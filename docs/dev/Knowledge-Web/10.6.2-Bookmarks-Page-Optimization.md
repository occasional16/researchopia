# 10.6.2 收藏夹页面优化计划

## 概述

本文档列出了 `/bookmarks` 页面的优化计划，目标是将当前粗糙的实现升级为类似 Edge 收藏夹的精致体验。

**相关文档：**
- [10.6-Bookmarks-and-Related-Links-Design.md](./10.6-Bookmarks-and-Related-Links-Design.md) - 主设计文档
- [10.6.1-Bookmark-Extension-Optimization.md](./10.6.1-Bookmark-Extension-Optimization.md) - 浏览器扩展优化

**当前页面：** `src/app/bookmarks/page.tsx` (770行)

**状态：** 进行中  
**创建日期：** 2025-01-03

---

## 一、当前实现分析

### 1.1 已实现功能
- ✅ 左侧文件夹树（支持嵌套）
- ✅ 右侧收藏列表
- ✅ 新建文件夹/添加收藏弹窗
- ✅ 文件夹展开/折叠
- ✅ 搜索过滤
- ✅ 右键菜单（重命名、删除）
- ✅ 未分类收藏
- ✅ 可见性图标显示

### 1.2 存在问题

| 类别 | 问题描述 | 严重程度 |
|------|----------|----------|
| **交互** | 无拖拽排序功能 | 🟡 中 |
| **交互** | 无拖拽移动到文件夹 | 🟡 中 |
| **视觉** | 列表样式单调，无网格视图 | 🟡 中 |
| **视觉** | favicon 加载失败无占位图 | 🟢 低 |
| **功能** | 无批量操作（多选删除/移动） | 🟡 中 |
| **功能** | 无导入/导出功能 | 🔴 高 |
| **功能** | 文件夹分享功能未完善 | 🟡 中 |
| **功能** | 无快捷键支持 | 🟢 低 |
| **性能** | 大量收藏时无虚拟滚动 | 🟢 低 |
| **移动端** | 响应式布局不完善 | 🟡 中 |

---

## 二、优化计划

### 优先级 P0：关键功能（必须完成）

#### 2.1 导入/导出功能
- **描述：** 支持导入浏览器收藏夹（Chrome/Edge HTML格式），导出为 HTML/JSON
- **用户价值：** 降低迁移门槛，增加用户粘性
- **实现方案：**
  - 解析 Chrome/Edge 导出的 `bookmarks.html`
  - 保留文件夹层级结构
  - 导出为标准 Netscape Bookmark HTML 格式
- **文件变更：**
  - 新增 `src/app/api/bookmarks/import/route.ts`
  - 新增 `src/app/api/bookmarks/export/route.ts`
  - 新增 `src/lib/bookmarks/parser.ts`
  - 更新 `src/app/bookmarks/page.tsx` 添加导入/导出按钮
- **工作量：** 1-2天
- **状态：** ✅ 已完成 (2025-01-17)

#### 2.2 拖拽排序与移动
- **描述：** 支持拖拽调整收藏顺序，拖拽移动到其他文件夹
- **用户价值：** 类似 Edge 的直观操作体验
- **实现方案：**
  - 使用 `@dnd-kit/core` + `@dnd-kit/sortable`
  - 更新 `position` 字段排序
  - 拖拽到文件夹时更新 `folder_id`
  - 自定义 `pointerWithin` 碰撞检测实现严格鼠标位置检测
  - `DragOverlay` 设置 `pointer-events: none` 实现光标穿透
- **API 变更：**
  - `PUT /api/bookmarks/items/[id]/move` - 移动到文件夹
  - `PUT /api/bookmarks/items/reorder` - 批量更新排序
- **工作量：** 2天
- **状态：** ✅ 已完成 (2025-01-17)

---

### 优先级 P1：体验提升

#### 2.3 视图切换（列表/网格）
- **描述：** 支持列表视图和网格视图切换
- **用户价值：** 适应不同使用习惯
- **实现方案：**
  - 网格视图显示大 favicon + 标题
  - 使用 localStorage 记住用户选择
- **工作量：** 0.5天
- **状态：** 🔲 未开始

#### 2.4 批量操作
- **描述：** 支持多选收藏进行批量删除/移动
- **用户价值：** 高效管理大量收藏
- **实现方案：**
  - 添加 checkbox 多选
  - 浮动操作栏（选中 N 项：移动、删除）
  - 全选/取消全选
- **API 变更：**
  - `DELETE /api/bookmarks/items/batch` - 批量删除
  - `PUT /api/bookmarks/items/batch/move` - 批量移动
- **工作量：** 1天
- **状态：** ✅ 已完成 (2025-01-17)

#### 2.5 分享功能完善
- **描述：** 完善文件夹分享功能（生成分享链接、设置权限）
- **用户价值：** 知识分享与协作
- **实现方案：**
  - 生成唯一 `share_code`
  - 公开访问页面 `/bookmarks/shared/[code]`
  - 分享设置弹窗（有效期、是否允许复制）
- **数据库变更：**
  - `bookmark_folders` 已有 `share_code` 字段
  - 新增 `share_expires_at` 字段
- **工作量：** 1天
- **状态：** 🔲 未开始

#### 2.6 移动端响应式优化
- **描述：** 优化移动端显示，侧边栏改为抽屉式
- **用户价值：** 移动端可用性
- **实现方案：**
  - 文件夹侧边栏改为可折叠抽屉
  - 底部 Tab 导航
  - 长按替代右键菜单
- **工作量：** 1天
- **状态：** 🔲 未开始

---

### 优先级 P2：锦上添花

#### 2.7 快捷键支持
- **描述：** 支持键盘快捷键操作
- **快捷键列表：**
  - `n` - 新建收藏
  - `f` - 新建文件夹
  - `Delete` - 删除选中项
  - `Ctrl+A` - 全选
  - `Escape` - 取消选择
- **工作量：** 0.5天
- **状态：** 🔲 未开始

#### 2.8 favicon 优化
- **描述：** favicon 加载失败时显示站点首字母占位图
- **实现方案：**
  ```tsx
  // 失败时生成首字母占位
  const getPlaceholder = (url: string) => {
    const hostname = new URL(url).hostname;
    return hostname.charAt(0).toUpperCase();
  }
  ```
- **工作量：** 0.5天
- **状态：** 🔲 未开始

#### 2.9 虚拟滚动
- **描述：** 收藏数量超过 100 条时启用虚拟滚动
- **用户价值：** 大数据量下保持流畅
- **实现方案：**
  - 使用 `@tanstack/react-virtual` 或 `react-window`
- **工作量：** 0.5天
- **状态：** 🔲 未开始

#### 2.10 文件夹拖拽排序
- **描述：** 支持拖拽调整文件夹顺序和层级
- **实现方案：**
  - 拖拽改变 `parent_id` 和 `position`
  - 拖拽到另一文件夹上成为子文件夹
- **工作量：** 1天
- **状态：** 🔲 未开始

---

## 三、实现路线图

### Phase 1: 核心功能（建议首先完成）
1. 导入/导出功能 (2.1)
2. 拖拽排序与移动 (2.2)

### Phase 2: 体验优化
3. 视图切换 (2.3)
4. 批量操作 (2.4)
5. 移动端响应式 (2.6)

### Phase 3: 高级功能
6. 分享功能完善 (2.5)
7. 快捷键支持 (2.7)

### Phase 4: 性能优化
8. favicon 优化 (2.8)
9. 虚拟滚动 (2.9)
10. 文件夹拖拽 (2.10)

---

## 四、技术选型建议

### 拖拽库
| 库名 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| `@dnd-kit/core` | 现代 API、高度可定制、支持 touch | 学习曲线 | ⭐⭐⭐⭐⭐ |
| `react-beautiful-dnd` | 动画流畅、文档丰富 | 维护状态不确定 | ⭐⭐⭐⭐ |
| 原生 HTML5 DnD | 无额外依赖 | 样式控制差、移动端支持差 | ⭐⭐ |

**建议：** 使用 `@dnd-kit/core`，现代且活跃维护。

### 虚拟滚动库
| 库名 | 优点 | 缺点 |
|------|------|------|
| `@tanstack/react-virtual` | 轻量、性能好 | 需要手动布局 |
| `react-window` | 简单易用 | 定制性一般 |

**建议：** 使用 `@tanstack/react-virtual`，与 TanStack Query 生态一致。

---

## 五、设计参考

### Edge 收藏夹特点
1. 左侧文件夹树 + 右侧收藏列表（已实现）
2. 拖拽排序和移动（待实现）
3. 搜索过滤（已实现）
4. 导入/导出（待实现）
5. 右键菜单丰富（部分实现）
6. 网格/列表视图切换（待实现）

### UI 改进建议

#### 当前样式
```
┌─────────────────────────────────────────────────┐
│ 📁 文件夹      │  🌐 收藏列表                    │
│ ├─ 工作        │  ├─ 标题1 (url1.com)           │
│ ├─ 学习        │  ├─ 标题2 (url2.com)           │
│ └─ 个人        │  └─ 标题3 (url3.com)           │
└─────────────────────────────────────────────────┘
```

#### 建议改进
```
┌─────────────────────────────────────────────────────────────┐
│ 🏠 > 收藏夹 > 工作                         📥 导入  📤 导出 │
├─────────────────────────────────────────────────────────────┤
│ 📁 文件夹          │  ☐ 全选  🔲 列表  ⊞ 网格  🔍 搜索...  │
│ ─────────────────  │  ─────────────────────────────────────  │
│ 🌐 未分类 (12)     │  ☐ 🌐 Google      google.com           │
│ ─────────────────  │  ☐ 🌐 GitHub      github.com           │
│ 📂 工作 (5)    ▸   │  ☐ 🌐 Stack...    stackoverflow.com    │
│   📂 项目A         │                                         │
│   📂 项目B         │  ─── 拖拽到此处移动 ───                 │
│ 📂 学习 (8)        │                                         │
│ 📂 个人 (3)        │  [+ 添加收藏]                           │
│                    │                                         │
│ [+ 新建文件夹]     │  已选中 2 项: [📁 移动] [🗑️ 删除]       │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、API 变更汇总

### 新增 API

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/bookmarks/import` | POST | 导入收藏夹 |
| `/api/bookmarks/export` | GET | 导出收藏夹 |
| `/api/bookmarks/items/batch` | DELETE | 批量删除 |
| `/api/bookmarks/items/batch/move` | PUT | 批量移动 |
| `/api/bookmarks/items/reorder` | PUT | 批量排序 |
| `/api/bookmarks/items/[id]/move` | PUT | 移动单个收藏 |

### 修改 API
无需修改现有 API。

---

## 七、实现清单

实现某个优化项时：
1. [ ] 将本文档中该项状态更新为 "🔄 进行中"
2. [ ] 创建分支 `feature/bookmarks-[功能名]`
3. [ ] 实现功能
4. [ ] 测试
5. [ ] 将状态更新为 "✅ 已完成"
6. [ ] 合并到主分支

---

## 八、变更日志

### 2025-01-03
- 创建初始文档
- 分析当前实现问题
- 列出 10 个优化项
- 制定 4 阶段实现路线图
