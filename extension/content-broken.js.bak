// content.js - å†…å®¹è„šæœ¬ï¼šDOIæ£€æµ‹å’Œæ‚¬æµ®å›¾æ ‡
class ResearchopiaContentScript {
  constructor() {
    this.detectedDOI = null;
    this.floatingIcon = null;
    this.sidebar = null;
    this.isDragging = false;
    this.dragStartX = 0;
    this.dragStartY = 0;
    this.settings = {};
    
    this.init();
  }

  async init() {
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.setup());
    } else {
      this.setup();
    }
  }

  async setup() {
    console.log('ğŸš€ ç ”å­¦æ¸¯æ‰©å±•å¼€å§‹åˆå§‹åŒ–...');
    
    try {
      console.log('ğŸ“‹ åŠ è½½è®¾ç½®...');
      await this.loadSettings();
      console.log('âœ… è®¾ç½®åŠ è½½å®Œæˆ:', this.settings);
      
      console.log('ğŸ” å¼€å§‹DOIæ£€æµ‹...');
      await this.detectDOI();
      console.log('âœ… DOIæ£€æµ‹å®Œæˆ:', this.detectedDOI);
      
      console.log('ğŸ“¡ è®¾ç½®æ¶ˆæ¯ç›‘å¬...');
      this.setupMessageListener();
      
      // å¼ºåˆ¶æ˜¾ç¤ºæµ®åŠ¨å›¾æ ‡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      console.log('ğŸ“Œ åˆ›å»ºæµ®åŠ¨å›¾æ ‡...');
      console.log('floatingEnabledè®¾ç½®:', this.settings.floatingEnabled);
      
      if (this.settings.floatingEnabled) {
        this.createFloatingIcon();
        console.log('âœ… æµ®åŠ¨å›¾æ ‡å·²åˆ›å»º');
      } else {
        console.log('âš ï¸ æµ®åŠ¨å›¾æ ‡è¢«è®¾ç½®ä¸ºå…³é—­');
      }
      
      console.log('ğŸ‰ ç ”å­¦æ¸¯æ‰©å±•å·²å®Œå…¨åŠ è½½');
    } catch (error) {
      console.error('âŒ ç ”å­¦æ¸¯æ‰©å±•åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  async loadSettings() {
    try {
      const result = await chrome.storage.sync.get([
        'floatingEnabled',
        'researchopiaUrl',
        'autoDetectDOI',
        'sidebarWidth'
      ]);
      
      this.settings = {
        floatingEnabled: result.floatingEnabled !== false, // é»˜è®¤ä¸ºtrue
        researchopiaUrl: result.researchopiaUrl || 'http://localhost:3000',
        autoDetectDOI: result.autoDetectDOI !== false, // é»˜è®¤ä¸ºtrue
        sidebarWidth: result.sidebarWidth || 400
      };
    } catch (error) {
      console.error('Failed to load settings:', error);
      // ä½¿ç”¨é»˜è®¤è®¾ç½®
      this.settings = {
        floatingEnabled: true,
        researchopiaUrl: 'http://localhost:3000',
        autoDetectDOI: true,
        sidebarWidth: 400
      };
    }
  }

  async detectDOI() {
    if (!this.settings.autoDetectDOI) return null;

    try {
      // å¤šç§DOIæ£€æµ‹æ–¹æ³•
      const methods = [
        () => this.extractDOIFromMeta(),
        () => this.extractDOIFromJSON(),
        () => this.extractDOIFromText(),
        () => this.extractDOIFromURL()
      ];

      for (const method of methods) {
        const doi = await method();
        if (doi) {
          this.detectedDOI = this.cleanDOI(doi);
          console.log('æ£€æµ‹åˆ°DOI:', this.detectedDOI);
          return this.detectedDOI;
        }
      }

      console.log('æœªæ£€æµ‹åˆ°DOI');
      return null;
    } catch (error) {
      console.error('DOIæ£€æµ‹å¤±è´¥:', error);
      return null;
    }
  }

  extractDOIFromMeta() {
    // ä»metaæ ‡ç­¾ä¸­æå–DOI
    const metaSelectors = [
      'meta[name="citation_doi"]',
      'meta[name="dc.identifier"]',
      'meta[name="DC.identifier"]',
      'meta[property="article:doi"]',
      'meta[name="doi"]',
      'meta[name="DOI"]'
    ];

    for (const selector of metaSelectors) {
      const meta = document.querySelector(selector);
      if (meta) {
        const content = meta.getAttribute('content') || meta.getAttribute('scheme');
        if (content && this.isValidDOI(content)) {
          return content;
        }
      }
    }
    return null;
  }

  extractDOIFromJSON() {
    // ä»JSON-LDæˆ–å…¶ä»–ç»“æ„åŒ–æ•°æ®ä¸­æå–DOI
    try {
      const jsonScripts = document.querySelectorAll('script[type="application/ld+json"]');
      for (const script of jsonScripts) {
        try {
          const data = JSON.parse(script.textContent);
          const doi = this.findDOIInObject(data);
          if (doi) return doi;
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error('JSON DOI extraction failed:', error);
    }
    return null;
  }

  extractDOIFromText() {
    // ä»é¡µé¢æ–‡æœ¬ä¸­æå–DOI
    const doiRegex = /(?:doi:|DOI:|https?:\/\/(?:www\.)?doi\.org\/|https?:\/\/dx\.doi\.org\/)?(10\.\d{4,}\/[^\s\])"'<]+)/gi;
    const textContent = document.body.textContent || '';
    
    const matches = textContent.match(doiRegex);
    if (matches && matches.length > 0) {
      for (const match of matches) {
        const cleanMatch = this.cleanDOI(match);
        if (this.isValidDOI(cleanMatch)) {
          return cleanMatch;
        }
      }
    }
    return null;
  }

  extractDOIFromURL() {
    // ä»å½“å‰URLä¸­æå–DOI
    const url = window.location.href;
    const doiRegex = /(?:doi\/|DOI\/|doi:|DOI:)?(10\.\d{4,}\/[^\s\])"'<\?#]+)/i;
    const match = url.match(doiRegex);
    
    if (match && match[1]) {
      const doi = this.cleanDOI(match[1]);
      if (this.isValidDOI(doi)) {
        return doi;
      }
    }
    return null;
  }

  findDOIInObject(obj) {
    if (typeof obj !== 'object' || obj === null) return null;
    
    // ç›´æ¥æ£€æŸ¥DOIå­—æ®µ
    const doiFields = ['doi', 'DOI', 'identifier', '@id', 'url'];
    for (const field of doiFields) {
      if (obj[field]) {
        const value = typeof obj[field] === 'string' ? obj[field] : JSON.stringify(obj[field]);
        if (this.isValidDOI(value)) {
          return this.cleanDOI(value);
        }
      }
    }
    
    // é€’å½’æœç´¢
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const result = this.findDOIInObject(obj[key]);
        if (result) return result;
      }
    }
    
    return null;
  }

  cleanDOI(doi) {
    if (!doi) return null;
    
    // ç§»é™¤å¸¸è§å‰ç¼€
    doi = doi.replace(/^(doi:|DOI:|https?:\/\/(?:www\.|dx\.)?doi\.org\/)/i, '');
    
    // ç§»é™¤å°¾éƒ¨çš„æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
    doi = doi.replace(/[.,;:)\]}"'>]*$/, '');
    
    // ç§»é™¤HTMLæ ‡ç­¾
    doi = doi.replace(/<[^>]*>/g, '');
    
    return doi.trim();
  }

  isValidDOI(doi) {
    if (!doi || typeof doi !== 'string') return false;
    
    // DOIçš„åŸºæœ¬æ ¼å¼æ£€æŸ¥ï¼š10.xxxx/xxxx
    const doiPattern = /^10\.\d{4,}\/\S+$/;
    return doiPattern.test(this.cleanDOI(doi));
  }

  createFloatingIcon() {
    console.log('ğŸ”¨ å¼€å§‹åˆ›å»ºæµ®åŠ¨å›¾æ ‡...');
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
    if (this.floatingIcon) {
      console.log('âš ï¸ æµ®åŠ¨å›¾æ ‡å·²å­˜åœ¨ï¼Œç§»é™¤æ—§å›¾æ ‡');
      this.floatingIcon.remove();
    }

    this.floatingIcon = document.createElement('div');
    this.floatingIcon.className = 'researchopia-floating-icon';
    this.floatingIcon.innerHTML = `
      <div class="icon-content">
        <div class="icon-text">ç ”</div>
        ${this.detectedDOI ? '<div class="doi-indicator"></div>' : ''}
      </div>
    `;

    // è®¾ç½®æ ·å¼
    Object.assign(this.floatingIcon.style, {
      position: 'fixed',
      top: '100px',
      right: '20px',
      width: '56px',
      height: '56px',
      backgroundColor: '#667eea',
      borderRadius: '50%',
      cursor: 'move',
      zIndex: '999999',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
      transition: 'all 0.3s ease',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
      userSelect: 'none'
    });
    
    console.log('ğŸ“ æµ®åŠ¨å›¾æ ‡æ ·å¼è®¾ç½®å®Œæˆ');
    
    // è®¾ç½®å›¾æ ‡å†…å®¹æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
      .researchopia-floating-icon .icon-text {
        color: white;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 2px;
      }
      .researchopia-floating-icon .doi-indicator {
        width: 8px;
        height: 8px;
        background: #4CAF50;
        border-radius: 50%;
        position: absolute;
        top: 6px;
        right: 6px;
        border: 2px solid white;
      }
      .researchopia-floating-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      }
    `;
    
    // æ·»åŠ æ ·å¼åˆ°head
    document.head.appendChild(style);
    console.log('ğŸ¨ æµ®åŠ¨å›¾æ ‡CSSæ ·å¼å·²æ·»åŠ ');
    
    // è®¾ç½®äº‹ä»¶
    this.setupFloatingIconEvents(this.floatingIcon);
    console.log('ğŸ›ï¸ æµ®åŠ¨å›¾æ ‡äº‹ä»¶è®¾ç½®å®Œæˆ');

    // æ·»åŠ åˆ°é¡µé¢
    try {
      document.body.appendChild(this.floatingIcon);
      console.log('âœ… æµ®åŠ¨å›¾æ ‡å·²æ·»åŠ åˆ°é¡µé¢DOM');
      
      // éªŒè¯æ˜¯å¦çœŸçš„æ·»åŠ æˆåŠŸ
      const addedIcon = document.querySelector('.researchopia-floating-icon');
      if (addedIcon) {
        console.log('âœ… æµ®åŠ¨å›¾æ ‡åœ¨DOMä¸­ç¡®è®¤å­˜åœ¨');
        console.log('ğŸ“ å›¾æ ‡ä½ç½®ä¿¡æ¯:', {
          top: addedIcon.style.top,
          right: addedIcon.style.right,
          zIndex: addedIcon.style.zIndex,
          display: addedIcon.style.display,
          visibility: getComputedStyle(addedIcon).visibility
        });
      } else {
        console.error('âŒ æµ®åŠ¨å›¾æ ‡æœªåœ¨DOMä¸­æ‰¾åˆ°');
      }
    } catch (error) {
      console.error('âŒ æ·»åŠ æµ®åŠ¨å›¾æ ‡åˆ°DOMå¤±è´¥:', error);
    }
  }

    // æ·»åŠ å†…éƒ¨æ ·å¼
    const iconContent = this.floatingIcon.querySelector('.icon-content');
    Object.assign(iconContent.style, {
      position: 'relative',
      color: 'white',
      fontSize: '20px',
      fontWeight: 'bold',
      textAlign: 'center'
    });

    // DOIæŒ‡ç¤ºå™¨æ ·å¼
    const doiIndicator = this.floatingIcon.querySelector('.doi-indicator');
    if (doiIndicator) {
      Object.assign(doiIndicator.style, {
        position: 'absolute',
        top: '-2px',
        right: '-2px',
        width: '12px',
        height: '12px',
        backgroundColor: '#10b981',
        borderRadius: '50%',
        border: '2px solid white'
      });
    }

    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    this.setupFloatingIconEvents();

    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(this.floatingIcon);
  }

  setupFloatingIconEvents() {
    if (!this.floatingIcon) return;

    let isHovering = false;
    let isDragging = false;
    let hasMoved = false;
    let startX = 0;
    let startY = 0;

    // é¼ æ ‡æ‚¬åœæ•ˆæœ
    this.floatingIcon.addEventListener('mouseenter', () => {
      isHovering = true;
      if (!isDragging) {
        this.floatingIcon.style.transform = 'scale(1.1)';
        this.floatingIcon.style.backgroundColor = '#5b21b6';
      }
    });

    this.floatingIcon.addEventListener('mouseleave', () => {
      isHovering = false;
      if (!isDragging) {
        this.floatingIcon.style.transform = 'scale(1)';
        this.floatingIcon.style.backgroundColor = '#667eea';
      }
    });

    // æ‹–æ‹½åŠŸèƒ½ - é¼ æ ‡æŒ‰ä¸‹
    this.floatingIcon.addEventListener('mousedown', (e) => {
      isDragging = true;
      hasMoved = false;
      
      // è®°å½•èµ·å§‹ä½ç½®
      const rect = this.floatingIcon.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      
      this.floatingIcon.style.transition = 'none';
      this.floatingIcon.style.cursor = 'grabbing';
      document.body.style.cursor = 'grabbing';
      document.body.style.userSelect = 'none';
      
      e.preventDefault();
      e.stopPropagation();
    });

    // æ‹–æ‹½ç§»åŠ¨
    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      
      const moveDistance = Math.sqrt(
        Math.pow(e.clientX - (startX + this.floatingIcon.offsetLeft), 2) +
        Math.pow(e.clientY - (startY + this.floatingIcon.offsetTop), 2)
      );
      
      if (moveDistance > 5) {
        hasMoved = true;
      }
      
      const x = e.clientX - startX;
      const y = e.clientY - startY;
      
      // è¾¹ç•Œé™åˆ¶
      const maxX = window.innerWidth - this.floatingIcon.offsetWidth;
      const maxY = window.innerHeight - this.floatingIcon.offsetHeight;
      
      const constrainedX = Math.max(0, Math.min(maxX, x));
      const constrainedY = Math.max(0, Math.min(maxY, y));
      
      this.floatingIcon.style.left = constrainedX + 'px';
      this.floatingIcon.style.top = constrainedY + 'px';
      this.floatingIcon.style.right = 'auto';
      this.floatingIcon.style.bottom = 'auto';
    });

    // æ‹–æ‹½ç»“æŸ
    document.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      
      isDragging = false;
      document.body.style.cursor = 'default';
      document.body.style.userSelect = '';
      this.floatingIcon.style.cursor = 'move';
      this.floatingIcon.style.transition = 'all 0.3s ease';
      
      // è¾¹ç¼˜å¸é™„
      const rect = this.floatingIcon.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const isLeftHalf = centerX < window.innerWidth / 2;
      
      setTimeout(() => {
        if (isLeftHalf) {
          this.floatingIcon.style.left = '20px';
          this.floatingIcon.style.right = 'auto';
        } else {
          this.floatingIcon.style.right = '20px';
          this.floatingIcon.style.left = 'auto';
        }
      }, 100);
      
      // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œåˆ™è®¤ä¸ºæ˜¯ç‚¹å‡»äº‹ä»¶
      if (!hasMoved) {
        setTimeout(() => {
          this.handleFloatingIconClick();
        }, 150); // å»¶è¿Ÿæ‰§è¡Œé¿å…ä¸æ‹–æ‹½å†²çª
      }
      
      if (!isHovering) {
        this.floatingIcon.style.transform = 'scale(1)';
        this.floatingIcon.style.backgroundColor = '#667eea';
      }
      
      e.stopPropagation();
    });

    // é˜²æ­¢æ‹–æ‹½æ—¶é€‰æ‹©æ–‡æœ¬
    this.floatingIcon.addEventListener('dragstart', (e) => {
      e.preventDefault();
    });

    // é˜²æ­¢å³é”®èœå•
    this.floatingIcon.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });
  }

  handleFloatingIconClick() {
    // ä½¿ç”¨ChromeåŸç”Ÿä¾§è¾¹æ API
    this.openNativeSidebar();
  }

  async openNativeSidebar() {
    try {
      // å‘background scriptå‘é€æ‰“å¼€ä¾§è¾¹æ çš„è¯·æ±‚
      const response = await chrome.runtime.sendMessage({
        action: 'openSidePanel',
        doi: this.detectedDOI,
        url: window.location.href
      });
      
      if (response && response.success) {
        console.log('âœ… ä¾§è¾¹æ æ‰“å¼€æˆåŠŸ');
      } else {
        console.log('âš ï¸ ä¾§è¾¹æ æ‰“å¼€å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        this.openFallbackSidebar();
      }
    } catch (error) {
      console.error('ä¾§è¾¹æ æ‰“å¼€å¤±è´¥:', error);
      this.openFallbackSidebar();
    }
  }

  openFallbackSidebar() {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªå®šä¹‰ä¾§è¾¹æ 
    if (this.sidebar) {
      // å¦‚æœä¾§è¾¹æ å·²å­˜åœ¨ï¼Œåˆ™åˆ‡æ¢æ˜¾ç¤º/éšè—
      const isVisible = this.sidebar.style.transform === 'translateX(0px)';
      this.sidebar.style.transform = isVisible ? `translateX(${this.settings.sidebarWidth}px)` : 'translateX(0px)';
      return;
    }

    this.createCustomSidebar();
  }

  createCustomSidebar() {
    this.sidebar = document.createElement('div');
    this.sidebar.className = 'researchopia-sidebar';
    
    // æ„å»ºç ”å­¦æ¸¯URLï¼Œä½†ä¸è‡ªåŠ¨æœç´¢
    let researchopiaUrl = this.settings.researchopiaUrl;
    if (this.detectedDOI) {
      researchopiaUrl += `/?doi=${encodeURIComponent(this.detectedDOI)}`;
    }

    this.sidebar.innerHTML = `
      <div class="sidebar-header">
        <div class="sidebar-title">
          <span class="sidebar-icon">ç ”</span>
          <span class="sidebar-text">ç ”å­¦æ¸¯ Researchopia</span>
        </div>
        <button class="sidebar-close" title="å…³é—­">Ã—</button>
      </div>
      <div class="sidebar-content">
        <iframe src="${researchopiaUrl}" frameborder="0" id="sidebarFrame"></iframe>
      </div>
    `;

    // è®¾ç½®æ ·å¼ - è°ƒæ•´ä¸ºæ¨æŒ¤æ•ˆæœè€Œéè¦†ç›–
    Object.assign(this.sidebar.style, {
      position: 'fixed',
      top: '0',
      right: '0',
      width: this.settings.sidebarWidth + 'px',
      height: '100vh',
      backgroundColor: 'white',
      zIndex: '999998',
      boxShadow: '-4px 0 20px rgba(0,0,0,0.15)',
      transform: `translateX(${this.settings.sidebarWidth}px)`,
      transition: 'transform 0.3s ease',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
    });

    // æ¨æŒ¤é¡µé¢å†…å®¹
    this.pushPageContent(true);

    // è®¾ç½®å†…éƒ¨æ ·å¼
    this.setupSidebarStyles();
    this.setupSidebarEvents();

    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(this.sidebar);

    // æ˜¾ç¤ºä¾§è¾¹æ 
    setTimeout(() => {
      this.sidebar.style.transform = 'translateX(0px)';
    }, 50);
  }

  pushPageContent(push) {
    // æ¨æŒ¤é¡µé¢å†…å®¹è€Œä¸æ˜¯è¦†ç›–
    const body = document.body;
    const html = document.documentElement;
    
    if (push) {
      const sidebarWidth = this.settings.sidebarWidth;
      body.style.transition = 'margin-right 0.3s ease';
      body.style.marginRight = sidebarWidth + 'px';
      html.style.transition = 'margin-right 0.3s ease';
      html.style.marginRight = sidebarWidth + 'px';
    } else {
      body.style.marginRight = '0px';
      html.style.marginRight = '0px';
      
      // æ¸…ç†transition
      setTimeout(() => {
        body.style.transition = '';
        html.style.transition = '';
      }, 300);
    }
  }

  setupSidebarStyles() {
    const header = this.sidebar.querySelector('.sidebar-header');
    Object.assign(header.style, {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      padding: '16px',
      borderBottom: '1px solid #e5e7eb',
      backgroundColor: '#f9fafb'
    });

    const title = this.sidebar.querySelector('.sidebar-title');
    Object.assign(title.style, {
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      fontSize: '18px',
      fontWeight: 'bold',
      color: '#1f2937'
    });

    const icon = this.sidebar.querySelector('.sidebar-icon');
    Object.assign(icon.style, {
      width: '32px',
      height: '32px',
      backgroundColor: '#667eea',
      color: 'white',
      borderRadius: '8px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      fontSize: '16px',
      fontWeight: 'bold'
    });

    const closeBtn = this.sidebar.querySelector('.sidebar-close');
    Object.assign(closeBtn.style, {
      background: 'none',
      border: 'none',
      fontSize: '24px',
      color: '#6b7280',
      cursor: 'pointer',
      padding: '4px',
      borderRadius: '4px'
    });

    const content = this.sidebar.querySelector('.sidebar-content');
    Object.assign(content.style, {
      height: 'calc(100vh - 65px)',
      overflow: 'hidden'
    });

    const iframe = this.sidebar.querySelector('iframe');
    Object.assign(iframe.style, {
      width: '100%',
      height: '100%',
      border: 'none'
    });
  }

  setupSidebarEvents() {
    const closeBtn = this.sidebar.querySelector('.sidebar-close');
    closeBtn.addEventListener('click', () => {
      this.closeSidebar();
    });

    closeBtn.addEventListener('mouseenter', () => {
      closeBtn.style.backgroundColor = '#f3f4f6';
    });

    closeBtn.addEventListener('mouseleave', () => {
      closeBtn.style.backgroundColor = 'transparent';
    });
  }

  closeSidebar() {
    if (this.sidebar) {
      this.sidebar.style.transform = `translateX(${this.settings.sidebarWidth}px)`;
      this.pushPageContent(false); // æ¢å¤é¡µé¢å†…å®¹
      
      setTimeout(() => {
        if (this.sidebar) {
          this.sidebar.remove();
          this.sidebar = null;
        }
      }, 300);
    }
  }

  setupMessageListener() {
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
      this.handleMessage(request, sender, sendResponse);
      return true;
    });
  }

  async handleMessage(request, sender, sendResponse) {
    try {
      switch (request.action) {
        case 'detectDOI':
          await this.detectDOI();
          sendResponse({
            success: true,
            doi: this.detectedDOI,
            url: window.location.href
          });
          break;
          
        case 'getCurrentDOI':
          // è¿”å›å½“å‰æ£€æµ‹åˆ°çš„DOI
          sendResponse({
            success: true,
            doi: this.detectedDOI,
            url: window.location.href,
            title: document.title
          });
          break;
          
        case 'toggleFloating':
          if (request.enabled) {
            this.createFloatingIcon();
          } else {
            if (this.floatingIcon) {
              this.floatingIcon.remove();
              this.floatingIcon = null;
            }
          }
          sendResponse({ success: true });
          break;
          
        case 'openSidebar':
          this.settings.researchopiaUrl = request.researchopiaUrl || this.settings.researchopiaUrl;
          this.openNativeSidebar();
          sendResponse({ success: true });
          break;
          
        default:
          sendResponse({ success: false, error: 'Unknown action' });
      }
    } catch (error) {
      console.error('Content script message handler error:', error);
      sendResponse({ success: false, error: error.message });
    }
  }

  // æ¸…ç†å‡½æ•°
  cleanup() {
    if (this.floatingIcon) {
      this.floatingIcon.remove();
      this.floatingIcon = null;
    }
    if (this.sidebar) {
      this.sidebar.remove();
      this.sidebar = null;
    }
  }
}

// åˆå§‹åŒ–å†…å®¹è„šæœ¬
let researchopiaCS = null;

if (!researchopiaCS) {
  researchopiaCS = new ResearchopiaContentScript();
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', () => {
  if (researchopiaCS) {
    researchopiaCS.cleanup();
  }
});