# 1.4.3 å››çº§å…±äº«æ¨¡å¼è®¾è®¡åˆ†æ

## è®¾è®¡æ¦‚è§ˆ

### å…±äº«æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | åŒæ­¥åˆ°æ•°æ®åº“ | åˆ—è¡¨å¯è§æ€§ | ç”¨æˆ·èº«ä»½æ˜¾ç¤º | å¯äº¤äº’(ç‚¹èµ/è¯„è®º) |
|------|-------------|-----------|-------------|----------------|
| **å…¬å¼€** | âœ… | æ‰€æœ‰ç”¨æˆ· | âœ… çœŸå®ç”¨æˆ·å | âœ… |
| **åŒ¿å** | âœ… | æ‰€æœ‰ç”¨æˆ· | ğŸ­ Anonymous | âœ… |
| **ç§å¯†** | âœ… | ä»…åˆ›å»ºè€… | âœ… çœŸå®ç”¨æˆ·å | âŒ (ä»…è‡ªå·±å¯è§) |
| **å–æ¶ˆ** | âŒ | - | - | âš ï¸ åˆ é™¤å…³è”æ•°æ® |

---

## æ ¸å¿ƒè®¾è®¡é€»è¾‘

### 1. æ•°æ®åº“å­—æ®µè®¾è®¡

**æ‰©å±• `shared_annotations` è¡¨**:

```sql
ALTER TABLE shared_annotations 
ADD COLUMN visibility VARCHAR(20) DEFAULT 'public' 
CHECK (visibility IN ('public', 'anonymous', 'private'));

-- ç´¢å¼•ä¼˜åŒ–(ä»…æŸ¥è¯¢å…¬å¼€/åŒ¿åæ ‡æ³¨)
CREATE INDEX idx_visibility_public 
ON shared_annotations(paper_id, visibility) 
WHERE visibility IN ('public', 'anonymous');
```

**å­—æ®µè¯´æ˜**:
- `public`: å…¬å¼€,æ˜¾ç¤ºçœŸå®ç”¨æˆ·å
- `anonymous`: åŒ¿å,æ˜¾ç¤º"åŒ¿åç”¨æˆ·"
- `private`: ç§å¯†,ä»…åˆ›å»ºè€…å¯è§

---

### 2. RLSç­–ç•¥æ›´æ–°

```sql
-- æŸ¥è¯¢ç­–ç•¥:å…¬å¼€/åŒ¿å â†’ æ‰€æœ‰äººå¯è§
CREATE POLICY "shared_annotations_select_public"
ON shared_annotations FOR SELECT
USING (
  visibility IN ('public', 'anonymous')
  OR 
  (visibility = 'private' AND user_id = auth.uid())
);

-- åˆ é™¤ç­–ç•¥:ä»…åˆ›å»ºè€…å¯åˆ é™¤
CREATE POLICY "shared_annotations_delete_own"
ON shared_annotations FOR DELETE
USING (user_id = auth.uid());
```

---

### 3. UIç»„ä»¶è®¾è®¡

#### æŒ‰é’®çŠ¶æ€æœº

```
[æœªå…±äº«] â”€â”€â”€clickâ”€â”€â†’ [é€‰æ‹©æ¨¡å¼]
                        â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“         â†“         â†“
           [å…¬å¼€]   [åŒ¿å]   [ç§å¯†]
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                   [å·²å…±äº«] â”€â”€â”€clickâ”€â”€â†’ [å–æ¶ˆ]
```

#### è§†è§‰è®¾è®¡

**æœªå…±äº«çŠ¶æ€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒ å…¬å¼€  ğŸ­ åŒ¿å  ğŸ”’ ç§å¯†   â”‚ â† 3ä¸ªæ¿€æ´»æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·²å…±äº«çŠ¶æ€(å…¬å¼€)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [âœ… å…¬å¼€]  ğŸ­ åŒ¿å  ğŸ”’ ç§å¯†  ğŸ—‘ï¸ å–æ¶ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ è“è‰²é«˜äº®
```

---

## äº¤äº’é€»è¾‘è¯¦è§£

### åœºæ™¯1: é¦–æ¬¡å…±äº«

```typescript
// ç”¨æˆ·ç‚¹å‡»"å…¬å¼€"æŒ‰é’®
async function shareAsPublic(localAnnotation) {
  const { data, error } = await supabase
    .from("shared_annotations")
    .insert({
      ...annotationData,
      visibility: "public",  // è®¾ç½®å…¬å¼€
      user_id: currentUser.id,
    })
    .select()
    .single();
  
  // æ›´æ–°UI
  updateButtonState("public");
}
```

### åœºæ™¯2: åˆ‡æ¢æ¨¡å¼

**ä»"å…¬å¼€" â†’ "åŒ¿å"**:
```typescript
async function switchVisibility(annotationId, newMode) {
  const { error } = await supabase
    .from("shared_annotations")
    .update({ visibility: newMode })
    .eq("id", annotationId);
  
  // ä»…æ›´æ–°visibilityå­—æ®µ,ä¿ç•™ç‚¹èµ/è¯„è®º
}
```

**æ³¨æ„**: å·²æœ‰çš„ç‚¹èµ/è¯„è®ºä¸åˆ é™¤,ä»…ä¿®æ”¹å±•ç¤ºé€»è¾‘

---

### åœºæ™¯3: å–æ¶ˆå…±äº«

```typescript
async function unshare(annotationId) {
  // 1. ç¡®è®¤å¯¹è¯æ¡†
  const confirmed = await showConfirmDialog({
    title: "ç¡®è®¤å–æ¶ˆå…±äº«?",
    message: "æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å…³è”çš„ç‚¹èµå’Œè¯„è®ºæ•°æ®",
    confirmText: "åˆ é™¤",
    cancelText: "å–æ¶ˆ",
  });
  
  if (!confirmed) return;
  
  // 2. çº§è”åˆ é™¤
  const { error } = await supabase.rpc("delete_annotation_cascade", {
    annotation_id: annotationId,
  });
  
  // 3. æ¸…ç©ºæœ¬åœ°çŠ¶æ€
  clearAnnotationMapping(localAnnotation.key);
}
```

**æ•°æ®åº“å‡½æ•°** (`delete_annotation_cascade`):
```sql
CREATE OR REPLACE FUNCTION delete_annotation_cascade(annotation_id UUID)
RETURNS void AS $$
BEGIN
  -- åˆ é™¤è¯„è®º
  DELETE FROM annotation_comments 
  WHERE annotation_id = $1;
  
  -- åˆ é™¤ç‚¹èµ
  DELETE FROM annotation_likes 
  WHERE annotation_id = $1;
  
  -- åˆ é™¤æ ‡æ³¨æœ¬èº«
  DELETE FROM shared_annotations 
  WHERE id = $1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## å‰ç«¯é€»è¾‘å®ç°

### æŒ‰é’®ç»„ä»¶

```tsx
function ShareModeButtons({ annotation, currentMode, onModeChange }) {
  const modes = [
    { id: "public", label: "ğŸŒ å…¬å¼€", color: "#2196F3" },
    { id: "anonymous", label: "ğŸ­ åŒ¿å", color: "#FF9800" },
    { id: "private", label: "ğŸ”’ ç§å¯†", color: "#9E9E9E" },
  ];
  
  return (
    <div className="share-mode-buttons">
      {modes.map(mode => (
        <button
          key={mode.id}
          className={currentMode === mode.id ? "active" : ""}
          style={{ borderColor: mode.color }}
          onClick={() => onModeChange(mode.id)}
        >
          {mode.label}
        </button>
      ))}
      
      {currentMode && (
        <button
          className="unshare-btn"
          onClick={() => onModeChange(null)}
        >
          ğŸ—‘ï¸ å–æ¶ˆ
        </button>
      )}
    </div>
  );
}
```

---

## æ•°æ®æŸ¥è¯¢é€»è¾‘

### åˆ—è¡¨é¡µæŸ¥è¯¢

```typescript
// è·å–å…¬å¼€+åŒ¿åæ ‡æ³¨(æ’é™¤ç§å¯†)
const { data: annotations } = await supabase
  .from("shared_annotations")
  .select(`
    *,
    profiles!inner(username, avatar_url)
  `)
  .eq("paper_id", paperId)
  .in("visibility", ["public", "anonymous"])
  .order("created_at", { ascending: false });

// å‰ç«¯å¤„ç†åŒ¿åé€»è¾‘
annotations.forEach(ann => {
  if (ann.visibility === "anonymous") {
    ann.profiles.username = "åŒ¿åç”¨æˆ·";
    ann.profiles.avatar_url = "/default-avatar.png";
  }
});
```

### æˆ‘çš„æ ‡æ³¨æŸ¥è¯¢

```typescript
// åŒ…å«ç§å¯†æ ‡æ³¨
const { data: myAnnotations } = await supabase
  .from("shared_annotations")
  .select("*")
  .eq("user_id", currentUserId)
  .order("created_at", { ascending: false });
```

---

## è¾¹ç¼˜åœºæ™¯å¤„ç†

### 1. ç§å¯†æ ‡æ³¨è¢«ç‚¹èµ/è¯„è®º

**é—®é¢˜**: å…¶ä»–ç”¨æˆ·èƒ½å¦é€šè¿‡APIç›´æ¥è®¿é—®ç§å¯†æ ‡æ³¨?

**è§£å†³æ–¹æ¡ˆ**: RLSç­–ç•¥ + APIå±‚åŒé‡æ ¡éªŒ

```typescript
// APIå±‚æ ¡éªŒ
export async function createComment(annotationId, content) {
  // 1. æ£€æŸ¥æ ‡æ³¨å¯è§æ€§
  const { data: annotation } = await supabase
    .from("shared_annotations")
    .select("visibility, user_id")
    .eq("id", annotationId)
    .single();
  
  if (annotation.visibility === "private" && 
      annotation.user_id !== currentUser.id) {
    throw new Error("æ— æƒè®¿é—®ç§å¯†æ ‡æ³¨");
  }
  
  // 2. åˆ›å»ºè¯„è®º
  // ...
}
```

---

### 2. åˆ‡æ¢æ¨¡å¼æ—¶çš„é€šçŸ¥é€»è¾‘

**ä»"å…¬å¼€" â†’ "ç§å¯†"**:
- âœ… å·²æœ‰ç‚¹èµ/è¯„è®ºä¿ç•™,ä½†å¯¹å…¶ä»–ç”¨æˆ·ä¸å¯è§
- âš ï¸ æ˜¯å¦é€šçŸ¥å·²è¯„è®ºçš„ç”¨æˆ·? (å¯é€‰)

**ä»"ç§å¯†" â†’ "å…¬å¼€"**:
- âœ… ä¹‹å‰éšè—çš„æ•°æ®é‡æ–°å¯è§
- ğŸ”” å¯é€‰:é€šçŸ¥æ›¾ç»è¯„è®ºè¿‡çš„ç”¨æˆ·

---

### 3. åŒ¿åç”¨æˆ·äº’åŠ¨é—®é¢˜

**åœºæ™¯**: ç”¨æˆ·AåŒ¿åå…±äº«æ ‡æ³¨,ç”¨æˆ·Bç‚¹èµ

**UIå±•ç¤º**:
```
ğŸ‘¤ åŒ¿åç”¨æˆ·
ğŸ“ "è¿™æ®µåˆ†æå¾ˆæœ‰æ·±åº¦..."
ğŸ‘ 5  ğŸ’¬ 2
```

**æ•°æ®æŸ¥è¯¢**: ç‚¹èµ/è¯„è®ºæ­£å¸¸å…³è”,ä»…usernameå­—æ®µå‰ç«¯å¤„ç†ä¸º"åŒ¿åç”¨æˆ·"

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

```typescript
// ç¼“å­˜å½“å‰ç”¨æˆ·çš„æ ‡æ³¨æ¨¡å¼
const annotationModes = new Map();

export function getCachedMode(localKey) {
  return annotationModes.get(localKey);
}

export function setCachedMode(localKey, mode) {
  annotationModes.set(localKey, mode);
  localStorage.setItem(
    "annotationModes",
    JSON.stringify([...annotationModes])
  );
}
```

### 2. æ‰¹é‡æ›´æ–°

```typescript
// æ‰¹é‡åˆ‡æ¢å¤šä¸ªæ ‡æ³¨çš„æ¨¡å¼
async function bulkUpdateVisibility(annotationIds, newMode) {
  const { error } = await supabase
    .from("shared_annotations")
    .update({ visibility: newMode })
    .in("id", annotationIds);
}
```

---

## ä¸"ä¸€é”®å…±äº«"çš„é›†æˆ

### åŸç”Ÿå¼¹çª—æŒ‰é’®ç»„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒ å…¬å¼€  ğŸ­ åŒ¿å  ğŸ”’ ç§å¯†  â”‚ â† 4é€‰1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ ç‚¹å‡»åçŠ¶æ€ä¿å­˜
   (åˆ›å»ºæ ‡æ³¨æ—¶ç”Ÿæ•ˆ)
```

### å®ç°ä»£ç 

```typescript
Zotero.Reader.registerEventListener(
  "renderTextSelectionPopup",
  (event) => {
    const { append, doc } = event;
    
    append(createShareModeSelector(doc, {
      onModeSelect: (mode) => {
        sessionStorage.setItem("pendingShareMode", mode);
        highlightButton(mode);  // è§†è§‰åé¦ˆ
      },
    }));
  }
);

// æ ‡æ³¨åˆ›å»ºåæ£€æµ‹
Zotero.Notifier.registerObserver({
  notify: async (event, type, ids) => {
    if (event === "add" && type === "item") {
      const mode = sessionStorage.getItem("pendingShareMode");
      if (mode) {
        await shareWithMode(annotation, mode);
        sessionStorage.removeItem("pendingShareMode");
      }
    }
  },
});
```

---

## ä¼˜åŠ¿åˆ†æ

| ç‰¹æ€§ | è¯´æ˜ | ç”¨æˆ·ä»·å€¼ |
|------|------|----------|
| **çµæ´»æ§åˆ¶** | 4ç§æ¨¡å¼æ»¡è¶³ä¸åŒåœºæ™¯ | éšç§/å…¬å¼€è‡ªç”±åˆ‡æ¢ |
| **æ— æŸè½¬æ¢** | æ¨¡å¼åˆ‡æ¢ä¸åˆ æ•°æ® | é¿å…è¯¯æ“ä½œ |
| **æ˜ç¡®åé¦ˆ** | æŒ‰é’®çŠ¶æ€æ¸…æ™° | é™ä½è®¤çŸ¥è´Ÿæ‹… |
| **å®‰å…¨åˆ é™¤** | çº§è”åˆ é™¤+ç¡®è®¤ | é˜²æ­¢æ•°æ®ä¸¢å¤± |

---

## å…³é”®è®¾è®¡è¯´æ˜

### âœ… UIè®¾è®¡: ä¿æŒ4ä¸ªç‹¬ç«‹æŒ‰é’®

**ç†ç”±**:
- æ“ä½œé¢‘æ¬¡é«˜,ä¸‹æ‹‰èœå•å¢åŠ ç‚¹å‡»æˆæœ¬
- 4ç§æ¨¡å¼è¯­ä¹‰æ˜ç¡®,ç”¨æˆ·éœ€ç›´è§‚å¯¹æ¯”
- æ¨ªå‘æ’åˆ—,è§†è§‰æ‰«ææ•ˆç‡é«˜

**å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸŒ å…¬å¼€] [ğŸ­ åŒ¿å] [ğŸ”’ ç§å¯†] [ğŸ—‘ï¸ å–æ¶ˆ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âœ… "ç§å¯†"æ¨¡å¼çš„æ ¸å¿ƒä»·å€¼

**ä¸"æœªå…±äº«"çš„3å¤§å·®å¼‚**:

| ç‰¹æ€§ | æœªå…±äº« | ç§å¯†å…±äº« |
|------|--------|---------|
| å­˜å‚¨ä½ç½® | ä»…æœ¬åœ°Zotero | âœ… Supabaseäº‘ç«¯ |
| å¤šè®¾å¤‡åŒæ­¥ | âŒ | âœ… |
| è‡ªæˆ‘ç‚¹èµ/è¯„è®º | âŒ | âœ… æ”¯æŒ |
| è½¬ä¸ºå…¬å¼€ | âŒ éœ€é‡æ–°å…±äº« | âœ… ä¸€é”®åˆ‡æ¢ |

**ä½¿ç”¨åœºæ™¯**:
```
ä¸ªäººå­¦ä¹ ç¬”è®° â†’ ç§å¯†å…±äº«(äº‘ç«¯å¤‡ä»½)
        â†“ ç»è¿‡æ•´ç†å®Œå–„
     å…¬å¼€å…±äº«(åˆ†äº«ç»™ç¤¾åŒº)
```

---

### âœ… åŒ¿åæ¨¡å¼çš„å¯è¿½æº¯æ€§

**å®ç°åŸåˆ™**: å‰ç«¯éšè—,åç«¯ä¿ç•™

**æ•°æ®åº“è®¾è®¡**:
```sql
-- user_idå­—æ®µå§‹ç»ˆè®°å½•çœŸå®åˆ›å»ºè€…
CREATE TABLE shared_annotations (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),  -- ğŸ‘ˆ çœŸå®ç”¨æˆ·ID
  visibility VARCHAR(20),                 -- ğŸ‘ˆ public/anonymous/private
  -- ...
);

-- æŸ¥è¯¢æ—¶å‰ç«¯åˆ¤æ–­
SELECT 
  id,
  CASE 
    WHEN visibility = 'anonymous' THEN NULL  -- ğŸ‘ˆ éšè—user_id
    ELSE user_id 
  END as display_user_id,
  visibility
FROM shared_annotations;
```

**ç®¡ç†å‘˜å·¥å…·**:
```typescript
// ä»…ç®¡ç†å‘˜å¯è®¿é—®
async function getAnonymousAuthor(annotationId: string) {
  const { data } = await supabase.rpc("get_real_author", {
    annotation_id: annotationId,
  });
  return data; // è¿”å›çœŸå®user_idå’Œusername
}
```

**å®¡è®¡æ—¥å¿—**:
```sql
-- è®°å½•æ‰€æœ‰åŒ¿åæ ‡æ³¨åˆ›å»º
CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  annotation_id UUID,
  user_id UUID,
  action VARCHAR(50),  -- 'create_anonymous'
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

**å‚è€ƒæ–‡æ¡£**:
- [ARCHITECTURE.md - RLSç­–ç•¥](../../ARCHITECTURE.md#rls)
- [1.4.2 ä¸€é”®å…±äº«å®ç°ç­–ç•¥](./1.4.2-ONE_CLICK_SHARE_IMPLEMENTATION.md)
