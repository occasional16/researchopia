revoke delete on table "public"."annotation_comments" from "anon";

revoke insert on table "public"."annotation_comments" from "anon";

revoke references on table "public"."annotation_comments" from "anon";

revoke select on table "public"."annotation_comments" from "anon";

revoke trigger on table "public"."annotation_comments" from "anon";

revoke truncate on table "public"."annotation_comments" from "anon";

revoke update on table "public"."annotation_comments" from "anon";

revoke delete on table "public"."annotation_comments" from "authenticated";

revoke insert on table "public"."annotation_comments" from "authenticated";

revoke references on table "public"."annotation_comments" from "authenticated";

revoke select on table "public"."annotation_comments" from "authenticated";

revoke trigger on table "public"."annotation_comments" from "authenticated";

revoke truncate on table "public"."annotation_comments" from "authenticated";

revoke update on table "public"."annotation_comments" from "authenticated";

revoke delete on table "public"."annotation_comments" from "service_role";

revoke insert on table "public"."annotation_comments" from "service_role";

revoke references on table "public"."annotation_comments" from "service_role";

revoke select on table "public"."annotation_comments" from "service_role";

revoke trigger on table "public"."annotation_comments" from "service_role";

revoke truncate on table "public"."annotation_comments" from "service_role";

revoke update on table "public"."annotation_comments" from "service_role";

revoke delete on table "public"."annotation_likes" from "anon";

revoke insert on table "public"."annotation_likes" from "anon";

revoke references on table "public"."annotation_likes" from "anon";

revoke select on table "public"."annotation_likes" from "anon";

revoke trigger on table "public"."annotation_likes" from "anon";

revoke truncate on table "public"."annotation_likes" from "anon";

revoke update on table "public"."annotation_likes" from "anon";

revoke delete on table "public"."annotation_likes" from "authenticated";

revoke insert on table "public"."annotation_likes" from "authenticated";

revoke references on table "public"."annotation_likes" from "authenticated";

revoke select on table "public"."annotation_likes" from "authenticated";

revoke trigger on table "public"."annotation_likes" from "authenticated";

revoke truncate on table "public"."annotation_likes" from "authenticated";

revoke update on table "public"."annotation_likes" from "authenticated";

revoke delete on table "public"."annotation_likes" from "service_role";

revoke insert on table "public"."annotation_likes" from "service_role";

revoke references on table "public"."annotation_likes" from "service_role";

revoke select on table "public"."annotation_likes" from "service_role";

revoke trigger on table "public"."annotation_likes" from "service_role";

revoke truncate on table "public"."annotation_likes" from "service_role";

revoke update on table "public"."annotation_likes" from "service_role";

revoke delete on table "public"."annotation_shares" from "anon";

revoke insert on table "public"."annotation_shares" from "anon";

revoke references on table "public"."annotation_shares" from "anon";

revoke select on table "public"."annotation_shares" from "anon";

revoke trigger on table "public"."annotation_shares" from "anon";

revoke truncate on table "public"."annotation_shares" from "anon";

revoke update on table "public"."annotation_shares" from "anon";

revoke delete on table "public"."annotation_shares" from "authenticated";

revoke insert on table "public"."annotation_shares" from "authenticated";

revoke references on table "public"."annotation_shares" from "authenticated";

revoke select on table "public"."annotation_shares" from "authenticated";

revoke trigger on table "public"."annotation_shares" from "authenticated";

revoke truncate on table "public"."annotation_shares" from "authenticated";

revoke update on table "public"."annotation_shares" from "authenticated";

revoke delete on table "public"."annotation_shares" from "service_role";

revoke insert on table "public"."annotation_shares" from "service_role";

revoke references on table "public"."annotation_shares" from "service_role";

revoke select on table "public"."annotation_shares" from "service_role";

revoke trigger on table "public"."annotation_shares" from "service_role";

revoke truncate on table "public"."annotation_shares" from "service_role";

revoke update on table "public"."annotation_shares" from "service_role";

revoke delete on table "public"."annotations" from "anon";

revoke insert on table "public"."annotations" from "anon";

revoke references on table "public"."annotations" from "anon";

revoke select on table "public"."annotations" from "anon";

revoke trigger on table "public"."annotations" from "anon";

revoke truncate on table "public"."annotations" from "anon";

revoke update on table "public"."annotations" from "anon";

revoke delete on table "public"."annotations" from "authenticated";

revoke insert on table "public"."annotations" from "authenticated";

revoke references on table "public"."annotations" from "authenticated";

revoke select on table "public"."annotations" from "authenticated";

revoke trigger on table "public"."annotations" from "authenticated";

revoke truncate on table "public"."annotations" from "authenticated";

revoke update on table "public"."annotations" from "authenticated";

revoke delete on table "public"."annotations" from "service_role";

revoke insert on table "public"."annotations" from "service_role";

revoke references on table "public"."annotations" from "service_role";

revoke select on table "public"."annotations" from "service_role";

revoke trigger on table "public"."annotations" from "service_role";

revoke truncate on table "public"."annotations" from "service_role";

revoke update on table "public"."annotations" from "service_role";

revoke delete on table "public"."announcements" from "anon";

revoke insert on table "public"."announcements" from "anon";

revoke references on table "public"."announcements" from "anon";

revoke select on table "public"."announcements" from "anon";

revoke trigger on table "public"."announcements" from "anon";

revoke truncate on table "public"."announcements" from "anon";

revoke update on table "public"."announcements" from "anon";

revoke delete on table "public"."announcements" from "authenticated";

revoke insert on table "public"."announcements" from "authenticated";

revoke references on table "public"."announcements" from "authenticated";

revoke select on table "public"."announcements" from "authenticated";

revoke trigger on table "public"."announcements" from "authenticated";

revoke truncate on table "public"."announcements" from "authenticated";

revoke update on table "public"."announcements" from "authenticated";

revoke delete on table "public"."announcements" from "service_role";

revoke insert on table "public"."announcements" from "service_role";

revoke references on table "public"."announcements" from "service_role";

revoke select on table "public"."announcements" from "service_role";

revoke trigger on table "public"."announcements" from "service_role";

revoke truncate on table "public"."announcements" from "service_role";

revoke update on table "public"."announcements" from "service_role";

revoke delete on table "public"."collaboration_sessions" from "anon";

revoke insert on table "public"."collaboration_sessions" from "anon";

revoke references on table "public"."collaboration_sessions" from "anon";

revoke select on table "public"."collaboration_sessions" from "anon";

revoke trigger on table "public"."collaboration_sessions" from "anon";

revoke truncate on table "public"."collaboration_sessions" from "anon";

revoke update on table "public"."collaboration_sessions" from "anon";

revoke delete on table "public"."collaboration_sessions" from "authenticated";

revoke insert on table "public"."collaboration_sessions" from "authenticated";

revoke references on table "public"."collaboration_sessions" from "authenticated";

revoke select on table "public"."collaboration_sessions" from "authenticated";

revoke trigger on table "public"."collaboration_sessions" from "authenticated";

revoke truncate on table "public"."collaboration_sessions" from "authenticated";

revoke update on table "public"."collaboration_sessions" from "authenticated";

revoke delete on table "public"."collaboration_sessions" from "service_role";

revoke insert on table "public"."collaboration_sessions" from "service_role";

revoke references on table "public"."collaboration_sessions" from "service_role";

revoke select on table "public"."collaboration_sessions" from "service_role";

revoke trigger on table "public"."collaboration_sessions" from "service_role";

revoke truncate on table "public"."collaboration_sessions" from "service_role";

revoke update on table "public"."collaboration_sessions" from "service_role";

revoke delete on table "public"."comment_votes" from "anon";

revoke insert on table "public"."comment_votes" from "anon";

revoke references on table "public"."comment_votes" from "anon";

revoke select on table "public"."comment_votes" from "anon";

revoke trigger on table "public"."comment_votes" from "anon";

revoke truncate on table "public"."comment_votes" from "anon";

revoke update on table "public"."comment_votes" from "anon";

revoke delete on table "public"."comment_votes" from "authenticated";

revoke insert on table "public"."comment_votes" from "authenticated";

revoke references on table "public"."comment_votes" from "authenticated";

revoke select on table "public"."comment_votes" from "authenticated";

revoke trigger on table "public"."comment_votes" from "authenticated";

revoke truncate on table "public"."comment_votes" from "authenticated";

revoke update on table "public"."comment_votes" from "authenticated";

revoke delete on table "public"."comment_votes" from "service_role";

revoke insert on table "public"."comment_votes" from "service_role";

revoke references on table "public"."comment_votes" from "service_role";

revoke select on table "public"."comment_votes" from "service_role";

revoke trigger on table "public"."comment_votes" from "service_role";

revoke truncate on table "public"."comment_votes" from "service_role";

revoke update on table "public"."comment_votes" from "service_role";

revoke delete on table "public"."comments" from "anon";

revoke insert on table "public"."comments" from "anon";

revoke references on table "public"."comments" from "anon";

revoke select on table "public"."comments" from "anon";

revoke trigger on table "public"."comments" from "anon";

revoke truncate on table "public"."comments" from "anon";

revoke update on table "public"."comments" from "anon";

revoke delete on table "public"."comments" from "authenticated";

revoke insert on table "public"."comments" from "authenticated";

revoke references on table "public"."comments" from "authenticated";

revoke select on table "public"."comments" from "authenticated";

revoke trigger on table "public"."comments" from "authenticated";

revoke truncate on table "public"."comments" from "authenticated";

revoke update on table "public"."comments" from "authenticated";

revoke delete on table "public"."comments" from "service_role";

revoke insert on table "public"."comments" from "service_role";

revoke references on table "public"."comments" from "service_role";

revoke select on table "public"."comments" from "service_role";

revoke trigger on table "public"."comments" from "service_role";

revoke truncate on table "public"."comments" from "service_role";

revoke update on table "public"."comments" from "service_role";

revoke delete on table "public"."documents" from "anon";

revoke insert on table "public"."documents" from "anon";

revoke references on table "public"."documents" from "anon";

revoke select on table "public"."documents" from "anon";

revoke trigger on table "public"."documents" from "anon";

revoke truncate on table "public"."documents" from "anon";

revoke update on table "public"."documents" from "anon";

revoke delete on table "public"."documents" from "authenticated";

revoke insert on table "public"."documents" from "authenticated";

revoke references on table "public"."documents" from "authenticated";

revoke select on table "public"."documents" from "authenticated";

revoke trigger on table "public"."documents" from "authenticated";

revoke truncate on table "public"."documents" from "authenticated";

revoke update on table "public"."documents" from "authenticated";

revoke delete on table "public"."documents" from "service_role";

revoke insert on table "public"."documents" from "service_role";

revoke references on table "public"."documents" from "service_role";

revoke select on table "public"."documents" from "service_role";

revoke trigger on table "public"."documents" from "service_role";

revoke truncate on table "public"."documents" from "service_role";

revoke update on table "public"."documents" from "service_role";

revoke delete on table "public"."paper_favorites" from "anon";

revoke insert on table "public"."paper_favorites" from "anon";

revoke references on table "public"."paper_favorites" from "anon";

revoke select on table "public"."paper_favorites" from "anon";

revoke trigger on table "public"."paper_favorites" from "anon";

revoke truncate on table "public"."paper_favorites" from "anon";

revoke update on table "public"."paper_favorites" from "anon";

revoke delete on table "public"."paper_favorites" from "authenticated";

revoke insert on table "public"."paper_favorites" from "authenticated";

revoke references on table "public"."paper_favorites" from "authenticated";

revoke select on table "public"."paper_favorites" from "authenticated";

revoke trigger on table "public"."paper_favorites" from "authenticated";

revoke truncate on table "public"."paper_favorites" from "authenticated";

revoke update on table "public"."paper_favorites" from "authenticated";

revoke delete on table "public"."paper_favorites" from "service_role";

revoke insert on table "public"."paper_favorites" from "service_role";

revoke references on table "public"."paper_favorites" from "service_role";

revoke select on table "public"."paper_favorites" from "service_role";

revoke trigger on table "public"."paper_favorites" from "service_role";

revoke truncate on table "public"."paper_favorites" from "service_role";

revoke update on table "public"."paper_favorites" from "service_role";

revoke delete on table "public"."paper_reports" from "anon";

revoke insert on table "public"."paper_reports" from "anon";

revoke references on table "public"."paper_reports" from "anon";

revoke select on table "public"."paper_reports" from "anon";

revoke trigger on table "public"."paper_reports" from "anon";

revoke truncate on table "public"."paper_reports" from "anon";

revoke update on table "public"."paper_reports" from "anon";

revoke delete on table "public"."paper_reports" from "authenticated";

revoke insert on table "public"."paper_reports" from "authenticated";

revoke references on table "public"."paper_reports" from "authenticated";

revoke select on table "public"."paper_reports" from "authenticated";

revoke trigger on table "public"."paper_reports" from "authenticated";

revoke truncate on table "public"."paper_reports" from "authenticated";

revoke update on table "public"."paper_reports" from "authenticated";

revoke delete on table "public"."paper_reports" from "service_role";

revoke insert on table "public"."paper_reports" from "service_role";

revoke references on table "public"."paper_reports" from "service_role";

revoke select on table "public"."paper_reports" from "service_role";

revoke trigger on table "public"."paper_reports" from "service_role";

revoke truncate on table "public"."paper_reports" from "service_role";

revoke update on table "public"."paper_reports" from "service_role";

revoke delete on table "public"."papers" from "anon";

revoke insert on table "public"."papers" from "anon";

revoke references on table "public"."papers" from "anon";

revoke select on table "public"."papers" from "anon";

revoke trigger on table "public"."papers" from "anon";

revoke truncate on table "public"."papers" from "anon";

revoke update on table "public"."papers" from "anon";

revoke delete on table "public"."papers" from "authenticated";

revoke insert on table "public"."papers" from "authenticated";

revoke references on table "public"."papers" from "authenticated";

revoke select on table "public"."papers" from "authenticated";

revoke trigger on table "public"."papers" from "authenticated";

revoke truncate on table "public"."papers" from "authenticated";

revoke update on table "public"."papers" from "authenticated";

revoke delete on table "public"."papers" from "service_role";

revoke insert on table "public"."papers" from "service_role";

revoke references on table "public"."papers" from "service_role";

revoke select on table "public"."papers" from "service_role";

revoke trigger on table "public"."papers" from "service_role";

revoke truncate on table "public"."papers" from "service_role";

revoke update on table "public"."papers" from "service_role";

revoke delete on table "public"."ratings" from "anon";

revoke insert on table "public"."ratings" from "anon";

revoke references on table "public"."ratings" from "anon";

revoke select on table "public"."ratings" from "anon";

revoke trigger on table "public"."ratings" from "anon";

revoke truncate on table "public"."ratings" from "anon";

revoke update on table "public"."ratings" from "anon";

revoke delete on table "public"."ratings" from "authenticated";

revoke insert on table "public"."ratings" from "authenticated";

revoke references on table "public"."ratings" from "authenticated";

revoke select on table "public"."ratings" from "authenticated";

revoke trigger on table "public"."ratings" from "authenticated";

revoke truncate on table "public"."ratings" from "authenticated";

revoke update on table "public"."ratings" from "authenticated";

revoke delete on table "public"."ratings" from "service_role";

revoke insert on table "public"."ratings" from "service_role";

revoke references on table "public"."ratings" from "service_role";

revoke select on table "public"."ratings" from "service_role";

revoke trigger on table "public"."ratings" from "service_role";

revoke truncate on table "public"."ratings" from "service_role";

revoke update on table "public"."ratings" from "service_role";

revoke delete on table "public"."user_comment_preferences" from "anon";

revoke insert on table "public"."user_comment_preferences" from "anon";

revoke references on table "public"."user_comment_preferences" from "anon";

revoke select on table "public"."user_comment_preferences" from "anon";

revoke trigger on table "public"."user_comment_preferences" from "anon";

revoke truncate on table "public"."user_comment_preferences" from "anon";

revoke update on table "public"."user_comment_preferences" from "anon";

revoke delete on table "public"."user_comment_preferences" from "authenticated";

revoke insert on table "public"."user_comment_preferences" from "authenticated";

revoke references on table "public"."user_comment_preferences" from "authenticated";

revoke select on table "public"."user_comment_preferences" from "authenticated";

revoke trigger on table "public"."user_comment_preferences" from "authenticated";

revoke truncate on table "public"."user_comment_preferences" from "authenticated";

revoke update on table "public"."user_comment_preferences" from "authenticated";

revoke delete on table "public"."user_comment_preferences" from "service_role";

revoke insert on table "public"."user_comment_preferences" from "service_role";

revoke references on table "public"."user_comment_preferences" from "service_role";

revoke select on table "public"."user_comment_preferences" from "service_role";

revoke trigger on table "public"."user_comment_preferences" from "service_role";

revoke truncate on table "public"."user_comment_preferences" from "service_role";

revoke update on table "public"."user_comment_preferences" from "service_role";

revoke delete on table "public"."user_follows" from "anon";

revoke insert on table "public"."user_follows" from "anon";

revoke references on table "public"."user_follows" from "anon";

revoke select on table "public"."user_follows" from "anon";

revoke trigger on table "public"."user_follows" from "anon";

revoke truncate on table "public"."user_follows" from "anon";

revoke update on table "public"."user_follows" from "anon";

revoke delete on table "public"."user_follows" from "authenticated";

revoke insert on table "public"."user_follows" from "authenticated";

revoke references on table "public"."user_follows" from "authenticated";

revoke select on table "public"."user_follows" from "authenticated";

revoke trigger on table "public"."user_follows" from "authenticated";

revoke truncate on table "public"."user_follows" from "authenticated";

revoke update on table "public"."user_follows" from "authenticated";

revoke delete on table "public"."user_follows" from "service_role";

revoke insert on table "public"."user_follows" from "service_role";

revoke references on table "public"."user_follows" from "service_role";

revoke select on table "public"."user_follows" from "service_role";

revoke trigger on table "public"."user_follows" from "service_role";

revoke truncate on table "public"."user_follows" from "service_role";

revoke update on table "public"."user_follows" from "service_role";

revoke delete on table "public"."users" from "anon";

revoke insert on table "public"."users" from "anon";

revoke references on table "public"."users" from "anon";

revoke select on table "public"."users" from "anon";

revoke trigger on table "public"."users" from "anon";

revoke truncate on table "public"."users" from "anon";

revoke update on table "public"."users" from "anon";

revoke delete on table "public"."users" from "authenticated";

revoke insert on table "public"."users" from "authenticated";

revoke references on table "public"."users" from "authenticated";

revoke select on table "public"."users" from "authenticated";

revoke trigger on table "public"."users" from "authenticated";

revoke truncate on table "public"."users" from "authenticated";

revoke update on table "public"."users" from "authenticated";

revoke delete on table "public"."users" from "service_role";

revoke insert on table "public"."users" from "service_role";

revoke references on table "public"."users" from "service_role";

revoke select on table "public"."users" from "service_role";

revoke trigger on table "public"."users" from "service_role";

revoke truncate on table "public"."users" from "service_role";

revoke update on table "public"."users" from "service_role";

revoke delete on table "public"."visit_counters" from "anon";

revoke insert on table "public"."visit_counters" from "anon";

revoke references on table "public"."visit_counters" from "anon";

revoke select on table "public"."visit_counters" from "anon";

revoke trigger on table "public"."visit_counters" from "anon";

revoke truncate on table "public"."visit_counters" from "anon";

revoke update on table "public"."visit_counters" from "anon";

revoke delete on table "public"."visit_counters" from "authenticated";

revoke insert on table "public"."visit_counters" from "authenticated";

revoke references on table "public"."visit_counters" from "authenticated";

revoke select on table "public"."visit_counters" from "authenticated";

revoke trigger on table "public"."visit_counters" from "authenticated";

revoke truncate on table "public"."visit_counters" from "authenticated";

revoke update on table "public"."visit_counters" from "authenticated";

revoke delete on table "public"."visit_counters" from "service_role";

revoke insert on table "public"."visit_counters" from "service_role";

revoke references on table "public"."visit_counters" from "service_role";

revoke select on table "public"."visit_counters" from "service_role";

revoke trigger on table "public"."visit_counters" from "service_role";

revoke truncate on table "public"."visit_counters" from "service_role";

revoke update on table "public"."visit_counters" from "service_role";

alter table "public"."announcements" drop constraint "announcements_type_check";

alter table "public"."paper_reports" drop constraint "paper_reports_source_check";

alter table "public"."annotation_comments" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."annotation_likes" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."annotation_shares" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."annotations" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."collaboration_sessions" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."comment_votes" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."comments" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."documents" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."paper_favorites" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."paper_reports" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."papers" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."ratings" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."user_follows" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."announcements" add constraint "announcements_type_check" CHECK (((type)::text = ANY ((ARRAY['info'::character varying, 'warning'::character varying, 'success'::character varying, 'error'::character varying])::text[]))) not valid;

alter table "public"."announcements" validate constraint "announcements_type_check";

alter table "public"."paper_reports" add constraint "paper_reports_source_check" CHECK (((source)::text = ANY ((ARRAY['wechat'::character varying, 'news'::character varying, 'blog'::character varying, 'other'::character varying])::text[]))) not valid;

alter table "public"."paper_reports" validate constraint "paper_reports_source_check";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.find_or_create_paper_by_doi(p_doi text, p_title text DEFAULT NULL::text, p_authors text[] DEFAULT NULL::text[], p_abstract text DEFAULT NULL::text, p_journal text DEFAULT NULL::text, p_publication_date date DEFAULT NULL::date, p_keywords text[] DEFAULT NULL::text[], p_created_by uuid DEFAULT NULL::uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    paper_id_found UUID;
    new_paper_id UUID;
BEGIN
    -- 首先尝试通过DOI查找现有论文
    SELECT id INTO paper_id_found
    FROM public.papers
    WHERE doi = p_doi
    LIMIT 1;
    
    -- 如果找到了，返回现有ID
    IF paper_id_found IS NOT NULL THEN
        RETURN paper_id_found;
    END IF;
    
    -- 如果没找到且提供了必要信息，创建新论文
    IF p_title IS NOT NULL AND p_created_by IS NOT NULL THEN
        INSERT INTO public.papers (
            doi, 
            title, 
            authors, 
            abstract, 
            journal, 
            publication_date, 
            keywords, 
            created_by
        ) VALUES (
            p_doi,
            p_title,
            COALESCE(p_authors, ARRAY[]::TEXT[]),
            p_abstract,
            p_journal,
            p_publication_date,
            COALESCE(p_keywords, ARRAY[]::TEXT[]),
            p_created_by
        ) RETURNING id INTO new_paper_id;
        
        RETURN new_paper_id;
    END IF;
    
    -- 如果无法创建，返回NULL
    RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_annotation_comment_tree(p_annotation_id uuid)
 RETURNS TABLE(id uuid, annotation_id uuid, user_id uuid, content text, created_at timestamp with time zone, updated_at timestamp with time zone, parent_id uuid, reply_count integer, depth integer, path uuid[], is_anonymous boolean, username text, avatar_url text)
 LANGUAGE sql
 STABLE
AS $function$
  WITH RECURSIVE comment_tree AS (
    -- 根评论
    SELECT 
      c.id,
      c.annotation_id,
      c.user_id,
      c.content,
      c.created_at,
      c.updated_at,
      c.parent_id,
      c.reply_count,
      0 as depth,
      ARRAY[c.id] as path,
      COALESCE(c.is_anonymous, false) as is_anonymous,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN '匿名用户'
        ELSE COALESCE(u.username, 'Anonymous')
      END as username,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN NULL
        ELSE u.avatar_url
      END as avatar_url
    FROM annotation_comments c
    LEFT JOIN users u ON c.user_id = u.id
    WHERE c.annotation_id = p_annotation_id 
      AND c.parent_id IS NULL
    
    UNION ALL
    
    -- 递归获取子评论
    SELECT 
      c.id,
      c.annotation_id,
      c.user_id,
      c.content,
      c.created_at,
      c.updated_at,
      c.parent_id,
      c.reply_count,
      ct.depth + 1,
      ct.path || c.id,
      COALESCE(c.is_anonymous, false) as is_anonymous,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN '匿名用户'
        ELSE COALESCE(u.username, 'Anonymous')
      END as username,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN NULL
        ELSE u.avatar_url
      END as avatar_url
    FROM annotation_comments c
    INNER JOIN comment_tree ct ON c.parent_id = ct.id
    LEFT JOIN users u ON c.user_id = u.id
  )
  SELECT * FROM comment_tree
  ORDER BY path;
$function$
;

CREATE OR REPLACE FUNCTION public.get_counter(counter_name text)
 RETURNS bigint
 LANGUAGE plpgsql
AS $function$
DECLARE
  counter_val BIGINT;
BEGIN
  SELECT counter_value INTO counter_val
  FROM public.visit_counters
  WHERE counter_type = counter_name;
  
  RETURN COALESCE(counter_val, 0);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_paper_comment_tree(p_paper_id uuid)
 RETURNS TABLE(id uuid, paper_id uuid, user_id uuid, content text, created_at timestamp with time zone, updated_at timestamp with time zone, parent_id uuid, reply_count integer, depth integer, path uuid[], is_anonymous boolean, username text, avatar_url text)
 LANGUAGE sql
 STABLE
AS $function$
  WITH RECURSIVE comment_tree AS (
    -- 根评论
    SELECT 
      c.id,
      c.paper_id,
      c.user_id,
      c.content,
      c.created_at,
      c.updated_at,
      c.parent_id,
      c.reply_count,
      0 as depth,
      ARRAY[c.id] as path,
      COALESCE(c.is_anonymous, false) as is_anonymous,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN '匿名用户'
        ELSE COALESCE(u.username, 'Anonymous')
      END as username,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN NULL
        ELSE u.avatar_url
      END as avatar_url
    FROM comments c
    LEFT JOIN users u ON c.user_id = u.id
    WHERE c.paper_id = p_paper_id 
      AND c.parent_id IS NULL
    
    UNION ALL
    
    -- 递归获取子评论
    SELECT 
      c.id,
      c.paper_id,
      c.user_id,
      c.content,
      c.created_at,
      c.updated_at,
      c.parent_id,
      c.reply_count,
      ct.depth + 1,
      ct.path || c.id,
      COALESCE(c.is_anonymous, false) as is_anonymous,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN '匿名用户'
        ELSE COALESCE(u.username, 'Anonymous')
      END as username,
      CASE 
        WHEN COALESCE(c.is_anonymous, false) = true THEN NULL
        ELSE u.avatar_url
      END as avatar_url
    FROM comments c
    INNER JOIN comment_tree ct ON c.parent_id = ct.id
    LEFT JOIN users u ON c.user_id = u.id
  )
  SELECT * FROM comment_tree
  ORDER BY path;
$function$
;

CREATE OR REPLACE FUNCTION public.get_paper_zotero_annotations(target_paper_id uuid)
 RETURNS TABLE(annotation_id uuid, document_id uuid, user_id uuid, type text, content text, comment text, color text, "position" jsonb, tags text[], visibility text, likes_count integer, comments_count integer, created_at timestamp with time zone, platform text, quality_score numeric, helpfulness_score numeric, display_name text, username text, user_avatar text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        pa.annotation_id,
        pa.document_id,
        pa.user_id,
        pa.type,
        pa.content,
        pa.comment,
        pa.color,
        pa."position",
        pa.tags,
        pa.visibility,
        pa.likes_count,
        pa.comments_count,
        pa.annotation_created_at as created_at,
        pa.platform,
        pa.quality_score,
        pa.helpfulness_score,
        pa.display_name,
        pa.username,
        pa.user_avatar
    FROM public.paper_annotations pa
    WHERE pa.paper_id = target_paper_id 
    AND pa.visibility IN ('public', 'shared')
    AND pa.platform = 'zotero'
    ORDER BY pa.annotation_created_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_shared_annotations_with_users(doc_id uuid)
 RETURNS TABLE(id uuid, document_id uuid, user_id uuid, type text, content text, comment text, color text, "position" jsonb, tags text[], visibility text, likes_count integer, comments_count integer, shares_count integer, created_at timestamp with time zone, updated_at timestamp with time zone, version integer, parent_id uuid, platform text, original_id text, permissions jsonb, quality_score numeric, helpfulness_score numeric, show_author_name boolean, author_name text, username text, user_email text, user_avatar text, display_name text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT * FROM public.annotations_with_users
    WHERE document_id = doc_id 
    AND visibility IN ('public', 'shared')
    ORDER BY created_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_annotation_stats(user_uuid uuid)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'total_annotations', COALESCE(COUNT(a.id), 0),
    'public_annotations', COALESCE(COUNT(CASE WHEN a.visibility = 'public' THEN 1 END), 0),
    'shared_annotations', COALESCE(COUNT(CASE WHEN a.visibility IN ('shared', 'public') THEN 1 END), 0),
    'total_likes', COALESCE(SUM(a.likes_count), 0),
    'total_comments', COALESCE(SUM(a.comments_count), 0),
    'documents_annotated', COALESCE(COUNT(DISTINCT a.document_id), 0)
  ) INTO result
  FROM public.annotations a
  WHERE a.user_id = user_uuid;
  
  RETURN result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_display_name(user_uuid uuid, show_real_name boolean)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  real_name TEXT;
  username TEXT;
BEGIN
  -- 如果不显示真实姓名，返回匿名标识
  IF NOT show_real_name THEN
    RETURN '匿名用户';
  END IF;
  
  -- 尝试获取真实姓名和用户名
  SELECT u.username INTO username
  FROM public.users u 
  WHERE u.id = user_uuid;
  
  -- 如果没有找到用户，返回匿名
  IF username IS NULL THEN
    RETURN '匿名用户';
  END IF;
  
  -- 返回用户名
  RETURN username;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  generated_username TEXT;
  counter INTEGER := 0;
  base_username TEXT;
BEGIN
  -- 生成基础用户名
  base_username := COALESCE(
    NEW.raw_user_meta_data->>'username',
    NEW.raw_user_meta_data->>'name', 
    NEW.raw_user_meta_data->>'full_name',
    split_part(NEW.email, '@', 1)
  );
  
  -- 确保用户名不为空
  IF base_username IS NULL OR base_username = '' THEN
    base_username := 'user_' || substring(NEW.id::text from 1 for 8);
  END IF;
  
  generated_username := base_username;
  
  -- 检查用户名是否已存在，如果存在则添加数字后缀
  WHILE EXISTS (SELECT 1 FROM public.users WHERE username = generated_username AND id != NEW.id) LOOP
    counter := counter + 1;
    generated_username := base_username || '_' || counter::text;
  END LOOP;
  
  INSERT INTO public.users (id, email, username)
  VALUES (NEW.id, NEW.email, generated_username)
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    username = COALESCE(EXCLUDED.username, public.users.username);
    
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    new.updated_at = now();
    RETURN new;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_counter(counter_name text, increment_by integer DEFAULT 1)
 RETURNS bigint
 LANGUAGE plpgsql
AS $function$
DECLARE
  new_value BIGINT;
BEGIN
  -- 更新计数器并返回新值
  UPDATE public.visit_counters 
  SET 
    counter_value = counter_value + increment_by,
    last_updated = NOW()
  WHERE counter_type = counter_name
  RETURNING counter_value INTO new_value;
  
  -- 如果计数器不存在，创建它
  IF new_value IS NULL THEN
    INSERT INTO public.visit_counters (counter_type, counter_value, last_updated)
    VALUES (counter_name, increment_by, NOW())
    RETURNING counter_value INTO new_value;
  END IF;
  
  RETURN new_value;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_visit_counter()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- 增加总访问量
  INSERT INTO public.realtime_counters (counter_name, counter_value, last_updated)
  VALUES ('total_visits', 1, NOW())
  ON CONFLICT (counter_name) 
  DO UPDATE SET 
    counter_value = public.realtime_counters.counter_value + 1,
    last_updated = NOW();
  
  -- 增加今日访问量
  INSERT INTO public.realtime_counters (counter_name, counter_value, last_updated)
  VALUES ('today_visits', 1, NOW())
  ON CONFLICT (counter_name) 
  DO UPDATE SET 
    counter_value = public.realtime_counters.counter_value + 1,
    last_updated = NOW();
END;
$function$
;

CREATE OR REPLACE FUNCTION public.link_documents_to_papers()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    linked_count INTEGER := 0;
    doc_record RECORD;
    paper_id_found UUID;
BEGIN
    -- 遍历所有有DOI且未关联的文档
    FOR doc_record IN 
        SELECT id, doi, title, authors 
        FROM public.documents 
        WHERE doi IS NOT NULL 
        AND paper_id IS NULL
    LOOP
        -- 尝试通过DOI匹配论文
        SELECT id INTO paper_id_found
        FROM public.papers 
        WHERE doi = doc_record.doi
        LIMIT 1;
        
        -- 如果找到匹配的论文，建立关联
        IF paper_id_found IS NOT NULL THEN
            UPDATE public.documents 
            SET paper_id = paper_id_found
            WHERE id = doc_record.id;
            
            linked_count := linked_count + 1;
        END IF;
    END LOOP;
    
    RETURN linked_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.record_visit()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.page_visits (date, visit_count) VALUES (CURRENT_DATE, 1);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.reset_today_counter()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  UPDATE public.realtime_counters 
  SET counter_value = 0, last_updated = NOW()
  WHERE counter_name = 'today_visits';
END;
$function$
;

CREATE OR REPLACE FUNCTION public.reset_today_visits()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  UPDATE public.visit_counters 
  SET counter_value = 0, last_updated = NOW()
  WHERE counter_type = 'today_visits';
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_annotation_comments_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE annotations 
    SET comments_count = comments_count + 1, updated_at = NOW()
    WHERE id = NEW.annotation_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE annotations 
    SET comments_count = GREATEST(0, comments_count - 1), updated_at = NOW()
    WHERE id = OLD.annotation_id;
  END IF;
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_annotation_likes_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE annotations 
    SET likes_count = likes_count + 1, updated_at = NOW()
    WHERE id = NEW.annotation_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE annotations 
    SET likes_count = GREATEST(0, likes_count - 1), updated_at = NOW()
    WHERE id = OLD.annotation_id;
  END IF;
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_comment_reply_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF TG_OP = 'INSERT' AND NEW.parent_id IS NOT NULL THEN
    UPDATE annotation_comments 
    SET reply_count = reply_count + 1, updated_at = NOW()
    WHERE id = NEW.parent_id;
  ELSIF TG_OP = 'DELETE' AND OLD.parent_id IS NOT NULL THEN
    UPDATE annotation_comments 
    SET reply_count = GREATEST(0, reply_count - 1), updated_at = NOW()
    WHERE id = OLD.parent_id;
  END IF;
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_paper_comment_reply_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF TG_OP = 'INSERT' THEN
    -- 插入时更新父评论的 reply_count
    IF NEW.parent_id IS NOT NULL THEN
      UPDATE comments 
      SET reply_count = reply_count + 1
      WHERE id = NEW.parent_id;
    END IF;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    -- 删除时更新父评论的 reply_count
    IF OLD.parent_id IS NOT NULL THEN
      UPDATE comments 
      SET reply_count = GREATEST(reply_count - 1, 0)
      WHERE id = OLD.parent_id;
    END IF;
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_paper_comments_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    paper_uuid UUID;
BEGIN
    IF TG_OP = 'DELETE' THEN
        paper_uuid := OLD.paper_id;
    ELSE
        paper_uuid := NEW.paper_id;
    END IF;

    UPDATE papers
    SET 
        comments_count = (SELECT COUNT(*) FROM comments WHERE paper_id = paper_uuid),
        updated_at = NOW()
    WHERE id = paper_uuid;

    RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_paper_rating_stats()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    paper_uuid UUID;
BEGIN
    -- 确定要更新的paper_id
    IF TG_OP = 'DELETE' THEN
        paper_uuid := OLD.paper_id;
    ELSE
        paper_uuid := NEW.paper_id;
    END IF;

    -- 更新论文的评分统计
    UPDATE papers
    SET 
        ratings_count = (SELECT COUNT(*) FROM ratings WHERE paper_id = paper_uuid),
        average_rating = (SELECT ROUND(AVG(overall_score)::numeric, 1) FROM ratings WHERE paper_id = paper_uuid),
        updated_at = NOW()
    WHERE id = paper_uuid;

    RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_paper_reports_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;



