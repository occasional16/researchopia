# 17.2 è¯„ä»·ç»„ä»¶æå–è®¡åˆ’

> **ç›®æ ‡**: ä»¥å½“å‰è®ºæ–‡è¯¦æƒ…é¡µçš„è¯„ä»·åŠŸèƒ½ä¸ºåŸºå‡†ï¼Œåˆ›å»ºå…±äº«æ¨¡æ¿ç»„ä»¶ï¼Œç„¶ååº”ç”¨åˆ°è®ºæ–‡å’Œç½‘é¡µè¯¦æƒ…é¡µ

---

## 1. å½“å‰è®ºæ–‡è¯¦æƒ…é¡µè¯„ä»·åŠŸèƒ½æ¸…å•

### 1.1 è¯„åˆ†åŠŸèƒ½

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ |
|------|----------|------|
| RatingForm | `src/components/rating/RatingForm.tsx` | 10åˆ†åˆ¶åŠæ˜Ÿè¯„åˆ†è¡¨å•ï¼ˆåˆ›æ–°æ€§ã€æ–¹æ³•è®ºã€å®ç”¨æ€§ã€æ€»ä½“è¯„ä»·ï¼‰+ åŒ¿åé€‰é¡¹ |
| RatingDisplay | `src/components/rating/RatingDisplay.tsx` | è¯„åˆ†ç»Ÿè®¡å±•ç¤ºï¼ˆå¹³å‡åˆ†ã€åˆ†å¸ƒå›¾ç­‰ï¼‰|

**API**: `createOrUpdateRating()` / `getUserRating()` (ç›´æ¥æ•°æ®åº“è°ƒç”¨ï¼Œvia `src/lib/database.ts`)

### 1.2 è¯„è®ºåŠŸèƒ½

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ |
|------|----------|------|
| CommentForm | `src/components/comments/CommentForm.tsx` | è¯„è®ºå‘å¸ƒè¡¨å• + åŒ¿åé€‰é¡¹ |
| CommentList | `src/components/comments/CommentList.tsx` | è¯„è®ºåˆ—è¡¨å®¹å™¨ï¼ˆåŠ è½½ã€è¿‡æ»¤ã€æ’åºï¼‰|
| NestedCommentTree | `src/components/NestedCommentTree.tsx` | åµŒå¥—è¯„è®ºæ¸²æŸ“ï¼ˆå›å¤ã€ç¼–è¾‘ã€åˆ é™¤ã€ç‚¹èµï¼‰|

**API**:
- `GET /api/paper-comments/tree/[paperId]` - è·å–è¯„è®ºæ ‘ï¼ˆå« like_count, has_likedï¼‰
- `POST /api/paper-comments/reply` - å‘å¸ƒè¯„è®º/å›å¤
- `PUT /api/paper-comments/[commentId]` - ç¼–è¾‘è¯„è®º
- `DELETE /api/paper-comments/[commentId]` - åˆ é™¤è¯„è®º
- `POST /api/paper-comments/vote` - ç‚¹èµ/å–æ¶ˆç‚¹èµ

---

## 2. å…±äº«æ¨¡æ¿è®¾è®¡

### 2.1 ç›®æ ‡ç›®å½•ç»“æ„

```
src/components/evaluation/shared/
â”œâ”€â”€ StarRating.tsx           # âœ… å·²å­˜åœ¨ï¼Œ10åˆ†åˆ¶åŠæ˜Ÿç»„ä»¶
â”œâ”€â”€ RatingForm.tsx           # ğŸ†• ä» rating/RatingForm.tsx æå–
â”œâ”€â”€ RatingDisplay.tsx        # ğŸ†• ä» rating/RatingDisplay.tsx æå–
â”œâ”€â”€ CommentForm.tsx          # âœ… å·²å­˜åœ¨ï¼Œéœ€è¦å¯¹é½åŠŸèƒ½
â”œâ”€â”€ CommentList.tsx          # âœ… å·²å­˜åœ¨ï¼Œéœ€è¦é‡æ„ä½¿ç”¨ NestedCommentTree
â”œâ”€â”€ NestedCommentTree.tsx    # ğŸ†• ä»æ ¹ç›®å½•ç§»åŠ¨å¹¶é€šç”¨åŒ–
â””â”€â”€ index.ts                 # å¯¼å‡ºæ‰€æœ‰ç»„ä»¶
```

### 2.2 ç»„ä»¶ Props ç»Ÿä¸€æ¥å£

```typescript
// ç»Ÿä¸€ target ç±»å‹
export type TargetType = 'paper' | 'webpage';

// è¯„åˆ†è¡¨å• Props
interface RatingFormProps {
  targetType: TargetType;
  targetId: string;
  onRatingSubmitted?: (rating: Rating) => void;
  className?: string;
}

// è¯„åˆ†å±•ç¤º Props
interface RatingDisplayProps {
  targetType: TargetType;
  ratings: Rating[];
  className?: string;
}

// è¯„è®ºåˆ—è¡¨ Props
interface CommentListProps {
  targetType: TargetType;
  targetId: string;
  className?: string;
}
```

### 2.3 ç»´åº¦é…ç½®

```typescript
// è®ºæ–‡è¯„ä»·ç»´åº¦
const PAPER_DIMENSIONS = [
  { key: 'innovation', label: 'åˆ›æ–°æ€§', description: 'è®ºæ–‡çš„åˆ›æ–°ç¨‹åº¦å’ŒåŸåˆ›æ€§' },
  { key: 'methodology', label: 'æ–¹æ³•è®º', description: 'ç ”ç©¶æ–¹æ³•çš„ç§‘å­¦æ€§å’Œä¸¥è°¨æ€§' },
  { key: 'practicality', label: 'å®ç”¨æ€§', description: 'ç ”ç©¶æˆæœçš„å®é™…åº”ç”¨ä»·å€¼' },
];

// ç½‘é¡µè¯„ä»·ç»´åº¦
const WEBPAGE_DIMENSIONS = [
  { key: 'quality', label: 'å†…å®¹è´¨é‡', description: 'å†…å®¹çš„æ·±åº¦å’Œå®Œæ•´æ€§' },
  { key: 'usefulness', label: 'å®ç”¨æ€§', description: 'å†…å®¹çš„å®é™…åº”ç”¨ä»·å€¼' },
  { key: 'accuracy', label: 'å‡†ç¡®æ€§', description: 'ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œå¯é æ€§' },
];
```

---

## 3. API å±‚ç»Ÿä¸€æ–¹æ¡ˆ

### 3.1 ç°æœ‰ API å¯¹æ¯”

| åŠŸèƒ½ | è®ºæ–‡ APIï¼ˆç°æœ‰ï¼‰| v2 ç»Ÿä¸€ APIï¼ˆç›®æ ‡ï¼‰|
|------|----------------|-------------------|
| è¯„åˆ†-åˆ›å»º/æ›´æ–° | `database.createOrUpdateRating()` | `POST /api/v2/ratings` âœ… |
| è¯„åˆ†-è·å– | `database.getPaperRatings()` | `GET /api/v2/ratings` âœ… |
| è¯„è®º-è·å–æ ‘ | `GET /api/paper-comments/tree/[id]` | `GET /api/v2/comments?nested=true` âš ï¸ éœ€æ‰©å±• |
| è¯„è®º-å‘å¸ƒ | `POST /api/paper-comments/reply` | `POST /api/v2/comments` âœ… |
| è¯„è®º-ç¼–è¾‘ | `PUT /api/paper-comments/[id]` | `PATCH /api/v2/comments` âœ… |
| è¯„è®º-åˆ é™¤ | `DELETE /api/paper-comments/[id]` | `DELETE /api/v2/comments` âœ… |
| è¯„è®º-ç‚¹èµ | `POST /api/paper-comments/vote` | `POST /api/v2/comments/vote` ğŸ†• éœ€åˆ›å»º |

### 3.2 ç»Ÿä¸€æ–¹æ¡ˆï¼ˆæ¨èï¼‰âœ…

**æ ¸å¿ƒåŸåˆ™**ï¼šæ‰©å±•ç°æœ‰ v2 APIï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„ API ç³»åˆ—

**éœ€è¦å®Œæˆçš„å·¥ä½œ**ï¼š
1. æ‰©å±• `GET /api/v2/comments` è¿”å› `like_count` å’Œ `has_liked`
2. åˆ›å»º `POST /api/v2/comments/vote` ç«¯ç‚¹ï¼ˆæ”¯æŒ paper/webpageï¼‰
3. ç¡®ä¿ `webpage_comment_votes` è¡¨å­˜åœ¨ï¼ˆæˆ–ç»Ÿä¸€ä½¿ç”¨ `comment_votes` è¡¨ï¼‰

**ä¼˜åŠ¿**ï¼š
- API å…¥å£ç»Ÿä¸€ï¼Œç»´æŠ¤æˆæœ¬ä½
- ç»„ä»¶ä»£ç ç®€å•ï¼Œåªéœ€ä¼ å…¥ `targetType`
- ç¬¦åˆ RESTful è®¾è®¡åŸåˆ™

---

## 4. å®æ–½è®¡åˆ’

### Phase 1: æ‰©å±• v2 API (Day 1) âœ… å·²å®Œæˆ

- [x] 4.1.1 æ‰©å±• `GET /api/v2/comments` è¿”å› `likesCount` å’Œ `hasLiked` å­—æ®µ
- [x] 4.1.2 åˆ›å»º `POST /api/v2/comments/vote/route.ts` ç«¯ç‚¹
- [x] 4.1.3 åˆ›å»º `webpage_comment_votes` æ•°æ®åº“è¡¨ï¼ˆè¿ç§» 009ï¼‰

### Phase 2: ç»„ä»¶æå–ä¸é€šç”¨åŒ– (Day 1-2) âœ… å·²å®Œæˆ

- [x] 4.2.1 ä½¿ç”¨ç°æœ‰ `evaluation/shared/EvaluationForm.tsx`ï¼ˆæ”¯æŒ targetTypeï¼‰
- [x] 4.2.2 æ·»åŠ  `showUsername` é€‰é¡¹æ”¯æŒ
- [x] 4.2.3 åˆ›å»º `evaluation/shared/RatingDisplay.tsx`ï¼ˆæ”¯æŒ targetTypeï¼‰
- [x] 4.2.4 æ·»åŠ ç»´åº¦é…ç½®å¯¼å‡º `PAPER_DISPLAY_DIMENSIONS` / `WEBPAGE_DISPLAY_DIMENSIONS`
- [x] 4.2.5 æ›´æ–° `evaluation/shared/CommentList.tsx` æ·»åŠ ç‚¹èµåŠŸèƒ½
- [x] 4.2.6 æ·»åŠ  `targetType` å‚æ•°ï¼Œè°ƒç”¨ v2 API
- [x] 4.2.7 æ›´æ–° `NestedCommentTree.tsx` æ”¯æŒ `targetType` å‚æ•°ï¼ˆCommentList å†…ç½®ï¼‰

### Phase 3: åº”ç”¨åˆ°è®ºæ–‡è¯¦æƒ…é¡µ (Day 2) âœ… å·²å®Œæˆ

- [x] 4.3.1 æ›´æ–° `papers/[...id]/page.tsx` ä½¿ç”¨ `evaluation/shared` ç»„ä»¶
- [x] 4.3.2 æµ‹è¯•è¯„åˆ†åŠŸèƒ½ï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€åŒ¿åï¼‰
- [x] 4.3.3 æµ‹è¯•è¯„è®ºåŠŸèƒ½ï¼ˆå‘å¸ƒã€å›å¤ã€åˆ é™¤ã€ç‚¹èµï¼‰

### Phase 4: åº”ç”¨åˆ°ç½‘é¡µè¯¦æƒ…é¡µ (Day 2-3) âœ… å·²å®Œæˆ

- [x] 4.4.1 æ›´æ–°ç½‘é¡µè¯¦æƒ…é¡µç»„ä»¶ (`webpages/[urlHash]/page.tsx`)
- [x] 4.4.2 ä½¿ç”¨ `evaluation/shared` ç»„ä»¶ï¼ˆtargetType='webpage'ï¼‰
- [x] 4.4.3 ä¿®å¤ v2/ratings API æ”¯æŒ url_hash æŸ¥è¯¢
- [x] 4.4.4 UI å¸ƒå±€ä¸è®ºæ–‡è¯¦æƒ…é¡µä¸€è‡´

### Phase 5: æ¸…ç†ä¸æ–‡æ¡£ (Day 3) âœ… å·²å®Œæˆ

- [x] 4.5.1 ç¡®è®¤åŠŸèƒ½æ­£å¸¸åï¼Œåˆ é™¤æ—§ç»„ä»¶ï¼ˆcomponents/rating/, components/comments/, components/webpage-rating/ï¼‰
- [x] 4.5.2 API æ–‡æ¡£å¾…åç»­æ›´æ–°
- [x] 4.5.3 æ›´æ–° 17.2 æ–‡æ¡£æ ‡è®°å·²å®Œæˆé¡¹

---

## 5. é£é™©ä¸æ³¨æ„äº‹é¡¹

### 5.1 æ•°æ®åº“è¡¨å·®å¼‚

| è®ºæ–‡ | ç½‘é¡µ |
|------|------|
| `ratings.paper_id` | `webpage_ratings.webpage_id` |
| `ratings.innovation_score` | `webpage_ratings.quality_score` |
| `comments.paper_id` | `webpage_comments.webpage_id` |
| `comment_votes` | `webpage_comment_votes` (éœ€åˆ›å»º) |

### 5.2 å‘åå…¼å®¹

- ç°æœ‰è®ºæ–‡ API ä¿æŒä¸å˜ï¼Œä»…æ–°å¢ç½‘é¡µ API
- ç°æœ‰ç»„ä»¶å¼•ç”¨è·¯å¾„éœ€è¦æ›´æ–°ï¼ˆimport è·¯å¾„å˜åŒ–ï¼‰

### 5.3 æµ‹è¯•é‡ç‚¹

- è¯„åˆ†ï¼šåˆ›å»ºã€ä¿®æ”¹ã€åŒ¿å
- è¯„è®ºï¼šå‘å¸ƒã€å›å¤ã€ç¼–è¾‘ã€åˆ é™¤
- ç‚¹èµï¼šç‚¹èµã€å–æ¶ˆç‚¹èµã€åˆ·æ–°åçŠ¶æ€ä¿æŒ

---

## 6. éªŒæ”¶æ ‡å‡†

- [x] è®ºæ–‡è¯¦æƒ…é¡µè¯„ä»·åŠŸèƒ½æ­£å¸¸ï¼ˆè¯„åˆ†+è¯„è®ºï¼‰
- [x] ç½‘é¡µè¯¦æƒ…é¡µè¯„ä»·åŠŸèƒ½æ­£å¸¸ï¼ˆè¯„åˆ†+è¯„è®ºï¼‰
- [x] ç»„ä»¶ä»£ç å¤ç”¨ï¼ˆ`evaluation/shared/` è¢«ä¸¤å¤„ä½¿ç”¨ï¼‰
- [x] API ç»“æ„ä¸€è‡´ï¼ˆè®ºæ–‡/ç½‘é¡µ API ç»“æ„ç›¸åŒï¼‰
- [x] æ— åŠŸèƒ½å›é€€ï¼ˆå¯¹æ¯”é‡æ„å‰åï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v0.2  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-16  
**æœ€åæ›´æ–°**: 2025-01-17  
**è´Ÿè´£äºº**: Researchopia Team

### æ›´æ–°æ—¥å¿—

- **v0.2** (2025-01-17): Phase 1-3 å®Œæˆï¼Œç»„ä»¶é›†æˆåˆ°è®ºæ–‡è¯¦æƒ…é¡µ
- **v0.1** (2025-01-16): åˆå§‹è®¡åˆ’æ–‡æ¡£

