# 10.5 网页评价体系设计 | Webpage Evaluation System

**构建通用评价体系，为知识网奠定基础**

---

## 一、核心概念

### 1.1 为什么需要"网页评价"？

| 现有体系 | 新增体系 | 关系 |
|----------|----------|------|
| **论文评价** (DOI为识别号) | **网页评价** (URL为识别号) | 网页是论文的超集 |
| 仅覆盖学术论文 | 覆盖任意网页（博客、教程、新闻...） | 扩展适用范围 |
| 网站 + Zotero 插件 | 网站 + **浏览器扩展** | 平台对称 |

### 1.2 与知识网的关系

```
网页评价体系                    知识网
    ↓                            ↓
webpage_ratings    ←复用数据模型→  knowledge_units
webpage_comments   ←复用表结构→   kn_notes
    ↓                            ↓
  URL识别          →自动转化→    知识单元节点
```

**核心价值**：先建立评价体系 → 积累 URL 数据 → 直接迁移到知识网

---

## 二、数据模型设计

### 2.1 新增表（对照现有 ratings/comments）

```sql
-- 网页评分（对照 ratings 表）
webpage_ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL,                -- URL（规范化后）
  url_hash TEXT NOT NULL,           -- URL哈希（索引用）
  user_id UUID NOT NULL REFERENCES users(id),
  -- 评分维度
  quality_score INTEGER NOT NULL CHECK (quality_score >= 1 AND quality_score <= 5),
  usefulness_score INTEGER NOT NULL CHECK (usefulness_score >= 1 AND usefulness_score <= 5),
  accuracy_score INTEGER NOT NULL CHECK (accuracy_score >= 1 AND accuracy_score <= 5),
  overall_score INTEGER NOT NULL CHECK (overall_score >= 1 AND overall_score <= 5),
  -- 元数据
  is_anonymous BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  -- 约束
  UNIQUE(url_hash, user_id)
)

-- 网页评论（对照 comments 表）
webpage_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL,
  url_hash TEXT NOT NULL,
  user_id UUID NOT NULL REFERENCES users(id),
  content TEXT NOT NULL,
  parent_id UUID REFERENCES webpage_comments(id),
  is_anonymous BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)

-- 网页元数据（存储标题、描述、截图等）
webpages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL UNIQUE,
  url_hash TEXT NOT NULL UNIQUE,
  title TEXT,
  description TEXT,
  favicon_url TEXT,
  og_image_url TEXT,              -- Open Graph 图片
  metadata JSONB,                 -- 其他元数据
  first_submitted_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)
```

### 2.2 复用现有表（无需新建）

| 表 | 复用方式 |
|---|----------|
| `users` | 直接复用 |
| `user_activities` | 添加新事件类型 |
| `visit_counters` | 扩展 entity_type |

---

## 三、API 端点设计

### 3.1 网页 CRUD

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/webpages` | POST | 提交新网页 |
| `/api/webpages/:url_hash` | GET | 获取网页详情 |
| `/api/webpages/:url_hash/ratings` | GET/POST | 获取/提交评分 |
| `/api/webpages/:url_hash/comments` | GET/POST | 获取/提交评论 |

### 3.2 浏览器扩展 API

```
# 快速检查（当前页面是否有评价）
GET /api/extension/webpage/check?url=xxx

# 获取评价摘要（用于扩展popup/sidebar显示）
GET /api/extension/webpage/summary?url=xxx

# 提交评分
POST /api/extension/webpage/rate
```

---

## 四、前端组件复用

### 4.1 可复用组件

| 组件 | 原位置 | 复用方式 |
|------|--------|----------|
| `RatingForm` | `src/components/rating/` | 修改 props 接口适配 |
| `RatingDisplay` | `src/components/rating/` | 同上 |
| `CommentForm` | `src/components/comments/` | 同上 |
| `CommentList` | `src/components/comments/` | 同上 |

### 4.2 新增页面

```
src/app/webpages/
  page.tsx              # 网页列表页
  [url_hash]/
    page.tsx            # 网页详情页（复用论文详情页布局）
```

---

## 五、浏览器扩展改造

### 5.1 改造范围

| 文件 | 改动 |
|------|------|
| `extension/popup.js` | 添加"评价此页"按钮 |
| `extension/sidebar.js` | 添加评价面板 |
| `extension/content.js` | 注入评分快捷入口（可选） |

### 5.2 核心流程

```
用户访问任意网页
      ↓
点击扩展图标 → popup 显示
      ↓
"评价此页" → 打开 sidebar
      ↓
sidebar 调用 API 检查网页是否存在
      ↓
  存在: 显示现有评分+允许用户评分
不存在: 自动提取元数据 → 创建网页记录 → 显示评分表单
```

---

## 六、开发顺序（建议）

### Phase 1：数据库 + 基础 API ✅ 已完成
1. ✅ 创建 migration：`webpages`, `webpage_ratings`, `webpage_comments`
2. ✅ 实现 API：`/api/webpages/*`
3. ✅ RLS 策略

### Phase 2：网站页面 ✅ 已完成
4. ✅ 复用 `RatingForm`/`RatingDisplay` 组件
5. ✅ 创建 `/webpages/[url_hash]` 详情页
6. ✅ 创建 `/webpages` 列表页

### Phase 3：浏览器扩展 ✅ 已完成
7. ✅ 扩展 popup 添加"⭐评价"Tab入口
8. ✅ 星星评分组件（4维度）
9. ✅ 提交评价到 API

### Phase 4：知识网迁移
10. ⬜ `webpages` → `knowledge_units` 数据迁移脚本
11. ⬜ 评分/评论 → 知识网笔记系统

---

## 七、关键实现要点

### 7.1 URL 规范化

```typescript
function normalizeUrl(url: string): string {
  const parsed = new URL(url);
  // 移除追踪参数
  ['utm_source', 'utm_medium', 'utm_campaign', 'ref', 'fbclid'].forEach(p => {
    parsed.searchParams.delete(p);
  });
  // 移除锚点
  parsed.hash = '';
  // 统一小写
  return parsed.toString().toLowerCase();
}

function hashUrl(url: string): string {
  return crypto.createHash('sha256').update(normalizeUrl(url)).digest('hex').slice(0, 16);
}
```

### 7.2 评分维度（简化版）

| 论文评分 | 网页评分 |
|----------|----------|
| innovation_score | quality_score（内容质量） |
| methodology_score | usefulness_score（实用性） |
| practicality_score | accuracy_score（准确性） |
| overall_score | overall_score |

---

## 八、风险与注意事项

1. **URL 唯一性**：同一内容可能有多个 URL（www/非www、http/https）→ 规范化解决
2. **动态页面**：SPA 内容变化 → 考虑 content hash（后续优化）
3. **隐私**：用户浏览历史敏感 → 确保 RLS 策略正确
4. **spam**：低质量评价 → 考虑举报/审核机制

---

## 九、参考文件

| 类型 | 文件路径 |
|------|----------|
| 论文评分组件 | `src/components/rating/RatingForm.tsx` |
| 论文评论组件 | `src/components/comments/CommentForm.tsx` |
| 论文详情页 | `src/app/papers/[id]/page.tsx` |
| Zotero 评价视图 | `zotero-plugin/src/modules/ui/paperEvaluationView.ts` |
| 浏览器扩展 | `extension/popup.js`, `extension/sidebar.js` |
| 知识网设计 | `docs/dev/Knowledge-Web/10.2-*.md` |

---

**文档版本**: v1.0  
**创建日期**: 2026-01-06  
**状态**: 待开发
