<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”å­¦æ¸¯æ‰©å±•æµ‹è¯• - localhostç‰ˆæœ¬</title>
    <meta name="citation_doi" content="10.1038/s41586-023-06548-1">
    <meta name="citation_title" content="Test Paper for Extension Development">
    <meta name="citation_author" content="Research Team">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #155DFC, #1e40af);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 30px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .extension-status {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #155DFC;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #155DFC;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #1e40af;
            transform: translateY(-2px);
        }
        
        .status-good { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        
        #diagnostic-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        .floating-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #155DFC, #1e40af);
            color: white;
            border: none;
            width: 100px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(21, 93, 252, 0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(21, 93, 252, 0.6);
        }
    </style>
</head>
<body>
    <button class="floating-button" id="test-extension-button">
        ğŸ”¬ ç ”å­¦æ¸¯
    </button>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç ”å­¦æ¸¯æ‰©å±•åŠŸèƒ½æµ‹è¯•</h1>
            <p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•æ‰©å±•åŠŸèƒ½çš„localhosté¡µé¢</p>
        </div>
        
        <div class="extension-status">
            <h3 id="extension-status-title">ğŸ”„ æ­£åœ¨æ£€æµ‹æ‰©å±•çŠ¶æ€...</h3>
            <div id="extension-status-content"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•åŠŸèƒ½</h3>
            <p>ä½¿ç”¨ä»¥ä¸‹æŒ‰é’®æµ‹è¯•å„é¡¹åŠŸèƒ½ï¼š</p>
            <button class="btn" onclick="testExtensionButton()">æµ‹è¯•æµ®åŠ¨æŒ‰é’®</button>
            <button class="btn" onclick="testSidePanel()">æµ‹è¯•ä¾§è¾¹æ æ‰“å¼€</button>
            <button class="btn" onclick="testPopup()">æµ‹è¯•å¼¹å‡ºçª—å£</button>
            <button class="btn" onclick="testNewTab()">æµ‹è¯•æ–°æ ‡ç­¾é¡µ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š DOIä¿¡æ¯æ£€æµ‹</h3>
            <p><strong>å½“å‰é¡µé¢DOIï¼š</strong> <span id="current-doi">æ£€æµ‹ä¸­...</span></p>
            <p><strong>è®ºæ–‡æ ‡é¢˜ï¼š</strong> <span id="paper-title">æ£€æµ‹ä¸­...</span></p>
            <button class="btn" onclick="detectDOI()">é‡æ–°æ£€æµ‹DOI</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” å®Œæ•´è¯Šæ–­</h3>
            <p>è¿è¡Œå®Œæ•´çš„æ‰©å±•è¯Šæ–­æ£€æŸ¥ï¼š</p>
            <button class="btn" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="btn" onclick="clearOutput()">æ¸…é™¤è¾“å‡º</button>
            <div id="diagnostic-output"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li><strong>æ‰©å±•åŠ è½½ï¼š</strong> ç¡®ä¿æ‰©å±•å·²åœ¨ edge://extensions/ ä¸­åŠ è½½</li>
                <li><strong>æƒé™æ£€æŸ¥ï¼š</strong> ç¡®è®¤æ‰©å±•æœ‰æ‰€éœ€æƒé™</li>
                <li><strong>APIæ”¯æŒï¼š</strong> Edgeç‰ˆæœ¬éœ€ >= 114 æ‰æ”¯æŒsidePanel</li>
                <li><strong>ç½‘ç»œè¿æ¥ï¼š</strong> éœ€è¦è¿æ¥åˆ°æœ¬åœ°å¼€å‘æœåŠ¡å™¨</li>
            </ul>
        </div>
    </div>

    <script>
        let diagnosticOutput = ''
        
        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹æ‰©å±•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            await checkExtensionStatus()
            detectDOI()
            console.log('ğŸ§ª æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡æµ‹è¯•æ‰©å±•åŠŸèƒ½')
        })
        
        // æ£€æµ‹æ‰©å±•çŠ¶æ€
        async function checkExtensionStatus() {
            const statusTitle = document.getElementById('extension-status-title')
            const statusContent = document.getElementById('extension-status-content')
            
            let status = '<div>'
            let hasExtension = false
            
            // æ£€æµ‹Chromeæ‰©å±•API
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                status += '<p class="status-good">âœ… Chromeæ‰©å±•APIå¯ç”¨</p>'
                hasExtension = true
                
                try {
                    const manifest = chrome.runtime.getManifest()
                    status += `<p class="status-good">âœ… æ‰©å±•å·²åŠ è½½: ${manifest.name} v${manifest.version}</p>`
                    
                    // æ£€æµ‹sidePanel API
                    if (chrome.sidePanel) {
                        status += '<p class="status-good">âœ… sidePanel APIå¯ç”¨</p>'
                    } else {
                        status += '<p class="status-error">âŒ sidePanel APIä¸å¯ç”¨</p>'
                    }
                    
                    // æ£€æµ‹å…¶ä»–API
                    if (chrome.tabs) status += '<p class="status-good">âœ… tabs APIå¯ç”¨</p>'
                    else status += '<p class="status-error">âŒ tabs APIä¸å¯ç”¨</p>'
                    
                    if (chrome.scripting) status += '<p class="status-good">âœ… scripting APIå¯ç”¨</p>'
                    else status += '<p class="status-error">âŒ scripting APIä¸å¯ç”¨</p>'
                    
                } catch (e) {
                    status += `<p class="status-error">âŒ æ‰©å±•APIè°ƒç”¨å¤±è´¥: ${e.message}</p>`
                }
            } else {
                status += '<p class="status-error">âŒ Chromeæ‰©å±•APIä¸å¯ç”¨</p>'
            }
            
            // æ£€æµ‹æµ®åŠ¨æŒ‰é’®
            const floatingButton = document.getElementById('test-extension-button')
            if (floatingButton) {
                status += '<p class="status-good">âœ… æµ‹è¯•æµ®åŠ¨æŒ‰é’®å·²åˆ›å»º</p>'
            }
            
            status += '</div>'
            
            statusTitle.textContent = hasExtension ? 'âœ… æ‰©å±•æ£€æµ‹ç»“æœ' : 'âŒ æ‰©å±•æœªæ£€æµ‹åˆ°'
            statusTitle.className = hasExtension ? 'status-good' : 'status-error'
            statusContent.innerHTML = status
        }
        
        // æ£€æµ‹DOI
        function detectDOI() {
            const doiMeta = document.querySelector('meta[name="citation_doi"]')
            const titleMeta = document.querySelector('meta[name="citation_title"]')
            
            const doiElement = document.getElementById('current-doi')
            const titleElement = document.getElementById('paper-title')
            
            if (doiMeta) {
                doiElement.textContent = doiMeta.content
                doiElement.className = 'status-good'
            } else {
                doiElement.textContent = 'æœªæ£€æµ‹åˆ°DOI'
                doiElement.className = 'status-error'
            }
            
            if (titleMeta) {
                titleElement.textContent = titleMeta.content
                titleElement.className = 'status-good'
            } else {
                titleElement.textContent = 'æœªæ£€æµ‹åˆ°æ ‡é¢˜'
                titleElement.className = 'status-error'
            }
        }
        
        // æµ‹è¯•æ‰©å±•æŒ‰é’®
        function testExtensionButton() {
            const button = document.getElementById('test-extension-button')
            if (button) {
                button.style.animation = 'pulse 0.5s'
                setTimeout(() => button.style.animation = '', 500)
                logOutput('âœ… æµ®åŠ¨æŒ‰é’®å­˜åœ¨å¹¶å¯äº¤äº’')
                
                // æ¨¡æ‹Ÿç‚¹å‡»
                button.click()
            } else {
                logOutput('âŒ æµ®åŠ¨æŒ‰é’®ä¸å­˜åœ¨')
            }
        }
        
        // æµ‹è¯•ä¾§è¾¹æ 
        async function testSidePanel() {
            if (typeof chrome !== 'undefined' && chrome.sidePanel) {
                try {
                    await chrome.sidePanel.open({ windowId: (await chrome.windows.getCurrent()).id })
                    logOutput('âœ… ä¾§è¾¹æ æ‰“å¼€æˆåŠŸ')
                } catch (e) {
                    logOutput(`âŒ ä¾§è¾¹æ æ‰“å¼€å¤±è´¥: ${e.message}`)
                }
            } else {
                logOutput('âŒ sidePanel APIä¸å¯ç”¨ï¼Œå°è¯•å…¶ä»–æ–¹æ³•')
                testPopup()
            }
        }
        
        // æµ‹è¯•å¼¹å‡ºçª—å£
        function testPopup() {
            const popup = window.open('http://localhost:3000', 'researchopia-popup', 'width=400,height=600,scrollbars=yes,resizable=yes')
            if (popup) {
                logOutput('âœ… å¼¹å‡ºçª—å£æ‰“å¼€æˆåŠŸ')
            } else {
                logOutput('âŒ å¼¹å‡ºçª—å£è¢«é˜»æ­¢')
            }
        }
        
        // æµ‹è¯•æ–°æ ‡ç­¾é¡µ
        function testNewTab() {
            window.open('http://localhost:3000', '_blank')
            logOutput('âœ… æ–°æ ‡ç­¾é¡µæ‰“å¼€')
        }
        
        // è¿è¡Œå®Œæ•´è¯Šæ–­
        async function runFullDiagnostic() {
            logOutput('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...\n' + '='.repeat(50))
            
            // æµè§ˆå™¨æ£€æµ‹
            logOutput('\n1. æµè§ˆå™¨ç¯å¢ƒæ£€æµ‹')
            logOutput('â”€'.repeat(30))
            
            const userAgent = navigator.userAgent
            if (userAgent.includes('Edg/')) {
                const edgeMatch = userAgent.match(/Edg\/([0-9.]+)/)
                const edgeVersion = edgeMatch ? edgeMatch[1] : 'Unknown'
                logOutput(`âœ… Edgeæµè§ˆå™¨æ£€æµ‹: Edgeç‰ˆæœ¬ ${edgeVersion}`)
                
                const majorVersion = parseInt(edgeVersion.split('.')[0])
                if (majorVersion >= 114) {
                    logOutput('âœ… sidePanel APIç‰ˆæœ¬æ”¯æŒ: Edgeç‰ˆæœ¬æ”¯æŒsidePanel API')
                } else {
                    logOutput('âŒ sidePanel APIç‰ˆæœ¬æ”¯æŒ: Edgeç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ >= 114')
                }
            } else {
                logOutput('âš ï¸ æµè§ˆå™¨æ£€æµ‹: å¯èƒ½ä¸æ˜¯Edgeæµè§ˆå™¨')
            }
            
            // æ‰©å±•æ£€æµ‹
            logOutput('\n2. æ‰©å±•çŠ¶æ€æ£€æµ‹')
            logOutput('â”€'.repeat(30))
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                logOutput('âœ… æ‰©å±•ç¯å¢ƒæ£€æµ‹: Chromeæ‰©å±•APIå¯ç”¨')
                
                try {
                    const manifest = chrome.runtime.getManifest()
                    logOutput(`âœ… æ‰©å±•ä¿¡æ¯: ${manifest.name} v${manifest.version}`)
                    logOutput(`âœ… æ‰©å±•ID: ${chrome.runtime.id}`)
                } catch (e) {
                    logOutput(`âŒ æ‰©å±•ä¿¡æ¯è·å–å¤±è´¥: ${e.message}`)
                }
            } else {
                logOutput('âŒ æ‰©å±•ç¯å¢ƒæ£€æµ‹: Chromeæ‰©å±•APIä¸å¯ç”¨')
            }
            
            // APIæ£€æµ‹
            logOutput('\n3. APIå¯ç”¨æ€§æ£€æµ‹')
            logOutput('â”€'.repeat(30))
            
            const apis = {
                'chrome.sidePanel': chrome?.sidePanel,
                'chrome.tabs': chrome?.tabs,
                'chrome.runtime': chrome?.runtime,
                'chrome.scripting': chrome?.scripting
            }
            
            for (const [apiName, api] of Object.entries(apis)) {
                if (api) {
                    logOutput(`âœ… ${apiName} API: å¯ç”¨`)
                } else {
                    logOutput(`âŒ ${apiName} API: ä¸å¯ç”¨`)
                }
            }
            
            // é€šä¿¡æµ‹è¯•
            logOutput('\n4. æ¶ˆæ¯ä¼ é€’æµ‹è¯•')
            logOutput('â”€'.repeat(30))
            
            if (chrome?.runtime?.sendMessage) {
                try {
                    chrome.runtime.sendMessage({ action: 'ping' }, (response) => {
                        if (chrome.runtime.lastError) {
                            logOutput(`âŒ Backgroundé€šä¿¡æµ‹è¯•: ${chrome.runtime.lastError.message}`)
                        } else {
                            logOutput(`âœ… Backgroundé€šä¿¡æµ‹è¯•: ${response ? 'é€šä¿¡æˆåŠŸ' : 'æ— å“åº”'}`)
                        }
                    })
                } catch (e) {
                    logOutput(`âŒ Backgroundé€šä¿¡æµ‹è¯•: ${e.message}`)
                }
            } else {
                logOutput('âŒ Backgroundé€šä¿¡æµ‹è¯•: sendMessage APIä¸å¯ç”¨')
            }
            
            // DOMæ£€æµ‹
            logOutput('\n5. DOMçŠ¶æ€æ£€æŸ¥')
            logOutput('â”€'.repeat(30))
            
            const floatingButton = document.getElementById('test-extension-button')
            if (floatingButton) {
                logOutput('âœ… æµ®åŠ¨æŒ‰é’®å­˜åœ¨æ€§: æµ‹è¯•æŒ‰é’®å·²åˆ›å»º')
            } else {
                logOutput('âŒ æµ®åŠ¨æŒ‰é’®å­˜åœ¨æ€§: æŒ‰é’®ä¸å­˜åœ¨')
            }
            
            const doiMeta = document.querySelector('meta[name="citation_doi"]')
            if (doiMeta) {
                logOutput(`âœ… DOIå…ƒæ•°æ®æ£€æµ‹: ${doiMeta.content}`)
            } else {
                logOutput('âŒ DOIå…ƒæ•°æ®æ£€æµ‹: æœªå‘ç°DOI')
            }
            
            // ç½‘ç»œæ£€æµ‹
            logOutput('\n6. ç½‘ç»œè¿æ¥æ£€æŸ¥')
            logOutput('â”€'.repeat(30))
            
            try {
                const response = await fetch('http://localhost:3000')
                if (response.ok) {
                    logOutput('âœ… æœ¬åœ°æœåŠ¡å™¨ç«¯å£3000: è¿æ¥æˆåŠŸ')
                } else {
                    logOutput(`âš ï¸ æœ¬åœ°æœåŠ¡å™¨ç«¯å£3000: HTTP ${response.status}`)
                }
            } catch (e) {
                logOutput(`âŒ æœ¬åœ°æœåŠ¡å™¨ç«¯å£3000: è¿æ¥å¤±è´¥ - ${e.message}`)
            }
            
            logOutput('\n' + '='.repeat(50))
            logOutput('ğŸ” å®Œæ•´è¯Šæ–­ç»“æŸ')
        }
        
        // è¾“å‡ºæ—¥å¿—
        function logOutput(message) {
            diagnosticOutput += message + '\n'
            document.getElementById('diagnostic-output').textContent = diagnosticOutput
            document.getElementById('diagnostic-output').scrollTop = document.getElementById('diagnostic-output').scrollHeight
        }
        
        // æ¸…é™¤è¾“å‡º
        function clearOutput() {
            diagnosticOutput = ''
            document.getElementById('diagnostic-output').textContent = ''
        }
        
        // æµ®åŠ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('test-extension-button').addEventListener('click', async () => {
            logOutput('ğŸ”¬ ç ”å­¦æ¸¯æ‰©å±•æŒ‰é’®è¢«ç‚¹å‡»')
            
            // å°è¯•å¤šç§æ‰“å¼€æ–¹å¼
            if (typeof chrome !== 'undefined' && chrome.sidePanel) {
                try {
                    await chrome.sidePanel.open({ windowId: (await chrome.windows.getCurrent()).id })
                    logOutput('âœ… ä½¿ç”¨ä¾§è¾¹æ æ‰“å¼€æˆåŠŸ')
                    return
                } catch (e) {
                    logOutput(`âš ï¸ ä¾§è¾¹æ æ‰“å¼€å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼: ${e.message}`)
                }
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šå¼¹å‡ºçª—å£
            const popup = window.open('http://localhost:3000', 'researchopia-popup', 'width=400,height=600,scrollbars=yes,resizable=yes')
            if (popup) {
                logOutput('âœ… ä½¿ç”¨å¼¹å‡ºçª—å£ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ')
            } else {
                logOutput('âš ï¸ å¼¹å‡ºçª—å£è¢«é˜»æ­¢ï¼Œä½¿ç”¨æ–°æ ‡ç­¾é¡µ')
                window.open('http://localhost:3000', '_blank')
            }
        })
        
        // CSSåŠ¨ç”»
        const style = document.createElement('style')
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `
        document.head.appendChild(style)
        
        // å…¨å±€è¯Šæ–­å‡½æ•°ï¼ˆå…¼å®¹ä¹‹å‰çš„è°ƒç”¨ï¼‰
        window.runEdgeDiagnostic = runFullDiagnostic
        
        console.log('ğŸ§ª localhostæµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ')
        console.log('ğŸ“‹ å¯ç”¨åŠŸèƒ½ï¼š')
        console.log('   - testExtensionButton(): æµ‹è¯•æ‰©å±•æŒ‰é’®')
        console.log('   - testSidePanel(): æµ‹è¯•ä¾§è¾¹æ ')
        console.log('   - runFullDiagnostic(): è¿è¡Œå®Œæ•´è¯Šæ–­')
        console.log('   - runEdgeDiagnostic(): åˆ«åè¯Šæ–­å‡½æ•°')
    </script>
</body>
</html>