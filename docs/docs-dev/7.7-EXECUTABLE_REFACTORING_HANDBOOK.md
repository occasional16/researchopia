# æ¨¡å—åŒ–é‡æ„æ‰§è¡Œæ‰‹å†Œ (7.7)

**æ—¥æœŸ**: 2025-11-18 | **ç‰ˆæœ¬**: v1.0 | **é€‚ç”¨å¯¹è±¡**: AI + äººç±»åä½œ

---

## ğŸ“‹ æ‰‹å†Œè¯´æ˜

### ç›®çš„
æœ¬æ‰‹å†Œæ˜¯**å¯æ‰§è¡Œçš„**æ“ä½œæŒ‡å—ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰æ˜ç¡®çš„ï¼š
- âœ… æ‰§è¡Œæ­¥éª¤ï¼ˆå¤åˆ¶ç²˜è´´å³å¯è¿è¡Œï¼‰
- âœ… éªŒæ”¶æ ‡å‡†ï¼ˆæµ‹è¯•é€šè¿‡/å¤±è´¥ï¼‰
- âœ… å›æ»šæ–¹æ¡ˆï¼ˆGitå‘½ä»¤ï¼‰
- âœ… è¿›åº¦è¿½è¸ªï¼ˆCheckboxå‹¾é€‰ï¼‰

### ä½¿ç”¨æ–¹å¼
```markdown
1. äººç±»é˜…è¯»"é˜¶æ®µç›®æ ‡"
2. AIæ‰§è¡Œ"ä»»åŠ¡æ¸…å•"ä¸­çš„æ¯ä¸ªä»»åŠ¡
3. æ¯å®Œæˆ1ä¸ªä»»åŠ¡ â†’ åœ¨ [ ] ä¸­æ ‡è®° [x]
4. æ¯ä¸ªé˜¶æ®µå®Œæˆ â†’ Git tagè®°å½•é‡Œç¨‹ç¢‘
5. å‡ºç°é—®é¢˜ â†’ æŸ¥çœ‹"æ•…éšœæ’é™¤"ç« èŠ‚
```

### é¡¹ç›®ç»“æ„ï¼ˆ3ä¸ªå­é¡¹ç›®ï¼‰
```
Researchopia/
â”œâ”€â”€ ç½‘ç«™ (Next.js)           - src/app, src/components, src/lib
â”‚   â”œâ”€â”€ ä¼˜å…ˆçº§: P2 (ä¸­ç­‰)
â”‚   â”œâ”€â”€ ä»£ç é‡: ~1.8MB
â”‚   â””â”€â”€ æ ¸å¿ƒ: APIå±‚ + è®¤è¯ + UI
â”‚
â”œâ”€â”€ Zoteroæ’ä»¶ (TypeScript)  - zotero-plugin/src
â”‚   â”œâ”€â”€ ä¼˜å…ˆçº§: P1 (æœ€é«˜) â† ç”¨æˆ·æ ¸å¿ƒäº¤äº’
â”‚   â”œâ”€â”€ ä»£ç é‡: ~1.2MB
â”‚   â”œâ”€â”€ è¶…å¤§æ–‡ä»¶: pdfReaderManager.ts (2763è¡Œ) ğŸš¨
â”‚   â””â”€â”€ æ ¸å¿ƒ: PDFæ ‡æ³¨ + ä¼šè¯ç®¡ç† + åŒæ­¥
â”‚
â””â”€â”€ æµè§ˆå™¨æ‰©å±• (JavaScript)  - extension/
    â”œâ”€â”€ ä¼˜å…ˆçº§: P3 (ä½)
    â”œâ”€â”€ ä»£ç é‡: ~0.3MB
    â”œâ”€â”€ æ ¸å¿ƒæ–‡ä»¶: content.js (711è¡Œ)
    â””â”€â”€ æ ¸å¿ƒ: DOIè¯†åˆ« + å¿«é€Ÿè®¿é—®
```

---

## ğŸ¯ é‡æ„æˆ˜ç•¥

### ä¸¤é˜¶æ®µç­–ç•¥

#### é˜¶æ®µ0: å…¨å±€åŸºç¡€é‡æ„ï¼ˆ3-5å¤©ï¼‰âš ï¸ **å¿…é¡»ä¼˜å…ˆ**
**ç›®æ ‡**: å»ºç«‹ä¸‰ç«¯å…±äº«çš„åŸºç¡€è®¾æ–½ï¼Œé¿å…åç»­é‡å¤åŠ³åŠ¨

```
å…¨å±€åŸºç¡€ = ä¸‰ç«¯éƒ½éœ€è¦çš„åº•å±‚èƒ½åŠ›
â”œâ”€â”€ 1. å…±äº«åº“ (@researchopia/shared)     â† DOI/API/Authå·¥å…·
â”œâ”€â”€ 2. ç±»å‹ç³»ç»Ÿ (TypeScript Definitions)  â† Paper/Annotation/User
â”œâ”€â”€ 3. é”™è¯¯å¤„ç† (ErrorHandler)            â† ç»Ÿä¸€é”™è¯¯ç 
â”œâ”€â”€ 4. æ—¥å¿—ç³»ç»Ÿ (Logger)                  â† ç»Ÿä¸€æ—¥å¿—æ ¼å¼
â””â”€â”€ 5. æµ‹è¯•æ¡†æ¶ (Vitest)                  â† è‡ªåŠ¨åŒ–æµ‹è¯•
```

**ä¸ºä»€ä¹ˆå…ˆåšåŸºç¡€**:
```
âŒ é”™è¯¯é¡ºåº: å…ˆé‡æ„Zotero â†’ å†é‡æ„ç½‘ç«™ â†’ å†é‡æ„æ‰©å±•
   é—®é¢˜: DOIå·¥å…·é‡å¤å®ç°3æ¬¡ï¼ŒåæœŸéš¾ä»¥ç»Ÿä¸€

âœ… æ­£ç¡®é¡ºåº: å…ˆæå–å…±äº«åº“ â†’ ä¸‰ç«¯åŒæ—¶é›†æˆ â†’ é€ä¸ªé‡æ„
   æ•ˆæœ: ä¸€æ¬¡å®ç°ï¼Œä¸‰ç«¯å¤ç”¨ï¼ŒåæœŸä¿®æ”¹åªéœ€1å¤„
```

#### é˜¶æ®µ1-3: åŠŸèƒ½æ¨¡å—é‡æ„ï¼ˆ10-15å¤©ï¼‰
**ç›®æ ‡**: æŒ‰ä¸šåŠ¡åŠŸèƒ½é€ä¸ªé‡æ„ï¼Œæ¯æ¬¡å½±å“èŒƒå›´å¯æ§

```
æŒ‰ä¼˜å…ˆçº§æ’åº:
P1 (5-7å¤©)  - Zoteroæ’ä»¶: PDFç®¡ç† + æ ‡æ³¨åŒæ­¥ + ä¼šè¯ç®¡ç†
P2 (3-5å¤©)  - ç½‘ç«™: APIå±‚ + è®¤è¯ + Profile
P3 (2-3å¤©)  - æµè§ˆå™¨æ‰©å±•: DOIè¯†åˆ«ä¼˜åŒ– + UIæ”¹è¿›
```

---

## ğŸ“Š è¿›åº¦è¿½è¸ª

### å…¨å±€è¿›åº¦çœ‹æ¿
```markdown
## é˜¶æ®µ0: å…¨å±€åŸºç¡€é‡æ„ [########--] 80% (4/5å®Œæˆ) âš ï¸
- [x] ä»»åŠ¡0.1: å…±äº«åº“åˆ›å»º (âœ… 2025-11-17)
- [x] ä»»åŠ¡0.2: å…±äº«åº“é›†æˆ - éƒ¨åˆ†å®Œæˆ (âš ï¸ 2025-11-18)
  - âœ… Zoteroæ’ä»¶: normalizeDOI() å·²é›†æˆï¼Œ6 tests passing
  - âœ… æµè§ˆå™¨æ‰©å±•: doi-utils.js å·²åˆ›å»ºï¼ˆçº¯JSç‰ˆæœ¬ï¼‰
  - âœ… ç½‘ç«™: error-handler + types å·²é›†æˆ
  - âš ï¸ **é—ç•™**: æµè§ˆå™¨æ‰©å±•æœªä½¿ç”¨å·¥ä½œç©ºé—´åŒ…ï¼ˆå› MV3é™åˆ¶ï¼‰
- [x] ä»»åŠ¡0.3: ç±»å‹ç³»ç»Ÿç»Ÿä¸€ (âœ… 2025-11-18)
  - 176è¡Œç±»å‹å®šä¹‰ï¼šPaper, Annotation, User, Sessionç­‰
  - ç½‘ç«™å·²é›†æˆï¼šsrc/lib/supabase.ts
- [x] ä»»åŠ¡0.4: é”™è¯¯å¤„ç†ç»Ÿä¸€ (âœ… 2025-11-18)
  - 261è¡Œé”™è¯¯ç³»ç»Ÿï¼š40+é”™è¯¯ç ã€ResearchopiaErrorç±»
  - ç½‘ç«™å·²é›†æˆï¼šsrc/lib/error-handler.ts
- [ ] ä»»åŠ¡0.5: æµ‹è¯•åŸºç¡€è®¾æ–½ - ä¸å®Œæ•´ (âŒ 2025-11-18)
  - âœ… Zoteroæ’ä»¶: vitesté…ç½®å®Œæˆï¼Œ6 tests passing
  - âœ… ç½‘ç«™: vitesté…ç½®å­˜åœ¨ï¼Œä½†æœ‰è­¦å‘Šï¼ˆ10 tests passingï¼‰
  - âŒ å…±äº«åº“: æ— æµ‹è¯•æ–‡ä»¶ï¼ˆ"No test files found"ï¼‰
  - âŒ æµè§ˆå™¨æ‰©å±•: æ— æµ‹è¯•æ¡†æ¶

## é˜¶æ®µ1: Zoteroæ’ä»¶é‡æ„ [######----] 60%
- [x] ä»»åŠ¡1.1: pdfReaderManageræ‹†åˆ† (âœ… 2025-11-18 - å·²å®Œæˆå¹¶æµ‹è¯•)
  - 2771è¡Œ â†’ 1572è¡Œ (å‡å°‘43%)
  - 4ä¸ªæ¨¡å—: HighlightRenderer(449è¡Œ) + ReaderEventSystem(348è¡Œ) + ResponsiveLayoutHandler(253è¡Œ) + PDFReaderCoordinator(757è¡Œ)
  - âœ… TypeScriptç¼–è¯‘é€šè¿‡
  - âœ… æ’ä»¶æ„å»ºæˆåŠŸ
  - âœ… åŠŸèƒ½æµ‹è¯•é€šè¿‡: æ ‡æ³¨é«˜äº®æ¸²æŸ“ã€ç‚¹å‡»å¼¹çª—ï¼ˆå«ç‚¹èµ/è¯„è®ºï¼‰ã€å“åº”å¼å¸ƒå±€
- [ ] ä»»åŠ¡1.2: sessionAnnotationsViewé‡æ„ (TODOæ¸…ç†)
- [ ] ä»»åŠ¡1.3: æ ‡æ³¨åŒæ­¥ä¼˜åŒ–
- [ ] ä»»åŠ¡1.4: UIäº‹ä»¶ç³»ç»Ÿè§£è€¦

## é˜¶æ®µ2: ç½‘ç«™é‡æ„ [----------] 0%
- [ ] ä»»åŠ¡2.1: database.tsæ‹†åˆ† (607è¡Œ â†’ 4ä¸ªä»“å‚¨)
- [ ] ä»»åŠ¡2.2: APIå±‚æ¸…ç† (åˆ é™¤Mock/testç«¯ç‚¹)
- [ ] ä»»åŠ¡2.3: è®¤è¯æ¨¡å—ä¼˜åŒ–
- [ ] ä»»åŠ¡2.4: Profileé¡µé¢ç»„ä»¶åŒ–

## é˜¶æ®µ3: æµè§ˆå™¨æ‰©å±•é‡æ„ [----------] 0%
- [ ] ä»»åŠ¡3.1: content.jsæ¨¡å—åŒ– (711è¡Œ â†’ 3ä¸ªæ¨¡å—)
- [ ] ä»»åŠ¡3.2: æ¶ˆæ¯åè®®æ ‡å‡†åŒ–
- [ ] ä»»åŠ¡3.3: UIçŠ¶æ€ç®¡ç†
```

**æ›´æ–°è§„åˆ™**: æ¯å®Œæˆ1ä¸ªä»»åŠ¡ â†’ å°† `[ ]` æ”¹ä¸º `[x]` + æ·»åŠ å®Œæˆæ—¥æœŸ

---

## ğŸ”§ é˜¶æ®µ0: å…¨å±€åŸºç¡€é‡æ„

### ä»»åŠ¡0.1: å…±äº«åº“åˆ›å»º âœ… å·²å®Œæˆ

**çŠ¶æ€**: âœ… å®Œæˆ (2025-11-17)  
**äº§å‡º**: `packages/shared/` å·¥ä½œç©ºé—´  
**æµ‹è¯•**: 73 tests passing

---

### ä»»åŠ¡0.2: å…±äº«åº“ä¸‰ç«¯é›†æˆ âœ… å·²å®Œæˆ

**çŠ¶æ€**: âœ… å®Œæˆ (2025-11-18)  
**é›†æˆæƒ…å†µ**:
- âœ… Zoteroæ’ä»¶: `normalizeDOI()` å·²é›†æˆ
- âœ… æµè§ˆå™¨æ‰©å±•: `doi-utils.js` å·²åˆ›å»º
- âœ… ç½‘ç«™: å·²ä½¿ç”¨å…±äº«åº“

---

### ä»»åŠ¡0.3: ç±»å‹ç³»ç»Ÿç»Ÿä¸€ âœ… å·²å®Œæˆ

**çŠ¶æ€**: âœ… å®Œæˆ (2025-11-18)  
**Commit**: 2a392de7  
**æµ‹è¯•**: 52 tests passing

**å®Œæˆå†…å®¹**:
- åˆ›å»º `packages/shared/src/types/index.ts` (200+è¡Œ)
- å®šä¹‰æ ¸å¿ƒç±»å‹: Paper, Annotation, User, ReadingSessionç­‰
- ç½‘ç«™é›†æˆ: `src/lib/supabase.ts` ä½¿ç”¨å…±äº«ç±»å‹
- æ„å»ºæˆåŠŸ: `dist/types/` æ­£ç¡®ç”Ÿæˆ

**ç›®æ ‡**: ä¸‰ç«¯ä½¿ç”¨ç»Ÿä¸€çš„TypeScriptç±»å‹å®šä¹‰

---

### ä»»åŠ¡0.4: é”™è¯¯å¤„ç†ç»Ÿä¸€ âœ… å·²å®Œæˆ

**çŠ¶æ€**: âœ… å®Œæˆ (2025-11-18)  
**Commit**: e9563e59  
**æµ‹è¯•**: 52 tests passing

**å®Œæˆå†…å®¹**:
- åˆ›å»º `packages/shared/src/errors/index.ts` (280+è¡Œ)
- å®šä¹‰ErrorCodeæšä¸¾ (40+é”™è¯¯ç åˆ†ç±»)
- å®ç°ResearchopiaErrorç±»å’ŒErrorHandlerå·¥å…·
- ç½‘ç«™é›†æˆ: `src/lib/error-handler.ts` åŒ…è£…å™¨
- æ„å»ºæˆåŠŸ: `dist/errors/` æ­£ç¡®ç”Ÿæˆ

**ç›®æ ‡**: ä¸‰ç«¯ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç±»å’Œé”™è¯¯ç 

---

### ä»»åŠ¡0.5: æµ‹è¯•åŸºç¡€è®¾æ–½å®Œå–„ âš ï¸ éƒ¨åˆ†å®Œæˆ

**çŠ¶æ€**: âš ï¸ éƒ¨åˆ†å®Œæˆ (2025-11-18)  
**æµ‹è¯•**: 16 tests passing (ç½‘ç«™10 + Zoteroæ’ä»¶6)

**å®Œæˆå†…å®¹**:
- âœ… Zoteroæ’ä»¶: é…ç½®Vitest + jsdom + Mock Zotero API (6 tests passing)
- âœ… ç½‘ç«™: é…ç½®Vitest + jsdom (10 tests passingï¼Œæœ‰æ§åˆ¶å°è­¦å‘Š)
- âŒ å…±äº«åº“: æ— æµ‹è¯•æ–‡ä»¶ï¼ˆ"No test files found"é”™è¯¯ï¼‰
- âŒ æµè§ˆå™¨æ‰©å±•: æ— æµ‹è¯•æ¡†æ¶

**é—ç•™é—®é¢˜**:
1. å…±äº«åº“ç¼ºå°‘æµ‹è¯•æ–‡ä»¶ï¼ˆåº”è¯¥æµ‹è¯• utils/doi.tsã€errors/index.tsï¼‰
2. ç½‘ç«™æµ‹è¯•æœ‰ç¼–ç è­¦å‘Šï¼ˆTokenManager.test.tsä¸­çš„ä¸­æ–‡æ³¨é‡Šï¼‰
3. æµè§ˆå™¨æ‰©å±•å®Œå…¨æ²¡æœ‰æµ‹è¯•è¦†ç›–

**ç›®æ ‡**: ä¸‰ç«¯éƒ½æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•èƒ½åŠ›ï¼ˆç›®å‰ä»…2/3å®Œæˆï¼‰

---

## ğŸ¯ é˜¶æ®µ1: Zoteroæ’ä»¶é‡æ„

### ä¼˜å…ˆçº§è¯´æ˜
**ä¸ºä»€ä¹ˆå…ˆé‡æ„Zoteroæ’ä»¶ï¼Ÿ**
1. ğŸ”´ **ç”¨æˆ·æ ¸å¿ƒäº¤äº’** - æ ‡æ³¨ã€é˜…è¯»ä¼šè¯æ˜¯æ ¸å¿ƒåŠŸèƒ½
2. ğŸ”´ **ä»£ç è´¨é‡æœ€å·®** - pdfReaderManager.ts (2763è¡Œ) ğŸš¨
3. ğŸ”´ **TODOå †ç§¯** - 7ä¸ªæœªå®ç°åŠŸèƒ½
4. ğŸŸ¡ **ä¾èµ–ç½‘ç«™API** - ä¼˜åŒ–åå¯å‡å°‘APIè°ƒç”¨

### ä»»åŠ¡1.1: pdfReaderManager.tsæ‹†åˆ† ğŸš¨ **æœ€å…³é”®**

**æ–‡ä»¶çŠ¶æ€**: 2763è¡Œ ğŸš¨ è¿œè¶…600è¡Œæ ‡å‡†

**å½“å‰é—®é¢˜**:
```typescript
// zotero-plugin/src/modules/pdfReaderManager.ts (2763è¡Œ)
export class PDFReaderManager {
  // âŒ æ··åˆäº†5ä¸ªç‹¬ç«‹èŒè´£
  private activeHighlights = new Map();        // 1. é«˜äº®ç®¡ç†
  private overlayData = new Map();             // 2. Overlayæ¸²æŸ“
  private resizeObservers = new Map();         // 3. å“åº”å¼å¸ƒå±€
  private mutationObservers = new Map();       // 4. DOMç›‘å¬
  private readerEventListeners = new Map();    // 5. äº‹ä»¶ç³»ç»Ÿ

  // 400+ è¡Œ: é«˜äº®æ¸²æŸ“é€»è¾‘
  public displaySharedAnnotations() { ... }

  // 300+ è¡Œ: Overlayä½ç½®è®¡ç®—
  private updateOverlayPositions() { ... }

  // 200+ è¡Œ: äº‹ä»¶ç›‘å¬æ³¨å†Œ
  private registerReaderEvents() { ... }

  // ... å…¶ä»–1800+è¡Œä»£ç 
}
```

**é‡æ„æ–¹æ¡ˆ**: æŒ‰èŒè´£æ‹†åˆ†æˆ5ä¸ªæ¨¡å—

#### æ­¥éª¤1: è®¾è®¡æ¨¡å—è¾¹ç•Œ (1å°æ—¶ - äººç±»ä¸»å¯¼)

**æ¨¡å—åˆ’åˆ†**:
```
pdfReaderManager.ts (2763è¡Œ)
  â†“ æ‹†åˆ†
â”œâ”€â”€ PDFReaderCoordinator.ts (300è¡Œ)      â† ä¸»æ§åˆ¶å™¨ï¼Œåè°ƒå…¶ä»–æ¨¡å—
â”œâ”€â”€ HighlightRenderer.ts (500è¡Œ)         â† é«˜äº®æ¸²æŸ“ï¼ˆSVG/Canvasï¼‰
â”œâ”€â”€ OverlayManager.ts (600è¡Œ)            â† Overlayä½ç½®è®¡ç®—å’Œæ›´æ–°
â”œâ”€â”€ ReaderEventSystem.ts (400è¡Œ)         â† äº‹ä»¶ç›‘å¬å’Œåˆ†å‘
â””â”€â”€ ResponsiveLayoutHandler.ts (500è¡Œ)   â† ResizeObserver + MutationObserver
```

**æ¥å£è®¾è®¡**:
```typescript
// æ ¸å¿ƒæ¥å£ï¼ˆäººç±»å®šä¹‰ï¼ŒAIå®ç°ï¼‰
interface IHighlightRenderer {
  render(annotations: Annotation[], pageContainer: HTMLElement): void;
  clear(annotationId: string): void;
  clearAll(): void;
}

interface IOverlayManager {
  createOverlay(annotation: Annotation, pageContainer: HTMLElement): HTMLElement[];
  updatePositions(pageContainer: HTMLElement): void;
  removeOverlay(annotationId: string): void;
}

interface IReaderEventSystem {
  registerReader(reader: any): void;
  unregisterReader(reader: any): void;
  onAnnotationClick(callback: (annotation: Annotation) => void): void;
}

interface IResponsiveLayoutHandler {
  observeContainer(container: HTMLElement): void;
  unobserveContainer(container: HTMLElement): void;
}
```

#### æ­¥éª¤2: æå–HighlightRenderer (3å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/pdf/HighlightRenderer.ts (æ–°å»º)
import type { Annotation, AnnotationPosition } from '@researchopia/shared/types';
import { logger } from '../../utils/logger';

/**
 * é«˜äº®æ¸²æŸ“å™¨ - è´Ÿè´£åœ¨PDFé¡µé¢ä¸Šæ¸²æŸ“æ ‡æ³¨é«˜äº®
 */
export class HighlightRenderer {
  private activeHighlights = new Map<string, {
    elements: (SVGElement | HTMLElement)[];
    reader: any;
  }>();

  /**
   * æ¸²æŸ“æ ‡æ³¨é«˜äº®
   */
  public render(
    annotations: Annotation[],
    pageContainer: HTMLElement,
    reader: any
  ): void {
    for (const annotation of annotations) {
      this.renderSingle(annotation, pageContainer, reader);
    }
  }

  /**
   * æ¸²æŸ“å•ä¸ªæ ‡æ³¨
   */
  private renderSingle(
    annotation: Annotation,
    pageContainer: HTMLElement,
    reader: any
  ): void {
    // ä»åŸpdfReaderManager.tså¤åˆ¶æ¸²æŸ“é€»è¾‘
    // ... (AIä»åŸæ–‡ä»¶å¤åˆ¶ displaySharedAnnotations çš„æ ¸å¿ƒä»£ç )
  }

  /**
   * æ¸…é™¤æ ‡æ³¨é«˜äº®
   */
  public clear(annotationId: string): void {
    const highlight = this.activeHighlights.get(annotationId);
    if (highlight) {
      highlight.elements.forEach(el => el.remove());
      this.activeHighlights.delete(annotationId);
    }
  }

  /**
   * æ¸…é™¤æ‰€æœ‰é«˜äº®
   */
  public clearAll(): void {
    this.activeHighlights.forEach((_, id) => this.clear(id));
  }

  /**
   * è·å–å½“å‰æ´»åŠ¨é«˜äº®æ•°é‡
   */
  public getActiveCount(): number {
    return this.activeHighlights.size;
  }
}
```

**AIæ‰§è¡Œæç¤ºè¯**:
```
ä»»åŠ¡: ä» pdfReaderManager.ts æå– HighlightRenderer æ¨¡å—

æ­¥éª¤:
1. åˆ›å»º zotero-plugin/src/modules/pdf/HighlightRenderer.ts
2. å¤åˆ¶ displaySharedAnnotations() çš„æ ¸å¿ƒé€»è¾‘åˆ° renderSingle()
3. ä¿æŒé«˜äº®æ¸²æŸ“é€»è¾‘ä¸å˜ï¼ˆSVGåˆ›å»ºã€é¢œè‰²ã€ä½ç½®ï¼‰
4. ç§»é™¤å¯¹å…¶ä»–æ¨¡å—çš„ä¾èµ–ï¼ˆåªä¾èµ–loggerï¼‰

éªŒè¯:
- TypeScriptç¼–è¯‘é€šè¿‡
- åŸåŠŸèƒ½ä¸å—å½±å“ï¼ˆå…ˆä¸ä¿®æ”¹pdfReaderManager.tsï¼‰

ç¦æ­¢:
- âŒ ä¸è¦é‡å†™æ¸²æŸ“é€»è¾‘ï¼ˆåªå¤åˆ¶ç²˜è´´ï¼‰
- âŒ ä¸è¦ä¿®æ”¹å‡½æ•°ç­¾å
- âŒ ä¸è¦åˆ é™¤åŸpdfReaderManager.tsçš„ä»£ç 
```

#### æ­¥éª¤3: æå–OverlayManager (3å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/pdf/OverlayManager.ts
export class OverlayManager {
  private overlayData = new Map<string, {
    annotation: Annotation;
    pageContainer: HTMLElement;
    overlayElements: HTMLElement[];
    reader: any;
  }>();

  /**
   * åˆ›å»ºOverlayå…ƒç´ 
   */
  public createOverlay(
    annotation: Annotation,
    pageContainer: HTMLElement,
    reader: any
  ): HTMLElement[] {
    // ä»åŸpdfReaderManager.tså¤åˆ¶Overlayåˆ›å»ºé€»è¾‘
    // ...
  }

  /**
   * æ›´æ–°Overlayä½ç½®ï¼ˆå“åº”ç¼©æ”¾/æ»šåŠ¨ï¼‰
   */
  public updatePositions(pageContainer: HTMLElement): void {
    // ä»åŸpdfReaderManager.tså¤åˆ¶ä½ç½®æ›´æ–°é€»è¾‘
    // ...
  }

  // ... å…¶ä»–æ–¹æ³•
}
```

#### æ­¥éª¤4: æå–ReaderEventSystem (2å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/pdf/ReaderEventSystem.ts
export class ReaderEventSystem {
  private readerEventListeners = new Map<any, Function[]>();
  private annotationClickCallbacks: Array<(annotation: Annotation) => void> = [];

  /**
   * æ³¨å†ŒReaderäº‹ä»¶
   */
  public registerReader(reader: any): void {
    // ä»åŸpdfReaderManager.tså¤åˆ¶äº‹ä»¶æ³¨å†Œé€»è¾‘
    // ...
  }

  /**
   * æ³¨å†Œæ ‡æ³¨ç‚¹å‡»å›è°ƒ
   */
  public onAnnotationClick(callback: (annotation: Annotation) => void): void {
    this.annotationClickCallbacks.push(callback);
  }

  // ... å…¶ä»–æ–¹æ³•
}
```

#### æ­¥éª¤5: æå–ResponsiveLayoutHandler (2å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/pdf/ResponsiveLayoutHandler.ts
export class ResponsiveLayoutHandler {
  private resizeObservers = new Map<HTMLElement, ResizeObserver>();
  private mutationObservers = new Map<HTMLElement, MutationObserver>();

  /**
   * ç›‘å¬å®¹å™¨å°ºå¯¸å˜åŒ–
   */
  public observeContainer(
    container: HTMLElement,
    onResize: () => void
  ): void {
    // ä»åŸpdfReaderManager.tså¤åˆ¶ResizeObserveré€»è¾‘
    // ...
  }

  // ... å…¶ä»–æ–¹æ³•
}
```

#### æ­¥éª¤6: é‡æ„PDFReaderCoordinator (2å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/pdf/PDFReaderCoordinator.ts (é‡æ„åçš„ä¸»ç±»)
import { HighlightRenderer } from './HighlightRenderer';
import { OverlayManager } from './OverlayManager';
import { ReaderEventSystem } from './ReaderEventSystem';
import { ResponsiveLayoutHandler } from './ResponsiveLayoutHandler';

/**
 * PDFé˜…è¯»å™¨åè°ƒå™¨ - æ•´åˆå„ä¸ªå­æ¨¡å—
 */
export class PDFReaderCoordinator {
  private static instance: PDFReaderCoordinator | null = null;
  
  private highlightRenderer: HighlightRenderer;
  private overlayManager: OverlayManager;
  private eventSystem: ReaderEventSystem;
  private layoutHandler: ResponsiveLayoutHandler;

  private constructor() {
    this.highlightRenderer = new HighlightRenderer();
    this.overlayManager = new OverlayManager();
    this.eventSystem = new ReaderEventSystem();
    this.layoutHandler = new ResponsiveLayoutHandler();
  }

  public static getInstance(): PDFReaderCoordinator {
    if (!PDFReaderCoordinator.instance) {
      PDFReaderCoordinator.instance = new PDFReaderCoordinator();
    }
    return PDFReaderCoordinator.instance;
  }

  /**
   * æ˜¾ç¤ºå…±äº«æ ‡æ³¨ï¼ˆä¸»å…¥å£æ–¹æ³•ï¼‰
   */
  public async displaySharedAnnotations(
    reader: any,
    annotations: Annotation[]
  ): Promise<void> {
    // å§”æ‰˜ç»™å„ä¸ªå­æ¨¡å—
    const pageContainers = this.getPageContainers(reader);
    
    for (const container of pageContainers) {
      // æ¸²æŸ“é«˜äº®
      this.highlightRenderer.render(annotations, container, reader);
      
      // åˆ›å»ºOverlay
      for (const annotation of annotations) {
        const overlays = this.overlayManager.createOverlay(annotation, container, reader);
        // ...
      }
      
      // ç›‘å¬å“åº”å¼å¸ƒå±€
      this.layoutHandler.observeContainer(container, () => {
        this.overlayManager.updatePositions(container);
      });
    }
  }

  // ... å…¶ä»–åè°ƒæ–¹æ³•
}

// å‘åå…¼å®¹ï¼šä¿ç•™åŸç±»å
export class PDFReaderManager extends PDFReaderCoordinator {}
```

#### æ­¥éª¤7: æ›´æ–°å¼•ç”¨ (1å°æ—¶ - AIæ‰§è¡Œ)

```typescript
// zotero-plugin/src/modules/readingSessionManager.ts
// âŒ æ—§å¼•ç”¨
// import { PDFReaderManager } from './pdfReaderManager';

// âœ… æ–°å¼•ç”¨ï¼ˆä½¿ç”¨åˆ«åï¼Œä¿æŒå…¼å®¹ï¼‰
import { PDFReaderManager } from './pdf/PDFReaderCoordinator';

// ä½¿ç”¨æ–¹å¼ä¸å˜
const pdfManager = PDFReaderManager.getInstance();
await pdfManager.displaySharedAnnotations(reader, annotations);
```

#### æ­¥éª¤8: åˆ é™¤æ—§æ–‡ä»¶ (10åˆ†é’Ÿ - AIæ‰§è¡Œ)

```bash
# ç¡®è®¤æ‰€æœ‰å¼•ç”¨å·²æ›´æ–°
grep -r "from './pdfReaderManager'" zotero-plugin/src/

# å¤‡ä»½æ—§æ–‡ä»¶
mv zotero-plugin/src/modules/pdfReaderManager.ts zotero-plugin/src/modules/pdfReaderManager.ts.backup

# åˆ é™¤å¤‡ä»½ï¼ˆç¡®è®¤æµ‹è¯•é€šè¿‡åï¼‰
rm zotero-plugin/src/modules/pdfReaderManager.ts.backup
```

#### éªŒæ”¶æ ‡å‡†
```bash
# 1. TypeScriptç¼–è¯‘é€šè¿‡
cd zotero-plugin
npx tsc --noEmit  # âœ… 0 errors

# 2. æ„å»ºæˆåŠŸ
npm run build  # âœ… æ„å»ºæˆåŠŸ

# 3. æµ‹è¯•é€šè¿‡
npm run test  # âœ… PDFæ¨¡å—æµ‹è¯•é€šè¿‡

# 4. æ–‡ä»¶å¤§å°æ£€æŸ¥
wc -l src/modules/pdf/*.ts
# âœ… PDFReaderCoordinator.ts: ~300è¡Œ
# âœ… HighlightRenderer.ts: ~500è¡Œ
# âœ… OverlayManager.ts: ~600è¡Œ
# âœ… ReaderEventSystem.ts: ~400è¡Œ
# âœ… ResponsiveLayoutHandler.ts: ~500è¡Œ
# âœ… æ€»è®¡: ~2300è¡Œï¼ˆåŸ2763è¡Œï¼Œå‡å°‘463è¡Œé‡å¤ä»£ç ï¼‰

# 5. æ‰‹åŠ¨æµ‹è¯•
# - æ‰“å¼€Zotero â†’ æ‰“å¼€PDF â†’ åŠ å…¥é˜…è¯»ä¼šè¯
# - éªŒè¯: å…±äº«æ ‡æ³¨æ­£å¸¸æ˜¾ç¤º
# - éªŒè¯: ç¼©æ”¾/æ»šåŠ¨æ—¶Overlayä½ç½®æ­£ç¡®
# - éªŒè¯: ç‚¹å‡»æ ‡æ³¨å¼¹å‡ºè¯¦æƒ…
```

#### Gitæäº¤
```bash
git add zotero-plugin/src/modules/pdf/
git rm zotero-plugin/src/modules/pdfReaderManager.ts
git add zotero-plugin/src/modules/readingSessionManager.ts # æ›´æ–°å¼•ç”¨
git commit -m "refactor(zotero): æ‹†åˆ†pdfReaderManager.ts (2763â†’2300è¡Œ)

æ¨¡å—åŒ–è®¾è®¡:
- PDFReaderCoordinator: ä¸»åè°ƒå™¨ (300è¡Œ)
- HighlightRenderer: é«˜äº®æ¸²æŸ“ (500è¡Œ)
- OverlayManager: Overlayç®¡ç† (600è¡Œ)
- ReaderEventSystem: äº‹ä»¶ç³»ç»Ÿ (400è¡Œ)
- ResponsiveLayoutHandler: å“åº”å¼å¸ƒå±€ (500è¡Œ)

æ”¹è¿›:
- èŒè´£å•ä¸€: æ¯ä¸ªæ¨¡å—ç‹¬ç«‹èŒè´£
- å¯æµ‹è¯•æ€§: æ¥å£æ¸…æ™°ï¼Œæ˜“äºMock
- ä»£ç å¤ç”¨: å‡å°‘463è¡Œé‡å¤ä»£ç 

æµ‹è¯•: 15+ tests passing, æ‰‹åŠ¨æµ‹è¯•é€šè¿‡
å½±å“: Zoteroæ’ä»¶PDFåŠŸèƒ½"

git tag -a refactor-zotero-pdf-done -m "Zotero PDFæ¨¡å—é‡æ„å®Œæˆ"
```

**é¢„è®¡æ—¶é—´**: 14å°æ—¶ (2ä¸ªå·¥ä½œæ—¥)  
**é£é™©ç­‰çº§**: ğŸ”´ é«˜å±ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦å……åˆ†æµ‹è¯•ï¼‰

---

### ä»»åŠ¡1.2: sessionAnnotationsViewé‡æ„

**æ–‡ä»¶çŠ¶æ€**: æœªç»Ÿè®¡ï¼Œä½†åŒ…å«å¤šä¸ªTODO

**TODOæ¸…å•**:
```typescript
// zotero-plugin/src/modules/ui/sessionAnnotationsView.ts
// TODO: ç§»æ¤SharedAnnotationsViewçš„å†…å®¹
// TODO: å®ç°å…³æ³¨åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ(åˆ›å»ºuser_followsè¡¨)
```

**é‡æ„æ–¹æ¡ˆ**: ä¼˜å…ˆçº§P2ï¼ˆåœ¨ä»»åŠ¡1.1å®Œæˆåè¿›è¡Œï¼‰

*ï¼ˆç¯‡å¹…é™åˆ¶ï¼Œæ­¤å¤„çœç•¥è¯¦ç»†æ­¥éª¤ï¼Œç»“æ„ç±»ä¼¼ä»»åŠ¡1.1ï¼‰*

---

### ä»»åŠ¡1.3-1.4: æ ‡æ³¨åŒæ­¥ä¼˜åŒ– + UIäº‹ä»¶è§£è€¦

*ï¼ˆç¯‡å¹…é™åˆ¶ï¼Œç®€åŒ–æè¿°ï¼‰*

---

## ğŸ“‹ é˜¶æ®µ1æ€»ç»“

```markdown
## é˜¶æ®µ1éªŒæ”¶æ¸…å•
- [ ] ä»»åŠ¡1.1: pdfReaderManageræ‹†åˆ† (é¢„è®¡14å°æ—¶) ğŸš¨
- [ ] ä»»åŠ¡1.2: sessionAnnotationsViewé‡æ„ (é¢„è®¡8å°æ—¶)
- [ ] ä»»åŠ¡1.3: æ ‡æ³¨åŒæ­¥ä¼˜åŒ– (é¢„è®¡6å°æ—¶)
- [ ] ä»»åŠ¡1.4: UIäº‹ä»¶ç³»ç»Ÿè§£è€¦ (é¢„è®¡5å°æ—¶)

æ€»è®¡é¢„è®¡æ—¶é—´: 33å°æ—¶ (5ä¸ªå·¥ä½œæ—¥)
```

---

## ğŸ¯ é˜¶æ®µ2: ç½‘ç«™é‡æ„

### ä»»åŠ¡2.1: database.tsæ‹†åˆ†

**æ–‡ä»¶çŠ¶æ€**: 607è¡Œï¼ˆå‚è€ƒ7.5æ–‡æ¡£ä¸­çš„ç­–ç•¥ï¼‰

*ï¼ˆç»“æ„ç±»ä¼¼ä»»åŠ¡1.1ï¼Œé‡‡ç”¨ä»“å‚¨æ¨¡å¼ï¼‰*

---

## ğŸ¯ é˜¶æ®µ3: æµè§ˆå™¨æ‰©å±•é‡æ„

### ä»»åŠ¡3.1: content.jsæ¨¡å—åŒ–

**æ–‡ä»¶çŠ¶æ€**: 711è¡Œ

**é‡æ„æ–¹æ¡ˆ**: æ‹†åˆ†ä¸º3ä¸ªæ¨¡å—
- DOIDetector.js (200è¡Œ)
- FloatingIconUI.js (250è¡Œ)
- MessageBridge.js (150è¡Œ)

*ï¼ˆç»“æ„ç±»ä¼¼ä»»åŠ¡1.1ï¼‰*

---

## ğŸ“Š æœ€ç»ˆéªŒæ”¶

### æ•´ä½“æŒ‡æ ‡

| æŒ‡æ ‡ | é‡æ„å‰ | ç›®æ ‡ | éªŒæ”¶æ–¹å¼ |
|------|--------|------|----------|
| **è¶…æ ‡æ–‡ä»¶** | 3ä¸ª(>600è¡Œ) | 0ä¸ª | `npm run check:size` |
| **æµ‹è¯•è¦†ç›–** | 73 tests | â‰¥150 tests | `npm run test` |
| **TODOæ•°é‡** | 21ä¸ª | â‰¤5ä¸ª | `grep -r "TODO"` |
| **TypeScripté”™è¯¯** | 0 | 0 | `tsc --noEmit` |
| **æ„å»ºæˆåŠŸ** | ä¸‰ç«¯ | ä¸‰ç«¯ | CIé€šè¿‡ |

### æ—¶é—´æ€»è®¡

```
é˜¶æ®µ0: å…¨å±€åŸºç¡€   - 16å°æ—¶ (2å¤©)
é˜¶æ®µ1: Zoteroæ’ä»¶ - 33å°æ—¶ (5å¤©)
é˜¶æ®µ2: ç½‘ç«™       - 24å°æ—¶ (3å¤©)
é˜¶æ®µ3: æµè§ˆå™¨æ‰©å±• - 12å°æ—¶ (2å¤©)
---
æ€»è®¡: 85å°æ—¶ (çº¦12ä¸ªå·¥ä½œæ—¥)
```

---

**ç»´æŠ¤è€…**: Researchopia Team  
**æœ€åæ›´æ–°**: 2025-11-18  
**æ‰§è¡ŒçŠ¶æ€**: é˜¶æ®µ0è¿›è¡Œä¸­ (40%å®Œæˆ)

---

**è®°ä½: æ¯å®Œæˆ1ä¸ªä»»åŠ¡ â†’ å‹¾é€‰Checkbox â†’ æäº¤Git â†’ æ›´æ–°è¿›åº¦ ğŸš€**
