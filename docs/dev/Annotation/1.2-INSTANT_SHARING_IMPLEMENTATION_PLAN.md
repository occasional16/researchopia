# 1.2 æ ‡æ³¨å³æ—¶å…±äº«åŠŸèƒ½å®æ–½æ–¹æ¡ˆ

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯å®æ–½æ–¹æ¡ˆ  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-11  
> **ä½œè€…**: Researchopia Team  
> **çŠ¶æ€**: å¾…å®¡æ ¸  
> **ç›¸å…³æ–‡æ¡£**: [1.1-å…±äº«æ ‡æ³¨ç”Ÿæ€æ„å»ºç­–ç•¥](./1.1-SHARED_ANNOTATION_ECOSYSTEM_DESIGN.md)

---

## ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [æŠ€æœ¯æ–¹æ¡ˆ](#2-æŠ€æœ¯æ–¹æ¡ˆ)
3. [è¯¦ç»†è®¾è®¡](#3-è¯¦ç»†è®¾è®¡)
4. [å®ç°æ­¥éª¤](#4-å®ç°æ­¥éª¤)
5. [æµ‹è¯•æ–¹æ¡ˆ](#5-æµ‹è¯•æ–¹æ¡ˆ)
6. [éƒ¨ç½²è®¡åˆ’](#6-éƒ¨ç½²è®¡åˆ’)
7. [é£é™©è¯„ä¼°](#7-é£é™©è¯„ä¼°)
8. [åç»­å¾…åŠ](#8-åç»­å¾…åŠ)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**: ç”¨æˆ·åœ¨Zotero PDFé˜…è¯»å™¨ä¸­åˆ›å»ºæ ‡æ³¨æ—¶ï¼Œç«‹å³å¼¹å‡ºå…±äº«é€‰æ‹©å¯¹è¯æ¡†ï¼Œå°†å…±äº«æ“ä½œä»"äº‹åæ‰¹é‡å¤„ç†"å˜ä¸º"åˆ›å»ºæ—¶å®æ—¶å†³ç­–"ã€‚

**è®¾è®¡åŸåˆ™**:
```
å¾®ä¿¡è¯»ä¹¦æ¨¡å¼: æ ‡æ³¨ â†’ é»˜è®¤å…¬å¼€ â†’ ç«‹å³å¯è§
                â†“
           (æ— é¢å¤–æ“ä½œ)

æˆ‘ä»¬çš„æ–¹æ¡ˆ: æ ‡æ³¨ â†’ å¼¹çª—é€‰æ‹©(3ç§’è‡ªåŠ¨) â†’ ç«‹å³åŒæ­¥
               â†“
          (æä½æ‘©æ“¦)
```

### 1.2 ç”¨æˆ·ä»·å€¼

**å¯¹ç”¨æˆ·**:
- âœ… æ‘©æ“¦é™ä½90%ï¼šä»7æ­¥æ“ä½œå‡å°‘åˆ°1æ¬¡ç‚¹å‡»ï¼ˆæˆ–æ— æ“ä½œè‡ªåŠ¨é€‰æ‹©ï¼‰
- âœ… ä¹ æƒ¯å…»æˆï¼šæ¯æ¬¡æ ‡æ³¨éƒ½æç¤ºï¼ŒåŸ¹å…»å…±äº«æ„è¯†
- âœ… å¯æ§æ€§é«˜ï¼šæ¯æ¡æ ‡æ³¨ç‹¬ç«‹å†³ç­–ï¼Œæ”¯æŒè®°ä½åå¥½
- âœ… éšç§ä¿æŠ¤ï¼šæ•æ„Ÿæ ‡æ³¨å¯ç«‹å³é€‰æ‹©"ç§å¯†"

**å¯¹å¹³å°**:
- âœ… å…±äº«ç‡æå‡ï¼šé¢„æœŸä»å½“å‰<5%æå‡åˆ°30-50%
- âœ… æ•°æ®å®æ—¶æ€§ï¼šæ ‡æ³¨åˆ›å»ºåç«‹å³è¿›å…¥ç”Ÿæ€ï¼Œæ— å»¶è¿Ÿ
- âœ… ç”¨æˆ·ç²˜æ€§ï¼šå³æ—¶åé¦ˆæœºåˆ¶å¢å¼ºç”¨æˆ·å‚ä¸æ„Ÿ

### 1.3 åŠŸèƒ½è¾¹ç•Œ

**åŒ…å«**:
- âœ… æ ‡æ³¨åˆ›å»ºäº‹ä»¶ç›‘å¬
- âœ… å…±äº«é€‰æ‹©å¼¹çª—UI
- âœ… è‡ªåŠ¨åŒæ­¥åˆ°Supabase
- âœ… ç”¨æˆ·åå¥½è®¾ç½®
- âœ… æ•æ„Ÿå†…å®¹æ£€æµ‹æç¤º

**ä¸åŒ…å«**:
- âŒ æ™ºèƒ½æ¨èå†å²æ ‡æ³¨ï¼ˆåŠŸèƒ½1ï¼Œåç»­å®ç°ï¼‰
- âŒ çƒ­é—¨æ ‡æ³¨é¡µï¼ˆåŠŸèƒ½3ï¼Œåç»­å®ç°ï¼‰
- âŒ æ‰¹é‡ä¿®æ”¹å·²æœ‰æ ‡æ³¨çš„å…±äº«çŠ¶æ€ï¼ˆå·²æœ‰åŠŸèƒ½ï¼Œæ— éœ€æ”¹åŠ¨ï¼‰

---

## 2. æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 æŠ€æœ¯æ ˆ

**å‰ç«¯ï¼ˆZoteroæ’ä»¶ï¼‰**:
```
- TypeScript
- Zotero Plugin API
  - Zotero.Reader (PDFé˜…è¯»å™¨)
  - Zotero.Notifier (äº‹ä»¶ç›‘å¬)
- XUL/HTML5 (å¯¹è¯æ¡†UI)
```

**åç«¯**:
```
- å¤ç”¨ç°æœ‰API: POST /api/proxy/annotations/share-to-session
- Supabase: annotationsè¡¨ + session_annotationsè¡¨
```

### 2.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Zotero PDF Reader                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·åˆ›å»ºæ ‡æ³¨ï¼ˆé«˜äº®/ä¸‹åˆ’çº¿/ç¬”è®°ï¼‰                          â”‚
â”‚         â†“                                                   â”‚
â”‚  Zotero.Notifier è§¦å‘ 'add' äº‹ä»¶                           â”‚
â”‚         â†“                                                   â”‚
â”‚  InstantSharingManager.onAnnotationCreated()               â”‚
â”‚         â†“                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  æ£€æŸ¥ç”¨æˆ·åå¥½                        â”‚                   â”‚
â”‚  â”‚  - å¦‚æœ"è‡ªåŠ¨åº”ç”¨é»˜è®¤" â†’ è·³è¿‡å¼¹çª—     â”‚                   â”‚
â”‚  â”‚  - å¦åˆ™ â†’ æ˜¾ç¤ºå¼¹çª—                   â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â†“                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  QuickShareDialog.show()            â”‚                   â”‚
â”‚  â”‚  - æ˜¾ç¤º3ä¸ªé€‰é¡¹æŒ‰é’®                   â”‚                   â”‚
â”‚  â”‚  - 3ç§’å€’è®¡æ—¶è‡ªåŠ¨é€‰æ‹©é»˜è®¤              â”‚                   â”‚
â”‚  â”‚  - "è®°ä½é€‰æ‹©"å¤é€‰æ¡†                  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â†“                                                   â”‚
â”‚  è·å–ç”¨æˆ·é€‰æ‹©: 'public' / 'anonymous' / 'private'           â”‚
â”‚         â†“                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  AnnotationManager.updateAnnotationSharing()            â”‚
â”‚  â”‚  - åˆ›å»º/æ›´æ–°Supabaseè®°å½•             â”‚                   â”‚
â”‚  â”‚  - å¦‚æœpublic â†’ åŠ å…¥å½“å‰session       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â†“                                                   â”‚
â”‚  âœ… å®Œæˆï¼šæ ‡æ³¨å·²åŒæ­¥ï¼Œå…¶ä»–ç”¨æˆ·å¯è§                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•°æ®æµ

```
Annotation Object (Zotero) â†’ ZoteroAnnotation (æ’ä»¶) â†’ SupabaseAnnotation (äº‘ç«¯)
         â†“                           â†“                         â†“
   annotation.key            visibility: 'public'        session_annotationsè¡¨
   annotation.text           show_author_name: true      (å¦‚æœæ˜¯public/shared)
   annotation.comment        supabase_id: 'uuid...'
```

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 æ ¸å¿ƒæ¨¡å—ï¼šInstantSharingManager

#### 3.1.1 æ¨¡å—èŒè´£

```typescript
/**
 * å³æ—¶å…±äº«ç®¡ç†å™¨
 * è´Ÿè´£ç›‘å¬æ ‡æ³¨åˆ›å»ºäº‹ä»¶ï¼Œå¼¹å‡ºå…±äº«é€‰æ‹©å¯¹è¯æ¡†ï¼Œå¤„ç†ç”¨æˆ·é€‰æ‹©
 */
export class InstantSharingManager {
  // 1. åˆå§‹åŒ–ï¼šæ³¨å†ŒZotero.Notifierç›‘å¬å™¨
  static async initialize(): Promise<void>;
  
  // 2. æ ‡æ³¨åˆ›å»ºå›è°ƒ
  private static async onAnnotationCreated(annotation: any): Promise<void>;
  
  // 3. æ˜¾ç¤ºå…±äº«é€‰æ‹©å¯¹è¯æ¡†
  private static async showQuickShareDialog(annotation: any): Promise<ShareChoice>;
  
  // 4. åº”ç”¨ç”¨æˆ·é€‰æ‹©
  private static async applyShareChoice(
    annotation: any, 
    choice: ShareChoice
  ): Promise<void>;
  
  // 5. æ£€æŸ¥æ˜¯å¦éœ€è¦å¼¹çª—ï¼ˆè€ƒè™‘ç”¨æˆ·åå¥½ï¼‰
  private static shouldShowDialog(): boolean;
  
  // 6. æ•æ„Ÿå†…å®¹æ£€æµ‹
  private static detectSensitiveContent(annotation: any): boolean;
}

type ShareChoice = {
  visibility: 'public' | 'private';
  showAuthorName: boolean;
  rememberChoice?: boolean;
};
```

#### 3.1.2 Zotero.Notifierç›‘å¬å™¨

```typescript
// src/modules/instantSharingManager.ts

export class InstantSharingManager {
  private static notifierID: string | null = null;
  private static isInitialized = false;

  public static async initialize(): Promise<void> {
    if (this.isInitialized) {
      logger.log("[InstantSharing] Already initialized");
      return;
    }

    // æ³¨å†ŒNotifierç›‘å¬å™¨
    this.notifierID = Zotero.Notifier.registerObserver(
      {
        notify: async (
          event: string,
          type: string,
          ids: number[] | string[],
          extraData: any
        ) => {
          // åªå…³æ³¨annotationçš„'add'äº‹ä»¶
          if (type === 'item' && event === 'add') {
            for (const id of ids) {
              const item = await Zotero.Items.getAsync(id);
              if (item && item.isAnnotation?.()) {
                logger.log("[InstantSharing] New annotation detected:", id);
                await this.onAnnotationCreated(item);
              }
            }
          }
        }
      },
      ['item'] // ç›‘å¬itemç±»å‹
    );

    this.isInitialized = true;
    logger.log("[InstantSharing] Initialized successfully");
  }

  public static cleanup(): void {
    if (this.notifierID) {
      Zotero.Notifier.unregisterObserver(this.notifierID);
      this.notifierID = null;
    }
    this.isInitialized = false;
    logger.log("[InstantSharing] Cleanup completed");
  }
}
```

#### 3.1.3 æ ‡æ³¨åˆ›å»ºå¤„ç†é€»è¾‘

```typescript
private static async onAnnotationCreated(item: any): Promise<void> {
  try {
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    const currentUser = AuthManager.getCurrentUser();
    if (!currentUser) {
      logger.log("[InstantSharing] User not logged in, skip");
      return;
    }

    // 2. æ£€æŸ¥æ˜¯å¦å¯ç”¨å³æ—¶å…±äº«åŠŸèƒ½
    const { PreferenceManager } = await import('../utils/prefs');
    const instantSharingEnabled = PreferenceManager.get('instantSharing.enabled', true);
    if (!instantSharingEnabled) {
      logger.log("[InstantSharing] Feature disabled in preferences");
      return;
    }

    // 3. è½¬æ¢ä¸ºZoteroAnnotationæ ¼å¼
    const annotation: ZoteroAnnotation = {
      id: item.id,
      key: item.key,
      type: item.annotationType || 'highlight',
      text: item.annotationText || '',
      comment: item.annotationComment || '',
      color: item.annotationColor || '#ffd400',
      pageLabel: item.annotationPageLabel || '',
      sortIndex: item.annotationSortIndex || '',
      position: typeof item.annotationPosition === 'string' 
        ? JSON.parse(item.annotationPosition) 
        : (item.annotationPosition || {}),
      tags: item.getTags?.() || [],
      dateModified: item.dateModified,
      parentItemID: item.parentItemID
    };

    // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦å¼¹çª—
    if (!this.shouldShowDialog()) {
      // ç›´æ¥åº”ç”¨é»˜è®¤é€‰æ‹©
      const defaultChoice = this.getDefaultChoice();
      await this.applyShareChoice(annotation, defaultChoice);
      return;
    }

    // 5. æ£€æµ‹æ•æ„Ÿå†…å®¹
    const isSensitive = this.detectSensitiveContent(annotation);
    
    // 6. æ˜¾ç¤ºå¯¹è¯æ¡†
    const choice = await this.showQuickShareDialog(annotation, isSensitive);
    
    // 7. åº”ç”¨é€‰æ‹©
    await this.applyShareChoice(annotation, choice);

    // 8. ä¿å­˜ç”¨æˆ·åå¥½ï¼ˆå¦‚æœå‹¾é€‰äº†"è®°ä½é€‰æ‹©"ï¼‰
    if (choice.rememberChoice) {
      PreferenceManager.set('instantSharing.defaultVisibility', choice.visibility);
      PreferenceManager.set('instantSharing.defaultShowAuthorName', choice.showAuthorName);
      PreferenceManager.set('instantSharing.autoApply', true);
    }

  } catch (error) {
    logger.error("[InstantSharing] Error handling annotation creation:", error);
  }
}
```

#### 3.1.4 æ•æ„Ÿå†…å®¹æ£€æµ‹

```typescript
private static detectSensitiveContent(annotation: ZoteroAnnotation): boolean {
  const sensitivePatterns = [
    // ä¸­æ–‡
    /æˆ‘çš„ç ”ç©¶/i,
    /å®éªŒæ•°æ®/i,
    /å¾…å‘è¡¨/i,
    /æœªå…¬å¼€/i,
    /è‰ç¨¿/i,
    /ç§å¯†/i,
    /TODO/i,
    /ä¸´æ—¶/i,
    
    // è‹±æ–‡
    /my research/i,
    /experimental data/i,
    /unpublished/i,
    /preliminary/i,
    /confidential/i,
    /draft/i,
    /private note/i,
    /internal/i
  ];

  const textToCheck = `${annotation.text} ${annotation.comment}`.toLowerCase();
  
  for (const pattern of sensitivePatterns) {
    if (pattern.test(textToCheck)) {
      logger.log("[InstantSharing] Sensitive content detected:", pattern);
      return true;
    }
  }

  return false;
}
```

### 3.2 UIç»„ä»¶ï¼šQuickShareDialog

#### 3.2.1 å¯¹è¯æ¡†æ ·å¼

**è®¾è®¡è¦æ±‚**:
- ğŸ“ å°å·§ä¸é®æŒ¡ï¼šå®½åº¦400pxï¼Œé«˜åº¦è‡ªé€‚åº”
- ğŸ“ ä½ç½®åˆç†ï¼šå±å¹•å³ä¸‹è§’ï¼Œä¸æŒ¡ä½PDFå†…å®¹
- â±ï¸ è‡ªåŠ¨æ¶ˆå¤±ï¼š3ç§’å€’è®¡æ—¶ï¼Œæ— æ“ä½œè‡ªåŠ¨é€‰æ‹©é»˜è®¤
- ğŸ¨ ç°ä»£é£æ ¼ï¼šåœ†è§’ã€é˜´å½±ã€æ¸å˜æŒ‰é’®
- â™¿ å¯è®¿é—®æ€§ï¼šé”®ç›˜å¿«æ·é”®ï¼ˆ1/2/3é€‰æ‹©é€‰é¡¹ï¼ŒEscå…³é—­ï¼‰

**UIå¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‰ æ ‡æ³¨å·²åˆ›å»ºï¼                     â”‚
â”‚                                      â”‚
â”‚  æ˜¯å¦å…¬å¼€åˆ†äº«è¿™æ¡æ ‡æ³¨ï¼Ÿ               â”‚
â”‚                                      â”‚
â”‚  "The key innovation is..."         â”‚
â”‚  ğŸ’¬ è¿™ä¸ªæ–¹æ³•è§£å†³äº†é•¿æœŸå­˜åœ¨çš„é—®é¢˜      â”‚
â”‚                                      â”‚
â”‚  âš ï¸ æ£€æµ‹åˆ°å¯èƒ½åŒ…å«æ•æ„Ÿå†…å®¹            â”‚  â† å¦‚æœæ£€æµ‹åˆ°
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸŒ å…¬å¼€ â”‚ â”‚ ğŸ•¶ï¸ åŒ¿å â”‚ â”‚ ğŸ”’ ç§å¯† â”‚â”‚
â”‚  â”‚  åˆ†äº«   â”‚ â”‚  åˆ†äº«   â”‚ â”‚  ä¸åˆ†äº« â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                      â”‚
â”‚  â–¡ è®°ä½æˆ‘çš„é€‰æ‹©ï¼Œä¸å†è¯¢é—®             â”‚
â”‚                                      â”‚
â”‚  â±ï¸ 3ç§’åå°†è‡ªåŠ¨é€‰æ‹©"å…¬å¼€åˆ†äº«"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.2 å¯¹è¯æ¡†å®ç°

```typescript
// src/modules/ui/quickShareDialog.ts

export class QuickShareDialog {
  private doc: Document;
  private annotation: ZoteroAnnotation;
  private isSensitive: boolean;
  private countdownTimer: number | null = null;
  private dialogElement: HTMLElement | null = null;
  private resolvePromise: ((choice: ShareChoice) => void) | null = null;

  constructor(
    doc: Document,
    annotation: ZoteroAnnotation,
    isSensitive: boolean
  ) {
    this.doc = doc;
    this.annotation = annotation;
    this.isSensitive = isSensitive;
  }

  /**
   * æ˜¾ç¤ºå¯¹è¯æ¡†å¹¶è¿”å›ç”¨æˆ·é€‰æ‹©
   */
  public show(): Promise<ShareChoice> {
    return new Promise<ShareChoice>((resolve) => {
      this.resolvePromise = resolve;
      this.render();
      this.startCountdown();
      this.attachEventListeners();
    });
  }

  private render(): void {
    // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
    this.dialogElement = this.doc.createElement('div');
    this.dialogElement.id = 'quick-share-dialog';
    this.dialogElement.className = 'quick-share-dialog';
    
    // æ ·å¼
    this.dialogElement.style.cssText = `
      position: fixed;
      bottom: 60px;
      right: 40px;
      width: 400px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
      padding: 24px;
      z-index: 10000;
      animation: slideInUp 0.3s ease-out;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: white;
    `;

    // æ·»åŠ åŠ¨ç”»
    const style = this.doc.createElement('style');
    style.textContent = `
      @keyframes slideInUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .quick-share-dialog button {
        transition: all 0.2s ease;
      }
      
      .quick-share-dialog button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
    `;
    this.doc.head.appendChild(style);

    // å†…å®¹HTML
    const previewText = this.annotation.text?.substring(0, 100) || '';
    const previewComment = this.annotation.comment?.substring(0, 80) || '';
    
    this.dialogElement.innerHTML = `
      <div style="margin-bottom: 16px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">
          ğŸ‰ æ ‡æ³¨å·²åˆ›å»ºï¼
        </div>
        <div style="font-size: 14px; opacity: 0.95;">
          æ˜¯å¦å…¬å¼€åˆ†äº«è¿™æ¡æ ‡æ³¨ï¼Ÿ
        </div>
      </div>

      <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
        <div style="margin-bottom: 6px;">"${previewText}${previewText.length >= 100 ? '...' : ''}"</div>
        ${previewComment ? `<div style="opacity: 0.9;">ğŸ’¬ ${previewComment}${previewComment.length >= 80 ? '...' : ''}</div>` : ''}
      </div>

      ${this.isSensitive ? `
        <div style="background: rgba(255, 193, 7, 0.2); padding: 10px; border-radius: 6px; margin-bottom: 16px; font-size: 12px; border: 1px solid rgba(255, 193, 7, 0.4);">
          âš ï¸ æ£€æµ‹åˆ°å¯èƒ½åŒ…å«æ•æ„Ÿå†…å®¹ï¼Œå»ºè®®é€‰æ‹©"ç§å¯†"
        </div>
      ` : ''}

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px;">
        <button id="btn-public" style="
          padding: 14px 10px;
          background: white;
          color: #667eea;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 700;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 6px;
        ">
          <span style="font-size: 20px;">ğŸŒ</span>
          <span>å…¬å¼€åˆ†äº«</span>
        </button>

        <button id="btn-anonymous" style="
          padding: 14px 10px;
          background: rgba(255,255,255,0.25);
          color: white;
          border: 2px solid rgba(255,255,255,0.5);
          border-radius: 10px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 700;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 6px;
        ">
          <span style="font-size: 20px;">ğŸ•¶ï¸</span>
          <span>åŒ¿ååˆ†äº«</span>
        </button>

        <button id="btn-private" style="
          padding: 14px 10px;
          background: rgba(255,255,255,0.15);
          color: white;
          border: 2px solid rgba(255,255,255,0.3);
          border-radius: 10px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 700;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 6px;
        ">
          <span style="font-size: 20px;">ğŸ”’</span>
          <span>ç§å¯†ä¸åˆ†äº«</span>
        </button>
      </div>

      <div style="margin-bottom: 12px;">
        <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="remember-choice" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
          <span>è®°ä½æˆ‘çš„é€‰æ‹©ï¼Œä¸å†è¯¢é—®</span>
        </label>
      </div>

      <div id="countdown" style="font-size: 12px; opacity: 0.8; text-align: center;">
        â±ï¸ <span id="countdown-seconds">3</span>ç§’åå°†è‡ªåŠ¨é€‰æ‹©"<span id="default-choice">å…¬å¼€åˆ†äº«</span>"
      </div>
    `;

    // æ·»åŠ åˆ°é¡µé¢
    this.doc.body.appendChild(this.dialogElement);

    // æ›´æ–°é»˜è®¤é€‰æ‹©æ˜¾ç¤º
    this.updateDefaultChoiceDisplay();
  }

  private updateDefaultChoiceDisplay(): void {
    const { PreferenceManager } = require('../utils/prefs');
    const defaultVisibility = PreferenceManager.get('instantSharing.defaultVisibility', 'public');
    const defaultChoiceSpan = this.dialogElement?.querySelector('#default-choice');
    
    if (defaultChoiceSpan) {
      const choiceMap: Record<string, string> = {
        'public': 'å…¬å¼€åˆ†äº«',
        'anonymous': 'åŒ¿ååˆ†äº«',
        'private': 'ç§å¯†ä¸åˆ†äº«'
      };
      defaultChoiceSpan.textContent = choiceMap[defaultVisibility] || 'å…¬å¼€åˆ†äº«';
    }
  }

  private startCountdown(): void {
    let seconds = 3;
    const countdownSpan = this.dialogElement?.querySelector('#countdown-seconds');

    this.countdownTimer = window.setInterval(() => {
      seconds--;
      if (countdownSpan) {
        countdownSpan.textContent = seconds.toString();
      }

      if (seconds <= 0) {
        this.applyDefault();
      }
    }, 1000);
  }

  private attachEventListeners(): void {
    // å…¬å¼€åˆ†äº«æŒ‰é’®
    this.dialogElement?.querySelector('#btn-public')?.addEventListener('click', () => {
      this.handleChoice('public', true);
    });

    // åŒ¿ååˆ†äº«æŒ‰é’®
    this.dialogElement?.querySelector('#btn-anonymous')?.addEventListener('click', () => {
      this.handleChoice('public', false);
    });

    // ç§å¯†æŒ‰é’®
    this.dialogElement?.querySelector('#btn-private')?.addEventListener('click', () => {
      this.handleChoice('private', true);
    });

    // é”®ç›˜å¿«æ·é”®
    const keyHandler = (e: KeyboardEvent) => {
      if (e.key === '1') this.handleChoice('public', true);
      else if (e.key === '2') this.handleChoice('public', false);
      else if (e.key === '3') this.handleChoice('private', true);
      else if (e.key === 'Escape') this.handleChoice('private', true);
    };
    this.doc.addEventListener('keydown', keyHandler);
  }

  private handleChoice(visibility: 'public' | 'private', showAuthorName: boolean): void {
    if (!this.resolvePromise) return;

    const rememberCheckbox = this.dialogElement?.querySelector('#remember-choice') as HTMLInputElement;
    const rememberChoice = rememberCheckbox?.checked || false;

    this.cleanup();
    
    this.resolvePromise({
      visibility,
      showAuthorName,
      rememberChoice
    });
  }

  private applyDefault(): void {
    const { PreferenceManager } = require('../utils/prefs');
    const defaultVisibility = PreferenceManager.get('instantSharing.defaultVisibility', 'public');
    const defaultShowAuthorName = PreferenceManager.get('instantSharing.defaultShowAuthorName', true);

    this.handleChoice(
      defaultVisibility as 'public' | 'private',
      defaultShowAuthorName
    );
  }

  private cleanup(): void {
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
      this.countdownTimer = null;
    }

    if (this.dialogElement) {
      this.dialogElement.remove();
      this.dialogElement = null;
    }
  }
}
```

### 3.3 åå¥½è®¾ç½®

#### 3.3.1 æ–°å¢è®¾ç½®é¡¹

åœ¨`typings/prefs.d.ts`ä¸­æ·»åŠ ï¼š

```typescript
declare const _globalThis: {
  // ... ç°æœ‰è®¾ç½®
  
  // å³æ—¶å…±äº«è®¾ç½®
  'instantSharing.enabled': boolean;              // æ˜¯å¦å¯ç”¨å³æ—¶å…±äº«åŠŸèƒ½
  'instantSharing.autoApply': boolean;            // è‡ªåŠ¨åº”ç”¨é»˜è®¤é€‰æ‹©ï¼ˆä¸å¼¹çª—ï¼‰
  'instantSharing.defaultVisibility': string;     // é»˜è®¤å¯è§æ€§: 'public' | 'private'
  'instantSharing.defaultShowAuthorName': boolean; // é»˜è®¤æ˜¯å¦æ˜¾ç¤ºä½œè€…å
  'instantSharing.countdownSeconds': number;      // å€’è®¡æ—¶ç§’æ•°ï¼ˆé»˜è®¤3ï¼‰
  'instantSharing.detectSensitive': boolean;      // æ˜¯å¦æ£€æµ‹æ•æ„Ÿå†…å®¹
};
```

#### 3.3.2 åå¥½è®¾ç½®UI

åœ¨`addon/content/preferences.xhtml`ä¸­æ·»åŠ ï¼š

```xml
<groupbox>
  <caption label="å³æ—¶å…±äº«è®¾ç½®" />
  
  <checkbox 
    id="pref-instantSharing-enabled"
    preference="pref-instantSharing-enabled"
    label="å¯ç”¨å³æ—¶å…±äº«åŠŸèƒ½"
    tooltip="åˆ›å»ºæ ‡æ³¨æ—¶è‡ªåŠ¨å¼¹å‡ºå…±äº«é€‰æ‹©å¯¹è¯æ¡†" />
  
  <hbox align="center">
    <label value="é»˜è®¤å¯è§æ€§ï¼š" />
    <menulist id="pref-instantSharing-defaultVisibility" preference="pref-instantSharing-defaultVisibility">
      <menupopup>
        <menuitem label="ğŸŒ å…¬å¼€åˆ†äº«" value="public" />
        <menuitem label="ğŸ”’ ç§å¯†ä¸åˆ†äº«" value="private" />
      </menupopup>
    </menulist>
  </hbox>
  
  <checkbox 
    id="pref-instantSharing-defaultShowAuthorName"
    preference="pref-instantSharing-defaultShowAuthorName"
    label="é»˜è®¤æ˜¾ç¤ºä½œè€…åï¼ˆå–æ¶ˆå‹¾é€‰åˆ™åŒ¿åï¼‰" />
  
  <checkbox 
    id="pref-instantSharing-autoApply"
    preference="pref-instantSharing-autoApply"
    label="è‡ªåŠ¨åº”ç”¨é»˜è®¤é€‰æ‹©ï¼ˆä¸å¼¹çª—ï¼‰"
    tooltip="å‹¾é€‰åå°†ä¸å†æ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œç›´æ¥ä½¿ç”¨ä¸Šæ–¹çš„é»˜è®¤è®¾ç½®" />
  
  <hbox align="center">
    <label value="å€’è®¡æ—¶ç§’æ•°ï¼š" />
    <textbox 
      id="pref-instantSharing-countdownSeconds"
      preference="pref-instantSharing-countdownSeconds"
      type="number"
      min="1"
      max="10"
      style="width: 60px;" />
    <label value="ç§’" />
  </hbox>
  
  <checkbox 
    id="pref-instantSharing-detectSensitive"
    preference="pref-instantSharing-detectSensitive"
    label="æ£€æµ‹æ•æ„Ÿå†…å®¹å¹¶æç¤º"
    tooltip="è‡ªåŠ¨æ£€æµ‹æ ‡æ³¨ä¸­å¯èƒ½åŒ…å«çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚'æˆ‘çš„ç ”ç©¶'ã€'æœªå‘è¡¨'ç­‰ï¼‰" />
</groupbox>
```

---

## 4. å®ç°æ­¥éª¤

### 4.1 Phase 1: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å¤©ï¼‰

#### Day 1: åŸºç¡€æ¡†æ¶
```
â–¡ åˆ›å»º src/modules/instantSharingManager.ts
  - å®ç° initialize() å’Œ cleanup()
  - æ³¨å†Œ Zotero.Notifier ç›‘å¬å™¨
  - å®ç° onAnnotationCreated() åŸºæœ¬é€»è¾‘

â–¡ åˆ›å»º src/modules/ui/quickShareDialog.ts
  - å®ç°å¯¹è¯æ¡†UIæ¸²æŸ“
  - å®ç°å€’è®¡æ—¶é€»è¾‘
  - å®ç°æŒ‰é’®äº‹ä»¶å¤„ç†

â–¡ æµ‹è¯•ï¼šæ‰‹åŠ¨åˆ›å»ºæ ‡æ³¨ï¼ŒéªŒè¯å¯¹è¯æ¡†èƒ½å¦å¼¹å‡º
```

#### Day 2: é›†æˆåŒæ­¥é€»è¾‘
```
â–¡ é›†æˆ AnnotationManager.updateAnnotationSharing()
  - åœ¨ applyShareChoice() ä¸­è°ƒç”¨
  - å¤„ç†æˆåŠŸ/å¤±è´¥æƒ…å†µ

â–¡ é›†æˆ session_annotations è¡¨
  - å¦‚æœé€‰æ‹©publicï¼Œè‡ªåŠ¨åŠ å…¥å½“å‰session

â–¡ æµ‹è¯•ï¼šéªŒè¯æ ‡æ³¨èƒ½å¦æ­£ç¡®åŒæ­¥åˆ°Supabase
```

#### Day 3: å®Œå–„åŠŸèƒ½
```
â–¡ å®ç°æ•æ„Ÿå†…å®¹æ£€æµ‹
  - detectSensitiveContent() å‡½æ•°
  - å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºè­¦å‘Š

â–¡ å®ç°åå¥½è®¾ç½®
  - æ·»åŠ  prefs.d.ts ç±»å‹å®šä¹‰
  - æ·»åŠ  preferences.xhtml UI
  - å®ç°"è®°ä½é€‰æ‹©"é€»è¾‘

â–¡ æµ‹è¯•ï¼šå®Œæ•´æµç¨‹æµ‹è¯•
```

### 4.2 Phase 2: ä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆ1-2å¤©ï¼‰

#### Day 4: ä¼˜åŒ–
```
â–¡ æ€§èƒ½ä¼˜åŒ–
  - é¿å…é¢‘ç¹åˆ›å»ºDOMå…ƒç´ 
  - å¤ç”¨å¯¹è¯æ¡†å®ä¾‹
  - æ·»åŠ é˜²æŠ–é€»è¾‘ï¼ˆé¿å…çŸ­æ—¶é—´å†…å¤šæ¬¡å¼¹çª—ï¼‰

â–¡ UIä¼˜åŒ–
  - æ·»åŠ åŠ¨ç”»æ•ˆæœ
  - å“åº”å¼å¸ƒå±€ï¼ˆé€‚é…ä¸åŒå±å¹•å°ºå¯¸ï¼‰
  - æ”¹å–„å¯è®¿é—®æ€§ï¼ˆé”®ç›˜å¿«æ·é”®ã€å±å¹•é˜…è¯»å™¨æ”¯æŒï¼‰

â–¡ é”™è¯¯å¤„ç†
  - ç½‘ç»œé”™è¯¯å¤„ç†
  - Supabase APIå¤±è´¥å¤„ç†
  - ç”¨æˆ·å–æ¶ˆæ“ä½œå¤„ç†
```

#### Day 5: æµ‹è¯•
```
â–¡ å•å…ƒæµ‹è¯•
  - detectSensitiveContent() æµ‹è¯•ç”¨ä¾‹
  - åå¥½è®¾ç½®è¯»å†™æµ‹è¯•

â–¡ é›†æˆæµ‹è¯•
  - åˆ›å»ºæ ‡æ³¨ â†’ å¼¹çª— â†’ é€‰æ‹© â†’ åŒæ­¥ å®Œæ•´æµç¨‹
  - ä¸åŒå¯è§æ€§é€‰é¡¹æµ‹è¯•
  - è®°ä½é€‰æ‹©åŠŸèƒ½æµ‹è¯•

â–¡ è¾¹ç•Œæµ‹è¯•
  - æœªç™»å½•ç”¨æˆ·
  - ç½‘ç»œæ–­å¼€
  - SupabaseæœåŠ¡ä¸å¯ç”¨
  - å¿«é€Ÿè¿ç»­åˆ›å»ºå¤šä¸ªæ ‡æ³¨
```

### 4.3 Phase 3: æ–‡æ¡£ä¸éƒ¨ç½²ï¼ˆ1å¤©ï¼‰

#### Day 6: æ–‡æ¡£
```
â–¡ æ›´æ–° USER-GUIDE.md
  - æ·»åŠ "å³æ—¶å…±äº«"ç« èŠ‚
  - æ·»åŠ è®¾ç½®è¯´æ˜
  - æ·»åŠ å¸¸è§é—®é¢˜

â–¡ æ›´æ–° DEVELOPMENT.md
  - æ·»åŠ æ¶æ„è¯´æ˜
  - æ·»åŠ APIæ–‡æ¡£

â–¡ åˆ›å»º CHANGELOG.md æ¡ç›®
```

#### Day 7: éƒ¨ç½²
```
â–¡ ä»£ç å®¡æŸ¥
  - ESLintæ£€æŸ¥
  - ç±»å‹æ£€æŸ¥
  - ä»£ç æ ¼å¼åŒ–

â–¡ æ„å»ºæµ‹è¯•ç‰ˆæœ¬
  - npm run build
  - åœ¨Zotero 7/8ä¸­æµ‹è¯•

â–¡ å‘å¸ƒ
  - æ›´æ–°ç‰ˆæœ¬å·
  - åˆ›å»ºGitHub Release
  - å‘å¸ƒåˆ°å®˜ç½‘
```

---

## 5. æµ‹è¯•æ–¹æ¡ˆ

### 5.1 åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•ç”¨ä¾‹1: åŸºæœ¬æµç¨‹
```
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œå³æ—¶å…±äº«åŠŸèƒ½å·²å¯ç”¨

æ­¥éª¤ï¼š
1. åœ¨Zotero PDFé˜…è¯»å™¨ä¸­æ‰“å¼€ä¸€ç¯‡è®ºæ–‡
2. é«˜äº®é€‰æ‹©ä¸€æ®µæ–‡æœ¬
3. éªŒè¯ï¼šå¯¹è¯æ¡†åœ¨3ç§’å†…å¼¹å‡º
4. ç‚¹å‡»"å…¬å¼€åˆ†äº«"æŒ‰é’®
5. éªŒè¯ï¼šå¯¹è¯æ¡†å…³é—­
6. æ£€æŸ¥Supabase: annotationsè¡¨ä¸­æ–°å¢è®°å½•ï¼Œvisibility='public'
7. å¦‚æœæœ‰å½“å‰sessionï¼Œæ£€æŸ¥session_annotationsè¡¨ä¸­æ–°å¢è®°å½•

é¢„æœŸç»“æœï¼šâœ… æ ‡æ³¨æˆåŠŸåˆ›å»ºå¹¶åŒæ­¥åˆ°Supabase
```

#### æµ‹è¯•ç”¨ä¾‹2: å€’è®¡æ—¶è‡ªåŠ¨é€‰æ‹©
```
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œé»˜è®¤é€‰æ‹©ä¸º"å…¬å¼€åˆ†äº«"

æ­¥éª¤ï¼š
1. åˆ›å»ºæ ‡æ³¨
2. å¯¹è¯æ¡†å¼¹å‡ºåä¸è¿›è¡Œä»»ä½•æ“ä½œ
3. ç­‰å¾…3ç§’
4. éªŒè¯ï¼šå¯¹è¯æ¡†è‡ªåŠ¨å…³é—­ï¼Œæ ‡æ³¨ä»¥"å…¬å¼€"æ–¹å¼åŒæ­¥

é¢„æœŸç»“æœï¼šâœ… è‡ªåŠ¨åº”ç”¨é»˜è®¤é€‰æ‹©
```

#### æµ‹è¯•ç”¨ä¾‹3: è®°ä½é€‰æ‹©
```
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·å·²ç™»å½•

æ­¥éª¤ï¼š
1. åˆ›å»ºæ ‡æ³¨Aï¼Œå¯¹è¯æ¡†å¼¹å‡º
2. å‹¾é€‰"è®°ä½æˆ‘çš„é€‰æ‹©"
3. é€‰æ‹©"ç§å¯†ä¸åˆ†äº«"
4. åˆ›å»ºæ ‡æ³¨B
5. éªŒè¯ï¼šå¯¹è¯æ¡†ä¸å†å¼¹å‡ºï¼Œæ ‡æ³¨Bç›´æ¥ä»¥"ç§å¯†"æ–¹å¼ä¿å­˜

é¢„æœŸç»“æœï¼šâœ… è®°ä½ç”¨æˆ·åå¥½ï¼Œåç»­æ ‡æ³¨ä¸å†å¼¹çª—
```

#### æµ‹è¯•ç”¨ä¾‹4: æ•æ„Ÿå†…å®¹æ£€æµ‹
```
å‰ç½®æ¡ä»¶ï¼šæ•æ„Ÿå†…å®¹æ£€æµ‹å·²å¯ç”¨

æ­¥éª¤ï¼š
1. åˆ›å»ºæ ‡æ³¨ï¼Œè¯„è®ºä¸­è¾“å…¥"è¿™æ˜¯æˆ‘çš„ç ”ç©¶æ•°æ®ï¼Œå¾…å‘è¡¨"
2. éªŒè¯ï¼šå¯¹è¯æ¡†ä¸­æ˜¾ç¤ºè­¦å‘Šâš ï¸
3. éªŒè¯ï¼šè­¦å‘Šæç¤º"æ£€æµ‹åˆ°å¯èƒ½åŒ…å«æ•æ„Ÿå†…å®¹"

é¢„æœŸç»“æœï¼šâœ… æ­£ç¡®æ£€æµ‹å¹¶æç¤ºç”¨æˆ·
```

#### æµ‹è¯•ç”¨ä¾‹5: æœªç™»å½•ç”¨æˆ·
```
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·æœªç™»å½•

æ­¥éª¤ï¼š
1. åˆ›å»ºæ ‡æ³¨
2. éªŒè¯ï¼šå¯¹è¯æ¡†ä¸å¼¹å‡º
3. éªŒè¯ï¼šæ ‡æ³¨ä»…ä¿å­˜åœ¨æœ¬åœ°Zotero

é¢„æœŸç»“æœï¼šâœ… ä¸å¹²æ‰°æœªç™»å½•ç”¨æˆ·çš„æ­£å¸¸ä½¿ç”¨
```

#### æµ‹è¯•ç”¨ä¾‹6: ç½‘ç»œé”™è¯¯
```
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·å·²ç™»å½•ï¼ŒSupabaseä¸å¯è¾¾

æ­¥éª¤ï¼š
1. æ–­å¼€ç½‘ç»œ
2. åˆ›å»ºæ ‡æ³¨ï¼Œé€‰æ‹©"å…¬å¼€åˆ†äº«"
3. éªŒè¯ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º"ç½‘ç»œé”™è¯¯ï¼ŒåŒæ­¥å¤±è´¥"
4. éªŒè¯ï¼šæ ‡æ³¨ä¿å­˜åœ¨æœ¬åœ°ï¼Œä½†æœªåŒæ­¥åˆ°äº‘ç«¯

é¢„æœŸç»“æœï¼šâœ… ä¼˜é›…åœ°å¤„ç†é”™è¯¯ï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œ
```

### 5.2 æ€§èƒ½æµ‹è¯•

#### æµ‹è¯•åœºæ™¯1: è¿ç»­åˆ›å»ºæ ‡æ³¨
```
æ­¥éª¤ï¼š
1. åœ¨5ç§’å†…å¿«é€Ÿåˆ›å»º10ä¸ªæ ‡æ³¨
2. è§‚å¯Ÿï¼šæ˜¯å¦æœ‰å¡é¡¿ã€å´©æºƒ
3. éªŒè¯ï¼šæ‰€æœ‰æ ‡æ³¨éƒ½æ­£ç¡®å¤„ç†

é¢„æœŸç»“æœï¼šâœ… æ— æ˜æ˜¾æ€§èƒ½é—®é¢˜
```

#### æµ‹è¯•åœºæ™¯2: å¤§é‡å†å²æ ‡æ³¨
```
æ­¥éª¤ï¼š
1. å‡†å¤‡ä¸€ä¸ªåŒ…å«500+æ ‡æ³¨çš„PDF
2. åˆ›å»ºæ–°æ ‡æ³¨
3. æµ‹é‡ï¼šå¯¹è¯æ¡†å¼¹å‡ºé€Ÿåº¦

é¢„æœŸç»“æœï¼šâœ… <500ms
```

### 5.3 å…¼å®¹æ€§æµ‹è¯•

```
æµ‹è¯•å¹³å°ï¼š
- Windows 10/11 + Zotero 7 + Chrome
- macOS 13+ + Zotero 8 Beta + Safari
- Linux (Ubuntu 22.04) + Zotero 7 + Firefox

éªŒè¯ç‚¹ï¼š
- å¯¹è¯æ¡†æ­£å¸¸æ˜¾ç¤º
- æŒ‰é’®ç‚¹å‡»å“åº”
- é”®ç›˜å¿«æ·é”®æœ‰æ•ˆ
- åå¥½è®¾ç½®æ­£å¸¸ä¿å­˜
```

---

## 6. éƒ¨ç½²è®¡åˆ’

### 6.1 ç‰ˆæœ¬ç®¡ç†

**ç‰ˆæœ¬å·è§„åˆ™**: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemantic Versioningï¼‰

```
å½“å‰ç‰ˆæœ¬: v1.0.0
æ–°ç‰ˆæœ¬: v1.1.0 (æ–°å¢åŠŸèƒ½: å³æ—¶å…±äº«)

ç‰ˆæœ¬å·æ ¼å¼: MAJOR.MINOR.PATCH
- MAJOR: ä¸å…¼å®¹çš„APIå˜æ›´
- MINOR: å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ–°å¢
- PATCH: å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£
```

### 6.2 å‘å¸ƒæµç¨‹

#### 6.2.1 æ„å»º
```bash
# 1. æ›´æ–°ç‰ˆæœ¬å·
npm version minor  # 1.0.0 â†’ 1.1.0

# 2. åŒæ­¥ç‰ˆæœ¬å·åˆ°å¤šå¤„
node scripts/sync-versions.js

# 3. æ„å»ºæ’ä»¶
cd zotero-plugin
npm run build

# 4. ç”Ÿæˆ.xpiæ–‡ä»¶
npm run build:xpi
# è¾“å‡º: builds/researchopia-1.1.0.xpi
```

#### 6.2.2 æµ‹è¯•
```bash
# 1. å®‰è£…åˆ°Zotero
# æ‰‹åŠ¨ï¼šå·¥å…· â†’ é™„åŠ ç»„ä»¶ â†’ Install Add-on From File

# 2. å†’çƒŸæµ‹è¯•
# - åˆ›å»ºæ ‡æ³¨
# - å¯¹è¯æ¡†å¼¹å‡º
# - é€‰æ‹©é€‰é¡¹
# - éªŒè¯åŒæ­¥

# 3. å›å½’æµ‹è¯•
# - è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
# - ç¡®ä¿æ—§åŠŸèƒ½æœªè¢«ç ´å
```

#### 6.2.3 å‘å¸ƒ
```bash
# 1. åˆ›å»ºGitæ ‡ç­¾
git tag -a v1.1.0 -m "Release v1.1.0: Instant Sharing"
git push origin v1.1.0

# 2. GitHub Release
# è®¿é—®: https://github.com/occasional16/researchopia/releases/new
# ä¸Šä¼ : researchopia-1.1.0.xpi
# å¡«å†™: Release Notes

# 3. æ›´æ–°å®˜ç½‘
# - æ›´æ–°ä¸‹è½½é“¾æ¥
# - å‘å¸ƒæ›´æ–°å…¬å‘Š

# 4. é€šçŸ¥ç”¨æˆ·
# - é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœæœ‰é‚®ä»¶åˆ—è¡¨ï¼‰
# - ç¤¾äº¤åª’ä½“å‘å¸ƒ
# - Discord/Slackç¤¾åŒºå…¬å‘Š
```

### 6.3 ç°åº¦å‘å¸ƒï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: é™ä½é£é™©ï¼Œé€æ­¥æ¨å¹¿

```
ç¬¬1å¤©: 5% ç”¨æˆ·ï¼ˆç§å­ç”¨æˆ·ï¼‰
      â†“ è§‚å¯ŸæŒ‡æ ‡ï¼šé”™è¯¯ç‡ã€å´©æºƒç‡
ç¬¬3å¤©: 20% ç”¨æˆ·
      â†“ è§‚å¯ŸæŒ‡æ ‡ï¼šä½¿ç”¨ç‡ã€å…±äº«ç‡
ç¬¬7å¤©: 50% ç”¨æˆ·
      â†“ æ”¶é›†åé¦ˆï¼Œä¿®å¤é—®é¢˜
ç¬¬10å¤©: 100% ç”¨æˆ·ï¼ˆå…¨é‡å‘å¸ƒï¼‰
```

**å®ç°æ–¹å¼**:
```typescript
// src/modules/instantSharingManager.ts

private static isUserInRollout(): boolean {
  const user = AuthManager.getCurrentUser();
  if (!user) return false;

  // ä»æœåŠ¡å™¨è·å–ç°åº¦å‘å¸ƒé…ç½®
  const rolloutConfig = await this.fetchRolloutConfig();
  
  // åŸºäºuser_idå“ˆå¸Œå€¼å†³å®šæ˜¯å¦åœ¨ç°åº¦èŒƒå›´å†…
  const userHash = this.hashUserId(user.id);
  return userHash < rolloutConfig.percentage;
}
```

---

## 7. é£é™©è¯„ä¼°

### 7.1 æŠ€æœ¯é£é™©

#### é£é™©1: Zotero.Notifier äº‹ä»¶ä¸¢å¤±
**å½±å“**: ç”¨æˆ·åˆ›å»ºæ ‡æ³¨ä½†å¯¹è¯æ¡†æœªå¼¹å‡º
**æ¦‚ç‡**: ä½
**åº”å¯¹**:
- æ·»åŠ å¿ƒè·³æ£€æµ‹ï¼Œå®šæœŸéªŒè¯ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸
- æä¾›æ‰‹åŠ¨è§¦å‘å¯¹è¯æ¡†çš„å…¥å£ï¼ˆå³é”®èœå•ï¼‰
- æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

#### é£é™©2: å¯¹è¯æ¡†è¢«PDFè¦†ç›–
**å½±å“**: ç”¨æˆ·çœ‹ä¸åˆ°å¯¹è¯æ¡†
**æ¦‚ç‡**: ä¸­
**åº”å¯¹**:
- ä½¿ç”¨æœ€é«˜z-index (10000+)
- æµ‹è¯•å¤šç§Zoteroç‰ˆæœ¬å’ŒPDFæŸ¥çœ‹å™¨
- å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å¯¹è¯æ¡†ä½ç½®

#### é£é™©3: åŒæ­¥å¤±è´¥
**å½±å“**: ç”¨æˆ·é€‰æ‹©å…¬å¼€ä½†æœªæˆåŠŸåŒæ­¥
**æ¦‚ç‡**: ä¸­ï¼ˆç½‘ç»œä¸ç¨³å®šï¼‰
**åº”å¯¹**:
- æ˜ç¡®çš„é”™è¯¯æç¤º
- æ”¯æŒç¦»çº¿é˜Ÿåˆ—ï¼Œç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡è¯•
- æä¾›æ‰‹åŠ¨é‡æ–°åŒæ­¥æŒ‰é’®

### 7.2 äº§å“é£é™©

#### é£é™©1: ç”¨æˆ·è§‰å¾—æ‰“æ‰°
**å½±å“**: å…³é—­å³æ—¶å…±äº«åŠŸèƒ½
**æ¦‚ç‡**: ä¸­
**åº”å¯¹**:
- æä¾›"è®°ä½é€‰æ‹©"é€‰é¡¹
- æä¾›"è‡ªåŠ¨åº”ç”¨é»˜è®¤"é€‰é¡¹ï¼ˆå®Œå…¨å…³é—­å¼¹çª—ï¼‰
- æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œè°ƒæ•´é»˜è®¤è¡Œä¸º

#### é£é™©2: å…±äº«ç‡æœªæå‡
**å½±å“**: åŠŸèƒ½æ— æ•ˆï¼Œäº§å“ç›®æ ‡æœªè¾¾æˆ
**æ¦‚ç‡**: ä½
**åº”å¯¹**:
- A/Bæµ‹è¯•ä¸åŒUIè®¾è®¡
- è°ƒæ•´å€’è®¡æ—¶æ—¶é•¿
- ä¼˜åŒ–é»˜è®¤é€‰é¡¹ï¼ˆå…¬å¼€ vs ç§å¯†ï¼‰

#### é£é™©3: éšç§æ³„éœ²
**å½±å“**: ç”¨æˆ·æ•æ„Ÿä¿¡æ¯è¢«å…¬å¼€
**æ¦‚ç‡**: ä¸­
**åº”å¯¹**:
- æ•æ„Ÿå†…å®¹æ£€æµ‹ï¼ˆå·²å®ç°ï¼‰
- æ˜ç¡®çš„éšç§è¯´æ˜
- æ”¯æŒæ’¤å›å·²å…¬å¼€çš„æ ‡æ³¨

### 7.3 è¿è¥é£é™©

#### é£é™©1: æ”¯æŒè¯·æ±‚å¢åŠ 
**å½±å“**: ç”¨æˆ·ä¸ç†è§£æ–°åŠŸèƒ½ï¼Œæäº¤å¤§é‡é—®é¢˜
**æ¦‚ç‡**: é«˜
**åº”å¯¹**:
- è¯¦ç»†çš„ç”¨æˆ·æŒ‡å—
- FAQæ–‡æ¡£
- é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºå¼•å¯¼æ•™ç¨‹

#### é£é™©2: è´Ÿé¢åé¦ˆ
**å½±å“**: éƒ¨åˆ†ç”¨æˆ·ä¸å–œæ¬¢æ–°åŠŸèƒ½ï¼Œç»™å‡ºå·®è¯„
**æ¦‚ç‡**: ä¸­
**åº”å¯¹**:
- å¼ºè°ƒåŠŸèƒ½å¯å…³é—­
- ä¸»åŠ¨æ”¶é›†åé¦ˆï¼Œå¿«é€Ÿè¿­ä»£
- åœ¨Release Notesä¸­è¯¦ç»†è¯´æ˜

---

## 8. åç»­å¾…åŠ

### 8.1 åŠŸèƒ½1: æ™ºèƒ½æ¨èå†å²æ ‡æ³¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**æ–‡æ¡£**: å‚è€ƒ [1.1èŠ‚ åŠŸèƒ½è®¾è®¡ 6.1.1](./1.1-SHARED_ANNOTATION_ECOSYSTEM_DESIGN.md#611-æ™ºèƒ½æ¨èå…±äº«åŠŸèƒ½)

**ç›®æ ‡**: 
- ä¸ºç”¨æˆ·ç­›é€‰å‡ºæœ€å€¼å¾—å…¬å¼€çš„å†å²æ ‡æ³¨
- æ”¯æŒæ‰¹é‡å®¡æ ¸å’Œä¸€é”®å…±äº«

**å…³é”®æ¨¡å—**:
```typescript
// src/modules/annotationRecommender.ts
class AnnotationRecommender {
  static recommendForSharing(annotations: ZoteroAnnotation[]): AnnotationScore[];
  private static calculateScore(ann: ZoteroAnnotation): number;
}
```

**UIå…¥å£**:
- "ç®¡ç†æ ‡æ³¨"tabé¡¶éƒ¨
- æ–°å¢"ğŸ¯ æ™ºèƒ½æ¨è"æŒ‰é’®

**é¢„è®¡å·¥æœŸ**: 5-6å¤©

---

### 8.2 åŠŸèƒ½3: çƒ­é—¨æ ‡æ³¨é¡µï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**æ–‡æ¡£**: å‚è€ƒ [1.1èŠ‚ åŠŸèƒ½è®¾è®¡ 6.2.1](./1.1-SHARED_ANNOTATION_ECOSYSTEM_DESIGN.md#621-çƒ­é—¨æ ‡æ³¨é¡µ)

**ç›®æ ‡**:
- å±•ç¤ºå…¨å¹³å°çƒ­é—¨æ ‡æ³¨
- æ”¯æŒå­¦ç§‘åˆ†ç±»
- å¸å¼•ç”¨æˆ·å‚ä¸è®¨è®º

**å…³é”®ç»„ä»¶**:
```typescript
// src/modules/ui/hotAnnotationsView.ts
class HotAnnotationsView {
  async render(container: HTMLElement, doc: Document): Promise<void>;
  private async fetchHotAnnotations(field?: string): Promise<any[]>;
  private renderAnnotationCard(annotation: any): HTMLElement;
}
```

**åç«¯æ”¯æŒ**:
- ç‰©åŒ–è§†å›¾: `mv_hot_annotations`
- API: `GET /api/annotations/hot`

**é¢„è®¡å·¥æœŸ**: 5-6å¤©

---

### 8.3 åŠŸèƒ½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### 8.3.1 å¯¹è¯æ¡†ä½ç½®è®°å¿†
```
â–¡ å…è®¸ç”¨æˆ·æ‹–æ‹½å¯¹è¯æ¡†åˆ°å–œæ¬¢çš„ä½ç½®
â–¡ ä¿å­˜ä½ç½®åˆ°åå¥½è®¾ç½®
â–¡ ä¸‹æ¬¡è‡ªåŠ¨å‡ºç°åœ¨ç›¸åŒä½ç½®
```

#### 8.3.2 å¿«æ·é”®è‡ªå®šä¹‰
```
â–¡ å…è®¸ç”¨æˆ·è‡ªå®šä¹‰é”®ç›˜å¿«æ·é”®
â–¡ é»˜è®¤: 1=å…¬å¼€, 2=åŒ¿å, 3=ç§å¯†
â–¡ å¯æ”¹ä¸º: P=å…¬å¼€, A=åŒ¿å, Esc=ç§å¯†
```

#### 8.3.3 æ‰¹é‡æ¨¡å¼
```
â–¡ å¿«é€Ÿåˆ›å»ºå¤šä¸ªæ ‡æ³¨æ—¶ï¼Œè¿›å…¥"æ‰¹é‡æ¨¡å¼"
â–¡ æ‰€æœ‰æ ‡æ³¨å…ˆæš‚å­˜ï¼Œæœ€åç»Ÿä¸€é€‰æ‹©å¯è§æ€§
â–¡ é¿å…é¢‘ç¹å¼¹çª—æ‰“æ–­é˜…è¯»
```

#### 8.3.4 AIè¾…åŠ©
```
â–¡ ä½¿ç”¨LLMåˆ†ææ ‡æ³¨å†…å®¹
â–¡ è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å€¼å¾—å…¬å¼€ï¼ˆè´¨é‡è¯„åˆ†ï¼‰
â–¡ è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ï¼ˆ#æœºå™¨å­¦ä¹  #æ³¨æ„åŠ›æœºåˆ¶ï¼‰
```

---

### 8.4 æ•°æ®åˆ†æï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

**ç›®æ ‡**: é€šè¿‡æ•°æ®éªŒè¯åŠŸèƒ½æ•ˆæœ

**å…³é”®æŒ‡æ ‡**:
```
1. å³æ—¶å…±äº«åŠŸèƒ½ä½¿ç”¨ç‡
   - å¯ç”¨è¯¥åŠŸèƒ½çš„ç”¨æˆ·å æ¯”
   - å¯¹è¯æ¡†å¼¹å‡ºæ¬¡æ•°
   - ç”¨æˆ·é€‰æ‹©åˆ†å¸ƒï¼ˆå…¬å¼€/åŒ¿å/ç§å¯†ï¼‰

2. å…±äº«ç‡æå‡
   - å¯ç”¨å‰åå¯¹æ¯”
   - ç›®æ ‡: ä»<5%æå‡åˆ°30-50%

3. ç”¨æˆ·ä½“éªŒ
   - å¯¹è¯æ¡†å…³é—­æ–¹å¼åˆ†å¸ƒï¼ˆç‚¹å‡»æŒ‰é’® vs è‡ªåŠ¨å€’è®¡æ—¶ï¼‰
   - "è®°ä½é€‰æ‹©"ä½¿ç”¨ç‡
   - é”™è¯¯ç‡ï¼ˆåŒæ­¥å¤±è´¥æ¬¡æ•°ï¼‰

4. å†…å®¹è´¨é‡
   - æ•æ„Ÿå†…å®¹æ£€æµ‹è§¦å‘ç‡
   - ç”¨æˆ·å¿½ç•¥æ•æ„Ÿè­¦å‘Šçš„æ¯”ä¾‹
```

**å®ç°æ–¹å¼**:
```typescript
// src/modules/analytics.ts
class AnalyticsManager {
  static trackEvent(eventName: string, properties: any): void;
  static trackError(error: Error, context: any): void;
}

// ä½¿ç”¨ç¤ºä¾‹
AnalyticsManager.trackEvent('instant_sharing_dialog_shown', {
  annotation_type: 'highlight',
  is_sensitive: false
});

AnalyticsManager.trackEvent('instant_sharing_choice_made', {
  choice: 'public',
  is_auto: false, // æ˜¯å¦å€’è®¡æ—¶è‡ªåŠ¨é€‰æ‹©
  remember_choice: true
});
```

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒä»·å€¼

**å³æ—¶å…±äº«åŠŸèƒ½é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³æ ¸å¿ƒé—®é¢˜**:

```
é—®é¢˜: ç”¨æˆ·æœ‰å¤§é‡æ ‡æ³¨ä½†ä¸æ„¿æ„/ä¸çŸ¥é“å¦‚ä½•å…±äº«
           â†“
æ–¹æ¡ˆ1: é™ä½æ‘©æ“¦ â†’ ä»7æ­¥å‡å°‘åˆ°1æ­¥ï¼ˆæˆ–0æ­¥è‡ªåŠ¨ï¼‰
æ–¹æ¡ˆ2: åŸ¹å…»ä¹ æƒ¯ â†’ æ¯æ¬¡æ ‡æ³¨éƒ½æç¤ºï¼Œå½¢æˆè‚Œè‚‰è®°å¿†
æ–¹æ¡ˆ3: å°Šé‡é€‰æ‹© â†’ ä¸‰ç§å¯è§æ€§ï¼Œæ”¯æŒè®°ä½åå¥½
           â†“
ç»“æœ: å…±äº«ç‡ä»<5%æå‡åˆ°30-50%
           â†“
å½±å“: æ ‡æ³¨ç”Ÿæ€å¿«é€Ÿå»ºç«‹ï¼Œç½‘ç»œæ•ˆåº”å¯åŠ¨
```

### 9.2 æˆåŠŸæŒ‡æ ‡

**çŸ­æœŸæŒ‡æ ‡ï¼ˆ1ä¸ªæœˆï¼‰**:
- [ ] åŠŸèƒ½ä½¿ç”¨ç‡ > 60%ï¼ˆå¯ç”¨è¯¥åŠŸèƒ½çš„ç”¨æˆ·å æ¯”ï¼‰
- [ ] å…±äº«ç‡æå‡è‡³20-30%
- [ ] é”™è¯¯ç‡ < 1%
- [ ] ç”¨æˆ·æ»¡æ„åº¦ > 4.0/5.0

**ä¸­æœŸæŒ‡æ ‡ï¼ˆ3ä¸ªæœˆï¼‰**:
- [ ] å…±äº«ç‡ç¨³å®šåœ¨30-50%
- [ ] äººå‡å…±äº«æ ‡æ³¨æ•° > 50æ¡
- [ ] "è®°ä½é€‰æ‹©"ä½¿ç”¨ç‡ > 40%ï¼ˆè¯´æ˜ç”¨æˆ·å½¢æˆä¹ æƒ¯ï¼‰

**é•¿æœŸæŒ‡æ ‡ï¼ˆ6ä¸ªæœˆï¼‰**:
- [ ] æ–°ç”¨æˆ·30å¤©å†…è‡³å°‘å…±äº«10æ¡æ ‡æ³¨ > 70%
- [ ] æ ‡æ³¨è¢«é˜…è¯»æ¬¡æ•°åŒæ¯”å¢é•¿300%
- [ ] å…¬å¼€æ ‡æ³¨æ€»æ•°çªç ´100ä¸‡æ¡

### 9.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³æ‰§è¡Œ**:
1. âœ… å®¡æ ¸æœ¬æ–¹æ¡ˆï¼Œæ”¶é›†åé¦ˆ
2. âœ… å¼€å§‹Phase 1å¼€å‘ï¼ˆé¢„è®¡3å¤©ï¼‰
3. âœ… å†…éƒ¨æµ‹è¯•ï¼ˆ1å¤©ï¼‰

**è¿‘æœŸè®¡åˆ’ï¼ˆ2å‘¨å†…ï¼‰**:
1. å‘å¸ƒv1.1.0ï¼ˆåŒ…å«å³æ—¶å…±äº«åŠŸèƒ½ï¼‰
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. å¿«é€Ÿè¿­ä»£ä¼˜åŒ–

**ä¸­æœŸè®¡åˆ’ï¼ˆ1ä¸ªæœˆå†…ï¼‰**:
1. å®ç°åŠŸèƒ½1ï¼ˆæ™ºèƒ½æ¨èå†å²æ ‡æ³¨ï¼‰
2. å®ç°åŠŸèƒ½3ï¼ˆçƒ­é—¨æ ‡æ³¨é¡µï¼‰
3. å½¢æˆå®Œæ•´çš„å…±äº«æ ‡æ³¨ç”Ÿæ€é—­ç¯

---

**æ–‡æ¡£ç»“æŸ**

_ç°åœ¨ç­‰å¾…æ‚¨çš„åé¦ˆï¼Œå¦‚æ‰¹å‡†åˆ™ç«‹å³å¼€å§‹å®æ–½ï¼_
