# 1.4.4 ä¸ºAnnotation-Popupæ·»åŠ 4çº§å…±äº«æŒ‰é’®

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### ç°çŠ¶
- âœ… **selection-popup**: é€‰ä¸­æ–‡æœ¬æ—¶å‡ºç°ï¼Œå·²å®ç°4çº§å…±äº«æŒ‰é’®ï¼ˆå…¬å¼€/åŒ¿å/ç§å¯†/å–æ¶ˆï¼‰
- âŒ **annotation-popup**: ç‚¹å‡»å·²æœ‰æ ‡æ³¨æ—¶å‡ºç°ï¼Œæš‚æ— å…±äº«æŒ‰é’®

### ç›®æ ‡
ä¸º `annotation-popup` æ·»åŠ ç›¸åŒçš„4ä¸ªå…±äº«æŒ‰é’®ï¼Œæä¾›å³æ—¶ä¿®æ”¹æ ‡æ³¨å…±äº«çŠ¶æ€çš„èƒ½åŠ›ï¼Œå®ç°å®Œæ•´çš„æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

---

## äºŒã€DOMç»“æ„å¯¹æ¯”

### selection-popup (å·²å®ç°)
```html
<div class="selection-popup">
  <div class="colors">...</div>           <!-- é¢œè‰²é€‰æ‹©å™¨ -->
  <div class="tool-toggle">...</div>      <!-- é«˜äº®/ä¸‹åˆ’çº¿åˆ‡æ¢ -->
  <div class="custom-sections">           <!-- âœ… æ³¨å…¥ç‚¹ (via injectSharingButtons) -->
    <div id="researchopia-sharing-buttons">
      <button id="researchopia-share-public">...</button>
      <button id="researchopia-share-anonymous">...</button>
      <button id="researchopia-share-private">...</button>
      <button id="researchopia-share-unshare">...</button>
    </div>
  </div>
</div>
```

### annotation-popup (å¾…å®ç°)
```html
<div class="annotation-popup">
  <div class="preview">
    <header>...</header>                  <!-- é¡µç ã€æ›´å¤šèœå• -->
    <div class="comment">...</div>        <!-- è¯„è®ºç¼–è¾‘å™¨ -->
    <button class="tags">Add tagsâ€¦</button>
    <!-- âŒ æ³¨å…¥ç‚¹: åœ¨ .preview åº•éƒ¨æ·»åŠ æŒ‰é’®å®¹å™¨ -->
  </div>
</div>
```

**å…³é”®å·®å¼‚**:
- `selection-popup` æœ‰ `.custom-sections` å®¹å™¨ â†’ å¯ç›´æ¥æ’å…¥
- `annotation-popup` æ— é¢„ç•™å®¹å™¨ â†’ éœ€åœ¨ `.preview` æœ«å°¾æ‰‹åŠ¨åˆ›å»º

---

## ä¸‰ã€äº‹ä»¶ä¸æ—¶æœº

### selection-popup (å·²å®ç°)
```typescript
// ç›‘å¬: renderTextSelectionPopup
Zotero.Reader.registerEventListener('renderTextSelectionPopup', (event) => {
  this.injectSharingButtons(event);
});

// é€»è¾‘: è®¾ç½®pendingMode â†’ ç­‰å¾…æ ‡æ³¨åˆ›å»º â†’ Notifierè§¦å‘è‡ªåŠ¨å…±äº«
button.click â†’ setPendingShareMode(mode) â†’ [æ ‡æ³¨åˆ›å»º] â†’ handleAnnotationCreated()
```

### annotation-popup (å¾…å®ç°)
```typescript
// ç›‘å¬: renderAnnotationPopup
Zotero.Reader.registerEventListener('renderAnnotationPopup', (event) => {
  this.injectAnnotationPopupButtons(event);
});

// é€»è¾‘: ç›´æ¥æ›´æ–°å·²æœ‰æ ‡æ³¨ (æ— éœ€Notifier)
button.click â†’ updateAnnotationImmediately(annotation, mode)
```

**æ ¸å¿ƒåŒºåˆ«**:
| ç‰¹æ€§ | selection-popup | annotation-popup |
|------|-----------------|------------------|
| **æ ‡æ³¨çŠ¶æ€** | å°šæœªåˆ›å»º | å·²å­˜åœ¨ |
| **æ“ä½œæµç¨‹** | å…ˆè®¾æ¨¡å¼ â†’ åˆ›å»ºååº”ç”¨ | ç‚¹å‡»å³æ›´æ–° |
| **éœ€è¦Notifier** | âœ… æ˜¯ | âŒ å¦ |
| **sessionå…³è”** | åœ¨handleAnnotationCreated | åœ¨updateAnnotationImmediately |

---

## å››ã€å®ç°æ–¹æ¡ˆ

### 4.1 ä»£ç ç»“æ„ (æ‰©å±•annotationSharingPopup.ts)

```typescript
class AnnotationSharingPopup {
  initialize(): void {
    // ç°æœ‰: selection-popupç›‘å¬
    Zotero.Reader.registerEventListener('renderTextSelectionPopup', ...);
    
    // æ–°å¢: annotation-popupç›‘å¬
    Zotero.Reader.registerEventListener('renderAnnotationPopup', (event) => {
      this.injectAnnotationPopupButtons(event);
    });
  }

  // âœ… å¤ç”¨: ç°æœ‰æŒ‰é’®é…ç½® (Lines 58-91)
  private shareModes: ShareModeButton[] = [...];

  // âœ… å¤ç”¨: ç°æœ‰æŒ‰é’®åˆ›å»ºé€»è¾‘ (æå–ä¸ºç‹¬ç«‹æ–¹æ³•)
  private createShareButton(mode: ShareModeButton, onClick: () => void): HTMLButtonElement;

  // ğŸ†• æ–°å¢: æ³¨å…¥annotation-popupæŒ‰é’®
  private injectAnnotationPopupButtons(event: any): void {
    const reader = event.reader;
    const doc = reader._iframeWindow?.document;
    const popup = doc?.querySelector('.annotation-popup .preview');
    
    // é˜²æ­¢é‡å¤æ³¨å…¥
    if (popup?.querySelector('#researchopia-annotation-popup-buttons')) return;
    
    // åˆ›å»ºæŒ‰é’®å®¹å™¨ (æ ·å¼ä¸selection-popupä¸€è‡´)
    const container = doc.createElement('div');
    container.id = 'researchopia-annotation-popup-buttons';
    container.style.cssText = `
      display: flex; gap: 6px; padding: 6px 0;
      border-top: 1px solid #e0e0e0; margin-top: 6px;
    `;
    
    // æ·»åŠ 4ä¸ªæŒ‰é’®
    this.shareModes.forEach(mode => {
      const button = this.createShareButton(mode, async () => {
        await this.updateAnnotationImmediately(event.annotation, mode.id);
      });
      container.appendChild(button);
    });
    
    popup.appendChild(container);
  }

  // ğŸ†• æ–°å¢: å³æ—¶æ›´æ–°æ ‡æ³¨å…±äº«çŠ¶æ€
  private async updateAnnotationImmediately(
    annotationItem: any, 
    shareMode: ShareMode
  ): Promise<void> {
    // Step 1: è·å–å½“å‰æ ‡æ³¨ä¿¡æ¯
    const itemID = annotationItem.id;
    const item = Zotero.Items.get(itemID);
    
    // Step 2: è·å–æ–‡æ¡£ä¿¡æ¯ (å¤ç”¨ç°æœ‰é€»è¾‘)
    const pdfAttachment = item.parentItem;
    const paperItem = pdfAttachment.parentItem;
    const doi = paperItem.getField('DOI');
    
    // Step 3: è·å–ç”¨æˆ·ä¿¡æ¯
    const user = AuthManager.getCurrentUser();
    
    // Step 4: æ„å»ºannotationå¯¹è±¡ (å¤ç”¨AnnotationManageræ ¼å¼)
    const annotation = {
      key: item.key,
      color: item.annotationColor,
      comment: item.annotationComment || '',
      sortIndex: item.annotationSortIndex,
      text: item.annotationText || '',
      // ... å…¶ä»–å­—æ®µ
    };
    
    // Step 5: è°ƒç”¨å…±äº«æ›´æ–°API
    const visibilityValue = shareMode === null ? null : 
                           shareMode === 'private' ? 'private' : 'public';
    const showAuthorName = shareMode === 'public';
    
    const updatedAnnotation = await AnnotationManager.updateAnnotationSharing(
      annotation,
      doi,
      user.email,
      visibilityValue,
      showAuthorName
    );
    
    // Step 6: Sessionå…³è” (ä¸selection-popupé€»è¾‘ä¸€è‡´)
    if (visibilityValue === 'public' && updatedAnnotation.supabaseId) {
      const sessionManager = ReadingSessionManager.getInstance();
      const session = sessionManager.getCurrentSession();
      if (session) {
        await apiClient.post('/api/proxy/annotations/share-to-session', {
          annotation_id: updatedAnnotation.supabaseId,
          session_id: session.id
        });
      }
    }
    
    // Step 7: è§†è§‰åé¦ˆ
    this.showUpdateFeedback(shareMode);
    
    // Step 8: åˆ·æ–°è§†å›¾ (å¦‚æœåœ¨ç®¡ç†æ ‡æ³¨æ¨¡å¼)
    const uiManager = UIManager.getInstance();
    if (uiManager.currentViewMode === 'annotations-manage') {
      await uiManager.sessionAnnotationsView.render(...);
    }
  }
}
```

### 4.2 æŒ‰é’®æ ·å¼ (å¤ç”¨selection-popup CSS)

```typescript
// å¤ç”¨ç°æœ‰æ ·å¼ç”Ÿæˆé€»è¾‘ (Lines 163-178)
const buttonStyle = `
  flex: 1;
  display: flex; align-items: center; justify-content: center;
  gap: 4px; padding: 6px 8px;
  border: 1px solid #ccc; border-radius: 4px;
  background: ${mode.id === null ? 'rgba(244, 67, 54, 0.125)' : '#fff'};
  color: ${mode.id === null ? '#F44336' : '#333'};
  font-size: 11px; font-weight: ${mode.id === null ? '600' : '400'};
  cursor: pointer; transition: all 0.2s;
`;
```

---

## äº”ã€ä¸selection-popupçš„å·®å¼‚æ€»ç»“

| ç»´åº¦ | selection-popup | annotation-popup |
|------|-----------------|------------------|
| **æ³¨å…¥ä½ç½®** | `.custom-sections` | `.preview` åº•éƒ¨ |
| **å®¹å™¨ID** | `#researchopia-sharing-buttons` | `#researchopia-annotation-popup-buttons` |
| **æ ‡æ³¨æ¥æº** | `event.annotation` (æœªåˆ›å»º) | `event.annotation` (å·²å­˜åœ¨) |
| **æ›´æ–°æ—¶æœº** | Notifierç›‘å¬åˆ›å»ºååº”ç”¨ | ç‚¹å‡»æŒ‰é’®å³æ—¶æ›´æ–° |
| **APIè°ƒç”¨** | handleAnnotationCreated â†’ updateAnnotationSharing | updateAnnotationImmediately â†’ updateAnnotationSharing |
| **ç”¨æˆ·ä½“éªŒ** | å…ˆé€‰æ¨¡å¼ â†’ åˆ›å»ºæ ‡æ³¨ â†’ è‡ªåŠ¨å…±äº« | ç‚¹å‡»æ ‡æ³¨ â†’ ä¿®æ”¹æ¨¡å¼ â†’ å³æ—¶ç”Ÿæ•ˆ |

---

## å…­ã€æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯
1. **å…¬å¼€å…±äº«**: ç‚¹å‡»"å…¬å¼€"æŒ‰é’® â†’ æ ‡æ³¨åœ¨æ’ä»¶å…±äº«è§†å›¾æ˜¾ç¤ºç”¨æˆ·å â†’ æ·»åŠ åˆ°å½“å‰ä¼šè¯
2. **åŒ¿åå…±äº«**: ç‚¹å‡»"åŒ¿å"æŒ‰é’® â†’ æ ‡æ³¨æ˜¾ç¤º"åŒ¿åç”¨æˆ·" â†’ æ·»åŠ åˆ°å½“å‰ä¼šè¯
3. **ç§å¯†å…±äº«**: ç‚¹å‡»"ç§å¯†"æŒ‰é’® â†’ æ ‡æ³¨ä»…è‡ªå·±å¯è§ (ä¸æ·»åŠ åˆ°ä¼šè¯)
4. **å–æ¶ˆå…±äº«**: ç‚¹å‡»"å–æ¶ˆ"æŒ‰é’® â†’ åˆ é™¤Supabaseè®°å½• â†’ ä»ä¼šè¯ç§»é™¤
5. **æ¨¡å¼åˆ‡æ¢**: å…¬å¼€ â†’ åŒ¿å â†’ ç§å¯† â†’ å–æ¶ˆ (è¿ç»­ç‚¹å‡»éªŒè¯çŠ¶æ€åˆ‡æ¢)
6. **è§†å›¾åˆ·æ–°**: åœ¨ç®¡ç†æ ‡æ³¨æ¨¡å¼ä¸‹ä¿®æ”¹å…±äº«çŠ¶æ€ â†’ åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°

### é¢„æœŸè¾“å‡º
- æŒ‰é’®ç‚¹å‡»æœ‰è§†è§‰åé¦ˆ (èƒŒæ™¯è‰²å˜åŒ–)
- console.logæ˜¾ç¤º: `âœ… Annotation [key] updated to [mode] mode`
- æ’ä»¶é¢æ¿æ ‡æ³¨åˆ—è¡¨å®æ—¶æ›´æ–°
- ä¼šè¯é¡µé¢æ ‡æ³¨å¡ç‰‡æ•°é‡å˜åŒ–

---

## ä¸ƒã€å®ç°ä¼˜å…ˆçº§

**P0 - æ ¸å¿ƒåŠŸèƒ½** (å½“å‰è¿­ä»£):
- [ ] ç›‘å¬ `renderAnnotationPopup` äº‹ä»¶
- [ ] æ³¨å…¥4ä¸ªæŒ‰é’®åˆ° `.preview` åº•éƒ¨
- [ ] å®ç° `updateAnnotationImmediately()` æ–¹æ³•
- [ ] æ·»åŠ sessionå…³è”é€»è¾‘

**P1 - ç”¨æˆ·ä½“éªŒ** (åç»­ä¼˜åŒ–):
- [ ] æŒ‰é’®æ˜¾ç¤ºå½“å‰æ ‡æ³¨çš„å…±äº«çŠ¶æ€ (é«˜äº®æ´»åŠ¨æŒ‰é’®)
- [ ] æ‰¹é‡ä¿®æ”¹å…±äº«çŠ¶æ€ (å¤šé€‰æ ‡æ³¨)
- [ ] å¿«æ·é”®æ”¯æŒ (Ctrl+1/2/3/4)

**P2 - é”™è¯¯å¤„ç†**:
- [ ] ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºæç¤º
- [ ] DOIç¼ºå¤±æ—¶çš„é™çº§æ–¹æ¡ˆ
- [ ] æƒé™ä¸è¶³æ—¶çš„é”™è¯¯æç¤º

---

## å…«ã€ä»£ç å¤ç”¨æ¸…å•

**å®Œå…¨å¤ç”¨** (æ— éœ€ä¿®æ”¹):
- âœ… `shareModes` æŒ‰é’®é…ç½®æ•°ç»„ (Lines 58-91)
- âœ… `getPendingShareMode()` / `setPendingShareMode()` (Lines 227-240)
- âœ… DOIè·å–é€»è¾‘ (Lines 360-389)
- âœ… AuthManagerç”¨æˆ·è·å– (Line 407)
- âœ… sessionå…³è”APIè°ƒç”¨ (Lines 452-469)

**éœ€è¦æå–** (é¿å…é‡å¤):
- âš ï¸ æŒ‰é’®åˆ›å»ºé€»è¾‘ (Lines 163-178) â†’ æå–ä¸º `createShareButton(mode, onClick)`
- âš ï¸ è§†è§‰åé¦ˆé€»è¾‘ (Lines 179-195) â†’ æå–ä¸º `showButtonFeedback(button)`

**éœ€è¦æ–°å¢**:
- ğŸ†• `injectAnnotationPopupButtons(event)` - æ³¨å…¥æŒ‰é’®åˆ°annotation-popup
- ğŸ†• `updateAnnotationImmediately(annotation, mode)` - å³æ—¶æ›´æ–°æ ‡æ³¨çŠ¶æ€

---

## ä¹ã€å‚è€ƒæ–‡æ¡£

- **å‰ç½®è®¾è®¡**: [1.4.3 4çº§å…±äº«æ¨¡å¼è®¾è®¡](./1.4.3-FOUR_TIER_SHARING_MODE_DESIGN.md)
- **ä»£ç å®ç°**: `zotero-plugin/src/modules/annotationSharingPopup.ts` (515 lines)
- **ç›¸å…³æ¨¡å—**: `AnnotationManager`, `ReadingSessionManager`, `UIManager`

---

**åˆ›å»ºæ—¶é—´**: 2025-01-19  
**ç‰ˆæœ¬**: v0.1  
**çŠ¶æ€**: å¾…å®ç° (è®¾è®¡è¯„å®¡ä¸­)
