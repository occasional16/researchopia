# 10.6 ç½‘é¡µæ”¶è—å¤¹ä¸å…³è”é“¾æ¥ç³»ç»Ÿè®¾è®¡

**ç®€åŒ–çŸ¥è¯†ç½‘ï¼Œèšç„¦å®ç”¨åŠŸèƒ½**

---

## ä¸€ã€è®¾è®¡èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é—®é¢˜åˆ†æ

åŸçŸ¥è¯†ç½‘è®¾è®¡ï¼ˆ10.2ç‰ˆæœ¬ï¼‰è¿‡äºå¤æ‚ï¼ŒåŒ…å«ï¼š
- å¤šé‡æ ‡è¯†ç³»ç»Ÿï¼ˆURLã€canonicalã€content_hashã€DOIã€ISBNï¼‰
- å¤æ‚çš„ç±»å‹åŒ–è¯æ®è¾¹
- ä½œå“æ—å½’å¹¶
- å¤šå±‚é‡‡é›†/è§£æ/å­˜å‚¨æ¶æ„

å®é™…ç”¨æˆ·éœ€æ±‚æ›´ç®€å•ï¼š**æ”¶è— â†’ æ•´ç† â†’ å…³è” â†’ å‘ç°**

### 1.2 æ–°è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| **ç®€åŒ–æ•°æ®æ¨¡å‹** | ç§»é™¤å¤æ‚çš„ knowledge_units/links ä½“ç³»ï¼ŒåŸºäºå·²æœ‰ webpages è¡¨æ‰©å±• |
| **ç±» Edge æ”¶è—å¤¹** | æ”¯æŒåµŒå¥—æ–‡ä»¶å¤¹ã€æ‹–æ‹½æ’åºã€å¤šå¤„å¼•ç”¨åŒä¸€ç½‘é¡µ |
| **å…³è”é“¾æ¥åŠŸèƒ½** | å°†åŸ knowledge/[id] é¡µé¢çš„ Related Links åŠŸèƒ½è¿ç§»è‡³ webpages/[urlHash] |
| **æ¨¡å—åŒ–è®¾è®¡** | ä¸ºåç»­è®ºæ–‡æ”¶è—å¤¹å¤ç”¨åšå‡†å¤‡ |

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        webpages (å·²å­˜åœ¨)                         â”‚
â”‚  å…¨å±€å”¯ä¸€çš„ç½‘é¡µå®ä½“ï¼Œä½œä¸º"çœŸç›¸æ¥æº"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                              â–²
         â”‚ webpage_id                   â”‚ source/target_webpage_id
         â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  bookmark_items â”‚            â”‚  webpage_links  â”‚
â”‚  (æ”¶è—æ¡ç›®)     â”‚            â”‚  (å…³è”é“¾æ¥)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ folder_id
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bookmark_foldersâ”‚
â”‚  (æ”¶è—å¤¹æ–‡ä»¶å¤¹) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¡¨è¯¦ç»†è®¾è®¡

#### 2.2.1 webpages è¡¨ï¼ˆå·²å­˜åœ¨ï¼Œä¿æŒä¸å˜ï¼‰

```sql
-- å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹
CREATE TABLE webpages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL UNIQUE,
  url_hash TEXT NOT NULL UNIQUE,      -- SHA256(url) çš„å‰16ä½
  title TEXT,
  description TEXT,
  favicon_url TEXT,
  og_image_url TEXT,
  metadata JSONB,                      -- æ‰©å±•å…ƒæ•°æ®
  first_submitted_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

#### 2.2.2 bookmark_folders è¡¨ï¼ˆæ–°å»ºï¼‰

```sql
CREATE TABLE bookmark_folders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES bookmark_folders(id) ON DELETE CASCADE,  -- åµŒå¥—æ”¯æŒ
  name TEXT NOT NULL,
  icon TEXT,                           -- å¯é€‰å›¾æ ‡ï¼ˆemojiæˆ–å›¾æ ‡åï¼‰
  position INTEGER DEFAULT 0,          -- åŒçº§æ’åº
  visibility TEXT NOT NULL DEFAULT 'private'
    CHECK (visibility IN ('private', 'public', 'shared')),
  share_code TEXT UNIQUE,              -- åˆ†äº«ç ï¼ˆä»… shared æ¨¡å¼ï¼‰
  description TEXT,                    -- æ–‡ä»¶å¤¹æè¿°
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- çº¦æŸï¼šåŒä¸€ç”¨æˆ·åŒä¸€çˆ¶çº§ä¸‹åç§°å”¯ä¸€
  UNIQUE(user_id, parent_id, name)
);

-- ç´¢å¼•
CREATE INDEX idx_bookmark_folders_user_id ON bookmark_folders(user_id);
CREATE INDEX idx_bookmark_folders_parent_id ON bookmark_folders(parent_id);
CREATE INDEX idx_bookmark_folders_share_code ON bookmark_folders(share_code) WHERE share_code IS NOT NULL;

-- RLS ç­–ç•¥
ALTER TABLE bookmark_folders ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æ–‡ä»¶å¤¹ + å…¬å¼€/åˆ†äº«çš„æ–‡ä»¶å¤¹
CREATE POLICY "Users can view own and public folders" ON bookmark_folders
  FOR SELECT USING (
    user_id = auth.uid() 
    OR visibility = 'public'
    OR (visibility = 'shared' AND share_code IS NOT NULL)
  );

-- ç”¨æˆ·åªèƒ½å¢åˆ æ”¹è‡ªå·±çš„æ–‡ä»¶å¤¹
CREATE POLICY "Users can manage own folders" ON bookmark_folders
  FOR ALL USING (user_id = auth.uid());
```

#### 2.2.3 bookmark_items è¡¨ï¼ˆæ–°å»ºï¼‰

```sql
CREATE TABLE bookmark_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  webpage_id UUID NOT NULL REFERENCES webpages(id) ON DELETE CASCADE,
  folder_id UUID REFERENCES bookmark_folders(id) ON DELETE CASCADE,  -- NULL = æ ¹ç›®å½•
  custom_title TEXT,                   -- å¯é€‰è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆè¦†ç›–ç½‘é¡µåŸæ ‡é¢˜ï¼‰
  note TEXT,                           -- ç”¨æˆ·å¤‡æ³¨
  position INTEGER DEFAULT 0,          -- åŒçº§æ’åº
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- å…è®¸åŒä¸€ç½‘é¡µåœ¨ä¸åŒæ–‡ä»¶å¤¹å‡ºç°ï¼Œä½†åŒä¸€æ–‡ä»¶å¤¹å†…å”¯ä¸€
  UNIQUE(user_id, webpage_id, folder_id)
);

-- ç´¢å¼•
CREATE INDEX idx_bookmark_items_user_id ON bookmark_items(user_id);
CREATE INDEX idx_bookmark_items_folder_id ON bookmark_items(folder_id);
CREATE INDEX idx_bookmark_items_webpage_id ON bookmark_items(webpage_id);

-- RLS ç­–ç•¥
ALTER TABLE bookmark_items ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æ”¶è— + å…¬å¼€æ–‡ä»¶å¤¹å†…çš„æ”¶è—
CREATE POLICY "Users can view own and public bookmarks" ON bookmark_items
  FOR SELECT USING (
    user_id = auth.uid() 
    OR folder_id IN (
      SELECT id FROM bookmark_folders 
      WHERE visibility IN ('public', 'shared')
    )
  );

-- ç”¨æˆ·åªèƒ½å¢åˆ æ”¹è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can manage own bookmarks" ON bookmark_items
  FOR ALL USING (user_id = auth.uid());
```

#### 2.2.4 webpage_links è¡¨ï¼ˆæ–°å»ºï¼‰

```sql
CREATE TABLE webpage_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_webpage_id UUID NOT NULL REFERENCES webpages(id) ON DELETE CASCADE,
  target_webpage_id UUID NOT NULL REFERENCES webpages(id) ON DELETE CASCADE,
  link_type TEXT NOT NULL DEFAULT 'related'
    CHECK (link_type IN ('related', 'cite', 'respond', 'review', 'derive')),
  note TEXT,                           -- å…³è”è¯´æ˜
  created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- åŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤å»ºç«‹ç›¸åŒçš„å…³è”
  UNIQUE(source_webpage_id, target_webpage_id, created_by),
  
  -- ä¸èƒ½è‡ªå·±å…³è”è‡ªå·±
  CHECK (source_webpage_id != target_webpage_id)
);

-- ç´¢å¼•
CREATE INDEX idx_webpage_links_source ON webpage_links(source_webpage_id);
CREATE INDEX idx_webpage_links_target ON webpage_links(target_webpage_id);
CREATE INDEX idx_webpage_links_created_by ON webpage_links(created_by);

-- RLS ç­–ç•¥
ALTER TABLE webpage_links ENABLE ROW LEVEL SECURITY;

-- æ‰€æœ‰äººå¯ä»¥æŸ¥çœ‹æ‰€æœ‰å…³è”ï¼ˆä½† API å±‚æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºåˆ›å»ºè€…ï¼‰
CREATE POLICY "Anyone can view links" ON webpage_links
  FOR SELECT USING (true);

-- ç”¨æˆ·åªèƒ½å¢åˆ æ”¹è‡ªå·±åˆ›å»ºçš„å…³è”
CREATE POLICY "Users can manage own links" ON webpage_links
  FOR ALL USING (created_by = auth.uid());
```

### 2.3 å¾…åˆ é™¤çš„æ—§è¡¨

> âš ï¸ **æ‰§è¡Œå‰éœ€ç¡®è®¤**ï¼šä»¥ä¸‹è¡¨å°†åœ¨è¿ç§»å®Œæˆååˆ é™¤

| è¡¨å | å½“å‰æ•°æ®é‡ | è¯´æ˜ |
|------|------------|------|
| `knowledge_units` | 4 æ¡ | è¢« webpages å–ä»£ |
| `knowledge_links` | 2 æ¡ | è¢« webpage_links å–ä»£ |
| `tags` | 1 æ¡ | æš‚ä¸å®ç°æ ‡ç­¾åŠŸèƒ½ |
| `unit_tags` | 0 æ¡ | æš‚ä¸å®ç°æ ‡ç­¾åŠŸèƒ½ |
| `kn_collections` | 2 æ¡ | è¢« bookmark_folders å–ä»£ |
| `collection_units` | 0 æ¡ | è¢« bookmark_items å–ä»£ |
| `kn_notes` | 0 æ¡ | æš‚ä¸å®ç°ç¬”è®°åŠŸèƒ½ |

---

## ä¸‰ã€API è®¾è®¡

### 3.1 æ”¶è—å¤¹ API

#### 3.1.1 æ–‡ä»¶å¤¹ç®¡ç†

| æ–¹æ³• | è·¯ç”± | è¯´æ˜ |
|------|------|------|
| GET | `/api/bookmarks/folders` | è·å–ç”¨æˆ·æ‰€æœ‰æ–‡ä»¶å¤¹ï¼ˆæ ‘å½¢ç»“æ„ï¼‰ |
| POST | `/api/bookmarks/folders` | åˆ›å»ºæ–‡ä»¶å¤¹ |
| PUT | `/api/bookmarks/folders/[id]` | æ›´æ–°æ–‡ä»¶å¤¹ï¼ˆåç§°ã€ä½ç½®ã€å¯è§æ€§ï¼‰ |
| DELETE | `/api/bookmarks/folders/[id]` | åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆçº§è”åˆ é™¤å­æ–‡ä»¶å¤¹å’Œæ¡ç›®ï¼‰ |
| POST | `/api/bookmarks/folders/[id]/share` | ç”Ÿæˆ/åˆ·æ–°åˆ†äº«ç  |

#### 3.1.2 æ”¶è—æ¡ç›®ç®¡ç†

| æ–¹æ³• | è·¯ç”± | è¯´æ˜ |
|------|------|------|
| GET | `/api/bookmarks/items` | è·å–æ”¶è—æ¡ç›®ï¼ˆæ”¯æŒæŒ‰æ–‡ä»¶å¤¹ç­›é€‰ï¼‰ |
| POST | `/api/bookmarks/items` | æ·»åŠ æ”¶è—ï¼ˆè‡ªåŠ¨åˆ›å»º webpage å¦‚ä¸å­˜åœ¨ï¼‰ |
| PUT | `/api/bookmarks/items/[id]` | æ›´æ–°æ¡ç›®ï¼ˆç§»åŠ¨æ–‡ä»¶å¤¹ã€è‡ªå®šä¹‰æ ‡é¢˜ï¼‰ |
| DELETE | `/api/bookmarks/items/[id]` | åˆ é™¤æ”¶è—æ¡ç›® |
| POST | `/api/bookmarks/items/batch-move` | æ‰¹é‡ç§»åŠ¨æ¡ç›® |

#### 3.1.3 åˆ†äº«è®¿é—®

| æ–¹æ³• | è·¯ç”± | è¯´æ˜ |
|------|------|------|
| GET | `/api/bookmarks/shared/[shareCode]` | é€šè¿‡åˆ†äº«ç è®¿é—®æ–‡ä»¶å¤¹ |

### 3.2 å…³è”é“¾æ¥ API

| æ–¹æ³• | è·¯ç”± | è¯´æ˜ |
|------|------|------|
| GET | `/api/webpages/[urlHash]/links` | è·å–ç½‘é¡µçš„å…³è”é“¾æ¥ |
| POST | `/api/webpages/[urlHash]/links` | åˆ›å»ºå…³è”é“¾æ¥ |
| DELETE | `/api/webpages/[urlHash]/links/[id]` | åˆ é™¤å…³è”é“¾æ¥ï¼ˆä»…åˆ›å»ºè€…å¯åˆ ï¼‰ |

**GET å‚æ•°**:
- `scope`: `mine` (æˆ‘çš„å…³è”) | `all` (æ‰€æœ‰å…³è”ï¼Œé»˜è®¤)
- `direction`: `outgoing` (ä»æœ¬ç½‘é¡µå‡ºå‘) | `incoming` (æŒ‡å‘æœ¬ç½‘é¡µ) | `both` (é»˜è®¤)

---

## å››ã€é¡µé¢è®¾è®¡

### 4.1 æ”¶è—å¤¹é¡µé¢ `/bookmarks`

**å–ä»£åŸ `/knowledge` é¡µé¢**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”– æˆ‘çš„æ”¶è—å¤¹                                    [+ æ–°å»ºæ–‡ä»¶å¤¹] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” æœç´¢æ”¶è—...                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“ å·¥ä½œç›¸å…³                           ğŸ”’ ç§å¯†  [â‹®]             â”‚
â”‚     â”œâ”€â”€ ğŸ“ AI å·¥å…·                     ğŸ”’ ç§å¯†  [â‹®]             â”‚
â”‚     â”‚     â”œâ”€â”€ ğŸŒ ChatGPT               [â‹®]                      â”‚
â”‚     â”‚     â””â”€â”€ ğŸŒ Claude                [â‹®]                      â”‚
â”‚     â””â”€â”€ ğŸ“ è®¾è®¡èµ„æº                    ğŸŒ å…¬å¼€  [â‹®]             â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“ å­¦ä¹ ç¬”è®°                           ğŸ”— åˆ†äº«  [â‹®]             â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœªåˆ†ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  ğŸŒ Hacker News                        [â‹®]                      â”‚
â”‚  ğŸŒ GitHub Trending                    [â‹®]                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½è¦ç‚¹**:
- å·¦ä¾§æ ‘å½¢æ–‡ä»¶å¤¹ç»“æ„ï¼Œæ”¯æŒå±•å¼€/æ”¶èµ·
- æ‹–æ‹½æ’åºï¼ˆæ–‡ä»¶å¤¹å’Œæ¡ç›®ï¼‰
- å³é”®èœå•ï¼šé‡å‘½åã€ç§»åŠ¨ã€åˆ é™¤ã€è®¾ç½®å¯è§æ€§
- æ‰¹é‡æ“ä½œï¼šå¤šé€‰åç§»åŠ¨/åˆ é™¤

### 4.2 ç½‘é¡µè¯¦æƒ…é¡µ `/webpages/[urlHash]`

**æ–°å¢"å…³è”ç½‘é¡µ"åŒºå—**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ ç½‘é¡µæ ‡é¢˜                                                     â”‚
â”‚  ğŸ”— https://example.com/article                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â­ è¯„åˆ†åŒºåŸŸ (å·²æœ‰)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ è¯„è®ºåŒºåŸŸ (å·²æœ‰)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”— å…³è”ç½‘é¡µ                              [æˆ‘çš„å…³è” | æ‰€æœ‰å…³è”]  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  + æ·»åŠ å…³è”ç½‘é¡µ                                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ğŸ“¤ ä»æœ¬é¡µå‡ºå‘çš„å…³è” (3)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ğŸ·ï¸ å¼•ç”¨  â†’  ã€Šæ·±åº¦å­¦ä¹ å…¥é—¨ã€‹        [åˆ é™¤]            â”‚  â”‚
â”‚  â”‚  â”‚        "æœ¬æ–‡å¼•ç”¨äº†è¯¥æ•™ç¨‹çš„ä»£ç ç¤ºä¾‹"                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ğŸ·ï¸ ç›¸å…³  â†’  ã€Šç¥ç»ç½‘ç»œå¯è§†åŒ–ã€‹      [åˆ é™¤]            â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ğŸ·ï¸ å›åº”  â†’  ã€Šå¯¹XXè§‚ç‚¹çš„åé©³ã€‹      [åˆ é™¤]            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  ğŸ“¥ æŒ‡å‘æœ¬é¡µçš„å…³è” (2)                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ğŸ·ï¸ è¯„è¿°  â†  ã€ŠXXæŠ€æœ¯å‘¨æŠ¥ã€‹                            â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ğŸ·ï¸ å¼•ç”¨  â†  ã€Šæœºå™¨å­¦ä¹ å®æˆ˜ã€‹                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½è¦ç‚¹**:
- Tab åˆ‡æ¢"æˆ‘çš„å…³è”"/"æ‰€æœ‰å…³è”"
- å…³è”ç±»å‹ï¼šç›¸å…³ã€å¼•ç”¨ã€å›åº”ã€è¯„è¿°ã€è¡ç”Ÿ
- æ·»åŠ å…³è”æ—¶å¯æœç´¢å·²æ”¶è—çš„ç½‘é¡µæˆ–è¾“å…¥æ–° URL
- åˆ é™¤æŒ‰é’®ä»…åœ¨"æˆ‘çš„å…³è”"è§†å›¾ä¸‹æ˜¾ç¤º
- "æ‰€æœ‰å…³è”"è§†å›¾ä¸æ˜¾ç¤ºåˆ›å»ºè€…ä¿¡æ¯

### 4.3 å¾…åˆ é™¤çš„é¡µé¢

| é¡µé¢è·¯å¾„ | è¯´æ˜ | åˆ é™¤æ—¶æœº |
|----------|------|----------|
| `/knowledge` | åŸçŸ¥è¯†æµé¡µé¢ | Phase 1 å®Œæˆå |
| `/knowledge/[id]` | åŸçŸ¥è¯†å•å…ƒè¯¦æƒ…é¡µ | Phase 1 å®Œæˆå |
| `/tags` | åŸæ ‡ç­¾ç®¡ç†é¡µé¢ | Phase 1 å®Œæˆå |
| `/collections` | åŸé›†åˆç®¡ç†é¡µé¢ | Phase 1 å®Œæˆå |

---

## äº”ã€ç»„ä»¶è®¾è®¡

### 5.1 å¯å¤ç”¨ç»„ä»¶

ä¸ºåç»­è®ºæ–‡æ”¶è—å¤¹å¤ç”¨ï¼ŒæŠ½å–é€šç”¨ç»„ä»¶ï¼š

```
src/components/bookmarks/
â”œâ”€â”€ FolderTree.tsx           # æ–‡ä»¶å¤¹æ ‘å½¢ç»“æ„ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ FolderContextMenu.tsx    # æ–‡ä»¶å¤¹å³é”®èœå•
â”œâ”€â”€ BookmarkItem.tsx         # æ”¶è—æ¡ç›®å¡ç‰‡
â”œâ”€â”€ BookmarkList.tsx         # æ¡ç›®åˆ—è¡¨
â”œâ”€â”€ AddBookmarkModal.tsx     # æ·»åŠ æ”¶è—å¼¹çª—
â”œâ”€â”€ MoveItemModal.tsx        # ç§»åŠ¨æ¡ç›®å¼¹çª—
â”œâ”€â”€ ShareFolderModal.tsx     # åˆ†äº«è®¾ç½®å¼¹çª—
â””â”€â”€ hooks/
    â”œâ”€â”€ useBookmarkFolders.ts
    â””â”€â”€ useBookmarkItems.ts

src/components/links/
â”œâ”€â”€ RelatedLinksSection.tsx  # å…³è”é“¾æ¥åŒºå—ï¼ˆåµŒå…¥è¯¦æƒ…é¡µï¼‰
â”œâ”€â”€ AddLinkModal.tsx         # æ·»åŠ å…³è”å¼¹çª—
â”œâ”€â”€ LinkCard.tsx             # å…³è”å¡ç‰‡
â””â”€â”€ hooks/
    â””â”€â”€ useWebpageLinks.ts
```

### 5.2 ç±»å‹å®šä¹‰

```typescript
// src/types/bookmarks.ts

export interface BookmarkFolder {
  id: string
  user_id: string
  parent_id: string | null
  name: string
  icon?: string
  position: number
  visibility: 'private' | 'public' | 'shared'
  share_code?: string
  description?: string
  created_at: string
  updated_at: string
  // å‰ç«¯æ‰©å±•
  children?: BookmarkFolder[]
  items?: BookmarkItem[]
}

export interface BookmarkItem {
  id: string
  user_id: string
  webpage_id: string
  folder_id: string | null
  custom_title?: string
  note?: string
  position: number
  created_at: string
  // Join data
  webpage?: {
    id: string
    url: string
    url_hash: string
    title: string | null
    favicon_url: string | null
  }
}

export interface WebpageLink {
  id: string
  source_webpage_id: string
  target_webpage_id: string
  link_type: 'related' | 'cite' | 'respond' | 'review' | 'derive'
  note?: string
  created_by: string
  created_at: string
  // Join data (æ ¹æ® direction)
  source_webpage?: {
    url_hash: string
    title: string | null
    favicon_url: string | null
  }
  target_webpage?: {
    url_hash: string
    title: string | null
    favicon_url: string | null
  }
}

export const LINK_TYPE_LABELS: Record<string, string> = {
  related: 'ç›¸å…³',
  cite: 'å¼•ç”¨',
  respond: 'å›åº”',
  review: 'è¯„è¿°',
  derive: 'è¡ç”Ÿ'
}

export const LINK_TYPE_COLORS: Record<string, string> = {
  related: 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
  cite: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
  respond: 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
  review: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300',
  derive: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
}
```

---

## å…­ã€å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ”¶è—å¤¹åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ P0ï¼‰

**ç›®æ ‡**: å®ç°ç±» Edge æ”¶è—å¤¹çš„æ ¸å¿ƒåŠŸèƒ½

| æ­¥éª¤ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 1.1 | åˆ›å»ºæ•°æ®åº“è¡¨ (bookmark_folders, bookmark_items) | 0.5h |
| 1.2 | å®ç° API è·¯ç”± (CRUD) | 2h |
| 1.3 | åˆ›å»º `/bookmarks` é¡µé¢ï¼ˆåŸºç¡€ç‰ˆï¼‰ | 3h |
| 1.4 | é›†æˆæµè§ˆå™¨æ‰©å±•æ”¶è—åŠŸèƒ½ | 2h |
| 1.5 | æµ‹è¯• & ä¿®å¤ | 1h |

**äº¤ä»˜ç‰©**:
- ç”¨æˆ·å¯ä»¥åˆ›å»ºæ–‡ä»¶å¤¹ã€æ·»åŠ ç½‘é¡µæ”¶è—
- æ”¯æŒåµŒå¥—æ–‡ä»¶å¤¹ç»“æ„
- åŸºæœ¬çš„æ’åºå’Œæœç´¢

### Phase 2: å…³è”é“¾æ¥åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ P0ï¼‰

**ç›®æ ‡**: åœ¨ç½‘é¡µè¯¦æƒ…é¡µå®ç°å…³è”é“¾æ¥åŠŸèƒ½

| æ­¥éª¤ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 2.1 | åˆ›å»ºæ•°æ®åº“è¡¨ (webpage_links) | 0.5h |
| 2.2 | å®ç° API è·¯ç”± | 1.5h |
| 2.3 | åˆ›å»º RelatedLinksSection ç»„ä»¶ | 2h |
| 2.4 | é›†æˆåˆ° webpages/[urlHash] é¡µé¢ | 1h |
| 2.5 | æµ‹è¯• & ä¿®å¤ | 1h |

**äº¤ä»˜ç‰©**:
- ç”¨æˆ·å¯ä»¥åœ¨ç½‘é¡µè¯¦æƒ…é¡µæ·»åŠ /æŸ¥çœ‹å…³è”
- æ”¯æŒ"æˆ‘çš„å…³è”"/"æ‰€æœ‰å…³è”"åˆ‡æ¢

### Phase 3: å¢å¼ºåŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ P1ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 3.1 | åˆ†äº«åŠŸèƒ½ï¼ˆshare_code ç”Ÿæˆã€è®¿é—®é¡µé¢ï¼‰ | 2h |
| 3.2 | æ‹–æ‹½æ’åºï¼ˆdnd-kitï¼‰ | 2h |
| 3.3 | æ‰¹é‡æ“ä½œ | 1.5h |
| 3.4 | å³é”®èœå• | 1h |

### Phase 4: æ¸…ç†æ—§ä»£ç ï¼ˆä¼˜å…ˆçº§ P2ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | è¯´æ˜ |
|------|------|------|
| 4.1 | åˆ é™¤æ—§é¡µé¢ | /knowledge, /knowledge/[id], /tags, /collections |
| 4.2 | åˆ é™¤æ—§ API | /api/kn/* |
| 4.3 | åˆ é™¤æ—§æ•°æ®åº“è¡¨ | knowledge_units, knowledge_links, tags ç­‰ï¼ˆéœ€ç¡®è®¤ï¼‰ |
| 4.4 | åˆ é™¤æ—§ç»„ä»¶å’Œç±»å‹ | ç›¸å…³çš„ components/types |

---

## ä¸ƒã€æµè§ˆå™¨æ‰©å±•é›†æˆ

### 7.1 æ”¶è—å½“å‰é¡µé¢

```typescript
// extension/src/background.ts
async function bookmarkCurrentPage(url: string, title: string, folderId?: string) {
  const response = await fetch(`${API_BASE}/api/bookmarks/items`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    },
    body: JSON.stringify({
      url,
      title,
      folder_id: folderId
    })
  })
  return response.json()
}
```

### 7.2 å¿«é€Ÿæ·»åŠ å…³è”

åœ¨æµè§ˆæ‰©å±•çš„ sidebar ä¸­ï¼Œç”¨æˆ·å¯ä»¥ï¼š
1. æŸ¥çœ‹å½“å‰é¡µé¢çš„å…³è”
2. ä»å·²æ”¶è—çš„ç½‘é¡µä¸­é€‰æ‹©æ·»åŠ å…³è”
3. ç›´æ¥è¾“å…¥ URL æ·»åŠ å…³è”

---

## å…«ã€åç»­æ‰©å±•è§„åˆ’

### 8.1 è®ºæ–‡æ”¶è—å¤¹ï¼ˆåæœŸï¼‰

- å¤ç”¨ bookmark_folders è¡¨ç»“æ„è®¾è®¡
- æ–°å»º `paper_bookmark_items` è¡¨
- ä»¥ DOI ä¸ºå”¯ä¸€æ ‡è¯†
- é›†æˆ Zotero æ’ä»¶åŒæ­¥

### 8.2 è·¨ç±»å‹å…³è”ï¼ˆåæœŸï¼‰

- æ‰©å±• webpage_links æˆ–æ–°å»ºé€šç”¨ `resource_links` è¡¨
- æ”¯æŒ ç½‘é¡µâ†”è®ºæ–‡ å…³è”
- è€ƒè™‘å¼•å…¥ `resource_type` + `resource_id` é€šç”¨æ¨¡å¼

### 8.3 æ™ºèƒ½æ¨èï¼ˆåæœŸï¼‰

- åŸºäºå…³è”å›¾è°±æ¨èç›¸å…³å†…å®¹
- ç­›é€‰é«˜è´¨é‡å…³è”ï¼ˆåŸºäºåˆ›å»ºè€…ä¿¡èª‰ã€ç¡®è®¤æ•°ç­‰ï¼‰

---

## ä¹ã€æ‰§è¡Œæ£€æŸ¥æ¸…å•

### Phase 1 æ£€æŸ¥æ¸…å•

- [x] 1.1 æ•°æ®åº“è¡¨åˆ›å»º
  - [x] åˆ›å»º bookmark_folders è¡¨
  - [x] åˆ›å»º bookmark_items è¡¨
  - [x] è®¾ç½® RLS ç­–ç•¥
  - [x] åˆ›å»ºå¿…è¦ç´¢å¼•

- [x] 1.2 API è·¯ç”±å®ç°
  - [x] GET /api/bookmarks/folders
  - [x] POST /api/bookmarks/folders
  - [x] PUT /api/bookmarks/folders/[id]
  - [x] DELETE /api/bookmarks/folders/[id]
  - [x] GET /api/bookmarks/items
  - [x] POST /api/bookmarks/items
  - [x] PUT /api/bookmarks/items/[id]
  - [x] DELETE /api/bookmarks/items/[id]

- [x] 1.3 é¡µé¢å®ç°
  - [x] åˆ›å»º /bookmarks é¡µé¢
  - [x] å®ç°æ–‡ä»¶å¤¹æ ‘ç»„ä»¶
  - [x] å®ç°æ”¶è—æ¡ç›®åˆ—è¡¨
  - [x] å®ç°æ·»åŠ /ç¼–è¾‘å¼¹çª—

- [ ] 1.4 æµè§ˆå™¨æ‰©å±•é›†æˆ
  - [ ] æ·»åŠ æ”¶è—æŒ‰é’®
  - [ ] é€‰æ‹©æ–‡ä»¶å¤¹åŠŸèƒ½

### Phase 2 æ£€æŸ¥æ¸…å•

- [x] 2.1 æ•°æ®åº“è¡¨åˆ›å»º
  - [x] åˆ›å»º webpage_links è¡¨
  - [x] è®¾ç½® RLS ç­–ç•¥

- [x] 2.2 API è·¯ç”±å®ç°
  - [x] GET /api/webpages/[urlHash]/links
  - [x] POST /api/webpages/[urlHash]/links
  - [x] DELETE /api/webpages/[urlHash]/links/[id]

- [x] 2.3 ç»„ä»¶å®ç°
  - [x] RelatedLinksSection ç»„ä»¶
  - [x] AddLinkModal ç»„ä»¶ï¼ˆé›†æˆåœ¨ RelatedLinksSection å†…ï¼‰
  - [x] LinkCard ç»„ä»¶ï¼ˆé›†æˆåœ¨ RelatedLinksSection å†…ï¼‰

- [x] 2.4 é¡µé¢é›†æˆ
  - [x] åœ¨ webpages/[urlHash] æ·»åŠ å…³è”åŒºå—
  - [x] å®ç° Tab åˆ‡æ¢ï¼ˆæˆ‘çš„/æ‰€æœ‰ï¼‰

### Phase 4 æ£€æŸ¥æ¸…å•

- [x] åˆ é™¤ç¡®è®¤ï¼ˆå·²ä¸ç”¨æˆ·ç¡®è®¤å¹¶æ‰§è¡Œï¼‰
  - [x] ç¡®è®¤ knowledge_units è¡¨å¯åˆ é™¤ âœ… å·²åˆ é™¤
  - [x] ç¡®è®¤ knowledge_links è¡¨å¯åˆ é™¤ âœ… å·²åˆ é™¤
  - [x] ç¡®è®¤å…¶ä»– kn_* è¡¨å¯åˆ é™¤ âœ… å·²åˆ é™¤ (kn_collections, kn_notes)

- [x] ä»£ç æ¸…ç†
  - [x] åˆ é™¤ /knowledge é¡µé¢
  - [x] åˆ é™¤ /knowledge/[id] é¡µé¢
  - [x] åˆ é™¤ /tags é¡µé¢
  - [x] åˆ é™¤ /collections é¡µé¢
  - [x] åˆ é™¤ç›¸å…³ API è·¯ç”± (/api/kn/*)
  - [x] æ›´æ–°å¯¼èˆªæ ï¼ˆæ·»åŠ æ”¶è—å¤¹å…¥å£ï¼‰

---

## åã€æ–‡æ¡£ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v1.0 | 2026-01-16 | åˆç‰ˆï¼Œç®€åŒ–çŸ¥è¯†ç½‘è®¾è®¡ï¼Œèšç„¦æ”¶è—å¤¹å’Œå…³è”é“¾æ¥ |
| v1.1 | 2026-01-16 | Phase 1ã€Phase 2ã€Phase 4 ä»£ç æ¸…ç†å·²å®Œæˆï¼›å¾…å®Œæˆï¼šæµè§ˆå™¨æ‰©å±•é›†æˆã€æ•°æ®åº“è¡¨æ¸…ç† |
| v1.2 | 2025-01-03 | Phase 4 æ•°æ®åº“æ¸…ç†å®Œæˆï¼Œåˆ é™¤ 4 ä¸ªæ—§è¡¨ (kn_collections, kn_notes, knowledge_units, knowledge_links) |

---

**ä½œè€…**: AI Assistant  
**å®¡æ ¸**: å¾…å®š  
**çŠ¶æ€**: Phase 1-4 å·²å®Œæˆï¼Œæµè§ˆå™¨æ‰©å±•é›†æˆéƒ¨åˆ†å®Œæˆï¼ˆå­˜åœ¨è®¤è¯é—®é¢˜å¾…ä¿®å¤ï¼‰
