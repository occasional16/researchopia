# Cloudflare Workers 部署指南

本文档记录了将 Researchopia 从 Vercel 迁移到 Cloudflare Workers 的完整过程和注意事项。

## 背景

- **迁移原因**：Vercel 免费额度超限导致网站暂停
- **迁移时间**：2025-12-23
- **技术方案**：使用 OpenNext 适配器 (`@opennextjs/cloudflare`) 在 Cloudflare Workers 上运行 Next.js

## 技术栈

| 组件 | 版本 |
|------|------|
| Next.js | 15.5.9 |
| @opennextjs/cloudflare | 1.14.7 |
| Wrangler CLI | 4.56.0 |

## 一、配置文件

### 1. wrangler.jsonc

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "researchopia",
  "main": ".open-next/worker.js",
  "compatibility_date": "2024-12-30",
  "compatibility_flags": ["nodejs_compat", "global_fetch_strictly_public"],
  "assets": {
    "directory": ".open-next/assets",
    "binding": "ASSETS"
  },
  "workers_dev": true,
  "observability": {
    "enabled": true
  },
  "services": [
    {
      "binding": "WORKER_SELF_REFERENCE",
      "service": "researchopia"
    }
  ]
}
```

**关键配置说明：**
- `compatibility_date`: 使用最新日期以获得最新功能
- `global_fetch_strictly_public`: OpenNext 要求的标志
- `WORKER_SELF_REFERENCE`: Worker 自引用绑定，用于内部路由

### 2. open-next.config.ts

```typescript
import { defineCloudflareConfig } from "@opennextjs/cloudflare";

export default defineCloudflareConfig({});
```

### 3. package.json scripts

```json
{
  "scripts": {
    "build:worker": "cloudflare",
    "dev:worker": "wrangler dev",
    "deploy:worker": "wrangler deploy"
  }
}
```

## 二、部署流程

### 1. 安装依赖

```bash
npm install @opennextjs/cloudflare wrangler --save-dev
```

### 2. 构建和部署

```bash
# 构建 Worker
npm run build:worker

# 本地测试
npm run dev:worker

# 部署到 Cloudflare
npm run deploy:worker
```

### 3. 验证部署

部署后会得到 Workers.dev URL（如 `researchopia.occasioal16.workers.dev`），可直接访问测试。

## 三、自定义域名配置

### 前提条件

域名需要在 Cloudflare 管理（NS 指向 Cloudflare）

### 步骤 1: 添加域名到 Cloudflare

1. 进入 https://dash.cloudflare.com/add-site
2. 输入域名（如 `researchopia.com`），选择 Free 计划
3. 在域名注册商（如阿里云）修改 NS 为 Cloudflare 提供的 NS
   - 例如：`matteo.ns.cloudflare.com` 和 `audrey.ns.cloudflare.com`
4. 等待 NS 传播（5分钟-48小时）

### 步骤 2: 删除旧的 DNS 记录

如果有指向 Vercel 的 CNAME 记录（如 `cname.vercel-dns.com`），**必须先删除**，否则会出现：
> Error 1014: CNAME Cross-User Banned

### 步骤 3: 配置 Worker 自定义域名

1. 进入 Workers & Pages → researchopia → Settings → Domains & Routes
2. 点击 "Add Custom Domain"
3. 添加 `researchopia.com`
4. 添加 `www.researchopia.com`

Cloudflare 会自动配置 DNS 和 SSL 证书。

## 四、环境变量配置

在 Cloudflare Dashboard → Workers → researchopia → Settings → Variables 中配置：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| NEXT_PUBLIC_SUPABASE_URL | 文本 | Supabase 项目 URL |
| NEXT_PUBLIC_SUPABASE_ANON_KEY | 文本 | Supabase 匿名密钥 |
| SUPABASE_SERVICE_ROLE_KEY | 加密 | Supabase 服务角色密钥 |
| RESEND_API_KEY | 加密 | Resend 邮件 API 密钥 |

## 五、已解决的问题

### 1. resvg.wasm 模块缺失

**问题**：使用 `next/og` (ImageResponse) 生成动态图标时，Worker 启动崩溃

**错误信息**：
```
Could not resolve "resvg" ... causing resvg.wasm to not be found
```

**解决方案**：删除动态图标文件，使用静态 SVG 图标
- 删除：`src/app/icon.tsx`, `src/app/apple-icon.tsx`
- 创建：`src/app/icon.svg`, `src/app/apple-icon.svg`（从 `favicon.svg` 复制）

### 2. Workers.dev 域名无法访问

**问题**：`*.workers.dev` 在中国大陆被 DNS 污染，解析到错误的 IP 地址

**表现**：
- DNS 解析返回 Facebook/Twitter 的 IP 而非 Cloudflare IP
- 连接超时无响应

**解决方案**：
- 使用 VPN 全局代理访问
- 或配置自定义域名（推荐）

### 3. VPN 白名单问题

**问题**：如果 VPN 软件对域名设置了白名单（直连），会导致 workers.dev 无法访问

**解决方案**：确保 `researchopia` 相关域名不在 VPN 白名单中

### 4. CNAME Cross-User Banned (Error 1014)

**问题**：域名在 Cloudflare 但 CNAME 指向另一个 Cloudflare 账号的服务（如 Vercel）

**解决方案**：删除指向其他服务的 CNAME 记录，使用 Worker 自定义域名功能

## 六、监控与日志

### 实时日志（Tail）

```bash
npx wrangler tail researchopia --format pretty
```

### Cloudflare Dashboard

进入 Workers & Pages → researchopia → Logs 查看历史日志

### 性能监控

启用 `observability.enabled: true` 后可在 Dashboard 查看请求指标

## 七、Vercel vs Cloudflare Workers 对比

| 特性 | Vercel | Cloudflare Workers |
|------|--------|-------------------|
| 免费额度 | 100GB 带宽/月 | 100,000 请求/天 |
| 冷启动 | 较慢（约 200ms） | 极快（< 1ms） |
| 边缘节点 | ~20 个 | ~300 个 |
| 自定义域名 | 免费 | 免费 |
| 中国大陆访问 | 需 CDN | 需自定义域名或 VPN |
| 部署速度 | 较慢 | 极快（< 30s） |
| Node.js 支持 | 完整 | 部分（需 OpenNext 适配） |

## 八、回滚方案

如需回滚到 Vercel：

1. 在域名注册商将 NS 改回原来的设置
2. 在 Cloudflare DNS 中删除 Worker 自定义域名
3. 等待 DNS 传播
4. 在 Vercel 重新部署

## 九、注意事项

1. **Workers.dev 子域名**：在 Cloudflare Dashboard → Workers & Pages → Manage account → Subdomain 中设置
2. **构建产物大小**：免费版限制 3MB（gzip 后），付费版 10MB
3. **内存限制**：128MB（免费）/ 512MB（付费）
4. **CPU 时间**：10ms（免费）/ 50ms（付费）

## 参考资源

- [OpenNext Cloudflare 文档](https://opennext.js.org/cloudflare)
- [Cloudflare Workers 文档](https://developers.cloudflare.com/workers/)
- [Wrangler CLI 文档](https://developers.cloudflare.com/workers/wrangler/)
- [Next.js on Cloudflare 指南](https://developers.cloudflare.com/workers/frameworks/framework-guides/nextjs/)

---

**最后更新**：2025-12-23
