# 9.12 Note Editor 滚动位置保持 Bug 修复

## 问题描述

在 Zotero 中对同一个 note 打开两个窗口时，编辑其中一个窗口会导致另一个窗口自动跳转到首行。

## 问题根因分析

### 1. Zotero 的 note-editor 机制

`note-editor` 是 Zotero 的 XUL 自定义元素（`chrome://zotero/content/elements/noteEditor.js`），核心逻辑：

```javascript
// note-editor.js - notify 方法
notify = async (event, type, ids, extraData) => {
    // ...
    if (extraData[id].noteEditorID !== this._editorInstance.instanceID) {
        this.initEditor(state, true);  // ← 问题根源：重新初始化编辑器
    }
};
```

当收到来自**其他编辑器实例**的 `modify` 事件时，会调用 `initEditor()` 重新初始化编辑器，这会**销毁旧 EditorInstance 并创建新的**，导致滚动位置丢失。

### 2. 为什么 Hook EditorInstance.notify 无效

EditorInstance.notify() 只处理文件下载和引用更新，真正触发 initEditor() 的是 note-editor 元素级别的 notify 方法。

## 解决方案

### 方案对比

| 方案 | 描述 | 优缺点 |
|------|------|--------|
| Hook note-editor.notify | Better-notes 的方案，在 bn-workspace 中 hook | 需要自定义元素架构 |
| **Notifier 观察者** | 注册 Zotero.Notifier 监听 modify 事件 | ✅ 无需访问 note-editor 元素 |

### 实现方案：Notifier 观察者 + 滚动位置缓存

1. **注册 Notifier 观察者**：监听 `item.modify` 事件
2. **保存滚动位置**：在 modify 事件触发时，保存所有非 source 编辑器的滚动位置
3. **识别窗口**：使用 top window 作为唯一标识符，避免 iframe 重建导致的 ID 变化
4. **恢复滚动位置**：在新编辑器注册时，匹配窗口 ID 并恢复对应的滚动位置

### 关键实现细节

```typescript
// 1. 窗口标识 - 使用 top window WeakMap
private windowMap = new WeakMap<Window, string>();

private getWindowId(editor: EditorInstance): string | null {
    const topWindow = editor._iframeWindow?.top;
    if (!topWindow) return null;
    
    if (!this.windowMap.has(topWindow)) {
        this.windowMap.set(topWindow, `topwin_${this.nextWindowId++}`);
    }
    return this.windowMap.get(topWindow)!;
}

// 2. 同步隐藏 - 避免闪烁
registerEditor(editor: EditorInstance) {
    const iframe = editor._iframeWindow?.frameElement as HTMLIFrameElement;
    if (iframe) {
        iframe.style.visibility = 'hidden';
        iframe.style.opacity = '0';
    }
    // 异步恢复
    this.hideAndRestoreScroll(editor, savedScrollTop);
}

// 3. 加载指示器 - 改善 UX
private createLoadingIndicator(iframe: HTMLIFrameElement): HTMLElement {
    const indicator = iframe.ownerDocument.createElement('div');
    indicator.innerHTML = `<div class="scroll-restore-spinner"></div>`;
    // ...
}
```

### 性能优化

| 优化项 | 实现 | 效果 |
|--------|------|------|
| 减少轮询间隔 | 30ms → 15ms | 响应更快 |
| 智能结束维护 | 检测滚动稳定后提前结束 | 减少不必要等待 |
| 同步隐藏 | 在 registerEditor 时立即隐藏 | 消除闪烁 |

### 最终效果

- **小 note**: ~300ms 恢复
- **大 note**: ~600ms 恢复
- **无闪烁**：用户看不到首行跳转
- **加载指示器**：恢复过程中显示 spinner

## 参考资料

- Zotero note-editor 源码: https://github.com/zotero/note-editor
- Better-notes 的修复 PR: https://github.com/windingwind/zotero-better-notes/pull/1463
- 实现文件: `zotero-plugin/src/modules/editor/scrollPreserver.ts`
