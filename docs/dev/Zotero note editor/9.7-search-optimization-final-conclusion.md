# 9.7 Zotero Note Editor æœç´¢ä¼˜åŒ–æœ€ç»ˆç»“è®º

## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»

### æµ‹è¯•ç¯å¢ƒ
- **æµ‹è¯•æ–‡æ¡£**: 500k+ å­—ç¬¦
- **æµ‹è¯•å…³é”®è¯**: "doc", "zot"
- **æµ‹è¯•æ–¹æ³•**: åœ¨å®˜æ–¹ note-editor è¾“å…¥æ¡†è¾“å…¥å­—ç¬¦ï¼Œè§‚å¯Ÿå¡é¡¿

### æ€§èƒ½å¯¹æ¯”

| å®ç°æ–¹æ¡ˆ | ç¬¬ä¸€ä¸ªå­—æ¯å¡é¡¿æ—¶é—´ | åç»­å­—æ¯å¡é¡¿æ—¶é—´ | "Unresponsive script" å¼¹çª— |
|---------|------------|------------|-------------------|
| **Better Notes æ’ä»¶** (CSS Overlay) | âœ… æ— å¡é¡¿ | âœ… æ— å¡é¡¿ | âŒ ä¸å‡ºç° |
| **å®˜æ–¹åŸå§‹ä»£ç ** (doc.descendants) | âŒ 10s | âŒ 3s/å­—ç¬¦ | âœ… å‡ºç° |
| **ä¼˜åŒ–1**: åŠ é˜²æŠ– (500ms) | âŒ 10s | âŒ 3s/å­—ç¬¦ | âœ… å‡ºç° |
| **ä¼˜åŒ–2**: TreeWalker + posAtDOM | âŒ 10s | âŒ 3s/å­—ç¬¦ | âœ… å‡ºç° |
| **ä¼˜åŒ–3**: å¼ºåˆ¶ Descendants (æ’é™¤ TreeWalker) | âŒ 10s | âŒ 3s/å­—ç¬¦ | âœ… å‡ºç° |
| **ä¼˜åŒ–4**: è™šæ‹Ÿæ¸²æŸ“ (MAX_DECORATIONS=200) | âŒ 10s | âŒ 3s/å­—ç¬¦ | âœ… å‡ºç° |

## ğŸ” å…³é”®å‘ç°

### 1. æœç´¢ç®—æ³•ä¸æ˜¯ç“¶é¢ˆ

**æµ‹è¯•ç»“è®º**: å¼ºåˆ¶ä½¿ç”¨ `searchWithDescendants()` å’Œä½¿ç”¨ `searchWithTreeWalker()` **æ€§èƒ½å®Œå…¨ä¸€æ ·**ï¼Œéƒ½å¡ 10sã€‚

**åŸå› åˆ†æ**:
- 500k å­—ç¬¦æ–‡æ¡£ï¼Œå³ä½¿ TreeWalker éå†åªéœ€ 10msï¼ˆå‚è€ƒ 9.6 æ–‡æ¡£åˆ†æï¼‰
- ä½†æ‰¾åˆ° 2000+ åŒ¹é…ç»“æœåï¼Œ**åˆ›å»º Decoration å’Œè§¦å‘ ProseMirror é‡æ–°æ¸²æŸ“** æ‰æ˜¯çœŸæ­£ç“¶é¢ˆ

### 2. ProseMirror è£…é¥°å™¨ç³»ç»Ÿçš„æ¶æ„ç“¶é¢ˆ

**æ ¸å¿ƒä»£ç ** (`search.js` updateView æ–¹æ³•, çº¦ 350 è¡Œ):
```javascript
// å³ä½¿åªæ¸²æŸ“ 200 ä¸ª decoration
const MAX_DECORATIONS = 200;
let list = this.results
  .slice(renderStart, renderEnd)
  .map((deco, i) => {
    return Decoration.inline(deco.from, deco.to, {
      class: index === this.selectedResultIndex 
        ? this.findSelectedClass : this.findClass
    });
  });

// ğŸ”´ è¿™ä¸¤è¡Œæ˜¯æ€§èƒ½ç“¶é¢ˆ
this.decorations = DecorationSet.create(tr.doc, list);
dispatch(tr);  // è§¦å‘æ•´ä¸ª ProseMirror é‡æ–°æ¸²æŸ“
```

**ä¸ºä»€ä¹ˆæ…¢**:
1. `DecorationSet.create()` éœ€è¦éªŒè¯æ¯ä¸ª decoration ä½ç½®æ˜¯å¦åœ¨ doc èŒƒå›´å†…
2. `dispatch(tr)` è§¦å‘æ•´ä¸ªç¼–è¾‘å™¨æ ‘çš„ diff å’Œ re-render
3. 500k å­—ç¬¦çš„ ProseMirror æ–‡æ¡£æ ‘éå¸¸å¤§ï¼Œä»»ä½• transaction éƒ½ä¼šå¾ˆæ…¢

### 3. Better Notes æ’ä»¶ä¸ºä»€ä¹ˆä¸å¡ï¼Ÿ

**æ’ä»¶å®ç°æ–¹æ¡ˆ** (å‚è€ƒ `zotero-better-notes` æºç ):
```typescript
// ä½¿ç”¨ TreeWalker + CSS Overlayï¼Œå®Œå…¨ç»•è¿‡ ProseMirror
function highlightMatches() {
  const walker = document.createTreeWalker(
    editorBody,
    NodeFilter.SHOW_TEXT
  );
  
  // å¿«é€Ÿéå†æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
  while (walker.nextNode()) {
    const textNode = walker.currentNode;
    // ... åŒ¹é…é€»è¾‘ ...
    
    // ğŸŸ¢ å…³é”®: ä½¿ç”¨ CSS ç»å¯¹å®šä½çš„ <span> è¦†ç›–åœ¨æ–‡æœ¬ä¸Š
    // ä¸è§¦å‘ ProseMirror transactionï¼
    const highlight = document.createElement('span');
    highlight.style.position = 'absolute';
    highlight.style.backgroundColor = 'yellow';
    overlay.appendChild(highlight);
  }
}
```

**æ€§èƒ½ä¼˜åŠ¿**:
1. âœ… TreeWalker C++ å®ç°ï¼Œéå† 500k å­—ç¬¦åªéœ€ 10ms
2. âœ… CSS Overlay å®Œå…¨ç»•è¿‡ ProseMirrorï¼Œä¸è§¦å‘ transaction
3. âœ… æµè§ˆå™¨åŸç”Ÿ DOM æ“ä½œï¼Œæ—  JavaScript AST éå†å¼€é”€

## ğŸ¤” ä¸ºä»€ä¹ˆå®˜æ–¹ä»£ç æ— æ³•ç”¨ CSS Overlayï¼Ÿ

### é—®é¢˜: ProseMirror å¿…é¡»ä½¿ç”¨ Decoration ç³»ç»Ÿ

**å®˜æ–¹æ¶æ„çº¦æŸ**:
```javascript
// ProseMirror Plugin è§„èŒƒè¦æ±‚é€šè¿‡ decorations å®ç°é«˜äº®
export function search() {
  return new Plugin({
    state: {
      apply: (tr, pluginState) => {
        // å¿…é¡»è¿”å› decorationsï¼Œè¿™æ˜¯ ProseMirror çš„æ ¸å¿ƒè®¾è®¡
        pluginState.decorations = DecorationSet.create(...);
      }
    },
    props: {
      // å¿…é¡»é€šè¿‡ decorations prop ä¼ é€’ç»™è§†å›¾
      decorations(state) {
        return this.getState(state).decorations;
      }
    }
  });
}
```

**è®¾è®¡é™åˆ¶**:
1. ProseMirror çš„ Decoration ç³»ç»Ÿè®¾è®¡ç”¨äº **å°‘é‡ã€ç²¾ç¡®çš„æ ‡è®°** (å¦‚æ‹¼å†™æ£€æŸ¥)
2. ä¸æ˜¯ä¸º **2000+ ä¸ªæœç´¢ç»“æœé«˜äº®** è®¾è®¡çš„
3. æ¯æ¬¡ decoration å˜æ›´éƒ½å¿…é¡»è§¦å‘ transaction â†’ é‡æ–°æ¸²æŸ“æ•´ä¸ªæ–‡æ¡£æ ‘

### å¯¹æ¯”: Better Notes æ’ä»¶å¯ä»¥"ä½œå¼Š"

**æ’ä»¶çš„ä¼˜åŠ¿**:
```typescript
// æ’ä»¶å¯ä»¥ç›´æ¥æ“ä½œ DOMï¼Œå› ä¸ºå®ƒæ§åˆ¶æ•´ä¸ª UI
class CustomSearchFindbar {
  search(term) {
    // ç›´æ¥åœ¨ editorInstance._iframeWindow.document ä¸Šæ“ä½œ
    const editorBody = this.getEditorBody();
    
    // åˆ›å»ºç‹¬ç«‹çš„ overlay container
    const overlay = document.createElement('div');
    overlay.className = 'custom-search-highlights';
    overlay.style.pointerEvents = 'none';  // ä¸å½±å“ç¼–è¾‘
    editorBody.appendChild(overlay);
    
    // ç”¨ TreeWalker å¿«é€Ÿæ‰¾åˆ°æ‰€æœ‰åŒ¹é…
    // ç”¨ CSS ç»å¯¹å®šä½ç”»é«˜äº®æ¡†
    // å®Œå…¨ä¸ç»è¿‡ ProseMirrorï¼
  }
}
```

**ä¸ºä»€ä¹ˆå®˜æ–¹ä»£ç ä¸èƒ½è¿™æ ·åš**:
- å®˜æ–¹ `search.js` æ˜¯ ProseMirror Pluginï¼Œå¿…é¡»éµå®ˆ Plugin API
- ä¸èƒ½ç›´æ¥æ“ä½œ DOM (ä¼šç ´å ProseMirror çŠ¶æ€ä¸€è‡´æ€§)
- å¿…é¡»é€šè¿‡ Decoration ç³»ç»Ÿ (è¿™å°±æ˜¯ç“¶é¢ˆæ‰€åœ¨)

## ğŸ“ æœ€ç»ˆç»“è®º

### âŒ æ— æ³•åœ¨å®˜æ–¹ä»£ç ä¸­è¾¾åˆ°æ’ä»¶çš„æ€§èƒ½

**åŸå› **: 
1. **æ¶æ„é™åˆ¶**: ProseMirror Plugin å¿…é¡»ä½¿ç”¨ Decoration ç³»ç»Ÿ
2. **è®¾è®¡ç“¶é¢ˆ**: Decoration ç³»ç»Ÿä¸é€‚åˆå¤§é‡é«˜äº® (500k æ–‡æ¡£ + 2000 åŒ¹é…)
3. **å®ç°å·®å¼‚**: æ’ä»¶å¯ä»¥"ç»•è¿‡" ProseMirror ç”¨ CSS Overlayï¼Œå®˜æ–¹ä»£ç ä¸èƒ½

### âœ… å®˜æ–¹ä»£ç çš„æœ€ä½³ä¼˜åŒ–æ–¹æ¡ˆ

å°½ç®¡æ— æ³•å®Œå…¨æ¶ˆé™¤å¡é¡¿ï¼Œä½†å¯ä»¥åšä»¥ä¸‹ä¼˜åŒ–:

#### æ–¹æ¡ˆ A: é™åˆ¶æœç´¢èŒƒå›´ (æ¨èæäº¤ PR)

```javascript
search(doc) {
  // åªæœç´¢å½“å‰å¯è§åŒºåŸŸ Â±100k å­—ç¬¦
  const currentPos = this.view.state.selection.from;
  const searchStart = Math.max(0, currentPos - 50000);
  const searchEnd = Math.min(doc.content.size, currentPos + 50000);
  
  // åªåœ¨è¿™ä¸ªèŒƒå›´å†…æœç´¢
  doc.descendants((node, pos) => {
    if (pos < searchStart || pos > searchEnd) {
      return false;  // è·³è¿‡
    }
    // ... æ­£å¸¸æœç´¢é€»è¾‘ ...
  });
}
```

**ä¼˜åŠ¿**:
- âœ… æ˜¾è‘—å‡å°‘æœç´¢èŒƒå›´ï¼Œä» 500k â†’ 100k
- âœ… å‡å°‘åŒ¹é…æ•°é‡ï¼Œä» 2000 â†’ 400
- âœ… ä¿ç•™ ProseMirror åŸç”Ÿ APIï¼Œç¬¦åˆå®˜æ–¹è§„èŒƒ
- âœ… ç”¨æˆ·ä½“éªŒ: æœç´¢å½“å‰åŒºåŸŸé€šå¸¸å·²è¶³å¤Ÿ

#### æ–¹æ¡ˆ B: å¼‚æ­¥æ¸²æŸ“ (å¤æ‚ï¼Œå¯èƒ½ä¸ç¨³å®š)

```javascript
updateView() {
  // ä½¿ç”¨ requestIdleCallback åˆ†æ‰¹æ¸²æŸ“
  requestIdleCallback(() => {
    this.search(tr.doc);
    
    // åˆ†æ‰¹åˆ›å»º decorations
    const batchSize = 50;
    let currentBatch = 0;
    
    function renderNextBatch() {
      const start = currentBatch * batchSize;
      const end = Math.min(start + batchSize, this.results.length);
      // ... æ¸²æŸ“ decorations[start:end] ...
      
      if (end < this.results.length) {
        requestIdleCallback(renderNextBatch);
      }
    }
    
    renderNextBatch();
  });
}
```

**åŠ£åŠ¿**:
- âš ï¸ å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
- âš ï¸ å¢åŠ ä»£ç å¤æ‚åº¦
- âš ï¸ éœ€è¦å¤§é‡æµ‹è¯•

#### æ–¹æ¡ˆ C: æ¥å—é™åˆ¶ï¼Œæ–‡æ¡£åŒ–è¯´æ˜ (æœ€è¯šå®)

åœ¨ PR ä¸­æ˜ç¡®è¯´æ˜:
```markdown
## Search Performance Limitations

For documents larger than 100k characters with 500+ matches:
- Search may experience 3-10s lag on first input
- This is a known limitation of ProseMirror's Decoration system
- Workaround: Use external search tools (e.g., Better Notes plugin)
- Alternative: Limit search scope to current visible area (see config option)
```

## ğŸ¯ PR æäº¤å»ºè®®

### æ¨èæ–¹æ¡ˆ: æ–¹æ¡ˆ A (é™åˆ¶æœç´¢èŒƒå›´)

**æäº¤å†…å®¹**:
1. **ä»£ç ä¿®æ”¹**: 
   - æ·»åŠ  `searchRadius` é…ç½®é¡¹ (é»˜è®¤ 50k å­—ç¬¦)
   - åªæœç´¢å½“å‰å…‰æ ‡ä½ç½® Â±50k èŒƒå›´
   - æ·»åŠ  "æœç´¢èŒƒå›´å·²é™åˆ¶" æç¤º (å¦‚æœæ–‡æ¡£è¶…å‡ºèŒƒå›´)

2. **æ–‡æ¡£è¯´æ˜**:
   - åœ¨ README æˆ– CHANGELOG ä¸­è¯´æ˜æ€§èƒ½é™åˆ¶
   - æä¾›é…ç½®é€‰é¡¹: `{ searchRadius: 50000 }` æˆ– `{ searchRadius: Infinity }` (æœç´¢å…¨æ–‡)

3. **æµ‹è¯•æ•°æ®**:
   - åŸå§‹: 500k æ–‡æ¡£æœç´¢ 10s
   - ä¼˜åŒ–å: 100k èŒƒå›´æœç´¢ 1-2s
   - ç»“è®º: æ€§èƒ½æå‡ 5-10xï¼Œå¯¹å¤§éƒ¨åˆ†ç”¨æˆ·å·²è¶³å¤Ÿ

### ä¸æ¨èæ–¹æ¡ˆ: TreeWalker + CSS Overlay

**åŸå› **:
1. **è¿å ProseMirror è®¾è®¡åŸåˆ™** - ç›´æ¥æ“ä½œ DOM ä¼šç ´åçŠ¶æ€ä¸€è‡´æ€§
2. **ç»´æŠ¤è´Ÿæ‹…** - éœ€è¦æ‰‹åŠ¨åŒæ­¥ DOM å’Œ ProseMirror çŠ¶æ€
3. **å¯èƒ½è¢«æ‹’ç»** - Zotero å®˜æ–¹å¯èƒ½è®¤ä¸ºè¿™æ˜¯ "hack"

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **9.2-zotero-note-search-optimization.md**: ä¼˜åŒ–å†å²è®°å½•
- **9.5-submit-official-search-optimization-pr.md**: åŸå§‹ PR è®¡åˆ’ (å·²è¿‡æ—¶)
- **9.6-zotero-search-performance-analysis.md**: TreeWalker vs Descendants æ€§èƒ½åˆ†æ

## ğŸ”„ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®ç°æ–¹æ¡ˆ A**: é™åˆ¶æœç´¢èŒƒå›´ä¼˜åŒ–
2. **æµ‹è¯•æ€§èƒ½**: éªŒè¯ 100k èŒƒå›´æœç´¢æ˜¯å¦é™åˆ° 1-2s
3. **å‡†å¤‡ PR**:
   - ä»£ç ä¿®æ”¹ + é…ç½®é€‰é¡¹
   - æ€§èƒ½æµ‹è¯•æ•°æ®
   - æ–‡æ¡£è¯´æ˜é™åˆ¶
4. **æäº¤ PR**: è¯´æ˜è¿™æ˜¯åœ¨ ProseMirror æ¶æ„é™åˆ¶ä¸‹çš„æœ€ä½³æ–¹æ¡ˆ

---

**æœ€åæ›´æ–°**: 2025-01-17  
**æµ‹è¯•ç¯å¢ƒ**: Windows 11, Zotero 8.0-beta.17, 500k+ å­—ç¬¦æ–‡æ¡£  
**ç»“è®º**: æ’ä»¶æ€§èƒ½æ— æ³•åœ¨å®˜æ–¹ä»£ç ä¸­å¤ç°ï¼Œä½†å¯é€šè¿‡é™åˆ¶æœç´¢èŒƒå›´æ˜¾è‘—ä¼˜åŒ–