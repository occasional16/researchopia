# 1.4.2 一键共享功能实现策略

## 设计逻辑

### 操作流程

```
1. 选中文本
   ↓
2. 原生弹窗出现
   ├─ 上方: 颜色选择(黄/红/绿...)
   ├─ 下方: 类型选择(高亮/下划线)
   └─ [新增] 顶部: 🔗 共享按钮 (Toggle)
   ↓
3. 用户点击共享按钮 → 状态切换为"待共享"
   ↓
4. 用户点击颜色 → 本地标注创建
   ↓
5. 检测到标注创建 → 自动同步到 Supabase
   ↓
6. Toast提示: "✅ 已共享标注"
```

---

## 核心实现

### 1. 注入共享按钮

**事件监听**: `renderTextSelectionPopup`

```typescript
Zotero.Reader.registerEventListener(
  "renderTextSelectionPopup",
  (event) => {
    const { append, doc } = event;
    
    append(
      ztoolkit.UI.createElement(doc, "button", {
        id: "researchopia-share-toggle",
        classList: ["toolbar-button"],
        properties: {
          innerHTML: `🔗 共享`,
          title: "创建标注后自动共享到Researchopia",
        },
        styles: {
          marginBottom: "8px",  // 与颜色选择器分隔
        },
        listeners: [{
          type: "click",
          listener: (e) => {
            const btn = e.target;
            const isActive = btn.classList.toggle("active");
            
            // 记录待共享状态
            sessionStorage.setItem(
              "pendingShare",
              isActive ? "true" : "false"
            );
            
            // 视觉反馈
            btn.style.background = isActive 
              ? "var(--color-accent)" 
              : "";
            btn.innerHTML = isActive 
              ? "🔗 待共享" 
              : "🔗 共享";
          },
        }],
      })
    );
  },
  "researchopia"
);
```

---

### 2. 监听标注创建

**事件监听**: `add` 类型的 `item` notify

```typescript
export function registerNotify() {
  Zotero.Notifier.registerObserver(
    {
      notify: async (event, type, ids, extraData) => {
        if (event === "add" && type === "item") {
          // 检查是否为标注
          const items = Zotero.Items.get(ids);
          const annotations = items.filter(item => item.isAnnotation());
          
          if (annotations.length === 0) return;
          
          // 检查是否处于待共享状态
          const pendingShare = sessionStorage.getItem("pendingShare");
          if (pendingShare !== "true") return;
          
          // 自动共享最新标注
          const latestAnnotation = annotations[0];
          await shareAnnotationToSupabase(latestAnnotation);
          
          // 清除待共享状态
          sessionStorage.removeItem("pendingShare");
          
          // 提示
          new ztoolkit.ProgressWindow("Researchopia")
            .createLine({ text: "✅ 标注已共享", progress: 100 })
            .show();
        }
      },
    },
    ["item"]
  );
}
```

---

### 3. 共享核心逻辑

```typescript
async function shareAnnotationToSupabase(annotation) {
  const paper = await getPaperByZoteroItem(annotation.parentItemID);
  
  // 构建共享标注数据
  const sharedData = {
    paper_id: paper.id,
    content: annotation.annotationText,
    comment: annotation.annotationComment || "",
    color: annotation.annotationColor,
    page_num: annotation.annotationPageLabel,
    position: {
      rects: annotation.annotationPosition,
      pageIndex: annotation.annotationPageIndex,
    },
    zotero_annotation_key: annotation.key,
  };
  
  // 上传到Supabase
  const { data, error } = await supabase
    .from("shared_annotations")
    .insert(sharedData)
    .select()
    .single();
  
  if (error) throw error;
  
  // 记录映射关系(本地key → 共享ID)
  await storeAnnotationMapping(annotation.key, data.id);
  
  return data;
}
```

---

## UI/UX细节

### 视觉设计

**未激活状态**:
```
┌─────────────────┐
│  🔗 共享        │  ← 灰色背景
└─────────────────┘
```

**激活状态**:
```
┌─────────────────┐
│  🔗 待共享      │  ← 蓝色背景(Accent Color)
└─────────────────┘
```

**Hover提示**:
```
"点击后,创建的标注将自动同步到Researchopia社区"
```

---

### 交互逻辑

#### 场景1: 标准流程
```
选中文本 → 点击"共享"按钮 → 点击颜色 → ✅ 自动共享
```

#### 场景2: 取消共享
```
选中文本 → 点击"共享"按钮 → 再次点击取消 → 点击颜色 → ❌ 不共享
```

#### 场景3: 关闭弹窗
```
选中文本 → 点击"共享"按钮 → 点击空白处关闭弹窗 → 状态清除
```

**清除逻辑**:
```typescript
// 监听弹窗关闭
popup.addEventListener("blur", () => {
  sessionStorage.removeItem("pendingShare");
});
```

---

## 优势分析

| 特性 | 说明 | 用户收益 |
|------|------|----------|
| **预声明** | 先决定是否共享,后创建标注 | 避免误操作 |
| **可撤销** | 点击前可以反悔 | 用户控制感强 |
| **零额外步骤** | 标注创建后自动同步 | 无心智负担 |
| **视觉反馈** | 按钮状态变化明确 | 操作确定性高 |

---

## 边缘场景处理

### 1. 网络错误
```typescript
try {
  await shareAnnotationToSupabase(annotation);
} catch (error) {
  // 显示重试选项
  new ztoolkit.ProgressWindow("共享失败")
    .createLine({
      text: "网络错误,点击重试",
      progress: 0,
      type: "error",
    })
    .show();
  
  // 存储到本地队列
  queueFailedShare(annotation);
}
```

### 2. 论文未在Supabase中
```typescript
// 自动创建论文记录
if (!paper) {
  paper = await createPaperFromZoteroItem(parentItem);
}
```

### 3. 用户未登录
```typescript
if (!isLoggedIn()) {
  showLoginDialog("登录后才能共享标注");
  sessionStorage.removeItem("pendingShare");
  return;
}
```

---

## 性能优化

### 1. 防抖处理
```typescript
// 避免快速点击多次共享
const debouncedShare = debounce(shareAnnotationToSupabase, 300);
```

### 2. 离线队列
```typescript
// 网络故障时存储到IndexedDB
const offlineQueue = [];

// 恢复网络后批量同步
window.addEventListener("online", () => {
  syncOfflineQueue();
});
```

---

## 扩展功能(可选)

### 高级选项

**长按共享按钮** → 弹出菜单:
```
┌─────────────────┐
│ ✅ 公开共享     │ ← 默认
│ 🔒 仅团队可见   │
│ 📋 添加标签...  │
└─────────────────┘
```

---

**参考文档**:
- [1.4 Zotero PDF Translate 弹窗注入机制](./1.4-ZOTERO_PDF_TRANSLATE_POPUP_INJECTION.md)
- [DEVELOPMENT.md - Zotero Notifier](../../DEVELOPMENT.md#zotero-notifier-api)
