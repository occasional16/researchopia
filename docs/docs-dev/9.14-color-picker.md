# 9.14 Rich Color Picker Enhancement

## Background

Zotero note-editor 的 Text Color 和 Highlight Text 功能仅提供 8 种预设颜色。

## Implementation (Completed ✅)

### Approach: Inject System Color Picker

在每个颜色下拉菜单底部添加 "More Colors..." 按钮，点击后调用系统原生颜色选择器。

### Key Code

**文件**: `zotero-plugin/src/modules/noteEditor/enhancements/colorPicker.ts`

```ts
// 获取 editorCore（需要 wrappedJSObject 解包）
const unwrappedWindow = iframeWindow?.wrappedJSObject || iframeWindow;
const editorCore = unwrappedWindow?._currentEditorInstance?._editorCore;

// 应用文字颜色
editorCore.pluginState.textColor.setColor(hexColor);

// 应用高亮颜色（需添加 50% 透明度）
editorCore.pluginState.highlightColor.setColor(hexColor + "80");
```

### Key Learnings

1. **XUL 环境**: Zotero 运行在 XUL/Firefox 环境，需要 `wrappedJSObject` 访问 iframe window 变量
2. **pluginState API**: note-editor 通过 `editorCore.pluginState.textColor.setColor()` 暴露颜色设置方法
3. **透明度**: 高亮颜色需要添加 `80` 后缀表示 50% 透明度

## FAQ

**Q: 为什么颜色选择器显示中文？**  
A: 使用系统原生颜色选择器，语言跟随操作系统设置。

**Q: 如何使用取色器/吸管？**  
A: Windows 颜色对话框中已内置取色器工具。

## Status: ✅ Completed (2025-12-01)
