# 9.4 迁移 CustomSearch 到 Researchopia 插件

**目标**: 将 better-notes 的 CustomSearch 功能迁移到 Researchopia Zotero 插件

**难度**: 6/10（中等偏低）

**预计工作量**: 3-5 小时

---

## 一、准备工作

### 1.1 确认源文件位置

**源目录**: `D:\AI\zotero-better-notes\src\modules\customSearch\`

**核心文件**（必须复制）:
```
findbar.ts       (524 行) - 核心 UI 和搜索逻辑
manager.ts       (86 行)  - 实例管理器
types.ts         (16 行)  - TypeScript 类型定义
```

**可选文件**（暂不需要）:
```
asyncEngine.ts   (68 行)  - 异步搜索引擎（未使用）
searchDialog.ts  (55 行)  - 对话框 UI（未使用）
index.ts         (6 行)   - 模块导出
```

### 1.2 确认目标位置

**目标目录**: `D:\AI\Researchopia\zotero-plugin\src\modules\customSearch\`

---

## 二、迁移步骤

### 2.1 复制文件

```powershell
cd D:\AI\Researchopia\zotero-plugin

# 创建 customSearch 目录
New-Item -ItemType Directory -Path "src\modules\customSearch" -Force

# 复制核心文件
Copy-Item "D:\AI\zotero-better-notes\src\modules\customSearch\findbar.ts" "src\modules\customSearch\"
Copy-Item "D:\AI\zotero-better-notes\src\modules\customSearch\manager.ts" "src\modules\customSearch\"
Copy-Item "D:\AI\zotero-better-notes\src\modules\customSearch\types.ts" "src\modules\customSearch\"
```

### 2.2 修改 import 路径

**findbar.ts** 需要修改的 import:

```typescript
// 原始
import { addon } from "../../addon";
import type { EditorElement } from "../../typings/editor";

// 修改为（根据您插件的结构调整）
import { config } from "../../package.json";
import type { EditorElement } from "../../typings/zotero";
```

**manager.ts** 需要修改的 import:

```typescript
// 原始
import { InlineFindbar } from "./findbar";
import type { EditorElement } from "../../typings/editor";

// 修改为
import { InlineFindbar } from "./findbar";
import type { EditorElement } from "../../typings/zotero";
```

### 2.3 添加类型定义

在 `typings/zotero.d.ts` 或新建 `typings/editor.d.ts` 添加:

```typescript
interface EditorElement extends HTMLElement {
  _bnScrollHooked?: boolean;
  notify?: (
    event: string,
    type: string,
    ids: number[],
    extraData: any
  ) => Promise<void>;
}

declare namespace Zotero {
  interface EditorInstance {
    _iframeWindow?: Window;
    _initPromise?: Promise<void>;
    instanceID?: string;
    getCurrentInstance?: () => Zotero.EditorInstance | null;
  }
}
```

---

## 三、集成到 Researchopia

### 3.1 找到 Note Editor 的注入点

**关键问题**: 在哪里获取 `Zotero.EditorInstance`？

**可能的位置**:
1. Reader 工具栏初始化时
2. Note window 打开时
3. Tab 切换时

**检查现有代码**:
```bash
# 搜索 EditorInstance 相关代码
grep -r "EditorInstance" src/
grep -r "note-editor" src/
grep -r "editor.instanceID" src/
```

### 3.2 创建 SearchManager 实例

在主模块初始化文件（如 `src/modules/main.ts`）:

```typescript
import { SearchManager } from "./customSearch/manager";

// 全局实例
const searchManager = new SearchManager();

// 在 addon 初始化时注册
export function initCustomSearch() {
  // 监听 editor 创建事件
  Zotero.Notifier.registerObserver({
    notify: (event, type, ids, extraData) => {
      if (event === "add" && type === "editor") {
        const editor = Zotero.getActiveZoteroPane()?.getCurrentEditor?.();
        if (editor) {
          searchManager.registerEditor(editor);
        }
      }
    }
  }, ["editor"]);
}
```

### 3.3 添加工具栏按钮

**方式 A**: 修改现有的 note-editor 工具栏

在 `src/modules/editor/toolbar.ts`（或类似文件）:

```typescript
import { SearchManager } from "../customSearch/manager";

export function addSearchButton(editor: Zotero.EditorInstance) {
  const toolbar = editor._iframeWindow?.document.querySelector(".toolbar");
  if (!toolbar) return;

  const searchBtn = document.createElement("button");
  searchBtn.className = "toolbar-button";
  searchBtn.title = "Custom Search (Ctrl+Shift+F)";
  searchBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none">
      <path fill="currentColor" d="M12.75 7.5a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0m-1.117 5.017a6.5 6.5 0 1 1 .884-.884L19 18.116l-.884.884z"/>
    </svg>
  `;
  
  searchBtn.addEventListener("click", () => {
    searchManager.toggle(editor);
  });

  toolbar.appendChild(searchBtn);
}
```

**方式 B**: 使用快捷键触发（更简单）

```typescript
// 在 addon 初始化时注册快捷键
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === "F") {
    e.preventDefault();
    const editor = Zotero.getActiveZoteroPane()?.getCurrentEditor?.();
    if (editor) {
      searchManager.toggle(editor);
    }
  }
});
```

---

## 四、调试与测试

### 4.1 构建插件

```bash
cd D:\AI\Researchopia\zotero-plugin
npm run build
```

### 4.2 测试清单

- [ ] 打开笔记，按 `Ctrl+Shift+F` 显示搜索栏
- [ ] 输入文本，实时高亮匹配内容
- [ ] 点击 Previous/Next 按钮，正确导航
- [ ] 勾选 Replace，显示替换 UI（第二行）
- [ ] Replace 和 Replace All 功能正常
- [ ] 深色模式下背景色正确
- [ ] 窗口缩放时布局正常
- [ ] 大文档（2000+ 匹配）性能流畅（<100ms）

### 4.3 常见问题

**问题 1**: TypeScript 报错 `Property '_iframeWindow' does not exist`

**解决**: 添加类型定义（见 2.3）

---

**问题 2**: 搜索栏无法显示

**检查**:
1. `editor._iframeWindow` 是否存在
2. `.primary-editor` 元素是否找到
3. 查看控制台错误日志

---

**问题 3**: 快捷键不生效

**原因**: 可能被 Zotero 或其他插件占用

**解决**: 改用其他快捷键，如 `Ctrl+Alt+F`

---

## 五、优化建议

### 5.1 样式定制

修改 `findbar.ts` 中的样式以匹配 Researchopia 主题:

```typescript
// 第 83 行附近
background-color: #f0f0f0;  // 改为您的主题色

// 深色模式（第 208 行）
this.findbar.style.backgroundColor = '#2a2a2a';  // 改为您的深色主题色
```

### 5.2 本地化

添加多语言支持（如果需要）:

```typescript
// 在 locale/ 目录添加翻译文件
{
  "customSearch.find": "查找",
  "customSearch.replace": "替换",
  "customSearch.replaceAll": "全部替换"
}
```

### 5.3 性能监控

添加日志以监控性能:

```typescript
// findbar.ts 第 290 行附近
const startTime = performance.now();
this.search(newQuery);
console.log(`Search took ${performance.now() - startTime}ms`);
```

---

## 六、发布更新

### 6.1 更新 CHANGELOG

在 `CHANGELOG.md` 添加:

```markdown
## [x.x.x] - 2025-11-27

### Added
- ✨ Custom Search: 高性能笔记搜索功能
  - 实时高亮匹配内容
  - Previous/Next 导航
  - Replace 和 Replace All
  - 性能提升 15x（相比原生搜索）
```

### 6.2 更新文档

在用户指南中添加 CustomSearch 使用说明。

---

## 附录：关键代码片段

### A1. 获取 EditorInstance

```typescript
// 方法 1: 从活动窗格获取
const editor = Zotero.getActiveZoteroPane()?.getCurrentEditor?.();

// 方法 2: 从 note window 获取
const noteWindow = Zotero.getMainWindow();
const editor = noteWindow.document.querySelector("note-editor")?._editorInstance;

// 方法 3: 从 reader 获取
const reader = Zotero.Reader.getByTabID(tabID);
const editor = reader?.getEditorInstance?.();
```

### A2. 监听 Editor 事件

```typescript
// 监听编辑器加载
document.addEventListener("editor-loaded", (e: CustomEvent) => {
  const editor = e.detail.editor;
  searchManager.registerEditor(editor);
});

// 监听编辑器销毁
document.addEventListener("editor-unload", (e: CustomEvent) => {
  const editor = e.detail.editor;
  searchManager.unregisterEditor(editor.instanceID);
});
```

---

**文档版本**: v1.0  
**创建日期**: 2025-11-27  
**作者**: GitHub Copilot  
**相关文档**: 
- [9.2 - Zotero Note 搜索优化分析](./9.2-zotero-note-search-optimization.md)
- [9.3 - PR 提交完整流程指南](./9.3-pr-submission-guide.md)
