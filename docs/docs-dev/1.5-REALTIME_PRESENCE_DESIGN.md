# 1.5 Realtime Presence 在线状态设计

**版本**: v1.0  
**日期**: 2025-11-23  
**目标**: 使用Supabase Realtime Presence替代is_online字段,实现准确的在线人数统计

---

## 一、技术选型对比

| 方案 | WebSocket原生 | Supabase Realtime Presence |
|------|--------------|---------------------------|
| 实现复杂度 | 高(需自建服务器) | 低(开箱即用) |
| 心跳管理 | 手动实现 | 自动(30秒) |
| 断线重连 | 手动实现 | 自动 |
| 异常退出处理 | 需手动清理 | **自动移除** ✅ |
| 与数据库集成 | 需额外同步 | 原生支持 |

**结论**: 使用Supabase Realtime Presence,利用其自动心跳和异常退出检测。

---

## 二、实现流程

### 2.1 用户加入会话

```typescript
// 前端/插件代码
const channel = supabase.channel(`session:${sessionId}`)

// 加入presence
await channel
  .on('presence', { event: 'sync' }, () => {
    const state = channel.presenceState()
    const onlineCount = Object.keys(state).length
    updateUI(onlineCount) // 更新UI显示
  })
  .subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      // 追踪自己的在线状态
      await channel.track({
        user_id: currentUserId,
        online_at: new Date().toISOString()
      })
    }
  })
```

### 2.2 Supabase自动管理

- **心跳**: 每30秒自动发送,无需手动
- **离线检测**: 超过30秒无响应→自动标记离线
- **异常退出**: 浏览器关闭/断网→立即移除presence

### 2.3 获取在线人数

**方式1: 前端实时计算(推荐)**
```typescript
const presenceState = channel.presenceState()
const onlineUsers = Object.keys(presenceState).length
```

**方式2: 服务端聚合(可选)**
```typescript
// API返回总人数,前端订阅realtime自己计算在线数
{
  member_count: 15,  // 后端查询session_members总数
  // 不再返回online_count
}
```

---

## 三、数据库变更

### 3.1 废弃字段

```sql
-- session_members表
-- ❌ 不再使用 is_online (BOOLEAN)
-- ⚠️ 保留 last_seen 用于历史活动记录
```

### 3.2 新增索引(可选)

```sql
-- 如需查询最近活跃成员
CREATE INDEX idx_session_members_last_seen 
ON session_members(session_id, last_seen DESC);
```

---

## 四、迁移步骤

### Phase 1: 前端实现(Week 1)

**网站 (`src/app/reading-session/[id]`)**:
1. ✅ 初始化channel并订阅presence
2. ✅ 用户进入页面时track在线状态
3. ✅ 监听sync事件更新在线人数
4. ✅ 页面卸载时untrack(自动)

**Zotero插件** (`readingSessionManager.ts`):
1. ✅ 在joinSession后订阅presence
2. ✅ 用户切换页面时不断线(保持连接)
3. ✅ 插件关闭时cleanup(自动)

### Phase 2: 后端调整(Week 1)

**API变更** (`api/proxy/reading-session/list/route.ts`):
```typescript
// ❌ 移除在线人数查询
// const { count: onlineCount } = await supabase
//   .from('session_members')
//   .eq('is_online', true)

// ✅ 只返回总人数
return {
  ...session,
  member_count: memberCount || 0
  // online_count字段移除
}
```

### Phase 3: 清理(Week 2)

1. ✅ 移除所有is_online相关代码
2. ✅ 更新TypeScript类型定义
3. ✅ 数据库迁移(可选):
   ```sql
   -- ALTER TABLE session_members DROP COLUMN is_online;
   ```

---

## 五、兼容性说明

### 5.1 过渡期策略

**同时支持两种方式(1-2周)**:
- 新用户使用Presence
- 老代码保留is_online逻辑
- 灰度切换,确保无故障

### 5.2 降级方案

**如果Realtime服务异常**:
```typescript
// 回退到last_seen判定
if (!realtimeAvailable) {
  const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000)
  return members.filter(m => 
    new Date(m.last_seen) > fiveMinutesAgo
  ).length
}
```

---

## 六、性能考虑

### 6.1 连接数限制

- Supabase Free Plan: 200并发连接
- Pro Plan: 500+并发连接
- 当前项目规模: 预估<50并发,安全

### 6.2 消息频率

- Presence sync: 自动优化,无需担心
- 数据量: 每个用户~50字节(user_id + timestamp)

---

## 七、参考资源

- [Supabase Realtime Presence文档](https://supabase.com/docs/guides/realtime/presence)
- [Presence最佳实践](https://supabase.com/docs/guides/realtime/presence#best-practices)
- 项目位置: `zotero-plugin/src/modules/readingSessionManager.ts`

---

**下一步**: 
1. 前端网站实现presence订阅
2. Zotero插件集成realtime
3. 测试异常退出场景
4. 性能监控和优化
