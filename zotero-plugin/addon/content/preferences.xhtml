<!-- Researchopia 偏好设置面板 - XUL/XHTML 片段 -->
<!-- 根据 Zotero 文档，偏好面板应该是片段，不需要 <?xml> 声明和根窗口元素 -->
<linkset>
  <html:link rel="stylesheet" href="preferences.css" xmlns:html="http://www.w3.org/1999/xhtml"/>
</linkset>

<!-- Scripts are loaded via preferences.js file -->
<vbox data-researchopia="true">
  <groupbox>
    <label><html:h2 id="researchopia-title-header">🔬 研学港 Researchopia</html:h2></label>
    <html:p class="description">Open academic exchange and knowledge sharing platform. Where Research Meets Community | 开放的学术交流与知识共享平台。研学并进，智慧共享</html:p>

    <!-- 账户设置 -->
    <groupbox>
      <label><html:h2>👤 账户设置</html:h2></label>

      <!-- 登录容器 - 直接显示登录界面 -->
      <html:div id="researchopia-login-container">
        <!-- 登录表单 -->
        <html:div class="login-form" id="login-form-section">
          <html:h3>连接到研学港</html:h3>
          <html:p class="login-description">登录以使用所有功能</html:p>
          <html:div class="form-group" style="display: flex; align-items: center; gap: 8px;">
            <html:label for="email-input">邮箱地址:</html:label>
            <html:input type="email" id="email-input" placeholder="your.email@example.com" />
            <html:a href="javascript:void(0)" onclick="Zotero.launchURL('https://www.researchopia.com/')" id="create-account" style="flex-shrink: 0; color: var(--accent-blue); text-decoration: none; font-size: 12px; white-space: nowrap; cursor: pointer;">创建账户</html:a>
          </html:div>
          <html:div class="form-group" style="display: flex; align-items: center; gap: 8px;">
            <html:label for="password-input">密码:</html:label>
            <html:input type="password" id="password-input" placeholder="请输入您的密码" />
            <html:a href="javascript:void(0)" onclick="Zotero.launchURL('https://www.researchopia.com/')" id="forgot-password" style="flex-shrink: 0; color: var(--accent-blue); text-decoration: none; font-size: 12px; white-space: nowrap; cursor: pointer;">忘记密码</html:a>
          </html:div>
          <html:div class="form-group">
            <html:label class="checkbox-label">
              <html:input type="checkbox" id="remember-credentials" />
              <html:span>记住账号密码</html:span>
              <html:small>下次登录自动填充账号和密码</html:small>
            </html:label>
          </html:div>
          <html:div class="form-actions">
            <html:button id="login-btn" class="researchopia-btn primary">
              <html:span class="btn-text">登录</html:span>
              <html:span class="btn-loading" style="display: none;">登录中...</html:span>
            </html:button>
          </html:div>
          <html:div id="login-message" class="message"></html:div>
        </html:div>
        
        <!-- 已登录状态 -->
        <html:div class="logged-in-status" id="logged-in-section" style="display: none;">
          <html:h3>已连接到研学港</html:h3>
          <html:div class="user-info">
            <html:div class="user-details">
              <html:div class="user-name">
                <html:strong>用户名: </html:strong>
                <html:span id="user-name-display">--</html:span>
              </html:div>
              <html:div class="user-email">
                <html:strong>邮箱: </html:strong>
                <html:span id="user-email-display">--</html:span>
              </html:div>
              <html:div class="login-time">
                <html:strong>登录时间: </html:strong>
                <html:span id="login-time-display">--</html:span>
              </html:div>
            </html:div>
            <html:div class="user-actions">
              <html:button id="logout-btn" class="researchopia-btn danger">
                <html:span class="btn-text">登出</html:span>
                <html:span class="btn-loading" style="display: none;">登出中...</html:span>
              </html:button>
            </html:div>
          </html:div>
          <html:div id="status-message" class="message"></html:div>
        </html:div>
      </html:div>
    </groupbox>

    <!-- 标注共享功能 -->
    <groupbox>
      <label><html:h2>📤 标注共享功能</html:h2></label>
      <html:p class="description" style="margin: 0 0 12px 0; color: #666; font-size: 12px;">管理 PDF 阅读器中的标注共享与查看功能</html:p>
      
      <!-- 管理共享标注 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="annotation-sharing-manage" preference="extensions.zotero.researchopia.annotationSharingManage" />
          <html:span>🔄 管理共享标注</html:span>
          <html:small>在本地标注卡片和文本选择弹窗中显示共享按钮，可将标注分享给其他用户</html:small>
        </html:label>
      </html:div>
      
      <!-- 查看共享标注 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="annotation-sharing-view" preference="extensions.zotero.researchopia.annotationSharingView" />
          <html:span>👁️ 查看共享标注</html:span>
          <html:small>在 PDF 阅读器侧边栏添加「共享标注」Tab，查看其他用户分享的标注</html:small>
        </html:label>
      </html:div>
      
      <html:div class="form-group" style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 6px;">
        <html:small style="color: #4CAF50; font-weight: 500;">💡 提示</html:small>
        <html:p style="margin: 4px 0; color: #666; font-size: 12px;">
          标注共享功能需要登录账户后才能使用。修改设置后需重新打开 PDF 或重启 Zotero 生效。
        </html:p>
      </html:div>
    </groupbox>

    <!-- Zotero Notes 增强工具 -->
    <groupbox>
      <label><html:h2>📝 Zotero Notes 增强工具</html:h2></label>
      <html:p class="description" style="margin: 0 0 12px 0; color: #666; font-size: 12px;">为 Zotero 笔记编辑器提供额外增强功能</html:p>
      
      <!-- 自定义搜索按钮 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="custom-search" preference="extensions.zotero.researchopia.customSearch" />
          <html:span>🔍 自定义搜索按钮</html:span>
          <html:small>在笔记工具栏添加增强搜索按钮，支持 Ctrl+F 快捷键，并自动隐藏原生搜索按钮</html:small>
        </html:label>
      </html:div>
      
      <!-- 统计功能 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="word-count" preference="extensions.zotero.researchopia.wordCount" />
          <html:span>📊 统计功能</html:span>
          <html:small>在编辑器右下角显示行数、字数、字符数统计信息</html:small>
        </html:label>
      </html:div>
      
      <!-- 显示行号 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="line-numbers" preference="extensions.zotero.researchopia.lineNumbers" />
          <html:span>📏 显示行号</html:span>
          <html:small>在笔记编辑器左侧显示行号</html:small>
        </html:label>
      </html:div>
      
      <!-- 阻止笔记窗口跳转到首行 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="scroll-preserver" preference="extensions.zotero.researchopia.scrollPreserver" />
          <html:span>📍 保持笔记视图位置</html:span>
          <html:small>编辑笔记时保持所有窗口的视图位置，防止自动跳转到首行</html:small>
        </html:label>
      </html:div>
      
      <!-- 标题折叠功能 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="heading-collapse" preference="extensions.zotero.researchopia.headingCollapse" />
          <html:span>📂 标题折叠</html:span>
          <html:small>为 H1-H3 标题添加折叠/展开按钮</html:small>
        </html:label>
      </html:div>
      
      <!-- 自定义颜色选择 -->
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="color-picker" preference="extensions.zotero.researchopia.colorPicker" />
          <html:span>🎨 自定义颜色</html:span>
          <html:small>在字体/高亮颜色面板添加「更多颜色」选项，支持任意颜色选择</html:small>
        </html:label>
      </html:div>
      
      <html:div class="form-group" style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 6px;">
        <html:small style="color: #4CAF50; font-weight: 500;">✅ 功能说明</html:small>
        <html:p style="margin: 4px 0; color: #666; font-size: 12px;">
          所有功能可独立开关，完美兼容Better Notes插件，修改后需重新打开笔记编辑器或重启Zotero后生效。
        </html:p>
      </html:div>
    </groupbox>

    <!-- 开发者选项 -->
    <groupbox>
      <label><html:h2>🔧 开发者选项</html:h2></label>
      
      <!-- 诊断工具（暂不开放）
      <html:div class="form-group" style="margin-bottom: 16px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
        <html:div style="margin-bottom: 8px;">
          <html:strong>🩺 诊断工具</html:strong>
        </html:div>
        <html:p style="margin: 4px 0 8px 0; color: #666; font-size: 12px;">
          一键生成诊断报告,包含插件版本、登录状态、网络连接等信息,用于故障排查和技术支持
        </html:p>
        <html:button id="generate-diagnostic-report-btn" class="researchopia-btn" style="font-size: 13px; padding: 8px 16px;">
          📋 生成诊断报告
        </html:button>
      </html:div>  -->
      
      <html:div class="form-group">
        <html:label class="checkbox-label">
          <html:input type="checkbox" id="use-dev-environment" />
          <html:span>⚠️ 开发者专用（其他情况请勿勾选！）</html:span>
          <html:small>使用开发环境 - 切换到本地开发服务器 (http://localhost:3000)</html:small>
        </html:label>
      </html:div>
      <html:div class="form-group">
        <html:small style="color: #666;">💡 提示: 切换环境后,点击按钮或链接时会使用新环境地址</html:small>
      </html:div>
      <html:div class="form-group" style="display: flex; align-items: center; gap: 8px;">
        <html:label for="custom-api-url" style="flex-shrink: 0;">自定义 API 地址:</html:label>
        <html:input 
          type="text" 
          id="custom-api-url" 
          placeholder="https://your-custom-domain.com" 
          style="flex: 1; font-family: monospace; font-size: 12px;"
        />
      </html:div>
      <html:div class="form-group" style="display: flex; align-items: center; gap: 12px;">
        <html:button id="reset-api-url-btn" class="researchopia-btn" style="font-size: 12px; padding: 6px 12px;">
          重置为默认
        </html:button>
        <html:span id="current-api-display" style="color: #666; font-size: 12px; font-weight: 500;"></html:span>
      </html:div>
    </groupbox>

    <!-- 关于 -->
    <groupbox>
      <label><html:h2>ℹ️ 关于</html:h2></label>
      <html:div class="about-info">
        <html:div style="margin: 8px 0; display: flex; align-items: center;">
          <html:strong style="margin-right: 6px;">插件版本:</html:strong>
          <html:span id="researchopia-version">Loading...</html:span>
          <html:span style="margin: 0 8px;">|</html:span>
          <html:strong style="margin-right: 6px;">兼容版本:</html:strong>
          <html:span>Zotero 8 beta, Zotero 7</html:span>
        </html:div>
        <html:div style="margin: 8px 0; color: #666; font-size: 12px; font-style: italic;">
          💡 推荐使用 Zotero 8 beta 以获得最佳体验
        </html:div>
        <html:div style="margin: 8px 0; display: flex; align-items: center;">
          <html:strong style="margin-right: 6px;">官方网站:</html:strong>
          <html:a href="javascript:void(0)" onclick="Zotero.launchURL('https://www.researchopia.com/')" style="color: var(--accent-blue); text-decoration: none; cursor: pointer;">https://www.researchopia.com/</html:a>
        </html:div>
        <html:div style="margin: 8px 0; display: flex; align-items: center;">
          <html:strong style="margin-right: 6px;">项目主页:</html:strong>
          <html:a href="javascript:void(0)" onclick="Zotero.launchURL('https://github.com/occasional16/researchopia')" style="color: var(--accent-blue); text-decoration: none; cursor: pointer;">https://github.com/occasional16/researchopia</html:a>
        </html:div>
      </html:div>
    </groupbox>
  </groupbox>
</vbox>
