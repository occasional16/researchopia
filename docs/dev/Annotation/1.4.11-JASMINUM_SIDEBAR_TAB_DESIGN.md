# 1.4.11 Jasminumæ’ä»¶Sidebarè‡ªå®šä¹‰Tabè®¾è®¡ç ”ç©¶

**æ–‡æ¡£ç¼–å·**: 1.4.11  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-20  
**ç ”ç©¶å¯¹è±¡**: [Jasminumæ’ä»¶](https://github.com/l0o0/jasminum) (Zoteroä¸­æ–‡è¾…åŠ©æ’ä»¶)  
**ç ”ç©¶ç›®çš„**: å­¦ä¹ å¦‚ä½•åœ¨Zotero Readerå·¦ä¾§sidebaråˆ›å»ºè‡ªå®šä¹‰tabå’ŒåŠŸèƒ½é¡µé¢

---

## ä¸€ã€æ ¸å¿ƒå®ç°åŸç†

### 1.1 æ³¨å†ŒReaderäº‹ä»¶ç›‘å¬

**å…³é”®API**: `Zotero.Reader.registerEventListener`

```typescript
// src/modules/tab.ts
export function registerTab() {
  Zotero.Reader.registerEventListener(
    "renderToolbar",              // ç›‘å¬toolbaræ¸²æŸ“äº‹ä»¶
    tabRegisterCallback,          // å›è°ƒå‡½æ•°
    config.addonID                // æ’ä»¶ID
  );
}

async function tabRegisterCallback(event: any) {
  const { reader } = event;
  await registerOutline(reader.tabID);  // æ³¨å†Œè‡ªå®šä¹‰outlineåŠŸèƒ½
}
```

**äº‹ä»¶è§¦å‘æ—¶æœº**: å½“Zotero Readeræ‰“å¼€PDFæ—¶,`renderToolbar`äº‹ä»¶è§¦å‘,æ’ä»¶é€šè¿‡`reader.tabID`è¯†åˆ«å½“å‰tabã€‚

---

## äºŒã€è‡ªå®šä¹‰TabæŒ‰é’®åˆ›å»º

### 2.1 Show OutlineæŒ‰é’®

**å®ç°ä½ç½®**: `src/modules/outline/outline.ts` Line 44-69

**HTMLç»“æ„**:
```html
<!-- Zotero Reader sidebarå·¥å…·æ  -->
<div id="sidebarContainer">
  <div class="start">
    <!-- åŸç”ŸæŒ‰é’®: Thumbnails/Annotations/Outline -->
    <button id="viewThumbnail">...</button>
    <button id="viewOutline">...</button>
    
    <!-- ğŸ†• Jasminumè‡ªå®šä¹‰æŒ‰é’® -->
    <button id="j-outline-button" 
            class="toolbar-button"
            role="tab"
            aria-selected="false"
            aria-controls="j-outline-viewer">
      {ICONS.outline}  <!-- SVGå›¾æ ‡ -->
    </button>
  </div>
</div>
```

**ä»£ç å®ç°**:
```typescript
export function addButton(doc: Document) {
  ztoolkit.UI.appendElement(
    {
      tag: "button",
      namespace: "html",
      id: "j-outline-button",
      classList: ["toolbar-button"],
      properties: { innerHTML: ICONS.outline },  // SVGå›¾æ ‡
      attributes: {
        title: getString("outline"),
        tabindex: "-1",
        role: "tab",                             // â­ WAI-ARIA role
        "aria-selected": "false",
        "aria-controls": "j-outline-viewer",     // â­ å…³è”å†…å®¹åŒºID
      },
    },
    doc.querySelector("#sidebarContainer div.start")!  // æ’å…¥ä½ç½®
  );
}
```

### 2.2 Show BookmarksæŒ‰é’®

**å®ç°ä½ç½®**: `src/modules/outline/bookmark.ts` Line 242-264

**ç‰¹ç‚¹**: ä¸Show OutlineæŒ‰é’®å®Œå…¨ç›¸åŒçš„å®ç°æ–¹å¼,åªæ˜¯IDå’Œå›¾æ ‡ä¸åŒ:
- `id="j-bookmark-button"`
- `aria-controls="j-bookmark-viewer"`
- `innerHTML: ICONS.bookmark`

---

## ä¸‰ã€è‡ªå®šä¹‰Tabå†…å®¹åŒºè®¾è®¡

### 3.1 Outlineè§†å›¾ç»“æ„

**å®ç°ä½ç½®**: `src/modules/outline/index.ts` Line 23-108

**é¡¶å±‚å®¹å™¨**:
```typescript
const treeContainer = ztoolkit.UI.createElement(doc, "div", {
  id: "jasminum-outline",
  classList: ["hidden"],  // é»˜è®¤éšè—,ç‚¹å‡»æŒ‰é’®åæ˜¾ç¤º
  namespace: "html",
  children: [
    {
      tag: "div",
      id: "j-outline-viewer",
      classList: ["outline-view"],
      attributes: {
        tabindex: "-1",
        "data-tabstop": "1",
        role: "tabpanel",                        // â­ WAI-ARIA role
        "aria-labelledby": "j-outline-button",   // â­ å…³è”æŒ‰é’®ID
      },
      children: [
        {
          tag: "ul",
          id: "root-list",
          classList: ["tree-list"],  // å¤§çº²æ ‘æ ¹èŠ‚ç‚¹
        },
      ],
    },
  ],
});

// æ’å…¥åˆ°sidebarå†…å®¹åŒº
doc.querySelector("#sidebarContent")?.appendChild(treeContainer);
```

**DOMå±‚çº§å…³ç³»**:
```
#sidebarContainer
â”œâ”€â”€ div.start                    (å·¥å…·æ æŒ‰é’®åŒº)
â”‚   â”œâ”€â”€ button#viewThumbnail
â”‚   â”œâ”€â”€ button#viewOutline
â”‚   â”œâ”€â”€ button#j-outline-button  (ğŸ†• è‡ªå®šä¹‰)
â”‚   â””â”€â”€ button#j-bookmark-button (ğŸ†• è‡ªå®šä¹‰)
â”œâ”€â”€ #sidebarContent              (å†…å®¹åŒº)
â”‚   â”œâ”€â”€ #thumbnailView           (åŸç”Ÿ)
â”‚   â”œâ”€â”€ #outlineView             (åŸç”Ÿ)
â”‚   â”œâ”€â”€ #jasminum-outline        (ğŸ†• è‡ªå®šä¹‰)
â”‚   â””â”€â”€ #jasminum-bookmarks      (ğŸ†• è‡ªå®šä¹‰)
â””â”€â”€ #j-outline-toolbar           (ğŸ†• å·¥å…·æ )
```

### 3.2 é¡¶éƒ¨å·¥å…·æ  (Expand all / Collapse all)

**å®ç°ä½ç½®**: `src/modules/outline/index.ts` Line 28-69

**Outlineå·¥å…·æ **:
```typescript
const toolbar = ztoolkit.UI.createElement(doc, "div", {
  id: "j-outline-toolbar",
  classList: ["j-hidden"],  // é»˜è®¤éšè—,æ¿€æ´»tabæ—¶æ˜¾ç¤º
  children: [
    {
      tag: "button",
      id: "j-outline-expand-all",
      classList: ["j-outline-toolbar-button", "toolbar-button"],
      properties: { innerHTML: ICONS.expand },
      attributes: { title: getString("outline-expand-all") },
    },
    {
      tag: "button",
      id: "j-outline-collapse-all",
      classList: ["j-outline-toolbar-button", "toolbar-button"],
      properties: { innerHTML: ICONS.collapse },
      attributes: { title: getString("outline-collapse-all") },
    },
    {
      tag: "button",
      id: "j-outline-add-node",
      properties: { innerHTML: ICONS.add },
      attributes: { title: getString("outline-add") },
    },
    {
      tag: "button",
      id: "j-outline-delete-node",
      properties: { innerHTML: ICONS.del },
      attributes: { title: getString("outline-delete") },
    },
    {
      tag: "button",
      id: "j-outline-save-pdf",
      properties: { innerHTML: ICONS.save },
      attributes: { title: getString("outline-save-to-pdf") },
    },
  ],
});

// æ’å…¥åˆ°#sidebarContentä¹‹å‰
doc.getElementById("sidebarContainer")!
   .insertBefore(toolbar, doc.getElementById("sidebarContent")!);
```

**Bookmarkå·¥å…·æ ** (Line 115-138):
```typescript
const toolbar = ztoolkit.UI.createElement(doc, "div", {
  id: "j-bookmark-toolbar",
  classList: ["j-hidden"],
  children: [
    { tag: "button", id: "j-bookmark-add", ... },
    { tag: "button", id: "j-bookmark-delete", ... },
    // æ³¨æ„: Bookmarkå·¥å…·æ åªæœ‰2ä¸ªæŒ‰é’®(add/delete),æ²¡æœ‰expand/collapse
  ],
});
```

**CSSæ ·å¼** (`src/modules/outline/style.ts`):
```css
#j-outline-toolbar, #j-bookmark-toolbar {
  display: flex;
  gap: 4px;
  padding: 8px;
  border-bottom: 1px solid #e0e0e0;
}

#j-outline-toolbar.j-hidden, #j-bookmark-toolbar.j-hidden {
  display: none;  /* éšè—å·¥å…·æ  */
}
```

---

## å››ã€Tabåˆ‡æ¢é€»è¾‘

### 4.1 ç‚¹å‡»æŒ‰é’®åˆ‡æ¢è§†å›¾

**å®ç°ä½ç½®**: `src/modules/outline/events.ts` Line 51-88

**æ ¸å¿ƒé€»è¾‘**:
```typescript
function hideShowMyOutlineAndBar(e: Event) {
  const button = (e.target as Element).closest("button");
  
  if (button.id === "j-outline-button") {
    // 1. è°ƒç”¨Zotero Reader APIè®¾ç½®sidebarè§†å›¾
    reader.setSidebarView("jasminum-outline");
    
    // 2. æ˜¾ç¤ºoutlineå®¹å™¨,éšè—bookmarkå®¹å™¨
    doc.getElementById("jasminum-outline")?.classList.remove("hidden");
    doc.getElementById("jasminum-bookmarks")?.classList.add("hidden");
    
    // 3. æ˜¾ç¤ºoutlineå·¥å…·æ ,éšè—bookmarkå·¥å…·æ 
    doc.getElementById("j-outline-toolbar")?.classList.toggle("j-hidden", false);
    doc.getElementById("j-bookmark-toolbar")?.classList.toggle("j-hidden", true);
    
    // 4. æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
    button.classList.toggle("active", true);
    doc.getElementById("j-bookmark-button")?.classList.toggle("active", false);
  } 
  else if (button.id === "j-bookmark-button") {
    // BookmarkæŒ‰é’®ç‚¹å‡»é€»è¾‘ç›¸åŒ,åªæ˜¯æ˜¾ç¤º/éšè—å¯¹è±¡ç›¸å
    reader.setSidebarView("jasminum-bookmarks");
    // ...
  }
  else {
    // ç‚¹å‡»å…¶ä»–åŸç”ŸæŒ‰é’®(Thumbnails/Annotations),éšè—Jasminumè§†å›¾
    doc.getElementById("jasminum-outline")?.classList.toggle("hidden", true);
    doc.getElementById("jasminum-bookmarks")?.classList.toggle("hidden", true);
    doc.getElementById("j-outline-toolbar")?.classList.toggle("j-hidden", true);
    doc.getElementById("j-bookmark-toolbar")?.classList.toggle("j-hidden", true);
    button.classList.toggle("active", false);
  }
}

// ç›‘å¬æ‰€æœ‰sidebaræŒ‰é’®ç‚¹å‡»äº‹ä»¶
doc.querySelectorAll("#sidebarContainer button.toolbar-button")
   .forEach(btn => btn.addEventListener("click", hideShowMyOutlineAndBar));
```

**å…³é”®API**: `reader.setSidebarView(viewName: string)`
- å‚æ•°: è‡ªå®šä¹‰è§†å›¾åç§° (å¦‚`"jasminum-outline"`)
- ä½œç”¨: é€šçŸ¥Zotero Readerå½“å‰æ¿€æ´»çš„sidebarè§†å›¾

---

## äº”ã€ç•Œé¢ä¸»ä½“å†…å®¹å®ç°

### 5.1 Outlineæ ‘å½¢ç»“æ„

**æ•°æ®æº**: PDFè‡ªå¸¦Outline + JSONæ–‡ä»¶ç¼“å­˜

**èŠ‚ç‚¹æ¸²æŸ“** (`src/modules/outline/outline.ts`):
```typescript
function createTreeNodes(
  nodes: OutlineNode[] | null,
  parentElement: HTMLElement,
  doc: Document
) {
  nodes.forEach(node => {
    const li = ztoolkit.UI.createElement(doc, "li", {
      classList: ["tree-item"],
      children: [
        {
          tag: "div",
          classList: ["tree-node"],
          attributes: {
            "data-id": node.id,
            "data-page": node.dest.pageIndex,
          },
          children: [
            {
              tag: "button",
              classList: ["tree-node-toggle"],
              properties: { innerHTML: node.items ? "â–¶" : "" },
            },
            {
              tag: "span",
              classList: ["tree-node-title"],
              properties: { textContent: node.title },
            },
          ],
        },
        // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
        {
          tag: "ul",
          classList: ["tree-list"],
          children: node.items ? node.items : [],
        },
      ],
    });
    parentElement.appendChild(li);
  });
}
```

**äº¤äº’åŠŸèƒ½** (`src/modules/outline/events.ts`):
- **Expand all** (Line 228): éå†æ‰€æœ‰`.tree-item`,ç§»é™¤`collapsed`ç±»
- **Collapse all** (Line 237): éå†æ‰€æœ‰`.tree-item`,æ·»åŠ `collapsed`ç±»
- **ç‚¹å‡»èŠ‚ç‚¹æ ‡é¢˜**: è·³è½¬åˆ°PDFå¯¹åº”é¡µé¢å’Œä½ç½®
- **æ‹–æ‹½æ’åº**: ç›‘å¬`dragstart`/`dragover`/`drop`äº‹ä»¶

### 5.2 Bookmarksåˆ—è¡¨

**æ•°æ®æº**: JSONæ–‡ä»¶ (`jasminum-bookmarks.json`)

**èŠ‚ç‚¹æ¸²æŸ“** (`src/modules/outline/bookmark.ts` Line 147-242):
```typescript
function createBookmarkNodes(
  nodes: BookmarkNode[] | null,
  parentElement: HTMLElement,
  doc: Document
) {
  if (!nodes || nodes.length == 0) {
    // ç©ºçŠ¶æ€æç¤º
    ztoolkit.UI.appendElement({
      tag: "div",
      classList: ["empty-bookmark-prompt"],
      properties: { innerHTML: `è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®${ICONS.add}åˆ›å»ºä¹¦ç­¾` },
    }, parentElement);
  } else {
    nodes.sort((a, b) => a.order - b.order).forEach(node => {
      const li = ztoolkit.UI.createElement(doc, "li", {
        classList: ["bookmark-item"],
        children: [
          {
            tag: "div",
            classList: ["bookmark-node"],
            attributes: {
              draggable: "true",
              "data-id": node.id,
              page: node.page,
              x: node.x,
              y: node.y,
            },
            children: [
              {
                tag: "span",
                classList: ["bookmark-color-dot"],
                styles: { backgroundColor: node.color },  // å½©è‰²æ ‡è®°
              },
              {
                tag: "span",
                classList: ["bookmark-title"],
                properties: { textContent: node.title },
              },
              {
                tag: "span",
                classList: ["bookmark-page"],
                properties: { textContent: `p.${node.page}` },
              },
            ],
          },
        ],
      });
      parentElement.appendChild(li);
    });
  }
}
```

**ç‰¹è‰²åŠŸèƒ½**:
- **å½©è‰²æ ‡è®°**: æ¯ä¸ªä¹¦ç­¾éšæœºåˆ†é…é¢œè‰² (9ç§é¢„è®¾é¢œè‰²)
- **æ‹–æ‹½æ’åº**: æ”¯æŒä¹¦ç­¾é‡æ–°æ’åº,ä¿å­˜åˆ°JSON
- **æ™ºèƒ½å‘½å**: æ–°å»ºä¹¦ç­¾è‡ªåŠ¨ç”Ÿæˆ"ç¬¬Xé¡µä¹¦ç­¾"æ ‡é¢˜

---

## å…­ã€å…³é”®æŠ€æœ¯è¦ç‚¹

### 6.1 WAI-ARIAæ”¯æŒ

**ç›®çš„**: æå‡æ— éšœç¢è®¿é—®ä½“éªŒ

**å®ç°**:
```html
<!-- æŒ‰é’® -->
<button id="j-outline-button"
        role="tab"
        aria-selected="false"
        aria-controls="j-outline-viewer">
  
<!-- å†…å®¹åŒº -->
<div id="j-outline-viewer"
     role="tabpanel"
     aria-labelledby="j-outline-button">
```

**è§„èŒƒéµå¾ª**: [ARIA Authoring Practices - Tabs Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/tabs/)

### 6.2 å¼‚æ­¥åŠ è½½ä¸ç¼“å­˜

**PDF OutlineåŠ è½½** (`src/modules/outline/outline.ts` Line 103-120):
```typescript
export async function getOutlineFromPDF(
  reader: _ZoteroTypes.ReaderInstance
): Promise<OutlineNode[] | null> {
  // 1. ä¼˜å…ˆä»JSONç¼“å­˜è¯»å–
  const outline = await loadOutlineFromJSON(reader._item);
  if (outline) return outline;
  
  // 2. ä»PDFæ–‡ä»¶è§£æOutline
  const pdfOutline = await reader._internalReader
    ._primaryView.pdfDocument.getOutline();
  
  // 3. ä¿å­˜åˆ°JSONç¼“å­˜
  if (pdfOutline) {
    await saveOutlineToJSON(reader._item, pdfOutline);
  }
  
  return pdfOutline;
}
```

**JSONæ–‡ä»¶è·¯å¾„**: `{Zotero.DataDirectory}/storage/{item.key}/jasminum-outline.json`

### 6.3 ç­‰å¾…DOMåŠ è½½

**å®ç°ä½ç½®**: `src/modules/outline/index.ts` Line 214-241

**é—®é¢˜**: Readeråˆå§‹åŒ–æ—¶sidebar DOMå…ƒç´ å¯èƒ½æœªæ¸²æŸ“

**è§£å†³æ–¹æ¡ˆ**:
```typescript
export async function registerOutline(tabID: string) {
  const reader = Zotero.Reader.getByTabID(tabID);
  await reader._initPromise;  // ç­‰å¾…Readeråˆå§‹åŒ–
  
  const doc = reader._iframeWindow?.document;
  
  // ç­‰å¾…sidebar toggleæŒ‰é’®åŠ è½½ (æœ€å¤š5ç§’)
  await wait.waitUtilAsync(
    () => doc && doc.getElementById("sidebarToggle") ? true : false,
    5,     // æ£€æŸ¥é—´éš”(ms)
    5000   // è¶…æ—¶æ—¶é—´(ms)
  );
  
  // ç­‰å¾…sidebar containeråŠ è½½
  await wait.waitUtilAsync(
    () => doc.querySelector("#sidebarContainer div.start") ? true : false,
    5,
    5000
  );
  
  addButton(doc);  // ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ·»åŠ æŒ‰é’®
}
```

**å·¥å…·å‡½æ•°**: `wait.waitUtilAsync()` æ¥è‡ª`zotero-plugin-toolkit`

### 6.4 CSSæ³¨å…¥

**å®ç°ä½ç½®**: `src/modules/outline/outline.ts` Line 9-19

```typescript
export function registerOutlineCSS(doc: Document) {
  const styleElement = ztoolkit.UI.createElement(doc, "style", {
    id: "jasminum-outline-style",
    properties: { textContent: outline_css },  // å®Œæ•´CSSå­—ç¬¦ä¸²
  });
  doc.head.appendChild(styleElement);
}
```

**CSSå†…å®¹** (`src/modules/outline/style.ts`):
```css
/* éšè—ZoteroåŸç”ŸOutlineæŒ‰é’® (å¯é€‰) */
#viewOutline { display: none; }

/* å·¥å…·æ æ ·å¼ */
#j-outline-toolbar, #j-bookmark-toolbar {
  display: flex;
  gap: 4px;
  padding: 8px;
  border-bottom: 1px solid #e0e0e0;
  background: var(--sidebar-bg);  /* è·ŸéšZoteroä¸»é¢˜ */
}

/* æ ‘å½¢èŠ‚ç‚¹æ ·å¼ */
.tree-item { list-style: none; }
.tree-node { 
  padding: 4px 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.tree-node:hover { background: var(--row-hover-bg); }

/* æŠ˜å /å±•å¼€åŠ¨ç”» */
.tree-item.collapsed > ul { display: none; }
```

---

## ä¸ƒã€ä¸ç°æœ‰Researchopiaçš„å·®å¼‚

### 7.1 Jasminumè®¾è®¡ç†å¿µ

**è‡ªå®šä¹‰Tab**:
- âœ… ä¸åŸç”ŸTabå¹³çº§ (Thumbnails/Annotations/Outline/Jasminum)
- âœ… ç‹¬ç«‹çš„å†…å®¹åŒºå’Œå·¥å…·æ 
- âœ… å®Œæ•´çš„è§†å›¾åˆ‡æ¢é€»è¾‘

**é€‚ç”¨åœºæ™¯**: éœ€è¦**é•¿æœŸæ˜¾ç¤º**çš„å¤æ‚åŠŸèƒ½ (å¤§çº²ç®¡ç†/ä¹¦ç­¾ç³»ç»Ÿ)

### 7.2 Researchopiaå½“å‰è®¾è®¡

**åŠ¨æ€æ³¨å…¥**:
- âŒ åœ¨æ¯ä¸ªannotationå¡ç‰‡ä¸­æ³¨å…¥æŒ‰é’®å’Œä¿¡æ¯åŒº
- âŒ æ‰¹é‡æ“ä½œå·¥å…·æ åŠ¨æ€æ’å…¥åˆ°`.sidebar-annotations`

**é—®é¢˜**:
1. å·¥å…·æ ä½ç½®ä¸å›ºå®š (éšæ»šåŠ¨æ¶ˆå¤±)
2. ä¸åŸç”ŸUIè€¦åˆåº¦é«˜
3. æ— æ³•åˆ©ç”¨Zoteroçš„tabåˆ‡æ¢æœºåˆ¶

### 7.3 æ”¹è¿›å»ºè®®

**å‚è€ƒJasminumå®ç°ç‹¬ç«‹Tab**:

```typescript
// æ­¥éª¤1: æ³¨å†ŒReaderäº‹ä»¶
Zotero.Reader.registerEventListener(
  "renderToolbar",
  async (event) => {
    const { reader } = event;
    await registerResearchopiaTab(reader.tabID);
  },
  "researchopia-tab"
);

// æ­¥éª¤2: åˆ›å»ºæŒ‰é’®
function addResearchopiaButton(doc: Document) {
  ztoolkit.UI.appendElement({
    tag: "button",
    id: "researchopia-tab-button",
    classList: ["toolbar-button"],
    properties: { innerHTML: ICONS.researchopia },
    attributes: {
      title: "Researchopia",
      role: "tab",
      "aria-controls": "researchopia-tab-viewer",
    },
  }, doc.querySelector("#sidebarContainer div.start")!);
}

// æ­¥éª¤3: åˆ›å»ºå†…å®¹åŒº
function createTabContent(doc: Document) {
  const container = ztoolkit.UI.createElement(doc, "div", {
    id: "researchopia-tab",
    classList: ["hidden"],
    children: [
      // å·¥å…·æ  (å…¨é€‰ + 4ä¸ªæ‰¹é‡æ“ä½œæŒ‰é’®)
      { tag: "div", id: "researchopia-toolbar", ... },
      
      // æ ‡æ³¨åˆ—è¡¨ (å¤ç”¨ç°æœ‰æ ‡æ³¨å¡ç‰‡æ¸²æŸ“é€»è¾‘)
      { tag: "div", id: "researchopia-annotations-list", ... },
    ],
  });
  doc.querySelector("#sidebarContent")?.appendChild(container);
}
```

**ä¼˜åŠ¿**:
1. âœ… æ‰¹é‡æ“ä½œå·¥å…·æ å›ºå®šåœ¨é¡¶éƒ¨,ä¸éšæ»šåŠ¨æ¶ˆå¤±
2. âœ… ç‹¬ç«‹ç©ºé—´å±•ç¤ºæ ‡æ³¨å¡ç‰‡,ä¸ä¸åŸç”ŸAnnotations tabå†²çª
3. âœ… åˆ©ç”¨Zoteroçš„`reader.setSidebarView()`æœºåˆ¶,ä¸åŸç”ŸTabæ— ç¼åˆ‡æ¢

---

## å…«ã€å‚è€ƒèµ„æº

**Jasminumæ’ä»¶**:
- GitHub: https://github.com/l0o0/jasminum
- æ ¸å¿ƒæ–‡ä»¶:
  - `src/modules/tab.ts` - äº‹ä»¶æ³¨å†Œå…¥å£
  - `src/modules/outline/outline.ts` - å¤§çº²åŠŸèƒ½
  - `src/modules/outline/bookmark.ts` - ä¹¦ç­¾åŠŸèƒ½
  - `src/modules/outline/events.ts` - äº¤äº’é€»è¾‘
  - `src/modules/outline/index.ts` - è§†å›¾æ¸²æŸ“

**Zotero Plugin Toolkit**:
- GitHub: https://github.com/windingwind/zotero-plugin-toolkit
- APIæ–‡æ¡£: `ztoolkit.UI.createElement()` / `wait.waitUtilAsync()`

**Zotero Reader API**:
- `Zotero.Reader.registerEventListener(eventName, callback, pluginID)`
- `reader.setSidebarView(viewName: string)`
- `reader._iframeWindow.document` - Readerçš„DOMå¯¹è±¡

---

## ä¹ã€æ€»ç»“

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼

1. **äº‹ä»¶é©±åŠ¨**: ç›‘å¬`renderToolbar`äº‹ä»¶,åœ¨Readeråˆå§‹åŒ–æ—¶æ³¨å…¥UI
2. **DOMåˆ†å±‚**: æŒ‰é’®(`div.start`) + å·¥å…·æ (`#sidebarContainer`) + å†…å®¹åŒº(`#sidebarContent`)
3. **è§†å›¾åˆ‡æ¢**: `reader.setSidebarView()` + `classList.toggle("hidden")` + `classList.toggle("active")`
4. **å¼‚æ­¥åŠ è½½**: `wait.waitUtilAsync()` ç¡®ä¿DOMå°±ç»ª + JSONç¼“å­˜ä¼˜åŒ–æ€§èƒ½
5. **æ— éšœç¢æ”¯æŒ**: WAI-ARIA roleså’Œå±æ€§,æå‡é”®ç›˜å¯¼èˆªä½“éªŒ

### å…³é”®ä»£ç é‡

- **æŒ‰é’®åˆ›å»º**: ~30è¡Œ (å«SVGå›¾æ ‡)
- **å†…å®¹åŒºæ¸²æŸ“**: ~80è¡Œ (å«æ ‘å½¢/åˆ—è¡¨ç»“æ„)
- **å·¥å…·æ **: ~50è¡Œ (2-5ä¸ªæŒ‰é’®)
- **äº‹ä»¶é€»è¾‘**: ~150è¡Œ (tabåˆ‡æ¢ + äº¤äº’)
- **æ€»è®¡**: ~300è¡Œæ ¸å¿ƒä»£ç å®ç°å®Œæ•´è‡ªå®šä¹‰Tab

### Researchopiaåº”ç”¨å»ºè®®

**çŸ­æœŸä¼˜åŒ–** (å½“å‰æ¶æ„):
- å°†æ‰¹é‡æ“ä½œå·¥å…·æ å›ºå®šåœ¨`#sidebarContainer`ä¸‹,é¿å…æ»šåŠ¨æ¶ˆå¤±

**ä¸­æœŸé‡æ„** (å‚è€ƒJasminum):
- åˆ›å»ºç‹¬ç«‹Tab "Researchopia Annotations"
- å·¥å…·æ æ˜¾ç¤º: å…¨é€‰å¼€å…³ + 4ä¸ªæ‰¹é‡æ“ä½œæŒ‰é’®
- ä¸»ä½“å†…å®¹: æ‰€æœ‰å…±äº«æ ‡æ³¨å¡ç‰‡ (å«å¤é€‰æ¡† + 4ä¸ªå…±äº«æŒ‰é’® + å…±äº«ä¿¡æ¯åŒº)

**é•¿æœŸæ‰©å±•**:
- æ·»åŠ ç­›é€‰å™¨ (æŒ‰å…±äº«çŠ¶æ€/ç‚¹èµæ•°/è¯„è®ºæ•°ç­›é€‰)
- æ·»åŠ æ’åºåŠŸèƒ½ (æŒ‰æ—¶é—´/é¡µç /ç‚¹èµæ•°)
- é›†æˆReading Sessionç®¡ç† (æ˜¾ç¤ºsessionåˆ—è¡¨,å¿«é€Ÿåˆ‡æ¢)
