# 1.4.9 åŸç”ŸAnnotation-Popupå…±äº«ä¿¡æ¯å±•ç¤ºæ–¹æ¡ˆ

**åˆ›å»ºæ—¥æœŸ**: 2025-11-19  
**ç›¸å…³æ–‡æ¡£**: 1.4.5, 1.4.8  
**ä¼˜å…ˆçº§**: P1  
**çŠ¶æ€**: ğŸ¤” æ–¹æ¡ˆè®¾è®¡

---

## éœ€æ±‚

åœ¨**åŸç”Ÿ annotation-popup** ä¸‹æ–¹,**4ä¸ªå…±äº«æŒ‰é’®** ä¸‹æ–¹,æ–°å¢ **å…±äº«ä¿¡æ¯åŒº**:
- ğŸ‘¤ ç”¨æˆ·å (è‹¥å·²å…±äº«)
- â¤ï¸ ç‚¹èµæ•° (å¯ç‚¹å‡»æŸ¥çœ‹ç‚¹èµç”¨æˆ·åˆ—è¡¨)
- ğŸ’¬ è¯„è®ºåˆ—è¡¨ (æ˜¾ç¤ºå‰3æ¡,æ”¯æŒå±•å¼€/æŠ˜å )
- ğŸ”— "æŸ¥çœ‹å…¨éƒ¨è¯„è®º" é“¾æ¥ (è·³è½¬åˆ°ç½‘ç«™)

**å‚è€ƒç•Œé¢** (æ¥è‡ª1.4.8):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€åŸç”ŸCommentç¼–è¾‘åŒºã€‘                â”‚ â† ZoteroåŸç”Ÿéƒ¨åˆ†
â”‚  [ç¼–è¾‘æ¡†]                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€å…±äº«æŒ‰é’®åŒºã€‘(å·²å®ç°)              â”‚ â† æ’ä»¶æ³¨å…¥
â”‚  [ç§å¯†] [å…¬å¼€] [åŒ¿å] [å–æ¶ˆ]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€å…±äº«ä¿¡æ¯åŒºã€‘(æœ¬æ¬¡æ–°å¢)            â”‚ â† æœ¬æ–‡æ¡£é‡ç‚¹
â”‚  ğŸ‘¤ å¼ ä¸‰                             â”‚
â”‚  â¤ï¸ 5äººç‚¹èµ  [æŸ¥çœ‹è¯¦æƒ…]            â”‚
â”‚  ğŸ’¬ 3æ¡è¯„è®º                         â”‚
â”‚    - æå››: å¾ˆæœ‰å¸®åŠ©!                â”‚
â”‚    - ç‹äº”: åŒæ„Ÿ                     â”‚
â”‚  [æŸ¥çœ‹å…¨éƒ¨è¯„è®º]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒé—®é¢˜

### Q1: æ³¨å…¥ä½ç½® - åœ¨å“ªé‡Œæ’å…¥å…±äº«ä¿¡æ¯åŒº?

**Zotero åŸç”Ÿ annotation-popup DOMç»“æ„**:
```html
<div class="annotation-popup">
  <div class="comment">
    <div class="editor">
      <div class="content" contenteditable="true" id="5FCS8K7D">
        <!-- ç”¨æˆ·è¾“å…¥çš„comment -->
      </div>
    </div>
  </div>
  
  <div class="preview">
    <!-- é«˜äº®é¢„è§ˆåŒº (annotationText) -->
    
    <!-- ğŸ”‘ æ’ä»¶æ³¨å…¥ç‚¹1: å…±äº«æŒ‰é’®åŒº -->
    <div id="researchopia-annotation-popup-buttons">
      <button data-mode="private">ç§å¯†</button>
      <button data-mode="public">å…¬å¼€</button>
      <button data-mode="anonymous">åŒ¿å</button>
      <button data-mode="null">å–æ¶ˆ</button>
    </div>
    
    <!-- ğŸ”‘ æ’ä»¶æ³¨å…¥ç‚¹2: å…±äº«ä¿¡æ¯åŒº (æœ¬æ¬¡æ–°å¢) -->
    <div id="researchopia-shared-info">
      <!-- è¿™é‡Œæ’å…¥ç‚¹èµã€è¯„è®ºå†…å®¹ -->
    </div>
  </div>
</div>
```

**é€‰æ‹©: `.preview` å®¹å™¨å†…,å…±äº«æŒ‰é’®ä¸‹æ–¹** âœ…

---

### Q2: å®ç°æ–¹å¼ - ç»§ç»­DOMæ³¨å…¥ or HTML Overlay?

#### æ–¹æ¡ˆA: ç»§ç»­DOMæ³¨å…¥ (æ¨è â­â­â­â­â­)

**åŸç†**: åœ¨ `injectButtonsToAnnotationPopup()` ä¸­,åˆ›å»º `<div id="researchopia-shared-info">`,æ’å…¥åˆ°æŒ‰é’®ä¸‹æ–¹

**å®ç°ä½ç½®**: `annotationSharingPopup.ts` Line 750 åæ–°å¢

**ä»£ç ç»“æ„**:
```typescript
// åœ¨ injectButtonsToAnnotationPopup() æœ«å°¾æ·»åŠ 
private async injectSharedInfoToAnnotationPopup(
  popupElement: HTMLElement,
  annotationKey: string,
  doc: Document
): Promise<void> {
  const previewContainer = popupElement.querySelector('.preview') as HTMLElement;
  
  // 1. æ£€æŸ¥æ˜¯å¦å·²æ³¨å…¥
  if (previewContainer.querySelector('#researchopia-shared-info')) {
    return; // å·²å­˜åœ¨,é¿å…é‡å¤
  }
  
  // 2. åˆ›å»ºå®¹å™¨
  const sharedInfoContainer = doc.createElement('div');
  sharedInfoContainer.id = 'researchopia-shared-info';
  sharedInfoContainer.style.cssText = `
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
    font-size: 11px;
    color: #666;
  `;
  
  // 3. å¼‚æ­¥åŠ è½½å…±äº«ä¿¡æ¯
  this.loadSharedInfo(annotationKey, sharedInfoContainer, doc);
  
  // 4. ç«‹å³æ’å…¥ "åŠ è½½ä¸­..." å ä½ç¬¦
  const loadingDiv = doc.createElement('div');
  loadingDiv.textContent = 'â³ åŠ è½½å…±äº«ä¿¡æ¯...';
  loadingDiv.style.cssText = `
    text-align: center;
    color: #999;
    padding: 8px;
  `;
  sharedInfoContainer.appendChild(loadingDiv);
  
  // 5. æ’å…¥åˆ° preview å®¹å™¨
  previewContainer.appendChild(sharedInfoContainer);
}

// åŠ è½½å…±äº«ä¿¡æ¯ (å¼‚æ­¥)
private async loadSharedInfo(
  annotationKey: string,
  container: HTMLElement,
  doc: Document
): Promise<void> {
  try {
    // 1. æŸ¥è¯¢æ ‡æ³¨è¯¦æƒ…
    const params = new URLSearchParams({ /* ... */ });
    const response = await apiClient.get('/api/proxy/annotations', params);
    const annotation = response.data.find(ann => ann.original_id === annotationKey);
    
    if (!annotation) {
      container.innerHTML = '<div style="color: #999;">æœªå…±äº«</div>';
      return;
    }
    
    // 2. æ¸…ç©º "åŠ è½½ä¸­..." å ä½ç¬¦
    container.innerHTML = '';
    
    // 3. æ¸²æŸ“ç”¨æˆ·å
    const authorDiv = doc.createElement('div');
    authorDiv.textContent = `ğŸ‘¤ ${annotation.username || 'åŒ¿åç”¨æˆ·'}`;
    authorDiv.style.cssText = `font-weight: 600; margin-bottom: 6px;`;
    container.appendChild(authorDiv);
    
    // 4. å¹¶è¡ŒæŸ¥è¯¢ç‚¹èµå’Œè¯„è®º
    const [likes, comments] = await Promise.all([
      supabaseManager.getAnnotationLikes(annotation.id),
      supabaseManager.getAnnotationCommentTree(annotation.id)
    ]);
    
    // 5. æ¸²æŸ“ç‚¹èµæ•°
    const likesDiv = doc.createElement('div');
    likesDiv.textContent = `â¤ï¸ ${likes?.length || 0}äººç‚¹èµ`;
    likesDiv.style.cssText = `margin-bottom: 6px; cursor: pointer;`;
    likesDiv.addEventListener('click', () => {
      // TODO: å¼¹å‡ºç‚¹èµç”¨æˆ·åˆ—è¡¨
    });
    container.appendChild(likesDiv);
    
    // 6. æ¸²æŸ“è¯„è®º (å‰3æ¡)
    if (comments && comments.length > 0) {
      const commentsTitle = doc.createElement('div');
      commentsTitle.textContent = `ğŸ’¬ ${this.countTotalComments(comments)}æ¡è¯„è®º`;
      commentsTitle.style.cssText = `font-weight: 600; margin: 8px 0 6px 0;`;
      container.appendChild(commentsTitle);
      
      // æ¸²æŸ“è¯„è®ºåˆ—è¡¨ (å¤ç”¨ PDFReaderCoordinator.renderCommentList)
      this.renderCommentList(comments.slice(0, 3), container, doc);
      
      // "æŸ¥çœ‹å…¨éƒ¨" é“¾æ¥
      if (comments.length > 3) {
        const viewAllLink = doc.createElement('a');
        viewAllLink.textContent = 'æŸ¥çœ‹å…¨éƒ¨è¯„è®º â†’';
        viewAllLink.href = `https://researchopia.com/annotations/${annotation.id}`;
        viewAllLink.target = '_blank';
        viewAllLink.style.cssText = `
          display: block;
          margin-top: 8px;
          color: #3b82f6;
          text-decoration: none;
          font-size: 10px;
        `;
        container.appendChild(viewAllLink);
      }
    } else {
      const noComments = doc.createElement('div');
      noComments.textContent = 'æš‚æ— è¯„è®º';
      noComments.style.cssText = `color: #999; font-style: italic; margin-top: 6px;`;
      container.appendChild(noComments);
    }
    
  } catch (error) {
    logger.error('[AnnotationSharingPopup] Error loading shared info:', error);
    container.innerHTML = '<div style="color: #f87171;">åŠ è½½å¤±è´¥</div>';
  }
}
```

**ä¼˜åŠ¿**:
- âœ… **åŸç”Ÿé›†æˆ**: å…±äº«ä¿¡æ¯ç›´æ¥åœ¨åŸç”Ÿpopupå†…,ç”¨æˆ·ä½“éªŒè¿è´¯
- âœ… **ä»£ç å¤ç”¨**: å¯å¤ç”¨ `PDFReaderCoordinator.renderCommentList()` çš„è¯„è®ºæ¸²æŸ“é€»è¾‘
- âœ… **ç”Ÿå‘½å‘¨æœŸ**: ä¸åŸç”ŸpopupåŒæ­¥,popupå…³é—­åˆ™è‡ªåŠ¨æ¸…ç†
- âœ… **ç®€å•å®ç°**: æ— éœ€å¤„ç†å®šä½ã€z-indexã€ç‚¹å‡»å¤–éƒ¨å…³é—­ç­‰é€»è¾‘

**åŠ£åŠ¿**:
- âš ï¸ **é«˜åº¦é™åˆ¶**: åŸç”Ÿpopupå¯èƒ½æœ‰æœ€å¤§é«˜åº¦é™åˆ¶,è¯„è®ºè¿‡å¤šä¼šæº¢å‡º (å¯æ»šåŠ¨)
- âš ï¸ **æ ·å¼çº¦æŸ**: éœ€åŒ¹é…åŸç”Ÿpopupæ ·å¼,é¿å…è§†è§‰ä¸åè°ƒ

---

#### æ–¹æ¡ˆB: HTML Overlay (ä¸æ¨è âŒ)

**åŸç†**: åœ¨åŸç”Ÿpopupä¸‹æ–¹é¢å¤–åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ HTML div (ç±»ä¼¼ `researchopia-annotation-popup`)

**å®ç°**:
```typescript
// åœ¨åŸç”Ÿpopupä¸‹æ–¹åˆ›å»ºç‹¬ç«‹å®¹å™¨
const overlayContainer = doc.createElement('div');
overlayContainer.className = 'researchopia-shared-info-overlay';
overlayContainer.style.cssText = `
  position: absolute;
  left: ${popupLeft}px;
  top: ${popupBottom + 5}px;
  width: ${popupWidth}px;
  background: white;
  border: 1px solid #d0d0d0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10001; /* æ¯”åŸç”Ÿpopupæ›´é«˜ */
`;
```

**åŠ£åŠ¿**:
- âŒ **å®šä½å¤æ‚**: éœ€æ‰‹åŠ¨è®¡ç®—åŸç”Ÿpopupçš„ä½ç½®å’Œå°ºå¯¸
- âŒ **ç”Ÿå‘½å‘¨æœŸ**: åŸç”Ÿpopupå…³é—­æ—¶,overlayéœ€æ‰‹åŠ¨æ¸…ç† (ç›‘å¬DOMç§»é™¤äº‹ä»¶)
- âŒ **è§†è§‰å‰²è£‚**: ä¸¤ä¸ªç‹¬ç«‹å¼¹çª—,ä½“éªŒä¸å¦‚é›†æˆåœ¨ä¸€èµ·
- âŒ **äº‹ä»¶å†²çª**: ç‚¹å‡»overlayæ—¶,åŸç”Ÿpopupå¯èƒ½æ„å¤–å…³é—­

**å”¯ä¸€ä¼˜åŠ¿**:
- å¯çªç ´åŸç”Ÿpopupçš„é«˜åº¦é™åˆ¶ (ä½†ç”¨æˆ·ä½“éªŒåè€Œæ›´å·®)

---

### Q3: æ€§èƒ½ä¼˜åŒ– - å¦‚ä½•é¿å…é¢‘ç¹æŸ¥è¯¢?

**é—®é¢˜**: æ¯æ¬¡æ‰“å¼€annotation-popupéƒ½åŠ è½½ç‚¹èµå’Œè¯„è®º,å¯èƒ½è¾ƒæ…¢

**è§£å†³ - ç¼“å­˜ç­–ç•¥**:
```typescript
// å¢åŠ å…±äº«ä¿¡æ¯ç¼“å­˜ (5ç§’æœ‰æ•ˆæœŸ)
private sharedInfoCache = new Map<string, {
  likes: any[];
  comments: any[];
  cachedAt: number;
}>();

private async loadSharedInfo(annotationKey: string, container: HTMLElement, doc: Document) {
  const annotation = await this.getAnnotationState(annotationKey); // å¤ç”¨çŠ¶æ€ç¼“å­˜
  if (!annotation) return;
  
  // æ£€æŸ¥ç¼“å­˜
  const cached = this.sharedInfoCache.get(annotation.id);
  if (cached && Date.now() - cached.cachedAt < 5000) {
    logger.log('[AnnotationSharingPopup] Using cached shared info');
    this.renderSharedInfo(cached.likes, cached.comments, container, doc);
    return;
  }
  
  // ç¼“å­˜æœªå‘½ä¸­,æŸ¥è¯¢API
  const [likes, comments] = await Promise.all([
    supabaseManager.getAnnotationLikes(annotation.id),
    supabaseManager.getAnnotationCommentTree(annotation.id)
  ]);
  
  // å­˜å…¥ç¼“å­˜
  this.sharedInfoCache.set(annotation.id, {
    likes,
    comments,
    cachedAt: Date.now()
  });
  
  this.renderSharedInfo(likes, comments, container, doc);
}
```

---

### Q4: ç”¨æˆ·äº¤äº’ - å¦‚ä½•å“åº”ç‚¹èµ/è¯„è®ºæ“ä½œ?

**åœºæ™¯A: ç”¨æˆ·ç‚¹å‡» "â¤ï¸ 5äººç‚¹èµ"**

**æ–¹æ¡ˆ1: æ‰“å¼€æ–°çª—å£** (ç®€å•,æ¨è â­â­â­â­)
```typescript
likesDiv.addEventListener('click', () => {
  const url = `https://researchopia.com/annotations/${annotation.id}#likes`;
  Zotero.launchURL(url); // åœ¨ç³»ç»Ÿæµè§ˆå™¨ä¸­æ‰“å¼€
});
```

**æ–¹æ¡ˆ2: å¼¹å‡ºæ¨¡æ€æ¡†** (å¤æ‚)
```typescript
likesDiv.addEventListener('click', () => {
  this.showLikesModal(annotation.id, doc);
});

private showLikesModal(annotationId: string, doc: Document) {
  // åˆ›å»ºæ¨¡æ€æ¡†,åˆ—å‡ºæ‰€æœ‰ç‚¹èµç”¨æˆ·
  // éœ€è¦å¤„ç†é®ç½©å±‚ã€å…³é—­æŒ‰é’®ã€z-indexç­‰
}
```

**æ¨è**: æ–¹æ¡ˆ1 (æ‰“å¼€æ–°çª—å£,ç”¨æˆ·å¯æŸ¥çœ‹å®Œæ•´ä¿¡æ¯)

---

**åœºæ™¯B: ç”¨æˆ·æƒ³è¦å›å¤è¯„è®º**

**æ–¹æ¡ˆ: è·³è½¬åˆ°ç½‘ç«™**
```typescript
const replyButton = doc.createElement('button');
replyButton.textContent = 'å›å¤';
replyButton.style.cssText = `
  font-size: 10px;
  padding: 2px 6px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
`;
replyButton.addEventListener('click', () => {
  const url = `https://researchopia.com/annotations/${annotation.id}?replyTo=${comment.id}`;
  Zotero.launchURL(url);
});
```

**åŸå› **: åœ¨ Zotero æ’ä»¶å†…å®ç°å®Œæ•´è¯„è®ºç¼–è¾‘å™¨æˆæœ¬è¿‡é«˜,ä¸å¦‚è·³è½¬åˆ°ç½‘ç«™

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. ä»£ç ä½ç½®å’Œè°ƒç”¨æ—¶æœº

**ä¿®æ”¹æ–‡ä»¶**: `zotero-plugin/src/modules/annotationSharingPopup.ts`

**è°ƒç”¨æ—¶æœº**:
```typescript
// Line 750: injectButtonsToAnnotationPopup() æœ«å°¾æ·»åŠ 
private injectButtonsToAnnotationPopup(popupElement: HTMLElement): void {
  // ... ç°æœ‰æŒ‰é’®æ³¨å…¥é€»è¾‘ ...
  
  // ğŸ†• æ³¨å…¥å…±äº«ä¿¡æ¯åŒº
  this.injectSharedInfoToAnnotationPopup(popupElement, annotationKey, doc);
}
```

---

### 2. è¯„è®ºæ¸²æŸ“å¤ç”¨

**é—®é¢˜**: `PDFReaderCoordinator.renderCommentList()` æ˜¯ç§æœ‰æ–¹æ³•,æ— æ³•ç›´æ¥è°ƒç”¨

**è§£å†³æ–¹æ¡ˆA: æå–ä¸ºå·¥å…·å‡½æ•°** (æ¨è â­â­â­â­)
```typescript
// æ–°å»ºæ–‡ä»¶: zotero-plugin/src/modules/ui/utils/CommentRenderer.ts
export class CommentRenderer {
  static renderCommentList(
    comments: any[],
    container: HTMLElement,
    doc: Document,
    options?: {
      maxDepth?: number;    // æœ€å¤§åµŒå¥—å±‚çº§ (é»˜è®¤3)
      maxComments?: number; // æœ€å¤šæ˜¾ç¤ºè¯„è®ºæ•° (é»˜è®¤10)
    }
  ): void {
    // å¤åˆ¶ PDFReaderCoordinator.renderCommentList() çš„é€»è¾‘
  }
}
```

**åœ¨ä¸¤å¤„ä½¿ç”¨**:
1. `PDFReaderCoordinator.ts` Line 670-710: è°ƒç”¨ `CommentRenderer.renderCommentList()`
2. `annotationSharingPopup.ts` (æ–°å¢): è°ƒç”¨ `CommentRenderer.renderCommentList()`

**è§£å†³æ–¹æ¡ˆB: ç›´æ¥å¤åˆ¶ä»£ç ** (å¿«é€Ÿä½†ä¸ä¼˜é›…)
```typescript
// åœ¨ annotationSharingPopup.ts ä¸­å¤åˆ¶ renderCommentList() æ–¹æ³•
private renderCommentList(comments: any[], container: HTMLElement, doc: Document, depth = 0) {
  // ä¸ PDFReaderCoordinator.renderCommentList() å®Œå…¨ç›¸åŒçš„å®ç°
}
```

**æ¨è**: æ–¹æ¡ˆA (æå–å·¥å…·å‡½æ•°,é¿å…ä»£ç é‡å¤)

---

### 3. æ ·å¼è®¾è®¡

**è®¾è®¡åŸåˆ™**:
- ä¸åŸç”Ÿpopupæ ·å¼ä¿æŒä¸€è‡´ (å­—ä½“ã€é¢œè‰²ã€é—´è·)
- ä½¿ç”¨å›¾æ ‡ (ğŸ‘¤â¤ï¸ğŸ’¬) å¢å¼ºå¯è¯»æ€§
- ç‚¹å‡»åŒºåŸŸå¢åŠ è§†è§‰åé¦ˆ (hoveræ•ˆæœ)

**å‚è€ƒæ ·å¼**:
```typescript
// æ•´ä½“å®¹å™¨
sharedInfoContainer.style.cssText = `
  margin-top: 12px;
  padding: 12px 0 0 0;
  border-top: 1px solid #e0e0e0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  font-size: 11px;
  line-height: 1.4;
  color: #666;
`;

// ç”¨æˆ·å
authorDiv.style.cssText = `
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
  font-size: 12px;
`;

// ç‚¹èµæ•° (å¯ç‚¹å‡»)
likesDiv.style.cssText = `
  margin-bottom: 6px;
  cursor: pointer;
  color: #666;
  transition: color 0.2s;
`;
likesDiv.addEventListener('mouseenter', () => {
  likesDiv.style.color = '#f87171'; // çº¢è‰²
});
likesDiv.addEventListener('mouseleave', () => {
  likesDiv.style.color = '#666';
});

// è¯„è®ºé¡¹
commentDiv.style.cssText = `
  margin-left: ${depth * 16}px;
  margin-bottom: 6px;
  padding: 6px;
  background: ${depth === 0 ? '#f9f9f9' : '#ffffff'};
  border-radius: 3px;
  font-size: 11px;
  line-height: 1.3;
`;
```

---

## æœ€ç»ˆæ–¹æ¡ˆ

### âœ… æ¨è: DOMæ³¨å…¥åˆ°åŸç”Ÿpopupå†…

**å®ç°æ­¥éª¤**:

1. **Phase 1: åŸºç¡€æ¸²æŸ“** (1å¤©)
   - [ ] åˆ›å»º `injectSharedInfoToAnnotationPopup()` æ–¹æ³•
   - [ ] æ’å…¥ `<div id="researchopia-shared-info">` åˆ° `.preview` å®¹å™¨
   - [ ] æ˜¾ç¤º "â³ åŠ è½½ä¸­..." å ä½ç¬¦

2. **Phase 2: æ•°æ®åŠ è½½** (1å¤©)
   - [ ] å®ç° `loadSharedInfo()` å¼‚æ­¥æŸ¥è¯¢ç‚¹èµå’Œè¯„è®º
   - [ ] æ¸²æŸ“ç”¨æˆ·åã€ç‚¹èµæ•°
   - [ ] æ·»åŠ ç¼“å­˜æœºåˆ¶ (5ç§’æœ‰æ•ˆæœŸ)

3. **Phase 3: è¯„è®ºæ¸²æŸ“** (1å¤©)
   - [ ] æå– `CommentRenderer.renderCommentList()` ä¸ºå·¥å…·å‡½æ•°
   - [ ] æ¸²æŸ“å‰3æ¡è¯„è®º (æ”¯æŒåµŒå¥—)
   - [ ] æ·»åŠ  "æŸ¥çœ‹å…¨éƒ¨è¯„è®º" é“¾æ¥

4. **Phase 4: äº¤äº’ä¼˜åŒ–** (0.5å¤©)
   - [ ] ç‚¹å‡»ç‚¹èµæ•° â†’ æ‰“å¼€ç½‘ç«™æŸ¥çœ‹è¯¦æƒ…
   - [ ] ç‚¹å‡»è¯„è®º "å›å¤" â†’ è·³è½¬ç½‘ç«™
   - [ ] æ·»åŠ  hover æ•ˆæœå’ŒåŠ è½½åŠ¨ç”»

5. **Phase 5: æµ‹è¯•å’Œä¼˜åŒ–** (0.5å¤©)
   - [ ] æµ‹è¯•é•¿è¯„è®ºåˆ—è¡¨çš„æ»šåŠ¨
   - [ ] æµ‹è¯•ç¼“å­˜æœ‰æ•ˆæ€§
   - [ ] æµ‹è¯•åŸç”Ÿpopupå…³é—­æ—¶çš„æ¸…ç†

**æ€»è®¡**: 4å¤©å·¥ä½œé‡

---

### âŒ ä¸æ¨è: HTML Overlayæ–¹æ¡ˆ

**ç†ç”±**:
- å®šä½å¤æ‚,ç”Ÿå‘½å‘¨æœŸç®¡ç†ç¹ç
- è§†è§‰å‰²è£‚,ç”¨æˆ·ä½“éªŒå·®
- æ— æ˜æ˜¾ä¼˜åŠ¿,å¾’å¢å¤æ‚åº¦

---

## å…³é”®å†³ç­–

### å†³ç­–1: ä¸ºä»€ä¹ˆä¸åœ¨å…±äº«æŒ‰é’®ä¸Šæ–¹æ’å…¥?

**é—®é¢˜**: å…±äº«ä¿¡æ¯æ’åœ¨æŒ‰é’®ä¸‹æ–¹,ç”¨æˆ·éœ€æ»šåŠ¨æ‰èƒ½çœ‹åˆ°

**åˆ†æ**:
- æ’åœ¨æŒ‰é’®ä¸Šæ–¹ â†’ æŒ‰é’®ä½ç½®ä¼šå˜åŒ–,ç”¨æˆ·ç‚¹å‡»æ—¶éœ€é‡æ–°å®šä½ (ä½“éªŒå·®)
- æ’åœ¨æŒ‰é’®ä¸‹æ–¹ â†’ æŒ‰é’®ä½ç½®å›ºå®š,å…±äº«ä¿¡æ¯å¯æ»šåŠ¨æŸ¥çœ‹ (æ›´åˆç†)

**ç»“è®º**: æŒ‰é’®ä¸‹æ–¹æ’å…¥ âœ…

---

### å†³ç­–2: æ˜¯å¦æ”¯æŒç›´æ¥ç‚¹èµ?

**æ–¹æ¡ˆA: æ”¯æŒç›´æ¥ç‚¹èµ** (å¤æ‚)
```typescript
likesDiv.innerHTML = `
  â¤ï¸ ${likesCount}äººç‚¹èµ 
  <button style="...">ç‚¹èµ</button>
`;

likeButton.addEventListener('click', async () => {
  await supabaseManager.likeAnnotation(annotation.id);
  likesCount++;
  likesDiv.textContent = `â¤ï¸ ${likesCount}äººç‚¹èµ`;
});
```

**æ–¹æ¡ˆB: ä»…æ˜¾ç¤ºæ•°é‡,è·³è½¬ç½‘ç«™æ“ä½œ** (ç®€å•,æ¨è)
```typescript
likesDiv.textContent = `â¤ï¸ ${likesCount}äººç‚¹èµ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)`;
likesDiv.addEventListener('click', () => {
  Zotero.launchURL(`https://researchopia.com/annotations/${annotation.id}`);
});
```

**æ¨è**: æ–¹æ¡ˆB
- å®ç°ç®€å•,æ— éœ€å¤„ç†ç‚¹èµçŠ¶æ€åŒæ­¥
- ç”¨æˆ·å¯åœ¨ç½‘ç«™æŸ¥çœ‹å®Œæ•´ä¿¡æ¯ (è°ç‚¹çš„èµã€æ—¶é—´ç­‰)
- æ’ä»¶èŒè´£èšç„¦:æ ‡æ³¨ç®¡ç†,ç½‘ç«™èŒè´£:ç¤¾äº¤äº’åŠ¨

---

### å†³ç­–3: æ˜¾ç¤ºå¤šå°‘æ¡è¯„è®º?

**é€‰é¡¹**:
- æ˜¾ç¤º1æ¡ â†’ ä¿¡æ¯ä¸è¶³
- æ˜¾ç¤º3æ¡ â†’ âœ… å¹³è¡¡ (æ¨è)
- æ˜¾ç¤ºå…¨éƒ¨ â†’ popupè¿‡é•¿,æ»šåŠ¨ä½“éªŒå·®

**æ¨è**: æ˜¾ç¤ºå‰3æ¡ + "æŸ¥çœ‹å…¨éƒ¨" é“¾æ¥

---

## æ½œåœ¨é—®é¢˜

### é—®é¢˜1: åŸç”Ÿpopupé«˜åº¦é™åˆ¶

**ç°è±¡**: è¯„è®ºè¿‡å¤šæ—¶,å…±äº«ä¿¡æ¯åŒºè¶…å‡ºpopupé«˜åº¦

**è§£å†³**:
```typescript
// ä¸º popup æ·»åŠ  max-height å’Œ overflow-y
const popup = doc.querySelector('.annotation-popup') as HTMLElement;
if (popup) {
  popup.style.maxHeight = '400px'; // é™åˆ¶æœ€å¤§é«˜åº¦
  popup.style.overflowY = 'auto';  // å…è®¸æ»šåŠ¨
}
```

---

### é—®é¢˜2: ç¼“å­˜å¤±æ•ˆæ—¶æœº

**åœºæ™¯**: ç”¨æˆ·åœ¨ç½‘ç«™æ·»åŠ è¯„è®ºå,å›åˆ°æ’ä»¶,ç¼“å­˜æœªæ›´æ–°

**è§£å†³**:
- ç¼“å­˜æœ‰æ•ˆæœŸ: 5ç§’ (çŸ­æœŸç¼“å­˜,å¿«é€Ÿå¤±æ•ˆ)
- æ‰‹åŠ¨åˆ·æ–°: ç”¨æˆ·å…³é—­popupå†æ‰“å¼€,è‡ªåŠ¨é‡æ–°åŠ è½½
- æœªæ¥: Supabase Realtime æ¨é€æ›´æ–°,ä¸»åŠ¨æ¸…é™¤ç¼“å­˜

---

### é—®é¢˜3: è½®è¯¢æ£€æµ‹çš„æ€§èƒ½

**å½“å‰**: 200msè½®è¯¢æ£€æµ‹ `.annotation-popup`

**ä¼˜åŒ–**:
- åªåœ¨æ£€æµ‹åˆ°popupæ—¶,æ‰§è¡Œä¸€æ¬¡ `injectSharedInfoToAnnotationPopup()`
- é¿å…é‡å¤æ³¨å…¥ (é€šè¿‡ `#researchopia-shared-info` æ£€æŸ¥)

---

## å‚è€ƒèµ„æ–™

- **å½“å‰å…±äº«æŒ‰é’®å®ç°**: `annotationSharingPopup.ts` Line 554-750
- **è¯„è®ºæ¸²æŸ“é€»è¾‘**: `PDFReaderCoordinator.ts` Line 670-710
- **SupabaseæŸ¥è¯¢æ–¹æ³•**: `supabase.ts` - `getAnnotationLikes()`, `getAnnotationCommentTree()`
- **1.4.5æ–‡æ¡£**: è¯¦ç»†UIè®¾è®¡å’Œå®ç°è®¡åˆ’
- **1.4.8æ–‡æ¡£**: æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸå’Œç®¡ç†ç•Œé¢è®¾è®¡

---

**æœ€ç»ˆç»“è®º**: 
- **æ¨èæ–¹æ¡ˆ: DOMæ³¨å…¥åˆ°åŸç”Ÿpopupå†…** â­â­â­â­â­
- ä»£ç ä½ç½®: `injectButtonsToAnnotationPopup()` æœ«å°¾è°ƒç”¨ `injectSharedInfoToAnnotationPopup()`
- å…³é”®æŠ€æœ¯: å¼‚æ­¥åŠ è½½ + ç¼“å­˜ + å¤ç”¨ `CommentRenderer` å·¥å…·å‡½æ•°
- ç”¨æˆ·äº¤äº’: ç‚¹å‡»è·³è½¬ç½‘ç«™ (ä¸åœ¨æ’ä»¶å†…å®ç°å®Œæ•´ç¤¾äº¤åŠŸèƒ½)
- å·¥ä½œé‡: 4å¤© (åŸºç¡€æ¸²æŸ“ â†’ æ•°æ®åŠ è½½ â†’ è¯„è®ºæ¸²æŸ“ â†’ äº¤äº’ä¼˜åŒ– â†’ æµ‹è¯•)
