# Researchopia 项目结构与优化判断（7.2）

**日期**: 2025-11-15 | **作者**: Copilot

> 参考文档: `docs/ARCHITECTURE.md`, `docs/docs-dev/7.1-PROJECT_CODE_QUALITY_ASSESSMENT.md`, `docs/CODE_QUALITY_CHECKLIST.md`

---

## 1. 当前结构概览

- **Monorepo**: Next.js 网站、Zotero 插件、浏览器扩展、`@researchopia/shared` 工具库共享同一仓库与脚本。
- **Next.js 网站**: App Router + Supabase 代理 API，UI/逻辑分层逐步稳定，核心页面已拆分为 <300 行组件但部分 API 仍存在 `v1/v2/proxy` 并存。
- **Zotero 插件**: MVC + Service 分层，`supabaseManager`、`readingSessionManager` 等核心模块拆分完成，但 PDF v1/v2 双栈、旧事件流程尚在退场期。
- **浏览器扩展**: Manifest V3 + 原生 JS，结构最轻量，浮动入口/侧边栏模块划分清晰。
- **共享库**: `packages/shared` 集中邮箱/DOI/API 工具，已被三端消费，解决 ~170 行重复代码。

## 2. 代码质量快照

| 组件 | 亮点 | 主要风险 |
|------|------|----------|
| Next.js 网站 | 页面组件化、数据库仓储层拆分、文件大小监控脚本上线 | API 目录混乱、缺少自动化测试/监控、少量服务端工具>300行临界 |
| Zotero 插件 | 核心管理器模块化、会话/认证流程可测试、文档充分 | pdfReaderManager v1 残留 1500+ 行、PDF/会话轮询未统一、事件广播缺回归测试 |
| 浏览器扩展 | 文件短小、职责单一、配置中心化 | 仍为 Vanilla JS，缺少 TS + Vite 构建与单元测试 |
| Shared 库 | 纯函数、d.ts 全量输出、Tree-shaking 支持 | 未建立版本规范与自动发布流程 |

## 3. 是否需要整体优化?

**结论**: 需要继续推进。虽然「超标文件」数量从 17 降至 7，结构基本健康，但以下系统性问题阻碍后续扩展：

1. **API 层割裂**: v1/v2/proxy 共存导致客户端调用分散，易出现重复逻辑与权限缺口。
2. **测试/监控为零**: 三端（尤其插件）完全依赖手测，任何重构都存在回归风险。
3. **插件遗留代码**: PDF v1/v2 双栈+老事件系统尚未清理，阻碍 TS 类型收敛与调试。
4. **扩展缺工程化支撑**: 未迁移 TS/Vite，未来功能增长会迅速失控。
5. **共享库流程缺失**: 无语义版本与自动发布，跨端升级需手动 `file:` 引用。

因此，需要一轮「架构收口 + 测试/自动化补全」的整体优化，避免在功能继续扩展后成本陡增。

## 4. 建议的优化方向（按优先级）

1. **API 收口（P0）**
   - 统一到 `/api/proxy/v2/*`，提供 typed client；清理 legacy v1/test 端点。
   - 在 `packages/shared` 暴露 API schema，减少三端重复校验。
2. **测试与监控（P0）**
   - Next.js: 配置 Vitest + Testing Library 覆盖核心 hooks/组件。
   - Zotero 插件: 至少为 session/auth 核心模块补充 Jest 单测 + 集成 log 报告。
   - 浏览器扩展: 引入 Playwright 端到端冒烟脚本（检测 DOI → 打开侧边栏）。
3. **插件遗留治理（P1）**
   - 完成 pdfReaderManager v1 → v2 迁移，移除 1500 行 deprecated 代码。
   - 将轮询/事件广播改为统一的 Realtime 通道或抽象接口，便于测试。
4. **扩展工程化升级（P1）**
   - 迁移至 TypeScript + Vite 构建，拆分 background/content/popup 的 shared helpers。
5. **共享库发布流程（P2）**
   - 引入 changeset + npm 内部 registry，三端通过 semver 升级，避免手动 `file:` 链接。

## 5. 下一步行动快照

| 时间 | 行动 | 负责人建议 |
|------|------|------------|
| +1 周 | 完成 API 目录收敛 + typed client 草稿 | Next.js 团队 |
| +2 周 | 为 session/auth 模块补 5+ 单测，接入 Vitest/Jest | 共用 Infra |
| +3 周 | 替换 Zotero PDF v1，封存旧模块 | 插件团队 |
| +4 周 | 浏览器扩展迁移至 TS + Vite，补 smoke test | 扩展团队 |

## 6. 即时治理记录

- 2025-11-15: 将 `docs/scripts` 与根 `scripts/` 合并，所有版本脚本统一使用 `scripts/check-versions.js`、`scripts/sync-versions.js`，并移除了冗余目录。
- 2025-11-15: 将版本管理指南迁移至 `scripts/VERSION_MANAGEMENT_GUIDE.md`，并删除 `docs/scripts` 目录，确保脚本与文档同域维护。
- 2025-11-15: 新增 `scripts/README.md`，统一列出版本脚本和 Changesets 命令速查。
- 2025-11-15: 新增 `scripts/check-email-config.js`，提供 SMTP 配置完整性体检，补齐 `npm run check-email` 脚本缺失的实现。
- 2025-11-15: 新增 `scripts/check-changeset.js` 与 `npm run changeset:check`，在 `packages/*` 发生改动时强制提醒补充 Changeset。
- 2025-11-15: 引入 Changesets (`npm run changeset`/`release:version`/`release:publish`) 管理 `packages/shared` 等 npm 包发布，配置位于 `.changeset/config.json`。
- 2025-11-15: `@researchopia/shared` 接入 Vitest（`npm run shared:test`），首批覆盖 DOI、Auth、API Client 与 Constants 工具集合的单元测试到位。
- 2025-11-15: `npm run check:quality` 现包含 `shared:test`，默认质量检查即运行共享库单元测试。

---

**备注**: 本文档限制 <1000 行，若需详细数据请参考 `docs/docs-dev/7.1-PROJECT_CODE_QUALITY_ASSESSMENT.md`。