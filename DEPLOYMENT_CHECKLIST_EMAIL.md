# 邮箱验证体系部署检查清单

## 部署前准备

### 1. API密钥申请
- [ ] Google reCAPTCHA v3
  - [ ] 访问 https://www.google.com/recaptcha/admin
  - [ ] 创建新站点（选择reCAPTCHA v3）
  - [ ] 添加域名到白名单
  - [ ] 获取站点密钥和密钥
  
- [ ] Abstract API（邮箱验证）
  - [ ] 访问 https://www.abstractapi.com/email-validation-api
  - [ ] 注册账户并获取API密钥
  - [ ] 测试API调用限制
  
- [ ] SendGrid（SMTP服务）
  - [ ] 访问 https://sendgrid.com/
  - [ ] 创建账户并验证邮箱
  - [ ] 创建API密钥
  - [ ] 配置发送域名验证

### 2. 环境变量配置
- [ ] 复制 `.env.example` 到 `.env.local`
- [ ] 填入所有必需的API密钥
- [ ] 验证配置格式正确性

### 3. 依赖安装
- [ ] 运行 `npm install` 安装新依赖
- [ ] 检查package.json中的新包
- [ ] 验证TypeScript类型定义

## 功能测试

### 1. reCAPTCHA测试
- [ ] 访问注册页面
- [ ] 验证reCAPTCHA脚本加载
- [ ] 测试表单提交时的验证
- [ ] 检查控制台无错误信息

### 2. 邮箱验证测试
- [ ] 测试有效教育邮箱
  - [ ] 输入 `test@pku.edu.cn`
  - [ ] 验证显示绿色勾选
  - [ ] 确认可投递性检查
  
- [ ] 测试无效邮箱
  - [ ] 输入 `test@gmail.com`
  - [ ] 验证显示错误信息
  - [ ] 确认建议邮箱功能
  
- [ ] 测试一次性邮箱
  - [ ] 输入 `test@10minutemail.com`
  - [ ] 验证被正确拒绝

### 3. SMTP服务测试
- [ ] 使用测试API验证SMTP配置
  ```bash
  curl -X POST http://localhost:3000/api/test/email-validation \
    -H "Content-Type: application/json" \
    -d '{"email":"test@edu.cn","testType":"smtp"}'
  ```
- [ ] 检查返回结果中的SMTP状态

### 4. 完整注册流程测试
- [ ] 使用真实教育邮箱注册
- [ ] 验证收到自定义验证邮件
- [ ] 检查邮件内容和格式
- [ ] 测试验证链接功能

## 性能测试

### 1. 响应时间测试
- [ ] 邮箱验证API响应时间 < 2秒
- [ ] reCAPTCHA验证响应时间 < 1秒
- [ ] 注册流程总时间 < 5秒

### 2. 并发测试
- [ ] 模拟10个并发注册请求
- [ ] 验证系统稳定性
- [ ] 检查限流机制工作正常

### 3. 错误处理测试
- [ ] 网络超时情况
- [ ] API服务不可用情况
- [ ] 无效API密钥情况

## 监控设置

### 1. 健康检查
- [ ] 访问 `/api/health-check`
- [ ] 验证所有组件状态为正常
- [ ] 检查邮件系统统计信息

### 2. 统计监控
- [ ] 访问 `/api/admin/email-stats`（需要admin token）
- [ ] 验证邮件发送统计
- [ ] 检查退回率监控

### 3. 告警设置
- [ ] 配置退回率告警阈值
- [ ] 设置API服务异常告警
- [ ] 配置SMTP服务监控

## 生产环境部署

### 1. 环境变量设置
- [ ] 在部署平台设置所有环境变量
- [ ] 验证密钥安全性（不在日志中暴露）
- [ ] 测试生产环境配置

### 2. DNS和域名配置
- [ ] 配置发送邮箱域名
- [ ] 设置SPF记录
- [ ] 配置DKIM签名
- [ ] 验证域名解析

### 3. SSL证书
- [ ] 确保HTTPS正常工作
- [ ] 验证reCAPTCHA在HTTPS下正常
- [ ] 测试邮件链接HTTPS跳转

## 安全检查

### 1. API安全
- [ ] 验证API密钥不在客户端暴露
- [ ] 检查限流机制工作正常
- [ ] 测试异常请求处理

### 2. 邮件安全
- [ ] 验证邮件模板无XSS风险
- [ ] 检查邮件链接安全性
- [ ] 测试邮件头部信息

### 3. 数据保护
- [ ] 验证敏感数据加密
- [ ] 检查日志信息脱敏
- [ ] 测试数据清理机制

## 用户体验测试

### 1. 界面测试
- [ ] 验证加载状态显示
- [ ] 测试错误信息友好性
- [ ] 检查成功状态反馈

### 2. 移动端测试
- [ ] 在手机浏览器测试注册
- [ ] 验证reCAPTCHA移动端体验
- [ ] 测试邮件在移动端显示

### 3. 多浏览器测试
- [ ] Chrome浏览器测试
- [ ] Firefox浏览器测试
- [ ] Safari浏览器测试
- [ ] Edge浏览器测试

## 文档和培训

### 1. 技术文档
- [ ] 更新API文档
- [ ] 编写故障排除指南
- [ ] 创建监控仪表板说明

### 2. 运维文档
- [ ] 编写部署流程文档
- [ ] 创建应急响应预案
- [ ] 准备常见问题解答

## 上线后监控

### 1. 第一周监控重点
- [ ] 每日检查邮件发送统计
- [ ] 监控退回率变化
- [ ] 收集用户反馈

### 2. 性能指标监控
- [ ] 注册成功率
- [ ] 邮箱验证准确率
- [ ] 系统响应时间

### 3. 问题跟踪
- [ ] 记录所有异常情况
- [ ] 分析失败原因
- [ ] 持续优化改进

## 回滚计划

### 1. 回滚触发条件
- [ ] 注册成功率低于90%
- [ ] 邮件退回率高于10%
- [ ] 系统响应时间超过10秒

### 2. 回滚步骤
- [ ] 禁用新的邮箱验证体系
- [ ] 恢复Supabase默认邮件服务
- [ ] 通知用户系统维护

### 3. 问题修复
- [ ] 分析回滚原因
- [ ] 修复相关问题
- [ ] 重新测试后再次部署

---

## 检查清单完成确认

- [ ] 所有测试项目已完成
- [ ] 生产环境配置已验证
- [ ] 监控系统已就绪
- [ ] 团队已完成培训
- [ ] 应急预案已准备

**部署负责人签名：** ________________

**部署日期：** ________________

**版本号：** ________________
