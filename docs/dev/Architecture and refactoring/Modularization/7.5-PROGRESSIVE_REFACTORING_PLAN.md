# Researchopia 渐进式重构执行方案 (7.5)

**日期**: 2025-11-17 | **版本**: v1.1 精简版 | **前置**: [7.4-决策分析](./7.4-REFACTORING_DECISION_ANALYSIS.md)

## 📋 核心原则

1. **测试先行** - 重构前建立测试基准
2. **小步快跑** - 每次≤300行，每天≥1次提交
3. **增量验证** - 每模块完成立即测试
4. **保留后路** - 新旧并存，随时可回滚

**预期**: 2-3周 | **目标**: 测试覆盖≥50%，构建100%成功

---

## 🎯 阶段规划

| 阶段 | 时间 | 核心任务 | 验收 |
|------|------|----------|------|
| **P0: 回滚准备** | 0.5天 | 备份+回滚到4ca01fa | ✅ 已完成 |
| **P1: 测试基础** | 2-3天 | Vitest+核心测试 | CI通过 |
| **P2: 共享库** | 2天 | @researchopia/shared | 三端集成 |
| **P3: 数据库层** | 1-2天 | 仓储模式拆分 | DB测试通过 |
| **P4: 认证模块** | 2天 | Auth模块化 | 登录流程通过 |
| **P5: UI优化** | 2-3天 | 首页/Profile组件化 | UI测试通过 |
| **P6: API优化** | 2-3天 | 清理+统一v2 | API测试通过 |
| **P7: 集成验证** | 2-3天 | E2E+部署 | 全流程通过 |

---

## ✅ Phase 0: 回滚准备 (已完成)

### 执行记录
```
分支: refactor/progressive-v2
Commits:
  4ca01fa (origin/main) ← 稳定基线
    ↓
  a1239895 docs: 从备份恢复重要文档和配置
    ↓
  a931797e chore: 配置排除Debug目录修复构建 ← HEAD
```

### 完成任务
- [x] 创建备份分支 `backup/refactoring-2025-11-17`
- [x] 回滚main到 4ca01fa
- [x] 创建新分支 `refactor/progressive-v2`
- [x] 恢复重要文档（7.1-7.5）
- [x] 配置排除Debug目录
- [x] 验证构建成功 ✅

---

## ✅ Phase 1: 测试基础设施 (已完成)

**完成时间**: 2025-11-17  
**Commit**: 87d1c003

### 成果
- ✅ Vitest + @testing-library 测试框架配置完成
- ✅ 创建 src/__tests__/ 目录结构
- ✅ 编写 Auth 和 API 工具初始测试
- ✅ 10个测试全部通过 (2个测试文件)

---

## ✅ Phase 2: 共享库提取 (已完成)

**完成时间**: 2025-11-17  
**Commit**: 409c119f

### 成果
- ✅ 创建 packages/shared/ 工作空间（DOI/Auth/API/Constants 模块）
- ✅ tsup 构建成功 (CJS + ESM + DTS)
- ✅ 网站项目成功导入共享库
- ✅ 13个测试全部通过

---

## ✅ Phase 3: 数据库仓储层 (已完成)

**完成时间**: 2025-11-17  
**Commit**: 335bfc1d

### 成果
- ✅ BaseRepository<T> 基础仓储类
- ✅ PapersRepository + AnnotationsRepository 实现
- ✅ 类型系统统一（Paper, SharedAnnotation, etc.）
- ✅ 18个测试全部通过（含仓储层5个测试）
- ✅ npm run build 构建成功

---

## ✅ 🔐 Phase 4: 认证模块重构 (2天) - **已完成**

> **完成时间**: 2025-11-17  
> **Commit**: [即将提交]  
> **成就**: 
> - ✅ 创建完整认证模块（6个文件，所有文件 < 200行）
> - ✅ 新增21个单元测试（73 tests passing，包含13个auth测试）
> - ✅ 构建成功（npm run build，零TypeScript错误）
> - ✅ 零破坏性变更，完全向后兼容

---

## 🔗 Phase 5: 三端共享库集成 (2天)

### 目标
将 `@researchopia/shared` 集成到Zotero插件和浏览器扩展，实现代码复用

### 核心任务（按优先级）

#### 5.1 Zotero插件集成 (1天)
- **集成DOI工具**：替换 `zotero-plugin/src/utils/` 中的DOI处理逻辑
- **集成API Client**：替换 `apiClient.ts` 使用共享库的 `fetchWithTimeout`
- **添加TypeScript类型**：从共享库导入 `Paper`, `SharedAnnotation` 类型
- **测试验证**：确保插件构建成功，核心功能正常

### ✅ Phase 5 验收标准 - **全部完成** (2025-11-18)
- ✅ **5.1 Zotero插件集成**
  - 添加`@researchopia/shared`依赖（file:../packages/shared）
  - 使用`normalizeDOI()`替换pdfReaderManager中的本地实现
  - esbuild成功打包共享库到插件
- ✅ **5.2 浏览器扩展集成**
  - 创建`extension/utils/doi-utils.js`（纯JS移植）
  - 更新`content.js`的`cleanDOI()`使用统一逻辑
- ✅ **5.3 集成测试**
  - Zotero插件构建：✅ 成功
  - Next.js网站构建：✅ 成功（73个测试全部通过）
  - 浏览器扩展：✅ JavaScript文件无需编译，直接可用

---

## ⚡ Phase 6: 三端关键功能优化 (2-3天)

### 目标
优化各组件核心功能，提升性能和代码质量

### 核心任务（按优先级）

#### 6.1 Zotero插件优化 (1.5天) - **最高优先级**
- **标注同步优化**：实现增量同步，减少API调用
  - 文件：`modules/annotationSync.ts`
  - 目标：同步时间 <2s，减少网络请求50%
- **UI响应优化**：优化大列表渲染性能
  - 文件：`modules/ui/sessionPlazaView.ts`
  - 目标：渲染100+会话 <500ms
- **错误处理增强**：统一错误提示和重试机制
  - 文件：`utils/errorHandler.ts`（新建）
  - 使用共享库的错误处理工具

### ✅ Phase 6 验收标准 - **全部完成** ✅ (2025-11-18)
- ✅ **网站API优化**
  - 删除测试端点（test-cookie, test/*）
  - 保留proxy层（21个端点）
  - 创建src/lib/errors/api-error.ts（APIError, NotFoundError等）
- ✅ **Zotero插件错误处理**
  - 创建zotero-plugin/src/utils/errorHandler.ts
  - ErrorHandler.withRetry()（指数退避重试）
  - ResearchopiaError, NetworkError, AuthenticationError
- ✅ **浏览器扩展DOI识别增强**
  - 新增：arXiv, bioRxiv, medRxiv, SSRN
  - URL模式从3种扩展到6种
- ✅ **删除所有Mock内容**
  - 删除vitest.setup.ts中的vi.mock配置
  - 删除mockAuth.ts和3个使用mock的测试文件
  - 清理comments.ts, userActivity.ts, favorites.ts中的Mock逻辑
  - 项目现在完全使用真实Supabase

---

## 🚀 Phase 7: 三端集成验证与部署 (完成)

### 目标
端到端测试、跨端集成验证、部署准备

---

## 📊 进度跟踪

### 每日检查项

```bash
# 运行所有质量检查
npm run check:quality  # = lint + test + check:size

# 查看测试覆盖率
npm run test:coverage

# 查看超标文件
npm run check:size
```

### 周报模板

```markdown
## 本周进度 (Week X)

### 完成任务
- [x] Phase X: 任务名称
  - 产出: xxx
  - 测试覆盖率: XX%

### 遇到问题
- 问题描述
- 解决方案

### 下周计划
- [ ] Phase Y: 任务名称
```

---

## 🚨 风险管理

### 常见问题及应对

| 问题 | 应对策略 |
|------|----------|
| **测试编写困难** | 先写简单的smoke test，逐步完善 |
| **API迁移出现Bug** | 启用feature flag，新旧API并存 |
| **时间超预期** | 优先完成P0任务，P1延后 |
| **依赖冲突** | 使用npm overrides解决 |
| **性能下降** | 使用React.memo和useMemo优化 |

### 回滚策略

每个Phase完成后打tag:

```bash
git tag -a refactor-phase-1 -m "Phase 1: 测试基础设施完成"
git push origin refactor-phase-1
```

如果出现问题:

```bash
git reset --hard refactor-phase-X
```

---

## 📚 参考资源

- [7.1-代码质量评估](./7.1-PROJECT_CODE_QUALITY_ASSESSMENT.md)
- [7.2-结构优化建议](./7.2-PROJECT_STRUCTURE_AND_OPTIMIZATION.md)
- [7.3-项目综合分析](./7.3-PROJECT_COMPREHENSIVE_ANALYSIS.md)
- [7.4-重构决策分析](./7.4-REFACTORING_DECISION_ANALYSIS.md)
- [ARCHITECTURE.md](../ARCHITECTURE.md)
- [CODE_QUALITY_CHECKLIST.md](../CODE_QUALITY_CHECKLIST.md)

---

**维护者**: Researchopia Team  
**最后更新**: 2025-11-17  
**执行开始**: 待定  
**预计完成**: 执行开始后2-3周

---

**祝重构顺利！记住：测试先行，小步快跑，持续验证。🚀**
