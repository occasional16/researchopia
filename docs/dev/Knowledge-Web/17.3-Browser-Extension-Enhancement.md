# æ–‡æ¡£ 17.3: æµè§ˆå™¨æ‰©å±•åŠŸèƒ½å¢å¼º

**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
**ç‰ˆæœ¬**: v0.2  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-14  
**æ›´æ–°æ—¥æœŸ**: 2025-01-15  
**å…³è”æ–‡æ¡£**: [17-Unified-Rating-System.md](./17-Unified-Rating-System.md), [17.2-Evaluation-Components-Extraction.md](./17.2-Evaluation-Components-Extraction.md), [17.4-extension-modular-refactor-plan.md](./17.4-extension-modular-refactor-plan.md)

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”ç½‘é¡µè¯¦æƒ…é¡µ (`src/app/webpages/[urlHash]/page.tsx`) å’Œæµè§ˆå™¨æ‰©å±• (`extension/`) çš„åŠŸèƒ½å·®å¼‚ï¼Œè§„åˆ’æµè§ˆå™¨æ‰©å±•çš„åŠŸèƒ½å¢å¼ºè·¯çº¿å›¾ã€‚

### 1.1 èƒŒæ™¯

åœ¨å®Œæˆæ–‡æ¡£ 17 å’Œ 17.2 çš„ç»Ÿä¸€è¯„ä»·ç³»ç»Ÿåï¼Œæµè§ˆå™¨æ‰©å±•å·²å®Œæˆï¼š
- âœ… TypeScript æ¨¡å—åŒ–è¿ç§» (Phase 0)
- âœ… **æ·±åº¦æ¨¡å—åŒ–é‡æ„** (v0.2, 2025-01-15) - è§ [17.4](./17.4-extension-modular-refactor-plan.md)
- âœ… v2 ç»Ÿä¸€ API æ¥å…¥
- âœ… Bearer Token è®¤è¯

ä½†ä¸ç½‘é¡µè¯¦æƒ…é¡µç›¸æ¯”ï¼Œæµè§ˆå™¨æ‰©å±•ä»ç¼ºå°‘å¤šé¡¹åŠŸèƒ½ã€‚

### 1.2 ç›®æ ‡

å°†æµè§ˆå™¨æ‰©å±•çš„åŠŸèƒ½ä¸ç½‘é¡µè¯¦æƒ…é¡µå¯¹é½ï¼Œæä¾›ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒã€‚

---

## äºŒã€åŠŸèƒ½å·®å¼‚æ¸…å•

| # | åŠŸèƒ½ | ç½‘é¡µè¯¦æƒ…é¡µ âœ… | æµè§ˆå™¨æ‰©å±• | ä¼˜å…ˆçº§ |
|---|------|--------------|-----------|--------|
| 1 | **è¯„è®ºç‚¹èµ** | æœ‰ (ThumbsUp + hasLiked) | âŒ ç¼ºå¤± | P1 |
| 2 | **è¯„åˆ†å±•ç¤ºåˆ—è¡¨** | æœ‰ (RatingDisplay ç»„ä»¶) | âŒ åªæ˜¾ç¤ºå¹³å‡åˆ† | P1 |
| 3 | **åŒ¿åè¯„è®ºé€‰é¡¹** | æœ‰ (isAnonymous toggle) | âŒ ç¼ºå¤± | P2 |
| 4 | **æ˜¾ç¤ºç”¨æˆ·åé€‰é¡¹** | æœ‰ (showUsername toggle) | âŒ ç¼ºå¤± | P2 |
| 5 | **è¯„è®ºç­›é€‰** | æœ‰ (Filter: all/mine) | âŒ ç¼ºå¤± | P3 |
| 6 | **è¯„è®ºç¼–è¾‘** | æœ‰ (Edit2 å›¾æ ‡) | âŒ ç¼ºå¤± | P3 |
| 7 | **ç”¨æˆ·å¤´åƒæ˜¾ç¤º** | æœ‰ (UserDisplay ç»„ä»¶) | âŒ åªæ˜¾ç¤ºé¦–å­—æ¯ | P3 |
| 8 | **ç½‘é¡µæè¿°** | æœ‰ (description) | âŒ ç¼ºå¤± | P3 |
| 9 | **ç½‘é¡µå›¾æ ‡** | æœ‰ (favicon_url) | âŒ ç¼ºå¤± | P3 |
| 10 | **ç»´åº¦è¯„åˆ†è¯¦æƒ…** | æœ‰ (dim1/2/3 åˆ†åˆ«å±•ç¤º) | âŒ åªæ˜¾ç¤ºæ€»åˆ† | P2 |
| 11 | **æ—¶é—´æ˜¾ç¤ºtooltip** | æœ‰ (æ‚¬åœç²¾ç¡®æ—¶é—´) | âŒ åªæœ‰ç›¸å¯¹æ—¶é—´ | P3 |

---

## ä¸‰ã€ä»£ç è´¨é‡å¯¹æ¯”

| # | æ–¹é¢ | ç½‘é¡µè¯¦æƒ…é¡µ | æµè§ˆå™¨æ‰©å±• | çŠ¶æ€ |
|---|------|-----------|-----------|------|
| A | **ç±»å‹å®‰å…¨** | TypeScript + å®Œæ•´ç±»å‹ | TypeScript | âœ… å·²å®Œæˆ |
| B | **è®¤è¯æ–¹å¼** | getAccessToken() | Bearer Token | âœ… å·²å®Œæˆ |
| C | **é”™è¯¯å¤„ç†** | try-catch + ç”¨æˆ·æç¤º | åŸºç¡€ toast | âš ï¸ å¾…æ”¹è¿› |
| D | **çŠ¶æ€ç®¡ç†** | React hooks | æ¨¡å—åŒ–çŠ¶æ€ | âœ… å·²å®Œæˆ |
| E | **APIç‰ˆæœ¬** | v2 unified API | v2 unified API | âœ… å·²å®Œæˆ |
| F | **ä»£ç æ¨¡å—åŒ–** | React ç»„ä»¶ | TS æ¨¡å—åŒ– | âœ… **v0.2 å®Œæˆ** |

---

## å››ã€å®æ–½è®¡åˆ’

### Phase 1 (P1 - é«˜ä¼˜å…ˆçº§)

#### 1.1 è¯„è®ºç‚¹èµåŠŸèƒ½ â¬œ

**æ¶‰åŠæ–‡ä»¶**:
- `extension/src/modules/comment-ui.ts`
- `extension/src/services/api-client.ts` (æ–°å¢ vote æ–¹æ³•)
- `extension/src/styles/popup.css` (ç‚¹èµæŒ‰é’®æ ·å¼)

**å®ç°è¦ç‚¹**:
- è°ƒç”¨ `/api/v2/comments/vote` API
- æ˜¾ç¤ºç‚¹èµæ•°é‡å’Œç‚¹èµçŠ¶æ€
- åˆ‡æ¢ç‚¹èµ/å–æ¶ˆç‚¹èµ

#### 1.2 è¯„åˆ†å±•ç¤ºåˆ—è¡¨ â¬œ

**æ¶‰åŠæ–‡ä»¶**:
- `extension/src/modules/rating-ui.ts` (æ‰©å±•)
- `extension/src/services/api-client.ts` (æ–°å¢ getRatings æ–¹æ³•)
- `extension/sidebar.html` (æ–°å¢åˆ—è¡¨åŒºåŸŸ)

**å®ç°è¦ç‚¹**:
- è·å–æ‰€æœ‰è¯„åˆ† (GET `/api/v2/ratings?targetType=webpage&targetId=xxx`)
- å±•ç¤ºç”¨æˆ·å/åŒ¿åã€å„ç»´åº¦è¯„åˆ†ã€æ€»åˆ†ã€æ—¶é—´
- åˆ†é¡µåŠ è½½

---

### Phase 2 (P2 - ä¸­ä¼˜å…ˆçº§)

#### 2.1 åŒ¿åè¯„è®ºé€‰é¡¹ â¬œ

**å®ç°è¦ç‚¹**:
- è¯„è®ºè¡¨å•æ·»åŠ "åŒ¿åå‘è¡¨"å¤é€‰æ¡†
- æäº¤æ—¶ä¼ é€’ `isAnonymous: true/false`

#### 2.2 æ˜¾ç¤ºç”¨æˆ·åé€‰é¡¹ â¬œ

**å®ç°è¦ç‚¹**:
- è¯„åˆ†è¡¨å•æ·»åŠ "æ˜¾ç¤ºç”¨æˆ·å"å¤é€‰æ¡†
- æäº¤æ—¶ä¼ é€’ `showUsername: true/false`

#### 2.3 å„ç»´åº¦è¯„åˆ†è¯¦æƒ…å±•ç¤º â¬œ

**å®ç°è¦ç‚¹**:
- åœ¨è¯„åˆ†ç»Ÿè®¡åŒºåŸŸå±•ç¤º dim1/dim2/dim3 å¹³å‡åˆ†
- ä½¿ç”¨ç½‘é¡µç»´åº¦æ ‡ç­¾ï¼šè´¨é‡ã€å®ç”¨æ€§ã€å‡†ç¡®æ€§

---

### Phase 3 (P3 - ä½ä¼˜å…ˆçº§)

#### 3.1 è¯„è®ºç­›é€‰ (all/mine) â¬œ

**å®ç°è¦ç‚¹**:
- æ·»åŠ ç­›é€‰ä¸‹æ‹‰æ¡†æˆ– Tab
- è°ƒç”¨ API æ—¶ä¼ é€’ `filter=mine`

#### 3.2 è¯„è®ºç¼–è¾‘åŠŸèƒ½ â¬œ

**å®ç°è¦ç‚¹**:
- æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼ˆä»…å¯¹è‡ªå·±çš„è¯„è®ºï¼‰
- è°ƒç”¨ PATCH `/api/v2/comments` æ›´æ–°è¯„è®º

#### 3.3 ç”¨æˆ·å¤´åƒURLæ˜¾ç¤º â¬œ

**å®ç°è¦ç‚¹**:
- ä» API è·å– `user.avatarUrl`
- æ˜¾ç¤ºå›¾ç‰‡å¤´åƒï¼Œå¤±è´¥æ—¶é™çº§ä¸ºé¦–å­—æ¯

#### 3.4 ç½‘é¡µæè¿°å’Œå›¾æ ‡ â¬œ

**å®ç°è¦ç‚¹**:
- è·å–ç½‘é¡µå…ƒæ•°æ®ï¼ˆdescription, favicon_urlï¼‰
- åœ¨é¡µé¢ä¿¡æ¯åŒºåŸŸæ˜¾ç¤º

#### 3.5 æ—¶é—´æ‚¬åœæ˜¾ç¤ºç²¾ç¡®æ—¶é—´ â¬œ

**å®ç°è¦ç‚¹**:
- æ·»åŠ  `title` å±æ€§æ˜¾ç¤ºå®Œæ•´æ—¶é—´
- æ ¼å¼ï¼š`YYYY-MM-DD HH:mm:ss`

---

## äº”ã€æ–‡ä»¶æ¶æ„ï¼ˆv0.2 é‡æ„åï¼‰

```
extension/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background.ts           # Service Worker å…¥å£ (77 è¡Œ)
â”‚   â”œâ”€â”€ content.ts              # Content Script å…¥å£ (332 è¡Œ)
â”‚   â”œâ”€â”€ popup.ts                # Popup å…¥å£ (422 è¡Œ)
â”‚   â”œâ”€â”€ sidebar.ts              # Sidebar å…¥å£ (379 è¡Œ)
â”‚   â”œâ”€â”€ welcome.ts              # Welcome å…¥å£ (55 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ background/             # ğŸ†• åå°æœåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts            # æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ message-handler.ts  # æ¶ˆæ¯å¤„ç† (~110 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ side-panel-manager.ts # ä¾§è¾¹æ ç®¡ç† (~130 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ site-detector.ts    # ç«™ç‚¹æ£€æµ‹ (~80 è¡Œ)
â”‚   â”‚   â””â”€â”€ types.ts            # ç±»å‹å®šä¹‰ (~30 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ content/                # ğŸ†• å†…å®¹è„šæœ¬æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts            # æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ floating-icon.ts    # æµ®åŠ¨å›¾æ ‡ (~434 è¡Œ)
â”‚   â”‚   â””â”€â”€ doi-detector.ts     # DOIæ£€æµ‹ (~298 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ popup/                  # ğŸ†• å¼¹çª—æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ doi-panel.ts        # DOIé¢æ¿ (~80 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ knowledge-panel.ts  # çŸ¥è¯†å•å…ƒé¢æ¿ (~120 è¡Œ)
â”‚   â”‚   â””â”€â”€ settings-panel.ts   # è®¾ç½®é¢æ¿ (~188 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                # Sidebar æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ index.ts            # æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ auth.ts             # è®¤è¯ç®¡ç† (~194 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ settings.ts         # è®¾ç½®ç®¡ç† (~132 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ rating-ui.ts        # è¯„åˆ†UI (~141 è¡Œ)
â”‚   â”‚   â”œâ”€â”€ comment-ui.ts       # è¯„è®ºUI (~178 è¡Œ)
â”‚   â”‚   â””â”€â”€ api-service.ts      # APIæœåŠ¡ (~127 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # ğŸ†• é€šç”¨æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ index.ts            # æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ api-client.ts       # APIå®¢æˆ·ç«¯ (~240 è¡Œ)
â”‚   â”‚   â””â”€â”€ auth-service.ts     # è®¤è¯æœåŠ¡ (~200 è¡Œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                  # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ api.ts              # APIç±»å‹
â”‚   â”‚   â”œâ”€â”€ storage.ts          # å­˜å‚¨ç±»å‹
â”‚   â”‚   â””â”€â”€ dom.ts              # DOMç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ doi.ts              # DOIå¤„ç†
â”‚   â”‚   â”œâ”€â”€ storage.ts          # å­˜å‚¨æ“ä½œ
â”‚   â”‚   â””â”€â”€ toast.ts            # Toastæç¤º
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/                 # ğŸ†• æ ·å¼æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ popup.css           # Popupæ ·å¼ (~380 è¡Œ)
â”‚   â”‚
â”‚   â””â”€â”€ lib/                    # ç¬¬ä¸‰æ–¹åº“
â”‚       â””â”€â”€ purify.min.js       # DOMPurify
â”‚
â”œâ”€â”€ dist/                       # æ„å»ºè¾“å‡º
â”‚   â”œâ”€â”€ background.js           # 4.6kb
â”‚   â”œâ”€â”€ content.js              # 15.5kb
â”‚   â”œâ”€â”€ popup.js                # 17.1kb
â”‚   â”œâ”€â”€ sidebar.js              # 18.9kb
â”‚   â””â”€â”€ welcome.js              # 1.2kb
â”‚
â”œâ”€â”€ manifest.json               # æ‰©å±•æ¸…å•
â”œâ”€â”€ popup.html                  # Popup HTML
â”œâ”€â”€ sidebar.html                # Sidebar HTML
â”œâ”€â”€ welcome.html                # Welcome HTML
â”œâ”€â”€ content.css                 # Content æ ·å¼
â”œâ”€â”€ build.mjs                   # esbuild æ„å»ºè„šæœ¬
â””â”€â”€ package.json                # ä¾èµ–é…ç½®
```

### æ¶æ„è¯´æ˜

**å…¥å£æ–‡ä»¶** (5ä¸ªï¼ŒChromeæ‰©å±•æ¶æ„è¦æ±‚):
- å¿…é¡»ä¿ç•™åœ¨ `src/` æ ¹ç›®å½•
- è´Ÿè´£åˆå§‹åŒ–å’Œåè°ƒæ¨¡å—

**æ¨¡å—æ–‡ä»¶** (æŒ‰åŠŸèƒ½åˆ†ç»„):
- `background/` - Service Worker ç›¸å…³
- `content/` - Content Script ç›¸å…³
- `popup/` - Popup é¡µé¢ç›¸å…³
- `modules/` - Sidebar é¡µé¢ç›¸å…³
- `services/` - é€šç”¨æœåŠ¡ (API, Auth)
- `types/` - TypeScript ç±»å‹
- `utils/` - å·¥å…·å‡½æ•°

---

## å…­ã€é‡æ„æˆæœç»Ÿè®¡ (v0.2)

| å…¥å£æ–‡ä»¶ | åŸå§‹è¡Œæ•° | ç°è¡Œæ•° | å‡å°‘ |
|----------|----------|--------|------|
| `background.ts` | 368 | 77 | **-79%** |
| `content.ts` | 731 | 332 | **-55%** |
| `popup.ts` | 750 | 422 | **-44%** |
| `sidebar.ts` | 379 | 379 | å·²æ¨¡å—åŒ– |
| `welcome.ts` | 55 | 55 | - |

**ç¼–è¯‘è¾“å‡º**:
- background.js: 7.0kb â†’ 4.6kb (-34%)
- æ€»è®¡: 57.3kb

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### Phase 1 å®Œæˆæ¡ä»¶
- [ ] è¯„è®ºå¯ä»¥ç‚¹èµ/å–æ¶ˆç‚¹èµï¼Œæ˜¾ç¤ºç‚¹èµæ•°
- [ ] å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è¯„åˆ†åˆ—è¡¨

### Phase 2 å®Œæˆæ¡ä»¶
- [ ] è¯„è®ºå’Œè¯„åˆ†æ”¯æŒåŒ¿åé€‰é¡¹
- [ ] è¯„åˆ†æ”¯æŒæ˜¾ç¤º/éšè—ç”¨æˆ·å
- [ ] æ˜¾ç¤ºå„ç»´åº¦å¹³å‡åˆ†

### Phase 3 å®Œæˆæ¡ä»¶
- [ ] å¯ä»¥ç­›é€‰"å…¨éƒ¨è¯„è®º"å’Œ"æˆ‘çš„è¯„è®º"
- [ ] å¯ä»¥ç¼–è¾‘è‡ªå·±çš„è¯„è®º
- [ ] æ˜¾ç¤ºç”¨æˆ·å¤´åƒï¼ˆURLå›¾ç‰‡ï¼‰
- [ ] æ˜¾ç¤ºç½‘é¡µæè¿°å’Œå›¾æ ‡
- [ ] æ—¶é—´æ‚¬åœæ˜¾ç¤ºç²¾ç¡®æ—¶é—´

---

## å…«ã€æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| v0.1 | 2025-01-14 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŠŸèƒ½å·®å¼‚åˆ†æ |
| v0.2 | 2025-01-15 | **æ›´æ–°æ–‡ä»¶æ¶æ„**ï¼šåæ˜ æ·±åº¦æ¨¡å—åŒ–é‡æ„æˆæœ |

---

**ç»´æŠ¤è€…**: Researchopia Team  
**ä¸‹æ¬¡å®¡æŸ¥**: å®Œæˆ Phase 1 å
