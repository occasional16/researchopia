# 1.3 æ ‡æ³¨å…±äº«å¢å¼ºåŠŸèƒ½ - æ¸è¿›å¼å®æ–½æ–¹æ¡ˆ

> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è·¯çº¿å›¾  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-11  
> **ä½œè€…**: Researchopia Team  
> **çŠ¶æ€**: è§„åˆ’ä¸­  
> **ç›¸å…³æ–‡æ¡£**: 
> - [1.1-å…±äº«æ ‡æ³¨ç”Ÿæ€æ„å»ºç­–ç•¥](./1.1-SHARED_ANNOTATION_ECOSYSTEM_DESIGN.md)
> - [1.2-æ ‡æ³¨å³æ—¶å…±äº«åŠŸèƒ½](./1.2-INSTANT_SHARING_IMPLEMENTATION_PLAN.md)

---

## ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#1-æ–¹æ¡ˆæ¦‚è¿°)
2. [Phase 1: æ ‡æ³¨åˆ›å»ºåå³æ—¶å…±äº«](#2-phase-1-æ ‡æ³¨åˆ›å»ºåå³æ—¶å…±äº«)
3. [Phase 2: PDFé¡µé¢overlayäº¤äº’å¢å¼º](#3-phase-2-pdfé¡µé¢overlayäº¤äº’å¢å¼º)
4. [Phase 3: æ¥ç®¡åŸç”Ÿæ ‡æ³¨å¼¹çª—](#4-phase-3-æ¥ç®¡åŸç”Ÿæ ‡æ³¨å¼¹çª—)
5. [å®æ–½æ—¶é—´è¡¨](#5-å®æ–½æ—¶é—´è¡¨)
6. [æŠ€æœ¯ä¾èµ–å…³ç³»](#6-æŠ€æœ¯ä¾èµ–å…³ç³»)

---

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 è®¾è®¡ç†å¿µ

**æ¸è¿›å¼å¢å¼ºï¼ˆProgressive Enhancementï¼‰**:
- âœ… æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹å¯ç”¨çš„å®Œæ•´åŠŸèƒ½
- âœ… åç»­é˜¶æ®µå»ºç«‹åœ¨å‰ä¸€é˜¶æ®µçš„åŸºç¡€ä¸Š
- âœ… é™ä½é£é™©ï¼Œä¾¿äºæµ‹è¯•å’Œå›æ»š
- âœ… å¿«é€Ÿè¿­ä»£ï¼ŒåŠæ—¶æ”¶é›†ç”¨æˆ·åé¦ˆ

### 1.2 ä¸‰ä¸ªé˜¶æ®µçš„å…³ç³»

```
Phase 1: æ ‡æ³¨åˆ›å»ºåå¼¹çª—
         â†“ (æœ€ç®€å•ï¼Œå¿«é€Ÿä¸Šçº¿ï¼ŒéªŒè¯éœ€æ±‚)
         âœ… 3-4å¤©å®ç°
         âœ… é™ä½æ‘©æ“¦90%ï¼ˆ7æ­¥â†’1æ­¥ï¼‰
         
Phase 2: PDFé¡µé¢äº¤äº’
         â†“ (å¢å¼ºå±•ç¤ºï¼Œæå‡ä½“éªŒ)
         âœ… 5-6å¤©å®ç°
         âœ… åœ¨PDFä¸­ç›´æ¥ç‚¹èµã€è¯„è®ºå…±äº«æ ‡æ³¨
         
Phase 3: æ¥ç®¡åŸç”Ÿå¼¹çª—
         â†“ (ç»ˆææ–¹æ¡ˆï¼Œå®Œç¾ä½“éªŒ)
         âœ… 10-14å¤©å®ç°
         âœ… åˆ›å»ºæ—¶å³å¯é€‰æ‹©ï¼Œé›¶é¢å¤–æ“ä½œ
```

### 1.3 ä¸ºä»€ä¹ˆä¸ç›´æ¥åšPhase 3ï¼Ÿ

**æŠ€æœ¯å¤æ‚åº¦**:
- Phase 1: ç®€å•ï¼ˆç›‘å¬äº‹ä»¶ + å¼¹çª—ï¼‰
- Phase 2: ä¸­ç­‰ï¼ˆæ³¨å…¥PDFé¡µé¢ + DOMæ“ä½œï¼‰
- Phase 3: å¤æ‚ï¼ˆæ‹¦æˆªåŸç”Ÿäº‹ä»¶ + è·¨ç‰ˆæœ¬å…¼å®¹ï¼‰

**é£é™©ç®¡ç†**:
- Phase 1å¤±è´¥ â†’ åªæµªè´¹3-4å¤©
- Phase 3å¤±è´¥ â†’ æµªè´¹2å‘¨+ï¼Œä¸”æ— å¤‡é€‰æ–¹æ¡ˆ

**ç”¨æˆ·ä»·å€¼**:
- Phase 1å·²ç»èƒ½è§£å†³80%çš„é—®é¢˜
- Phase 2å’Œ3æ˜¯é”¦ä¸Šæ·»èŠ±

---

## 2. Phase 1: æ ‡æ³¨åˆ›å»ºåå³æ—¶å…±äº«

### 2.1 åŠŸèƒ½æè¿°

ç”¨æˆ·åœ¨Zotero PDFé˜…è¯»å™¨ä¸­åˆ›å»ºæ ‡æ³¨åï¼Œ**ç«‹å³å¼¹å‡ºå…±äº«é€‰æ‹©å¯¹è¯æ¡†**ã€‚

**ç”¨æˆ·æµç¨‹**:
```
1. ç”¨æˆ·åœ¨PDFä¸­é«˜äº®æ–‡æœ¬ â†’ Zoteroæ ‡æ³¨åˆ›å»º
2. ğŸ†• å¯¹è¯æ¡†å¼¹å‡ºï¼šå…¬å¼€/åŒ¿å/ç§å¯†ï¼Ÿ
3. ç”¨æˆ·é€‰æ‹©ï¼ˆæˆ–3ç§’è‡ªåŠ¨é€‰æ‹©é»˜è®¤ï¼‰
4. æ ‡æ³¨åŒæ­¥åˆ°Supabase
```

### 2.2 æŠ€æœ¯æ–¹æ¡ˆ

**æ ¸å¿ƒæ¨¡å—**: `InstantSharingManager`

**å…³é”®æŠ€æœ¯ç‚¹**:
1. ç›‘å¬ `Zotero.Notifier` çš„ `'add'` äº‹ä»¶
2. åˆ¤æ–­æ–°å¢itemæ˜¯å¦ä¸ºannotation
3. å¼¹å‡º `QuickShareDialog` å¯¹è¯æ¡†
4. è°ƒç”¨ `AnnotationManager.updateAnnotationSharing()` åŒæ­¥

**ä»£ç ç¤ºä¾‹**:
```typescript
// src/modules/instantSharingManager.ts

export class InstantSharingManager {
  public static async initialize(): Promise<void> {
    this.notifierID = Zotero.Notifier.registerObserver(
      {
        notify: async (event, type, ids, extraData) => {
          if (type === 'item' && event === 'add') {
            for (const id of ids) {
              const item = await Zotero.Items.getAsync(id);
              if (item && item.isAnnotation?.()) {
                await this.onAnnotationCreated(item);
              }
            }
          }
        }
      },
      ['item']
    );
  }

  private static async onAnnotationCreated(item: any): Promise<void> {
    // 1. æ£€æŸ¥ç”¨æˆ·ç™»å½•
    const user = AuthManager.getCurrentUser();
    if (!user) return;

    // 2. æ˜¾ç¤ºå¯¹è¯æ¡†
    const dialog = new QuickShareDialog(doc, annotation, false);
    const choice = await dialog.show();

    // 3. åŒæ­¥æ ‡æ³¨
    await AnnotationManager.updateAnnotationSharing(
      annotation,
      documentId,
      user.id,
      choice.visibility,
      choice.showAuthorName
    );
  }
}
```

### 2.3 å®Œæ•´æ–‡æ¡£

è¯¦è§: [1.2-æ ‡æ³¨å³æ—¶å…±äº«åŠŸèƒ½å®æ–½æ–¹æ¡ˆ](./1.2-INSTANT_SHARING_IMPLEMENTATION_PLAN.md)

### 2.4 é¢„æœŸæˆæœ

- âœ… å…±äº«ç‡ä»<5%æå‡åˆ°20-30%
- âœ… ç”¨æˆ·å½¢æˆæ ‡æ³¨æ—¶æ€è€ƒ"æ˜¯å¦å…±äº«"çš„ä¹ æƒ¯
- âœ… ä¸ºPhase 2å’Œ3å¥ å®šåŸºç¡€

### 2.5 å±€é™æ€§

- âŒ éœ€è¦é¢å¤–å¼¹çª—ï¼Œç•¥å¾®æ‰“æ–­é˜…è¯»æµç¨‹
- âŒ æ— æ³•åœ¨PDFé¡µé¢ç›´æ¥çœ‹åˆ°å®Œæ•´çš„å…±äº«æ ‡æ³¨äº¤äº’
- âŒ ä¸å¦‚"åˆ›å»ºæ—¶é€‰æ‹©"é‚£ä¹ˆæ— ç¼

---

## 3. Phase 2: PDFé¡µé¢overlayäº¤äº’å¢å¼º

### 3.1 åŠŸèƒ½æè¿°

åœ¨PDFé¡µé¢ä¸Š**ç›´æ¥å±•ç¤ºå…±äº«æ ‡æ³¨çš„overlay**ï¼Œç”¨æˆ·ç‚¹å‡»overlayåå¼¹å‡ºå®Œæ•´ä¿¡æ¯å¼¹çª—ï¼Œæ”¯æŒç‚¹èµã€è¯„è®ºã€å›å¤ã€‚

**å½“å‰çŠ¶æ€**:
- âœ… å·²å®ç°ï¼šå…±äº«æ ‡æ³¨çš„overlayæ˜¾ç¤ºï¼ˆä½ç½®ã€é¢œè‰²ï¼‰
- âŒ ç¼ºå¤±ï¼šç‚¹å‡»åçš„äº¤äº’å¼¹çª—

**ç›®æ ‡**:
- âœ… ç‚¹å‡»overlayå¼¹å‡ºä¿¡æ¯å¡ç‰‡
- âœ… æ˜¾ç¤ºï¼šæ ‡æ³¨å†…å®¹ã€ä½œè€…ã€æ—¶é—´ã€ç‚¹èµæ•°ã€è¯„è®ºæ•°
- âœ… æ”¯æŒï¼šç‚¹èµã€è¯„è®ºã€å›å¤ã€å®šä½åˆ°åŸæ–‡

### 3.2 æŠ€æœ¯æ–¹æ¡ˆ

#### 3.2.1 æ¶æ„è®¾è®¡

```
Zotero PDF Reader (iframe)
  â†“
PDFé¡µé¢ (canvas/svg)
  â†“
å…±äº«æ ‡æ³¨overlay (div, position: absolute)
  â†“ (æ·»åŠ clickäº‹ä»¶ç›‘å¬)
AnnotationPopupå¼¹çª—
  â”œâ”€ æ ‡æ³¨å†…å®¹å±•ç¤º
  â”œâ”€ ç”¨æˆ·ä¿¡æ¯ï¼ˆhoveræ˜¾ç¤ºuserCardï¼‰
  â”œâ”€ ç‚¹èµæŒ‰é’®
  â”œâ”€ è¯„è®ºåŒºåŸŸ
  â””â”€ å®šä½æŒ‰é’®
```

#### 3.2.2 æ ¸å¿ƒä»£ç 

```typescript
// src/modules/pdfReaderManager.ts

export class PDFReaderManager {
  /**
   * ä¸ºå…±äº«æ ‡æ³¨overlayæ·»åŠ äº¤äº’
   */
  private static addOverlayInteraction(
    overlayElement: HTMLElement,
    annotation: SharedAnnotation,
    reader: any
  ): void {
    overlayElement.style.cursor = 'pointer';
    
    overlayElement.addEventListener('click', async (e) => {
      e.stopPropagation();
      
      // å¼¹å‡ºä¿¡æ¯å¡ç‰‡
      const popup = new AnnotationPopup(
        overlayElement.ownerDocument,
        annotation,
        reader
      );
      
      await popup.show();
    });
    
    // hoveræ•ˆæœ
    overlayElement.addEventListener('mouseenter', () => {
      overlayElement.style.opacity = '0.8';
      overlayElement.style.transform = 'scale(1.05)';
    });
    
    overlayElement.addEventListener('mouseleave', () => {
      overlayElement.style.opacity = '0.5';
      overlayElement.style.transform = 'scale(1)';
    });
  }
}
```

#### 3.2.3 AnnotationPopupç»„ä»¶

```typescript
// src/modules/ui/annotationPopup.ts

export class AnnotationPopup {
  private doc: Document;
  private annotation: SharedAnnotation;
  private reader: any;
  private popupElement: HTMLElement | null = null;

  constructor(doc: Document, annotation: SharedAnnotation, reader: any) {
    this.doc = doc;
    this.annotation = annotation;
    this.reader = reader;
  }

  public async show(): Promise<void> {
    // åˆ›å»ºå¼¹çª—
    this.popupElement = this.createPopupElement();
    
    // å®šä½åˆ°annotationä½ç½®é™„è¿‘
    const overlayRect = this.getOverlayRect();
    this.positionPopup(overlayRect);
    
    // æ·»åŠ åˆ°é¡µé¢
    this.doc.body.appendChild(this.popupElement);
    
    // æ·»åŠ å…³é—­ç›‘å¬
    this.attachCloseListeners();
  }

  private createPopupElement(): HTMLElement {
    const popup = this.doc.createElement('div');
    popup.className = 'annotation-popup';
    popup.style.cssText = `
      position: fixed;
      width: 400px;
      max-height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      padding: 20px;
      z-index: 10001;
      overflow-y: auto;
    `;

    // å†…å®¹
    popup.innerHTML = `
      <div class="annotation-popup-header">
        <div class="annotation-popup-user">
          ${this.renderUserInfo()}
        </div>
        <button class="annotation-popup-close">âœ•</button>
      </div>

      <div class="annotation-popup-content">
        <div class="annotation-text">
          ${this.annotation.content}
        </div>
        ${this.annotation.comment ? `
          <div class="annotation-comment">
            ğŸ’¬ ${this.annotation.comment}
          </div>
        ` : ''}
      </div>

      <div class="annotation-popup-actions">
        <button class="action-like">
          ${this.annotation.user_liked ? 'â¤ï¸' : 'ğŸ¤'} 
          ${this.annotation.likes_count || 0}
        </button>
        <button class="action-comment">
          ğŸ’¬ ${this.annotation.comments_count || 0}
        </button>
        <button class="action-locate">ğŸ“ å®šä½</button>
      </div>

      <div class="annotation-popup-comments" id="comments-section" style="display: none;">
        <!-- è¯„è®ºåˆ—è¡¨åŠ¨æ€åŠ è½½ -->
      </div>
    `;

    // ç»‘å®šäº‹ä»¶
    this.attachActionListeners(popup);

    return popup;
  }

  private renderUserInfo(): string {
    const displayName = this.annotation.show_author_name 
      ? (this.annotation.username || 'æœªçŸ¥ç”¨æˆ·')
      : 'åŒ¿åç”¨æˆ·';
    
    return `
      <span class="user-avatar">ğŸ‘¤</span>
      <span class="user-name">${displayName}</span>
      <span class="annotation-time">${formatDate(this.annotation.created_at)}</span>
    `;
  }

  private attachActionListeners(popup: HTMLElement): void {
    // ç‚¹èµ
    popup.querySelector('.action-like')?.addEventListener('click', async () => {
      await this.handleLike();
    });

    // è¯„è®º
    popup.querySelector('.action-comment')?.addEventListener('click', async () => {
      await this.toggleComments();
    });

    // å®šä½
    popup.querySelector('.action-locate')?.addEventListener('click', async () => {
      await this.locateInPDF();
    });

    // å…³é—­
    popup.querySelector('.annotation-popup-close')?.addEventListener('click', () => {
      this.close();
    });
  }

  private async handleLike(): Promise<void> {
    const currentUser = AuthManager.getCurrentUser();
    if (!currentUser) {
      alert('è¯·å…ˆç™»å½•');
      return;
    }

    const supabaseManager = new SupabaseManager();
    await supabaseManager.likeAnnotation(this.annotation.id, currentUser.id);

    // æ›´æ–°UI
    this.annotation.user_liked = !this.annotation.user_liked;
    this.annotation.likes_count = (this.annotation.likes_count || 0) + (this.annotation.user_liked ? 1 : -1);
    
    // é‡æ–°æ¸²æŸ“
    this.close();
    await this.show();
  }

  private async toggleComments(): Promise<void> {
    const commentsSection = this.popupElement?.querySelector('#comments-section') as HTMLElement;
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
      // åŠ è½½è¯„è®º
      const supabaseManager = new SupabaseManager();
      const commentTree = await supabaseManager.getAnnotationCommentTree(this.annotation.id);
      
      // æ¸²æŸ“è¯„è®º
      commentsSection.innerHTML = this.renderComments(commentTree);
      commentsSection.style.display = 'block';
    } else {
      commentsSection.style.display = 'none';
    }
  }

  private renderComments(commentTree: any[]): string {
    // é€’å½’æ¸²æŸ“è¯„è®ºæ ‘
    // å¤ç”¨ SessionAnnotationsView çš„è¯„è®ºæ¸²æŸ“é€»è¾‘
    return ''; // çœç•¥è¯¦ç»†å®ç°
  }

  private async locateInPDF(): Promise<void> {
    if (!this.annotation.position || typeof this.annotation.position.pageIndex !== 'number') {
      alert('æ— æ³•å®šä½ï¼šç¼ºå°‘ä½ç½®ä¿¡æ¯');
      return;
    }

    // è·³è½¬åˆ°å¯¹åº”é¡µé¢
    this.reader._internalReader.setPageIndex(this.annotation.position.pageIndex);
    
    // é«˜äº®æ ‡æ³¨ï¼ˆé—ªçƒæ•ˆæœï¼‰
    // å¤ç”¨ PDFReaderManager.highlightMultipleAnnotations é€»è¾‘
    
    this.close();
  }

  private positionPopup(overlayRect: DOMRect): void {
    if (!this.popupElement) return;

    // å°è¯•æ˜¾ç¤ºåœ¨overlayå³ä¾§ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿåˆ™æ˜¾ç¤ºåœ¨å·¦ä¾§
    const viewportWidth = window.innerWidth;
    const popupWidth = 400;
    
    let left = overlayRect.right + 10;
    if (left + popupWidth > viewportWidth) {
      left = overlayRect.left - popupWidth - 10;
    }

    let top = overlayRect.top;
    if (top + 600 > window.innerHeight) {
      top = window.innerHeight - 600 - 20;
    }

    this.popupElement.style.left = `${left}px`;
    this.popupElement.style.top = `${top}px`;
  }

  private attachCloseListeners(): void {
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    const outsideClickHandler = (e: MouseEvent) => {
      if (this.popupElement && !this.popupElement.contains(e.target as Node)) {
        this.close();
      }
    };
    
    this.doc.addEventListener('click', outsideClickHandler, { once: true });

    // Escé”®å…³é—­
    const escHandler = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        this.close();
      }
    };
    
    this.doc.addEventListener('keydown', escHandler, { once: true });
  }

  private close(): void {
    if (this.popupElement) {
      this.popupElement.remove();
      this.popupElement = null;
    }
  }

  private getOverlayRect(): DOMRect {
    // è·å–å¯¹åº”overlayçš„ä½ç½®
    // éœ€è¦æ ¹æ®annotation.idæ‰¾åˆ°å¯¹åº”çš„overlayå…ƒç´ 
    return new DOMRect(0, 0, 0, 0); // å ä½
  }
}
```

### 3.3 å®æ–½æ­¥éª¤

#### Day 1-2: åŸºç¡€æ¡†æ¶
```
â–¡ åœ¨ PDFReaderManager ä¸­æ‰¾åˆ°åˆ›å»ºoverlayçš„ä»£ç ä½ç½®
â–¡ ä¸ºæ¯ä¸ªoverlayæ·»åŠ  data-annotation-id å±æ€§
â–¡ æ·»åŠ clickäº‹ä»¶ç›‘å¬å™¨
â–¡ åˆ›å»º AnnotationPopup ç±»æ¡†æ¶
```

#### Day 3-4: UIå®ç°
```
â–¡ å®ç°å¼¹çª—UIå¸ƒå±€
â–¡ å®ç°å®šä½é€»è¾‘ï¼ˆæ˜¾ç¤ºåœ¨overlayé™„è¿‘ï¼‰
â–¡ å®ç°å…³é—­é€»è¾‘ï¼ˆç‚¹å‡»å¤–éƒ¨/Escï¼‰
â–¡ æ·»åŠ åŠ¨ç”»æ•ˆæœ
```

#### Day 5-6: åŠŸèƒ½é›†æˆ
```
â–¡ é›†æˆç‚¹èµåŠŸèƒ½
â–¡ é›†æˆè¯„è®ºåŠŸèƒ½ï¼ˆå¤ç”¨SessionAnnotationsViewçš„é€»è¾‘ï¼‰
â–¡ é›†æˆå®šä½åŠŸèƒ½ï¼ˆè·³è½¬åˆ°PDFé¡µé¢ï¼‰
â–¡ æ·»åŠ UserHoverCardæ”¯æŒ
```

### 3.4 é¢„æœŸæˆæœ

- âœ… ç”¨æˆ·å¯ä»¥åœ¨PDFé¡µé¢ç›´æ¥ä¸å…±äº«æ ‡æ³¨äº¤äº’
- âœ… æ— éœ€åˆ‡æ¢åˆ°ä¾§è¾¹æ ï¼Œé˜…è¯»ä½“éªŒæ›´æµç•…
- âœ… æå‡ç¤¾åŒºäº’åŠ¨ï¼ˆç‚¹èµã€è¯„è®ºï¼‰
- âœ… ä¸ºPhase 3çš„å®Œæ•´æ–¹æ¡ˆç§¯ç´¯ç»éªŒ

### 3.5 å±€é™æ€§

- âŒ ä»ç„¶æ˜¯"åˆ›å»ºå"æ‰èƒ½äº¤äº’ï¼Œä¸æ˜¯"åˆ›å»ºæ—¶"
- âŒ éœ€è¦å…ˆå…±äº«æ ‡æ³¨ï¼Œæ‰èƒ½åœ¨PDFä¸­çœ‹åˆ°overlay

---

## 4. Phase 3: æ¥ç®¡åŸç”Ÿæ ‡æ³¨å¼¹çª—

### 4.1 åŠŸèƒ½æè¿°

**ç»ˆæç›®æ ‡**: ç”¨æˆ·åœ¨PDFä¸­é€‰æ‹©æ–‡æœ¬æ—¶ï¼Œ**æ’ä»¶å¼¹çª—ç›´æ¥æ›¿ä»£ZoteroåŸç”Ÿå¼¹çª—**ï¼Œåœ¨åŒä¸€ä¸ªç•Œé¢ä¸­å®Œæˆï¼š
1. é€‰æ‹©æ ‡æ³¨ç±»å‹ï¼ˆé«˜äº®/ä¸‹åˆ’çº¿/ç¬”è®°ï¼‰
2. é€‰æ‹©é¢œè‰²
3. è¾“å…¥è¯„è®º
4. **ğŸ†• é€‰æ‹©å…±äº«æ–¹å¼ï¼ˆå…¬å¼€/åŒ¿å/ç§å¯†ï¼‰**

**ç”¨æˆ·æµç¨‹**:
```
1. ç”¨æˆ·åœ¨PDFä¸­é€‰æ‹©æ–‡æœ¬
2. ğŸ†• æ’ä»¶å¼¹çª—å¼¹å‡ºï¼ˆæ›¿ä»£ZoteroåŸç”Ÿå¼¹çª—ï¼‰
3. ç”¨æˆ·åœ¨åŒä¸€å¼¹çª—ä¸­ï¼š
   - é€‰æ‹©æ ‡æ³¨ç±»å‹/é¢œè‰²
   - è¾“å…¥è¯„è®º
   - é€‰æ‹©å…±äº«æ–¹å¼
4. ç‚¹å‡»"åˆ›å»º"æŒ‰é’®
5. æ ‡æ³¨åˆ›å»º + åŒæ­¥åˆ°Supabaseï¼ˆä¸€æ­¥åˆ°ä½ï¼‰
```

**å¯¹æ¯”Phase 1**:
```
Phase 1: åˆ›å»ºæ ‡æ³¨ â†’ (ZoteroåŸç”Ÿå¼¹çª—) â†’ æ ‡æ³¨åˆ›å»º â†’ (æ’ä»¶å¼¹çª—) â†’ é€‰æ‹©å…±äº«
Phase 3: åˆ›å»ºæ ‡æ³¨ â†’ (æ’ä»¶å¼¹çª—ï¼šåŸç”ŸåŠŸèƒ½+å…±äº«é€‰æ‹©) â†’ æ ‡æ³¨åˆ›å»º+åŒæ­¥
```

### 4.2 æŠ€æœ¯æ–¹æ¡ˆ

#### 4.2.1 æ ¸å¿ƒæŒ‘æˆ˜

**æŒ‘æˆ˜1**: å¦‚ä½•ç¦ç”¨ZoteroåŸç”Ÿæ ‡æ³¨å¼¹çª—ï¼Ÿ

**æŒ‘æˆ˜2**: å¦‚ä½•ç›‘å¬PDFæ–‡æœ¬é€‰æ‹©äº‹ä»¶ï¼Ÿ

**æŒ‘æˆ˜3**: å¦‚ä½•åœ¨æ’ä»¶å¼¹çª—ä¸­å¤ç°ZoteroåŸç”ŸåŠŸèƒ½ï¼ˆé¢œè‰²é€‰æ‹©ã€ç±»å‹é€‰æ‹©ï¼‰ï¼Ÿ

**æŒ‘æˆ˜4**: å¦‚ä½•ç¡®ä¿è·¨Zoteroç‰ˆæœ¬ï¼ˆ7/8ï¼‰å…¼å®¹ï¼Ÿ

#### 4.2.2 å¯è¡Œæ€§åˆ†æ

**æ–¹æ¡ˆA: Hook Zotero Reader API**

```typescript
// ä¼ªä»£ç 
const originalCreateAnnotation = reader._internalReader.createAnnotation;

reader._internalReader.createAnnotation = async function(...args) {
  // æ‹¦æˆªè°ƒç”¨
  const selection = reader._internalReader.getSelection();
  
  // æ˜¾ç¤ºæ’ä»¶å¼¹çª—
  const result = await showPluginAnnotationDialog(selection);
  
  if (result) {
    // è°ƒç”¨åŸç”ŸAPIåˆ›å»ºæ ‡æ³¨
    const annotation = await originalCreateAnnotation.call(this, result.annotationData);
    
    // åŒæ­¥åˆ°Supabase
    await syncToSupabase(annotation, result.shareChoice);
  }
};
```

**ä¼˜ç‚¹**:
- âœ… ç†è®ºä¸Šå¯è¡Œ
- âœ… å®Œå…¨æ§åˆ¶æµç¨‹

**ç¼ºç‚¹**:
- âŒ ä¾èµ–Zoteroå†…éƒ¨APIï¼ˆå¯èƒ½éšç‰ˆæœ¬å˜åŒ–ï¼‰
- âŒ éœ€è¦æ·±å…¥ç ”ç©¶Zotero Readeræºç 
- âŒ ç»´æŠ¤æˆæœ¬é«˜

---

**æ–¹æ¡ˆB: ç›‘å¬PDF Selection + éšè—åŸç”Ÿå¼¹çª—**

```typescript
// ç›‘å¬PDF iframeä¸­çš„æ–‡æœ¬é€‰æ‹©
const pdfIframe = reader._iframe;
const pdfDoc = pdfIframe.contentDocument;

pdfDoc.addEventListener('mouseup', async (e) => {
  const selection = pdfDoc.getSelection();
  if (selection && selection.toString().length > 0) {
    // ç«‹å³éšè—åŸç”Ÿå¼¹çª—ï¼ˆå¦‚æœå‡ºç°ï¼‰
    hideNativePopup();
    
    // æ˜¾ç¤ºæ’ä»¶å¼¹çª—
    await showPluginAnnotationDialog(selection);
  }
});

function hideNativePopup() {
  // å°è¯•æŸ¥æ‰¾å¹¶éšè—ZoteroåŸç”Ÿå¼¹çª—
  const nativePopup = pdfDoc.querySelector('.annotation-popup'); // å‡è®¾classå
  if (nativePopup) {
    nativePopup.style.display = 'none';
  }
}
```

**ä¼˜ç‚¹**:
- âœ… ä¸ä¾èµ–å†…éƒ¨API
- âœ… ç›¸å¯¹ç¨³å®š

**ç¼ºç‚¹**:
- âŒ å¯èƒ½æ— æ³•å®Œå…¨é˜»æ­¢åŸç”Ÿå¼¹çª—å‡ºç°ï¼ˆé—ªçƒé—®é¢˜ï¼‰
- âŒ éœ€è¦æ‰¾åˆ°åŸç”Ÿå¼¹çª—çš„DOMå…ƒç´ ï¼ˆå¯èƒ½å˜åŒ–ï¼‰

---

**æ–¹æ¡ˆC: åå¥½è®¾ç½® + ç”¨æˆ·æ‰‹åŠ¨ç¦ç”¨åŸç”Ÿå¼¹çª—**

```
1. åœ¨Zoteroè®¾ç½®ä¸­ï¼Œæä¾›é€‰é¡¹ï¼š
   "ä½¿ç”¨Researchopiaæ ‡æ³¨å¼¹çª—ï¼ˆå®éªŒæ€§ï¼‰"
   
2. ç”¨æˆ·å‹¾é€‰åï¼Œæ’ä»¶ä¿®æ”¹Zoteroçš„about:configé…ç½®ï¼š
   extensions.zotero.annotations.popup.enabled = false
   
3. æ’ä»¶ç›‘å¬æ–‡æœ¬é€‰æ‹©ï¼Œæ˜¾ç¤ºè‡ªå·±çš„å¼¹çª—
```

**ä¼˜ç‚¹**:
- âœ… æœ€ç¨³å®š
- âœ… ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©

**ç¼ºç‚¹**:
- âŒ éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
- âŒ å¦‚æœZoteroä¸æä¾›ç¦ç”¨åŸç”Ÿå¼¹çª—çš„é…ç½®ï¼Œæ­¤æ–¹æ¡ˆä¸å¯è¡Œ

---

#### 4.2.3 æ¨èæ–¹æ¡ˆ

**é‡‡ç”¨æ–¹æ¡ˆBï¼ˆç›‘å¬Selection + éšè—åŸç”Ÿå¼¹çª—ï¼‰+ é™çº§åˆ°æ–¹æ¡ˆAï¼ˆå¦‚æœæ–¹æ¡ˆBæ•ˆæœä¸ä½³ï¼‰**

**å®æ–½æ­¥éª¤**:

##### Step 1: è°ƒç ”Zotero Reader APIï¼ˆ3-4å¤©ï¼‰
```
â–¡ é˜…è¯»Zoteroæºç ï¼š
  - zotero/reader/reader.js
  - zotero/reader/pdf-reader.js
  
â–¡ æ‰¾åˆ°å…³é”®APIï¼š
  - å¦‚ä½•è·å–PDF iframe
  - å¦‚ä½•ç›‘å¬æ–‡æœ¬é€‰æ‹©
  - åŸç”Ÿå¼¹çª—çš„DOMç»“æ„
  - å¦‚ä½•è°ƒç”¨Zotero.Items.createAnnotation()
  
â–¡ åœ¨Zotero 7å’Œ8ä¸­åˆ†åˆ«æµ‹è¯•
```

##### Step 2: å®ç°æ–‡æœ¬é€‰æ‹©ç›‘å¬ï¼ˆ2-3å¤©ï¼‰
```typescript
// src/modules/annotationCreationInterceptor.ts

export class AnnotationCreationInterceptor {
  private static isInitialized = false;
  private static readers: Map<string, any> = new Map();

  public static async initialize(): Promise<void> {
    if (this.isInitialized) return;

    // ç›‘å¬Readeræ‰“å¼€äº‹ä»¶
    Zotero.Reader.registerEventListener('renderered', (reader: any) => {
      this.attachToReader(reader);
    });

    this.isInitialized = true;
  }

  private static attachToReader(reader: any): void {
    const readerId = reader._instanceID;
    if (this.readers.has(readerId)) return;

    try {
      const pdfIframe = reader._iframe;
      if (!pdfIframe) {
        logger.error("[Interceptor] PDF iframe not found");
        return;
      }

      const pdfDoc = pdfIframe.contentDocument;
      if (!pdfDoc) {
        logger.error("[Interceptor] PDF document not accessible");
        return;
      }

      // ç›‘å¬é¼ æ ‡æŠ¬èµ·ï¼ˆæ–‡æœ¬é€‰æ‹©ç»“æŸï¼‰
      pdfDoc.addEventListener('mouseup', async (e: MouseEvent) => {
        await this.handleTextSelection(reader, pdfDoc, e);
      });

      this.readers.set(readerId, reader);
      logger.log("[Interceptor] Attached to reader:", readerId);
    } catch (error) {
      logger.error("[Interceptor] Error attaching to reader:", error);
    }
  }

  private static async handleTextSelection(
    reader: any,
    pdfDoc: Document,
    event: MouseEvent
  ): Promise<void> {
    const selection = pdfDoc.getSelection();
    if (!selection || selection.toString().trim().length === 0) {
      return;
    }

    // å°è¯•éšè—åŸç”Ÿå¼¹çª—
    this.hideNativePopup(pdfDoc);

    // å»¶è¿Ÿ50msï¼Œç¡®ä¿åŸç”Ÿå¼¹çª—å·²è¢«éšè—
    await new Promise(resolve => setTimeout(resolve, 50));

    // æ˜¾ç¤ºæ’ä»¶å¼¹çª—
    const result = await this.showPluginCreationDialog(reader, selection);
    
    if (result) {
      await this.createAnnotation(reader, result);
    }

    // æ¸…é™¤é€‰æ‹©
    selection.removeAllRanges();
  }

  private static hideNativePopup(pdfDoc: Document): void {
    // å°è¯•æŸ¥æ‰¾å¹¶éšè—ZoteroåŸç”Ÿå¼¹çª—
    // éœ€è¦è°ƒç ”ç¡®å®šclassåæˆ–id
    const selectors = [
      '.annotation-popup',
      '#zotero-annotation-popup',
      '.pdf-annotation-toolbar'
    ];

    for (const selector of selectors) {
      const popup = pdfDoc.querySelector(selector);
      if (popup) {
        (popup as HTMLElement).style.display = 'none';
        logger.log("[Interceptor] Hidden native popup:", selector);
      }
    }
  }

  private static async showPluginCreationDialog(
    reader: any,
    selection: Selection
  ): Promise<AnnotationCreationResult | null> {
    const dialog = new AnnotationCreationDialog(
      reader._iframe.contentDocument,
      selection.toString()
    );

    return await dialog.show();
  }

  private static async createAnnotation(
    reader: any,
    result: AnnotationCreationResult
  ): Promise<void> {
    // è°ƒç”¨Zotero APIåˆ›å»ºæ ‡æ³¨
    const parentItem = reader._item;
    const attachment = reader._annotationItem;

    const annotationData = {
      type: result.type, // 'highlight' | 'underline' | 'note'
      text: result.text,
      comment: result.comment,
      color: result.color,
      position: result.position, // ä»selectionä¸­æå–
      tags: []
    };

    // åˆ›å»ºæ ‡æ³¨
    const newAnnotation = new Zotero.Item('annotation');
    newAnnotation.parentID = attachment.id;
    newAnnotation.annotationType = annotationData.type;
    newAnnotation.annotationText = annotationData.text;
    newAnnotation.annotationComment = annotationData.comment;
    newAnnotation.annotationColor = annotationData.color;
    newAnnotation.annotationPosition = JSON.stringify(annotationData.position);
    await newAnnotation.saveTx();

    // åŒæ­¥åˆ°Supabase
    if (result.shareChoice.visibility !== 'private') {
      const user = AuthManager.getCurrentUser();
      if (user) {
        const { AnnotationManager } = await import('./annotations');
        const documentInfo = await SupabaseManager.getInstance().findOrCreateDocument(parentItem);
        
        await AnnotationManager.updateAnnotationSharing(
          {
            id: newAnnotation.id,
            key: newAnnotation.key,
            // ... å…¶ä»–å­—æ®µ
          },
          documentInfo.id,
          user.id,
          result.shareChoice.visibility,
          result.shareChoice.showAuthorName
        );
      }
    }
  }
}

interface AnnotationCreationResult {
  type: 'highlight' | 'underline' | 'note';
  text: string;
  comment: string;
  color: string;
  position: any;
  shareChoice: {
    visibility: 'public' | 'private';
    showAuthorName: boolean;
  };
}
```

##### Step 3: å®ç°æ’ä»¶æ ‡æ³¨åˆ›å»ºå¼¹çª—ï¼ˆ4-5å¤©ï¼‰
```typescript
// src/modules/ui/annotationCreationDialog.ts

export class AnnotationCreationDialog {
  private doc: Document;
  private selectedText: string;
  private dialogElement: HTMLElement | null = null;
  private resolvePromise: ((result: AnnotationCreationResult | null) => void) | null = null;

  constructor(doc: Document, selectedText: string) {
    this.doc = doc;
    this.selectedText = selectedText;
  }

  public show(): Promise<AnnotationCreationResult | null> {
    return new Promise((resolve) => {
      this.resolvePromise = resolve;
      this.render();
    });
  }

  private render(): void {
    this.dialogElement = this.doc.createElement('div');
    this.dialogElement.className = 'researchopia-annotation-dialog';
    this.dialogElement.style.cssText = `
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
      padding: 24px;
      z-index: 10002;
    `;

    this.dialogElement.innerHTML = `
      <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">
        åˆ›å»ºæ ‡æ³¨
      </h3>

      <!-- æ ‡æ³¨æ–‡æœ¬é¢„è§ˆ -->
      <div style="
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        max-height: 120px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.5;
      ">
        "${this.selectedText.substring(0, 200)}${this.selectedText.length > 200 ? '...' : ''}"
      </div>

      <!-- æ ‡æ³¨ç±»å‹ -->
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">
          æ ‡æ³¨ç±»å‹
        </label>
        <div style="display: flex; gap: 10px;">
          <button class="type-btn" data-type="highlight" style="
            flex: 1;
            padding: 10px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
            âœ¨ é«˜äº®
          </button>
          <button class="type-btn" data-type="underline" style="
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
            â– ä¸‹åˆ’çº¿
          </button>
          <button class="type-btn" data-type="note" style="
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          ">
            ğŸ“ ç¬”è®°
          </button>
        </div>
      </div>

      <!-- é¢œè‰²é€‰æ‹© -->
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">
          é¢œè‰²
        </label>
        <div style="display: flex; gap: 8px;">
          ${this.renderColorButtons()}
        </div>
      </div>

      <!-- è¯„è®º -->
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px;">
          è¯„è®ºï¼ˆå¯é€‰ï¼‰
        </label>
        <textarea id="annotation-comment" placeholder="æ·»åŠ ä½ çš„æƒ³æ³•..." style="
          width: 100%;
          min-height: 80px;
          padding: 10px;
          border: 1px solid #dee2e6;
          border-radius: 6px;
          font-family: inherit;
          font-size: 13px;
          resize: vertical;
          box-sizing: border-box;
        "></textarea>
      </div>

      <!-- ğŸ†• å…±äº«è®¾ç½® -->
      <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 13px;">
          ğŸŒ å…±äº«è®¾ç½®
        </label>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
          <button class="share-btn" data-visibility="public" data-show-name="true" style="
            padding: 8px;
            background: white;
            border: 2px solid #0d6efd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
          ">
            ğŸŒ å…¬å¼€
          </button>
          <button class="share-btn" data-visibility="public" data-show-name="false" style="
            padding: 8px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
          ">
            ğŸ•¶ï¸ åŒ¿å
          </button>
          <button class="share-btn" data-visibility="private" data-show-name="true" style="
            padding: 8px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
          ">
            ğŸ”’ ç§å¯†
          </button>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="btn-cancel" style="
          padding: 10px 20px;
          background: white;
          color: #6c757d;
          border: 1px solid #dee2e6;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
        ">
          å–æ¶ˆ
        </button>
        <button id="btn-create" style="
          padding: 10px 20px;
          background: #0d6efd;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
        ">
          åˆ›å»ºæ ‡æ³¨
        </button>
      </div>
    `;

    // æ·»åŠ åˆ°é¡µé¢
    this.doc.body.appendChild(this.dialogElement);

    // ç»‘å®šäº‹ä»¶
    this.attachEventListeners();
  }

  private renderColorButtons(): string {
    const colors = [
      { name: 'é»„è‰²', value: '#ffd400', border: '#ffc107' },
      { name: 'çº¢è‰²', value: '#ff6b6b', border: '#dc3545' },
      { name: 'ç»¿è‰²', value: '#51cf66', border: '#28a745' },
      { name: 'è“è‰²', value: '#339af0', border: '#0d6efd' },
      { name: 'ç´«è‰²', value: '#845ef7', border: '#6f42c1' }
    ];

    return colors.map((color, index) => `
      <button class="color-btn" data-color="${color.value}" style="
        width: 36px;
        height: 36px;
        background: ${color.value};
        border: 2px solid ${index === 0 ? color.border : '#dee2e6'};
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
      " title="${color.name}"></button>
    `).join('');
  }

  private attachEventListeners(): void {
    // ç±»å‹é€‰æ‹©
    this.dialogElement?.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.dialogElement?.querySelectorAll('.type-btn').forEach(b => {
          (b as HTMLElement).style.background = 'white';
          (b as HTMLElement).style.borderColor = '#dee2e6';
        });
        (btn as HTMLElement).style.background = '#fff3cd';
        (btn as HTMLElement).style.borderColor = '#ffc107';
      });
    });

    // é¢œè‰²é€‰æ‹©
    this.dialogElement?.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.dialogElement?.querySelectorAll('.color-btn').forEach(b => {
          (b as HTMLElement).style.borderColor = '#dee2e6';
          (b as HTMLElement).style.transform = 'scale(1)';
        });
        (btn as HTMLElement).style.borderColor = '#212529';
        (btn as HTMLElement).style.transform = 'scale(1.1)';
      });
    });

    // å…±äº«é€‰æ‹©
    this.dialogElement?.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.dialogElement?.querySelectorAll('.share-btn').forEach(b => {
          (b as HTMLElement).style.background = 'white';
          (b as HTMLElement).style.borderColor = '#dee2e6';
        });
        (btn as HTMLElement).style.background = '#e7f5ff';
        (btn as HTMLElement).style.borderColor = '#0d6efd';
      });
    });

    // å–æ¶ˆ
    this.dialogElement?.querySelector('#btn-cancel')?.addEventListener('click', () => {
      this.close(null);
    });

    // åˆ›å»º
    this.dialogElement?.querySelector('#btn-create')?.addEventListener('click', () => {
      this.handleCreate();
    });

    // Escå…³é—­
    this.doc.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        this.close(null);
      }
    }, { once: true });
  }

  private handleCreate(): void {
    // è·å–é€‰æ‹©çš„ç±»å‹
    const selectedTypeBtn = this.dialogElement?.querySelector('.type-btn[style*="background: rgb(255, 243, 205)"]');
    const type = selectedTypeBtn?.getAttribute('data-type') || 'highlight';

    // è·å–é€‰æ‹©çš„é¢œè‰²
    const selectedColorBtn = this.dialogElement?.querySelector('.color-btn[style*="border-color: rgb(33, 35, 41)"]');
    const color = selectedColorBtn?.getAttribute('data-color') || '#ffd400';

    // è·å–è¯„è®º
    const commentTextarea = this.dialogElement?.querySelector('#annotation-comment') as HTMLTextAreaElement;
    const comment = commentTextarea?.value || '';

    // è·å–å…±äº«é€‰æ‹©
    const selectedShareBtn = this.dialogElement?.querySelector('.share-btn[style*="background: rgb(231, 245, 255)"]');
    const visibility = selectedShareBtn?.getAttribute('data-visibility') || 'public';
    const showAuthorName = selectedShareBtn?.getAttribute('data-show-name') === 'true';

    // æ„å»ºç»“æœ
    const result: AnnotationCreationResult = {
      type: type as 'highlight' | 'underline' | 'note',
      text: this.selectedText,
      comment,
      color,
      position: {}, // TODO: ä»selectionä¸­æå–position
      shareChoice: {
        visibility: visibility as 'public' | 'private',
        showAuthorName
      }
    };

    this.close(result);
  }

  private close(result: AnnotationCreationResult | null): void {
    if (this.dialogElement) {
      this.dialogElement.remove();
      this.dialogElement = null;
    }

    if (this.resolvePromise) {
      this.resolvePromise(result);
      this.resolvePromise = null;
    }
  }
}
```

##### Step 4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰
```
â–¡ æµ‹è¯•åŸç”Ÿå¼¹çª—æ˜¯å¦æˆåŠŸéšè—
â–¡ æµ‹è¯•æ’ä»¶å¼¹çª—UIæ˜¯å¦æ­£å¸¸
â–¡ æµ‹è¯•æ ‡æ³¨åˆ›å»ºæ˜¯å¦æˆåŠŸ
â–¡ æµ‹è¯•åŒæ­¥åˆ°Supabaseæ˜¯å¦æ­£å¸¸
â–¡ è·¨ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•ï¼ˆZotero 7/8ï¼‰
â–¡ æ€§èƒ½ä¼˜åŒ–
â–¡ é”™è¯¯å¤„ç†
```

### 4.3 é¢„æœŸæˆæœ

- âœ… ç”¨æˆ·ä½“éªŒæ¥è¿‘å®Œç¾ï¼šåˆ›å»ºæ ‡æ³¨æ—¶å³å¯é€‰æ‹©å…±äº«æ–¹å¼
- âœ… é›¶é¢å¤–æ“ä½œï¼šæ— éœ€äº‹åå¼¹çª—
- âœ… åŠŸèƒ½é›†æˆï¼šåŸç”ŸåŠŸèƒ½+å…±äº«é€‰æ‹©åœ¨åŒä¸€ç•Œé¢
- âœ… å…±äº«ç‡å¯èƒ½è¿›ä¸€æ­¥æå‡åˆ°40-60%

### 4.4 é£é™©ä¸æŒ‘æˆ˜

**æŠ€æœ¯é£é™©**:
- âŒ å¯èƒ½æ— æ³•å®Œå…¨éšè—åŸç”Ÿå¼¹çª—ï¼ˆé—ªçƒé—®é¢˜ï¼‰
- âŒ Positionä¿¡æ¯æå–å¯èƒ½å›°éš¾
- âŒ è·¨ç‰ˆæœ¬å…¼å®¹æ€§å¯èƒ½æœ‰é—®é¢˜
- âŒ Zoteroæ›´æ–°å¯èƒ½å¯¼è‡´æ–¹æ¡ˆå¤±æ•ˆ

**æ›¿ä»£æ–¹æ¡ˆ**:
- å¦‚æœPhase 3å®ç°å›°éš¾ï¼ŒPhase 1å’Œ2å·²ç»è¶³å¤Ÿå®ç”¨
- å¯ä»¥ä½œä¸º"å®éªŒæ€§åŠŸèƒ½"æä¾›ç»™é«˜çº§ç”¨æˆ·

---

## 5. å®æ–½æ—¶é—´è¡¨

### 5.1 ç”˜ç‰¹å›¾

```
Week 1-2:   Phase 1 (æ ‡æ³¨åˆ›å»ºåå³æ—¶å…±äº«)
            â”œâ”€ Day 1-3: å¼€å‘
            â”œâ”€ Day 4-5: æµ‹è¯•
            â””â”€ Day 6-7: æ–‡æ¡£+å‘å¸ƒ
            
Week 3-4:   Phase 2 (PDFé¡µé¢overlayäº¤äº’)
            â”œâ”€ Day 1-2: åŸºç¡€æ¡†æ¶
            â”œâ”€ Day 3-4: UIå®ç°
            â””â”€ Day 5-6: åŠŸèƒ½é›†æˆ
            
Week 5-7:   Phase 3 (æ¥ç®¡åŸç”Ÿæ ‡æ³¨å¼¹çª—)
            â”œâ”€ Day 1-4: è°ƒç ”Zotero API
            â”œâ”€ Day 5-7: å®ç°æ–‡æœ¬é€‰æ‹©ç›‘å¬
            â”œâ”€ Day 8-12: å®ç°æ’ä»¶å¼¹çª—
            â””â”€ Day 13-14: æµ‹è¯•ä¸ä¼˜åŒ–
```

### 5.2 é‡Œç¨‹ç¢‘

```
âœ… Milestone 1: Phase 1ä¸Šçº¿ (Week 2ç»“æŸ)
   - å…±äº«ç‡æå‡åˆ°20-30%
   - ç”¨æˆ·åé¦ˆæ”¶é›†
   
âœ… Milestone 2: Phase 2ä¸Šçº¿ (Week 4ç»“æŸ)
   - PDFé¡µé¢äº¤äº’å®Œå–„
   - ç¤¾åŒºäº’åŠ¨å¢åŠ 
   
âœ… Milestone 3: Phase 3ä¸Šçº¿ (Week 7ç»“æŸ)
   - ç»ˆææ–¹æ¡ˆå®ç°
   - å…±äº«ç‡è¾¾åˆ°40-60%
```

### 5.3 çµæ´»è°ƒæ•´

- å¦‚æœPhase 1æ•ˆæœå¾ˆå¥½ï¼Œå¯ä»¥å»¶åPhase 2å’Œ3
- å¦‚æœPhase 3å®ç°å›°éš¾ï¼Œå¯ä»¥æ”¾å¼ƒï¼ŒPhase 1å’Œ2å·²ç»è¶³å¤Ÿ
- å¯ä»¥æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´ä¼˜å…ˆçº§

---

## 6. æŠ€æœ¯ä¾èµ–å…³ç³»

### 6.1 æ¨¡å—ä¾èµ–å›¾

```
InstantSharingManager (Phase 1)
    â†“ ä¾èµ–
    â”œâ”€ Zotero.Notifier
    â”œâ”€ QuickShareDialog
    â”œâ”€ AnnotationManager
    â””â”€ SupabaseManager

PDFReaderManager (Phase 2)
    â†“ ä¾èµ–
    â”œâ”€ ç°æœ‰çš„overlayåˆ›å»ºé€»è¾‘
    â”œâ”€ AnnotationPopup (æ–°å¢)
    â”œâ”€ UserHoverCardManager
    â””â”€ SupabaseManager

AnnotationCreationInterceptor (Phase 3)
    â†“ ä¾èµ–
    â”œâ”€ Zotero.Reader API
    â”œâ”€ AnnotationCreationDialog (æ–°å¢)
    â”œâ”€ AnnotationManager
    â””â”€ SupabaseManager
```

### 6.2 å¤ç”¨ç°æœ‰ç»„ä»¶

**Phase 1**:
- âœ… å®Œå…¨å¤ç”¨ `AnnotationManager.updateAnnotationSharing()`
- âœ… å¤ç”¨ `PreferenceManager`
- âœ… å¤ç”¨ `AuthManager`

**Phase 2**:
- âœ… å¤ç”¨ `SessionAnnotationsView` çš„è¯„è®ºæ¸²æŸ“é€»è¾‘
- âœ… å¤ç”¨ `UserHoverCardManager`
- âœ… å¤ç”¨ç‚¹èµã€è¯„è®ºAPI

**Phase 3**:
- âœ… å¤ç”¨ Phase 1 çš„åŒæ­¥é€»è¾‘
- âœ… å¤ç”¨ `AnnotationManager.createAnnotation()`

### 6.3 æ–°å¢ç»„ä»¶

**Phase 1**:
- ğŸ†• `InstantSharingManager`
- ğŸ†• `QuickShareDialog`

**Phase 2**:
- ğŸ†• `AnnotationPopup`

**Phase 3**:
- ğŸ†• `AnnotationCreationInterceptor`
- ğŸ†• `AnnotationCreationDialog`

---

## 7. æ€»ç»“

### 7.1 ä¸‰ä¸ªé˜¶æ®µå¯¹æ¯”

| ç‰¹æ€§ | Phase 1 | Phase 2 | Phase 3 |
|------|---------|---------|---------|
| **ç”¨æˆ·æµç¨‹** | åˆ›å»ºâ†’å¼¹çª—â†’é€‰æ‹© | ç‚¹å‡»overlayâ†’äº¤äº’ | é€‰æ‹©æ–‡æœ¬â†’å¼¹çª—ï¼ˆå«å…±äº«ï¼‰ |
| **æ‘©æ“¦ç¨‹åº¦** | ä½ | ä¸­ | æä½ |
| **æŠ€æœ¯å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ |
| **å¼€å‘æ—¶é—´** | 3-4å¤© | 5-6å¤© | 10-14å¤© |
| **é£é™©** | ä½ | ä¸­ | é«˜ |
| **å…±äº«ç‡æå‡** | +20-25% | +5-10% | +10-15% |
| **ä¾èµ–Phase 1** | - | æ˜¯ | æ˜¯ |

### 7.2 æ¨èç­–ç•¥

1. **ä¼˜å…ˆå®æ–½Phase 1**ï¼šå¿«é€Ÿä¸Šçº¿ï¼ŒéªŒè¯éœ€æ±‚ï¼Œæ”¶é›†åé¦ˆ
2. **è¯„ä¼°åå®æ–½Phase 2**ï¼šå¦‚æœPhase 1æ•ˆæœå¥½ï¼Œç»§ç»­Phase 2
3. **è°¨æ…å®æ–½Phase 3**ï¼šæŠ€æœ¯é£é™©é«˜ï¼Œå¯ä½œä¸ºå®éªŒæ€§åŠŸèƒ½

### 7.3 æˆåŠŸæ ‡å‡†

**Phase 1æˆåŠŸæ ‡å‡†**:
- âœ… å…±äº«ç‡ä»<5%æå‡åˆ°â‰¥20%
- âœ… åŠŸèƒ½ä½¿ç”¨ç‡â‰¥60%
- âœ… é”™è¯¯ç‡<1%

**Phase 2æˆåŠŸæ ‡å‡†**:
- âœ… overlayç‚¹å‡»ç‡â‰¥30%
- âœ… ç‚¹èµæ•°å¢é•¿â‰¥50%
- âœ… è¯„è®ºæ•°å¢é•¿â‰¥30%

**Phase 3æˆåŠŸæ ‡å‡†**:
- âœ… å…±äº«ç‡è¿›ä¸€æ­¥æå‡åˆ°â‰¥40%
- âœ… ç”¨æˆ·åé¦ˆ"ä½“éªŒæä½³"â‰¥70%
- âœ… è·¨ç‰ˆæœ¬å…¼å®¹æ€§æ— é—®é¢˜

---

**æ–‡æ¡£ç»“æŸ**

_ä¸‹ä¸€æ­¥ï¼šå¼€å§‹å®æ–½Phase 1ï¼_
