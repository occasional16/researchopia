# 17.1 论文详情页评价模块改进方案

> **目标**: 以论文详情页为标准，设计优秀的评分评论 UI，后续统一应用到所有场景

---

## 1. 现状问题

### 1.1 评分模块问题
- 评分表单和评分展示分离，布局割裂
- 缺少直观的统计可视化（如评分分布图）
- 匿名选项 UI 不够优雅
- **5星制粒度太粗**，难以区分评分差异

### 1.2 评论模块问题
- 评论表单和列表分离，体验不连贯
- 嵌套回复功能不明显
- 缺少用户头像和互动元素（点赞等）

---

## 2. 改进方案

### 2.1 评分制度改进：5星10分制 ⭐

采用类似**豆瓣**的评分方式：

| 显示 | 用户操作 | 存储值 | 描述 |
|------|---------|--------|------|
| ⭐⭐⭐⭐☆ 8.0 | 点击整星 | 8 | 对应4颗满星 |
| ⭐⭐⭐⭐★ 8.5 | 点击半星 | 8.5 | 对应4颗半星 |
| ⭐⭐⭐⭐⭐ 10 | 点击最后整星 | 10 | 满分 |

**交互设计**：
- 鼠标悬停：显示当前分数预览
- 点击左半：选择 0.5 分（半星）
- 点击右半：选择 1.0 分（整星）
- 显示格式：`⭐⭐⭐⭐☆ 8.0 分`

### 2.2 整体布局优化

```
┌─────────────────────────────────────────────────────┐
│ 📊 评价统计                                          │
│ ┌──────────────────┐ ┌────────────────────────────┐ │
│ │ 综合评分         │ │ 评分分布图                 │ │
│ │ ⭐ 8.2 (123人)   │ │ [柱状图: 9-10, 7-8, ...]   │ │
│ └──────────────────┘ └────────────────────────────┘ │
│                                                     │
│ 各维度评分: 创新性 8.3 | 方法论 8.1 | 实用性 8.2    │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ 📝 我的评分                                          │
│ ┌──────────────────────────────────────────────────┐│
│ │ 创新性   ⭐⭐⭐⭐☆ 8.0                          ││
│ │ 方法论   ⭐⭐⭐⭐⭐ 10                           ││
│ │ 实用性   ⭐⭐⭐☆☆ 6.0                          ││
│ │ 总体评价 ⭐⭐⭐⭐★ 8.5                          ││
│ │                                                  ││
│ │ ☐ 匿名评分          [提交评分]                  ││
│ └──────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ 💬 评论 (56)                                         │
│ ┌──────────────────────────────────────────────────┐│
│ │ [输入框] 分享您对这篇论文的看法...                ││
│ │                               ☐ 匿名  [发表评论] ││
│ └──────────────────────────────────────────────────┘│
│                                                     │
│ ┌──────────────────────────────────────────────────┐│
│ │ 👤 张三 · 2小时前                                 ││
│ │ 这篇论文的创新点很突出，特别是在...               ││
│ │                          👍 12  💬 回复  🗑️ 删除 ││
│ │                                                  ││
│ │   └─ 👤 李四 · 1小时前                           ││
│ │      同意，我认为...                             ││
│ │                      👍 3  💬 回复               ││
│ └──────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

### 2.3 数据库兼容方案

现有数据库存储 1-5 整数，迁移方案：

| 方案 | 描述 | 推荐 |
|------|------|------|
| **A: 乘2** | 旧数据 × 2（如 4 → 8）| ✅ 简单 |
| B: 新字段 | 新增 `_score_10` 字段 | 复杂 |
| C: 新表 | 创建新评分表 | 复杂 |

**推荐方案 A**：
- 前端显示时：`score * 2` 得到10分制
- 存储时：`inputScore / 2` 存回5分制
- 向后兼容，无需数据迁移

---

## 3. 实施步骤

1. ✅ 方案确认
2. ✅ 实现 10 分制星级组件
   - 数据库迁移：rating 约束从 1-5 改为 1-10，现有数据 × 2
   - `RatingForm.tsx`: 支持半星点击 (左半奇数、右半偶数)
   - `RatingDisplay.tsx`: 支持半星显示
   - `RatingAnalyticsDisplay.tsx`: 分布图和置信区间适配 1-10
   - `ratingAlgorithms.ts`: 分布计算适配 1-10
3. ✅ 更新论文详情页 UI
4. ✅ 用户验收 (论文详情页)
5. ✅ 提取为统一组件
   - `src/components/evaluation/shared/StarRating.tsx` 已是 10 分制
   - `src/components/evaluation/shared/EvaluationForm.tsx` 已适配
6. ✅ 应用到其他场景
   - ✅ 网页详情页 (`webpages/[urlHash]/page.tsx`) - 使用统一组件
   - ✅ 浏览器扩展 sidebar - 已更新为 10 分制半星系统
   - ✅ Zotero 插件 - 已更新为 10 分制半星系统

---

## 4. 修改的文件清单

| 文件 | 修改内容 |
|------|----------|
| `src/components/rating/RatingForm.tsx` | 半星评分交互，分数显示格式 |
| `src/components/rating/RatingDisplay.tsx` | 半星渲染 `getStarFill()` |
| `src/components/rating/RatingAnalyticsDisplay.tsx` | 分布图 1-10，置信区间 1-10 |
| `src/lib/ratingAlgorithms.ts` | `calculateRatingDistribution()` 1-10 |
| `src/app/api/v2/ratings/route.ts` | 验证范围从 1-5 改为 1-10 |
| 数据库迁移 `update_rating_constraints_to_10_scale` | 约束 1-10，现有数据 ×2 |
| `extension/sidebar.html` | 星级样式支持半星 |
| `extension/sidebar.js` | 半星交互逻辑 |
| `zotero-plugin/src/modules/ui/paperEvaluationView.ts` | 10分制半星评分交互 |

---

**文档版本**: v0.6  
**更新日期**: 2025-01-13
