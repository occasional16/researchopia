# 1.4.10 Zoteroå·¦ä¾§Sidebaræ ‡æ³¨ç®¡ç†æœ€ä½³å®è·µæ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-XX  
**ä½œè€…**: AIåŠ©æ‰‹  
**çŠ¶æ€**: ğŸŸ¡ è®¾è®¡é˜¶æ®µ - å¾…ç”¨æˆ·è¯„å®¡

---

## ğŸ“‹ ç›®å½•

1. [èƒŒæ™¯ä¸é—®é¢˜](#1-èƒŒæ™¯ä¸é—®é¢˜)
2. [Zotero Reader Sidebar æ¶æ„åˆ†æ](#2-zotero-reader-sidebar-æ¶æ„åˆ†æ)
3. [ç°æœ‰æ–¹æ¡ˆè¯„ä¼°](#3-ç°æœ‰æ–¹æ¡ˆè¯„ä¼°)
4. [æ¨èæ–¹æ¡ˆè®¾è®¡](#4-æ¨èæ–¹æ¡ˆè®¾è®¡)
5. [æŠ€æœ¯å®ç°è·¯å¾„](#5-æŠ€æœ¯å®ç°è·¯å¾„)
6. [é£é™©ä¸æŒ‘æˆ˜](#6-é£é™©ä¸æŒ‘æˆ˜)
7. [å†³ç­–å»ºè®®](#7-å†³ç­–å»ºè®®)

---

## 1. èƒŒæ™¯ä¸é—®é¢˜

### 1.1 å½“å‰å®ç°ç°çŠ¶

**å·²å®ŒæˆåŠŸèƒ½**:
- âœ… **annotation-popupå¢å¼º**: åœ¨PDF viewerå†…çš„annotation popupä¸­æ³¨å…¥4ä¸ªå…±äº«æŒ‰é’®(public/followers/private/cancel)
- âœ… **å…±äº«ä¿¡æ¯å±•ç¤º**: åœ¨popupä¸‹æ–¹æ˜¾ç¤ºè¯„è®ºã€ç‚¹èµç­‰ç¤¾äº¤ä¿¡æ¯
- âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åˆ›å»º/æ›´æ–°/åˆ é™¤å…±äº«çŠ¶æ€,è‡ªåŠ¨å…³è”reading session
- âœ… **æ€§èƒ½ä¼˜åŒ–**: 200ms polling + documentç¼“å­˜ + shared infoç¼“å­˜(5ç§’TTL)

**å®ç°ä½ç½®**:
- `zotero-plugin/src/modules/annotationSharingPopup.ts` (ä¸»ç±»)
- `zotero-plugin/src/modules/ui/utils/CommentRenderer.ts` (è¯„è®ºæ¸²æŸ“å·¥å…·ç±»)

### 1.2 ç”¨æˆ·ç—›ç‚¹

**å½“å‰æ–¹æ¡ˆçš„å±€é™æ€§**:

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| **äº¤äº’ä¸ç¬¦åˆZoteroä¹ æƒ¯** | éœ€è¦å…ˆå³é”®ç‚¹å‡»annotation,ç­‰å¾…popupå‡ºç°æ‰èƒ½å…±äº« | ç”¨æˆ·ä½“éªŒä¸æµç•…,å¢åŠ æ“ä½œæ­¥éª¤ |
| **æ‰¹é‡æ“ä½œç¼ºå¤±** | æ— æ³•æ‰¹é‡å…±äº«/å–æ¶ˆå…±äº«å¤šä¸ªæ ‡æ³¨ | ç®¡ç†å¤§é‡æ ‡æ³¨æ—¶æ•ˆç‡ä½ä¸‹ |
| **ä¿¡æ¯å±•ç¤ºä¸å……åˆ†** | Popupç©ºé—´æœ‰é™,æ— æ³•å±•ç¤ºå®Œæ•´çš„ç¤¾äº¤ä¿¡æ¯(é•¿è¯„è®ºåˆ—è¡¨) | ç”¨æˆ·æ— æ³•å…¨é¢äº†è§£æ ‡æ³¨çš„è®¨è®ºæƒ…å†µ |
| **ä¸åŸç”ŸåŠŸèƒ½å‰²è£‚** | Zoteroå·¦ä¾§sidebarå·²æœ‰"Show Annotations"é¡µé¢,æˆ‘ä»¬å¦èµ·ç‚‰ç¶ | å­¦ä¹ æˆæœ¬é«˜,è¿åæœ€å°æƒŠè®¶åŸåˆ™ |

**ç”¨æˆ·æœŸæœ›**:
> "æœ€ä½³å®è·µåº”è¯¥æ˜¯åœ¨Zoteroå·¦ä¾§sidebarå®ç°ç°æœ‰ç®¡ç†æ ‡æ³¨å’Œå…±äº«æ ‡æ³¨é¡µé¢çš„åŠŸèƒ½"

---

## 2. Zotero Reader Sidebar æ¶æ„åˆ†æ

### 2.1 Sidebar åŸºç¡€ç»“æ„

**HTML å±‚çº§** (åŸºäº `Debug/Zotero-HTML/sidebarContent.html`):

```html
<div id="sidebarContent">
  <!-- Tabåˆ‡æ¢åŒº -->
  <div class="toolbar">
    <div id="view-thumbnails-button">Thumbnails</div>
    <div id="view-annotations-button">Show Annotations</div> â† æ ‡æ³¨åˆ—è¡¨
    <div id="view-outline-button">Outline</div>
  </div>
  
  <!-- Annotations View -->
  <div id="annotationsView" role="tabpanel">
    <!-- æ ‡æ³¨åˆ—è¡¨å®¹å™¨ -->
    <div id="annotations" class="annotations">
      <!-- å•ä¸ªæ ‡æ³¨å¡ç‰‡ -->
      <div class="annotation" data-sidebar-annotation-id="5ESYPV6C">
        <div class="preview">
          <header>
            <div class="start"><!-- é¡µç  --></div>
            <div class="end">
              <div class="custom-sections"></div> â† â­ æ’ä»¶æ³¨å…¥ç‚¹
            </div>
          </header>
          <div class="text">æ ‡æ³¨é«˜äº®æ–‡æœ¬...</div>
          <div class="comment">ç”¨æˆ·è¯„è®º...</div>
          <div class="tags"><!-- æ ‡ç­¾ --></div>
        </div>
      </div>
      <!-- æ›´å¤šæ ‡æ³¨... -->
    </div>
    
    <!-- é¢œè‰²ç­›é€‰å™¨ -->
    <div id="selector">
      <div class="colors">
        <div class="color yellow" data-color="yellow">Yellow</div>
        <div class="color red" data-color="red">Red</div>
        <!-- å…¶ä»–é¢œè‰² -->
      </div>
    </div>
  </div>
</div>
```

**å…³é”®DOMå…ƒç´ **:
- `#annotationsView`: Annotations tabçš„ä¸»å®¹å™¨
- `#annotations.annotations`: æ ‡æ³¨åˆ—è¡¨æ»šåŠ¨å®¹å™¨
- `.annotation[data-sidebar-annotation-id]`: å•ä¸ªæ ‡æ³¨å¡ç‰‡(åŒ…å«annotation key)
- `.custom-sections`: **æ’ä»¶è‡ªå®šä¹‰å†…å®¹æ³¨å…¥ç‚¹**(åœ¨æ¯ä¸ªannotation headerä¸­)
- `#selector .colors`: é¢œè‰²ç­›é€‰å™¨(å¯å‚è€ƒå…¶è®¾è®¡æ·»åŠ "å…±äº«çŠ¶æ€ç­›é€‰")

### 2.2 Zotero Reader API ç ”ç©¶

**åŸºäº `zotero/zotero` GitHubä»“åº“æºç åˆ†æ**:

#### 2.2.1 äº‹ä»¶ç›‘å¬æœºåˆ¶

`chrome/content/zotero/xpcom/reader.js` Line 2011-2068:

```javascript
class Reader {
  /**
   * æ’ä»¶å¯ä»¥æ³¨å…¥DOMåˆ°reader UI:
   * - renderTextSelectionPopup (selection popup)
   * - renderSidebarAnnotationHeader (sidebaræ ‡æ³¨å¡ç‰‡header) â† â­ å…³é”®
   * - renderToolbar (å·¥å…·æ )
   */
  registerEventListener(type, handler, pluginID = undefined) {
    if (!this._registeredListeners[type]) {
      this._registeredListeners[type] = [];
    }
    this._registeredListeners[type].push({ handler, pluginID });
  }
}
```

**å¯ç”¨çš„sidebarç›¸å…³äº‹ä»¶**:

| äº‹ä»¶åç§° | è§¦å‘æ—¶æœº | äº‹ä»¶å‚æ•° | ç”¨é€” |
|---------|---------|----------|------|
| `renderSidebarAnnotationHeader` | æ¯ä¸ªsidebaræ ‡æ³¨å¡ç‰‡æ¸²æŸ“æ—¶ | `{reader, doc, params, append}` | **æ³¨å…¥è‡ªå®šä¹‰UIåˆ°æ ‡æ³¨å¡ç‰‡** |
| `createAnnotationContextMenu` | å³é”®ç‚¹å‡»sidebaræ ‡æ³¨æ—¶ | `{reader, params, append}` | æ·»åŠ è‡ªå®šä¹‰å³é”®èœå•é¡¹ |
| `createSelectorContextMenu` | å³é”®ç‚¹å‡»é¢œè‰²ç­›é€‰å™¨æ—¶ | `{reader, params, append}` | æ·»åŠ ç­›é€‰å™¨èœå•é¡¹ |

**ç¤ºä¾‹ä»£ç ** (æ¥è‡ªZoteroå®˜æ–¹æ–‡æ¡£æ³¨é‡Š):

```typescript
// åœ¨sidebaræ ‡æ³¨å¡ç‰‡headeræ³¨å…¥è‡ªå®šä¹‰å†…å®¹
Zotero.Reader.registerEventListener('renderSidebarAnnotationHeader', (event) => {
  let { reader, doc, params, append } = event;
  
  // params.annotation: å½“å‰æ ‡æ³¨å¯¹è±¡
  // params.annotation.id: annotation key (å¦‚ "5ESYPV6C")
  
  // åˆ›å»ºè‡ªå®šä¹‰DOM
  let container = doc.createElement('div');
  container.className = 'custom-share-buttons';
  container.innerHTML = '<button>Share</button>';
  
  // æ³¨å…¥åˆ°.custom-sections
  append(container);
});
```

#### 2.2.2 Sidebar æ¸²æŸ“æ—¶æœº

**å‘ç°**:
- âŒ **æ²¡æœ‰** `onSidebarAnnotationListRendered` äº‹ä»¶(sidebaræ•´ä½“æ¸²æŸ“å®Œæˆ)
- âœ… **æœ‰** `renderSidebarAnnotationHeader` äº‹ä»¶(æ¯ä¸ªå¡ç‰‡ç‹¬ç«‹è§¦å‘)
- âš ï¸ **æ³¨æ„**: ç­›é€‰/æ’åºåä¼šé‡æ–°æ¸²æŸ“å¡ç‰‡,éœ€é‡æ–°æ³¨å…¥

**æ¸²æŸ“æµç¨‹**:
```
ç”¨æˆ·æ‰“å¼€PDF â†’ Readeråˆå§‹åŒ– â†’ SidebaråŠ è½½æ ‡æ³¨åˆ—è¡¨
   â†“
æ¯ä¸ªannotationå¡ç‰‡æ¸²æŸ“ â†’ è§¦å‘ renderSidebarAnnotationHeader
   â†“
æ’ä»¶é€šè¿‡ append() æ³¨å…¥è‡ªå®šä¹‰UI
```

### 2.3 ä¸ç°æœ‰ annotation-popup æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | annotation-popup | sidebar |
|------|------------------|---------|
| **æ£€æµ‹æœºåˆ¶** | 200ms polling (æ— å®˜æ–¹API) | `renderSidebarAnnotationHeader` äº‹ä»¶ âœ… |
| **æ³¨å…¥ç‚¹** | `.annotation-popup` (popupå®¹å™¨) | `.custom-sections` (å¡ç‰‡header) |
| **è·å–annotation key** | `popupElement.id` | `params.annotation.id` âœ… |
| **æŒä¹…æ€§** | Popupå…³é—­åUIæ¶ˆå¤± | SidebaræŒä¹…æ˜¾ç¤º âœ… |
| **æ‰¹é‡æ“ä½œæ”¯æŒ** | æ— (å•ä¸ªpopup) âŒ | å¯æ·»åŠ å…¨å±€ç­›é€‰/æ‰¹é‡æŒ‰é’® âœ… |
| **ç”¨æˆ·ä¹ æƒ¯** | éZoteroåŸç”Ÿäº¤äº’ | ç¬¦åˆZoteroè®¾è®¡å“²å­¦ âœ… |

---

## 3. ç°æœ‰æ–¹æ¡ˆè¯„ä¼°

### 3.1 æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

æˆ‘ä»¬æœ‰2ä¸ªæ ¸å¿ƒé¡µé¢æ‰¿è½½æ ‡æ³¨ç®¡ç†åŠŸèƒ½:
1. **ç®¡ç†æ ‡æ³¨é¡µé¢** (`myAnnotationsView.ts`): åœ¨item paneä¸­æ˜¾ç¤º,æ”¯æŒæ‰¹é‡æ“ä½œ
2. **å…±äº«æ ‡æ³¨é¡µé¢** (`sessionAnnotationsView.ts`): æ˜¾ç¤ºå½“å‰sessionçš„å…±äº«æ ‡æ³¨,æ”¯æŒè¯„è®º/ç‚¹èµ

**é›†æˆæ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | æè¿° | ä¼˜åŠ¿ | åŠ£åŠ¿ | æŠ€æœ¯å¯è¡Œæ€§ |
|------|------|------|------|-----------|
| **A. å¢å¼ºåŸç”Ÿ"Show Annotations"** | åœ¨sidebarçš„"Show Annotations" tabæ³¨å…¥å…±äº«æŒ‰é’®+ä¿¡æ¯ | âœ… æœ€ç¬¦åˆZoteroä¹ æƒ¯<br>âœ… æ— éœ€å­¦ä¹ æ–°äº¤äº’<br>âœ… æ ‡æ³¨åˆ—è¡¨å·²å­˜åœ¨ | âš ï¸ ç©ºé—´æœ‰é™(å¡ç‰‡è¾ƒå°)<br>âš ï¸ æ— æ³•å®Œå…¨æ›¿ä»£ç°æœ‰é¡µé¢ | ğŸŸ¢ **é«˜** - ä½¿ç”¨å®˜æ–¹API |
| **B. æ–°å¢"Shared Annotations" tab** | åœ¨sidebaræ·»åŠ ç¬¬4ä¸ªtab(Thumbnails/Annotations/Outline/**Shared**) | âœ… ç‹¬ç«‹ç©ºé—´<br>âœ… å¯å¤ç”¨ç°æœ‰é¡µé¢é€»è¾‘ | âŒ ä¿®æ”¹ZoteroåŸç”ŸUI(ä¾µå…¥æ€§å¼º)<br>âŒ æŠ€æœ¯éš¾åº¦é«˜ | ğŸ”´ **ä½** - éœ€hook Zoteroå†…éƒ¨ |
| **C. æ··åˆæ–¹æ¡ˆ(æ¨è)** | Sidebaræ³¨å…¥è½»é‡æ§åˆ¶ + ä¿ç•™item paneå®Œæ•´é¡µé¢ | âœ… æ¸è¿›å¼å¢å¼º<br>âœ… å…¼é¡¾å¿«æ·æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§ | âš ï¸ éœ€ç»´æŠ¤ä¸¤å¥—UI | ğŸŸ¢ **é«˜** - åˆ†é˜¶æ®µå®æ–½ |

### 3.2 æŠ€æœ¯å®ç°éš¾åº¦è¯„ä¼°

| æ–¹æ¡ˆ | Zotero APIéœ€æ±‚ | ä»£ç å¤æ‚åº¦ | ç»´æŠ¤æˆæœ¬ | ç”¨æˆ·å­¦ä¹ æ›²çº¿ |
|------|---------------|----------|----------|-------------|
| **A** | `renderSidebarAnnotationHeader` (å·²å­˜åœ¨) | â­â­ (ä¸­ç­‰) | â­ (ä½) | â­ (æ— ) |
| **B** | éœ€hookåº•å±‚tabç³»ç»Ÿ(ä¸æ¨è) | â­â­â­â­â­ (æé«˜) | â­â­â­â­â­ (æé«˜) | â­â­ (ä¸­ç­‰) |
| **C** | `renderSidebarAnnotationHeader` + ç°æœ‰item pane | â­â­â­ (ä¸­é«˜) | â­â­ (ä¸­ç­‰) | â­ (ä½) |

---

## 4. æ¨èæ–¹æ¡ˆè®¾è®¡

### 4.1 æ€»ä½“æ¶æ„: **æ··åˆæ–¹æ¡ˆ (C)**

**è®¾è®¡ç†å¿µ**:
- ğŸ¯ **80/20åŸåˆ™**: Sidebaræä¾›80%å¸¸ç”¨æ“ä½œ(å¿«é€Ÿå…±äº«),item paneä¿ç•™20%é«˜çº§åŠŸèƒ½(æ‰¹é‡ç®¡ç†ã€è¯¦ç»†ä¿¡æ¯)
- ğŸ§© **æ¸è¿›å¼å¢å¼º**: å…ˆå®ç°sidebaråŸºç¡€åŠŸèƒ½,éªŒè¯åå†æ‰©å±•
- ğŸ”— **èŒè´£åˆ†ç¦»**: Sidebar = å¿«æ·æ“ä½œå…¥å£,item pane = å®Œæ•´ç®¡ç†ä¸­å¿ƒ

**ç”¨æˆ·äº¤äº’æµç¨‹**:

```
ç”¨æˆ·æ‰“å¼€PDF
   â†“
Sidebaræ˜¾ç¤ºæ ‡æ³¨åˆ—è¡¨ (åŸç”Ÿ"Show Annotations")
   â†“
æ¯ä¸ªæ ‡æ³¨å¡ç‰‡headeræ˜¾ç¤º:
   - å…±äº«çŠ¶æ€å›¾æ ‡ (public/followers/private/æœªå…±äº«)
   - å¿«æ·å…±äº«æŒ‰é’® (ç‚¹å‡»åˆ‡æ¢çŠ¶æ€)
   - ç¤¾äº¤ä¿¡æ¯é¢„è§ˆ (ğŸ‘ 5 likes, ğŸ’¬ 3 comments)
   â†“
ã€å¿«é€Ÿæ“ä½œã€‘ç‚¹å‡»å¿«æ·æŒ‰é’® â†’ ç›´æ¥åˆ‡æ¢å…±äº«çŠ¶æ€
ã€æ·±åº¦ç®¡ç†ã€‘ç‚¹å‡»"ç®¡ç†æ ‡æ³¨"æŒ‰é’® â†’ è·³è½¬åˆ°item paneå®Œæ•´é¡µé¢
```

### 4.2 Sidebar UIè®¾è®¡

#### 4.2.1 å•ä¸ªæ ‡æ³¨å¡ç‰‡å¢å¼º

**æ³¨å…¥ä½ç½®**: `.custom-sections` div (åœ¨annotation headerçš„å³ä¾§)

**è§†è§‰è®¾è®¡** (Mockup):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page 5          [ğŸŒ][ğŸ‘¤][ğŸ”’][âŒ]  â† 4ä¸ªå…±äº«æŒ‰é’®
â”‚                 ğŸ‘ 5  ğŸ’¬ 3         â† ç¤¾äº¤ä¿¡æ¯é¢„è§ˆ
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ "This is the annotation text..."        â”‚
â”‚ Comment: "My notes..."                   â”‚
â”‚ #tag1 #tag2                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UIç»„ä»¶æ¸…å•**:

| ç»„ä»¶ | ç±»å‹ | åŠŸèƒ½ | äº¤äº’ |
|------|------|------|------|
| **å…±äº«æŒ‰é’®ç»„** | Button group | åˆ‡æ¢å…±äº«çŠ¶æ€ | ç‚¹å‡» â†’ è°ƒç”¨`updateAnnotationSharing()` |
| **çŠ¶æ€å›¾æ ‡** | Icon | æ˜¾ç¤ºå½“å‰å…±äº«çŠ¶æ€ | è§†è§‰åé¦ˆ |
| **ç¤¾äº¤ä¿¡æ¯** | Text label | æ˜¾ç¤ºç‚¹èµ/è¯„è®ºæ•° | ç‚¹å‡» â†’ å±•å¼€å®Œæ•´è¯„è®ºåˆ—è¡¨ |
| **"ç®¡ç†"æŒ‰é’®** | Link button | è·³è½¬item pane | ç‚¹å‡» â†’ `addon.ui.showInItemPane()` |

#### 4.2.2 å…¨å±€ç­›é€‰å™¨å¢å¼º

**æ³¨å…¥ä½ç½®**: `#selector` (åœ¨é¢œè‰²ç­›é€‰å™¨æ—è¾¹)

**è§†è§‰è®¾è®¡** (Mockup):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Color: [Yellow] [Red] [Green] [Blue]    â”‚
â”‚ Share: [ğŸŒ Public] [ğŸ‘¤ Followers] [ğŸ”’ Private] [â“ Not Shared] â”‚
â”‚ [æ‰¹é‡å…±äº«] [åˆ·æ–°]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½**:
- **ç­›é€‰æŒ‰é’®**: ç‚¹å‡»ååªæ˜¾ç¤ºå¯¹åº”å…±äº«çŠ¶æ€çš„æ ‡æ³¨(ç±»ä¼¼é¢œè‰²ç­›é€‰å™¨)
- **æ‰¹é‡å…±äº«æŒ‰é’®**: å¯¹å½“å‰ç­›é€‰ç»“æœæ‰¹é‡åº”ç”¨å…±äº«çŠ¶æ€
- **åˆ·æ–°æŒ‰é’®**: é‡æ–°æŸ¥è¯¢æ ‡æ³¨å…±äº«çŠ¶æ€(æ¸…é™¤ç¼“å­˜)

### 4.3 Item Pane é¡µé¢ä¿ç•™

**ä¿ç•™ç†ç”±**:
1. **æ‰¹é‡æ“ä½œ**: Sidebarç©ºé—´æœ‰é™,å¤æ‚æ‰¹é‡æ“ä½œ(å¦‚"å…±äº«æ‰€æœ‰çº¢è‰²æ ‡æ³¨")éœ€è¦ä¸“é—¨é¡µé¢
2. **è¯¦ç»†ä¿¡æ¯**: å®Œæ•´è¯„è®ºåˆ—è¡¨ã€ç‚¹èµç”¨æˆ·åˆ—è¡¨ã€åˆ†äº«å†å²ç­‰
3. **é«˜çº§é…ç½®**: å¦‚"æ˜¯å¦æ˜¾ç¤ºä½œè€…å"ã€"å¯¼å‡ºå…±äº«æ ‡æ³¨"ç­‰

**é¡µé¢å…³ç³»**:
```
Sidebar (å¿«æ·å…¥å£)
   â†“ ç‚¹å‡»"ç®¡ç†æ ‡æ³¨"
Item Pane: ç®¡ç†æ ‡æ³¨é¡µé¢ (myAnnotationsView)
   - æ˜¾ç¤ºæ‰€æœ‰æ ‡æ³¨
   - æ‰¹é‡æ“ä½œå·¥å…·
   - ç­›é€‰/æ’åºåŠŸèƒ½
   
Sidebar (ç¤¾äº¤ä¿¡æ¯é¢„è§ˆ)
   â†“ ç‚¹å‡»è¯„è®ºæ•°
Item Pane: å…±äº«æ ‡æ³¨è¯¦æƒ… (sessionAnnotationsView)
   - å®Œæ•´è¯„è®ºåˆ—è¡¨
   - ç‚¹èµç”¨æˆ·åˆ—è¡¨
   - å›å¤è¯„è®ºåŠŸèƒ½
```

---

## 5. æŠ€æœ¯å®ç°è·¯å¾„

### 5.1 Phase 1: SidebaråŸºç¡€æ³¨å…¥ (1å‘¨)

**ç›®æ ‡**: åœ¨sidebaræ ‡æ³¨å¡ç‰‡æ˜¾ç¤ºå…±äº«çŠ¶æ€å’Œå¿«æ·æŒ‰é’®

**å®ç°æ­¥éª¤**:

1. **åˆ›å»º SidebarAnnotationEnhancer ç±»**:
   ```typescript
   // zotero-plugin/src/modules/sidebarAnnotationEnhancer.ts
   export class SidebarAnnotationEnhancer {
     async register(reader: any): Promise<void> {
       // ç›‘å¬sidebaræ ‡æ³¨å¡ç‰‡æ¸²æŸ“
       Zotero.Reader.registerEventListener(
         'renderSidebarAnnotationHeader',
         this.onRenderAnnotation.bind(this),
         addon.id
       );
     }
     
     private async onRenderAnnotation(event: any): Promise<void> {
       const { reader, doc, params, append } = event;
       const annotationKey = params.annotation.id; // è·å–annotation key
       
       // åˆ›å»ºå…±äº«æŒ‰é’®UI
       const container = this.createShareButtons(doc, annotationKey);
       append(container); // æ³¨å…¥åˆ°.custom-sections
       
       // å¼‚æ­¥åŠ è½½å…±äº«çŠ¶æ€
       this.loadShareStatus(container, annotationKey);
     }
   }
   ```

2. **å¤ç”¨ç°æœ‰ä»£ç **:
   - **æŒ‰é’®åˆ›å»ºé€»è¾‘**: ä» `annotationSharingPopup.ts` æå–
   - **APIæŸ¥è¯¢**: å¤ç”¨ `queryAnnotationShareStatus()`
   - **ç¼“å­˜æœºåˆ¶**: å¤ç”¨ `documentCache` å’Œ `sharedInfoCache`

3. **ä¼˜åŒ–ç‚¹**:
   - âœ… ä½¿ç”¨å®˜æ–¹API,æ— éœ€polling(æ€§èƒ½ä¼˜äºpopupæ–¹æ¡ˆ)
   - âœ… ç›´æ¥è·å– `params.annotation.id`,æ— éœ€DOMæŸ¥è¯¢
   - âœ… äº‹ä»¶é©±åŠ¨,è‡ªåŠ¨å¤„ç†ç­›é€‰/æ’åºåçš„é‡æ–°æ¸²æŸ“

**é¢„æœŸäº§å‡º**:
- æ–‡ä»¶: `sidebarAnnotationEnhancer.ts` (~300è¡Œ)
- æ•ˆæœ: æ¯ä¸ªsidebaræ ‡æ³¨å¡ç‰‡æ˜¾ç¤º4ä¸ªå…±äº«æŒ‰é’®

### 5.2 Phase 2: ç¤¾äº¤ä¿¡æ¯å±•ç¤º (3å¤©)

**ç›®æ ‡**: åœ¨sidebaræ˜¾ç¤ºç‚¹èµ/è¯„è®ºé¢„è§ˆ

**å®ç°æ­¥éª¤**:

1. **æ³¨å…¥ç¤¾äº¤ä¿¡æ¯UI**:
   ```typescript
   private createSocialInfo(doc: Document, annotationKey: string): HTMLElement {
     const infoDiv = doc.createElement('div');
     infoDiv.className = 'researchopia-social-info';
     infoDiv.innerHTML = `
       <span class="likes">ğŸ‘ <span class="count">-</span></span>
       <span class="comments">ğŸ’¬ <span class="count">-</span></span>
     `;
     
     // ç‚¹å‡»å±•å¼€å®Œæ•´è¯„è®º
     infoDiv.addEventListener('click', () => {
       this.showCommentsInItemPane(annotationKey);
     });
     
     return infoDiv;
   }
   ```

2. **å¤ç”¨ CommentRenderer**:
   - å¦‚æœç”¨æˆ·ç‚¹å‡»è¯„è®ºæ•°,åœ¨item paneæ‰“å¼€ `sessionAnnotationsView`
   - æ»šåŠ¨åˆ°å¯¹åº”annotationçš„è¯„è®ºåŒº

**é¢„æœŸäº§å‡º**:
- ä¿®æ”¹: `sidebarAnnotationEnhancer.ts` (+50è¡Œ)
- æ•ˆæœ: æ˜¾ç¤º "ğŸ‘ 5 ğŸ’¬ 3",ç‚¹å‡»è·³è½¬item pane

### 5.3 Phase 3: å…¨å±€ç­›é€‰å™¨ (5å¤©)

**ç›®æ ‡**: åœ¨sidebaræ·»åŠ "æŒ‰å…±äº«çŠ¶æ€ç­›é€‰"åŠŸèƒ½

**å®ç°æ­¥éª¤**:

1. **åˆ›å»ºç­›é€‰å™¨UI**:
   ```typescript
   private injectShareFilter(doc: Document, selectorContainer: HTMLElement): void {
     const filterDiv = doc.createElement('div');
     filterDiv.className = 'share-status-filter';
     filterDiv.innerHTML = `
       <div class="filter-label">Share:</div>
       <div class="filter-buttons">
         <button data-share="public">ğŸŒ Public</button>
         <button data-share="followers">ğŸ‘¤ Followers</button>
         <button data-share="private">ğŸ”’ Private</button>
         <button data-share="null">â“ Not Shared</button>
       </div>
     `;
     
     // ç‚¹å‡»ç­›é€‰æŒ‰é’® â†’ éšè—ä¸åŒ¹é…çš„æ ‡æ³¨å¡ç‰‡
     filterDiv.addEventListener('click', (e) => {
       const target = e.target as HTMLElement;
       if (target.tagName === 'BUTTON') {
         this.filterByShareStatus(doc, target.dataset.share);
       }
     });
     
     selectorContainer.appendChild(filterDiv);
   }
   ```

2. **ç­›é€‰é€»è¾‘**:
   ```typescript
   private async filterByShareStatus(doc: Document, shareMode: string): Promise<void> {
     // 1. è·å–æ‰€æœ‰sidebaræ ‡æ³¨å¡ç‰‡
     const annotationCards = doc.querySelectorAll('.annotation[data-sidebar-annotation-id]');
     
     // 2. éå†æ¯ä¸ªå¡ç‰‡,æŸ¥è¯¢å…¶å…±äº«çŠ¶æ€
     for (const card of annotationCards) {
       const annotationKey = card.getAttribute('data-sidebar-annotation-id');
       const shareStatus = await this.getAnnotationShareStatus(annotationKey);
       
       // 3. ä¸åŒ¹é…çš„éšè—
       if (shareMode !== 'all' && shareStatus?.visibility !== shareMode) {
         (card as HTMLElement).style.display = 'none';
       } else {
         (card as HTMLElement).style.display = '';
       }
     }
   }
   ```

**æŒ‘æˆ˜**:
- âš ï¸ **æ€§èƒ½é—®é¢˜**: å¦‚æœæ ‡æ³¨æ•°é‡å¤š(å¦‚100+),é€ä¸ªæŸ¥è¯¢ä¼šå¾ˆæ…¢
- ğŸ’¡ **è§£å†³æ–¹æ¡ˆ**: 
  1. æ‰¹é‡æŸ¥è¯¢API: `GET /annotations?document_id=X&user_id=Y` (ä¸€æ¬¡è·å–æ‰€æœ‰)
  2. æœ¬åœ°ç¼“å­˜: å°†æŸ¥è¯¢ç»“æœç¼“å­˜åˆ° `Map<annotationKey, shareStatus>`
  3. å¢é‡æ›´æ–°: åªæŸ¥è¯¢æœªç¼“å­˜çš„æ ‡æ³¨

**é¢„æœŸäº§å‡º**:
- ä¿®æ”¹: `sidebarAnnotationEnhancer.ts` (+150è¡Œ)
- æ•ˆæœ: å¯æŒ‰å…±äº«çŠ¶æ€ç­›é€‰sidebaræ ‡æ³¨

### 5.4 Phase 4: æ‰¹é‡æ“ä½œ (3å¤©)

**ç›®æ ‡**: æ”¯æŒæ‰¹é‡å…±äº«å½“å‰ç­›é€‰ç»“æœ

**å®ç°æ­¥éª¤**:

1. **æ·»åŠ æ‰¹é‡æŒ‰é’®**:
   ```typescript
   private createBatchActions(doc: Document): HTMLElement {
     const batchDiv = doc.createElement('div');
     batchDiv.className = 'batch-actions';
     batchDiv.innerHTML = `
       <button id="batch-share-public">æ‰¹é‡è®¾ä¸ºPublic</button>
       <button id="batch-share-followers">æ‰¹é‡è®¾ä¸ºFollowers</button>
       <button id="batch-cancel-share">æ‰¹é‡å–æ¶ˆå…±äº«</button>
     `;
     
     // ç‚¹å‡» â†’ å¯¹å½“å‰æ˜¾ç¤ºçš„æ ‡æ³¨åº”ç”¨æ“ä½œ
     batchDiv.addEventListener('click', (e) => {
       const target = e.target as HTMLElement;
       if (target.tagName === 'BUTTON') {
         this.batchUpdateAnnotations(doc, target.id);
       }
     });
     
     return batchDiv;
   }
   ```

2. **æ‰¹é‡æ›´æ–°é€»è¾‘**:
   ```typescript
   private async batchUpdateAnnotations(doc: Document, action: string): Promise<void> {
     // 1. è·å–å½“å‰æ˜¾ç¤ºçš„æ ‡æ³¨å¡ç‰‡(æœªè¢«éšè—çš„)
     const visibleCards = Array.from(
       doc.querySelectorAll('.annotation[data-sidebar-annotation-id]:not([style*="display: none"])')
     );
     
     // 2. ç¡®è®¤æ“ä½œ
     const count = visibleCards.length;
     const confirmed = confirm(`ç¡®å®šè¦å¯¹ ${count} ä¸ªæ ‡æ³¨æ‰§è¡Œæ“ä½œå—?`);
     if (!confirmed) return;
     
     // 3. æ‰¹é‡æ›´æ–°
     const shareMode = this.parseActionToShareMode(action);
     const promises = visibleCards.map(card => {
       const annotationKey = card.getAttribute('data-sidebar-annotation-id');
       return this.updateAnnotationSharing(annotationKey, shareMode);
     });
     
     await Promise.all(promises);
     
     // 4. åˆ·æ–°UI
     this.refreshAllAnnotationStates(doc);
   }
   ```

**é¢„æœŸäº§å‡º**:
- ä¿®æ”¹: `sidebarAnnotationEnhancer.ts` (+100è¡Œ)
- æ•ˆæœ: å¯æ‰¹é‡æ“ä½œç­›é€‰å‡ºçš„æ ‡æ³¨

### 5.5 ä»£ç æ¶æ„

**æ–°å¢æ–‡ä»¶**:
```
zotero-plugin/src/modules/
â”œâ”€â”€ sidebarAnnotationEnhancer.ts      # ä¸»ç±» (æ–°å¢, ~600è¡Œ)
â”œâ”€â”€ annotationSharingPopup.ts         # ç°æœ‰popupå¢å¼º (ä¿ç•™)
â””â”€â”€ ui/
    â””â”€â”€ utils/
        â””â”€â”€ CommentRenderer.ts         # è¯„è®ºæ¸²æŸ“å·¥å…· (å¤ç”¨)
```

**ç±»èŒè´£åˆ’åˆ†**:

```typescript
// sidebarAnnotationEnhancer.ts
export class SidebarAnnotationEnhancer {
  // Phase 1: åŸºç¡€æ³¨å…¥
  async register(reader: any): Promise<void>;
  private onRenderAnnotation(event: any): Promise<void>;
  private createShareButtons(doc: Document, key: string): HTMLElement;
  private loadShareStatus(container: HTMLElement, key: string): Promise<void>;
  
  // Phase 2: ç¤¾äº¤ä¿¡æ¯
  private createSocialInfo(doc: Document, key: string): HTMLElement;
  private showCommentsInItemPane(key: string): void;
  
  // Phase 3: ç­›é€‰å™¨
  private injectShareFilter(doc: Document, selector: HTMLElement): void;
  private filterByShareStatus(doc: Document, shareMode: string): Promise<void>;
  
  // Phase 4: æ‰¹é‡æ“ä½œ
  private createBatchActions(doc: Document): HTMLElement;
  private batchUpdateAnnotations(doc: Document, action: string): Promise<void>;
  
  // å…±äº«é€»è¾‘ (å¤ç”¨ annotationSharingPopup)
  private async updateAnnotationSharing(key: string, mode: ShareMode): Promise<void>;
  private async queryAnnotationShareStatus(key: string): Promise<any>;
}
```

**ä¸ç°æœ‰ä»£ç çš„å…³ç³»**:
- âœ… **å¤ç”¨** `annotationSharingPopup.ts` çš„APIè°ƒç”¨é€»è¾‘
- âœ… **å¤ç”¨** `CommentRenderer.ts` çš„è¯„è®ºæ¸²æŸ“
- âœ… **å¤ç”¨** `documentCache` å’Œ `sharedInfoCache`
- âœ… **ä¿ç•™** popupæ–¹æ¡ˆ(ä¸¤è€…å¯å…±å­˜,ä¸å†²çª)

---

## 6. é£é™©ä¸æŒ‘æˆ˜

### 6.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **Zoteroæ›´æ–°ç ´åAPI** | æ’ä»¶å¤±æ•ˆ | ğŸŸ¡ ä¸­ç­‰ | ç›‘å¬Zotero release notes,åŠæ—¶é€‚é… |
| **æ€§èƒ½é—®é¢˜** (å¤§é‡æ ‡æ³¨) | ç•Œé¢å¡é¡¿ | ğŸŸ¡ ä¸­ç­‰ | æ‰¹é‡æŸ¥è¯¢ + æœ¬åœ°ç¼“å­˜ + è™šæ‹Ÿæ»šåŠ¨ |
| **æ ·å¼å†²çª** | UIæ˜¾ç¤ºå¼‚å¸¸ | ğŸŸ¢ ä½ | ä½¿ç”¨ç‹¬ç«‹CSSå‘½åç©ºé—´(`.researchopia-*`) |
| **ä¸å…¶ä»–æ’ä»¶å†²çª** | åŠŸèƒ½å¼‚å¸¸ | ğŸŸ¢ ä½ | åœ¨ `renderSidebarAnnotationHeader` ä¸­åšé˜²å¾¡æ€§æ£€æŸ¥ |

### 6.2 ç”¨æˆ·ä½“éªŒé£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **Sidebarç©ºé—´æ‹¥æŒ¤** | ä¿¡æ¯è¿‡è½½ | ğŸŸ¡ ä¸­ç­‰ | é‡‡ç”¨å¯æŠ˜å è®¾è®¡,é»˜è®¤åªæ˜¾ç¤ºå›¾æ ‡ |
| **å­¦ä¹ æ›²çº¿** | ç”¨æˆ·å›°æƒ‘ | ğŸŸ¢ ä½ | ç¬¦åˆZoteroä¹ æƒ¯,æ— éœ€æ–°å­¦ä¹  |
| **æ“ä½œè¯¯è§¦** | è¯¯æ“ä½œå…±äº«çŠ¶æ€ | ğŸŸ¡ ä¸­ç­‰ | æ‰¹é‡æ“ä½œéœ€ç¡®è®¤,å•ä¸ªæ“ä½œå¯æ’¤é”€ |

### 6.3 å®æ–½é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **å¼€å‘å‘¨æœŸè¶…é¢„æœŸ** | å»¶è¿Ÿä¸Šçº¿ | ğŸŸ¡ ä¸­ç­‰ | åˆ†é˜¶æ®µå‘å¸ƒ(Phase 1å…ˆä¸Šçº¿) |
| **æµ‹è¯•è¦†ç›–ä¸è¶³** | çº¿ä¸ŠBug | ğŸŸ¡ ä¸­ç­‰ | é‡ç‚¹æµ‹è¯•è¾¹ç¼˜case(æ— æ ‡æ³¨ã€å¤§é‡æ ‡æ³¨) |
| **å…¼å®¹æ€§é—®é¢˜** | éƒ¨åˆ†ç”¨æˆ·æ— æ³•ä½¿ç”¨ | ğŸŸ¢ ä½ | åœ¨Zotero 6/7ä¸¤ä¸ªç‰ˆæœ¬æµ‹è¯• |

---

## 7. å†³ç­–å»ºè®®

### 7.1 æ¨èæ–¹æ¡ˆ: **æ··åˆæ–¹æ¡ˆ (C)**

**ç†ç”±**:
1. âœ… **æŠ€æœ¯å¯è¡Œæ€§é«˜**: ä½¿ç”¨Zoteroå®˜æ–¹API,æ— éœ€hackå†…éƒ¨
2. âœ… **ç”¨æˆ·ä½“éªŒæœ€ä½³**: ç¬¦åˆZoteroè®¾è®¡å“²å­¦,æ— å­¦ä¹ æˆæœ¬
3. âœ… **æ¸è¿›å¼å¢å¼º**: å¯åˆ†é˜¶æ®µå®æ–½,é™ä½é£é™©
4. âœ… **åŠŸèƒ½å®Œæ•´æ€§**: Sidebar + item paneè¦†ç›–æ‰€æœ‰åœºæ™¯

**ä¸æ¨èæ–¹æ¡ˆ B çš„åŸå› **:
- âŒ **æŠ€æœ¯éš¾åº¦è¿‡é«˜**: éœ€è¦hook Zoteroå†…éƒ¨tabç³»ç»Ÿ,ç»´æŠ¤æˆæœ¬æé«˜
- âŒ **ä¾µå…¥æ€§å¼º**: ä¿®æ”¹åŸç”ŸUI,å¯èƒ½ä¸Zoteroæ›´æ–°å†²çª
- âŒ **æ”¶ç›Šä¸æ˜æ˜¾**: æ–°tabä¸item paneåŠŸèƒ½é‡å¤,ç”¨æˆ·ä»·å€¼ä½

### 7.2 å®æ–½ä¼˜å…ˆçº§

| é˜¶æ®µ | åŠŸèƒ½ | å¼€å‘æ—¶é—´ | ç”¨æˆ·ä»·å€¼ | ä¼˜å…ˆçº§ |
|------|------|---------|----------|--------|
| **Phase 1** | SidebaråŸºç¡€æ³¨å…¥ | 1å‘¨ | â­â­â­â­â­ | ğŸ”´ P0 (å¿…é¡») |
| **Phase 2** | ç¤¾äº¤ä¿¡æ¯å±•ç¤º | 3å¤© | â­â­â­â­ | ğŸŸ  P1 (é‡è¦) |
| **Phase 3** | å…¨å±€ç­›é€‰å™¨ | 5å¤© | â­â­â­ | ğŸŸ¡ P2 (å»ºè®®) |
| **Phase 4** | æ‰¹é‡æ“ä½œ | 3å¤© | â­â­â­ | ğŸŸ¡ P2 (å»ºè®®) |

**å‘å¸ƒç­–ç•¥**:
1. **v1.0 (MVP)**: Phase 1 (åŸºç¡€æŒ‰é’®æ³¨å…¥)
2. **v1.1**: Phase 1 + Phase 2 (ç¤¾äº¤ä¿¡æ¯)
3. **v1.2**: Phase 1-3 (ç­›é€‰å™¨)
4. **v2.0**: å®Œæ•´åŠŸèƒ½ (æ‰¹é‡æ“ä½œ)

### 7.3 æˆåŠŸæŒ‡æ ‡

**å®šé‡æŒ‡æ ‡**:
- [ ] 90%ä»¥ä¸Šç”¨æˆ·åœ¨sidebarå®Œæˆå…±äº«æ“ä½œ(è€Œéitem pane)
- [ ] å¹³å‡å…±äº«æ“ä½œæ—¶é—´ä» 10ç§’ é™è‡³ 3ç§’
- [ ] Sidebar UIæ¸²æŸ“æ—¶é—´ < 100ms (å³ä½¿100ä¸ªæ ‡æ³¨)

**å®šæ€§æŒ‡æ ‡**:
- [ ] ç”¨æˆ·åé¦ˆ: "ç¬¦åˆZoteroä½¿ç”¨ä¹ æƒ¯"
- [ ] æ— éœ€é¢å¤–æ•™ç¨‹,ç”¨æˆ·è‡ªç„¶å‘ç°åŠŸèƒ½
- [ ] æ‰¹é‡æ“ä½œæ•ˆç‡æ˜¾è‘—æå‡

---

## 8. å¾…è§£å†³é—®é¢˜

### 8.1 éœ€è¦ç”¨æˆ·åé¦ˆçš„é—®é¢˜

1. **UIè®¾è®¡ç»†èŠ‚**:
   - 4ä¸ªå…±äº«æŒ‰é’®å¤ªå¤š,æ˜¯å¦æ”¹ä¸º1ä¸ªä¸‹æ‹‰èœå•? (èŠ‚çœç©ºé—´)
   - ç¤¾äº¤ä¿¡æ¯æ˜¯å¦éœ€è¦tooltipæ‚¬åœæ˜¾ç¤º? (è€Œéç›´æ¥æ˜¾ç¤º)

2. **åŠŸèƒ½ä¼˜å…ˆçº§**:
   - æ˜¯å¦éœ€è¦"ä¸€é”®å…±äº«æ‰€æœ‰é«˜äº®"åŠŸèƒ½?
   - æ˜¯å¦éœ€è¦"å¯¼å…¥/å¯¼å‡ºå…±äº«é…ç½®"åŠŸèƒ½?

3. **æ€§èƒ½è¾¹ç•Œ**:
   - å½“æ ‡æ³¨æ•°é‡è¶…è¿‡500æ—¶,æ˜¯å¦éœ€è¦è™šæ‹Ÿæ»šåŠ¨?
   - æ‰¹é‡æ“ä½œæ˜¯å¦éœ€è¦è¿›åº¦æ¡?

### 8.2 æŠ€æœ¯è°ƒç ”å¾…ç¡®è®¤

1. **Zotero Reader APIå…¼å®¹æ€§**:
   - `renderSidebarAnnotationHeader` åœ¨Zotero 6.xå’Œ7.xæ˜¯å¦éƒ½æ”¯æŒ?
   - äº‹ä»¶å‚æ•° `params.annotation` çš„å®Œæ•´ç»“æ„æ˜¯ä»€ä¹ˆ?

2. **æ ·å¼è¦†ç›–é—®é¢˜**:
   - `.custom-sections` çš„é»˜è®¤æ ·å¼æ˜¯ä»€ä¹ˆ?
   - å¦‚ä½•ç¡®ä¿æˆ‘ä»¬çš„æŒ‰é’®ä¸ä¼šç ´ååŸç”Ÿå¸ƒå±€?

---

## 9. å‚è€ƒèµ„æ–™

### 9.1 Zotero æºç 

| æ–‡ä»¶ | å…³é”®ä»£ç è¡Œ | å†…å®¹ |
|------|-----------|------|
| `chrome/content/zotero/xpcom/reader.js` | Line 2011-2068 | `Reader.registerEventListener()` API |
| `chrome/content/zotero/xpcom/reader.js` | Line 371-392 | Readeräº‹ä»¶å›è°ƒç¤ºä¾‹ |

### 9.2 é¡¹ç›®ç°æœ‰ä»£ç 

| æ–‡ä»¶ | å…³é”®ä»£ç è¡Œ | å†…å®¹ |
|------|-----------|------|
| `zotero-plugin/src/modules/annotationSharingPopup.ts` | Line 584-750 | popupæŒ‰é’®æ³¨å…¥é€»è¾‘(å¯å¤ç”¨) |
| `zotero-plugin/src/modules/ui/utils/CommentRenderer.ts` | å…¨æ–‡ | è¯„è®ºæ¸²æŸ“å·¥å…·ç±» |
| `zotero-plugin/src/modules/ui/myAnnotationsView.ts` | å…¨æ–‡ | ç®¡ç†æ ‡æ³¨é¡µé¢(ä¿ç•™) |
| `zotero-plugin/src/modules/ui/sessionAnnotationsView.ts` | å…¨æ–‡ | å…±äº«æ ‡æ³¨é¡µé¢(ä¿ç•™) |

### 9.3 ç›¸å…³æ–‡æ¡£

- [docs/DEVELOPMENT.md - Zoteroæ’ä»¶å¼€å‘](../../DEVELOPMENT.md#hot-reload)
- [docs/docs-dev/1.4.9-ANNOTATION_POPUP_ENHANCEMENT.md](./1.4.9-ANNOTATION_POPUP_ENHANCEMENT.md) - popupæ–¹æ¡ˆæ–‡æ¡£

---

## 10. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç­‰å¾…ç”¨æˆ·åé¦ˆ** ğŸŸ¡:

1. **è®¾è®¡æ–¹æ¡ˆç¡®è®¤**:
   - [ ] ç”¨æˆ·æ˜¯å¦åŒæ„æ··åˆæ–¹æ¡ˆ(C)?
   - [ ] UIè®¾è®¡æ˜¯å¦éœ€è¦è°ƒæ•´?

2. **ä¼˜å…ˆçº§ç¡®è®¤**:
   - [ ] æ˜¯å¦å…ˆå®æ–½Phase 1 (åŸºç¡€æ³¨å…¥)?
   - [ ] Phase 2-4æ˜¯å¦å¿…è¦?

3. **æŠ€æœ¯ç»†èŠ‚ç¡®è®¤**:
   - [ ] æ˜¯å¦ä¿ç•™ç°æœ‰popupæ–¹æ¡ˆ?
   - [ ] æ˜¯å¦éœ€è¦å…¼å®¹Zotero 6.x?

**ç¡®è®¤åå¼€å§‹å®æ–½** ğŸŸ¢:

```bash
# Step 1: åˆ›å»ºæ–°åˆ†æ”¯
git checkout -b feature/sidebar-annotation-enhancer

# Step 2: åˆ›å»ºæ–‡ä»¶
touch zotero-plugin/src/modules/sidebarAnnotationEnhancer.ts

# Step 3: å®æ–½Phase 1
# ... (å‚è§5.1èŠ‚)
```

---

**æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ ç­‰å¾…ç”¨æˆ·è¯„å®¡å’Œåé¦ˆ  
**ä¸‹æ¬¡æ›´æ–°**: ç”¨æˆ·ç¡®è®¤æ–¹æ¡ˆåæ›´æ–°å®æ–½ç»†èŠ‚
