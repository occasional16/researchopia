// background.js - æœåŠ¡å·¥ä½œè¿›ç¨‹
class BackgroundManager {
  constructor() {
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.checkResearchopiaConnection();
  }

  setupEventListeners() {
    // æ‰©å±•å®‰è£…æ—¶
    chrome.runtime.onInstalled.addListener((details) => {
      if (details.reason === 'install') {
        this.handleInstall();
      } else if (details.reason === 'update') {
        this.handleUpdate(details.previousVersion);
      }
    });

    // æ ‡ç­¾é¡µæ›´æ–°æ—¶
    chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
      if (changeInfo.status === 'complete' && tab.url) {
        this.handleTabUpdate(tabId, tab);
      }
    });

    // å¤„ç†æ¥è‡ªcontent scriptçš„æ¶ˆæ¯
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
      return this.handleMessage(request, sender, sendResponse);
    });

    // å¤„ç†æ‰©å±•å›¾æ ‡ç‚¹å‡»
    chrome.action.onClicked.addListener((tab) => {
      this.handleActionClick(tab);
    });
  }

  async handleInstall() {
    console.log('ç ”å­¦æ¸¯æ‰©å±•å·²å®‰è£…');
    
    // è®¾ç½®ä¾§è¾¹æ è¡Œä¸º
    if (chrome.sidePanel && chrome.sidePanel.setPanelBehavior) {
      try {
        await chrome.sidePanel.setPanelBehavior({ openPanelOnActionClick: true });
        console.log('âœ… ä¾§è¾¹æ è¡Œä¸ºè®¾ç½®æˆåŠŸï¼šç‚¹å‡»æ‰©å±•å›¾æ ‡å¯ç›´æ¥æ‰“å¼€ä¾§è¾¹æ ');
      } catch (error) {
        console.warn('âš ï¸ è®¾ç½®ä¾§è¾¹æ è¡Œä¸ºå¤±è´¥:', error);
      }
    }
    
    // è®¾ç½®é»˜è®¤é…ç½®
    await chrome.storage.sync.set({
      floatingEnabled: true,
      researchopiaUrl: 'http://localhost:3000',
      autoDetectDOI: true,
      sidebarWidth: 400
    });

    // æ˜¾ç¤ºæ¬¢è¿é¡µé¢
    chrome.tabs.create({
      url: chrome.runtime.getURL('welcome.html')
    });
  }

  async handleUpdate(previousVersion) {
    console.log(`ç ”å­¦æ¸¯æ‰©å±•å·²æ›´æ–°: ${previousVersion} -> ${chrome.runtime.getManifest().version}`);
  }

  async handleTabUpdate(tabId, tab) {
    // æ£€æŸ¥æ˜¯å¦ä¸ºå­¦æœ¯ç½‘ç«™
    if (this.isAcademicSite(tab.url)) {
      // æ›´æ–°æ‰©å±•å›¾æ ‡çŠ¶æ€
      chrome.action.setBadgeText({
        text: 'DOI',
        tabId: tabId
      });
      
      chrome.action.setBadgeBackgroundColor({
        color: '#4ade80',
        tabId: tabId
      });
    } else {
      chrome.action.setBadgeText({
        text: '',
        tabId: tabId
      });
    }
  }

  handleMessage(request, sender, sendResponse) {
    console.log('ğŸ“¨ Backgroundæ”¶åˆ°æ¶ˆæ¯:', request.action);
    
    try {
      switch (request.action) {
        case 'detectDOI':
          this.handleDOIDetection(request, sender, sendResponse);
          return true; // å¼‚æ­¥å“åº”
          
        case 'openResearchopia':
          this.openResearchopia(request.doi).then(() => {
            sendResponse({ success: true });
          }).catch(error => {
            console.error('âŒ openResearchopia error:', error);
            sendResponse({ success: false, error: error.message });
          });
          return true; // å¼‚æ­¥å“åº”
          
        case 'openSidePanel':
          this.openSidePanel(sender.tab, request.doi, request.url).then(result => {
            sendResponse({ success: result });
          }).catch(error => {
            console.error('âŒ openSidePanel error:', error);
            sendResponse({ success: false, error: error.message });
          });
          return true; // å¼‚æ­¥å“åº”
          
        case 'checkConnection':
          this.checkResearchopiaConnection().then(() => {
            sendResponse({ success: true });
          }).catch(error => {
            console.error('âŒ checkConnection error:', error);
            sendResponse({ success: false, error: error.message });
          });
          return true; // å¼‚æ­¥å“åº”
          
        case 'log':
          // å¤„ç†æ¥è‡ªpopupçš„æ—¥å¿—æ¶ˆæ¯
          console.log('ğŸ“ Popupæ—¥å¿—:', request.message, '@', request.timestamp);
          sendResponse({ success: true });
          return false; // åŒæ­¥å“åº”
          
        default:
          console.warn('âŒ æœªçŸ¥çš„action:', request.action);
          sendResponse({ success: false, error: 'Unknown action: ' + request.action });
          return false; // åŒæ­¥å“åº”
      }
    } catch (error) {
      console.error('âŒ Background message handler error:', error);
      sendResponse({ success: false, error: error.message });
      return false;
    }
  }

  async openSidePanel(tab, doi, url) {
    try {
      // ä¿å­˜DOIä¿¡æ¯ä¾›ä¾§è¾¹æ ä½¿ç”¨
      if (doi) {
        await chrome.storage.sync.set({ 
          doiFromContentScript: doi,
          currentPageUrl: url
        });
        console.log('ğŸ’¾ å·²ä¿å­˜DOIåˆ°storage:', doi);
      }

      // ç”±äºsidePanel.open()éœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼Œè€Œä»content scriptçš„æ¶ˆæ¯æ— æ³•ä¼ é€’ç”¨æˆ·æ‰‹åŠ¿ä¸Šä¸‹æ–‡
      // æˆ‘ä»¬ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆï¼šé€šçŸ¥ç”¨æˆ·ç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œæˆ–è€…å°è¯•æ¿€æ´»æ‰©å±•å›¾æ ‡
      console.log('âš ï¸ æ— æ³•ç›´æ¥ä»content scriptæ‰“å¼€ä¾§è¾¹æ ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼‰');
      
      // å°è¯•é«˜äº®æ‰©å±•å›¾æ ‡æç¤ºç”¨æˆ·ç‚¹å‡»
      if (chrome.action && chrome.action.setBadgeText) {
        await chrome.action.setBadgeText({
          text: 'ï¿½',
          tabId: tab.id
        });
        
        await chrome.action.setBadgeBackgroundColor({
          color: '#4ade80',
          tabId: tab.id
        });
        
        // 3ç§’åæ¸…é™¤é«˜äº®
        setTimeout(async () => {
          await chrome.action.setBadgeText({
            text: '',
            tabId: tab.id
          });
        }, 3000);
      }

      console.log('ğŸ’¡ å·²é«˜äº®æ‰©å±•å›¾æ ‡ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»æ‰“å¼€ä¾§è¾¹æ ');
        
        // é¢å¤–éªŒè¯ï¼šæ£€æŸ¥ä¾§è¾¹æ æ˜¯å¦çœŸçš„æ‰“å¼€äº†
        setTimeout(async () => {
          try {
            // å°è¯•å‘ä¾§è¾¹æ å‘é€æ¶ˆæ¯æ¥éªŒè¯æ˜¯å¦æ‰“å¼€
            const response = await chrome.runtime.sendMessage({
              action: 'sidebarPing'
            });
            console.log('ğŸ“¡ ä¾§è¾¹æ pingå“åº”:', response);
          } catch (error) {
            console.log('ğŸ“¡ ä¾§è¾¹æ pingå¤±è´¥ï¼ˆå¯èƒ½æ­£å¸¸ï¼‰:', error.message);
          }
        }, 500);
        
        return true;
      } else {
        console.log('âš ï¸ åŸç”Ÿä¾§è¾¹æ APIä¸å¯ç”¨ï¼Œchrome.sidePanel:', !!chrome.sidePanel, 'openæ–¹æ³•:', !!(chrome.sidePanel && chrome.sidePanel.open));
        return false;
      }
    } catch (error) {
      console.error('âŒ æ‰“å¼€ä¾§è¾¹æ å¤±è´¥:', error);
      console.error('é”™è¯¯è¯¦æƒ…:', {
        message: error.message,
        name: error.name,
        stack: error.stack
      });
      return false;
    }
  }

  async handleDOIDetection(request, sender, sendResponse) {
    // è¿™é‡Œä¸»è¦æ˜¯åè°ƒå·¥ä½œï¼Œå®é™…æ£€æµ‹åœ¨content scriptä¸­è¿›è¡Œ
    sendResponse({ success: true, message: 'DOI detection initiated' });
  }

  async openResearchopia(doi = null) {
    try {
      const settings = await chrome.storage.sync.get(['researchopiaUrl']);
      const baseUrl = settings.researchopiaUrl || 'http://localhost:3000';
      
      let url = baseUrl;
      if (doi) {
        url += `/?doi=${encodeURIComponent(doi)}&autoSearch=true`;
      }

      await chrome.tabs.create({
        url: url,
        active: true
      });
    } catch (error) {
      console.error('Failed to open Researchopia:', error);
    }
  }

  async checkResearchopiaConnection() {
    try {
      const settings = await chrome.storage.sync.get(['researchopiaUrl']);
      const baseUrl = settings.researchopiaUrl || 'http://localhost:3000';
      
      // å°è¯•è¿æ¥ç ”å­¦æ¸¯æœåŠ¡å™¨
      const response = await fetch(baseUrl, { 
        method: 'HEAD',
        mode: 'no-cors'
      });
      
      console.log('Researchopia connection status:', response.ok ? 'Connected' : 'Disconnected');
      
      // æ›´æ–°è¿æ¥çŠ¶æ€
      await chrome.storage.local.set({
        connectionStatus: response.ok ? 'connected' : 'disconnected',
        lastChecked: Date.now()
      });
    } catch (error) {
      console.log('Researchopia connection failed:', error.message);
      await chrome.storage.local.set({
        connectionStatus: 'disconnected',
        lastChecked: Date.now()
      });
    }
  }

  async handleActionClick(tab) {
    // å½“ç”¨æˆ·ç‚¹å‡»æ‰©å±•å›¾æ ‡æ—¶çš„å¤„ç†
    console.log('Extension icon clicked on:', tab.url);
  }

  isAcademicSite(url) {
    if (!url) return false;
    
    const academicSites = [
      'nature.com',
      'science.org',
      'ieee.org',
      'springer.com',
      'sciencedirect.com',
      'wiley.com',
      'tandfonline.com',
      'acm.org',
      'arxiv.org',
      'pubmed.ncbi.nlm.nih.gov',
      'doi.org'
    ];

    try {
      const hostname = new URL(url).hostname.toLowerCase();
      return academicSites.some(site => hostname.includes(site));
    } catch (error) {
      return false;
    }
  }
}

// åˆå§‹åŒ–èƒŒæ™¯è„šæœ¬
new BackgroundManager();