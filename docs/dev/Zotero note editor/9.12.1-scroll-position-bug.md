# 9.12 å¤šçª—å£æ»šåŠ¨ä½ç½®Bugåˆ†æ

## Bugæè¿°

**é—®é¢˜**: å¯¹åŒä¸€ä¸ªnoteæ‰“å¼€2ä¸ªçª—å£æ—¶ï¼Œç¼–è¾‘å…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¼šè‡ªåŠ¨è·³è½¬åˆ°é¦–è¡Œã€‚

**å½±å“**: ç”¨æˆ·åœ¨å¤šçª—å£åä½œåœºæ™¯ä¸‹å·¥ä½œä½“éªŒæå·®ã€‚

---

## 1. Bugæ ¹æœ¬åŸå› 

### 1.1 äº‹ä»¶æµåˆ†æ

```
çª—å£Aç¼–è¾‘ â†’ Zotero Notifierå¹¿æ’­ "modify" äº‹ä»¶ â†’ çª—å£Bæ¥æ”¶äº‹ä»¶
                                              â†“
                              note-editor.notify() è¢«è°ƒç”¨
                                              â†“
                              æ£€æµ‹åˆ°itemå†…å®¹å˜åŒ–ï¼Œè°ƒç”¨ initEditor()
                                              â†“
                              æ•´ä¸ª EditorCore è¢«é‡å»ºï¼ˆProseMirroré‡æ–°åˆå§‹åŒ–ï¼‰
                                              â†“
                              Reactæ ‘é‡æ–°æ¸²æŸ“ï¼Œscroll position è¢«é‡ç½®ä¸º0
```

### 1.2 æ ¸å¿ƒé—®é¢˜ç‚¹

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| **EditorCore é‡å»º** | `initEditor()` ä¼šé”€æ¯æ—§çš„ ProseMirror å®ä¾‹ï¼Œåˆ›å»ºæ–°å®ä¾‹ |
| **DOM é‡æ¸²æŸ“** | React ç»„ä»¶é‡å»ºå¯¼è‡´ `.editor-core` å…ƒç´ è¢«æ›¿æ¢ |
| **æ— çŠ¶æ€æ¢å¤** | Zotero note-editor æ²¡æœ‰æä¾› scroll çŠ¶æ€æ¢å¤æœºåˆ¶ |

### 1.3 å…³é”®ä»£ç ä½ç½®

- **zotero/note-editor**: `src/index.zotero.js` - `_init()` æ–¹æ³•é‡å»ºæ•´ä¸ªç¼–è¾‘å™¨
- **Notifier**: `extraData[itemID].noteEditorID` æ ‡è¯†ç¼–è¾‘æ¥æº
- **æ»šåŠ¨å®¹å™¨**: `.editor-core` å…ƒç´ çš„ `scrollTop` å±æ€§

---

## 2. ç”¨æˆ·ä¿®æ”¹æ–¹æ¡ˆè¯„ä¼°

å‚è€ƒ: [PR #1463 - zotero-better-notes](https://github.com/windingwind/zotero-better-notes/pull/1463/commits/a289dccd324bb0fcb7d1af8e9497099a7bc20a46)

### 2.1 æ–¹æ¡ˆæ ¸å¿ƒæ€è·¯

```typescript
// 1. Hook note-editor çš„ notify æ–¹æ³•
noteEditor.notify = async function(event, type, ids, extraData) {
  // 2. åˆ¤æ–­æ˜¯å¦ä¸º"å¤–éƒ¨ç¼–è¾‘"ï¼ˆéæœ¬ç¼–è¾‘å™¨å‘èµ·çš„ä¿®æ”¹ï¼‰
  const isOwnEdit = extraData[itemID].noteEditorID === editor.instanceID;
  
  if (!isOwnEdit) {
    // 3. ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
    savedScrollPosition = editorCore.scrollTop;
    
    // 4. éšè— iframe é˜²æ­¢é—ªçƒ
    iframe.style.opacity = "0";
    
    // 5. ç­‰å¾…ç¼–è¾‘å™¨é‡å»ºå®Œæˆåæ¢å¤
    await waitForEditorReady();
    editorCore.scrollTop = savedScrollPosition;
    
    // 6. æ˜¾ç¤º iframe
    iframe.style.opacity = "1";
  }
  
  // 7. è°ƒç”¨åŸå§‹ notify
  return originalNotify.call(this, ...);
}
```

### 2.2 ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| **ç²¾å‡†åˆ¤æ–­** | ä½¿ç”¨ `noteEditorID` ç²¾ç¡®è¯†åˆ«ç¼–è¾‘æ¥æº |
| **éä¾µå…¥å¼** | Hook æ–¹å¼ä¸ä¿®æ”¹ Zotero æ ¸å¿ƒä»£ç  |
| **è§†è§‰å¹³æ»‘** | ä½¿ç”¨ opacity éšè—/æ˜¾ç¤ºé¿å…æ»šåŠ¨è·³åŠ¨é—ªçƒ |
| **å¥å£®æ€§** | æœ‰ timeout å…œåº•ï¼ˆ5ç§’è¶…æ—¶ï¼‰ |

### 2.3 æ½œåœ¨é£é™©

| é£é™©ç‚¹ | è¯´æ˜ | é£é™©çº§åˆ« |
|--------|------|----------|
| **è½®è¯¢ç­‰å¾…** | `_waitForEditorReady()` ä½¿ç”¨ 100ms é—´éš”è½®è¯¢ï¼Œæ•ˆç‡è¾ƒä½ | ğŸŸ¡ ä¸­ |
| **åŒé‡ Hook** | éœ€è¦ `_bnScrollHooked` æ ‡è®°é˜²æ­¢é‡å¤ï¼Œä½†å¤šæ’ä»¶å…±å­˜æ—¶å¯èƒ½å†²çª | ğŸŸ¡ ä¸­ |
| **opacity é—ªçƒ** | å¿«é€Ÿè¿ç»­ç¼–è¾‘æ—¶å¯èƒ½å‡ºç°çŸ­æš‚çš„é€æ˜é—ªçƒ | ğŸŸ¢ ä½ |
| **iframe å¼•ç”¨** | ç›´æ¥æ“ä½œ iframe styleï¼Œç¼–è¾‘å™¨ç»“æ„å˜åŒ–å¯èƒ½å¤±æ•ˆ | ğŸŸ¡ ä¸­ |

### 2.4 è¯„ä¼°ç»“è®º

**è¿™æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼Œä½†ä¸æ˜¯æœ€ä½³å®è·µ**ã€‚

**ç†ç”±**:
1. **è½®è¯¢ç­‰å¾…**: `_waitForEditorReady()` ä½¿ç”¨è½®è¯¢æ£€æµ‹ç¼–è¾‘å™¨å°±ç»ªçŠ¶æ€ï¼Œè™½ç„¶åŠŸèƒ½æ­£ç¡®ï¼Œä½†æ¶ˆè€—èµ„æºã€‚æ›´ä¼˜æ–¹æ¡ˆæ˜¯ä½¿ç”¨ MutationObserver æˆ–äº‹ä»¶ç›‘å¬ã€‚

2. **æ—¶åºé£é™©**: `setTimeout(() => {...}, 0)` å°†æ¢å¤é€»è¾‘æ”¾å…¥ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œç†è®ºä¸Šå®‰å…¨ï¼Œä½†åœ¨é«˜å¹¶å‘ç¼–è¾‘åœºæ™¯ä¸‹å¯èƒ½äº§ç”Ÿç«æ€ã€‚

3. **ç´§è€¦åˆ**: ç›´æ¥ä¾èµ– `.editor-core` é€‰æ‹©å™¨å’Œ `_iframeWindow` ç»“æ„ï¼ŒZotero æ›´æ–°å¯èƒ½ç ´åå…¼å®¹æ€§ã€‚

**æ”¹è¿›å»ºè®®**:
- ä½¿ç”¨ `MutationObserver` ç›‘å¬ iframe å†…å®¹å˜åŒ–æ›¿ä»£è½®è¯¢
- æ·»åŠ  debounce å¤„ç†å¿«é€Ÿè¿ç»­ç¼–è¾‘åœºæ™¯
- è€ƒè™‘ä½¿ç”¨ `requestAnimationFrame` æ›¿ä»£ `setTimeout` è¿›è¡Œ DOM æ“ä½œ

---

## 3. Researchopia æ’ä»¶å®ç°è®¡åˆ’

### 3.1 å®ç°ä½ç½®

åœ¨ `zotero-plugin/src/modules/noteEditor/` ä¸‹æ–°å»º `scrollPreserver.ts`:

```
noteEditor/
â”œâ”€â”€ index.ts           # æ¨¡å—å…¥å£
â”œâ”€â”€ toolbar.ts         # å·¥å…·æ åˆå§‹åŒ–
â”œâ”€â”€ search/            # æœç´¢åŠŸèƒ½
â”œâ”€â”€ enhancements/      # å¢å¼ºåŠŸèƒ½
â””â”€â”€ scrollPreserver.ts # ğŸ†• æ»šåŠ¨ä½ç½®ä¿æŒå™¨
```

### 3.2 å®ç°è¦ç‚¹

1. **çŠ¶æ€å­˜å‚¨**: ä½¿ç”¨ WeakMap ä»¥ EditorInstance ä¸ºé”®å­˜å‚¨æ»šåŠ¨ä½ç½®
2. **Hook æ–¹å¼**: åŒç”¨æˆ·æ–¹æ¡ˆï¼ŒHook `noteEditor.notify`
3. **ç­‰å¾…æœºåˆ¶**: ä½¿ç”¨ `MutationObserver` + Promise æ›¿ä»£è½®è¯¢
4. **é˜²é—ªçƒ**: ä¿ç•™ opacity æ–¹æ¡ˆï¼Œä½†æ·»åŠ  transition å¹³æ»‘è¿‡æ¸¡

### 3.3 ä»£ç æ¶æ„

```typescript
// scrollPreserver.ts
export class ScrollPreserver {
  private savedPositions = new WeakMap<EditorInstance, number>();
  private isRestoring = new WeakSet<Element>();
  
  hookNoteEditor(editorElement: EditorElement): void;
  private saveScrollPosition(editor: EditorInstance): void;
  private restoreScrollPosition(editor: EditorInstance): Promise<void>;
  private waitForEditorReady(editorElement: EditorElement): Promise<EditorInstance>;
}
```

### 3.4 é›†æˆç‚¹

åœ¨ `toolbar.ts` çš„ `initEditorToolbar()` ä¸­è°ƒç”¨ï¼š

```typescript
import { ScrollPreserver } from "./scrollPreserver";

export async function initEditorToolbar(editor: EditorInstance) {
  // ... existing code ...
  
  // Initialize scroll position preserver
  ScrollPreserver.getInstance().hookNoteEditor(editorElement);
}
```

---

## 4. ä¸‹ä¸€æ­¥

1. **åˆ›å»º** `scrollPreserver.ts` æ–‡ä»¶
2. **å®ç°** ScrollPreserver ç±»
3. **é›†æˆ** åˆ° toolbar.ts
4. **æµ‹è¯•** å¤šçª—å£ç¼–è¾‘åœºæ™¯

---

*æ–‡æ¡£ç¼–å·: 9.12*  
*åˆ›å»ºæ—¶é—´: 2025-01-17*  
*çŠ¶æ€: å¾…å®ç°*
