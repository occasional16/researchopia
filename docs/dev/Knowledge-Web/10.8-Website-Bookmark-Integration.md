# 10.8 主网站收藏功能集成设计

**让收藏功能触手可及，提升用户粘性**

---

## 一、设计背景与目标

### 1.1 现状分析

**当前收藏功能分布**：

| 位置 | 功能现状 | 用户体验问题 |
|------|----------|--------------|
| 浏览器扩展 Popup | ✅ 完整收藏功能：选择文件夹、查看已收藏状态 | 需要安装扩展 |
| 主网站 /bookmarks 页面 | ✅ 完整管理功能：文件夹树、拖拽排序、批量操作 | 入口深，需主动访问 |
| 主网站 /webpages 列表页 | ❌ 无收藏按钮 | 看到感兴趣网页无法直接收藏 |
| 主网站 /webpages/[urlHash] 详情页 | ❌ 无收藏按钮 | 评分评论后无法收藏 |
| 主网站首页热门网页 | ❌ 无收藏按钮 | 发现热门内容后无法收藏 |

**用户痛点**：
1. **割裂的体验**：扩展能收藏，网站却不能
2. **路径太长**：想收藏一个网页需要：记住URL → 打开 /bookmarks → 手动添加
3. **缺乏即时反馈**：不知道当前网页是否已收藏

### 1.2 设计目标

| 目标 | 短期（P0） | 长期（P1-P2） |
|------|-----------|---------------|
| **一键收藏** | 在网页列表/详情页添加收藏按钮 | 支持快捷键、悬浮球 |
| **即时反馈** | 显示已收藏状态（黄色星标） | 显示收藏到哪些文件夹 |
| **流畅操作** | 弹窗选择文件夹后收藏 | 支持快速收藏（默认文件夹） |
| **数据一致** | 复用现有 API，与扩展共享数据 | 实时同步收藏状态 |

---

## 二、短期方案（MVP）

### 2.1 新增组件设计

#### 2.1.1 BookmarkButton 组件

**文件位置**: `src/components/bookmarks/BookmarkButton.tsx`

```tsx
'use client'

import { useState, useEffect } from 'react'
import { Bookmark, BookmarkCheck, Loader2 } from 'lucide-react'
import { useAuth } from '@/contexts/AuthContext'
import BookmarkModal from './BookmarkModal'

interface BookmarkButtonProps {
  url: string
  title?: string
  variant?: 'icon' | 'button' | 'compact'
  className?: string
  onBookmarkChange?: (isBookmarked: boolean) => void
}

/**
 * Universal bookmark button component
 * - Shows filled bookmark if already bookmarked
 * - Opens folder selection modal on click
 * - Supports icon-only, button, and compact variants
 */
export default function BookmarkButton({
  url,
  title,
  variant = 'icon',
  className = '',
  onBookmarkChange
}: BookmarkButtonProps) {
  const { user, getAccessToken } = useAuth()
  const [isBookmarked, setIsBookmarked] = useState(false)
  const [bookmarkCount, setBookmarkCount] = useState(0) // In how many folders
  const [loading, setLoading] = useState(false)
  const [showModal, setShowModal] = useState(false)

  // Check bookmark status on mount and when URL changes
  useEffect(() => {
    if (user && url) {
      checkBookmarkStatus()
    }
  }, [user, url])

  const checkBookmarkStatus = async () => {
    try {
      const token = await getAccessToken()
      const res = await fetch(`/api/bookmarks/items/check?url=${encodeURIComponent(url)}`, {
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      })
      if (res.ok) {
        const data = await res.json()
        setIsBookmarked(data.isBookmarked)
        setBookmarkCount(data.bookmarks?.length || 0)
      }
    } catch (error) {
      console.error('Failed to check bookmark status:', error)
    }
  }

  const handleClick = (e: React.MouseEvent) => {
    e.preventDefault()
    e.stopPropagation()
    
    if (!user) {
      // Redirect to login with return URL
      window.location.href = `/login?redirect=${encodeURIComponent(window.location.pathname)}`
      return
    }
    
    setShowModal(true)
  }

  const handleBookmarkSuccess = (added: boolean) => {
    if (added) {
      setIsBookmarked(true)
      setBookmarkCount(prev => prev + 1)
    }
    onBookmarkChange?.(true)
    setShowModal(false)
  }

  // Render based on variant
  const renderButton = () => {
    const iconColor = isBookmarked 
      ? 'text-yellow-500 fill-yellow-500' 
      : 'text-gray-400 hover:text-yellow-500'
    
    if (variant === 'icon') {
      return (
        <button
          onClick={handleClick}
          disabled={loading}
          className={`p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${className}`}
          title={isBookmarked ? `已收藏到 ${bookmarkCount} 个文件夹` : '收藏'}
        >
          {loading ? (
            <Loader2 size={18} className="animate-spin text-gray-400" />
          ) : isBookmarked ? (
            <BookmarkCheck size={18} className={iconColor} />
          ) : (
            <Bookmark size={18} className={iconColor} />
          )}
        </button>
      )
    }

    if (variant === 'button') {
      return (
        <button
          onClick={handleClick}
          disabled={loading}
          className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-colors ${
            isBookmarked 
              ? 'border-yellow-300 bg-yellow-50 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-400' 
              : 'border-gray-300 hover:border-yellow-300 hover:bg-yellow-50 dark:border-gray-600 dark:hover:bg-yellow-900/20'
          } ${className}`}
        >
          {loading ? (
            <Loader2 size={16} className="animate-spin" />
          ) : isBookmarked ? (
            <BookmarkCheck size={16} className="text-yellow-500 fill-yellow-500" />
          ) : (
            <Bookmark size={16} />
          )}
          <span className="text-sm">{isBookmarked ? '已收藏' : '收藏'}</span>
        </button>
      )
    }

    // compact variant
    return (
      <button
        onClick={handleClick}
        disabled={loading}
        className={`flex items-center gap-1 text-sm ${iconColor} hover:text-yellow-500 ${className}`}
        title={isBookmarked ? `已收藏到 ${bookmarkCount} 个文件夹` : '收藏'}
      >
        {loading ? (
          <Loader2 size={14} className="animate-spin" />
        ) : isBookmarked ? (
          <BookmarkCheck size={14} className="fill-current" />
        ) : (
          <Bookmark size={14} />
        )}
        {bookmarkCount > 0 && <span>{bookmarkCount}</span>}
      </button>
    )
  }

  return (
    <>
      {renderButton()}
      {showModal && (
        <BookmarkModal
          url={url}
          title={title}
          isOpen={showModal}
          onClose={() => setShowModal(false)}
          onSuccess={handleBookmarkSuccess}
        />
      )}
    </>
  )
}
```

#### 2.1.2 BookmarkModal 组件

**文件位置**: `src/components/bookmarks/BookmarkModal.tsx`

```tsx
'use client'

import { useState, useEffect } from 'react'
import { X, Folder, FolderOpen, Check, Loader2, Plus } from 'lucide-react'
import { useAuth } from '@/contexts/AuthContext'
import type { BookmarkFolder } from '@/types/bookmarks'

interface BookmarkModalProps {
  url: string
  title?: string
  isOpen: boolean
  onClose: () => void
  onSuccess: (added: boolean) => void
}

/**
 * Modal for selecting folder and adding bookmark
 * Similar to browser extension popup's folder selection
 */
export default function BookmarkModal({
  url,
  title,
  isOpen,
  onClose,
  onSuccess
}: BookmarkModalProps) {
  const { getAccessToken } = useAuth()
  const [folders, setFolders] = useState<BookmarkFolder[]>([])
  const [existingBookmarks, setExistingBookmarks] = useState<{
    id: string
    folder_id: string | null
  }[]>([])
  const [selectedFolderId, setSelectedFolderId] = useState<string | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState('')

  useEffect(() => {
    if (isOpen) {
      loadData()
    }
  }, [isOpen])

  const loadData = async () => {
    setLoading(true)
    setError('')
    try {
      const token = await getAccessToken()
      const headers = token ? { Authorization: `Bearer ${token}` } : {}

      // Load folders and check existing bookmarks in parallel
      const [foldersRes, checkRes] = await Promise.all([
        fetch('/api/bookmarks/folders', { headers }),
        fetch(`/api/bookmarks/items/check?url=${encodeURIComponent(url)}`, { headers })
      ])

      if (foldersRes.ok) {
        const data = await foldersRes.json()
        setFolders(data.folders || [])
      }

      if (checkRes.ok) {
        const data = await checkRes.json()
        setExistingBookmarks(data.bookmarks || [])
      }
    } catch (err) {
      setError('加载文件夹失败')
    } finally {
      setLoading(false)
    }
  }

  const handleSave = async () => {
    setSaving(true)
    setError('')

    try {
      const token = await getAccessToken()
      const res = await fetch('/api/bookmarks/items', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        body: JSON.stringify({
          url,
          title,
          folder_id: selectedFolderId
        })
      })

      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || '收藏失败')
      }

      onSuccess(true)
    } catch (err: any) {
      setError(err.message || '收藏失败')
    } finally {
      setSaving(false)
    }
  }

  // Check if a folder already has this bookmark
  const isFolderBookmarked = (folderId: string | null) => {
    return existingBookmarks.some(b => b.folder_id === folderId)
  }

  // Render folder tree (simplified, flat for MVP)
  const renderFolderOption = (folder: BookmarkFolder) => {
    const isBookmarked = isFolderBookmarked(folder.id)
    const isSelected = selectedFolderId === folder.id

    return (
      <button
        key={folder.id}
        onClick={() => !isBookmarked && setSelectedFolderId(folder.id)}
        disabled={isBookmarked}
        className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-colors ${
          isBookmarked
            ? 'bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400 cursor-default'
            : isSelected
            ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400'
            : 'hover:bg-gray-100 dark:hover:bg-gray-700'
        }`}
      >
        {isSelected ? <FolderOpen size={18} /> : <Folder size={18} />}
        <span className="flex-1 truncate">{folder.name}</span>
        {isBookmarked && <Check size={16} className="text-green-500" />}
      </button>
    )
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/50" 
        onClick={onClose}
      />
      
      {/* Modal */}
      <div className="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md mx-4 overflow-hidden">
        {/* Header */}
        <div className="flex items-center justify-between px-4 py-3 border-b dark:border-gray-700">
          <h3 className="font-semibold text-gray-900 dark:text-gray-100">
            收藏到文件夹
          </h3>
          <button
            onClick={onClose}
            className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
          >
            <X size={20} />
          </button>
        </div>

        {/* URL Preview */}
        <div className="px-4 py-2 bg-gray-50 dark:bg-gray-900/50 border-b dark:border-gray-700">
          <p className="text-sm text-gray-600 dark:text-gray-400 truncate" title={url}>
            {title || url}
          </p>
        </div>

        {/* Content */}
        <div className="px-4 py-3 max-h-80 overflow-y-auto">
          {loading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="animate-spin text-gray-400" />
            </div>
          ) : error ? (
            <div className="text-center py-8 text-red-500">{error}</div>
          ) : (
            <div className="space-y-1">
              {/* Uncategorized option */}
              <button
                onClick={() => !isFolderBookmarked(null) && setSelectedFolderId(null)}
                disabled={isFolderBookmarked(null)}
                className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-colors ${
                  isFolderBookmarked(null)
                    ? 'bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400 cursor-default'
                    : selectedFolderId === null
                    ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400'
                    : 'hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                <Folder size={18} />
                <span className="flex-1">未分类</span>
                {isFolderBookmarked(null) && <Check size={16} className="text-green-500" />}
              </button>
              
              {/* User folders */}
              {folders.map(renderFolderOption)}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="flex items-center justify-between px-4 py-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
          <button
            onClick={() => window.open('/bookmarks', '_blank')}
            className="text-sm text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1"
          >
            <Plus size={14} />
            新建文件夹
          </button>
          <div className="flex gap-2">
            <button
              onClick={onClose}
              className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
            >
              取消
            </button>
            <button
              onClick={handleSave}
              disabled={saving || (selectedFolderId !== null && isFolderBookmarked(selectedFolderId))}
              className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            >
              {saving && <Loader2 size={14} className="animate-spin" />}
              收藏
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
```

### 2.2 页面集成方案

#### 2.2.1 网页详情页 `/webpages/[urlHash]/page.tsx`

在页面头部区域添加收藏按钮：

```tsx
import BookmarkButton from '@/components/bookmarks/BookmarkButton'

// In the header section, next to the title
<div className="flex items-center gap-3">
  <h1 className="text-2xl font-bold">{webpage.title}</h1>
  <BookmarkButton 
    url={webpage.url}
    title={webpage.title || undefined}
    variant="button"
  />
</div>
```

#### 2.2.2 网页列表页 `/webpages/page.tsx`

在每个网页卡片右上角添加收藏按钮：

```tsx
import BookmarkButton from '@/components/bookmarks/BookmarkButton'

// In the webpage card component
<div className="relative group">
  <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
    <BookmarkButton 
      url={webpage.url}
      title={webpage.title || undefined}
      variant="icon"
    />
  </div>
  {/* ... rest of card content */}
</div>
```

#### 2.2.3 首页热门网页 `HotContent.tsx`

在热门网页列表项添加收藏按钮：

```tsx
import BookmarkButton from '@/components/bookmarks/BookmarkButton'

// In the webpage list item
<div className="flex items-center gap-2">
  <span className="text-gray-400">{webpage.rating_count} 评分</span>
  <BookmarkButton 
    url={webpage.url}
    variant="compact"
  />
</div>
```

### 2.3 实现优先级

| 优先级 | 任务 | 工作量 | 依赖 |
|--------|------|--------|------|
| P0 | 创建 `BookmarkButton` 组件 | 2h | 无 |
| P0 | 创建 `BookmarkModal` 组件 | 2h | BookmarkButton |
| P0 | 集成到 `/webpages/[urlHash]` 详情页 | 0.5h | BookmarkButton |
| P1 | 集成到 `/webpages` 列表页 | 1h | BookmarkButton |
| P1 | 集成到首页 `HotContent` | 1h | BookmarkButton |
| P2 | 添加收藏统计（网页被多少人收藏） | 2h | 新增 API |

**预计总工作量**: 8-10 小时

---

## 三、长期优化方案

### 3.1 快速收藏功能（P1）

**问题**: 每次收藏都要打开弹窗选择文件夹，操作步骤多

**解决方案**: 
1. **长按/右键菜单**: 直接收藏到默认文件夹
2. **快捷键支持**: `Ctrl/Cmd + D` 收藏当前页
3. **默认文件夹设置**: 用户可在设置中指定默认收藏文件夹

```tsx
// BookmarkButton 增强
interface BookmarkButtonProps {
  // ...existing props
  enableQuickSave?: boolean // 启用快速收藏
  defaultFolderId?: string // 默认文件夹
  onQuickSave?: () => void
}

// 长按检测
const handleMouseDown = () => {
  if (enableQuickSave) {
    longPressTimer = setTimeout(() => quickSave(), 500)
  }
}
```

### 3.2 收藏统计与社交功能（P1）

**功能点**：
1. **收藏计数**: 显示"已被 N 人收藏"
2. **热门收藏**: 首页展示"最多收藏的网页"
3. **收藏者列表**: 查看谁收藏了这个网页（可选隐私设置）

**API 扩展**:

```typescript
// GET /api/webpages/[urlHash]/stats
{
  "bookmark_count": 42,
  "rating_count": 15,
  "comment_count": 8
}

// GET /api/webpages?sort=bookmarks
// 按收藏数排序
```

**数据库扩展**:

```sql
-- 添加索引优化收藏计数查询
CREATE INDEX idx_bookmark_items_webpage_id ON bookmark_items(webpage_id);

-- 或使用物化视图缓存计数
CREATE MATERIALIZED VIEW webpage_stats AS
SELECT 
  w.id as webpage_id,
  w.url_hash,
  COUNT(DISTINCT bi.id) as bookmark_count
FROM webpages w
LEFT JOIN bookmark_items bi ON bi.webpage_id = w.id
GROUP BY w.id, w.url_hash;
```

### 3.3 收藏夹同步与导入（P2）

**功能点**：
1. **浏览器书签导入**: 从 Chrome/Firefox/Edge 导入书签
2. **其他服务导入**: 从 Pocket、Raindrop.io、Pinboard 导入
3. **跨设备同步**: 网站与扩展实时同步

**技术方案**:

```typescript
// 已有的导入导出 API
// POST /api/bookmarks/import
// GET /api/bookmarks/export

// 扩展支持的格式
const SUPPORTED_FORMATS = [
  'netscape-html',  // 标准浏览器书签格式
  'pocket-csv',     // Pocket 导出格式
  'raindrop-json',  // Raindrop.io JSON
  'json'            // 通用 JSON
]
```

### 3.4 智能收藏推荐（P2）

**功能点**：
1. **相似网页推荐**: "收藏了这个的人也收藏了..."
2. **阅读历史分析**: 基于浏览记录推荐收藏
3. **自动分类建议**: AI 建议将新收藏放入哪个文件夹

**技术方案**:

```typescript
// 基于协同过滤的推荐
// GET /api/bookmarks/recommendations

// 基于内容的分类建议
// POST /api/bookmarks/suggest-folder
{
  "url": "https://example.com/article",
  "title": "Machine Learning Tutorial",
  "suggestedFolders": [
    { "id": "xxx", "name": "AI/ML", "confidence": 0.85 },
    { "id": "yyy", "name": "教程", "confidence": 0.72 }
  ]
}
```

### 3.5 收藏夹可视化（P2）

**功能点**：
1. **标签云**: 基于收藏网页的关键词
2. **时间线视图**: 按收藏时间展示
3. **域名分组**: 自动按网站分组显示

**UI 设计**:

```
┌────────────────────────────────────────────────┐
│  收藏夹视图切换: [列表] [网格] [时间线] [域名] │
├────────────────────────────────────────────────┤
│  时间线视图:                                   │
│  ○ 今天 (3)                                   │
│    ├─ 文章A                                   │
│    ├─ 文章B                                   │
│    └─ 文章C                                   │
│  ○ 昨天 (5)                                   │
│    ├─ ...                                     │
│  ○ 上周 (12)                                  │
│    └─ ...                                     │
└────────────────────────────────────────────────┘
```

---

## 四、参考设计

### 4.1 竞品分析

| 产品 | 收藏方式 | 特色功能 | 可借鉴点 |
|------|----------|----------|----------|
| **Pocket** | 一键保存按钮 | 阅读模式、标签 | 简洁的保存流程 |
| **Raindrop.io** | 浏览器扩展+网页 | 嵌套文件夹、协作 | 强大的组织功能 |
| **Pinterest** | Pin 按钮 | 画板分类、视觉展示 | 视觉化展示 |
| **Notion Web Clipper** | 选择数据库 | 自定义属性 | 灵活的元数据 |
| **Edge 收藏夹** | Ctrl+D 快捷键 | 收藏栏、文件夹 | 原生体验 |

### 4.2 交互设计原则

1. **渐进增强**
   - 未登录: 显示收藏按钮，点击跳转登录
   - 已登录: 完整功能

2. **最小操作路径**
   - 常用操作 < 3 次点击
   - 提供键盘快捷键

3. **即时反馈**
   - 收藏成功: 动画 + Toast 提示
   - 显示收藏到哪个文件夹

4. **容错设计**
   - 重复收藏: 提示已存在，可添加到其他文件夹
   - 离线支持: 队列保存，恢复后同步

---

## 五、实施路线图

```
Phase 1 (短期 MVP) - 1 周
├── Day 1-2: 创建 BookmarkButton + BookmarkModal 组件
├── Day 3: 集成到网页详情页
├── Day 4: 集成到网页列表页
├── Day 5: 集成到首页热门网页
└── Day 6-7: 测试、修复、优化

Phase 2 (功能增强) - 2 周
├── Week 1: 快速收藏 + 默认文件夹
├── Week 1: 收藏统计（被收藏数）
└── Week 2: 热门收藏排行榜

Phase 3 (长期优化) - 持续
├── 智能分类建议
├── 导入更多格式
├── 可视化视图
└── 协作收藏夹
```

---

## 六、技术注意事项

### 6.1 性能优化

1. **批量查询收藏状态**
   - 列表页需要批量检查多个 URL 的收藏状态
   - 新增 API: `POST /api/bookmarks/items/check-batch`

```typescript
// 批量检查 API
// POST /api/bookmarks/items/check-batch
{
  "urls": ["url1", "url2", "url3"]
}
// Response
{
  "results": {
    "url1": { "isBookmarked": true, "folders": ["xxx"] },
    "url2": { "isBookmarked": false, "folders": [] },
    "url3": { "isBookmarked": true, "folders": ["yyy", "zzz"] }
  }
}
```

2. **客户端缓存**
   - 使用 React Query 或 SWR 缓存收藏状态
   - 乐观更新，提升响应速度

### 6.2 安全考虑

1. **权限验证**: 所有收藏 API 需验证用户身份
2. **速率限制**: 防止恶意批量收藏
3. **数据隔离**: RLS 策略确保用户只能访问自己的收藏

### 6.3 与浏览器扩展的一致性

1. **共用 API**: 网站和扩展使用相同的 `/api/bookmarks/*` 接口
2. **共用类型**: 收藏类型定义在 `@/types/bookmarks`
3. **状态同步**: 扩展收藏后，网页刷新应显示已收藏状态

---

## 七、附录

### 7.1 相关文档

- [10.6 网页收藏夹与关联链接系统设计](./10.6-Bookmarks-and-Related-Links-Design.md) - 数据库设计与 API 规范
- [10.6.1 浏览器扩展收藏优化](./10.6.1-Bookmark-Extension-Optimization.md) - 扩展端实现
- [10.6.2 收藏夹页面优化](./10.6.2-Bookmarks-Page-Optimization.md) - 管理页面优化

### 7.2 相关代码

- 收藏页面: `src/app/bookmarks/page.tsx`
- 收藏 API: `src/app/api/bookmarks/`
- 扩展 Popup: `extension/popup.html`
- 类型定义: `src/types/bookmarks.ts`

### 7.3 设计决策记录

| 决策 | 选项 | 决定 | 理由 |
|------|------|------|------|
| 收藏按钮位置 | 固定浮动 vs 内嵌 | 内嵌 | 更自然，不遮挡内容 |
| 文件夹选择 | 下拉菜单 vs 弹窗 | 弹窗 | 支持更多信息展示 |
| 默认行为 | 直接收藏 vs 选择文件夹 | 选择文件夹 | 保持与扩展一致 |
| 已收藏提示 | 禁用按钮 vs 允许多次 | 允许添加到其他文件夹 | 更灵活 |

---

**文档版本**: v1.0  
**创建日期**: 2025-01-16  
**作者**: GitHub Copilot  
**状态**: 待实施
