# 7.6 Zotero PDF Translate 弹窗注入机制分析

## 核心原理

zotero-pdf-translate 通过 **Zotero Reader API 事件监听** 在原生标注弹窗周围添加组件,而非直接修改弹窗 DOM。

## 关键实现

### 1. 事件注册入口

**文件**: `src/modules/reader.ts`

```typescript
export function registerReaderInitializer() {
  // 监听文本选择弹窗渲染事件
  Zotero.Reader.registerEventListener(
    "renderTextSelectionPopup",
    (event) => {
      const { reader, doc, params, append } = event;
      addon.data.translate.selectedText = params.annotation.text.trim();
      addon.hooks.onReaderPopupShow(event);
    },
    config.addonID,
  );
}
```

### 2. 弹窗构建逻辑

**文件**: `src/modules/popup.ts`

#### 关键方法: `buildReaderPopup(event)`

```typescript
export function buildReaderPopup(event) {
  const { reader, doc, append } = event;
  const popup = doc.querySelector(".selection-popup");
  
  // 通过 append 函数注入自定义元素
  append(
    ztoolkit.UI.createElement(doc, "fragment", {
      children: [
        // 1. 翻译按钮
        {
          tag: "button",
          id: makeId("translate"),
          classList: ["toolbar-button", "wide-button"],
          properties: {
            innerHTML: `${SVGIcon}翻译`,
          },
          listeners: [
            {
              type: "click",
              listener: () => { addon.hooks.onTranslate(); },
            },
          ],
        },
        
        // 2. 可编辑文本区域
        {
          tag: "textarea",
          id: makeId("text"),
          styles: {
            fontSize: `${getPref("fontSize")}px`,
            width: "-moz-available",
            height: "30px",
          },
        },
        
        // 3. "Add to Note" 按钮
        {
          tag: "button",
          id: makeId("addtonote"),
          properties: {
            innerHTML: "添加翻译至笔记",
          },
          listeners: [
            {
              type: "click",
              listener: async () => {
                // 获取翻译结果并添加到笔记
                await addon.hooks.onTranslate(task);
                reader._addToNote([annotation]);
              },
            },
          ],
        },
      ],
    }),
  );
}
```

### 3. 动态更新机制

**刷新流程**: 当翻译完成后调用 `updateReaderPopup()`

```typescript
export function updateReaderPopup() {
  const popup = addon.data.popup.currentPopup;
  
  // 获取最新翻译任务
  const task = getLastTranslateTask({ type: "text" });
  
  // 更新文本区域内容
  textarea.value = task.result || task.raw;
  
  // 控制按钮显示/隐藏
  const hideTranslateButton = task.status !== "waiting";
  updateHidden(translateButton, hideTranslateButton);
  
  // 调整弹窗尺寸
  updatePopupSize(popup, textarea);
}
```

## 技术要点

### API 使用

| API | 说明 | 触发时机 |
|-----|------|----------|
| `Zotero.Reader.registerEventListener()` | 注册读者事件监听器 | 插件初始化 |
| `renderTextSelectionPopup` | 选中文本后弹窗渲染事件 | 用户在PDF选择文本 |
| `event.append()` | 向弹窗追加元素的函数 | 事件回调中 |

### DOM 注入策略

```
.selection-popup (Zotero原生)
├── .colors (原生高亮颜色选择器)
├── [插件注入] #audiobox (发音按钮)
├── [插件注入] #translate (翻译按钮)
├── [插件注入] #text (翻译结果文本区)
└── [插件注入] #addtonote (添加到笔记按钮)
```

### 响应式尺寸调整

```typescript
function updatePopupSize(popup, textarea) {
  const textHeight = textarea.scrollHeight;
  const textWidth = textarea.scrollWidth;
  
  // 宽高比 > 0.75 时增加宽度
  if (textHeight / textWidth > 0.75 && 
      popup.offsetLeft + newWidth < viewer.offsetWidth) {
    textarea.style.width = `${newWidth}px`;
    updatePopupSize(popup, textarea, false); // 递归调整
  }
  
  // 最终调整高度
  textarea.style.height = `${textHeight + 3}px`;
}
```

## 适配参考

### 应用到 Researchopia 的步骤

1. **注册事件监听**
   ```typescript
   Zotero.Reader.registerEventListener(
     "renderTextSelectionPopup",
     onPopupRender,
     "researchopia"
   );
   ```

2. **在事件回调中注入元素**
   ```typescript
   function onPopupRender(event) {
     const { append, doc } = event;
     append(createCustomElements(doc));
   }
   ```

3. **维护组件状态**
   - 存储当前弹窗引用: `currentPopup`
   - 异步更新内容: `updatePopup()`
   - 响应用户交互

## 注意事项

⚠️ **不要直接修改 `.selection-popup` 内部结构** - 使用 `append()` 追加元素  
⚠️ **元素ID需要唯一** - 使用 `${pluginID}-${readerID}-${type}` 格式  
⚠️ **样式冲突** - 使用 `!important` 或提高选择器优先级

---

**参考仓库**: [windingwind/zotero-pdf-translate](https://github.com/windingwind/zotero-pdf-translate)  
**核心文件**:
- `src/modules/reader.ts` (事件注册)
- `src/modules/popup.ts` (弹窗构建/更新)
