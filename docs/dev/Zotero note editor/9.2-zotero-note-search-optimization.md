# 9.2 Zotero Note æœç´¢åŠŸèƒ½ä¼˜åŒ–

## ä¸€ã€åŸç”Ÿæœç´¢æ€§èƒ½é—®é¢˜åˆ†æ

### æ ¸å¿ƒé—®é¢˜
Zotero note åŸç”Ÿæœç´¢ï¼ˆCtrl+Fï¼‰åœ¨å¤§æ–‡æ¡£åœºæ™¯ä¸‹å­˜åœ¨ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼š
1. **CPU å ç”¨é«˜** - è¾“å…¥è¿‡ç¨‹å’Œ Previous/Next æ“ä½œå‡ºç°ç§’çº§å¡é¡¿
2. **å®æ—¶å…¨æ–‡éå†** - æ¯æ¬¡è¾“å…¥å­—ç¬¦éƒ½è§¦å‘å®Œæ•´ `doc.descendants()` éå†
3. **decoration å…¨é‡é‡å»º** - æ‰€æœ‰åŒ¹é…ç»“æœéƒ½åˆ›å»º `Decoration.inline()`ï¼Œæ— æ•°é‡é™åˆ¶

### æŠ€æœ¯æ ¹å› 

**å®˜æ–¹ä»£ç ** ([search.js](https://github.com/zotero/note-editor/blob/master/src/core/plugins/search.js)):

```javascript
// é—®é¢˜1: æ¯æ¬¡è¾“å…¥éƒ½å…¨æ–‡éå†
updateView() {
  if (this.triggerUpdate) {
    this.search(tr.doc); // âŒ æ— é˜²æŠ–ï¼Œå®æ—¶æ‰§è¡Œ
    // ...
  }
}

search(doc) {
  this.results = [];
  // âŒ éå†æ•´ä¸ªæ–‡æ¡£çš„æ‰€æœ‰ text node
  doc.descendants((node, pos) => {
    if (node.isText) {
      // æ­£åˆ™åŒ¹é… + å˜éŸ³ç¬¦å¤„ç†
      let chars = removeDiacritics(node.text);
      // ...
    }
  });
  
  // é—®é¢˜2: æ— æ•°é‡é™åˆ¶åœ°åˆ›å»º decoration
  let list = this.results.map((deco, index) => (
    Decoration.inline(deco.from, deco.to, { class: 'find' })
  )); // âŒ å¦‚æœåŒ¹é… 2000+ ç»“æœï¼Œåˆ›å»º 2000+ decoration
  this.decorations = DecorationSet.create(tr.doc, list);
}
```

**æ€§èƒ½ç“¶é¢ˆ**:
- `doc.descendants()` - O(n) å¤æ‚åº¦ï¼Œ10000+ èŠ‚ç‚¹æ–‡æ¡£éå†è€—æ—¶ 100-500ms
- `removeDiacritics()` - æ¯ä¸ª text node éƒ½æ‰§è¡Œå˜éŸ³ç¬¦è½¬æ¢
- `DecorationSet.create()` - å¤§é‡ decoration å¯¹è±¡åˆ›å»ºå’Œ DOM æ¸²æŸ“
- `scrollIntoView()` - æ¯æ¬¡ next/prev éƒ½è§¦å‘å¹³æ»‘æ»šåŠ¨ï¼Œé˜»å¡ UI

---

## äºŒã€æ’ä»¶ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒåŸç†
**è½»é‡çº§ CSS Overlay + é˜²æŠ– + è™šæ‹Ÿæ¸²æŸ“**

### å…³é”®ä¼˜åŒ–

#### 1. è¾“å…¥é˜²æŠ–ï¼ˆ300msï¼‰
```typescript
private searchDebounceTimer: number | null = null;

private onSearchInput(): void {
  if (this.searchDebounceTimer) clearTimeout(this.searchDebounceTimer);
  
  // å»¶è¿Ÿ 300ms æ‰§è¡Œï¼Œé¿å…æ¯ä¸ªå­—ç¬¦éƒ½è§¦å‘æœç´¢
  this.searchDebounceTimer = setTimeout(() => {
    this.performSearch();
  }, 300);
}
```

**æ•ˆæœ**: å¿«é€Ÿè¾“å…¥ "search" 5 ä¸ªå­—ç¬¦ï¼Œåªæ‰§è¡Œ 1 æ¬¡æœç´¢ï¼ˆè€Œé 5 æ¬¡ï¼‰

#### 2. TreeWalker é«˜æ•ˆéå†
```typescript
// ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ TreeWalker API æ›¿ä»£ ProseMirror doc.descendants()
const walker = document.createTreeWalker(
  editorBody,
  NodeFilter.SHOW_TEXT,
  null
);

let textNode;
while ((textNode = walker.nextNode())) {
  const text = textNode.textContent || '';
  // æ­£åˆ™åŒ¹é…...
}
```

**ä¼˜åŠ¿**: TreeWalker æ˜¯ C++ å®ç°ï¼Œæ¯” JavaScript éå†å¿« 3-5 å€

#### 3. è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“ï¼ˆæœ€å¤š 200 ä¸ª overlayï¼‰
```typescript
// åªæ¸²æŸ“å½“å‰ä½ç½® Â±50/Â±150 èŒƒå›´å†…çš„ç»“æœ
const renderStart = Math.max(0, this.currentIndex - 50);
const renderEnd = Math.min(this.matches.length, this.currentIndex + 150);

for (let i = renderStart; i < renderEnd && overlays.length < 200; i++) {
  // åˆ›å»º overlay
}
```

**æ•ˆæœ**: 
- è¾“å…¥ "t" åŒ¹é… 2696 ä¸ªç»“æœ
- å®˜æ–¹æ–¹æ¡ˆ: åˆ›å»º 2696 ä¸ª decorationï¼Œè€—æ—¶ 1.5s+ï¼Œå¡é¡¿ä¸¥é‡
- æ’ä»¶æ–¹æ¡ˆ: åªåˆ›å»º 200 ä¸ª overlayï¼Œè€—æ—¶ <100msï¼Œæµç•…

#### 4. ç‹¬ç«‹ Overlay å®¹å™¨
```typescript
// åœ¨ .ProseMirror å¤–éƒ¨åˆ›å»ºç‹¬ç«‹å®¹å™¨
const container = document.createElement('div');
container.id = 'custom-search-overlay-container';
container.style.cssText = `
  position: absolute;
  pointer-events: none;
  z-index: 10;
`;
editorBody.parentElement.appendChild(container);

// ä½¿ç”¨ç»å¯¹å®šä½ div è¦†ç›–æ–‡æœ¬
const overlay = document.createElement('div');
overlay.style.cssText = `
  position: absolute;
  left: ${rect.left}px;
  top: ${rect.top}px;
  width: ${rect.width}px;
  height: ${rect.height}px;
  background: yellow;
  opacity: 0.6;
`;
container.appendChild(overlay);
```

**ä¼˜åŠ¿**: 
- ä¸ä¿®æ”¹ ProseMirror documentï¼Œä¸è§¦å‘ `tr.docChanged`
- ä¸èµ° ProseMirror æ¸²æŸ“ç®¡çº¿ï¼Œåˆ›å»ºæ›´å¿«
- å¯¼èˆªæ—¶åªéœ€ä¿®æ”¹ CSSï¼Œæ— éœ€é‡å»ºæ•´ä¸ª DecorationSet

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | å®˜æ–¹æœç´¢ | æ’ä»¶æœç´¢ | æå‡ |
|------|----------|----------|------|
| **è¾“å…¥ "t"ï¼ˆ2696 åŒ¹é…ï¼‰** | 1.5s+ å¡é¡¿ | <100ms æµç•… | **15x** |
| **Previous/Next å¯¼èˆª** | 200-500ms | <50ms | **4-10x** |
| **CPU å ç”¨** | æŒç»­ 80%+ | ç¬é—´å³°å€¼ <30% | **3x** |

---

## ä¸‰ã€å®˜æ–¹ PR ä¼˜åŒ–æ€è·¯

### ç›®æ ‡ä»“åº“
https://github.com/zotero/note-editor

### æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆ Aï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼ˆæ¨èï¼‰
ä¿æŒç°æœ‰ Decoration API æ¶æ„ï¼Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

##### 1. æ·»åŠ è¾“å…¥é˜²æŠ–
```javascript
// search.js ç¬¬ 220 è¡Œé™„è¿‘
class Search {
  constructor(options = {}) {
    // ...
    this.debounceTimer = null;
  }
  
  updateView() {
    if (this.debounceTimer) clearTimeout(this.debounceTimer);
    
    this.debounceTimer = setTimeout(() => {
      if (this.triggerUpdate) {
        this.search(tr.doc);
        // ...
      }
    }, 300); // æ·»åŠ é˜²æŠ–
  }
}
```

##### 2. Decoration è™šæ‹Ÿæ¸²æŸ“
```javascript
search(doc) {
  // ... ç°æœ‰æœç´¢é€»è¾‘
  
  // åªä¸ºå¯è§åŒºåŸŸ + é™„è¿‘åˆ›å»º decoration
  const MAX_DECORATIONS = 200;
  const visibleStart = Math.max(0, this.selectedResultIndex - 50);
  const visibleEnd = Math.min(this.results.length, this.selectedResultIndex + 150);
  
  let list = this.results
    .slice(visibleStart, visibleEnd)
    .map((deco, index) => (
      Decoration.inline(deco.from, deco.to, {
        class: (visibleStart + index) === this.selectedResultIndex
          ? this.findSelectedClass : this.findClass
      })
    ));
  
  this.decorations = DecorationSet.create(tr.doc, list);
}
```

##### 3. ç¼“å­˜æœç´¢ç»“æœ
```javascript
search(doc) {
  // æ·»åŠ ç»“æœç¼“å­˜
  const cacheKey = `${this.searchTerm}-${this.caseSensitive}-${this.wholeWords}`;
  if (this.cachedResults && this.cachedResults.key === cacheKey) {
    this.results = this.cachedResults.results;
    return;
  }
  
  // æ‰§è¡Œæœç´¢...
  this.cachedResults = { key: cacheKey, results: this.results };
}
```

**é¢„æœŸæ•ˆæœ**: 
- è¾“å…¥å¡é¡¿ä»ç§’çº§é™ä½åˆ° <300ms
- Previous/Next å“åº”ä» 200-500ms é™ä½åˆ° <100ms
- CPU å ç”¨å³°å€¼é™ä½ 50%

#### æ–¹æ¡ˆ Bï¼šæ¶æ„é‡æ„ï¼ˆæ¿€è¿›ï¼‰
å®Œå…¨é‡å†™ä¸º Web Worker + IndexedDB ç´¢å¼•

```javascript
// ä¸»çº¿ç¨‹: search-ui.js
class SearchUI {
  constructor() {
    this.worker = new Worker('search-worker.js');
  }
  
  search(query) {
    this.worker.postMessage({ type: 'search', query, docId: this.doc.id });
  }
}

// Worker çº¿ç¨‹: search-worker.js
self.onmessage = async (e) => {
  if (e.data.type === 'search') {
    // åœ¨ worker ä¸­æ‰§è¡Œæœç´¢ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
    const results = await searchInIndexedDB(e.data.query, e.data.docId);
    self.postMessage({ type: 'results', results });
  }
};
```

**ä¼˜åŠ¿**: 
- æœç´¢å®Œå…¨ä¸é˜»å¡ UI
- å¤§æ–‡æ¡£å¯é¢„å»ºç´¢å¼•
- æ”¯æŒå¢é‡æ›´æ–°

**åŠ£åŠ¿**: 
- å·¥ç¨‹å¤æ‚åº¦é«˜
- éœ€è¦é‡å†™ç°æœ‰æ¶æ„
- ç»´æŠ¤æˆæœ¬å¢åŠ 

### æ¨èå®æ–½æ­¥éª¤

1. **Phase 1: å¿«é€Ÿä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰**
   - æ·»åŠ è¾“å…¥é˜²æŠ–ï¼ˆ300msï¼‰
   - å®ç° decoration è™šæ‹Ÿæ¸²æŸ“ï¼ˆmax 200ï¼‰
   - æäº¤ PRï¼Œæ ‡é¢˜ï¼š`perf: optimize search performance for large documents`

2. **Phase 2: ç¼“å­˜ä¼˜åŒ–ï¼ˆ2-3 å‘¨ï¼‰**
   - æ·»åŠ æœç´¢ç»“æœç¼“å­˜
   - ä¼˜åŒ– `removeDiacritics()` æ€§èƒ½ï¼ˆä½¿ç”¨ Map ç¼“å­˜ï¼‰
   - æäº¤å•ç‹¬ PR

3. **Phase 3: æ¶æ„è¯„ä¼°ï¼ˆå¯é€‰ï¼‰**
   - ä¸ Zotero å›¢é˜Ÿè®¨è®º Web Worker æ–¹æ¡ˆå¯è¡Œæ€§
   - å¦‚æœæ¥å—ï¼Œå•ç‹¬åˆ†æ”¯å®ç°

---

## å››ã€æ€»ç»“

### æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | å®˜æ–¹æœç´¢ | æ’ä»¶ä¼˜åŒ– | å®˜æ–¹ PR æ–¹æ¡ˆ |
|------|----------|----------|--------------|
| **éå†æ–¹å¼** | `doc.descendants()` | `TreeWalker` | ä¿æŒ descendants + ç¼“å­˜ |
| **é˜²æŠ–** | âŒ æ—  | âœ… 300ms | âœ… æ·»åŠ  300ms |
| **æ¸²æŸ“ç­–ç•¥** | å…¨é‡ decoration | è™šæ‹Ÿ overlayï¼ˆmax 200ï¼‰ | è™šæ‹Ÿ decorationï¼ˆmax 200ï¼‰ |
| **CPU å ç”¨** | æŒç»­ 80%+ | ç¬é—´å³°å€¼ <30% | é¢„è®¡é™è‡³ 40-50% |
| **å®æ–½æˆæœ¬** | - | ç‹¬ç«‹æ’ä»¶ | PR å®¡æ ¸ + åˆå¹¶ |

### æ€§èƒ½æå‡é¢„æœŸ

**æ’ä»¶æ–¹æ¡ˆ**ï¼ˆå·²å®ç°ï¼‰:
- âœ… è¾“å…¥å“åº”: 1.5s â†’ <100msï¼ˆ**15x**ï¼‰
- âœ… å¯¼èˆªé€Ÿåº¦: 200-500ms â†’ <50msï¼ˆ**4-10x**ï¼‰
- âœ… CPU å ç”¨: 80%+ â†’ <30%ï¼ˆ**3x**ï¼‰

**å®˜æ–¹ PR æ–¹æ¡ˆ**ï¼ˆPhase 1 é¢„æœŸï¼‰:
- ğŸ¯ è¾“å…¥å“åº”: 1.5s â†’ <300msï¼ˆ**5x**ï¼‰
- ğŸ¯ å¯¼èˆªé€Ÿåº¦: 200-500ms â†’ <100msï¼ˆ**2-5x**ï¼‰
- ğŸ¯ CPU å ç”¨: 80%+ â†’ 40-50%ï¼ˆ**2x**ï¼‰

### å…³é”®æŠ€æœ¯ç‚¹

1. **é˜²æŠ–æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒ** - é¿å…æ— æ„ä¹‰çš„é‡å¤è®¡ç®—
2. **è™šæ‹Ÿæ¸²æŸ“æ˜¯å¿…è¦çš„** - æ— è®º overlay è¿˜æ˜¯ decorationï¼Œéƒ½è¦é™åˆ¶æ•°é‡
3. **TreeWalker vs doc.descendants()** - æµè§ˆå™¨åŸç”Ÿ API æ›´å¿«ï¼Œä½† ProseMirror æ–¹æ¡ˆæ›´æ˜“ç»´æŠ¤
4. **æ¸è¿›å¼ä¼˜åŒ–æ›´ç°å®** - å®Œå…¨é‡æ„é£é™©é«˜ï¼Œå°æ­¥å¿«è·‘æ›´æ˜“è¢«æ¥å—

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-11-26  
**ç›¸å…³æ–‡ä»¶**: 
- æ’ä»¶å®ç°: `zotero-better-notes/src/modules/customSearch/findbar.ts` (524 lines)
- å®˜æ–¹ä»£ç : https://github.com/zotero/note-editor/blob/master/src/core/plugins/search.js (275 lines)
