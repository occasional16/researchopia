# AIé©±åŠ¨çš„æ¨¡å—åŒ–é‡æ„æ–¹æ³•è®º (7.6)

**æ—¥æœŸ**: 2025-11-18 | **ç‰ˆæœ¬**: v1.0 | **å‰ç½®**: [7.4](./7.4-REFACTORING_DECISION_ANALYSIS.md) + [7.5](./7.5-PROGRESSIVE_REFACTORING_PLAN.md)

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ä¸ºä»€ä¹ˆAIé‡æ„æ€»æ˜¯å¤±è´¥ï¼Ÿ**

1. **AIçš„ç›²ç‚¹**
   - âŒ æ— æ³•ç†è§£å…¨å±€ä¾èµ–é“¾ï¼ˆæ”¹Aå½±å“Bã€Cã€D...ï¼‰
   - âŒ æ— æ³•è®°å¿†é•¿ä¸Šä¸‹æ–‡ï¼ˆè¶…è¿‡10ä¸ªæ–‡ä»¶åå¼€å§‹"å¤±å¿†"ï¼‰
   - âŒ è¿‡åº¦è‡ªä¿¡ï¼ˆä»£ç çœ‹èµ·æ¥å¯¹ï¼Œå®é™…é€»è¾‘é”™è¯¯ï¼‰

2. **é¡¹ç›®çš„æ­»ç©´**
   - ğŸš¨ 607è¡Œdatabase.ts - 18ä¸ªå‡½æ•°ç´§å¯†è€¦åˆ
   - ğŸš¨ APIè·¯ç”±æ— è¾¹ç•Œ - proxyã€v1ã€ç›´æ¥è·¯ç”±æ··æ‚
   - ğŸš¨ Mockä¸çœŸå®æ··åˆ - ç”Ÿäº§ä»£ç ä¸­å­˜åœ¨å¤§é‡Mocké€»è¾‘
   - ğŸš¨ 21ä¸ªTODO - æœªå®Œæˆçš„åŠŸèƒ½åƒå®šæ—¶ç‚¸å¼¹

3. **äººç±»çš„è¯¯åˆ¤**
   - âš ï¸ ç›¸ä¿¡"AIä¸€æ¬¡æå®šå¤§é‡æ„"
   - âš ï¸ ç¼ºå°‘æµ‹è¯•å°±å¼€å§‹æ”¹ä»£ç 
   - âš ï¸ commitæ··ä¹±æ— æ³•å›æ»š

---

## ğŸ’¡ AIé‡æ„çš„ç¬¬ä¸€æ€§åŸç†

### åŸåˆ™1: AIåªèƒ½åš"å±€éƒ¨é‡æ„" âœ…

**æ ¸å¿ƒæ´å¯Ÿ**: AIæ˜¯"è¿‘è§†çœ¼"ï¼Œçœ‹ä¸åˆ°ä»£ç èƒŒåçš„è¿è¡Œæ—¶ä¾èµ–ã€‚

**æ“ä½œæŒ‡å—**:
```
âœ… å•æ–‡ä»¶æ‹†åˆ† (database.ts â†’ papers.ts + users.ts)
âœ… æå–å·¥å…·å‡½æ•° (20è¡Œé‡å¤ä»£ç  â†’ utils/helper.ts)
âœ… ç»„ä»¶åŒ–UI (1000è¡Œ â†’ 5ä¸ª200è¡Œç»„ä»¶)

âŒ é‡å†™æ•´ä¸ªAPIå±‚ï¼ˆ11ä¸ªç«¯ç‚¹æ¶ˆå¤±çš„æ•™è®­ï¼‰
âŒ åŒæ—¶é‡æ„3ä¸ªç‹¬ç«‹æ¨¡å—ï¼ˆçˆ†ç‚¸åŠå¾„å¤ªå¤§ï¼‰
âŒ æ”¹å˜æ•°æ®æµæ¶æ„ï¼ˆproxyåˆ é™¤å¯¼è‡´çº§è”å¤±è´¥ï¼‰
```

### åŸåˆ™2: æµ‹è¯•æ˜¯AIçš„"çœ¼ç›" ğŸ”

**æ ¸å¿ƒæ´å¯Ÿ**: æ²¡æœ‰æµ‹è¯•ï¼ŒAIæ— æ³•çŸ¥é“ä»£ç æ˜¯å¦æ­£ç¡®ã€‚

**æ“ä½œæŒ‡å—**:
```typescript
// âŒ é”™è¯¯çš„é‡æ„é¡ºåº
1. AIé‡æ„ä»£ç  â†’ 2. è¿è¡Œç¨‹åº â†’ 3. å‘ç°å´©æºƒ â†’ 4. æ— æ³•å®šä½é—®é¢˜

// âœ… æ­£ç¡®çš„é‡æ„é¡ºåº
1. å†™æµ‹è¯•ï¼ˆè¦†ç›–ç°æœ‰è¡Œä¸ºï¼‰
2. AIé‡æ„ä»£ç 
3. è¿è¡Œæµ‹è¯•ï¼ˆå¤±è´¥ = ä»£ç é”™è¯¯ï¼ŒæˆåŠŸ = å¯æäº¤ï¼‰
4. æ‰‹åŠ¨éªŒè¯æ ¸å¿ƒæµç¨‹
```

**æµ‹è¯•é‡‘å­—å¡”**:
```
E2Eæµ‹è¯• (5%)         â† ç”¨æˆ·å®Œæ•´æµç¨‹ (ç™»å½•â†’åˆ›å»ºä¼šè¯â†’åˆ†äº«æ ‡æ³¨)
   â†‘
é›†æˆæµ‹è¯• (15%)       â† APIç«¯åˆ°ç«¯ (POST /api/sessions â†’ DB)
   â†‘
å•å…ƒæµ‹è¯• (80%)       â† å‡½æ•°çº§ (normalizeDOI('10.1000/abc') === '10.1000/abc')
```

### åŸåˆ™3: å¢é‡æäº¤ = æ—¶å…‰æœº â±ï¸

**æ ¸å¿ƒæ´å¯Ÿ**: AIä¼šçŠ¯é”™ï¼Œä½†Gitä¸ä¼šã€‚

**æ“ä½œæŒ‡å—**:
```bash
# âœ… æ¯æ¬¡é‡æ„åç«‹å³æäº¤
git add src/lib/papers.ts
git commit -m "refactor(db): æ‹†åˆ†database.ts - papersæ¨¡å—

- æå–getPapers/createPaperç­‰å‡½æ•°
- æµ‹è¯•: 18/18é€šè¿‡
- å½±å“èŒƒå›´: src/app/api/papers/*.ts"

# âŒ ç­‰æ‰€æœ‰æ¨¡å—éƒ½æ”¹å®Œå†æäº¤ (ç¾éš¾æ€§çš„)
git add .
git commit -m "é‡æ„å®Œæˆ" # æ— æ³•å›æ»šå•ä¸ªæ¨¡å—
```

**æäº¤ç²’åº¦**:
| ç±»å‹ | è¡Œæ•°å˜åŒ– | æ–‡ä»¶æ•° | æäº¤æ—¶æœº |
|------|----------|--------|----------|
| å·¥å…·æå– | â‰¤100 | 1-2 | ç«‹å³ |
| ç»„ä»¶æ‹†åˆ† | â‰¤300 | 2-5 | æµ‹è¯•é€šè¿‡å |
| æ¨¡å—é‡æ„ | â‰¤500 | 3-10 | é›†æˆæµ‹è¯•é€šè¿‡å |

---

## ğŸ”§ é’ˆå¯¹Researchopiaçš„AIé‡æ„ç­–ç•¥

### ç­–ç•¥1: "è¯»å†™åˆ†ç¦»" - å…ˆæ‹†æ•°æ®å±‚

**ç°çŠ¶**: `src/lib/database.ts` (607è¡Œ) åŒ…å«Papersã€Usersã€Commentsã€Ratingsæ‰€æœ‰æ“ä½œ

**é—®é¢˜**:
```typescript
// å…¸å‹çš„è€¦åˆä»£ç 
export async function getPaperById(id: string) {
  const { data } = await supabase
    .from('papers')
    .select(`*, ratings(*), comments(*)`) // â† è·¨è¡¨æŸ¥è¯¢ï¼Œéš¾ä»¥æ‹†åˆ†
    .eq('id', id)
  
  // è®¡ç®—è¯„åˆ†é€»è¾‘æ··åœ¨æŸ¥è¯¢é‡Œ
  const avgRating = data.ratings.reduce(...) // â† ä¸šåŠ¡é€»è¾‘è€¦åˆ
}
```

**AIé‡æ„æ–¹æ¡ˆ** (3å¤©):

#### Day 1: åˆ›å»ºä»“å‚¨åŸºç±»
```typescript
// src/lib/repositories/BaseRepository.ts (100è¡Œ)
export abstract class BaseRepository<T> {
  protected tableName: string;
  
  async findById(id: string): Promise<T | null> { ... }
  async findAll(limit = 20, offset = 0): Promise<T[]> { ... }
  async create(data: Omit<T, 'id' | 'created_at'>): Promise<T> { ... }
}

// âœ… AIå¯ä»¥å®‰å…¨å®Œæˆ (çº¯æŠ½è±¡ï¼Œæ— ä¸šåŠ¡é€»è¾‘)
// âœ… æµ‹è¯•ç®€å• (Mock supabaseï¼ŒéªŒè¯SQLç”Ÿæˆ)
```

#### Day 2: æ‹†åˆ†Papersä»“å‚¨
```typescript
// src/lib/repositories/PapersRepository.ts (150è¡Œ)
export class PapersRepository extends BaseRepository<Paper> {
  constructor() { super('papers') }
  
  // åªè´Ÿè´£æ•°æ®åº“CRUDï¼Œä¸å«ä¸šåŠ¡é€»è¾‘
  async findByDOI(doi: string): Promise<Paper | null> { ... }
  async searchByTitle(query: string): Promise<Paper[]> { ... }
}

// src/lib/services/PapersService.ts (200è¡Œ)
export class PapersService {
  constructor(
    private papersRepo: PapersRepository,
    private ratingsRepo: RatingsRepository // â† ä¾èµ–æ³¨å…¥
  ) {}
  
  // ä¸šåŠ¡é€»è¾‘ï¼ˆè¯„åˆ†è®¡ç®—ã€ç»Ÿè®¡ï¼‰
  async getPaperWithStats(id: string): Promise<PaperWithStats> {
    const paper = await this.papersRepo.findById(id)
    const ratings = await this.ratingsRepo.findByPaperId(id)
    return { ...paper, avgRating: this.calcAvg(ratings) }
  }
}

// âœ… AIå¯ä»¥é€ä¸ªè¿ç§»å‡½æ•°
// âœ… æ¯è¿ç§»ä¸€ä¸ªå‡½æ•° = 1æ¬¡æäº¤
```

#### Day 3: é›†æˆæµ‹è¯•
```typescript
// src/__tests__/repositories/papers.test.ts
test('PapersRepository.findByDOI', async () => {
  const repo = new PapersRepository()
  const paper = await repo.findByDOI('10.1000/test')
  expect(paper.doi).toBe('10.1000/test')
})

// âœ… æµ‹è¯•é€šè¿‡ â†’ æäº¤ â†’ æ ‡è®°"papersæ¨¡å—é‡æ„å®Œæˆ"
```

**å…³é”®è§„åˆ™**:
- âŒ **ç¦æ­¢AIåŒæ—¶æ”¹åŠ¨Papers + Usersä»“å‚¨** (ä¾èµ–çˆ†ç‚¸)
- âœ… **æ¯ä¸ªä»“å‚¨ç‹¬ç«‹å®Œæˆåå†è¿›è¡Œä¸‹ä¸€ä¸ª** (éš”ç¦»é£é™©)

---

### ç­–ç•¥2: "ä¿æŠ¤ç½©" - APIå±‚å‘åå…¼å®¹

**ç°çŠ¶**: é‡æ„åAPIç«¯ç‚¹ä»103â†’92ï¼ˆ11ä¸ªæ¶ˆå¤±ï¼‰

**é—®é¢˜**: å‰ç«¯/æ’ä»¶/æ‰©å±•çš„æ‰€æœ‰è°ƒç”¨éƒ½ä¼šå¤±è´¥

**AIé‡æ„æ–¹æ¡ˆ** (2å¤©):

#### Day 1: åˆ›å»ºAPIé€‚é…å™¨
```typescript
// src/app/api/v2/papers/route.ts (æ–°ç«¯ç‚¹)
import { PapersService } from '@/lib/services/PapersService'

export async function GET(request: Request) {
  const service = new PapersService(...)
  const papers = await service.getPapersWithStats()
  return Response.json(papers) // â† æ–°æ ¼å¼
}

// src/app/api/v1/papers/route.ts (ä¿ç•™æ—§ç«¯ç‚¹)
export async function GET(request: Request) {
  const v2Response = await fetch('/api/v2/papers') // â† ä»£ç†åˆ°v2
  return v2Response // â† è¿”å›æ—§æ ¼å¼ï¼ˆé€‚é…å™¨è½¬æ¢ï¼‰
}

// âœ… æ—§å®¢æˆ·ç«¯ç»§ç»­å·¥ä½œ
// âœ… æ–°ä»£ç åªéœ€ç»´æŠ¤v2
// âœ… é€æ­¥è¿ç§»å®¢æˆ·ç«¯ååˆ é™¤v1
```

#### Day 2: è®°å½•è¿ç§»æ˜ å°„
```markdown
## APIè¿ç§»å¯¹ç…§è¡¨

| æ—§ç«¯ç‚¹ | æ–°ç«¯ç‚¹ | çŠ¶æ€ | å®¢æˆ·ç«¯è¿ç§» |
|--------|--------|------|------------|
| GET /api/papers | GET /api/v2/papers | âœ… | ç½‘ç«™âœ… æ’ä»¶âŒ æ‰©å±•âŒ |
| POST /api/proxy/annotations | POST /api/v2/annotations | âœ… | ç½‘ç«™âœ… æ’ä»¶âœ… æ‰©å±•âŒ |

**è§„åˆ™**: åªæœ‰"å®¢æˆ·ç«¯è¿ç§»"å…¨âœ…åæ‰èƒ½åˆ é™¤æ—§ç«¯ç‚¹
```

**å…³é”®è§„åˆ™**:
- âŒ **ç¦æ­¢AIç›´æ¥åˆ é™¤æ—§API** (ç ´åå‘åå…¼å®¹)
- âœ… **æ–°æ—§å¹¶å­˜â‰¥2å‘¨** (ç»™å®¢æˆ·ç«¯è¿ç§»æ—¶é—´)
- âœ… **è®°å½•æ¯ä¸ªç«¯ç‚¹çš„æ¶ˆè´¹è€…** (é˜²æ­¢é—æ¼)

---

### ç­–ç•¥3: "æ‰‹æœ¯åˆ€" - UIç»„ä»¶çš„ç²¾å‡†æ‹†åˆ†

**ç°çŠ¶**: `profile/page.tsx` (816è¡Œ) â†’ é‡æ„å201è¡Œ âœ… ä½†ä¾èµ–ç»„ä»¶æœªéªŒè¯

**é—®é¢˜**: æ‹†å‡ºçš„ç»„ä»¶å¯èƒ½ç¼ºå°‘å¿…è¦çš„props/context

**AIé‡æ„æ–¹æ¡ˆ** (1å¤©):

#### æ­¥éª¤1: è¯†åˆ«"è‡ªç„¶è¾¹ç•Œ"
```typescript
// âŒ é”™è¯¯æ‹†åˆ† (AIå¸¸çŠ¯çš„é”™è¯¯)
// ProfilePage.tsx â†’ æ‹†æˆ Header.tsx + Content.tsx
// é—®é¢˜: Headeréœ€è¦userï¼ŒContentä¹Ÿéœ€è¦userï¼Œéƒ½è¦ä¼ props

// âœ… æ­£ç¡®æ‹†åˆ† (åŸºäºåŠŸèƒ½å†…èš)
ProfilePage.tsx (201è¡Œ)
  â”œâ”€ PersonalInfo.tsx (80è¡Œ)      â† ç‹¬ç«‹åŠŸèƒ½ï¼šæ˜¾ç¤º+ç¼–è¾‘ä¸ªäººä¿¡æ¯
  â”œâ”€ AccountSettings.tsx (90è¡Œ)   â† ç‹¬ç«‹åŠŸèƒ½ï¼šå¯†ç /é‚®ç®±ç®¡ç†
  â””â”€ ActivityTimeline.tsx (120è¡Œ) â† ç‹¬ç«‹åŠŸèƒ½ï¼šç”¨æˆ·åŠ¨æ€
```

#### æ­¥éª¤2: å¢é‡æå– (æ¯æ¬¡1ä¸ªç»„ä»¶)
```bash
# ç¬¬1æ¬¡æäº¤
git add src/components/profile/PersonalInfo.tsx
git add src/app/profile/page.tsx # åªä¿®æ”¹å¼•å…¥PersonalInfo
git commit -m "refactor(profile): æå–PersonalInfoç»„ä»¶ (816â†’736è¡Œ)"

# ç¬¬2æ¬¡æäº¤
git add src/components/profile/AccountSettings.tsx
git commit -m "refactor(profile): æå–AccountSettingsç»„ä»¶ (736â†’646è¡Œ)"

# âœ… æ¯æ¬¡æäº¤åè¿è¡Œæµ‹è¯•+æ‰‹åŠ¨éªŒè¯
# âŒ ä¸è¦ä¸€æ¬¡æ€§æ‹†å®Œæ‰€æœ‰ç»„ä»¶
```

**å…³é”®è§„åˆ™**:
- âŒ **ç¦æ­¢AIæ‹†åˆ†"å±•ç¤º+é€»è¾‘"æ··åˆçš„ç»„ä»¶** (useState/useEffectä½ç½®é”™è¯¯)
- âœ… **æ¯ä¸ªç»„ä»¶æ‹†åˆ†åç«‹å³å†™Storybook** (éš”ç¦»éªŒè¯)
- âœ… **ä¿æŒContextä¾èµ–æœ€å°åŒ–** (é¿å…"ä¸Šä¸‹æ–‡åœ°ç‹±")

---

## ğŸš¨ AIé‡æ„çš„"ç¦é£åŒº"

### ç¦åŒº1: è®¤è¯ç³»ç»Ÿ â›”

**ä¸ºä»€ä¹ˆ**: è®¤è¯æ¶‰åŠå®‰å…¨ã€sessionã€tokenåˆ·æ–°ï¼ŒAIå®¹æ˜“å¿½ç•¥è¾¹ç¼˜æƒ…å†µ

**ç°çŠ¶é—®é¢˜**:
```typescript
// src/lib/auth-security.ts (300+è¡Œ)
export class SessionManager {
  // âŒ æ··åˆäº†ï¼šTokenç®¡ç† + æ´»åŠ¨è·Ÿè¸ª + è‡ªåŠ¨åˆ·æ–° + å®‰å…¨æ£€æŸ¥
  // âŒ AIæ— æ³•ç†è§£ï¼š"åˆ·æ–°å¤±è´¥æ—¶åº”è¯¥æ¸…ç†å“ªäº›çŠ¶æ€ï¼Ÿ"
}

// zotero-plugin/src/modules/auth.ts (200+è¡Œ)
// âŒ ä¸ç½‘ç«™çš„è®¤è¯é€»è¾‘ä¸åŒæ­¥
// âŒ session.expires_at çš„æ—¶é—´æˆ³å•ä½åˆ¤æ–­ï¼ˆç§’ vs æ¯«ç§’ï¼‰
```

**AIé‡æ„ç­–ç•¥**: âš ï¸ **ç¦æ­¢AIç‹¬ç«‹é‡æ„è®¤è¯æ¨¡å—**

**äººç±»ä¸»å¯¼æ–¹æ¡ˆ**:
1. **äººç±»è®¾è®¡æ¥å£**:
   ```typescript
   // äººç±»å®šä¹‰æ¸…æ™°çš„èŒè´£è¾¹ç•Œ
   interface IAuthCore { login(), logout() }
   interface ISessionManager { refresh(), validate() }
   interface ITokenManager { store(), retrieve() }
   ```

2. **AIé€ä¸ªå®ç°**:
   ```typescript
   // AIåªè´Ÿè´£å®ç°å•ä¸ªæ¥å£ï¼ˆ200è¡Œä»¥å†…ï¼‰
   class AuthCore implements IAuthCore {
     async login(email, password) { /* AIç”Ÿæˆ */ }
   }
   ```

3. **äººç±»éªŒè¯å…³é”®è·¯å¾„**:
   - ç™»å½• â†’ æˆåŠŸ â†’ Tokenå­˜å‚¨
   - Tokenè¿‡æœŸ â†’ åˆ·æ–° â†’ å¤±è´¥ â†’ æ¸…ç†çŠ¶æ€
   - è·¨TabåŒæ­¥ â†’ BroadcastChannel

### ç¦åŒº2: æ•°æ®åº“è¿ç§» â›”

**ä¸ºä»€ä¹ˆ**: Schemaå˜æ›´å½±å“æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå›æ»šä»£ä»·å·¨å¤§

**AIå¸¸çŠ¯é”™è¯¯**:
```sql
-- âŒ AIç”Ÿæˆçš„è¿ç§»
ALTER TABLE papers ADD COLUMN new_field TEXT;
-- é—®é¢˜ï¼šæ²¡æœ‰é»˜è®¤å€¼ï¼Œæ—§æ•°æ®æŸ¥è¯¢ä¼šå¤±è´¥

-- âŒ AIåˆ é™¤å­—æ®µ
ALTER TABLE users DROP COLUMN old_field;
-- é—®é¢˜ï¼šæ—§å®¢æˆ·ç«¯ä»åœ¨ä½¿ç”¨è¿™ä¸ªå­—æ®µï¼Œä¼šå´©æºƒ
```

**äººç±»ä¸»å¯¼æ–¹æ¡ˆ**:
1. **äººç±»è®¾è®¡è¿ç§»ç­–ç•¥**:
   ```sql
   -- Step 1: æ·»åŠ æ–°å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
   ALTER TABLE papers ADD COLUMN doi_normalized TEXT DEFAULT '';
   
   -- Step 2: åŒå†™æœŸï¼ˆæ—§å­—æ®µ+æ–°å­—æ®µåŒæ—¶ç»´æŠ¤ï¼‰
   -- Step 3: æ•°æ®è¿ç§»ï¼ˆåå°è„šæœ¬ï¼‰
   -- Step 4: å®¢æˆ·ç«¯å…¨éƒ¨åˆ‡æ¢åˆ°æ–°å­—æ®µ
   -- Step 5: åˆ é™¤æ—§å­—æ®µ
   ```

2. **AIåªç”Ÿæˆæ•°æ®è¿ç§»è„šæœ¬**:
   ```typescript
   // AIç”Ÿæˆä½†äººç±»å®¡æ ¸
   async function migrateDoiField() {
     const papers = await db.papers.findAll()
     for (const paper of papers) {
       paper.doi_normalized = normalizeDOI(paper.doi)
       await paper.save()
     }
   }
   ```

### ç¦åŒº3: è·¨ç«¯é€šä¿¡åè®® â›”

**ä¸ºä»€ä¹ˆ**: Zoteroæ’ä»¶ã€æµè§ˆå™¨æ‰©å±•ã€ç½‘ç«™ä¹‹é—´çš„æ¶ˆæ¯æ ¼å¼æ˜¯"åˆçº¦"

**ç°çŠ¶é—®é¢˜**:
```typescript
// zotero-plugin å‘é€æ¶ˆæ¯
window.parent.postMessage({
  type: 'AUTH_STATUS',
  user: { id, name, email } // â† å­—æ®µ
}, '*')

// ç½‘ç«™æ¥æ”¶æ¶ˆæ¯
window.addEventListener('message', (event) => {
  if (event.data.type === 'AUTH_STATUS') {
    const user = event.data.user // â† å‡è®¾å­—æ®µå­˜åœ¨
  }
})

// âŒ AIé‡æ„æ—¶æ”¹äº†å­—æ®µå
// type: 'AUTH_STATUS' â†’ 'auth_status' // â† ç½‘ç«™æ”¶ä¸åˆ°æ¶ˆæ¯
```

**äººç±»ä¸»å¯¼æ–¹æ¡ˆ**:
1. **å®šä¹‰TypeScriptç±»å‹**:
   ```typescript
   // packages/shared/src/types/messages.ts
   export interface AuthStatusMessage {
     type: 'AUTH_STATUS'; // â† å­—é¢é‡ç±»å‹ï¼Œä¸å…è®¸æ”¹
     user: { id: string; name: string; email: string };
   }
   ```

2. **AIåªèƒ½åœ¨ç±»å‹çº¦æŸä¸‹ä¿®æ”¹**:
   ```typescript
   // âœ… TypeScriptä¼šæŠ¥é”™ï¼ŒAIæ— æ³•ç ´ååè®®
   const message: AuthStatusMessage = {
     type: 'auth_status', // â† ç±»å‹é”™è¯¯ï¼
     user: { ... }
   }
   ```

---

## ğŸ“‹ AIé‡æ„çš„æ“ä½œæ‰‹å†Œ

### é˜¶æ®µ1: äººç±»å‡†å¤‡ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**:
- [ ] **ç¡®å®šé‡æ„èŒƒå›´**:
  ```markdown
  æœ¬æ¬¡é‡æ„: src/lib/database.ts (607è¡Œ)
  ç›®æ ‡: æ‹†åˆ†ä¸º4ä¸ªä»“å‚¨ç±» (Papers, Users, Comments, Ratings)
  å½±å“èŒƒå›´: src/app/api/**/*.ts (23ä¸ªAPIè·¯ç”±)
  é£é™©ç­‰çº§: ğŸ”´ é«˜å±ï¼ˆæ ¸å¿ƒæ•°æ®å±‚ï¼‰
  ```

- [ ] **å»ºç«‹æµ‹è¯•åŸºçº¿**:
  ```bash
  npm run test        # å½“å‰: 73 tests passing
  npm run test:e2e    # å½“å‰: 5/5 passing
  npm run build       # å½“å‰: âœ… æˆåŠŸ
  ```

- [ ] **åˆ›å»ºåŠŸèƒ½æ˜ å°„è¡¨**:
  ```markdown
  ## database.ts å‡½æ•°æ˜ å°„
  
  | å‡½æ•°å | æ–°ä½ç½® | ä¾èµ– | æµ‹è¯• |
  |--------|--------|------|------|
  | getPapers() | PapersRepository | supabase | âœ… |
  | createPaper() | PapersRepository | supabase | âœ… |
  | getPaperById() | PapersService | PapersRepo + RatingsRepo | âŒ å¾…å†™ |
  ```

### é˜¶æ®µ2: AIæ‰§è¡Œï¼ˆ3-5å¤©ï¼‰

**Daily å·¥ä½œæµ**:

#### æ¯æ—¥å¼€å§‹ (9:00-9:30)
```bash
# 1. äººç±»ç¡®å®šä»Šæ—¥ä»»åŠ¡
echo "ä»Šæ—¥ä»»åŠ¡: æ‹†åˆ†PapersRepository (é¢„è®¡150è¡Œï¼Œ5ä¸ªå‡½æ•°)"

# 2. åˆ›å»ºå·¥ä½œåˆ†æ”¯
git checkout -b refactor/papers-repo-day1

# 3. AIæ‰§è¡Œå‰çš„å¿«ç…§
npm run test > baseline.txt  # ä¿å­˜æµ‹è¯•åŸºçº¿
```

#### AIå¼€å‘æ—¶æ®µ (9:30-12:00)
```bash
# AIç”Ÿæˆä»£ç ...

# æ¯å®Œæˆ1ä¸ªå‡½æ•° = 1æ¬¡æäº¤
git add src/lib/repositories/PapersRepository.ts
git commit -m "refactor(db): æ·»åŠ PapersRepository.findById

- ä»database.tsè¿ç§»getPaperByIdé€»è¾‘
- æµ‹è¯•: test/repositories/papers.test.ts
- çŠ¶æ€: 75/73 tests passing (+2)"

# âœ… æ¯æ¬¡æäº¤åè¿è¡Œæµ‹è¯•
npm run test
```

#### äººç±»éªŒè¯ (12:00-13:00)
```bash
# 1. å¯¹æ¯”æµ‹è¯•ç»“æœ
npm run test > current.txt
diff baseline.txt current.txt

# 2. æ‰‹åŠ¨æµ‹è¯•æ ¸å¿ƒæµç¨‹
# - æ‰“å¼€ç½‘ç«™ â†’ é¦–é¡µåŠ è½½ â†’ ç‚¹å‡»è®ºæ–‡ â†’ æŸ¥çœ‹è¯¦æƒ…
# - Zoteroæ’ä»¶ â†’ ç™»å½• â†’ åˆ›å»ºä¼šè¯ â†’ ä¸Šä¼ æ ‡æ³¨

# 3. Code Reviewå…³é”®ç‚¹
# - æ˜¯å¦å¼•å…¥æ–°çš„å¤–éƒ¨ä¾èµ–ï¼Ÿ
# - é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ï¼Ÿ
# - ç±»å‹å®šä¹‰æ˜¯å¦å‡†ç¡®ï¼Ÿ
```

#### ä¸‹åˆè¿­ä»£ (14:00-17:00)
```bash
# æ ¹æ®éªŒè¯ç»“æœä¿®å¤
git add .
git commit -m "fix(db): ä¿®å¤PapersRepositoryç±»å‹å®šä¹‰"

# ç»§ç»­ä¸‹ä¸€ä¸ªå‡½æ•°...
```

#### æ¯æ—¥ç»“æŸ (17:00-17:30)
```bash
# 1. æ‰“tag
git tag -a refactor-day1 -m "Day 1: PapersRepositoryå®Œæˆ (5/18å‡½æ•°)"

# 2. æ›´æ–°è¿›åº¦æ–‡æ¡£
echo "## Day 1 (2025-11-18)
- âœ… PapersRepository: findById, findAll, create, update, delete
- âœ… æµ‹è¯•: 80/73 passing (+7)
- â­ï¸ æ˜å¤©: UsersRepository" >> progress.md

# 3. æ¨é€åˆ°è¿œç«¯ï¼ˆæœ¬åœ°ä¿ç•™ï¼‰
git push origin refactor/papers-repo-day1
```

### é˜¶æ®µ3: äººç±»é›†æˆï¼ˆ2å¤©ï¼‰

**ä»»åŠ¡**:
- [ ] **é›†æˆæµ‹è¯•**: æ‰€æœ‰ä»“å‚¨ç±»è”åˆæµ‹è¯•
- [ ] **æ€§èƒ½æµ‹è¯•**: æŸ¥è¯¢é€Ÿåº¦å¯¹æ¯”é‡æ„å‰å
- [ ] **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ARCHITECTURE.mdæ•°æ®åº“ç« èŠ‚
- [ ] **éƒ¨ç½²é¢„æ¼”**: åœ¨æµ‹è¯•ç¯å¢ƒè¿è¡Œ24å°æ—¶

---

## ğŸ“ AIé‡æ„çš„"ä½œæˆ˜åŸåˆ™"

### åŸåˆ™1: "èƒ½ä¸æ”¹å°±ä¸æ”¹"

**åä¾‹**: é‡æ„åä»103ä¸ªAPI â†’ 92ä¸ªAPI
- â“ 11ä¸ªç«¯ç‚¹å»å“ªäº†ï¼Ÿ
- â“ æ˜¯çœŸçš„åºŸå¼ƒè¿˜æ˜¯å¿˜è®°è¿ç§»ï¼Ÿ
- â“ å®¢æˆ·ç«¯ä¼šä¸ä¼šå´©æºƒï¼Ÿ

**æ­£ç¡®åšæ³•**:
```markdown
## APIæ¸…ç†å†³ç­–è®°å½•

### åˆ é™¤çš„ç«¯ç‚¹ (11ä¸ª)
| ç«¯ç‚¹ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ | å®¢æˆ·ç«¯å½±å“ |
|------|------|----------|------------|
| /api/test-cookie | æµ‹è¯•ç«¯ç‚¹ | æ—  | æ— ï¼ˆä»…å¼€å‘ï¼‰ |
| /api/v1/old-auth | å·²åºŸå¼ƒ6ä¸ªæœˆ | /api/v2/auth | å·²è¿ç§»âœ… |

### ä¿ç•™çš„ç«¯ç‚¹ (92ä¸ª)
| ç«¯ç‚¹ | ç”¨é€” | ä¾èµ– | æµ‹è¯• |
|------|------|------|------|
| /api/proxy/papers | Supabaseä»£ç† | æ’ä»¶+æ‰©å±• | âœ… |
```

### åŸåˆ™2: "æµ‹è¯•æ˜¯åˆçº¦"

**åä¾‹**: Phase 6åˆ é™¤Mockä½†æ²¡æœ‰çœŸå®æµ‹è¯•
```typescript
// âŒ åˆ é™¤Mockå
test('ç”¨æˆ·ç™»å½•', async () => {
  // æ²¡æœ‰æµ‹è¯• â†’ ä¸çŸ¥é“ç™»å½•æ˜¯å¦æ­£å¸¸
})
```

**æ­£ç¡®åšæ³•**:
```typescript
// âœ… å…ˆå†™é›†æˆæµ‹è¯•
test('ç”¨æˆ·ç™»å½• - çœŸå®Supabase', async () => {
  const response = await fetch('/api/auth/signin', {
    method: 'POST',
    body: JSON.stringify({ email: 'test@example.com', password: 'test123' })
  })
  expect(response.status).toBe(200)
  const data = await response.json()
  expect(data.user).toBeDefined()
})

// ç„¶åå†åˆ é™¤Mock
// - git commit "test: æ·»åŠ authé›†æˆæµ‹è¯•"
// - git commit "refactor: åˆ é™¤mockAuth.ts"
```

### åŸåˆ™3: "å°æ­¥å¿«è·‘ > å¤§æ­¥é£è·ƒ"

**æ—¶é—´å¯¹æ¯”**:

| ç­–ç•¥ | å•æ¬¡æ”¹åŠ¨ | æäº¤é¢‘ç‡ | æµ‹è¯•é¢‘ç‡ | é£é™© | æ€»è€—æ—¶ |
|------|----------|----------|----------|------|--------|
| **å¤§çˆ†ç‚¸å¼** | 5000è¡Œ | 1æ¬¡/å‘¨ | 1æ¬¡/å‘¨ | ğŸ”´ æé«˜ | 2å‘¨ï¼ˆå¤±è´¥ï¼‰+ 1å‘¨ï¼ˆå›æ»šï¼‰= **3å‘¨** |
| **å°æ­¥å¿«è·‘** | 300è¡Œ | 5æ¬¡/å¤© | 5æ¬¡/å¤© | ğŸŸ¢ ä½ | 2å‘¨ï¼ˆæˆåŠŸï¼‰= **2å‘¨** |

**å…³é”®æ•°æ®**:
- 300è¡Œæ”¹åŠ¨ â†’ å¹³å‡2ä¸ªBug
- 5000è¡Œæ”¹åŠ¨ â†’ å¹³å‡30ä¸ªBugï¼ˆä¸æ˜¯çº¿æ€§å¢é•¿ï¼ï¼‰
- æ¯ä¸ªBugä¿®å¤æ—¶é—´: 30åˆ†é’Ÿ~2å°æ—¶

**è®¡ç®—**:
```
å¤§çˆ†ç‚¸å¼:
  - ä»£ç æ—¶é—´: 5å¤©
  - Bugä¿®å¤: 30ä¸ª Ã— 1å°æ—¶ = 30å°æ—¶ = 4å¤©
  - é›†æˆè°ƒè¯•: 3å¤©
  - å›æ»šé‡æ¥: 1å‘¨
  æ€»è®¡ â‰ˆ 3å‘¨

å°æ­¥å¿«è·‘:
  - ä»£ç æ—¶é—´: 5å¤©
  - Bugä¿®å¤: 2ä¸ª/å¤© Ã— 0.5å°æ—¶ Ã— 10å¤© = 10å°æ—¶ = 1.5å¤©
  - é›†æˆè°ƒè¯•: 2å¤©
  æ€»è®¡ â‰ˆ 2å‘¨
```

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### é‡æ„å®Œæˆçš„éªŒæ”¶

| ç»´åº¦ | æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | éªŒæ”¶æ–¹å¼ |
|------|------|------|------|----------|
| **æµ‹è¯•è¦†ç›–ç‡** | % | 73 tests | â‰¥100 tests | `npm run test:coverage` |
| **æ„å»ºæˆåŠŸ** | Y/N | âœ… | âœ… | `npm run build` é›¶é”™è¯¯ |
| **æ–‡ä»¶è¡Œæ•°** | è¶…æ ‡æ–‡ä»¶ | 1ä¸ª | â‰¤3ä¸ª | `npm run check:size` |
| **APIç¨³å®šæ€§** | ç«¯ç‚¹æ•° | 92 | â‰¥100 | `npm run test:api` |
| **E2Eé€šè¿‡ç‡** | % | - | 100% | `npm run test:e2e` |
| **TypeScripté”™è¯¯** | ä¸ª | 0 | 0 | `tsc --noEmit` |
| **TODOæ¸…ç†** | ä¸ª | 21 | â‰¤5 | `grep -r "TODO" src/` |

### æ¯æ—¥è´¨é‡é—¨ç¦

```bash
# å¿…é¡»é€šè¿‡æ‰èƒ½ç»“æŸä¸€å¤©çš„å·¥ä½œ
npm run check:quality

# ç­‰ä»·äº:
npm run lint          # ESLinté€šè¿‡
npm run test          # æµ‹è¯•é€šè¿‡
npm run check:size    # æ–‡ä»¶å¤§å°åˆè§„
npm run build         # æ„å»ºæˆåŠŸ
```

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨

### æ˜å¤©å¼€å§‹çš„ç¬¬ä¸€ä¸ªä»»åŠ¡

**ä»»åŠ¡**: æ‹†åˆ† `src/lib/database.ts` (607è¡Œ) çš„Papersæ¨¡å—

**æ—¶é—´**: 1å¤©

**æ­¥éª¤**:
1. **9:00-9:30** - äººç±»å‡†å¤‡
   ```bash
   # åˆ›å»ºåˆ†æ”¯
   git checkout -b refactor/papers-repo
   
   # å†™æµ‹è¯•
   touch src/__tests__/repositories/papers.test.ts
   ```

2. **9:30-12:00** - AIæ‰§è¡Œ
   ```bash
   # AIç”ŸæˆPapersRepository.ts (150è¡Œ)
   # åŒ…å«: findById, findAll, findByDOI, create, update
   ```

3. **12:00-13:00** - äººç±»éªŒè¯
   ```bash
   npm run test  # æµ‹è¯•é€šè¿‡
   # æ‰‹åŠ¨æµ‹è¯•: æ‰“å¼€é¦–é¡µï¼Œç‚¹å‡»è®ºæ–‡ï¼ŒæŸ¥çœ‹è¯¦æƒ…
   ```

4. **14:00-17:00** - AIç»§ç»­
   ```bash
   # æ›´æ–°APIè·¯ç”±ä½¿ç”¨æ–°çš„PapersRepository
   # é€ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œæ¯æ”¹1ä¸ª = 1æ¬¡æäº¤
   ```

5. **17:00** - æäº¤
   ```bash
   git add .
   git commit -m "refactor(db): Papersæ¨¡å—é‡æ„å®Œæˆ

   - åˆ›å»ºPapersRepository (150è¡Œ)
   - æ›´æ–°10ä¸ªAPIè·¯ç”±
   - æµ‹è¯•: 85/73 passing (+12)
   - database.ts: 607 â†’ 450è¡Œ (-157)"
   
   git tag -a refactor-papers-done
   ```

---

## ğŸ’¡ ç»™AIçš„æç¤ºè¯æ¨¡æ¿

### æ¨¡æ¿1: æ‹†åˆ†æ•°æ®åº“å‡½æ•°
```
ä»»åŠ¡: å°† src/lib/database.ts çš„ getPapers() å‡½æ•°è¿ç§»åˆ° PapersRepository

è¦æ±‚:
1. åˆ›å»º src/lib/repositories/PapersRepository.ts
2. å®šä¹‰ class PapersRepository extends BaseRepository<Paper>
3. å®ç° async findAll(limit, offset): Promise<Paper[]>
4. ä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼ˆåŒ…æ‹¬é”™è¯¯å¤„ç†ï¼‰
5. æ·»åŠ å•å…ƒæµ‹è¯• src/__tests__/repositories/papers.test.ts

éªŒè¯:
- TypeScriptç¼–è¯‘é€šè¿‡
- æµ‹è¯•é€šè¿‡: npm run test
- åŸAPIè·¯ç”±æ­£å¸¸: curl http://localhost:3000/api/papers

ç¦æ­¢:
- âŒ ä¸è¦ä¿®æ”¹å…¶ä»–å‡½æ•°
- âŒ ä¸è¦æ”¹å˜è¿”å›å€¼ç±»å‹
- âŒ ä¸è¦æ·»åŠ æ–°çš„ä¾èµ–åŒ…
```

### æ¨¡æ¿2: ç»„ä»¶æ‹†åˆ†
```
ä»»åŠ¡: ä» src/app/profile/page.tsx (816è¡Œ) æ‹†åˆ†å‡º PersonalInfo ç»„ä»¶

è¦æ±‚:
1. åˆ›å»º src/components/profile/PersonalInfo.tsx
2. æå– "ä¸ªäººä¿¡æ¯ç¼–è¾‘" éƒ¨åˆ†ï¼ˆç¬¬50-130è¡Œï¼‰
3. Propsæ¥å£: { user: User; onUpdate: (user: User) => void }
4. ä¿æŒåŸæœ‰æ ·å¼ï¼ˆTailwind classesï¼‰
5. æ·»åŠ Storybook: src/components/profile/PersonalInfo.stories.tsx

éªŒè¯:
- Profileé¡µé¢æ­£å¸¸æ˜¾ç¤º
- ç¼–è¾‘åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- Storybookå¯é¢„è§ˆ: npm run storybook

ç¦æ­¢:
- âŒ ä¸è¦ä¿®æ”¹å…¶ä»–ç»„ä»¶
- âŒ ä¸è¦æ”¹å˜UIæ ·å¼
- âŒ ä¸è¦é‡å†™ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [7.4 é‡æ„å†³ç­–åˆ†æ](./7.4-REFACTORING_DECISION_ANALYSIS.md) - å¤±è´¥æ•™è®­
- [7.5 æ¸è¿›å¼é‡æ„è®¡åˆ’](./7.5-PROGRESSIVE_REFACTORING_PLAN.md) - æ‰§è¡Œè·¯çº¿
- [CODE_QUALITY_CHECKLIST](../CODE_QUALITY_CHECKLIST.md) - è´¨é‡æ ‡å‡†
- [ARCHITECTURE](../ARCHITECTURE.md) - æ¶æ„è®¾è®¡

---

**ç»´æŠ¤è€…**: Researchopia Team  
**æœ€åæ›´æ–°**: 2025-11-18  
**ä¸‹æ¬¡å®¡æŸ¥**: é‡æ„ç¬¬ä¸€é˜¶æ®µå®Œæˆå

---

## é™„å½•: AIå·¥å…·é…ç½®

### VS Code Claudeè®¾ç½®

```json
{
  "copilot.instructions": {
    "refactoring": {
      "maxLinesPerChange": 300,
      "requireTests": true,
      "commitFrequency": "per-function"
    }
  }
}
```

### æç¤ºè¯å¿«æ·é”®

```markdown
/refactor-function [æ–‡ä»¶è·¯å¾„] [å‡½æ•°å] - æ‹†åˆ†å•ä¸ªå‡½æ•°
/add-tests [æ–‡ä»¶è·¯å¾„] - ä¸ºæ¨¡å—æ·»åŠ æµ‹è¯•
/split-component [ç»„ä»¶è·¯å¾„] - æ‹†åˆ†UIç»„ä»¶
/check-deps [æ¨¡å—å] - æ£€æŸ¥ä¾èµ–å…³ç³»
```

---

**è®°ä½: AIæ˜¯å·¥å…·ï¼Œäººç±»æ˜¯å†³ç­–è€…ã€‚æµ‹è¯•æ˜¯å®‰å…¨ç½‘ï¼ŒGitæ˜¯æ—¶å…‰æœºã€‚ğŸš€**
