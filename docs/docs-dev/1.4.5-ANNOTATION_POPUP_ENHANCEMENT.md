# 1.4.5 annotation-popup å¢å¼º - å±•ç¤ºå…±äº«ä¿¡æ¯

**åˆ›å»ºæ—¥æœŸ**: 2025-11-19  
**ç›¸å…³ä»»åŠ¡**: annotation-popup å…±äº«æŒ‰é’®åŠŸèƒ½  
**ä¼˜å…ˆçº§**: P2  
**çŠ¶æ€**: ğŸ¤” å¾…è¯„ä¼°

---

## èƒŒæ™¯

å·²å®ç°åŠŸèƒ½:
- âœ… annotation-popup æ·»åŠ 4ä¸ªå…±äº«æŒ‰é’® (å…¬å¼€/åŒ¿å/ç§å¯†/å–æ¶ˆ)
- âœ… å…±äº«æ ‡æ³¨é¡µé¢ç‚¹å‡»å¡ç‰‡ â†’ PDFå±•ç¤ºæ ‡æ³¨ â†’ ä¸‹æ–¹å¼¹å‡º `researchopia-annotation-popup` (åŒ…å«ç”¨æˆ·åã€commentã€ç‚¹èµã€è¯„è®º)

å½“å‰é™åˆ¶:
- âŒ åŸç”Ÿ annotation-popup åªæ˜¾ç¤ºæ ‡æ³¨å†…å®¹å’Œcomment,æ— å…±äº«ä¿¡æ¯
- âŒ ç”¨æˆ·ç‚¹å‡»è‡ªå·±çš„å·²å…±äº«æ ‡æ³¨æ—¶,æ— æ³•çœ‹åˆ°ç‚¹èµ/è¯„è®ºæ•°æ®

---

## éœ€æ±‚

**ç›®æ ‡**: åœ¨åŸç”Ÿ annotation-popup ä¸‹æ–¹å±•ç¤ºå…±äº«ä¿¡æ¯ (å½“æ ‡æ³¨å·²å…±äº«æ—¶)

**å±•ç¤ºå†…å®¹**:
- ç”¨æˆ·å (å…¬å¼€æ¨¡å¼) / "åŒ¿åç”¨æˆ·" (åŒ¿åæ¨¡å¼)
- ç‚¹èµæ•°é‡
- è¯„è®ºåˆ—è¡¨ (å¸¦å›å¤æ ‘ç»“æ„)

**è§¦å‘æ¡ä»¶**:
- ç”¨æˆ·ç‚¹å‡»**è‡ªå·±çš„å·²å…±äº«æ ‡æ³¨** (private/public/anonymous)
- æŸ¥è¯¢ Supabase ç¡®è®¤è¯¥æ ‡æ³¨å·²å…±äº«

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ‰©å±•ç°æœ‰æ³¨å…¥é€»è¾‘ (æ¨è â­)

**ä½ç½®**: `annotationSharingPopup.ts` â†’ `injectButtonsToAnnotationPopup()`

**å®ç°æ­¥éª¤**:
1. åœ¨æ³¨å…¥å…±äº«æŒ‰é’®å,æŸ¥è¯¢æ ‡æ³¨çš„å…±äº«çŠ¶æ€
2. å¦‚æœå·²å…±äº« (`existingAnnotation !== null`),ç»§ç»­æŸ¥è¯¢:
   - ç‚¹èµæ•°æ®: `supabaseManager.getAnnotationLikes(annotationId)`
   - è¯„è®ºæ•°æ®: `supabaseManager.getAnnotationCommentTree(annotationId)`
3. åˆ›å»ºä¿¡æ¯å±•ç¤ºåŒºåŸŸ (å¤ç”¨ `PDFReaderCoordinator.ts` çš„æ¸²æŸ“é€»è¾‘)

**ä»£ç ç»“æ„**:
```typescript
// annotationSharingPopup.ts Line ~750
(async () => {
  // 1. æŸ¥è¯¢çŠ¶æ€ (å·²æœ‰)
  const existingAnnotation = /* ... */;
  
  if (existingAnnotation) {
    // 2. æ›´æ–°æŒ‰é’®é«˜äº® (å·²æœ‰)
    // ...
    
    // 3. ğŸ†• å±•ç¤ºå…±äº«ä¿¡æ¯
    const infoContainer = this.createSharedInfoContainer(
      doc, 
      existingAnnotation, 
      buttonContainer
    );
    
    // 4. å¼‚æ­¥åŠ è½½ç‚¹èµ/è¯„è®º
    this.loadSharedInfo(existingAnnotation.id, infoContainer, doc);
  }
})();
```

**ä¼˜ç‚¹**:
- âœ… å¤ç”¨ç°æœ‰pollingæœºåˆ¶,æ— éœ€é¢å¤–ç›‘å¬
- âœ… é€»è¾‘é›†ä¸­åœ¨ `annotationSharingPopup.ts`
- âœ… ä¸å…±äº«æŒ‰é’®ä½ç½®æ¥è¿‘,UIä¸€è‡´

**ç¼ºç‚¹**:
- âš ï¸ æ¯æ¬¡æ‰“å¼€popupéƒ½éœ€æŸ¥è¯¢ (å·²æœ‰ç¼“å­˜ä¼˜åŒ–,å½±å“å°)
- âš ï¸ éœ€è¦å¤ç”¨ `PDFReaderCoordinator` çš„è¯„è®ºæ¸²æŸ“å‡½æ•° (æˆ–æå–å…¬å…±æ–¹æ³•)

---

### æ–¹æ¡ˆ2: æ‰©å±• Zotero åŸç”Ÿ popup (ä¸æ¨è âŒ)

**ä½ç½®**: ç›‘å¬ Zotero Reader çš„ popup åˆ›å»ºäº‹ä»¶ (æ— å®˜æ–¹API)

**é—®é¢˜**:
- âŒ Zotero æ—  `renderAnnotationPopup` äº‹ä»¶
- âŒ éœ€è¦hack Zoteroå†…éƒ¨ä»£ç ,ç»´æŠ¤æˆæœ¬é«˜
- âŒ Zoteroæ›´æ–°å¯èƒ½ç ´ååŠŸèƒ½

---

### æ–¹æ¡ˆ3: åˆ›å»ºç‹¬ç«‹å¼¹çª— (å¤‡é€‰)

**ä½ç½®**: åœ¨ annotation-popup æ—è¾¹/ä¸Šæ–¹åˆ›å»ºæ–°çš„æµ®çª—

**é—®é¢˜**:
- âš ï¸ ä¸¤ä¸ªå¼¹çª—å¹¶å­˜,UIæ··ä¹±
- âš ï¸ ä½ç½®è®¡ç®—å¤æ‚ (éœ€é€‚é…ä¸åŒå±å¹•å°ºå¯¸)
- âš ï¸ å…³é—­é€»è¾‘éœ€è¦åŒæ­¥

---

## æ¨èå®ç° (æ–¹æ¡ˆ1 è¯¦ç»†è®¾è®¡)

### 1. UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [comment content]              â”‚ â† Zotero åŸç”Ÿ popup
â”‚ [toolbar icons]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒå…¬å¼€  ğŸ­åŒ¿å  ğŸ”’ç§å¯†  ğŸ—‘ï¸å–æ¶ˆ â”‚ â† å·²å®ç° (4ä¸ªæŒ‰é’®)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ ç”¨æˆ·å                       â”‚ â† ğŸ†• æ–°å¢åŒºåŸŸ
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚ ğŸ‘ ç‚¹èµ (5)                     â”‚
â”‚ ğŸ’¬ ç”¨æˆ·è¯„è®º (3)                 â”‚
â”‚   - Alice: å¾ˆæœ‰è§åœ°...         â”‚
â”‚     â”” Bob: èµåŒ+1              â”‚
â”‚   - Charlie: è¡¥å……è¯´æ˜...       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ·å¼ç‰¹å¾**:
- ç°è‰²åˆ†éš”çº¿ (ä¸ `researchopia-annotation-popup` ä¿æŒä¸€è‡´)
- å­—ä½“ 11px,è¡Œé«˜ 1.4
- æœ€å¤§é«˜åº¦ 200px,è¶…å‡ºæ»šåŠ¨
- æ·¡é»„èƒŒæ™¯ (commentåŒºåŸŸ)

---

### 2. å…³é”®ä»£ç ä½ç½®

**æ–°å¢æ–¹æ³•** (åœ¨ `annotationSharingPopup.ts` ä¸­):

```typescript
/**
 * åˆ›å»ºå…±äº«ä¿¡æ¯å®¹å™¨
 */
private createSharedInfoContainer(
  doc: Document,
  annotation: any,
  afterElement: HTMLElement
): HTMLElement {
  const container = doc.createElement('div');
  container.id = 'researchopia-shared-info';
  container.style.cssText = `
    padding-top: 8px;
    border-top: 1px solid #e0e0e0;
    margin-top: 8px;
  `;
  
  // ç”¨æˆ·å
  const username = annotation.show_author_name 
    ? (annotation.username || 'æœªçŸ¥ç”¨æˆ·') 
    : 'åŒ¿åç”¨æˆ·';
  const authorDiv = doc.createElement('div');
  authorDiv.textContent = `ğŸ‘¤ ${username}`;
  authorDiv.style.cssText = `
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 11px;
  `;
  container.appendChild(authorDiv);
  
  // å ä½ç¬¦ (ç‚¹èµ/è¯„è®ºå¼‚æ­¥åŠ è½½)
  const loadingDiv = doc.createElement('div');
  loadingDiv.textContent = 'åŠ è½½ä¸­...';
  loadingDiv.style.color = '#999';
  loadingDiv.style.fontSize = '11px';
  container.appendChild(loadingDiv);
  
  afterElement.parentElement?.appendChild(container);
  return container;
}

/**
 * å¼‚æ­¥åŠ è½½ç‚¹èµ/è¯„è®ºæ•°æ®
 */
private async loadSharedInfo(
  annotationId: string,
  container: HTMLElement,
  doc: Document
): Promise<void> {
  try {
    const supabaseManager = (this.annotationManager as any).supabaseManager;
    
    // å¹¶è¡ŒæŸ¥è¯¢ç‚¹èµå’Œè¯„è®º
    const [likes, comments] = await Promise.all([
      supabaseManager.getAnnotationLikes(annotationId),
      supabaseManager.getAnnotationCommentTree(annotationId)
    ]);
    
    // æ¸…ç©ºå ä½ç¬¦
    container.innerHTML = '';
    
    // æ¸²æŸ“ç‚¹èµæ•°
    const likesDiv = doc.createElement('div');
    likesDiv.textContent = `ğŸ‘ ç‚¹èµ (${likes?.length || 0})`;
    likesDiv.style.cssText = `
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    `;
    container.appendChild(likesDiv);
    
    // æ¸²æŸ“è¯„è®º
    const commentsTitle = doc.createElement('div');
    commentsTitle.textContent = `ğŸ’¬ ç”¨æˆ·è¯„è®º (${this.countComments(comments)})`;
    commentsTitle.style.cssText = `
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 600;
    `;
    container.appendChild(commentsTitle);
    
    if (comments && comments.length > 0) {
      // å¤ç”¨ PDFReaderCoordinator çš„è¯„è®ºæ¸²æŸ“é€»è¾‘
      const { PDFReaderCoordinator } = await import('./pdf/PDFReaderCoordinator');
      PDFReaderCoordinator.renderCommentList(comments, container, doc);
    } else {
      const noCommentDiv = doc.createElement('div');
      noCommentDiv.textContent = 'æš‚æ— è¯„è®º';
      noCommentDiv.style.cssText = `
        color: #999;
        font-size: 11px;
        text-align: center;
        padding: 8px;
      `;
      container.appendChild(noCommentDiv);
    }
  } catch (error) {
    logger.error('[AnnotationSharingPopup] Error loading shared info:', error);
  }
}
```

---

### 3. ä»£ç å¤ç”¨

**æå–å…¬å…±æ–¹æ³•** (å»ºè®®åœ¨ `ui-utils.ts` ä¸­):

```typescript
/**
 * è¯„è®ºæ¸²æŸ“å·¥å…· (ä» PDFReaderCoordinator æå–)
 */
export class CommentRenderer {
  static renderCommentList(
    comments: any[],
    container: HTMLElement,
    doc: Document,
    maxDepth: number = 2
  ): void {
    // å¤ç”¨ç°æœ‰é€»è¾‘ (Line 600-700)
  }
  
  static countComments(comments: any[]): number {
    // é€’å½’è®¡ç®—æ€»è¯„è®ºæ•°
  }
}
```

**è°ƒç”¨æ–¹**:
- `annotationSharingPopup.ts` â†’ åœ¨ annotation-popup ä¸‹æ–¹å±•ç¤º
- `PDFReaderCoordinator.ts` â†’ åœ¨ researchopia-annotation-popup ä¸­å±•ç¤º

---

## æ€§èƒ½è€ƒè™‘

**ä¼˜åŒ–æªæ–½**:
1. **ç¼“å­˜æŸ¥è¯¢ç»“æœ** (5ç§’å†…é‡å¤æ‰“å¼€åŒä¸€æ ‡æ³¨ä¸é‡æ–°æŸ¥è¯¢)
2. **åˆ†æ‰¹åŠ è½½**: å…ˆæ˜¾ç¤ºç”¨æˆ·å â†’ 1ç§’ååŠ è½½ç‚¹èµ â†’ 2ç§’ååŠ è½½è¯„è®º
3. **æœ€å¤§è¯„è®ºæ•°**: åªå±•ç¤ºå‰10æ¡ (è¶…å‡ºæ˜¾ç¤º"æŸ¥çœ‹æ›´å¤š...")

**é¢„æœŸæ€§èƒ½**:
- åˆæ¬¡æ‰“å¼€å»¶è¿Ÿ: ~500ms (æŸ¥è¯¢annotation) + ~300ms (æŸ¥è¯¢ç‚¹èµ/è¯„è®º)
- ç¼“å­˜å‘½ä¸­å»¶è¿Ÿ: <50ms

---

## é£é™©ä¸é™åˆ¶

### æŠ€æœ¯é£é™©

1. **Zotero popupå…³é—­äº‹ä»¶**
   - é—®é¢˜: ç”¨æˆ·ç§»å¼€é¼ æ ‡,popupè‡ªåŠ¨å…³é—­,ä½†æˆ‘ä»¬çš„å¼‚æ­¥æŸ¥è¯¢ä»åœ¨è¿›è¡Œ
   - è§£å†³: ç›‘å¬popup removal,ä¸­æ­¢pendingè¯·æ±‚ (AbortController)

2. **DOMç»“æ„å˜åŒ–**
   - é—®é¢˜: Zoteroæ›´æ–°å¯èƒ½æ”¹å˜ `.annotation-popup` ç»“æ„
   - è§£å†³: ä½¿ç”¨çµæ´»çš„é€‰æ‹©å™¨ + é™çº§å¤„ç† (æ‰¾ä¸åˆ°å®¹å™¨åˆ™è·³è¿‡æ³¨å…¥)

### ç”¨æˆ·ä½“éªŒé™åˆ¶

1. **ç§å¯†æ ‡æ³¨æ— æ„ä¹‰**
   - ç§å¯†æ ‡æ³¨åªæœ‰è‡ªå·±å¯è§,ç‚¹èµ/è¯„è®ºä¸ºç©º
   - è§£å†³: ä»…åœ¨ `public/anonymous` æ¨¡å¼ä¸‹å±•ç¤ºç¤¾äº¤ä¿¡æ¯,`private` åªæ˜¾ç¤ºç”¨æˆ·å

2. **è¯„è®ºåŒºåŸŸè¿‡é•¿**
   - è¶…è¿‡10æ¡è¯„è®ºä¼šå¯¼è‡´popupè¿‡é«˜
   - è§£å†³: é™åˆ¶æœ€å¤§é«˜åº¦ 200px + æ»šåŠ¨æ¡

---

## å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€å±•ç¤º (1-2å¤©)
- [ ] æå– `CommentRenderer` å…¬å…±ç±»
- [ ] åœ¨ `injectButtonsToAnnotationPopup` ä¸­æ·»åŠ ä¿¡æ¯å®¹å™¨
- [ ] æŸ¥è¯¢å¹¶æ˜¾ç¤ºç”¨æˆ·å
- [ ] æŸ¥è¯¢å¹¶æ˜¾ç¤ºç‚¹èµæ•°

### Phase 2: è¯„è®ºæ¸²æŸ“ (1å¤©)
- [ ] é›†æˆè¯„è®ºæŸ¥è¯¢
- [ ] å¤ç”¨è¯„è®ºæ ‘æ¸²æŸ“é€»è¾‘
- [ ] æµ‹è¯•å¤šå±‚åµŒå¥—å›å¤

### Phase 3: æ€§èƒ½ä¼˜åŒ– (1å¤©)
- [ ] æ·»åŠ æŸ¥è¯¢ç»“æœç¼“å­˜
- [ ] å®ç°åˆ†æ‰¹åŠ è½½
- [ ] æ·»åŠ åŠ è½½çŠ¶æ€åŠ¨ç”»

### Phase 4: è¾¹ç¼˜æƒ…å†µå¤„ç† (0.5å¤©)
- [ ] å¤„ç†Zotero popupå…³é—­äº‹ä»¶
- [ ] é™çº§å¤„ç† (APIå¤±è´¥ã€ç½‘ç»œè¶…æ—¶)
- [ ] æ·»åŠ é”™è¯¯æç¤º

**æ€»è®¡**: ~3.5-4.5å¤©

---

## å¾…å†³ç­–

1. **æ˜¯å¦å±•ç¤ºç§å¯†æ ‡æ³¨çš„ç¤¾äº¤ä¿¡æ¯?**
   - é€‰é¡¹A: ä¸å±•ç¤º (å› ä¸ºåªæœ‰è‡ªå·±å¯è§)
   - é€‰é¡¹B: å±•ç¤º"ä»…è‡ªå·±å¯è§"æç¤º

2. **è¯„è®ºæ•°é‡é™åˆ¶?**
   - å½“å‰å»ºè®®: å±•ç¤ºå‰10æ¡ + "æŸ¥çœ‹æ›´å¤š"é“¾æ¥ (è·³è½¬åˆ°å…±äº«æ ‡æ³¨é¡µé¢)

3. **ç‚¹èµ/è¯„è®ºæŒ‰é’®?**
   - é€‰é¡¹A: åªå±•ç¤ºæ•°æ®,ä¸æä¾›äº¤äº’ (ç®€å•)
   - é€‰é¡¹B: æ·»åŠ ç‚¹èµ/è¯„è®ºæŒ‰é’® (å¤æ‚,éœ€è¦è¡¨å•)

---

## å‚è€ƒèµ„æ–™

- **ç°æœ‰å®ç°**: `zotero-plugin/src/modules/pdf/PDFReaderCoordinator.ts` Line 486-650
- **å…±äº«æŒ‰é’®æ³¨å…¥**: `zotero-plugin/src/modules/annotationSharingPopup.ts` Line 590-750
- **è¯„è®ºAPI**: `zotero-plugin/src/modules/supabase.ts` Line 781 (`getAnnotationCommentTree`)
- **ç‚¹èµAPI**: `zotero-plugin/src/modules/supabase.ts` Line 455 (`getAnnotationLikes`)

---

**ç»“è®º**: æ–¹æ¡ˆ1 (æ‰©å±•ç°æœ‰æ³¨å…¥é€»è¾‘) æœ€å¯è¡Œ,é¢„è®¡å¼€å‘å‘¨æœŸ 3.5-4.5å¤©,ç”¨æˆ·ä½“éªŒæå‡æ˜æ˜¾ã€‚
