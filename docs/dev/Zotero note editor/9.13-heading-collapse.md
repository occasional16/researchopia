# 9.13 标题折叠功能

## 需求
在 Zotero note 中实现标题（H1-H3）内容折叠/展开功能，支持真正的视觉折叠（内容高度折叠，后续内容上移）。

## 技术分析

### Zotero Note 编辑器结构
- 基于 ProseMirror 富文本编辑器
- 标题元素: `<h1>`, `<h2>`, `<h3>` (对应 Heading 1-3)
- 编辑器容器: `.editor-core` (在 iframe 内)
- **关键约束**: ProseMirror 的 `EditorView.updateState()` 会重新渲染 DOM，覆盖任何直接的样式修改

### 实现方案演进

#### ❌ 失败方案 1：直接 DOM 样式修改
- 尝试: 通过 `element.style.display = 'none'` 隐藏内容
- 问题: ProseMirror 每次更新状态时重建 DOM，覆盖所有样式更改

#### ❌ 失败方案 2：按钮注入到 ProseMirror 内部
- 尝试: 在标题元素旁直接注入折叠按钮
- 问题: 按钮变成可编辑内容，用户可删除

#### ❌ 失败方案 3：覆盖层遮挡
- 尝试: 使用白色矩形覆盖折叠内容
- 问题: 仅视觉遮挡，内容仍占据空间，无法实现真正折叠

#### ✅ 成功方案：动态 CSS + nth-child 选择器
- 策略: 不直接修改 DOM，而是动态生成 CSS 规则
- 原理: CSS 规则不受 ProseMirror DOM 重建影响
- 实现: 根据折叠状态动态生成 `:nth-child(n)` 选择器

### 折叠逻辑
```
H1 "Chapter 1"     ← 点击折叠
  内容...          ← 隐藏 (display: none)
  H2 "Section"     ← 隐藏
    内容...        ← 隐藏
H1 "Chapter 2"     ← 不隐藏（同级或更高级标题）
```

### 兼容性
- ✅ Item Pane (main window)
- ✅ Edit in Separate Window (zotero:note)
- ✅ Better Notes (betternotes workspace)

## 实现架构

### 文件位置
`zotero-plugin/src/modules/noteEditor/enhancements/headingCollapse.ts`

### 核心组件

#### 1. 按钮容器 (position: fixed)
```typescript
// 容器放在 iframe body 中，editor-core 外部
const container = doc.createElement('div');
container.id = 'heading-collapse-container';
container.className = 'heading-collapse-container';
doc.body.appendChild(container);
```

#### 2. 滚动事件监听
```typescript
// 使用 requestAnimationFrame 优化性能
const scrollHandler = () => {
  if (rafId !== null) {
    iframeWindow.cancelAnimationFrame(rafId);
  }
  rafId = iframeWindow.requestAnimationFrame(() => {
    this.updateButtonPositions(noteEditor, doc);
  });
};
editorCore.addEventListener('scroll', scrollHandler, { passive: true });
```

#### 3. 动态 CSS 生成 (核心)
```typescript
private updateCollapseCSS(doc: Document, proseMirror: HTMLElement, itemID: number): void {
  let dynamicStyle = doc.getElementById('heading-collapse-dynamic-styles');
  if (!dynamicStyle) {
    dynamicStyle = doc.createElement('style');
    dynamicStyle.id = 'heading-collapse-dynamic-styles';
    doc.head.appendChild(dynamicStyle);
  }
  
  // 为每个折叠的标题生成 CSS 规则
  const cssRules: string[] = [];
  collapsedIndices.forEach(headingIndex => {
    // 计算需要隐藏的子元素范围
    for (let i = headingChildIndex + 1; i < endChildIndex; i++) {
      const childIndex = i + 1; // nth-child 从 1 开始
      cssRules.push(
        `.ProseMirror.primary-editor > :nth-child(${childIndex}) {
          display: none !important;
        }`
      );
    }
  });
  
  dynamicStyle.textContent = cssRules.join('\n');
}
```

#### 4. 状态持久化
```typescript
// 按 itemID 存储折叠状态
const collapseStates = new Map<number, Set<number>>();
// itemID -> Set<折叠的标题索引>
```

### 生命周期

1. **初始化**: `initHeadingCollapseSystem()` → 启动窗口扫描
2. **窗口扫描**: 每 500ms 扫描所有窗口的 `note-editor` 元素
3. **编辑器设置**: 注入样式、创建按钮容器、绑定滚动事件
4. **按钮更新**: 滚动时更新按钮位置，检测标题数量变化
5. **折叠切换**: 点击按钮 → 更新状态 → 重新生成 CSS
6. **清理**: `destroyHeadingCollapseSystem()` → 停止扫描、清理状态

## API

```typescript
// 初始化
import { initHeadingCollapseSystem } from './enhancements/headingCollapse';
initHeadingCollapseSystem();

// 销毁
import { destroyHeadingCollapseSystem } from './enhancements/headingCollapse';
destroyHeadingCollapseSystem();
```

## 已知限制

1. **状态不跨会话持久化**: 折叠状态仅在内存中保存，关闭 Zotero 后丢失
2. **编辑可能影响索引**: 添加/删除标题可能导致折叠状态错位（自动重新计算按钮）

## 相关模块

- `scrollPreserver.ts`: 共享窗口扫描机制
- `lineNumbers.ts`: 同为 noteEditor 增强功能
- `hooks.ts`: 负责初始化和销毁调用
