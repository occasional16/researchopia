# 10.3 çŸ¥è¯†ç½‘ MVP v2 | Knowledge Web MVP v2

**æ•´åˆæ·±åº¦åé¦ˆåŽçš„åŠ¡å®žMVPè§„èŒƒ**

---

## ä¸€ã€MVP åŽŸåˆ™

> **ä¸¥è°¨ vs é€Ÿåº¦**: å…ˆå…è®¸è½¯å…³è”(æ ‡æ³¨"å¾…è¯æ®")ï¼Œè¯æ®åˆ°ä½åŽå‡çº§ä¸ºå¼ºå…³è”
> **è‡ªåŠ¨ vs äººå·¥**: è‡ªåŠ¨æå–åš"å»ºè®®è¾¹"ï¼Œäººå·¥ç¡®è®¤ç”Ÿæˆ"æ­£å¼è¾¹"
> **å…¬å¼€ vs ç§å¯†**: é»˜è®¤ç§å¯†ï¼Œé€æ¡é€‰æ‹©å…¬å¼€

---

## äºŒã€åŠŸèƒ½èŒƒå›´

### 2.1 Must Have (4-6å‘¨)

| åŠŸèƒ½ | å…¥å£ | è¯´æ˜Ž |
|------|------|------|
| **ç½‘é¡µé‡‡é›†** | æ‰©å±• | URLè§„èŒƒåŒ–(å‰”é™¤utm)ã€DOIæ£€æµ‹ã€å¿«ç…§æŒ‡é’ˆ |
| **æ–‡çŒ®é‡‡é›†** | æ‰©å±•+ç½‘ç«™ | DOI/ISBNè§£æžã€å…ƒæ•°æ®èŽ·å– |
| **ç±»åž‹åŒ–åŒé“¾** | ç½‘ç«™ | 5ç§åŸºç¡€ç±»åž‹ + è¯æ®ç‰‡æ®µ(å¯é€‰) |
| **æ ‡ç­¾+é›†åˆ** | ç½‘ç«™ | æ ‡ç­¾(è¯­ä¹‰)ã€é›†åˆ(ç­–å±•)åˆ†ç¦» |
| **ä¸ªäººçŸ¥è¯†æµ** | ç½‘ç«™ | æ—¶é—´çº¿ + æ ‡ç­¾è¿‡æ»¤ |
| **ç¬”è®°åŒº** | ç½‘ç«™ | é«˜äº® + è¯„è®º (åŸºç¡€ç‰ˆ) |

### 2.2 Defer (Phase 2+)

- âŒ å›¾è§†å›¾å¯è§†åŒ–
- âŒ å…¨å±€çŸ¥è¯†æµ/æŽ¨èç®—æ³•
- âŒ OpenAlex/CrossRefé›†æˆ
- âŒ ZoteroåŒå‘åŒæ­¥
- âŒ ä½œå“æ—å½’å¹¶
- âŒ å¿«ç…§WARCå­˜å‚¨

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨

```sql
-- çŸ¥è¯†å•å…ƒ (ç®€åŒ–ç‰ˆ)
CREATE TABLE knowledge_units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL CHECK (type IN ('webpage', 'paper', 'book', 'video')),
  -- æ ‡è¯†
  url TEXT,                      -- è§„èŒƒåŒ–URL
  doi TEXT,
  isbn TEXT,
  -- åŸºç¡€ä¿¡æ¯
  title TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',   -- authors, abstract, sourceç­‰
  -- æƒé™
  user_id UUID REFERENCES auth.users(id),
  visibility TEXT DEFAULT 'private' CHECK (visibility IN ('private', 'public')),
  -- æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  -- çº¦æŸ
  UNIQUE(user_id, type, COALESCE(url, ''), COALESCE(doi, ''))
);

-- ç±»åž‹åŒ–åŒé“¾
CREATE TABLE knowledge_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_id UUID REFERENCES knowledge_units(id) ON DELETE CASCADE,
  target_id UUID REFERENCES knowledge_units(id) ON DELETE CASCADE,
  -- ç±»åž‹åŒ–
  link_type TEXT DEFAULT 'related' CHECK (link_type IN (
    'cite', 'respond', 'review', 'derive', 'related'
  )),
  -- è¯æ® (å¯é€‰)
  evidence_text TEXT,            -- å¼•æ–‡ç‰‡æ®µ
  evidence_page INTEGER,         -- é¡µç 
  -- å…ƒæ•°æ®
  is_verified BOOLEAN DEFAULT false,
  confidence FLOAT DEFAULT 0.5,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  -- çº¦æŸ
  UNIQUE(source_id, target_id, link_type)
);

-- æ ‡ç­¾
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  visibility TEXT DEFAULT 'private',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, name)
);

CREATE TABLE unit_tags (
  unit_id UUID REFERENCES knowledge_units(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  PRIMARY KEY(unit_id, tag_id)
);

-- é›†åˆ (ç­–å±•)
CREATE TABLE collections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  user_id UUID REFERENCES auth.users(id),
  visibility TEXT DEFAULT 'private',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE collection_units (
  collection_id UUID REFERENCES collections(id) ON DELETE CASCADE,
  unit_id UUID REFERENCES knowledge_units(id) ON DELETE CASCADE,
  position INTEGER DEFAULT 0,
  added_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY(collection_id, unit_id)
);

-- ç¬”è®°
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  unit_id UUID REFERENCES knowledge_units(id) ON DELETE CASCADE,
  note_type TEXT DEFAULT 'comment' CHECK (note_type IN ('highlight', 'comment')),
  text_excerpt TEXT,             -- é«˜äº®åŽŸæ–‡
  content TEXT,                  -- ç¬”è®°å†…å®¹
  user_id UUID REFERENCES auth.users(id),
  visibility TEXT DEFAULT 'private',
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 ç´¢å¼•

```sql
CREATE INDEX idx_units_user ON knowledge_units(user_id);
CREATE INDEX idx_units_type ON knowledge_units(type);
CREATE INDEX idx_units_url ON knowledge_units(url);
CREATE INDEX idx_units_doi ON knowledge_units(doi);
CREATE INDEX idx_units_created ON knowledge_units(created_at DESC);
CREATE INDEX idx_links_source ON knowledge_links(source_id);
CREATE INDEX idx_links_target ON knowledge_links(target_id);
CREATE INDEX idx_notes_unit ON notes(unit_id);
```

### 3.3 RLS

```sql
-- çŸ¥è¯†å•å…ƒ
ALTER TABLE knowledge_units ENABLE ROW LEVEL SECURITY;
CREATE POLICY "units_read" ON knowledge_units FOR SELECT USING (
  visibility = 'public' OR user_id = auth.uid()
);
CREATE POLICY "units_write" ON knowledge_units FOR ALL USING (user_id = auth.uid());

-- åŒé“¾ (è·ŸéšèŠ‚ç‚¹æƒé™)
ALTER TABLE knowledge_links ENABLE ROW LEVEL SECURITY;
CREATE POLICY "links_read" ON knowledge_links FOR SELECT USING (
  EXISTS (SELECT 1 FROM knowledge_units WHERE id = source_id AND (visibility = 'public' OR user_id = auth.uid()))
);
CREATE POLICY "links_write" ON knowledge_links FOR ALL USING (created_by = auth.uid());
```

---

## å››ã€API ç«¯ç‚¹

### 4.1 çŸ¥è¯†å•å…ƒ

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ |
|------|------|------|
| POST | `/api/kn/units` | åˆ›å»ºçŸ¥è¯†å•å…ƒ |
| GET | `/api/kn/units` | åˆ—è¡¨ (æ”¯æŒtype/tagè¿‡æ»¤) |
| GET | `/api/kn/units/[id]` | è¯¦æƒ… + å…³è”è¾¹ + ç¬”è®° |
| PATCH | `/api/kn/units/[id]` | æ›´æ–° |
| DELETE | `/api/kn/units/[id]` | åˆ é™¤ |

### 4.2 åŒé“¾

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ |
|------|------|------|
| POST | `/api/kn/links` | åˆ›å»ºåŒé“¾ |
| GET | `/api/kn/links?unit_id=` | èŽ·å–å•å…ƒçš„æ‰€æœ‰å…³è” |
| PATCH | `/api/kn/links/[id]` | æ›´æ–°(æ·»åŠ è¯æ®/ç¡®è®¤) |
| DELETE | `/api/kn/links/[id]` | åˆ é™¤ |

### 4.3 æ ‡ç­¾+é›†åˆ+ç¬”è®°

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ |
|------|------|------|
| POST/GET | `/api/kn/tags` | æ ‡ç­¾CRUD |
| POST/GET | `/api/kn/collections` | é›†åˆCRUD |
| POST/GET | `/api/kn/notes` | ç¬”è®°CRUD |

---

## äº”ã€æµè§ˆå™¨æ‰©å±•æ”¹é€ 

### 5.1 é‡‡é›†æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»æ‰©å±•å›¾æ ‡
2. è‡ªåŠ¨è§£æž: URLè§„èŒƒåŒ– + DOIæ£€æµ‹ + æ ‡é¢˜æŠ“å–
3. ç”¨æˆ·é€‰æ‹©: ç±»åž‹ + æ ‡ç­¾ + é›†åˆ + å¯è§æ€§
4. å¯é€‰: å¿«é€Ÿå»ºç«‹åŒé“¾(æœç´¢å·²æœ‰å•å…ƒ)
5. ä¿å­˜åˆ°æœåŠ¡å™¨
```

### 5.2 URLè§„èŒƒåŒ–è§„åˆ™

```javascript
function normalizeUrl(url) {
  const urlObj = new URL(url);
  // å‰”é™¤è¿½è¸ªå‚æ•°
  ['utm_source', 'utm_medium', 'utm_campaign', 'fbclid', 'gclid'].forEach(p => {
    urlObj.searchParams.delete(p);
  });
  // ç§»é™¤ä¼šè¯å‚æ•°
  urlObj.searchParams.delete('sessionid');
  // ç»Ÿä¸€åè®®
  urlObj.protocol = 'https:';
  return urlObj.toString();
}
```

### 5.3 UI åŽŸåž‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â­ ä¿å­˜çŸ¥è¯†å•å…ƒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç±»åž‹: â—‹ç½‘é¡µ â—‹è®ºæ–‡ â—‹å›¾ä¹¦ â—‹è§†é¢‘       â”‚
â”‚ æ ‡é¢˜: [è‡ªåŠ¨å¡«å……ï¼Œå¯ç¼–è¾‘]             â”‚
â”‚ URL:  [è§„èŒƒåŒ–åŽæ˜¾ç¤º]                â”‚
â”‚ DOI:  [è‡ªåŠ¨æ£€æµ‹ / æ‰‹åŠ¨è¾“å…¥]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ‡ç­¾: [+æ·»åŠ æ ‡ç­¾...]                â”‚
â”‚ é›†åˆ: [é€‰æ‹©é›†åˆ â–¼]                  â”‚
â”‚ å¯è§: â—‹ç§å¯† â—‹å…¬å¼€                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ”— å…³è” (å¯é€‰)                      â”‚
â”‚ [æœç´¢å·²æœ‰çŸ¥è¯†å•å…ƒ...]               â”‚
â”‚ å…³ç³»ç±»åž‹: [å¼•ç”¨ â–¼]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        [å–æ¶ˆ]     [ä¿å­˜]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€ç½‘ç«™é¡µé¢

| è·¯ç”± | åŠŸèƒ½ |
|------|------|
| `/knowledge` | ä¸ªäººçŸ¥è¯†æµ (æ—¶é—´çº¿+è¿‡æ»¤) |
| `/knowledge/[id]` | å•å…ƒè¯¦æƒ… (ä¿¡æ¯+å…³è”+ç¬”è®°) |
| `/tags` | æ ‡ç­¾ç®¡ç† |
| `/collections` | é›†åˆç®¡ç† |
| `/collections/[id]` | é›†åˆå†…å®¹ |

---

## ä¸ƒã€é‡Œç¨‹ç¢‘

| å‘¨ | ç›®æ ‡ | äº¤ä»˜ç‰© | çŠ¶æ€ |
|----|------|--------|------|
| W1 | æ•°æ®åº“ | 6è¡¨ + ç´¢å¼• + RLS | âœ… å®Œæˆ (2025-12-05) |
| W2 | API | çŸ¥è¯†å•å…ƒ + åŒé“¾ CRUD | âœ… å®Œæˆ (2025-12-05) |
| W3 | æ‰©å±• | é‡‡é›† + URLè§„èŒƒåŒ– + DOIæ£€æµ‹ | âœ… å®Œæˆ (2025-12-05) |
| W4 | ç½‘ç«™ | çŸ¥è¯†æµ + è¯¦æƒ…é¡µ | âœ… å®Œæˆ (2025-12-05) |
| W5 | æ ‡ç­¾é›†åˆ | ç®¡ç†é¡µé¢ + ç­›é€‰ | âœ… å®Œæˆ (2025-12-05) |
| W6 | ç¬”è®°+ä¼˜åŒ– | åŸºç¡€ç¬”è®° + æµ‹è¯• | âœ… å®Œæˆ (2025-12-05) |

### è¿›åº¦è®°å½•
- **2025-12-05**: å®Œæˆ W1-W6 (MVPå…¨éƒ¨å®Œæˆ!)
  - æ•°æ®åº“: 7è¡¨åˆ›å»ºå®Œæˆ (knowledge_units, knowledge_links, tags, unit_tags, kn_collections, collection_units, kn_notes)
  - APIç«¯ç‚¹:
    - `/api/kn/units` - çŸ¥è¯†å•å…ƒ CRUD
    - `/api/kn/units/[id]` - å•å…ƒè¯¦æƒ…/æ›´æ–°/åˆ é™¤
    - `/api/kn/links` - åŒé“¾ CRUD
    - `/api/kn/tags` - æ ‡ç­¾ CRUD
    - `/api/kn/tags/[id]` - æ ‡ç­¾æ›´æ–°/åˆ é™¤
    - `/api/kn/collections` - é›†åˆ CRUD
    - `/api/kn/collections/[id]` - é›†åˆè¯¦æƒ…/æ›´æ–°/åˆ é™¤
    - `/api/kn/notes` - ç¬”è®°åˆ›å»º/åˆ—è¡¨
    - `/api/kn/notes/[id]` - ç¬”è®°æ›´æ–°/åˆ é™¤
  - æ‰©å±•: popup.html/js æ”¹é€ ï¼Œæ”¯æŒçŸ¥è¯†å•å…ƒé‡‡é›†
  - ç½‘ç«™é¡µé¢:
    - `/knowledge` - çŸ¥è¯†æµåˆ—è¡¨
    - `/knowledge/[id]` - å•å…ƒè¯¦æƒ…é¡µï¼ˆå«å…³è”ã€ç¬”è®°ï¼‰
    - `/tags` - æ ‡ç­¾ç®¡ç†
    - `/collections` - é›†åˆç®¡ç†
  - ä¿®å¤: RLSé—®é¢˜ - ä½¿ç”¨admin clientç»•è¿‡RLSè¿›è¡ŒæŸ¥è¯¢
  - Navbar: æ·»åŠ çŸ¥è¯†ç½‘ç»œã€æ ‡ç­¾ç®¡ç†ã€é›†åˆç®¡ç†å…¥å£

---

## å…«ã€æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | MVPç›®æ ‡ |
|------|---------|
| é‡‡é›†æˆåŠŸçŽ‡ | >95% |
| URLè§„èŒƒåŒ–å‡†ç¡®çŽ‡ | >98% |
| DOIè‡ªåŠ¨æ£€æµ‹çŽ‡ | >80% |
| é¦–æ¬¡é‡‡é›†è€—æ—¶ | <2s |
| çŸ¥è¯†æµåŠ è½½ | <500ms |

---

## ä¹ã€Phase 2 é¢„å‘Š

å®ŒæˆMVPåŽä¼˜å…ˆçº§:
1. å›¾è§†å›¾å¯è§†åŒ– (D3.js)
2. OpenAlexé›†æˆ (å¼•ç”¨ç½‘ç»œè¡¥å…¨)
3. å…¨å±€çŸ¥è¯†æµ + æŽ¨è
4. ZoteroåŒå‘åŒæ­¥

---

*æ–‡æ¡£ç‰ˆæœ¬: v2.0 | åˆ›å»º: 2025-12-04*
