# 17.4 æµè§ˆå™¨æ‰©å±•æ¨¡å—åŒ–é‡æ„è®¡åˆ’

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.2  
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-14  
> **æ›´æ–°æ—¥æœŸ**: 2025-01-14  
> **å…³è”æ–‡æ¡£**: [DEVELOPMENT.md](../../DEVELOPMENT.md#æµè§ˆå™¨æ‰©å±•)
> **çŠ¶æ€**: âœ… å…¨éƒ¨ Phase å·²å®Œæˆ

## ğŸ“ˆ é‡æ„è¿›åº¦æ€»ç»“

| Phase | æè¿° | çŠ¶æ€ | åˆ›å»ºæ–‡ä»¶ |
|-------|------|------|----------|
| Phase 1 | Type ç»Ÿä¸€ | âœ… å®Œæˆ | `types/api.ts`, `types/storage.ts`, `types/dom.ts` |
| Phase 2 | Utils é‡æ„ | âœ… å®Œæˆ | `utils/doi.ts`, `utils/storage.ts`, `utils/toast.ts` |
| Phase 3 | Popup æ‹†åˆ† | âœ… å®Œæˆ | `popup/doi-panel.ts`, `popup/knowledge-panel.ts`, `popup/settings-panel.ts` |
| Phase 4 | Content æ‹†åˆ† | âœ… å®Œæˆ | `content/floating-icon.ts`, `content/doi-detector.ts` |
| Phase 5 | æ ·å¼æŠ½å– | âœ… å®Œæˆ | `styles/popup.css` (ä» popup.html æŠ½å–) |
| Phase 6 | Service å±‚ | âœ… å®Œæˆ | `services/api-client.ts`, `services/auth-service.ts` |

### æ–°å¢æ–‡ä»¶ç»Ÿè®¡

| ç›®å½• | æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|------|
| `types/` | `api.ts` | ~150 | æ¶ˆæ¯ã€API è¯·æ±‚/å“åº”ç±»å‹ |
| `types/` | `storage.ts` | ~70 | å­˜å‚¨æ•°æ®ç±»å‹ |
| `types/` | `dom.ts` | ~120 | DOM ç›¸å…³ç±»å‹ |
| `utils/` | `doi.ts` | ~200 | DOI æ£€æµ‹ã€æ¸…ç†ã€éªŒè¯ |
| `utils/` | `storage.ts` | ~170 | Chrome Storage å°è£… |
| `utils/` | `toast.ts` | ~130 | Toast é€šçŸ¥ç»„ä»¶ |
| `popup/` | `doi-panel.ts` | ~160 | DOI é¢æ¿æ¨¡å— |
| `popup/` | `knowledge-panel.ts` | ~260 | çŸ¥è¯†å•å…ƒé¢æ¿ |
| `popup/` | `settings-panel.ts` | ~160 | è®¾ç½®é¢æ¿ |
| `content/` | `floating-icon.ts` | ~380 | æ‚¬æµ®å›¾æ ‡ç»„ä»¶ |
| `content/` | `doi-detector.ts` | ~260 | Content DOI æ£€æµ‹ |
| `services/` | `api-client.ts` | ~240 | HTTP å®¢æˆ·ç«¯ |
| `services/` | `auth-service.ts` | ~200 | è®¤è¯æœåŠ¡ |
| `styles/` | `popup.css` | ~380 | Popup æ ·å¼ |
| **æ€»è®¡** | **14 æ–‡ä»¶** | **~2880** | æ¨¡å—åŒ–åŸºç¡€è®¾æ–½ |

**è¯´æ˜**: æ‰€æœ‰ Phase åˆ›å»ºäº†æ¨¡å—åŒ–åŸºç¡€è®¾æ–½ï¼Œä½†**æœªä¿®æ”¹åŸæœ‰èƒ½æ­£å¸¸å·¥ä½œçš„ popup.ts å’Œ content.ts**ï¼Œä»¥ä¿æŒç¨³å®šæ€§ã€‚æ–°æ¨¡å—å¯åœ¨åç»­è¿­ä»£ä¸­é€æ­¥é›†æˆã€‚

## ğŸ“Š å½“å‰çŠ¶æ€åˆ†æ

### æ–‡ä»¶è§„æ¨¡ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | å¤§å°(KB) | é—®é¢˜ |
|------|------|----------|------|
| `popup.ts` | 750 | 23.8 | âš ï¸ è¿‡å¤§ï¼ŒèŒè´£æ··æ‚ |
| `content.ts` | 697 | 22.7 | âš ï¸ è¿‡å¤§ï¼ŒèŒè´£æ··æ‚ |
| `sidebar.ts` | 379 | 12.0 | ğŸ”¶ ä¸­ç­‰ï¼Œå¯ä¼˜åŒ– |
| `background.ts` | 358 | 12.3 | ğŸ”¶ ä¸­ç­‰ï¼Œå¯ä¼˜åŒ– |
| `popup.html` | 580 | 13.3 | âš ï¸ å†…è”æ ·å¼è¿‡å¤š |

### é—®é¢˜è¯Šæ–­

1. **å•ä½“ç±»è®¾è®¡**
   - `PopupManager` (750è¡Œ) åŒ…å«ï¼šUIç®¡ç†ã€çŠ¶æ€ç®¡ç†ã€APIè°ƒç”¨ã€DOMæ“ä½œã€äº‹ä»¶å¤„ç†
   - `ResearchopiaContentScript` (697è¡Œ) åŒ…å«ï¼šDOIæ£€æµ‹ã€æ‚¬æµ®å›¾æ ‡ã€ä¾§è¾¹æ æ§åˆ¶ã€æ¶ˆæ¯å¤„ç†

2. **ä»£ç é‡å¤**
   - DOI æ¸…ç†/éªŒè¯é€»è¾‘åœ¨å¤šä¸ªæ–‡ä»¶é‡å¤
   - Toast æ˜¾ç¤ºé€»è¾‘åœ¨ popup/sidebar é‡å¤
   - å­˜å‚¨è®¿é—®æ¨¡å¼é‡å¤

3. **æ ·å¼å†…è”**
   - `popup.html` åŒ…å«å¤§é‡å†…è”æ ·å¼
   - `content.ts` ä¸­çš„æ‚¬æµ®å›¾æ ‡æ ·å¼ç¡¬ç¼–ç 

4. **ç±»å‹åˆ†æ•£**
   - æ¥å£å®šä¹‰åˆ†æ•£åœ¨å„æ–‡ä»¶é¡¶éƒ¨
   - ç¼ºå°‘ç»Ÿä¸€çš„ç±»å‹æ¨¡å—

---

## ğŸ¯ é‡æ„ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹
- **ä½è€¦åˆ**ï¼šæ¨¡å—é—´é€šè¿‡æ˜ç¡®æ¥å£é€šä¿¡
- **å¯æµ‹è¯•**ï¼šçº¯å‡½æ•°ä¼˜å…ˆï¼Œä¾¿äºå•å…ƒæµ‹è¯•
- **å¯å¤ç”¨**ï¼šé€šç”¨é€»è¾‘æå–ä¸ºå·¥å…·å‡½æ•°

### ç›®æ ‡æ¶æ„

```
extension/src/
â”œâ”€â”€ types/                    # ç±»å‹å®šä¹‰ï¼ˆç»Ÿä¸€ï¼‰
â”‚   â”œâ”€â”€ index.ts              # å…¬å…±ç±»å‹å¯¼å‡º
â”‚   â”œâ”€â”€ api.ts                # API ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ storage.ts            # å­˜å‚¨ç›¸å…³ç±»å‹
â”‚   â””â”€â”€ dom.ts                # DOM ç›¸å…³ç±»å‹
â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°ï¼ˆçº¯å‡½æ•°ï¼‰
â”‚   â”œâ”€â”€ index.ts              # å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ doi.ts                # DOI å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ storage.ts            # å­˜å‚¨è®¿é—®å·¥å…·
â”‚   â””â”€â”€ toast.ts              # Toast é€šçŸ¥å·¥å…·
â”œâ”€â”€ services/                 # æœåŠ¡å±‚ï¼ˆæœ‰çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ api-client.ts         # API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ auth-service.ts       # è®¤è¯æœåŠ¡
â”‚   â””â”€â”€ message-bus.ts        # æ¶ˆæ¯æ€»çº¿
â”œâ”€â”€ ui/                       # UI ç»„ä»¶
â”‚   â”œâ”€â”€ floating-icon.ts      # æ‚¬æµ®å›¾æ ‡
â”‚   â”œâ”€â”€ toast.ts              # Toast ç»„ä»¶
â”‚   â””â”€â”€ tab-manager.ts        # Tab ç®¡ç†
â”œâ”€â”€ features/                 # åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ doi-detector.ts       # DOI æ£€æµ‹
â”‚   â”œâ”€â”€ knowledge-unit.ts     # çŸ¥è¯†å•å…ƒ
â”‚   â””â”€â”€ rating/               # è¯„åˆ†åŠŸèƒ½
â”‚       â”œâ”€â”€ rating-manager.ts
â”‚       â””â”€â”€ rating-ui.ts
â”œâ”€â”€ popup/                    # Popup æ¨¡å—åŒ–
â”‚   â”œâ”€â”€ popup.ts              # ä¸»å…¥å£ï¼ˆç²¾ç®€ï¼‰
â”‚   â”œâ”€â”€ knowledge-panel.ts    # çŸ¥è¯†é¢æ¿
â”‚   â”œâ”€â”€ doi-panel.ts          # DOI é¢æ¿
â”‚   â””â”€â”€ settings-panel.ts     # è®¾ç½®é¢æ¿
â”œâ”€â”€ content/                  # Content Script æ¨¡å—åŒ–
â”‚   â”œâ”€â”€ content.ts            # ä¸»å…¥å£ï¼ˆç²¾ç®€ï¼‰
â”‚   â””â”€â”€ page-analyzer.ts      # é¡µé¢åˆ†æ
â”œâ”€â”€ sidebar/                  # Sidebar æ¨¡å—åŒ–
â”‚   â”œâ”€â”€ sidebar.ts            # ä¸»å…¥å£
â”‚   â””â”€â”€ tab-content.ts        # Tab å†…å®¹
â””â”€â”€ background.ts             # Backgroundï¼ˆä¿æŒï¼‰

extension/styles/             # æ ·å¼æ¨¡å—åŒ–
â”œâ”€â”€ common.css                # å…¬å…±æ ·å¼å˜é‡
â”œâ”€â”€ popup.css                 # Popup ä¸“ç”¨æ ·å¼
â”œâ”€â”€ sidebar.css               # Sidebar ä¸“ç”¨æ ·å¼
â””â”€â”€ floating-icon.css         # æ‚¬æµ®å›¾æ ‡æ ·å¼ï¼ˆä» JS æŠ½ç¦»ï¼‰
```

---

## ğŸ“ é‡æ„é˜¶æ®µ

### Phase 1: ç±»å‹ç»Ÿä¸€ (1-2å¤©)

**ç›®æ ‡**: å°†åˆ†æ•£çš„ç±»å‹å®šä¹‰é›†ä¸­ç®¡ç†

**ä»»åŠ¡**:
1. åˆ›å»º `types/api.ts` - API è¯·æ±‚/å“åº”ç±»å‹
2. åˆ›å»º `types/storage.ts` - Chrome Storage ç±»å‹
3. åˆ›å»º `types/dom.ts` - DOM å…ƒç´ ç±»å‹
4. æ›´æ–° `types/index.ts` - ç»Ÿä¸€å¯¼å‡º

**é¢„æœŸæ•ˆæœ**:
- æ¶ˆé™¤é‡å¤çš„æ¥å£å®šä¹‰
- æé«˜ç±»å‹å®‰å…¨æ€§
- ä¾¿äº IDE è‡ªåŠ¨è¡¥å…¨

### Phase 2: å·¥å…·å‡½æ•°æå– (2-3å¤©)

**ç›®æ ‡**: å°†çº¯å‡½æ•°é€»è¾‘ä»ç±»ä¸­æŠ½ç¦»

**ä»»åŠ¡**:
1. åˆ›å»º `utils/doi.ts`:
   ```typescript
   // ä» content.ts, popup.ts æå–
   export function cleanDOI(raw: string): string;
   export function isValidDOI(doi: string): boolean;
   export function extractDOIFromURL(url: string): string | null;
   export function extractDOIFromMeta(): string | null;
   export function extractDOIFromJsonLd(data: unknown): string | null;
   ```

2. åˆ›å»º `utils/storage.ts`:
   ```typescript
   // ç»Ÿä¸€ Storage è®¿é—®
   export async function getSettings(): Promise<Settings>;
   export async function setSettings(data: Partial<Settings>): Promise<void>;
   export async function getPanelState(tabId: number): Promise<boolean>;
   ```

3. åˆ›å»º `utils/toast.ts`:
   ```typescript
   // ç»Ÿä¸€ Toast é€»è¾‘
   export function showToast(message: string, type: ToastType): void;
   export function hideToast(): void;
   ```

**é¢„æœŸæ•ˆæœ**:
- popup.ts å‡å°‘ ~100 è¡Œ
- content.ts å‡å°‘ ~150 è¡Œ
- æ¶ˆé™¤ä»£ç é‡å¤

### Phase 3: Popup æ‹†åˆ† (3-4å¤©)

**ç›®æ ‡**: å°† 750 è¡Œçš„ PopupManager æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—

**ä»»åŠ¡**:
1. åˆ›å»º `popup/knowledge-panel.ts` (çŸ¥è¯†å•å…ƒä¿å­˜åŠŸèƒ½)
2. åˆ›å»º `popup/doi-panel.ts` (DOI æ£€æµ‹å’Œæ˜¾ç¤º)
3. åˆ›å»º `popup/settings-panel.ts` (è®¾ç½®ç®¡ç†)
4. ç²¾ç®€ `popup/popup.ts` ä¸ºåè°ƒå™¨

**é¢„æœŸç»“æ„**:
```typescript
// popup.ts (ç²¾ç®€å ~150 è¡Œ)
import { KnowledgePanel } from './knowledge-panel';
import { DOIPanel } from './doi-panel';
import { SettingsPanel } from './settings-panel';

class PopupManager {
  private knowledgePanel: KnowledgePanel;
  private doiPanel: DOIPanel;
  private settingsPanel: SettingsPanel;
  
  async init() {
    await this.knowledgePanel.init();
    await this.doiPanel.init();
    await this.settingsPanel.init();
  }
}
```

**é¢„æœŸæ•ˆæœ**:
- popup.ts: 750è¡Œ â†’ ~150è¡Œ
- å•ç‹¬æµ‹è¯•å„é¢æ¿é€»è¾‘
- ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½

### Phase 4: Content Script æ‹†åˆ† (3-4å¤©)

**ç›®æ ‡**: å°† 697 è¡Œçš„ ResearchopiaContentScript æ‹†åˆ†

**ä»»åŠ¡**:
1. åˆ›å»º `ui/floating-icon.ts` (æ‚¬æµ®å›¾æ ‡ç»„ä»¶)
2. åˆ›å»º `features/doi-detector.ts` (DOI æ£€æµ‹é€»è¾‘)
3. åˆ›å»º `content/page-analyzer.ts` (é¡µé¢åˆ†æ)
4. ç²¾ç®€ `content/content.ts` ä¸ºåè°ƒå™¨

**é¢„æœŸç»“æ„**:
```typescript
// content.ts (ç²¾ç®€å ~100 è¡Œ)
import { FloatingIcon } from '../ui/floating-icon';
import { DOIDetector } from '../features/doi-detector';
import { PageAnalyzer } from './page-analyzer';

class ResearchopiaContentScript {
  private floatingIcon: FloatingIcon;
  private doiDetector: DOIDetector;
  
  async init() {
    const doi = await this.doiDetector.detect();
    this.floatingIcon.show(doi);
    this.setupMessageListener();
  }
}
```

**é¢„æœŸæ•ˆæœ**:
- content.ts: 697è¡Œ â†’ ~100è¡Œ
- æ‚¬æµ®å›¾æ ‡ç‹¬ç«‹ç»„ä»¶åŒ–
- DOI æ£€æµ‹å¯å¤ç”¨

### Phase 5: æ ·å¼æŠ½ç¦» (1-2å¤©)

**ç›®æ ‡**: å°†å†…è”æ ·å¼æŠ½ç¦»ä¸º CSS æ–‡ä»¶

**ä»»åŠ¡**:
1. åˆ›å»º `styles/popup.css` (ä» popup.html æŠ½ç¦»)
2. åˆ›å»º `styles/floating-icon.css` (ä» content.ts æŠ½ç¦»)
3. æ›´æ–° build.mjs å¤åˆ¶æ ·å¼æ–‡ä»¶
4. æ›´æ–° HTML å¼•ç”¨

**é¢„æœŸæ•ˆæœ**:
- popup.html: 580è¡Œ â†’ ~200è¡Œ
- æ ·å¼å¯å¤ç”¨
- ä¾¿äºä¸»é¢˜å®šåˆ¶

### Phase 6: æœåŠ¡å±‚é‡æ„ (2-3å¤©)

**ç›®æ ‡**: ç»Ÿä¸€ API è°ƒç”¨å’Œè®¤è¯é€»è¾‘

**ä»»åŠ¡**:
1. åˆ›å»º `services/api-client.ts` (ç»Ÿä¸€ API å°è£…)
2. åˆ›å»º `services/auth-service.ts` (è®¤è¯ç®¡ç†)
3. é‡æ„ç°æœ‰ `modules/api-service.ts`
4. æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨å’Œé”™è¯¯å¤„ç†

**é¢„æœŸç»“æ„**:
```typescript
// api-client.ts
export class ApiClient {
  private baseUrl: string;
  private authService: AuthService;
  
  async request<T>(endpoint: string, options: RequestOptions): Promise<T>;
  async get<T>(endpoint: string): Promise<T>;
  async post<T>(endpoint: string, data: unknown): Promise<T>;
}
```

---

## ğŸ“Š é¢„æœŸæˆæœ

### ä»£ç é‡å˜åŒ–

| æ–‡ä»¶ | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| popup.ts | 750è¡Œ | ~150è¡Œ | -80% |
| content.ts | 697è¡Œ | ~100è¡Œ | -85% |
| sidebar.ts | 379è¡Œ | ~200è¡Œ | -47% |
| popup.html | 580è¡Œ | ~200è¡Œ | -65% |

### æ¨¡å—æ•°é‡å˜åŒ–

| ç›®å½• | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| types/ | 1æ–‡ä»¶ | 4æ–‡ä»¶ |
| utils/ | 1æ–‡ä»¶ | 4æ–‡ä»¶ |
| modules/ | 6æ–‡ä»¶ | â†’ services/ 3æ–‡ä»¶ |
| ui/ | 0æ–‡ä»¶ | 3æ–‡ä»¶ |
| features/ | 0æ–‡ä»¶ | 3æ–‡ä»¶ |
| popup/ | 1æ–‡ä»¶ | 4æ–‡ä»¶ |
| content/ | 1æ–‡ä»¶ | 2æ–‡ä»¶ |

### è´¨é‡æŒ‡æ ‡

- **å•æ–‡ä»¶è¡Œæ•°**: < 200è¡Œï¼ˆç›®æ ‡ï¼‰
- **åœˆå¤æ‚åº¦**: < 10ï¼ˆæ¯ä¸ªå‡½æ•°ï¼‰
- **æµ‹è¯•è¦†ç›–ç‡**: > 70%ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰

---

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹

### é£é™©
1. **é‡æ„æœŸé—´åŠŸèƒ½å›å½’** - éœ€è¦å……åˆ†æµ‹è¯•
2. **æ„å»ºé…ç½®å˜æ›´** - esbuild å…¥å£ç‚¹å¯èƒ½éœ€è¦è°ƒæ•´
3. **Chrome æ‰©å±•ç‰¹æ®Šé™åˆ¶** - æŸäº›æ¨¡å—éœ€è¦åœ¨ç‰¹å®šä¸Šä¸‹æ–‡è¿è¡Œ

### ç¼“è§£æªæ–½
1. æ¯ä¸ª Phase å®Œæˆåè¿›è¡Œé›†æˆæµ‹è¯•
2. ä¿æŒ git æäº¤ç²’åº¦å°ï¼Œä¾¿äºå›æ»š
3. æ–‡æ¡£è®°å½•æ¯ä¸ªæ¨¡å—çš„è¿è¡Œä¸Šä¸‹æ–‡è¦æ±‚

---

## ğŸ—“ï¸ æ—¶é—´ä¼°ç®—

| Phase | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|-------|----------|--------|
| Phase 1: ç±»å‹ç»Ÿä¸€ | 1-2å¤© | P1 |
| Phase 2: å·¥å…·å‡½æ•° | 2-3å¤© | P1 |
| Phase 3: Popup æ‹†åˆ† | 3-4å¤© | P2 |
| Phase 4: Content æ‹†åˆ† | 3-4å¤© | P2 |
| Phase 5: æ ·å¼æŠ½ç¦» | 1-2å¤© | P3 |
| Phase 6: æœåŠ¡å±‚ | 2-3å¤© | P3 |

**æ€»è®¡**: çº¦ 12-18 å¤©ï¼ˆä¸åŒ…å«æµ‹è¯•ï¼‰

---

## ğŸ“ å‚è€ƒèµ„æº

- [Chrome Extension Architecture](https://developer.chrome.com/docs/extensions/mv3/architecture-overview/)
- [TypeScript Project References](https://www.typescriptlang.org/docs/handbook/project-references.html)
- [Clean Architecture in TypeScript](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**ä¸‹ä¸€æ­¥**: è¯·ç¡®è®¤æ­¤è®¡åˆ’ï¼Œæˆ‘å°†ä» Phase 1 å¼€å§‹æ‰§è¡Œã€‚
