# 11.2 Cloudflare Pages 迁移方案

> 目标：长期免费解决方案，使用 OpenNext 适配器

## 1. 技术选型

### 1.1 免费额度对比

| 资源 | Vercel 免费 | Cloudflare 免费 |
|------|-------------|-----------------|
| 函数调用 | 100K/月 | **100K/天** |
| 带宽 | 100 GB | ♾️ 无限 |
| 静态请求 | 100 GB | ♾️ 无限 |

### 1.2 适配器选择

| 适配器 | 状态 | Node.js 支持 |
|--------|------|--------------|
| `@cloudflare/next-on-pages` | ❌ 已废弃 | 不支持（需全部 Edge） |
| **`@opennextjs/cloudflare`** | ✅ 推荐 | ✅ 支持混合运行时 |

**选择原因**：项目有 100+ API 路由使用 Node.js 运行时（Supabase SDK、PDF 处理等），OpenNext 支持混合运行时，无需修改所有路由。

---

## 2. 构建配置

### 2.1 Cloudflare Dashboard 配置

在 **Workers & Pages** → 项目设置中：

| 配置项 | 值 |
|--------|-----|
| Framework preset | Next.js (Static HTML Export) |
| Build command | `npx opennextjs-cloudflare build` |
| Build output directory | `.open-next/assets` |
| Deploy command | (留空，自动) |

### 2.2 环境变量

**Production 环境添加：**
```
NEXT_PUBLIC_SUPABASE_URL = https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY = eyJhbGciOi...
SUPABASE_SERVICE_ROLE_KEY = eyJhbGciOi... (加密)
RESEND_API_KEY = re_xxx (加密)
NEXT_PUBLIC_RECAPTCHA_SITE_KEY = 6Lxxx
```

---

## 3. 本地文件

### 3.1 package.json scripts
```json
{
  "build:cf": "npx opennextjs-cloudflare build",
  "preview:cf": "npx opennextjs-cloudflare dev",
  "deploy:cf": "npx wrangler pages deploy"
}
```

### 3.2 open-next.config.ts
```typescript
// OpenNext configuration for Cloudflare
const config = {};
export default config;
```

### 3.3 wrangler.toml
```toml
name = "researchopia"
compatibility_date = "2024-12-22"
compatibility_flags = ["nodejs_compat"]
```

---

## 4. 部署流程

1. Git push 触发 Cloudflare 自动构建
2. OpenNext 编译 Next.js 为 Cloudflare Pages 格式
3. 输出到 `.open-next/` 目录
4. Wrangler 自动部署到边缘网络

---

## 5. 执行清单

- [x] 安装 @opennextjs/cloudflare
- [x] 创建 open-next.config.ts
- [x] 更新 wrangler.toml (nodejs_compat)
- [x] 添加 npm scripts
- [ ] 更新 Cloudflare Dashboard Build command
- [ ] 配置环境变量
- [ ] 触发部署
- [ ] 验证功能

---

## 6. 域名迁移（可选）

1. 在 Cloudflare Dashboard 添加自定义域名
2. 更新 DNS 记录指向 Pages
3. 启用 SSL（自动）

---

## 7. MCP 集成（可选）

```json
// .vscode/mcp.json
{
  "servers": {
    "cloudflare": {
      "command": "npx",
      "args": ["@anthropic/mcp-server-cloudflare"]
    }
  }
}
```

---

*创建时间: 2024-12-22 | 更新: 2024-12-23*
