# 1.4.8 è‡ªå·±æ ‡æ³¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ

**åˆ›å»ºæ—¥æœŸ**: 2025-11-19  
**ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒåŠŸèƒ½)  
**çŠ¶æ€**: ğŸ“‹ è®¾è®¡æ–¹æ¡ˆ

---

## æ ¸å¿ƒåŸåˆ™

**æ•°æ®ä¸€è‡´æ€§**: Zoteroæœ¬åœ°æ ‡æ³¨ â‡„ Supabaseäº‘ç«¯æ ‡æ³¨ **åŒå‘åŒæ­¥**  
**ç”¨æˆ·ä½“éªŒ**: æ‰€æœ‰æ“ä½œå³æ—¶åé¦ˆ,æ— éœ€åˆ·æ–°é¡µé¢  
**æƒé™æ§åˆ¶**: private (ä»…è‡ªå·±) / shared (ç‰¹å®šç”¨æˆ·) / public (æ‰€æœ‰äºº)

---

## æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸ (7ä¸ªé˜¶æ®µ)

### 1ï¸âƒ£ åˆ›å»ºæ ‡æ³¨ (CREATE)

**ç”¨æˆ·æ“ä½œ**: åœ¨PDFä¸­æ¡†é€‰æ–‡æœ¬ â†’ é«˜äº®/ä¸‹åˆ’çº¿ â†’ æ·»åŠ comment

**æ•°æ®æµ**:
```
Zotero Reader (æ¡†é€‰) 
  â†’ Zotero.Item åˆ›å»º (annotationType, annotationText, annotationComment, annotationColor)
  â†’ Zotero Notifier è§¦å‘ 'add' äº‹ä»¶
  â†’ AnnotationManager.onAnnotationAdd()
  â†’ ğŸ” åˆ¤æ–­: æ˜¯å¦åº”è‡ªåŠ¨å…±äº«?
     - âœ… è‹¥ç”¨æˆ·å¼€å¯"è‡ªåŠ¨å…±äº«æ–°æ ‡æ³¨" â†’ è°ƒç”¨ updateAnnotationSharing()
     - âŒ å¦åˆ™ â†’ åˆ›å»ºä¸º private,ç­‰å¾…æ‰‹åŠ¨å…±äº«
```

**å…³é”®ä»£ç ä½ç½®**:
- `annotationManager.ts` - `onAnnotationAdd()` (ç›‘å¬Zotero Notifier)
- `supabase.ts` - `createAnnotation()` (åŒæ­¥åˆ°Supabase)

**é»˜è®¤çŠ¶æ€**: `visibility: 'private'`, `show_author_name: true`

---

### 2ï¸âƒ£ å…±äº«æ ‡æ³¨ (SHARE)

**ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»æ ‡æ³¨ â†’ å¼¹å‡º popup â†’ ç‚¹å‡»å…±äº«æŒ‰é’® (ç§å¯†/å…¬å¼€/åŒ¿å/å–æ¶ˆ)

**å½“å‰å®ç°** (annotationSharingPopup.ts):

#### æ–¹å¼A: Selection Popup (æ–°æ ‡æ³¨,æ¡†é€‰åç«‹å³å…±äº«)
```typescript
// Line 140-180: renderTextSelectionPopup äº‹ä»¶
Zotero.Reader.registerEventListener('renderTextSelectionPopup', async (event) => {
  const { reader, params, append } = event;
  
  // æ³¨å…¥4ä¸ªå…±äº«æŒ‰é’®åˆ°åŸç”Ÿpopup
  const buttons = this.createShareButtons(doc, annotationItem, null);
  const container = doc.createElement('div');
  container.appendChild(buttons);
  append(container);
});
```

#### æ–¹å¼B: Annotation Popup (å·²æœ‰æ ‡æ³¨,ç‚¹å‡»åä¿®æ”¹å…±äº«çŠ¶æ€)
```typescript
// Line 554-750: è½®è¯¢æ£€æµ‹ .annotation-popup å…ƒç´ 
setInterval(() => {
  const popups = doc.querySelectorAll('.annotation-popup');
  popups.forEach(popup => {
    if (!popup.querySelector('#researchopia-annotation-popup-buttons')) {
      // æå– annotation key: .comment .content çš„ id å±æ€§
      const annotationKey = popup.querySelector('.comment .content')?.id;
      
      // æ³¨å…¥4ä¸ªå…±äº«æŒ‰é’® + å¼‚æ­¥æŸ¥è¯¢å½“å‰å…±äº«çŠ¶æ€ + é«˜äº®å¯¹åº”æŒ‰é’®
      this.injectButtonsToAnnotationPopup(popup, annotationKey);
    }
  });
}, 200);
```

**å…±äº«æ¨¡å¼è½¬æ¢**:
```typescript
// shareModes å®šä¹‰ (Line 80-100)
private shareModes = [
  { id: 'private', label: 'ç§å¯†', color: '#6366f1' },   // ä»…è‡ªå·±å¯è§
  { id: 'public', label: 'å…¬å¼€', color: '#10b981' },     // æ‰€æœ‰äººå¯è§ + æ˜¾ç¤ºç”¨æˆ·å
  { id: 'anonymous', label: 'åŒ¿å', color: '#f59e0b' },  // æ‰€æœ‰äººå¯è§ + éšè—ç”¨æˆ·å
  { id: null, label: 'å–æ¶ˆ', color: '#94a3b8' }          // åˆ é™¤å…±äº«æ ‡æ³¨
];

// æ¨¡å¼è½¬æ¢é€»è¾‘ (Line 448-460)
const visibilityValue = mode === 'anonymous' ? 'public' : mode; // 'private' | 'public'
const showAuthorName = mode !== 'anonymous';                    // true | false
```

**APIè°ƒç”¨**:
```typescript
// updateAnnotationImmediately() - Line 773-1032
await AnnotationManager.updateAnnotationSharing(
  annotation,
  document.id,
  user.id,
  visibilityValue,    // 'private' | 'public'
  showAuthorName      // true | false
);

// Sessionå…³è” (ä»… public æ¨¡å¼)
if (visibilityValue === 'public') {
  await apiClient.post('/api/proxy/annotations/share-to-session', {
    annotation_id: annotation.supabaseId,
    session_id: currentSession.id
  });
}
```

**çŠ¶æ€åŒæ­¥**:
```typescript
// å…±äº«æˆåŠŸå,ç«‹å³æ›´æ–°æŒ‰é’®é«˜äº® (Line 990-1020)
this.shareModes.forEach(mode => {
  const button = buttonContainer.querySelector(`button[data-mode="${mode.id}"]`);
  const isActive = shareMode === mode.id;
  button.style.borderColor = isActive ? mode.color : '#ccc';
  button.style.background = isActive ? `${mode.color}20` : '#fff';
});

// åˆ·æ–°ä¾§è¾¹æ  "å…±äº«æ ‡æ³¨" è§†å›¾
await this.refreshSessionAnnotationsView();
```

---

### 3ï¸âƒ£ ä¿®æ”¹æ ‡æ³¨å†…å®¹ (UPDATE)

**ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»å·²æœ‰æ ‡æ³¨ â†’ ç¼–è¾‘ comment / ä¿®æ”¹é¢œè‰² / åˆ‡æ¢ç±»å‹ (é«˜äº®â†”ä¸‹åˆ’çº¿)

**æ•°æ®æµ**:
```
Zotero Reader (ç¼–è¾‘comment)
  â†’ Zotero.Item.setField('annotationComment', newText)
  â†’ Zotero Notifier è§¦å‘ 'modify' äº‹ä»¶
  â†’ AnnotationManager.onAnnotationModify()
  â†’ æŸ¥è¯¢ Supabase: è¯¥æ ‡æ³¨æ˜¯å¦å·²å…±äº«?
     - âœ… è‹¥å·²å…±äº« â†’ è°ƒç”¨ updateAnnotation() åŒæ­¥åˆ°Supabase
     - âŒ è‹¥æœªå…±äº« â†’ æ— éœ€åŒæ­¥
```

**å…³é”®ä»£ç ä½ç½®**:
- `annotationManager.ts` - `onAnnotationModify()` (ç›‘å¬Zoteroä¿®æ”¹)
- `supabase.ts` - `updateAnnotation(id, {content, comment, color, type})`

**æ”¯æŒä¿®æ”¹çš„å­—æ®µ**:
- `annotationComment` â†’ `comment` (ç¬”è®°å†…å®¹)
- `annotationColor` â†’ `color` (é«˜äº®é¢œè‰²)
- `annotationType` â†’ `type` (highlight / underline)
- `annotationText` â†’ `content` (æ ‡æ³¨åŸæ–‡,åªè¯»)

---

### 4ï¸âƒ£ ä¿®æ”¹å…±äº«çŠ¶æ€ (RESHARE)

**ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»å·²æœ‰æ ‡æ³¨ â†’ annotation-popup â†’ ç‚¹å‡»ä¸åŒçš„å…±äº«æŒ‰é’®

**åœºæ™¯ä¸¾ä¾‹**:
- åœºæ™¯A: ä» "ç§å¯†" åˆ‡æ¢åˆ° "å…¬å¼€" (visibility: private â†’ public, show_author_name: true)
- åœºæ™¯B: ä» "å…¬å¼€" åˆ‡æ¢åˆ° "åŒ¿å" (visibility: public, show_author_name: true â†’ false)
- åœºæ™¯C: ä» "åŒ¿å" åˆ‡æ¢åˆ° "å–æ¶ˆ" (åˆ é™¤ Supabase è®°å½•)

**å®ç°é€»è¾‘** (annotationSharingPopup.ts Line 860-920):
```typescript
// 1. æŸ¥è¯¢ç°æœ‰æ ‡æ³¨ (é€šè¿‡ API,ä¸æ˜¯ç›´æ¥æŸ¥ Supabase)
const params = new URLSearchParams({ document_id: documentId, type: 'my' });
const response = await apiClient.get('/api/proxy/annotations', params);
const existingAnnotation = response.data.find(ann => ann.original_id === annotationKey);

// 2. æ„é€  annotation å¯¹è±¡ (åŒ…å« supabaseId ç”¨äº UPDATE)
const annotation = {
  key: annotationItem.key,
  type: annotationItem.annotationType,
  text: annotationItem.annotationText,
  comment: annotationItem.annotationComment,
  supabaseId: existingAnnotation?.id,  // ğŸ”‘ å…³é”®: æœ‰IDåˆ™UPDATE,æ— IDåˆ™CREATE
  // ...
};

// 3. å¤„ç† "å–æ¶ˆ" æ¨¡å¼ (åˆ é™¤)
if (shareMode === null) {
  if (existingAnnotation) {
    await supabaseManager.deleteAnnotation(existingAnnotation.id);
  }
  return;
}

// 4. è°ƒç”¨ updateAnnotationSharing (å†…éƒ¨åˆ¤æ–­ CREATE or UPDATE)
await AnnotationManager.updateAnnotationSharing(
  annotation,
  documentId,
  userId,
  visibilityValue,
  showAuthorName
);
```

**é˜²é‡å¤åˆ›å»º**:
- âœ… é€šè¿‡ `annotation.supabaseId` åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨
- âœ… `AnnotationManager.updateAnnotationSharing()` å†…éƒ¨æ£€æŸ¥:
  ```typescript
  if (annotation.supabaseId) {
    await supabaseManager.updateAnnotation(annotation.supabaseId, updateData);
  } else {
    const newAnnotation = await supabaseManager.createAnnotation(annotationData);
    annotation.supabaseId = newAnnotation.id; // ğŸ”‘ å›å¡«ID
  }
  ```

---

### 5ï¸âƒ£ ä»–äººè¯„è®º (COMMENT)

**ç”¨æˆ·æ“ä½œ**: ä»–äººåœ¨å…±äº«æ ‡æ³¨ä¸Šæ·»åŠ è¯„è®º / ç‚¹èµ

**æ•°æ®æµ**:
```
ä»–äººæ“ä½œ (ç½‘ç«™ / æ’ä»¶)
  â†’ Supabase comments è¡¨æ–°å¢è®°å½•
  â†’ (å¯é€‰) Supabase Realtime æ¨é€é€šçŸ¥
  â†’ AnnotationManager æ¥æ”¶é€šçŸ¥
  â†’ ğŸ“¢ Toast æç¤º: "XXX è¯„è®ºäº†ä½ çš„æ ‡æ³¨"
```

**æŸ¥çœ‹è¯„è®º**:
- **æ–¹å¼A**: ç‚¹å‡»è‡ªå·±çš„æ ‡æ³¨ â†’ annotation-popup â†’ åº•éƒ¨æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
- **æ–¹å¼B**: ä¾§è¾¹æ  "å…±äº«æ ‡æ³¨" é¢æ¿ â†’ ç‚¹å‡»å¡ç‰‡ â†’ å±•å¼€è¯„è®ºæ ‘

**å…³é”®ä»£ç ä½ç½®**:
- `supabase.ts` - `getAnnotationCommentTree(annotationId)` (æŸ¥è¯¢è¯„è®ºæ ‘)
- `PDFReaderCoordinator.ts` - `renderCommentList()` (æ¸²æŸ“åµŒå¥—è¯„è®º)

---

### 6ï¸âƒ£ åˆ é™¤æ ‡æ³¨ (DELETE)

**ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»æ ‡æ³¨ â†’ å³é”® â†’ "åˆ é™¤æ ‡æ³¨"

**æ•°æ®æµ**:
```
Zotero Reader (åˆ é™¤)
  â†’ Zotero.Item.eraseTx()
  â†’ Zotero Notifier è§¦å‘ 'delete' äº‹ä»¶
  â†’ AnnotationManager.onAnnotationDelete()
  â†’ æŸ¥è¯¢ Supabase: è¯¥æ ‡æ³¨æ˜¯å¦å·²å…±äº«?
     - âœ… è‹¥å·²å…±äº« â†’ è°ƒç”¨ deleteAnnotation(id) åŒæ­¥åˆ é™¤
     - âŒ è‹¥æœªå…±äº« â†’ æ— éœ€æ“ä½œ
```

**Supabaseä¾§**:
```sql
-- çº§è”åˆ é™¤ç›¸å…³æ•°æ®
DELETE FROM annotations WHERE id = 'xxx'; -- è§¦å‘ ON DELETE CASCADE
  â†’ è‡ªåŠ¨åˆ é™¤ comments è¡¨ä¸­çš„è¯„è®º
  â†’ è‡ªåŠ¨åˆ é™¤ likes è¡¨ä¸­çš„ç‚¹èµ
  â†’ è‡ªåŠ¨åˆ é™¤ session_annotations è¡¨ä¸­çš„å…³è”
```

**å…³é”®ä»£ç ä½ç½®**:
- `annotationManager.ts` - `onAnnotationDelete()` (ç›‘å¬Zoteroåˆ é™¤)
- `supabase.ts` - `deleteAnnotation(id)` (APIè°ƒç”¨)

---

### 7ï¸âƒ£ å–æ¶ˆå…±äº« (UNSHARE)

**ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»æ ‡æ³¨ â†’ annotation-popup â†’ ç‚¹å‡» "å–æ¶ˆ" æŒ‰é’®

**ä¸åˆ é™¤æ ‡æ³¨çš„åŒºåˆ«**:
- åˆ é™¤æ ‡æ³¨: Zoteroæœ¬åœ° + Supabase éƒ½åˆ é™¤
- å–æ¶ˆå…±äº«: ä»…åˆ é™¤ Supabase è®°å½•,Zoteroæœ¬åœ°ä¿ç•™

**æ•°æ®æµ**:
```
ç‚¹å‡» "å–æ¶ˆ" æŒ‰é’®
  â†’ shareMode = null
  â†’ updateAnnotationImmediately() æ£€æµ‹åˆ° shareMode === null
  â†’ è°ƒç”¨ supabaseManager.deleteAnnotation(supabaseId)
  â†’ Zotero.Item ä¿æŒä¸å˜ (ä»…æœ¬åœ°å¯è§)
```

**å®ç°ä»£ç ** (annotationSharingPopup.ts Line 912-920):
```typescript
if (shareMode === null) {
  if (existingAnnotation) { // ğŸ”‘ æ£€æŸ¥ existingAnnotation,ä¸æ˜¯ annotation.supabaseId
    await supabaseManager.deleteAnnotation(existingAnnotation.id);
    this.showAnnotationPopupFeedback(doc, 'âœ… å·²å–æ¶ˆå…±äº«', true);
  } else {
    this.showAnnotationPopupFeedback(doc, 'âœ… æ ‡æ³¨æœªå…±äº«,æ— éœ€å–æ¶ˆ', true);
  }
  return; // ä¸è°ƒç”¨ updateAnnotationSharing
}
```

---

## å±•ç¤ºæ–¹å¼å¯¹æ¯”

### æ–¹æ¡ˆA: è‡ªå·±çš„æ ‡æ³¨ = Zotero åŸç”Ÿæ˜¾ç¤º â­â­â­â­â­ (å½“å‰)

**åŸç†**: 
- è‡ªå·±çš„æ ‡æ³¨å­˜å‚¨ä¸º `Zotero.Item`
- Zotero/PDF.js è‡ªåŠ¨æ¸²æŸ“ä¸ºåŸç”Ÿé«˜äº®
- ç‚¹å‡»åå¼¹å‡º **åŸç”Ÿ annotation-popup** (åŒ…å« comment ç¼–è¾‘æ¡†)
- **æ’ä»¶å¢å¼º**: æ³¨å…¥4ä¸ªå…±äº«æŒ‰é’®åˆ° annotation-popup

**ä¼˜åŠ¿**:
- âœ… **åŸç”Ÿä½“éªŒ**: ä¸ Zotero æ ‡å‡†å·¥ä½œæµå®Œå…¨ä¸€è‡´
- âœ… **æ— éœ€é¢å¤–æ¸²æŸ“**: PDF.js è‡ªåŠ¨å¤„ç†é«˜äº®ã€ç¼©æ”¾ã€æ»šåŠ¨
- âœ… **ç¼–è¾‘åŠŸèƒ½**: åŸç”Ÿ comment ç¼–è¾‘æ¡†ã€é¢œè‰²é€‰æ‹©ã€ç±»å‹åˆ‡æ¢
- âœ… **æ•°æ®ä¸€è‡´æ€§**: Zotero.Item æ˜¯å”¯ä¸€æ•°æ®æº

**å½“å‰çŠ¶æ€**: âœ… å·²å®Œæ•´å®ç°
- Line 554-750: è½®è¯¢æ³¨å…¥å…±äº«æŒ‰é’®åˆ° annotation-popup
- Line 590-750: å¼‚æ­¥æŸ¥è¯¢å…±äº«çŠ¶æ€ + é«˜äº®å¯¹åº”æŒ‰é’®
- Line 773-1032: ç‚¹å‡»æŒ‰é’® â†’ å³æ—¶æ›´æ–° Supabase + æŒ‰é’®çŠ¶æ€åŒæ­¥

---

### æ–¹æ¡ˆB: è‡ªå·±çš„æ ‡æ³¨ = HTML Overlay æ˜¾ç¤º âŒ (ä¸æ¨è)

**å‡è®¾**: åƒä»–äººæ ‡æ³¨ä¸€æ ·,ç”¨ `HighlightRenderer` æ¸²æŸ“è‡ªå·±çš„æ ‡æ³¨

**é—®é¢˜**:
- âŒ **æ•°æ®å†—ä½™**: Zotero.Item + HTML Overlay ä¸¤ä»½æ•°æ®
- âŒ **åŒæ­¥å¤æ‚**: Zoteroç¼–è¾‘åéœ€æ‰‹åŠ¨æ›´æ–°overlay
- âŒ **æ— æ³•ç¼–è¾‘**: HTML div ä¸æ”¯æŒ comment ç¼–è¾‘æ¡†
- âŒ **æ€§èƒ½æµªè´¹**: é‡å¤æ¸²æŸ“å·²æœ‰çš„åŸç”Ÿé«˜äº®

**ç»“è®º**: è‡ªå·±çš„æ ‡æ³¨åº”ä¿æŒåŸç”Ÿæ˜¾ç¤º,**æ— éœ€** HTML Overlay

---

## ç®¡ç†ç•Œé¢è®¾è®¡

### ä½ç½®1: PDF Reader å†… (annotation-popup)

**å½“å‰å®ç°**: âœ… 4ä¸ªå…±äº«æŒ‰é’® (ç§å¯†/å…¬å¼€/åŒ¿å/å–æ¶ˆ)

**æœªæ¥å¢å¼º (1.4.5)**:
```
annotation-popup ä¸‹æ–¹å¢åŠ :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€å…±äº«æŒ‰é’®åŒºã€‘                      â”‚
â”‚  [ç§å¯†] [å…¬å¼€] [åŒ¿å] [å–æ¶ˆ]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€å…±äº«ä¿¡æ¯åŒºã€‘(è‹¥å·²å…±äº«)            â”‚
â”‚  ğŸ‘¤ å¼ ä¸‰                             â”‚
â”‚  â¤ï¸ 5äººç‚¹èµ                        â”‚
â”‚  ğŸ’¬ 3æ¡è¯„è®º                         â”‚
â”‚    - æå››: å¾ˆæœ‰å¸®åŠ©!                â”‚
â”‚    - ç‹äº”: åŒæ„Ÿ                     â”‚
â”‚  [æŸ¥çœ‹å…¨éƒ¨è¯„è®º]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ä½ç½®2: Zotero ä¾§è¾¹æ  (ç®¡ç†æ ‡æ³¨é¢æ¿)

**å½“å‰çŠ¶æ€**: 
- âœ… "æˆ‘çš„æ ‡æ³¨" æ ‡ç­¾é¡µ: æ˜¾ç¤ºå½“å‰PDFçš„æ‰€æœ‰ Zotero æ ‡æ³¨ (æ— è®ºæ˜¯å¦å…±äº«)
- âœ… "å…±äº«æ ‡æ³¨" æ ‡ç­¾é¡µ: æ˜¾ç¤ºå½“å‰PDFçš„æ‰€æœ‰å…±äº«æ ‡æ³¨ (åŒ…æ‹¬ä»–äººçš„)

**æœªæ¥ä¼˜åŒ–**:
```
ã€æˆ‘çš„æ ‡æ³¨ã€‘æ ‡ç­¾é¡µå¢å¼º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ç­›é€‰: [å…¨éƒ¨] [å·²å…±äº«] [æœªå…±äº«]   â”‚
â”‚ ğŸ“Š æ’åº: [åˆ›å»ºæ—¶é—´] [å…±äº«çŠ¶æ€]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â— [å…¬å¼€] "è¿™æ˜¯å…³é”®å‘ç°" (5èµ3è¯„)    â”‚ â† ç‚¹å‡»è·³è½¬åˆ°PDFä½ç½®
â”‚ â— [ç§å¯†] "å¾…è¡¥å……çš„æƒ³æ³•"              â”‚
â”‚ â— [åŒ¿å] "å­˜ç–‘çš„è§‚ç‚¹" (2èµ)          â”‚
â”‚ â—‹  "æœªå…±äº«æ ‡æ³¨"                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰¹é‡æ“ä½œ: [å…¨é€‰] [æ‰¹é‡å…±äº«]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ä½ç½®3: Zotero å³é”®èœå•

**æ–°å¢èœå•é¡¹**:
```
å³é”®ç‚¹å‡» Zotero.Item (annotation) â†’
  â”œâ”€ "å…±äº«æ ‡æ³¨" å­èœå•
  â”‚   â”œâ”€ "âœ“ å…¬å¼€å…±äº« (æ˜¾ç¤ºå§“å)"   â† å½“å‰çŠ¶æ€æ‰“å‹¾
  â”‚   â”œâ”€ "  åŒ¿åå…±äº«"
  â”‚   â”œâ”€ "  ç§å¯† (ä»…è‡ªå·±)"
  â”‚   â””â”€ "  å–æ¶ˆå…±äº«"
  â”œâ”€ "æŸ¥çœ‹å…±äº«è¯¦æƒ…" (æ‰“å¼€ç½‘é¡µæŸ¥çœ‹ç‚¹èµ/è¯„è®º)
  â””â”€ "å¤åˆ¶å…±äº«é“¾æ¥" (ç”Ÿæˆ https://researchopia.com/annotations/xxx)
```

**å®ç°æ–¹å¼**: 
- Zotero.ContextMenu API (ç±»ä¼¼ç°æœ‰çš„ "æ·»åŠ åˆ°é˜…è¯»åˆ—è¡¨" èœå•)

---

## å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. åŒå‘åŒæ­¥ä¿è¯

**Zotero â†’ Supabase**:
```typescript
// Zotero Notifier ç›‘å¬ (annotationManager.ts)
Zotero.Notifier.registerObserver({
  notify: (event, type, ids) => {
    if (type === 'item') {
      if (event === 'add') this.onAnnotationAdd(ids);
      if (event === 'modify') this.onAnnotationModify(ids);
      if (event === 'delete') this.onAnnotationDelete(ids);
    }
  }
}, ['item']);
```

**Supabase â†’ Zotero** (æœªæ¥å®ç°):
```typescript
// Supabase Realtime ç›‘å¬ (ä»…è‡ªå·±çš„æ ‡æ³¨)
const channel = supabase.channel('my-annotations')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'annotations',
    filter: `user_id=eq.${currentUserId}`
  }, (payload) => {
    // ğŸ” åœºæ™¯: åœ¨ç½‘ç«™ä¿®æ”¹æ ‡æ³¨ comment â†’ åŒæ­¥åˆ°æ’ä»¶
    const annotationItem = Zotero.Items.getByLibraryAndKey(libraryID, payload.new.original_id);
    if (annotationItem) {
      annotationItem.setField('annotationComment', payload.new.comment);
      await annotationItem.saveTx();
    }
  })
  .subscribe();
```

---

### 2. çŠ¶æ€æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**: æ¯æ¬¡æ‰“å¼€ annotation-popup éƒ½æŸ¥è¯¢å…±äº«çŠ¶æ€,å¯èƒ½è¾ƒæ…¢

**è§£å†³ - å†…å­˜ç¼“å­˜**:
```typescript
// annotationSharingPopup.ts å¢åŠ ç¼“å­˜
private annotationStateCache = new Map<string, {
  visibility: 'private' | 'public';
  showAuthorName: boolean;
  cachedAt: number;
}>();

// æŸ¥è¯¢æ—¶å…ˆæ£€æŸ¥ç¼“å­˜ (5ç§’æœ‰æ•ˆæœŸ)
async getAnnotationState(annotationKey: string): Promise<any> {
  const cached = this.annotationStateCache.get(annotationKey);
  if (cached && Date.now() - cached.cachedAt < 5000) {
    return cached;
  }
  
  // ç¼“å­˜æœªå‘½ä¸­,æŸ¥è¯¢API
  const response = await apiClient.get('/api/proxy/annotations', params);
  const annotation = response.data.find(ann => ann.original_id === annotationKey);
  
  if (annotation) {
    this.annotationStateCache.set(annotationKey, {
      visibility: annotation.visibility,
      showAuthorName: annotation.show_author_name,
      cachedAt: Date.now()
    });
  }
  
  return annotation;
}
```

---

### 3. æ‰¹é‡æ“ä½œ

**åœºæ™¯**: ç”¨æˆ·å¸Œæœ›å°†æ•´ç¯‡è®ºæ–‡çš„æ‰€æœ‰æ ‡æ³¨ä¸€é”®å…±äº«

**å®ç°**:
```typescript
// supabase.ts å·²æœ‰æ‰¹é‡æ›´æ–°æ–¹æ³• (Line 287-310)
async batchUpdateAnnotationSharing(
  annotationIds: string[], 
  visibility: 'private' | 'public', 
  showAuthorName: boolean
): Promise<void> {
  await this.apiRequest(`annotations?id=in.(${annotationIds.join(',')})`, {
    method: 'PATCH',
    body: JSON.stringify({
      visibility,
      show_author_name: showAuthorName,
      updated_at: new Date().toISOString()
    })
  });
}
```

**UIè§¦å‘**:
- ä¾§è¾¹æ  "æˆ‘çš„æ ‡æ³¨" æ ‡ç­¾é¡µ â†’ [å…¨é€‰] â†’ [æ‰¹é‡å…±äº«] æŒ‰é’®
- å¼¹å‡ºå¯¹è¯æ¡†: é€‰æ‹©å…±äº«æ¨¡å¼ (å…¬å¼€/åŒ¿å/ç§å¯†)

---

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•

1. **å±•ç¤ºæ–¹å¼**:
   - â­ è‡ªå·±çš„æ ‡æ³¨ = Zotero åŸç”Ÿæ˜¾ç¤º (å½“å‰æ–¹æ¡ˆ)
   - â­ ä»–äººçš„æ ‡æ³¨ = HTML Overlay æ˜¾ç¤º (1.4.7æ–¹æ¡ˆ)

2. **å…±äº«å…¥å£**:
   - â­ ä¸»å…¥å£: annotation-popup çš„4ä¸ªå…±äº«æŒ‰é’® (å·²å®ç°)
   - è¾…åŠ©å…¥å£: ä¾§è¾¹æ æ‰¹é‡æ“ä½œ (æœªæ¥å®ç°)

3. **çŠ¶æ€åŒæ­¥**:
   - â­ Zotero Notifier â†’ Supabase (å·²å®ç°)
   - â­ æŒ‰é’®ç‚¹å‡» â†’ å³æ—¶æ›´æ–° + è§†è§‰åé¦ˆ (å·²å®ç°)
   - æœªæ¥: Supabase Realtime â†’ Zotero (åŒå‘åŒæ­¥)

4. **æ€§èƒ½ä¼˜åŒ–**:
   - â­ å†…å­˜ç¼“å­˜å…±äº«çŠ¶æ€ (5ç§’æœ‰æ•ˆæœŸ)
   - â­ æ‰¹é‡æ›´æ–°API (å·²å®ç° batchUpdateAnnotationSharing)

---

### âŒ é¿å…åšæ³•

1. âŒ ä¸ºè‡ªå·±çš„æ ‡æ³¨åˆ›å»º HTML Overlay (æ•°æ®å†—ä½™)
2. âŒ æ¯æ¬¡æŸ¥è¯¢éƒ½ç›´æ¥è®¿é—® Supabase (åº”é€šè¿‡API + ç¼“å­˜)
3. âŒ ä¿®æ”¹ Zotero.Item åä¸åŒæ­¥åˆ° Supabase (æ•°æ®ä¸ä¸€è‡´)
4. âŒ åˆ é™¤ Zotero.Item åä¸æ¸…ç† Supabase è®°å½• (æ•°æ®æ®‹ç•™)

---

## å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ (å·²å®Œæˆ âœ…)
- âœ… annotation-popup æ³¨å…¥å…±äº«æŒ‰é’®
- âœ… æŸ¥è¯¢å…±äº«çŠ¶æ€ + é«˜äº®å¯¹åº”æŒ‰é’®
- âœ… ç‚¹å‡»æŒ‰é’® â†’ å³æ—¶æ›´æ–° Supabase
- âœ… Session å…³è” (å…¬å¼€æ ‡æ³¨è‡ªåŠ¨åŠ å…¥å½“å‰é˜…è¯»ä¼šè¯)

### P1 - å¢å¼ºä½“éªŒ (1.4.5)
- [ ] annotation-popup æ˜¾ç¤ºå…±äº«ä¿¡æ¯ (ç‚¹èµæ•°ã€è¯„è®ºåˆ—è¡¨)
- [ ] å†…å­˜ç¼“å­˜å…±äº«çŠ¶æ€ (5ç§’æœ‰æ•ˆæœŸ)
- [ ] ä¾§è¾¹æ  "æˆ‘çš„æ ‡æ³¨" ç­›é€‰ (å…¨éƒ¨/å·²å…±äº«/æœªå…±äº«)

### P2 - é«˜çº§åŠŸèƒ½
- [ ] æ‰¹é‡å…±äº«æ“ä½œ (é€‰ä¸­å¤šä¸ªæ ‡æ³¨ â†’ ä¸€é”®å…±äº«)
- [ ] å³é”®èœå• "å…±äº«æ ‡æ³¨" å¿«æ·æ“ä½œ
- [ ] å¤åˆ¶å…±äº«é“¾æ¥ (ç”Ÿæˆç½‘é¡µURL)

### P3 - åŒå‘åŒæ­¥
- [ ] Supabase Realtime â†’ Zotero (ç½‘ç«™ä¿®æ”¹ comment â†’ æ’ä»¶è‡ªåŠ¨æ›´æ–°)
- [ ] å†²çªæ£€æµ‹ (åŒæ—¶åœ¨æ’ä»¶å’Œç½‘ç«™ä¿®æ”¹åŒä¸€æ ‡æ³¨)

---

**ç»“è®º**: 
- **å½“å‰å®ç° (annotation-popupå…±äº«æŒ‰é’®) æ˜¯æœ€ä½³å®è·µ** âœ…
- æ— éœ€ä¸ºè‡ªå·±çš„æ ‡æ³¨åˆ›å»º HTML Overlay
- æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´,ä¼˜åŒ–æ–¹å‘æ¸…æ™° (ç¼“å­˜ã€æ‰¹é‡ã€åŒå‘åŒæ­¥)
