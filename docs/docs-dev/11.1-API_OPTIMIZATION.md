# 11.1 API ä¼˜åŒ–æ–¹æ¡ˆ

> ç›®æ ‡ï¼šå‡å°‘ Function Invocations å’Œ CPU ä½¿ç”¨

## 1. è¶…é¢æ ¹å› åˆ†æ

### 1.1 ç”¨é‡æ•°æ®ï¼ˆ2024-12-22ï¼‰

| æŒ‡æ ‡ | ç”¨é‡ | é¢åº¦ | è¶…é¢å€æ•° |
|------|------|------|----------|
| Speed Insights | 57K | 10K | 5.7x âœ… å·²å…³é—­ |
| Function Invocations | 2.4M | 1M | **2.4x** ğŸ”´ |
| Edge Requests | 2.4M | 1M | **2.4x** ğŸ”´ |
| Fluid Active CPU | 11h22m | 4h | **2.8x** ğŸ”´ |
| Web Analytics | 32K | 50K | 0.64x âœ… |
| Memory | 116.6 GB | 360 GB | 0.32x âœ… |
| Bandwidth | 2.01 GB | 10 GB | 0.2x âœ… |

### 1.2 æ ¹å› å®šä½

**é—®é¢˜1: é‡å¤çš„ Health Check è·¯ç”±** (3ä¸ª)
- `/api/health` - nodejs runtime
- `/api/health-check` - å«æ•°æ®åº“æ£€æµ‹
- `/api/v1/health` - ä¸ /api/health é‡å¤

**é—®é¢˜2: é«˜é¢‘è½®è¯¢**
- Zotero æ’ä»¶å¿ƒè·³æ£€æµ‹å¯èƒ½è¿‡äºé¢‘ç¹
- æµè§ˆå™¨æ‰©å±•å¯èƒ½æœ‰è½®è¯¢é€»è¾‘

**é—®é¢˜3: è·¯ç”±ç¢ç‰‡åŒ–**
- 101 ä¸ªç‹¬ç«‹ API è·¯ç”± â†’ æ¯ä¸ªè·¯ç”±ç‹¬ç«‹å†·å¯åŠ¨
- `proxy/annotations/` ä¸‹æœ‰ 8 ä¸ªå­è·¯ç”±
- `proxy/reading-session/` ä¸‹æœ‰ 6 ä¸ªå­è·¯ç”±

---

## 2. ä¼˜åŒ–æ–¹æ¡ˆ

### P0: ç«‹å³å¯åš

#### 2.1 åˆå¹¶ Health Checkï¼ˆåˆ é™¤é‡å¤ï¼‰

```bash
# ä¿ç•™ /api/healthï¼ˆè½»é‡ï¼‰ï¼Œåˆ é™¤ï¼š
rm src/app/api/v1/health/route.ts        # ä¸ /api/health é‡å¤
# health-check ä¿ç•™ç”¨äºæ·±åº¦æ£€æµ‹ï¼Œä½†æ”¹åæˆ–é™åˆ¶è°ƒç”¨
```

#### 2.2 æ·»åŠ ç¼“å­˜å¤´

æ‰€æœ‰åªè¯» API æ·»åŠ ï¼š
```typescript
headers: {
  'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=120'
}
```

#### 2.3 æ£€æŸ¥å®¢æˆ·ç«¯è½®è¯¢

- Zotero æ’ä»¶ï¼šæ£€æŸ¥å¿ƒè·³é—´éš”ï¼Œå»ºè®® â‰¥30s
- æµè§ˆå™¨æ‰©å±•ï¼šé¿å…åå°è½®è¯¢ï¼Œæ”¹ç”¨äº‹ä»¶é©±åŠ¨

### P2: ä¸­æœŸé‡æ„

#### 2.4 åˆå¹¶ç¢ç‰‡åŒ–è·¯ç”±

**Before (8 routes):**
```
/api/proxy/annotations/create
/api/proxy/annotations/list
/api/proxy/annotations/get-share-status
...
```

**After (1 route with actions):**
```typescript
// /api/proxy/annotations/route.ts
export async function POST(req) {
  const { action, ...params } = await req.json();
  switch (action) {
    case 'create': return handleCreate(params);
    case 'list': return handleList(params);
    case 'get-share-status': return handleGetShareStatus(params);
    // ...
  }
}
```

**æ”¶ç›Š**: å‡å°‘ ~50% å†·å¯åŠ¨æ¬¡æ•°

#### 2.5 ä½¿ç”¨ Edge Runtime

å°†æ—  Node.js ä¾èµ–çš„è·¯ç”±æ”¹ä¸º Edgeï¼š
```typescript
export const runtime = 'edge'; // æ›¿ä»£ 'nodejs'
```

é€‚ç”¨è·¯ç”±ï¼š
- `/api/health`
- `/api/config/version`
- çº¯ä»£ç†ç±» API

---

## 3. é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ | é¢„æœŸå‡å°‘ |
|--------|----------|
| åˆ é™¤é‡å¤è·¯ç”± | -3% invocations |
| æ·»åŠ ç¼“å­˜ | -30% invocations |
| åˆå¹¶è·¯ç”± | -20% å†·å¯åŠ¨ |
| Edge Runtime | -40% CPU æ—¶é—´ |

**ç»¼åˆé¢„æœŸ**: Function Invocations é™è‡³ 1.2Mï¼ˆå…è´¹é¢åº¦å†…ï¼‰

---

## 4. æ‰§è¡Œæ¸…å•

- [ ] åˆ é™¤ `/api/v1/health/route.ts`
- [ ] ä¸ºåªè¯» API æ·»åŠ  `s-maxage` ç¼“å­˜
- [ ] æ£€æŸ¥ Zotero æ’ä»¶å¿ƒè·³é—´éš”
- [ ] æ£€æŸ¥æµè§ˆå™¨æ‰©å±•è½®è¯¢é€»è¾‘
- [ ] åˆå¹¶ `proxy/annotations/*` ä¸ºå•è·¯ç”±
- [ ] åˆå¹¶ `proxy/reading-session/*` ä¸ºå•è·¯ç”±

---

*åˆ›å»ºæ—¶é—´: 2024-12-22*
