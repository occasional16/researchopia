# 9.3 Better Notes æœç´¢åŠŸèƒ½ PR æäº¤æŒ‡å—

## é›¶ã€å‰ç½®å‡†å¤‡

### æ£€æŸ¥å½“å‰çŠ¶æ€
```powershell
cd D:\AI\zotero-better-notes
git status
git branch  # ç¡®è®¤åœ¨ feature/custom-search åˆ†æ”¯
```

### ç¡®ä¿ä»£ç å¯æ„å»º
```powershell
npm run build
# åº”è¯¥æˆåŠŸè¾“å‡º: âœ” Build finished in ~1s
```

---

## ä¸€ã€ä»£ç æ•´ç†ä¸æµ‹è¯•

### 1.1 æ¸…ç†è°ƒè¯•ä»£ç 
æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶ï¼Œç§»é™¤å¤šä½™çš„ `console.log` å’Œ `ztoolkit.log`ï¼š
- `src/modules/customSearch/findbar.ts`
- `src/modules/customSearch/manager.ts`

**ä¿ç•™å…³é”®æ—¥å¿—**ï¼ˆé”™è¯¯å’Œé‡è¦æ“ä½œï¼‰:
```typescript
// âœ… ä¿ç•™
ztoolkit.log('[CustomSearch] ERROR: Cannot find .ProseMirror element');
ztoolkit.log('[CustomSearch] Created', count, 'overlay elements');

// âŒ åˆ é™¤
ztoolkit.log('[CustomSearch] Query changed, clearing old highlights');
ztoolkit.log('[CustomSearch] Scrolled to match:', index);
```

### 1.2 å®Œæ•´åŠŸèƒ½æµ‹è¯•
åœ¨ Zotero ä¸­æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

| æµ‹è¯•é¡¹ | æ“ä½œ | æœŸæœ›ç»“æœ |
|--------|------|----------|
| åŸºç¡€æœç´¢ | è¾“å…¥ "test" | é«˜äº®æ‰€æœ‰åŒ¹é…ï¼Œæ˜¾ç¤º "1/N" |
| å¿«é€Ÿè¾“å…¥ | å¿«é€Ÿè¾“å…¥ "search" | 300ms åæ‰§è¡Œæœç´¢ï¼Œæµç•…æ— å¡é¡¿ |
| å¤§é‡åŒ¹é… | è¾“å…¥ "t" | <100ms å“åº”ï¼Œåªæ¸²æŸ“ 200 ä¸ªé«˜äº® |
| å¯¼èˆª | ç‚¹å‡» Previous/Next | å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ï¼Œé«˜äº®å˜æ©™è‰² |
| æ›¿æ¢å•ä¸ª | è¾“å…¥æ›¿æ¢æ–‡æœ¬ï¼Œç‚¹å‡» Replace | å½“å‰åŒ¹é…è¢«æ›¿æ¢ï¼Œæœç´¢æ›´æ–° |
| æ›¿æ¢å…¨éƒ¨ | ç‚¹å‡» Replace All | æ‰€æœ‰åŒ¹é…è¢«æ›¿æ¢ |
| å…³é—­æœç´¢æ  | æŒ‰ Escape æˆ–ç‚¹å‡»å…³é—­æŒ‰é’® | é«˜äº®æ¸…é™¤ï¼Œæœç´¢æ éšè— |
| é”®ç›˜å¿«æ·é”® | Ctrl+Shift+F | æœç´¢æ æ‰“å¼€/å…³é—­ |

---

## äºŒã€æäº¤ä»£ç åˆ°æœ¬åœ°åˆ†æ”¯

### 2.1 æŸ¥çœ‹ä¿®æ”¹å†…å®¹
```powershell
git diff src/modules/customSearch/
git diff src/modules/editor/toolbar.ts
git diff addon/prefs.js
```

### 2.2 æš‚å­˜æ–‡ä»¶
```powershell
# æš‚å­˜æ–°å¢æ–‡ä»¶
git add src/modules/customSearch/findbar.ts
git add src/modules/customSearch/manager.ts
git add src/modules/customSearch/types.ts

# æš‚å­˜ä¿®æ”¹æ–‡ä»¶
git add src/modules/editor/toolbar.ts
git add addon/prefs.js
```

### 2.3 æäº¤åˆ°æœ¬åœ°
```powershell
git commit -m "feat: add optimized custom search feature

- Implement inline search bar with real-time highlighting
- Add debounced input (300ms) to prevent lag
- Use virtual rendering (max 200 overlays) for large documents
- Support Previous/Next navigation and Replace functionality
- Add keyboard shortcut (Ctrl+Shift+F)
- Performance: 15x faster than native search in large notes

Resolves performance issues in large documents by using:
1. CSS overlay highlighting (no DOM modification)
2. TreeWalker for efficient text traversal
3. Debouncing and virtual rendering strategies"
```

---

## ä¸‰ã€æ¨é€åˆ° GitHub

### 3.1 æ¨é€åˆ†æ”¯åˆ°è¿œç¨‹
```powershell
# ç¬¬ä¸€æ¬¡æ¨é€ï¼ˆå¦‚æœåˆ†æ”¯ä¸å­˜åœ¨äºè¿œç¨‹ï¼‰
git push -u origin feature/custom-search

# æˆ–è€…ï¼ˆå¦‚æœå·²æ¨é€è¿‡ï¼‰
git push origin feature/custom-search
```

### 3.2 éªŒè¯æ¨é€æˆåŠŸ
æµè§ˆå™¨æ‰“å¼€ï¼šhttps://github.com/occasional16/zotero-better-notes/tree/feature/custom-search

ç¡®è®¤çœ‹åˆ°æœ€æ–°æäº¤ã€‚

---

## å››ã€åˆ›å»º Pull Request

### 4.1 åœ¨ GitHub åˆ›å»º PR
1. è®¿é—® https://github.com/windingwind/zotero-better-notes
2. ç‚¹å‡» **"Pull requests"** â†’ **"New pull request"**
3. ç‚¹å‡» **"compare across forks"**
4. è®¾ç½® base å’Œ headï¼š
   - **base repository**: `windingwind/zotero-better-notes`
   - **base**: `master`ï¼ˆæˆ– `main`ï¼ŒæŸ¥çœ‹ä¸»åˆ†æ”¯åç§°ï¼‰
   - **head repository**: `occasional16/zotero-better-notes`
   - **compare**: `feature/custom-search`

### 4.2 å¡«å†™ PR ä¿¡æ¯

**Title**:
```
feat: Add optimized custom search feature for note editor
```

**Description** (æ¨¡æ¿):
```markdown
## Summary
Implements a high-performance custom search feature for the note editor, addressing severe performance issues in large documents.

## Motivation
The native Zotero search (Ctrl+F) experiences significant lag in large notes:
- Input lag: 1.5s+ when matching 2000+ results
- Previous/Next navigation: 200-500ms delay
- High CPU usage: sustained 80%+

## Changes
### New Features
- âœ¨ Inline search bar with real-time highlighting
- âœ¨ Previous/Next navigation with smooth scrolling
- âœ¨ Replace and Replace All functionality
- âœ¨ Keyboard shortcut: `Ctrl+Shift+F` to toggle search bar
- âœ¨ Match counter (e.g., "1/25")

### Performance Optimizations
- âš¡ **Input debouncing (300ms)**: Prevents lag during fast typing
- âš¡ **Virtual rendering (max 200 overlays)**: Only renders visible highlights
- âš¡ **TreeWalker traversal**: 3-5x faster than `doc.descendants()`
- âš¡ **CSS overlay architecture**: No DOM modification, no ProseMirror overhead

### Technical Implementation
- Uses independent overlay container outside `.ProseMirror`
- Stores match positions as `{ node, start, length }` instead of creating DOM elements
- Dynamically creates/destroys overlays based on viewport and navigation

## Performance Comparison
| Scenario | Before (Native) | After (Plugin) | Improvement |
|----------|-----------------|----------------|-------------|
| Input "t" (2696 matches) | 1.5s+ lag | <100ms | **15x** |
| Previous/Next navigation | 200-500ms | <50ms | **4-10x** |
| CPU usage | 80%+ sustained | <30% peak | **3x** |

## Testing
Tested in Zotero 7 with notes containing:
- âœ… Small notes (<1000 words): Instant response
- âœ… Medium notes (1000-5000 words): Smooth performance
- âœ… Large notes (10000+ words): Significant improvement over native search

## Files Changed
- `src/modules/customSearch/findbar.ts` (524 lines) - Main search UI and logic
- `src/modules/customSearch/manager.ts` (146 lines) - Search instance manager
- `src/modules/customSearch/types.ts` (12 lines) - TypeScript interfaces
- `src/modules/editor/toolbar.ts` (3 lines) - Toolbar integration
- `addon/prefs.js` (1 line) - Preference registration

## Screenshots
<!-- Optional: Add screenshots showing the search bar in action -->

## Additional Notes
- Preference key: `extensions.zotero.betternotes.editor.customSearch` (default: `true`)
- Fully compatible with existing better-notes features
- No breaking changes to existing code

## Related Issues
<!-- If there's an existing issue, reference it here -->
Closes #XXX (if applicable)

## Checklist
- [x] Code builds successfully (`npm run build`)
- [x] Manually tested in Zotero 7
- [x] No console errors in normal usage
- [x] Performance validated in large documents
- [ ] Awaiting maintainer review
```

### 4.3 æäº¤ PR
ç‚¹å‡» **"Create pull request"** æŒ‰é’®ã€‚

---

## äº”ã€PR åç»­å¤„ç†

### 5.1 å“åº” Code Review
ç»´æŠ¤è€…å¯èƒ½ä¼šæå‡ºä»¥ä¸‹ç±»å‹çš„åé¦ˆï¼š

**å¸¸è§å®¡æŸ¥æ„è§**:
1. **ä»£ç é£æ ¼** - ç¡®ä¿ç¬¦åˆé¡¹ç›®è§„èŒƒï¼ˆç¼©è¿›ã€å‘½åç­‰ï¼‰
2. **TypeScript ç±»å‹** - è¡¥å……ç¼ºå¤±çš„ç±»å‹å®šä¹‰
3. **å›½é™…åŒ–** - æ·»åŠ å¤šè¯­è¨€æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
4. **æ€§èƒ½æµ‹è¯•** - æä¾›æ›´å¤šæµ‹è¯•æ•°æ®
5. **æ–‡æ¡£** - æ·»åŠ  README æˆ–ç”¨æˆ·æ–‡æ¡£

**å“åº”æµç¨‹**:
```powershell
# åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç 
# ... ä¿®æ”¹æ–‡ä»¶ ...

# æäº¤ä¿®æ”¹
git add .
git commit -m "fix: address review comments

- Update TypeScript types
- Add i18n support
- Improve error handling"

# æ¨é€æ›´æ–°
git push origin feature/custom-search
# PR ä¼šè‡ªåŠ¨æ›´æ–°
```

### 5.2 ä¿æŒ PR åŒæ­¥
å¦‚æœ `windingwind/zotero-better-notes` çš„ `master` åˆ†æ”¯æœ‰æ›´æ–°ï¼š

```powershell
# æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
git remote add upstream https://github.com/windingwind/zotero-better-notes.git

# è·å–ä¸Šæ¸¸æ›´æ–°
git fetch upstream

# åˆ‡æ¢åˆ°æœ¬åœ° master åˆ†æ”¯
git checkout master
git merge upstream/master

# å›åˆ° feature åˆ†æ”¯å¹¶ rebase
git checkout feature/custom-search
git rebase master

# å¦‚æœæœ‰å†²çªï¼Œè§£å†³åï¼š
git add .
git rebase --continue

# å¼ºåˆ¶æ¨é€ï¼ˆrebase åéœ€è¦ï¼‰
git push origin feature/custom-search --force-with-lease
```

### 5.3 PR è¢«æ¥å—å
```powershell
# åˆ‡æ¢å› master åˆ†æ”¯
git checkout master

# åŒæ­¥ä¸Šæ¸¸æœ€æ–°ä»£ç 
git fetch upstream
git merge upstream/master

# åˆ é™¤æœ¬åœ° feature åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
git branch -d feature/custom-search

# åˆ é™¤è¿œç¨‹ feature åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
git push origin --delete feature/custom-search
```

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1: PR é•¿æ—¶é—´æ— å“åº”æ€ä¹ˆåŠï¼Ÿ
**A**: Better Notes æ˜¯ä¸ªäººç»´æŠ¤é¡¹ç›®ï¼Œç»´æŠ¤è€…å¯èƒ½è¾ƒå¿™ï¼š
- ç­‰å¾… 1-2 å‘¨æ˜¯æ­£å¸¸çš„
- å¦‚æœè¶…è¿‡ 2 å‘¨æ— å“åº”ï¼Œå¯ä»¥ç¤¼è²Œåœ°åœ¨ PR è¯„è®ºä¸­ ping ç»´æŠ¤è€…ï¼š`@windingwind Gentle reminder, is there any feedback on this PR? ğŸ˜Š`

### Q2: ç»´æŠ¤è€…è¦æ±‚å¤§å¹…ä¿®æ”¹æ€ä¹ˆåŠï¼Ÿ
**A**: 
1. å…ˆè®¨è®ºæ–¹æ¡ˆï¼Œç¡®è®¤æ–¹å‘ä¸€è‡´
2. å¦‚æœåˆ†æ­§è¾ƒå¤§ï¼Œå¯ä»¥æå‡ºæŠ˜ä¸­æ–¹æ¡ˆ
3. å¦‚æœæ— æ³•è¾¾æˆä¸€è‡´ï¼Œå¯ä»¥å…³é—­ PRï¼Œå°†åŠŸèƒ½ä½œä¸ºç‹¬ç«‹æ’ä»¶å‘å¸ƒ

### Q3: å¦‚ä½•å¤„ç†åˆå¹¶å†²çªï¼Ÿ
**A**:
```powershell
# æ‹‰å–æœ€æ–° master
git fetch upstream
git checkout master
git merge upstream/master

# Rebase feature åˆ†æ”¯
git checkout feature/custom-search
git rebase master

# å¦‚æœæœ‰å†²çªï¼š
# 1. æ‰“å¼€å†²çªæ–‡ä»¶ï¼Œæ‰‹åŠ¨è§£å†³å†²çªæ ‡è®°ï¼ˆ<<<<<<, =======, >>>>>>>ï¼‰
# 2. æš‚å­˜è§£å†³åçš„æ–‡ä»¶
git add <conflicted-file>
# 3. ç»§ç»­ rebase
git rebase --continue

# æ¨é€æ›´æ–°
git push origin feature/custom-search --force-with-lease
```

### Q4: PR è¢«æ‹’ç»äº†æ€ä¹ˆåŠï¼Ÿ
**A**: 
- è¯¢é—®å…·ä½“åŸå› å’Œæ”¹è¿›å»ºè®®
- å¦‚æœæ˜¯æ¶æ„é—®é¢˜ï¼Œè€ƒè™‘é‡æ„æˆ–ä½œä¸ºç‹¬ç«‹æ’ä»¶
- å­¦ä¹ ç»éªŒï¼Œä¸‹æ¬¡æ”¹è¿›

---

## ä¸ƒã€ç‹¬ç«‹æ’ä»¶å‘å¸ƒï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

å¦‚æœ PR æ— æ³•è¢«æ¥å—ï¼Œå¯ä»¥ä½œä¸ºç‹¬ç«‹æ’ä»¶å‘å¸ƒï¼š

### 7.1 Fork Better Notes åˆ›å»ºç‹¬ç«‹æ’ä»¶
```powershell
# å…‹éš†ä½ çš„ fork
git clone https://github.com/occasional16/zotero-better-notes.git custom-search-plugin
cd custom-search-plugin

# ä¿®æ”¹ package.json
# æ”¹åä¸º: "zotero-better-notes-custom-search"
# æ”¹æè¿°: "Custom search plugin for Better Notes"
```

### 7.2 å‘å¸ƒåˆ° GitHub Releases
1. åœ¨ GitHub åˆ›å»ºæ–° Release
2. ä¸Šä¼  `.xpi` æ–‡ä»¶ï¼ˆä» `build/` ç›®å½•ï¼‰
3. ç¼–å†™ Release Notes
4. ç”¨æˆ·å¯ä»¥é€šè¿‡ "Install Add-on From File" å®‰è£…

---

## å…«ã€æ£€æŸ¥æ¸…å•

æäº¤ PR å‰æœ€åæ£€æŸ¥ï¼š

- [ ] ä»£ç å·²æµ‹è¯•ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] æ¸…ç†äº†è°ƒè¯•æ—¥å¿—
- [ ] `npm run build` æˆåŠŸ
- [ ] Commit message æ¸…æ™°ï¼ˆéµå¾ª Conventional Commitsï¼‰
- [ ] PR description å®Œæ•´ï¼ŒåŒ…å«åŠ¨æœºã€æ”¹åŠ¨ã€æµ‹è¯•ç»“æœ
- [ ] æ²¡æœ‰æ— å…³æ–‡ä»¶æ”¹åŠ¨ï¼ˆæ£€æŸ¥ `git diff`ï¼‰
- [ ] TypeScript ç±»å‹å®šä¹‰å®Œæ•´
- [ ] æ·»åŠ äº†å¿…è¦çš„æ³¨é‡Š
- [ ] æ€§èƒ½æ•°æ®å‡†ç¡®

---

## ä¹ã€å‚è€ƒèµ„æº

| èµ„æº | é“¾æ¥ |
|------|------|
| Better Notes ä»“åº“ | https://github.com/windingwind/zotero-better-notes |
| Conventional Commits | https://www.conventionalcommits.org/ |
| GitHub PR æŒ‡å— | https://docs.github.com/en/pull-requests |
| Git å†²çªè§£å†³ | https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-11-26  
**é€‚ç”¨äººç¾¤**: ç¼–ç¨‹åˆå­¦è€…  
**é¢„è®¡å®Œæˆæ—¶é—´**: é¦–æ¬¡æäº¤ 1-2 å°æ—¶ï¼Œåç»­ç»´æŠ¤è§†åé¦ˆè€Œå®š

**ç¥ PR é¡ºåˆ©ï¼ğŸ‰**
