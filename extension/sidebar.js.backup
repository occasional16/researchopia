// sidebar.js - ä¾§è¾¹æ é€»è¾‘
class ResearchopiaSidebar {
  constructor() {
    this.iframe = null;
    this.currentDoi = null;
    this.researchopiaUrl =   hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    const error = document.getElementById('errorContainer');
    
    loading.classList.add('hidden');
    error.classList.add('hidden');
  }

  showSuccess() {
    this.iframe.classList.remove('hidden');
  }

  showError() {
    const loading = document.getElementById('loadingOverlay');
    const error = document.getElementById('errorContainer');
    
    loading.classList.add('hidden');
    error.classList.remove('hidden');
    this.iframe.classList.add('hidden');
  }00';
    this.isLoaded = false;
    this.connectionAttempts = 0;
    this.maxAttempts = 3;
    
    this.init();
  }

  async init() {
    console.log('ðŸš€ ç ”å­¦æ¸¯ä¾§è¾¹æ åˆå§‹åŒ–...');
    
    // åŠ è½½è®¾ç½®
    await this.loadSettings();
    
    // èŽ·å–å½“å‰é¡µé¢çš„DOIä¿¡æ¯
    await this.getCurrentPageInfo();
    
    // åˆå§‹åŒ–iframe
    this.setupIframe();
    
    // è®¾ç½®æ¶ˆæ¯ç›‘å¬
    this.setupMessageListener();
    
    // è®¾ç½®UIäº‹ä»¶ç›‘å¬å™¨
    this.setupEventListeners();
    
    // æ£€æµ‹æœåŠ¡å™¨è¿žæŽ¥
    this.checkConnection();
  }

  async loadSettings() {
    try {
      const result = await chrome.storage.sync.get([
        'researchopiaUrl',
        'sidebarLastUrl',
        'doiFromContentScript'
      ]);
      
      this.researchopiaUrl = result.researchopiaUrl || 'http://localhost:3000';
      this.lastUrl = result.sidebarLastUrl;
      this.currentDoi = result.doiFromContentScript;
      
      console.log('ðŸ“‹ ä¾§è¾¹æ è®¾ç½®åŠ è½½å®Œæˆ:', {
        url: this.researchopiaUrl,
        doi: this.currentDoi,
        lastUrl: this.lastUrl
      });
    } catch (error) {
      console.error('è®¾ç½®åŠ è½½å¤±è´¥:', error);
    }
  }

  async getCurrentPageInfo() {
    try {
      // èŽ·å–å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µ
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      
      if (tab && tab.id) {
        // å‘content scriptè¯·æ±‚DOIä¿¡æ¯
        const response = await chrome.tabs.sendMessage(tab.id, {
          action: 'getCurrentDOI'
        });
        
        if (response && response.success && response.doi) {
          this.currentDoi = response.doi;
          console.log('ðŸ“„ èŽ·å–å½“å‰é¡µé¢DOI:', this.currentDoi);
        }
      }
    } catch (error) {
      console.log('æ— æ³•èŽ·å–å½“å‰é¡µé¢ä¿¡æ¯:', error.message);
    }
  }

  setupIframe() {
    this.iframe = document.getElementById('researchopiaFrame');
    
    // æž„å»ºURL
    let targetUrl = this.researchopiaUrl;
    
    // å¦‚æžœæœ‰DOIï¼Œæ·»åŠ æœç´¢å‚æ•°ï¼ˆä½†ä¸è‡ªåŠ¨æœç´¢ï¼‰
    if (this.currentDoi) {
      targetUrl += `/?doi=${encodeURIComponent(this.currentDoi)}`;
      console.log('ðŸ”— æž„å»ºå¸¦DOIçš„URL:', targetUrl);
    } else if (this.lastUrl) {
      // å¦‚æžœæ²¡æœ‰æ–°DOIä½†æœ‰ä¸Šæ¬¡çš„URLï¼Œæ¢å¤ä¸Šæ¬¡çŠ¶æ€
      targetUrl = this.lastUrl;
      console.log('ðŸ”„ æ¢å¤ä¸Šæ¬¡URL:', targetUrl);
    }
    
    this.iframe.src = targetUrl;
    
    // iframeåŠ è½½äº‹ä»¶
    this.iframe.onload = () => {
      this.hideLoading();
      this.showSuccess();
      this.isLoaded = true;
      
      // ä¿å­˜å½“å‰URL
      chrome.storage.sync.set({ sidebarLastUrl: targetUrl });
      
      console.log('âœ… ç ”å­¦æ¸¯é¡µé¢åŠ è½½å®Œæˆ');
    };
    
    this.iframe.onerror = () => {
      this.showError();
      console.error('âŒ ç ”å­¦æ¸¯é¡µé¢åŠ è½½å¤±è´¥');
    };
  }

  async checkConnection() {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const response = await fetch(this.researchopiaUrl, {
        method: 'HEAD',
        mode: 'no-cors',
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      this.updateConnectionStatus(true);
      
    } catch (error) {
      console.warn('æœåŠ¡å™¨è¿žæŽ¥æ£€æŸ¥å¤±è´¥:', error.message);
      this.updateConnectionStatus(false);
      
      // å¦‚æžœè¿žæŽ¥å¤±è´¥ä¸”æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºé”™è¯¯
      setTimeout(() => {
        if (!this.isLoaded) {
          this.showError();
        }
      }, 3000);
    }
  }

  updateConnectionStatus(connected) {
    const indicator = document.getElementById('connectionStatus');
    if (connected) {
      indicator.style.background = '#4ade80';
      indicator.title = 'æœåŠ¡å™¨è¿žæŽ¥æ­£å¸¸';
    } else {
      indicator.style.background = '#ef4444';
      indicator.title = 'æœåŠ¡å™¨è¿žæŽ¥å¼‚å¸¸';
    }
  }

  hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    const error = document.getElementById('errorContainer');
    
    loading.style.display = 'none';
    error.style.display = 'none';
  }

  showSuccess() {
    this.iframe.style.display = 'block';
  }

  showError() {
    const loading = document.getElementById('loadingOverlay');
    const error = document.getElementById('errorContainer');
    
    loading.style.display = 'none';
    error.style.display = 'block';
    this.iframe.style.display = 'none';
    
    this.updateConnectionStatus(false);
  }

  setupMessageListener() {
    // ç›‘å¬æ¥è‡ªå…¶ä»–æ‰©å±•ç»„ä»¶çš„æ¶ˆæ¯
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
      console.log('ðŸ“¨ ä¾§è¾¹æ æ”¶åˆ°æ¶ˆæ¯:', request);
      
      switch (request.action) {
        case 'updateDOI':
          this.handleDOIUpdate(request.doi);
          sendResponse({ success: true });
          break;
          
        case 'refreshSidebar':
          this.refresh();
          sendResponse({ success: true });
          break;
          
        case 'getSidebarStatus':
          sendResponse({ 
            success: true, 
            loaded: this.isLoaded,
            doi: this.currentDoi,
            url: this.iframe ? this.iframe.src : null
          });
          break;
          
        default:
          sendResponse({ success: false, error: 'Unknown action' });
      }
      
      return true;
    });
  }

  setupEventListeners() {
    // é‡è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    const retryBtn = document.getElementById('retryBtn');
    if (retryBtn) {
      retryBtn.addEventListener('click', () => {
        console.log('ðŸ”„ ç”¨æˆ·ç‚¹å‡»é‡è¯•è¿žæŽ¥');
        this.retryConnection();
      });
    }
    
    // è®¾ç½®æŒ‰é’®
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        this.toggleSettingsPanel();
      });
    }
    
    // å…³é—­è®¾ç½®æŒ‰é’®
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    if (closeSettingsBtn) {
      closeSettingsBtn.addEventListener('click', () => {
        this.hideSettingsPanel();
      });
    }
    
    // æ‚¬æµ®å›¾æ ‡åˆ‡æ¢æŒ‰é’®
    const toggleFloatBtn = document.getElementById('toggleFloatBtn');
    if (toggleFloatBtn) {
      toggleFloatBtn.addEventListener('click', () => {
        this.toggleFloatingIcon();
      });
    }
    
    // DOIæ£€æµ‹æŒ‰é’®
    const detectDOIBtn = document.getElementById('detectDOIBtn');
    if (detectDOIBtn) {
      detectDOIBtn.addEventListener('click', () => {
        this.detectCurrentDOI();
      });
    }
    
    // ä¿å­˜è®¾ç½®æŒ‰é’®
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', () => {
        this.saveSettings();
      });
    }
    
    // é‡ç½®è®¾ç½®æŒ‰é’®
    const resetSettingsBtn = document.getElementById('resetSettingsBtn');
    if (resetSettingsBtn) {
      resetSettingsBtn.addEventListener('click', () => {
        this.resetSettings();
      });
    }
    
    console.log('ðŸŽ›ï¸ ä¾§è¾¹æ äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
  }

  retryConnection() {
    console.log('ðŸ”„ é‡è¯•è¿žæŽ¥...');
    this.connectionAttempts = 0;
    this.checkConnection();
  }

  toggleSettingsPanel() {
    const panel = document.getElementById('settingsPanel');
    if (panel.style.display === 'none') {
      this.showSettingsPanel();
    } else {
      this.hideSettingsPanel();
    }
  }

  showSettingsPanel() {
    const panel = document.getElementById('settingsPanel');
    panel.style.display = 'block';
    
    // æ›´æ–°è®¾ç½®é¢æ¿çš„æ˜¾ç¤ºå†…å®¹
    this.updateSettingsDisplay();
  }

  hideSettingsPanel() {
    const panel = document.getElementById('settingsPanel');
    panel.style.display = 'none';
  }

  updateSettingsDisplay() {
    // æ›´æ–°DOIæ˜¾ç¤º
    const doiDisplay = document.getElementById('currentDOIDisplay');
    if (doiDisplay) {
      doiDisplay.textContent = this.currentDoi || 'æœªæ£€æµ‹åˆ°';
      doiDisplay.title = this.currentDoi || 'æœªæ£€æµ‹åˆ°DOI';
    }
    
    // æ›´æ–°æœåŠ¡å™¨URL
    const urlInput = document.getElementById('serverUrlInput');
    if (urlInput) {
      urlInput.value = this.researchopiaUrl;
    }
  }

  async toggleFloatingIcon() {
    try {
      // èŽ·å–å½“å‰æ ‡ç­¾é¡µ
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      
      if (tab && tab.id) {
        const response = await chrome.tabs.sendMessage(tab.id, {
          action: 'toggleFloating',
          enabled: true
        });
        
        console.log('ðŸ“Œ æ‚¬æµ®å›¾æ ‡åˆ‡æ¢ç»“æžœ:', response);
      }
    } catch (error) {
      console.error('âŒ åˆ‡æ¢æ‚¬æµ®å›¾æ ‡å¤±è´¥:', error);
    }
  }

  async detectCurrentDOI() {
    try {
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      
      if (tab && tab.id) {
        const response = await chrome.tabs.sendMessage(tab.id, {
          action: 'detectDOI'
        });
        
        if (response && response.success && response.doi) {
          this.currentDoi = response.doi;
          this.updateSettingsDisplay();
          console.log('ðŸ” é‡æ–°æ£€æµ‹åˆ°DOI:', response.doi);
        } else {
          console.log('âš ï¸ æœªæ£€æµ‹åˆ°DOI');
        }
      }
    } catch (error) {
      console.error('âŒ DOIæ£€æµ‹å¤±è´¥:', error);
    }
  }

  async saveSettings() {
    const urlInput = document.getElementById('serverUrlInput');
    
    if (urlInput) {
      const newUrl = urlInput.value.trim();
      if (newUrl && newUrl !== this.researchopiaUrl) {
        this.researchopiaUrl = newUrl;
        
        // ä¿å­˜åˆ°å­˜å‚¨
        await chrome.storage.sync.set({
          researchopiaUrl: newUrl
        });
        
        console.log('ðŸ’¾ è®¾ç½®å·²ä¿å­˜:', newUrl);
        
        // é‡æ–°åŠ è½½iframe
        this.loadResearchopia();
      }
    }
  }

  async resetSettings() {
    // é‡ç½®ä¸ºé»˜è®¤å€¼
    this.researchopiaUrl = 'http://localhost:3000';
    
    await chrome.storage.sync.set({
      researchopiaUrl: this.researchopiaUrl
    });
    
    // æ›´æ–°æ˜¾ç¤º
    this.updateSettingsDisplay();
    
    // é‡æ–°åŠ è½½
    this.loadResearchopia();
    
    console.log('ðŸ”„ è®¾ç½®å·²é‡ç½®');
  }

  handleDOIUpdate(newDoi) {
    if (newDoi && newDoi !== this.currentDoi) {
      console.log('ðŸ”„ æ›´æ–°ä¾§è¾¹æ DOI:', newDoi);
      this.currentDoi = newDoi;
      
      // ä¸è‡ªåŠ¨åˆ·æ–°ï¼Œåªæ›´æ–°URLä»¥å¤‡åŽç»­ä½¿ç”¨
      const newUrl = `${this.researchopiaUrl}/?doi=${encodeURIComponent(newDoi)}`;
      chrome.storage.sync.set({ 
        doiFromContentScript: newDoi,
        sidebarLastUrl: newUrl
      });
    }
  }

  refresh() {
    if (this.iframe) {
      this.iframe.src = this.iframe.src;
      this.showLoading();
    }
  }

  showLoading() {
    const loading = document.getElementById('loadingOverlay');
    const error = document.getElementById('errorContainer');
    
    loading.style.display = 'flex';
    error.style.display = 'none';
    this.iframe.style.display = 'none';
    this.isLoaded = false;
  }
}

// å…¨å±€é‡è¯•å‡½æ•°
window.retryConnection = function() {
  if (window.sidebarInstance) {
    window.sidebarInstance.showLoading();
    window.sidebarInstance.checkConnection();
    
    // é‡æ–°åŠ è½½iframe
    setTimeout(() => {
      if (window.sidebarInstance.iframe) {
        window.sidebarInstance.iframe.src = window.sidebarInstance.iframe.src;
      }
    }, 500);
  }
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  window.sidebarInstance = new ResearchopiaSidebar();
});

// é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
window.addEventListener('beforeunload', () => {
  if (window.sidebarInstance && window.sidebarInstance.iframe) {
    chrome.storage.sync.set({
      sidebarLastUrl: window.sidebarInstance.iframe.src
    });
  }
});