# 9.8 æœç´¢ä¼˜åŒ–æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆæ’ä»¶èƒ½åšåˆ°è€Œå®˜æ–¹ä»£ç ä¸è¡Œï¼Ÿ

## ğŸ¯ æ ¸å¿ƒç»“è®º

**Claude Sonnet çš„ç»“è®ºå­˜åœ¨è®¤çŸ¥ç›²ç‚¹**ï¼šé—®é¢˜ä¸åœ¨äº"å®˜æ–¹ä»£ç ä¸èƒ½ç”¨ CSS Overlay"ï¼Œè€Œåœ¨äº **ä»£ç æ‰§è¡Œæ—¶æœºå’Œä¸Šä¸‹æ–‡ä¸åŒ**ã€‚

## ğŸ” å…³é”®å‘ç°ï¼šçœŸæ­£çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ

### 1. ä»£ç æ‰§è¡Œç¯å¢ƒå¯¹æ¯”

| ç»´åº¦ | Better Notes æ’ä»¶ | å®˜æ–¹ note-editor |
|-----|------------------|------------------|
| **æ‰§è¡Œä¸Šä¸‹æ–‡** | å¤–éƒ¨ JavaScriptï¼ˆæ’ä»¶æ³¨å…¥ï¼‰ | ProseMirror Plugin å†…éƒ¨ |
| **äº‹ä»¶å¾ªç¯** | ç‹¬ç«‹çš„äº‹ä»¶é˜Ÿåˆ— | ä¸ ProseMirror äº‹åŠ¡å…±äº« |
| **DOM æ“ä½œ** | ç›´æ¥æ“ä½œ iframe.document | é€šè¿‡ `this.view.dom` |
| **é«˜äº®æ–¹å¼** | CSS Overlayï¼ˆç‹¬ç«‹å®¹å™¨ï¼‰ | DecorationSetï¼ˆPM å†…éƒ¨ï¼‰ |

### 2. ğŸ”´ è¢«å¿½ç•¥çš„çœŸç›¸ï¼š`dispatch(tr)` æ‰æ˜¯å…ƒå‡¶

```javascript
// å®˜æ–¹ search.js ä¸­çš„ updateView()
this.debounceTimer = setTimeout(() => {
    this.search(tr.doc);  // â† æœç´¢æœ¬èº«å¾ˆå¿«ï¼ˆ10-50msï¼‰
    
    // ğŸ”´ çœŸæ­£çš„ç“¶é¢ˆåœ¨è¿™é‡Œï¼
    this.decorations = DecorationSet.create(tr.doc, list);
    dispatch(tr);  // â† è¿™ä¼šè§¦å‘ ProseMirror å®Œæ•´æ¸²æŸ“å‘¨æœŸ
}, 500);
```

**å³ä½¿ debounce 500msï¼Œ`dispatch(tr)` ä»ç„¶ä¼šï¼š**
1. é‡æ–°è®¡ç®—æ•´ä¸ªæ–‡æ¡£çš„ AST
2. éªŒè¯æ‰€æœ‰ Decoration ä½ç½®
3. è§¦å‘ ViewPlugin çš„ update é’©å­
4. é‡ç»˜ DOMï¼ˆ500k æ–‡æ¡£ = å¤§é‡ DOM èŠ‚ç‚¹ï¼‰

### 3. ğŸŸ¢ æ’ä»¶ä¸ºä»€ä¹ˆä¸å¡ï¼Ÿ

```typescript
// Better Notes findbar.ts ä¸­çš„ createHighlightOverlays()
private createHighlightOverlays(): void {
    let container = this.doc.getElementById('custom-search-overlay-container');
    if (!container) {
        container = this.doc.createElement('div');
        container.id = 'custom-search-overlay-container';
        // å…³é”®ï¼špointer-events: none + ç‹¬ç«‹å®¹å™¨
        editorContainer.appendChild(container);  // â† ä¸è§¦å‘ ProseMirrorï¼
    }
    
    // ç›´æ¥æ“ä½œ DOMï¼Œå®Œå…¨ç»•è¿‡ ProseMirror äº‹åŠ¡ç³»ç»Ÿ
    for (let index = renderStart; index < renderEnd; index++) {
        const overlay = this.doc.createElement('div');
        container.appendChild(overlay);  // â† åŸç”Ÿ DOM æ“ä½œ
    }
}
```

**å…³é”®åŒºåˆ«**ï¼š
- âœ… æ’ä»¶çš„ CSS Overlay æ˜¯**ç‹¬ç«‹ DOM å®¹å™¨**ï¼Œä¸åœ¨ ProseMirror ç®¡è¾–èŒƒå›´å†…
- âœ… `appendChild` æ˜¯åŸç”Ÿ DOM æ“ä½œï¼Œä¸è§¦å‘ PM çš„ transaction/dispatch
- âœ… `pointer-events: none` ç¡®ä¿ä¸å½±å“ç¼–è¾‘å™¨äº¤äº’

## ğŸ§  ç¬¬ä¸€æ€§åŸç†åˆ†æ

### ä¸ºä»€ä¹ˆ Claude Sonnet çš„ç»“è®ºæ˜¯é”™è¯¯çš„ï¼Ÿ

**Sonnet çš„é€»è¾‘**ï¼š
> "ProseMirror Plugin å¿…é¡»ä½¿ç”¨ Decoration ç³»ç»Ÿ" â†’ "å®˜æ–¹ä»£ç ä¸èƒ½ç”¨ CSS Overlay"

**é—®é¢˜åœ¨äº**ï¼šè¿™æ˜¯å¯¹ ProseMirror Plugin API çš„**è¿‡åº¦è§£è¯»**ã€‚

**äº‹å®**ï¼š
1. Plugin çš„ `decorations` prop æ˜¯**å¯é€‰çš„**ï¼Œä¸æ˜¯å¼ºåˆ¶ä½¿ç”¨
2. Plugin å¯ä»¥åœ¨ `view` é’©å­ä¸­ç›´æ¥æ“ä½œ DOM
3. å…³é”®æ˜¯**ä¸è¦é€šè¿‡ `dispatch` è§¦å‘ transaction**

### ä¿®å¤æ€è·¯

```javascript
// å®˜æ–¹ search.js å¯ä»¥è¿™æ ·æ”¹é€ ï¼š
export function search() {
    return new Plugin({
        key: searchKey,
        view: (view) => {
            const pluginState = new Search();
            pluginState.view = view;
            
            // ğŸŸ¢ åˆ›å»ºç‹¬ç«‹çš„ overlay container
            pluginState.overlayContainer = createOverlayContainer(view.dom);
            
            return {
                update(view, lastState) {
                    // ğŸŸ¢ ç”¨ CSS Overlay è€Œé Decoration
                    pluginState.updateHighlights();  // ä¸è°ƒç”¨ dispatch!
                }
            };
        },
        // ğŸŸ¢ å…³é”®ï¼šä¸å†ä½¿ç”¨ decorations prop
        // props: { decorations(state) { ... } }  // åˆ é™¤è¿™ä¸ªï¼
    });
}
```

## ğŸ› ï¸ å¯è¡Œçš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šåœ¨å®˜æ–¹ä»£ç ä¸­å¼•å…¥ CSS Overlayï¼ˆæ¨èï¼‰

**ä¿®æ”¹ `search.js`**ï¼š
1. ç§»é™¤ `DecorationSet.create()` å’Œ `dispatch(tr)` çš„è°ƒç”¨
2. æ·»åŠ ç‹¬ç«‹çš„ `<div id="search-overlay-container">` 
3. ç”¨ `Range.getClientRects()` è®¡ç®—é«˜äº®ä½ç½®
4. ç›´æ¥æ“ä½œ DOM è€Œéé€šè¿‡ ProseMirror

**é¢„æœŸæ•ˆæœ**ï¼šæ€§èƒ½ä¸ Better Notes æ’ä»¶ä¸€è‡´

### æ–¹æ¡ˆ Bï¼šæ··åˆæ–¹æ¡ˆï¼ˆä¿å®ˆï¼‰

- å°‘é‡åŒ¹é…ï¼ˆ<50ï¼‰ï¼šä½¿ç”¨åŸç”Ÿ Decorationï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
- å¤§é‡åŒ¹é…ï¼ˆ>50ï¼‰ï¼šåˆ‡æ¢åˆ° CSS Overlay æ¨¡å¼

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åœ¨ `D:\AI\note-editor` ä¸­å®ç° CSS Overlay æ–¹æ¡ˆ**
2. **æµ‹è¯•æ€§èƒ½**ï¼šéªŒè¯æ˜¯å¦è¾¾åˆ°æ’ä»¶çº§åˆ«çš„æµç•…åº¦
3. **ç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½**ï¼šæ›¿æ¢ã€å¯¼èˆªã€é«˜äº®ç­‰
4. **å‡†å¤‡ PR**ï¼šè¯´æ˜è¿™æ˜¯æ¶æ„çº§ä¼˜åŒ–ï¼Œè€Œéç®€å•çš„ç®—æ³•è°ƒæ•´

## ğŸ¯ æ ¸å¿ƒæ´å¯Ÿ

> **æ’ä»¶èƒ½åšåˆ°ä¸æ˜¯å› ä¸ºå®ƒ"ä½œå¼Š"ï¼Œè€Œæ˜¯å› ä¸ºå®ƒæ­£ç¡®åœ°ç»•è¿‡äº† ProseMirror çš„ transaction ç³»ç»Ÿã€‚å®˜æ–¹ä»£ç å®Œå…¨å¯ä»¥é‡‡ç”¨ç›¸åŒçš„ç­–ç•¥ã€‚**

---

**æœ€åæ›´æ–°**: 2025-01-27  
**çŠ¶æ€**: ç­‰å¾…éªŒè¯å®ç°
