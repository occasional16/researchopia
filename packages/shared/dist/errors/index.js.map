{"version":3,"sources":["../../src/errors/index.ts"],"sourcesContent":["/**\r\n * 统一错误处理系统\r\n * 用于三端（网站、Zotero插件、浏览器扩展）的错误管理\r\n */\r\n\r\nexport enum ErrorCode {\r\n  // 网络错误 (1xxx)\r\n  NETWORK_ERROR = 1000,\r\n  NETWORK_TIMEOUT = 1001,\r\n  NETWORK_OFFLINE = 1002,\r\n\r\n  // 认证错误 (2xxx)\r\n  AUTH_INVALID_CREDENTIALS = 2000,\r\n  AUTH_TOKEN_EXPIRED = 2001,\r\n  AUTH_PERMISSION_DENIED = 2002,\r\n  AUTH_SESSION_INVALID = 2003,\r\n\r\n  // 数据错误 (3xxx)\r\n  DATA_NOT_FOUND = 3000,\r\n  DATA_VALIDATION_FAILED = 3001,\r\n  DATA_CONFLICT = 3002,\r\n  DATA_PARSE_ERROR = 3003,\r\n\r\n  // API错误 (4xxx)\r\n  API_INVALID_REQUEST = 4000,\r\n  API_RATE_LIMIT = 4001,\r\n  API_SERVER_ERROR = 4002,\r\n  API_BAD_RESPONSE = 4003,\r\n\r\n  // 业务逻辑错误 (5xxx)\r\n  ANNOTATION_SYNC_FAILED = 5000,\r\n  SESSION_JOIN_FAILED = 5001,\r\n  PAPER_REGISTRATION_FAILED = 5002,\r\n  PDF_LOAD_FAILED = 5003,\r\n  DOI_INVALID = 5004,\r\n\r\n  // 系统错误 (9xxx)\r\n  UNKNOWN_ERROR = 9000,\r\n}\r\n\r\nexport type ErrorSource = 'website' | 'zotero-plugin' | 'browser-extension';\r\n\r\nexport interface ErrorContext {\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Researchopia统一错误类\r\n * \r\n * @example\r\n * ```typescript\r\n * throw new ResearchopiaError(\r\n *   ErrorCode.AUTH_TOKEN_EXPIRED,\r\n *   'Access token has expired',\r\n *   'website',\r\n *   { userId: '123', token: 'xxx...' }\r\n * );\r\n * ```\r\n */\r\nexport class ResearchopiaError extends Error {\r\n  public readonly code: ErrorCode;\r\n  public readonly context?: ErrorContext;\r\n  public readonly timestamp: number;\r\n  public readonly source: ErrorSource;\r\n  public readonly originalError?: Error;\r\n\r\n  constructor(\r\n    code: ErrorCode,\r\n    message: string,\r\n    source: ErrorSource,\r\n    context?: ErrorContext,\r\n    originalError?: Error\r\n  ) {\r\n    super(message);\r\n    this.name = 'ResearchopiaError';\r\n    this.code = code;\r\n    this.context = context;\r\n    this.timestamp = Date.now();\r\n    this.source = source;\r\n    this.originalError = originalError;\r\n\r\n    // 保持原始错误堆栈\r\n    if (originalError && originalError.stack) {\r\n      this.stack = `${this.stack}\\nCaused by: ${originalError.stack}`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 转换为JSON格式（用于日志记录和网络传输）\r\n   */\r\n  toJSON() {\r\n    return {\r\n      name: this.name,\r\n      code: this.code,\r\n      message: this.message,\r\n      source: this.source,\r\n      context: this.context,\r\n      timestamp: this.timestamp,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 获取用户友好的错误消息\r\n   */\r\n  getUserMessage(): string {\r\n    const errorMessages: Record<ErrorCode, string> = {\r\n      // 网络错误\r\n      [ErrorCode.NETWORK_ERROR]: '网络连接失败，请检查网络设置',\r\n      [ErrorCode.NETWORK_TIMEOUT]: '请求超时，请稍后重试',\r\n      [ErrorCode.NETWORK_OFFLINE]: '当前处于离线状态，请检查网络连接',\r\n\r\n      // 认证错误\r\n      [ErrorCode.AUTH_INVALID_CREDENTIALS]: '用户名或密码错误',\r\n      [ErrorCode.AUTH_TOKEN_EXPIRED]: '登录已过期，请重新登录',\r\n      [ErrorCode.AUTH_PERMISSION_DENIED]: '您没有权限执行此操作',\r\n      [ErrorCode.AUTH_SESSION_INVALID]: '会话无效，请重新登录',\r\n\r\n      // 数据错误\r\n      [ErrorCode.DATA_NOT_FOUND]: '未找到请求的数据',\r\n      [ErrorCode.DATA_VALIDATION_FAILED]: '数据验证失败，请检查输入',\r\n      [ErrorCode.DATA_CONFLICT]: '数据冲突，请刷新后重试',\r\n      [ErrorCode.DATA_PARSE_ERROR]: '数据解析失败',\r\n\r\n      // API错误\r\n      [ErrorCode.API_INVALID_REQUEST]: '请求参数错误',\r\n      [ErrorCode.API_RATE_LIMIT]: '请求过于频繁，请稍后再试',\r\n      [ErrorCode.API_SERVER_ERROR]: '服务器错误，请稍后重试',\r\n      [ErrorCode.API_BAD_RESPONSE]: '服务器响应异常',\r\n\r\n      // 业务逻辑错误\r\n      [ErrorCode.ANNOTATION_SYNC_FAILED]: '标注同步失败',\r\n      [ErrorCode.SESSION_JOIN_FAILED]: '加入阅读会话失败',\r\n      [ErrorCode.PAPER_REGISTRATION_FAILED]: '论文注册失败',\r\n      [ErrorCode.PDF_LOAD_FAILED]: 'PDF加载失败',\r\n      [ErrorCode.DOI_INVALID]: 'DOI格式无效',\r\n\r\n      // 系统错误\r\n      [ErrorCode.UNKNOWN_ERROR]: '发生未知错误',\r\n    };\r\n\r\n    return errorMessages[this.code] || this.message;\r\n  }\r\n\r\n  /**\r\n   * 判断是否为可重试错误\r\n   */\r\n  isRetryable(): boolean {\r\n    const retryableCodes = [\r\n      ErrorCode.NETWORK_ERROR,\r\n      ErrorCode.NETWORK_TIMEOUT,\r\n      ErrorCode.API_RATE_LIMIT,\r\n      ErrorCode.API_SERVER_ERROR,\r\n    ];\r\n    return retryableCodes.includes(this.code);\r\n  }\r\n\r\n  /**\r\n   * 判断是否为需要重新认证的错误\r\n   */\r\n  requiresReauth(): boolean {\r\n    const reauthCodes = [\r\n      ErrorCode.AUTH_TOKEN_EXPIRED,\r\n      ErrorCode.AUTH_SESSION_INVALID,\r\n    ];\r\n    return reauthCodes.includes(this.code);\r\n  }\r\n}\r\n\r\n/**\r\n * 错误处理工具函数\r\n */\r\nexport class ErrorHandler {\r\n  /**\r\n   * 将任意错误转换为ResearchopiaError\r\n   */\r\n  static normalize(\r\n    error: unknown,\r\n    source: ErrorSource,\r\n    defaultCode = ErrorCode.UNKNOWN_ERROR\r\n  ): ResearchopiaError {\r\n    if (error instanceof ResearchopiaError) {\r\n      return error;\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      return new ResearchopiaError(\r\n        defaultCode,\r\n        error.message,\r\n        source,\r\n        undefined,\r\n        error\r\n      );\r\n    }\r\n\r\n    return new ResearchopiaError(\r\n      defaultCode,\r\n      String(error),\r\n      source\r\n    );\r\n  }\r\n\r\n  /**\r\n   * 记录错误（可扩展到远程日志服务）\r\n   */\r\n  static log(error: ResearchopiaError): void {\r\n    console.error('[Researchopia Error]', {\r\n      code: error.code,\r\n      message: error.message,\r\n      source: error.source,\r\n      context: error.context,\r\n      timestamp: new Date(error.timestamp).toISOString(),\r\n    });\r\n\r\n    if (error.originalError) {\r\n      console.error('[Original Error]', error.originalError);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理错误（记录 + 可选的用户提示）\r\n   */\r\n  static handle(\r\n    error: unknown,\r\n    source: ErrorSource,\r\n    options?: {\r\n      showToUser?: boolean;\r\n      onUserMessage?: (message: string) => void;\r\n    }\r\n  ): ResearchopiaError {\r\n    const normalizedError = this.normalize(error, source);\r\n    this.log(normalizedError);\r\n\r\n    if (options?.showToUser && options?.onUserMessage) {\r\n      options.onUserMessage(normalizedError.getUserMessage());\r\n    }\r\n\r\n    return normalizedError;\r\n  }\r\n}\r\n\r\n/**\r\n * 创建特定类型错误的便捷函数\r\n */\r\nexport const createError = {\r\n  network: (message: string, source: ErrorSource, context?: ErrorContext) =>\r\n    new ResearchopiaError(ErrorCode.NETWORK_ERROR, message, source, context),\r\n\r\n  auth: (message: string, source: ErrorSource, context?: ErrorContext) =>\r\n    new ResearchopiaError(ErrorCode.AUTH_INVALID_CREDENTIALS, message, source, context),\r\n\r\n  notFound: (message: string, source: ErrorSource, context?: ErrorContext) =>\r\n    new ResearchopiaError(ErrorCode.DATA_NOT_FOUND, message, source, context),\r\n\r\n  validation: (message: string, source: ErrorSource, context?: ErrorContext) =>\r\n    new ResearchopiaError(ErrorCode.DATA_VALIDATION_FAILED, message, source, context),\r\n\r\n  api: (message: string, source: ErrorSource, context?: ErrorContext) =>\r\n    new ResearchopiaError(ErrorCode.API_SERVER_ERROR, message, source, context),\r\n};\r\n"],"mappings":"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","names":["ErrorCode"]}