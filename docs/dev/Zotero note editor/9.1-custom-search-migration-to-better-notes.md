# 9.1 CustomSearch è¿ç§»åˆ° zotero-better-notes æ–¹æ¡ˆ

**ç›®æ ‡**: å°† Researchopia çš„ CustomSearch åŠŸèƒ½è¿ç§»åˆ° zotero-better-notes å¹¶æäº¤ PR

---

## ğŸ“¦ å½“å‰æ¨¡å—æ¸…å•

```
src/modules/customSearch/
â”œâ”€â”€ manager.ts        (278è¡Œ) - ä¸»æ§åˆ¶å™¨ï¼ŒHookæ³¨å…¥
â”œâ”€â”€ asyncEngine.ts    (63è¡Œ)  - å¼‚æ­¥æœç´¢å¼•æ“
â”œâ”€â”€ searchDialog.ts   (78è¡Œ)  - ç»“æœå¯¹è¯æ¡†
â”œâ”€â”€ types.ts          (16è¡Œ)  - TypeScriptç±»å‹
â””â”€â”€ index.ts          (9è¡Œ)   - æ¨¡å—å¯¼å‡º

é…ç½®æ–‡ä»¶:
- addon/content/preferences.xhtml (åå¥½è®¾ç½®UI)
- addon/prefs.js (é»˜è®¤å€¼: customSearch=true)
```

**æ ¸å¿ƒåŠŸèƒ½**:
- Hook `Zotero.Notes.registerEditorInstance` æ³¨å…¥æŒ‰é’®
- `waitForEditor()` è½®è¯¢ç­‰å¾… iframe
- å·¥å…·æ æŒ‰é’® (`.toolbar .start`)
- å¿«æ·é”® `Ctrl+Shift+F`
- æ­£åˆ™/å¤§å°å†™æ•æ„Ÿæœç´¢
- ç»“æœå¯¹è¯æ¡† + è·³è½¬å®šä½

---

## ğŸ”„ è¿ç§»æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (5min)

```powershell
cd D:\AI\zotero-better-notes
git checkout -b feature/custom-search
tree /F src\modules\editor  # æŸ¥çœ‹å·¥å…·æ ç®¡ç†ä»£ç 
```

**éœ€è¦ç¡®è®¤**:
1. æ—¥å¿—ç³»ç»Ÿ: æœç´¢ `.log(` æ‰¾åˆ° logger ç”¨æ³•
2. Hookä½ç½®: æœç´¢ `registerEditorInstance`
3. åå¥½è®¾ç½®: æŸ¥æ‰¾ `addon/prefs/` æˆ– `defaults/preferences/`
4. å‘½åç©ºé—´: æœç´¢ `Zotero.BetterNotes`

---

### Phase 2: æ–‡ä»¶å¤åˆ¶ (10min)

```powershell
# åˆ›å»ºç›®å½•
New-Item -ItemType Directory -Path "src\modules\customSearch" -Force

# å¤åˆ¶æ¨¡å—
Copy-Item "D:\AI\Researchopia\zotero-plugin\src\modules\customSearch\*" `
  -Destination "src\modules\customSearch\" -Recurse
```

---

### Phase 3: ä»£ç é€‚é… (15min)

**å…³é”®ä¿®æ”¹ç‚¹**:

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| **manager.ts** | 1. æ›¿æ¢ logger (Researchopia â†’ better-notes)<br>2. ä¿®æ”¹å‘½åç©ºé—´ `(Zotero as any).Researchopia` â†’ `BetterNotes`<br>3. ä¿®æ”¹åå¥½è®¾ç½®å‰ç¼€ |
| **searchDialog.ts** | ç»Ÿä¸€å¯¹è¯æ¡†æ ·å¼ (å‚è€ƒ better-notes UIç»„ä»¶) |
| **åå¥½è®¾ç½®** | æ·»åŠ  `extensions.zotero.betternotes.customSearch` |

**Logger æ›¿æ¢ç¤ºä¾‹**:
```typescript
// æœç´¢: logger.warn
// æ›¿æ¢ä¸º: ztoolkit.log (éœ€ç¡®è®¤å®é™…ç”¨æ³•)
```

**Hook é›†æˆ**:
- å¦‚æœ better-notes å·²æœ‰ Hook â†’ åœ¨ç°æœ‰é€»è¾‘ä¸­**æ·»åŠ **æŒ‰é’®æ³¨å…¥
- å¦‚æœæ²¡æœ‰ â†’ ç›´æ¥ä½¿ç”¨ manager.ts çš„ Hook æœºåˆ¶

---

### Phase 4: åå¥½è®¾ç½®é›†æˆ (10min)

åœ¨ better-notes çš„åå¥½è®¾ç½®æ–‡ä»¶æ·»åŠ :
```javascript
pref("extensions.zotero.betternotes.customSearch", true);
```

åœ¨è®¾ç½®é¢æ¿ UI æ·»åŠ å¤é€‰æ¡† (å‚è€ƒ better-notes ç°æœ‰è®¾ç½®æ ¼å¼)

---

### Phase 5: æµ‹è¯• (20min)

```powershell
npm install
npm run build
# åœ¨ Zotero ä¸­åŠ è½½æµ‹è¯•
```

**æµ‹è¯•æ¸…å•**:
- [ ] æŒ‰é’®æ˜¾ç¤ºåœ¨ `.toolbar .start`
- [ ] `Ctrl+Shift+F` è§¦å‘æœç´¢
- [ ] è¾“å…¥å…³é”®è¯æ˜¾ç¤ºç»“æœ
- [ ] ç‚¹å‡»ç»“æœè·³è½¬æ­£ç¡®
- [ ] åå¥½è®¾ç½®å¼€å…³ç”Ÿæ•ˆ
- [ ] æ­£åˆ™/å¤§å°å†™æ¨¡å¼æ­£å¸¸

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¯èƒ½çš„å†²çªç‚¹

1. **é‡å¤ Hook**: 
   - better-notes å¯èƒ½å·² Hook `registerEditorInstance`
   - éœ€è¦åˆå¹¶é€»è¾‘ï¼Œä¸èƒ½é‡å¤æ›¿æ¢

2. **å·¥å…·æ ä½ç½®**:
   - ç¡®è®¤ better-notes çš„å·¥å…·æ ç»“æ„
   - `.toolbar .start` å¯èƒ½éœ€è¦è°ƒæ•´

3. **å¯¹è¯æ¡†æ ·å¼**:
   - ä½¿ç”¨ better-notes çš„ CSS å˜é‡
   - ä¿æŒè§†è§‰ä¸€è‡´æ€§

---

## ğŸ“‹ PR å‡†å¤‡

### åˆ†æ”¯å‘½å
```bash
feature/custom-search
```

### Commit ä¿¡æ¯
```
feat: add custom search button to note toolbar

- Hook Zotero.Notes.registerEditorInstance to inject button
- Support Ctrl+Shift+F keyboard shortcut
- Async search engine with regex support
- Result dialog with jump-to-line functionality
- Add preference toggle (default: enabled)
```

### PR æè¿°æ¨¡æ¿
```markdown
## åŠŸèƒ½è¯´æ˜
åœ¨ç¬”è®°ç¼–è¾‘å™¨å·¥å…·æ æ·»åŠ è‡ªå®šä¹‰æœç´¢æŒ‰é’®ï¼Œæä¾›å¢å¼ºçš„æœç´¢åŠŸèƒ½ã€‚

## ä¸»è¦ç‰¹æ€§
- ğŸ” å·¥å…·æ æœç´¢æŒ‰é’® (ä½äºå·¦ä¾§åŒºåŸŸ)
- âŒ¨ï¸ é”®ç›˜å¿«æ·é”® Ctrl+Shift+F
- ğŸ¯ æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼å’Œå¤§å°å†™æ•æ„Ÿæœç´¢
- ğŸ“ ç»“æœåˆ—è¡¨æ”¯æŒç‚¹å‡»è·³è½¬
- âš™ï¸ åå¥½è®¾ç½®å¼€å…³æ§åˆ¶

## ä½¿ç”¨æ–¹æ³•
1. æ‰“å¼€ç¬”è®°ç¼–è¾‘å™¨
2. ç‚¹å‡»å·¥å…·æ æœç´¢å›¾æ ‡ æˆ– æŒ‰ Ctrl+Shift+F
3. è¾“å…¥æœç´¢å…³é”®è¯
4. åœ¨ç»“æœåˆ—è¡¨ä¸­ç‚¹å‡»è·³è½¬

## æµ‹è¯•æˆªå›¾
[TODO: æ·»åŠ æˆªå›¾]

## ç›¸å…³ Issue
Closes #XXX (å¦‚æœ‰)
```

---

## ğŸ“ éœ€è¦åé¦ˆçš„ä¿¡æ¯

åœ¨å¼€å§‹è¿ç§»å‰ï¼Œè¯·ç¡®è®¤:

1. **better-notes æ—¥å¿—ç³»ç»Ÿ**: æ˜¯ `ztoolkit.log()` è¿˜æ˜¯å…¶ä»–?
2. **ç°æœ‰ Hook**: æ˜¯å¦å·²æœ‰ `registerEditorInstance` Hook?
3. **åå¥½è®¾ç½®è·¯å¾„**: æ–‡ä»¶ä½ç½®?
4. **å‘½åç©ºé—´**: `Zotero.BetterNotes` æ˜¯å¦æ­£ç¡®?

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26  
**çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·åé¦ˆ
