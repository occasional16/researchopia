# 1.4.12 Shared Annotations Sidebar Tab è®¾è®¡ä¸å®æ–½æ–¹æ¡ˆ

**æ–‡æ¡£ç¼–å·**: 1.4.12  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-21  
**ç‰ˆæœ¬**: v2.0 (å®Œæ•´ä¿®è®¢ç‰ˆ)  
**çŠ¶æ€**: âœ… æ¶æ„è¯„å®¡é€šè¿‡,å¯å¼€å§‹Phase 2å®æ–½

**å…³è”æ–‡æ¡£**: 
- [1.4.11 Jasminumæ’ä»¶Sidebarè‡ªå®šä¹‰Tabè®¾è®¡ç ”ç©¶](./1.4.11-JASMINUM_SIDEBAR_TAB_DESIGN.md)
- `zotero-plugin\src\modules\ui\sessionAnnotationsView.ts` (åŠŸèƒ½å‚è€ƒ)
- `zotero-plugin\src\modules\sidebarAnnotationEnhancer.ts` (UIå‚è€ƒ)
- `zotero-plugin\src\modules\pdf\PDFReaderCoordinator.ts` (è·³è½¬API)

---

## ä¸€ã€è®¾è®¡ç›®æ ‡ä¸ä»·å€¼

### 1.1 åŠŸèƒ½å®šä½

åœ¨Zotero Readerå·¦ä¾§Sidebaræ–°å¢**Shared Annotations Tab**,å±•ç¤ºå½“å‰æ–‡çŒ®çš„**æ‰€æœ‰ç”¨æˆ·å…±äº«æ ‡æ³¨**ã€‚

**æ ¸å¿ƒå·®å¼‚åŒ–**:
- **åŸç”ŸAnnotations Tab**: ä»…æ˜¾ç¤ºæœ¬åœ°/æˆ‘çš„æ ‡æ³¨ (Zoteroé»˜è®¤è¡Œä¸º)
- **Shared Annotations Tab**: æ˜¾ç¤ºæ‰€æœ‰äººçš„å…¬å¼€æ ‡æ³¨ (ç¤¾åŒº/ä¼šè¯è§†å›¾)

### 1.2 ä¸šåŠ¡ä»·å€¼

| ä½¿ç”¨åœºæ™¯ | ä»·å€¼ | ç”¨æˆ·è§’è‰² |
|---------|------|---------|
| æŸ¥çœ‹åŒè¡Œè§‚ç‚¹ | å¿«é€Ÿäº†è§£å…¶ä»–ç ”ç©¶è€…å¯¹åŒä¸€æ–‡çŒ®çš„æ ‡æ³¨å’Œè¯„è®º | ç ”ç©¶è€… |
| æ–‡çŒ®å…±è¯» | åœ¨ä¼šè¯ä¸­æŸ¥çœ‹æ‰€æœ‰æˆå‘˜çš„æ ‡æ³¨,ä¿ƒè¿›åä½œè®¨è®º | å­¦ä¹ å°ç»„ |
| çŸ¥è¯†å‘ç° | å‘ç°çƒ­ç‚¹æ®µè½å’Œé«˜è´¨é‡æ‰¹æ³¨,æå‡é˜…è¯»æ•ˆç‡ | å­¦ç”Ÿ/è‡ªå­¦è€… |

### 1.3 æŠ€æœ¯ç›®æ ‡

- âœ… **åŸç”Ÿä½“éªŒ**: ä¸ZoteroåŸç”ŸTabæ— ç¼é›†æˆ
- âœ… **æ€§èƒ½ä¼˜å…ˆ**: æ‡’åŠ è½½æ•°æ®,ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
- âœ… **ä»£ç å¤ç”¨**: æœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰æ¨¡å— (APIClient, UserHoverCardç­‰)
- âœ… **ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ¨¡å—èŒè´£,é¿å…ä¸ç°æœ‰åŠŸèƒ½è€¦åˆ

---

## äºŒã€UIæ¶æ„è®¾è®¡

### 2.1 å…¥å£æŒ‰é’® (Sidebar Toolbar Button)

**æ’å…¥ä½ç½®**: `#sidebarContainer div.start` (Annotationså’ŒOutlineä¹‹é—´)

**è®¾è®¡è§„æ ¼**:
```html
<button 
  id="researchopia-shared-annotations-button"
  class="researchopia-toolbar-button"
  role="tab"
  aria-selected="false"
  aria-controls="researchopia-shared-annotations-view"
  title="Shared Annotations">
  ğŸ‘¥
</button>
```

**æ ·å¼è¦æ±‚**:
- å›¾æ ‡: `ğŸ‘¥` (ç¾¤ç»„å›¾æ ‡,è¯­ä¹‰æ˜ç¡®)
- å­—ä½“å¤§å°: `16px` (ä¸åŸç”ŸæŒ‰é’®ä¸€è‡´)
- æ¿€æ´»çŠ¶æ€: ä½¿ç”¨ `.selected` CSSç±» (ZoteroåŸç”Ÿæ ·å¼)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ (Phase 1)
- æ–‡ä»¶: `sidebarSharedView.ts:373-410`
- ä½ç½®: ä½¿ç”¨ `insertBefore(button, outlineButton)` æ’å…¥

### 2.2 å†…å®¹å®¹å™¨ (Content Panel)

**æ’å…¥ä½ç½®**: `#sidebarContent` (ä¸ `#annotationsView` å¹³çº§)

**DOMç»“æ„**:
```html
<div id="researchopia-shared-annotations-view" 
     class="hidden"
     role="tabpanel"
     aria-labelledby="researchopia-shared-annotations-button">
  
  <!-- 1. é¡¶éƒ¨å·¥å…·æ  (å›ºå®š) -->
  <div class="shared-annotations-toolbar">
    <select id="filter-scope">
      <option>å…¨éƒ¨å…±äº«</option>
      <option>ä»…å…³æ³¨</option>
      <option>å½“å‰ä¼šè¯</option>
    </select>
    <button id="refresh-btn">ğŸ”„</button>
  </div>

  <!-- 2. æ ‡æ³¨åˆ—è¡¨ (æ»šåŠ¨åŒºåŸŸ) -->
  <div class="shared-annotations-list" style="overflow-y: auto;">
    <!-- åŠ¨æ€æ’å…¥æ ‡æ³¨å¡ç‰‡ -->
  </div>
</div>
```

**å¯è§æ€§æ§åˆ¶**:
- ä½¿ç”¨ `.hidden` CSSç±» (display: none !important)
- **ä¸ä½¿ç”¨** å†…è” `style.display` (é¿å…æ ·å¼å†²çª)
- é€šè¿‡ `hideMyView()` / `showMyView()` æ–¹æ³•åˆ‡æ¢

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ (Phase 1)
- æ–‡ä»¶: `sidebarSharedView.ts:412-481`
- å½“å‰æ˜¾ç¤ºå ä½å†…å®¹ "(Phase 1: Framework Ready)"

---

## ä¸‰ã€æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

### 3.1 åˆå§‹åŒ–ä¸äº‹ä»¶æ³¨å†Œ

**äº‹ä»¶ç›‘å¬ç­–ç•¥**:
```typescript
// 1ï¸âƒ£ renderToolbar - Readeråˆå§‹æ‰“å¼€æ—¶è§¦å‘
Zotero.Reader.registerEventListener('renderToolbar', async (event) => {
  const { reader, doc } = event;
  await this.init(doc, reader); // æ³¨å…¥æŒ‰é’®+å®¹å™¨+äº‹ä»¶
}, addonID);

// 2ï¸âƒ£ renderSidebarAnnotationHeader - Toggle sidebaré‡å»ºDOMæ—¶è§¦å‘
Zotero.Reader.registerEventListener('renderSidebarAnnotationHeader', async (event) => {
  const { reader, doc } = event;
  
  // æ£€æµ‹DOMä¸¢å¤±å¹¶é‡æ–°æ³¨å…¥ (å«10æ¬¡Ã—100msé‡è¯•é€»è¾‘)
  if (this.registeredReaders.has(reader.tabID) && !doc.getElementById('researchopia-shared-annotations-button')) {
    logger.warn('âš ï¸ Tab DOM lost (Toggle detected), re-injecting...');
    this.registeredReaders.delete(reader.tabID);
    // é‡è¯•é€»è¾‘...
  }
}, addonID);
```

**é˜²å¾¡æ€§æªæ–½**:
- âœ… Toggle sidebaråè‡ªåŠ¨æ¢å¤ (å·²æµ‹è¯•é€šè¿‡)
- âœ… å¤šReaderå®ä¾‹éš”ç¦» (registeredReaders Map)
- âœ… DOMç­‰å¾…é‡è¯• (å¤„ç†å¼‚æ­¥æ¸²æŸ“)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ
- æ–‡ä»¶: `sidebarSharedView.ts:28-78` (registeræ–¹æ³•)
- Commit: `0828941c` (2025-11-21)

### 3.2 Tabåˆ‡æ¢é€»è¾‘ âš ï¸ å…³é”®ä¿®æ­£

**âŒ é”™è¯¯åšæ³•** (ä¼šå¯¼è‡´TypeError):
```typescript
// ç¦æ­¢è°ƒç”¨ reader.setSidebarView() !
reader.setSidebarView('researchopia-shared'); // âŒ this._onChangeSidebarView is not a function
```

**âœ… æ­£ç¡®åšæ³•** (çº¯DOMæ§åˆ¶):
```typescript
/**
 * æ˜¾ç¤ºè‡ªå®šä¹‰è§†å›¾
 */
private showMyView(doc: Document) {
  // 1. éšè—æ‰€æœ‰åŸç”Ÿè§†å›¾
  ['annotationsView', 'thumbnailView', 'outlineView'].forEach(id => {
    const view = doc.getElementById(id);
    if (view && !view.classList.contains('hidden')) {
      view.classList.add('hidden');
    }
  });
  
  // 2. æ˜¾ç¤ºè‡ªå®šä¹‰è§†å›¾
  const myView = doc.getElementById('researchopia-shared-annotations-view');
  if (myView?.classList.contains('hidden')) {
    myView.classList.remove('hidden');
  }
  
  // 3. æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
  this.updateButtonStates(doc, 'researchopia-shared-annotations-button');
}

/**
 * éšè—è‡ªå®šä¹‰è§†å›¾ (åˆ‡æ¢åˆ°åŸç”ŸTabæ—¶)
 */
private hideMyView(doc: Document) {
  const myView = doc.getElementById('researchopia-shared-annotations-view');
  if (myView && !myView.classList.contains('hidden')) {
    myView.classList.add('hidden');
  }
  
  // æ˜¾ç¤ºç›®æ ‡åŸç”Ÿè§†å›¾ (é€šè¿‡äº‹ä»¶è·å–)
}
```

**CSSæ ·å¼**:
```css
.hidden {
  display: none !important;
}

button.selected {
  background: var(--fill-secondary) !important;
}
```

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ
- æ–‡ä»¶: `sidebarSharedView.ts:465-520` (hideMyView)
- æ–‡ä»¶: `sidebarSharedView.ts:522-576` (showMyView)

### 3.3 æ•°æ®åŠ è½½æµç¨‹ (Phase 2 å¾…å®æ–½)

**æ•°æ®é“¾è·¯**:
```
Reader.itemID â†’ Zotero Item â†’ DOI â†’ Supabase Document ID â†’ Shared Annotations
```

**å®ç°ä¼ªä»£ç **:
```typescript
/**
 * åŠ è½½å…±äº«æ ‡æ³¨
 */
private async loadAnnotations(reader: any, doc: Document): Promise<void> {
  try {
    // 1. è·å–å½“å‰æ–‡çŒ®DOI
    const item = Zotero.Items.get(reader.itemID);
    const doi = item.getField('DOI');
    
    if (!doi) {
      this.showEmptyState(doc, 'å½“å‰æ–‡çŒ®æ— DOI,æ— æ³•åŠ è½½å…±äº«æ ‡æ³¨');
      return;
    }
    
    // 2. æŸ¥è¯¢Supabase Document ID (å¸¦ç¼“å­˜)
    let documentId = this.documentCache.get(doi);
    if (!documentId) {
      const response = await this.apiClient.get('/api/proxy/documents', { doi });
      documentId = response.data.id;
      this.documentCache.set(doi, documentId);
    }
    
    // 3. è·å–å…±äº«æ ‡æ³¨ (type=all è·å–æ‰€æœ‰ç”¨æˆ·çš„æ ‡æ³¨)
    const annotations = await this.apiClient.get('/api/proxy/annotations', {
      document_id: documentId,
      type: 'all', // æˆ– 'public' (å–å†³äºAPIè®¾è®¡)
      order: 'created_at.desc' // æœ€æ–°ä¼˜å…ˆ
    });
    
    // 4. æ¸²æŸ“æ ‡æ³¨åˆ—è¡¨
    this.renderAnnotationList(annotations.data, doc);
    
  } catch (error) {
    logger.error('[SidebarSharedView] Failed to load annotations:', error);
    this.showErrorState(doc, 'åŠ è½½å¤±è´¥,è¯·åˆ·æ–°é‡è¯•');
  }
}
```

**APIå‚æ•°è¯´æ˜**:
- `type=all`: è·å–æ‰€æœ‰ç”¨æˆ·çš„å…±äº«æ ‡æ³¨ (vs `type=my` ä»…æˆ‘çš„)
- `visibility=public`: ä»…å…¬å¼€æ ‡æ³¨ (æ’é™¤ç§å¯†æ ‡æ³¨)
- `session_id` (å¯é€‰): ç­›é€‰ç‰¹å®šä¼šè¯çš„æ ‡æ³¨

**ç¼“å­˜ç­–ç•¥**:
- DOI â†’ Document ID: æ°¸ä¹…ç¼“å­˜ (Map)
- æ ‡æ³¨æ•°æ®: 5åˆ†é’Ÿè¿‡æœŸ (å¸¦åˆ·æ–°æŒ‰é’®)

### 3.4 æ ‡æ³¨å¡ç‰‡æ¸²æŸ“ (Phase 2 å¾…å®æ–½)

**HTMLç»“æ„** (ç®€åŒ–ç‰ˆ,é€‚é…Sidebarçª„å®½åº¦):
```html
<div class="shared-annotation-card" data-annotation-id="xxx">
  <!-- å¤´éƒ¨: ç”¨æˆ·ä¿¡æ¯ -->
  <div class="card-header">
    <img class="avatar" src="..." />
    <div class="user-info">
      <span class="username">@admin</span>
      <span class="timestamp">2å°æ—¶å‰</span>
    </div>
  </div>
  
  <!-- æ ‡æ³¨æ–‡æœ¬ (é«˜äº®é¢œè‰²) -->
  <div class="annotation-body" style="border-left: 3px solid #FFEB3B;">
    <p class="annotation-text">è¿™æ˜¯æ ‡æ³¨çš„å†…å®¹...</p>
    <span class="page-number">p.5</span>
  </div>
  
  <!-- ç¤¾äº¤æŒ‰é’® -->
  <div class="social-actions">
    <button class="like-btn">â¤ï¸ <span>12</span></button>
    <button class="comment-btn">ğŸ’¬ <span>3</span></button>
  </div>
  
  <!-- è¯„è®ºåŒº (å±•å¼€æ—¶æ˜¾ç¤º) -->
  <div class="comments-section hidden">
    <!-- è¯„è®ºæ ‘æ¸²æŸ“ -->
  </div>
</div>
```

**æ ·å¼é€‚é…**:
```css
.shared-annotation-card {
  padding: 10px;
  border-bottom: 1px solid var(--material-divider);
  cursor: pointer;
  transition: background 0.2s;
}

.shared-annotation-card:hover {
  background: var(--fill-quinary);
}

/* Sidebarçª„å®½åº¦ä¼˜åŒ– */
.annotation-body {
  font-size: 13px; /* æ¯”SessionViewå°1px */
  line-height: 1.4;
  max-width: 100%;
  word-wrap: break-word;
}

.avatar {
  width: 24px; /* æ¯”SessionViewå°4px */
  height: 24px;
  border-radius: 50%;
}
```

**æ¸²æŸ“é€»è¾‘**:
```typescript
/**
 * æ¸²æŸ“å•ä¸ªæ ‡æ³¨å¡ç‰‡
 */
private renderAnnotationCard(annotation: any, doc: Document): HTMLElement {
  const card = doc.createElement('div');
  card.className = 'shared-annotation-card';
  card.dataset.annotationId = annotation.id;
  
  // æ„å»ºHTML (çœç•¥è¯¦ç»†ä»£ç )
  card.innerHTML = `...`;
  
  // 1. ç‚¹å‡»è·³è½¬åˆ°æ ‡æ³¨ä½ç½®
  card.addEventListener('click', async (e) => {
    if ((e.target as HTMLElement).closest('.social-actions')) return; // é¿å…å†²çª
    await this.navigateToAnnotation(annotation);
  });
  
  // 2. ç»‘å®šç”¨æˆ·å¡ç‰‡ (Hoveræ˜¾ç¤º)
  const userInfo = card.querySelector('.user-info');
  this.userHoverCardManager.attachToElement(userInfo, annotation.user_id);
  
  // 3. ç‚¹èµæŒ‰é’®
  const likeBtn = card.querySelector('.like-btn');
  likeBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    await this.handleLike(annotation.id);
  });
  
  // 4. è¯„è®ºæŒ‰é’®
  const commentBtn = card.querySelector('.comment-btn');
  commentBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    this.toggleComments(card, annotation.id);
  });
  
  return card;
}
```

**æ¨¡å—å¤ç”¨**:
- `UserHoverCardManager`: âœ… ç›´æ¥å®ä¾‹åŒ– (å·²åœ¨constructorä¸­åˆ›å»º)
- `CommentRenderer`: âœ… åç»­Phase 3å¼•å…¥ (è¯„è®ºæ ‘æ¸²æŸ“)
- `SupabaseManager`: âœ… ç”¨äºç‚¹èµAPI (`likeAnnotation()`)

### 3.5 æ ‡æ³¨è·³è½¬åŠŸèƒ½ âš ï¸ å…³é”®ä¿®æ­£

**âŒ é”™è¯¯åšæ³•** (ä¸å¤„ç†ç‰ˆæœ¬å…¼å®¹):
```typescript
reader.navigate(position); // âŒ Zotero 8å¯èƒ½ä¸æ”¯æŒ
```

**âœ… æ­£ç¡®åšæ³•** (ä½¿ç”¨PDFReaderManager):
```typescript
/**
 * è·³è½¬åˆ°æ ‡æ³¨ä½ç½®
 * å¤ç”¨ SessionAnnotationsView çš„æˆç†Ÿæ–¹æ¡ˆ
 */
private async navigateToAnnotation(annotation: any): Promise<void> {
  try {
    // 1. æ‡’åŠ è½½ PDFReaderManager (é¿å…å¾ªç¯ä¾èµ–)
    const pdfManager = await this.getPDFReaderManager();
    if (!pdfManager) {
      logger.error('[SidebarSharedView] PDFReaderManager not available');
      return;
    }
    
    // 2. è°ƒç”¨è·³è½¬æ–¹æ³• (è‡ªåŠ¨å¤„ç† Zotero 7/8 å·®å¼‚)
    await pdfManager.navigateToAnnotation(
      this.currentReader, // ä¿å­˜å½“å‰readerå¼•ç”¨
      annotation.position // { pageIndex, rects } æ ¼å¼
    );
    
    logger.log(`[SidebarSharedView] Navigated to annotation: ${annotation.id}`);
    
  } catch (error) {
    logger.error('[SidebarSharedView] Navigation failed:', error);
  }
}

/**
 * è·å–PDFReaderManagerå®ä¾‹ (æ‡’åŠ è½½)
 * å‚è€ƒ: sessionAnnotationsView.ts:47-70
 */
private async getPDFReaderManager(): Promise<any | null> {
  if (this.pdfReaderManager) {
    return this.pdfReaderManager;
  }
  
  // ä»å…¨å±€Zoteroå¯¹è±¡è·å–
  const addon = (Zotero as any).Researchopia;
  if (addon?._pdfReaderManager) {
    this.pdfReaderManager = addon._pdfReaderManager;
    return this.pdfReaderManager;
  }
  
  // åŠ¨æ€å¯¼å…¥å¹¶åˆå§‹åŒ–
  try {
    const { PDFReaderManager } = await import('../pdf');
    const manager = PDFReaderManager.getInstance();
    await manager.initialize();
    if (addon) {
      addon._pdfReaderManager = manager;
    }
    this.pdfReaderManager = manager;
    return manager;
  } catch (error) {
    logger.error('[SidebarSharedView] Failed to load PDFReaderManager:', error);
    return null;
  }
}
```

**ç‰ˆæœ¬å…¼å®¹å¤„ç†** (PDFReaderCoordinator.ts:705-719):
```typescript
// PDFReaderManagerå†…éƒ¨å®ç°
async navigateToAnnotation(reader: any, position: any) {
  // Zotero 8: æ–°API
  if (typeof reader.navigateToPosition === 'function') {
    reader.navigateToPosition(position);
    return true;
  }
  
  // Zotero 7: æ—§API
  if (typeof reader.navigate === 'function') {
    reader.navigate({ position });
    return true;
  }
  
  throw new Error('No navigation method available');
}
```

**å®ç°è¦ç‚¹**:
- æ‡’åŠ è½½é¿å…å¾ªç¯ä¾èµ–
- å…¨å±€ç¼“å­˜é¿å…é‡å¤åˆå§‹åŒ–
- ç‰ˆæœ¬æ£€æµ‹è‡ªåŠ¨åˆ‡æ¢API

---

## å››ã€åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¡†æ¶ âœ… å·²å®Œæˆ

**å·¥ä½œå†…å®¹**:
- [x] åˆ›å»º `sidebarSharedView.ts` ç±»
- [x] æ³¨å†Œ `renderToolbar` å’Œ `renderSidebarAnnotationHeader` äº‹ä»¶
- [x] å®ç°æŒ‰é’®å’Œå®¹å™¨æ³¨å…¥é€»è¾‘
- [x] å®ç°Tabåˆ‡æ¢é€»è¾‘ (çº¯CSSæ§åˆ¶)
- [x] å¤„ç†Toggle sidebar DOMé‡å»ºé—®é¢˜ (10æ¬¡é‡è¯•)

**ä»£ç çŠ¶æ€**:
- æ–‡ä»¶: `src/modules/ui/sidebarSharedView.ts` (683è¡Œ)
- Commit: `0828941c` (2025-11-21)
- æµ‹è¯•: âœ… Toggle sidebaræŒä¹…æ€§é€šè¿‡

**æ˜¾ç¤ºæ•ˆæœ**: å ä½é¡µé¢ "(Phase 1: Framework Ready)"

---

### Phase 2: æ•°æ®å¯¹æ¥ (å½“å‰é˜¶æ®µ,é¢„è®¡6-8å°æ—¶)

**ä»»åŠ¡æ¸…å•**:
- [ ] 2.1 å®ç° `loadAnnotations()` æ–¹æ³•
  - è·å–Reader.itemID â†’ DOI â†’ Document ID
  - è°ƒç”¨ `/api/proxy/annotations?type=all`
  - å¤„ç†åŠ è½½çŠ¶æ€ (Loading Spinner)
  - å¤„ç†ç©ºçŠ¶æ€ (æ— DOI / æ— æ ‡æ³¨)
  
- [ ] 2.2 å®ç° `renderAnnotationList()` æ–¹æ³•
  - éå†annotationsæ•°ç»„
  - è°ƒç”¨ `renderAnnotationCard()` ç”ŸæˆDOM
  - æ’å…¥åˆ° `.shared-annotations-list` å®¹å™¨
  
- [ ] 2.3 å®ç° `renderAnnotationCard()` æ–¹æ³•
  - å¤ç”¨ SessionView çš„HTMLç»“æ„ (ç®€åŒ–)
  - é€‚é…Sidebarå®½åº¦ (å­—ä½“/padding/avatarç¼©å°)
  - é›†æˆ UserHoverCardManager
  
- [ ] 2.4 å®ç° `navigateToAnnotation()` æ–¹æ³•
  - æ‡’åŠ è½½ PDFReaderManager
  - è°ƒç”¨ `navigateToAnnotation(reader, position)`
  - é”™è¯¯å¤„ç†

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç‚¹å‡»Tabèƒ½åŠ è½½å¹¶æ˜¾ç¤ºå…±äº«æ ‡æ³¨åˆ—è¡¨
- âœ… ç‚¹å‡»æ ‡æ³¨å¡ç‰‡èƒ½è·³è½¬åˆ°PDFå¯¹åº”ä½ç½®
- âœ… Hoverç”¨æˆ·åæ˜¾ç¤ºç”¨æˆ·å¡ç‰‡

**é¢„è®¡å®Œæˆæ—¶é—´**: 1ä¸ªå·¥ä½œæ—¥

---

### Phase 3: ç¤¾äº¤åŠŸèƒ½ (é¢„è®¡4å°æ—¶)

**ä»»åŠ¡æ¸…å•**:
- [ ] 3.1 å®ç°ç‚¹èµåŠŸèƒ½
  - è°ƒç”¨ `SupabaseManager.likeAnnotation()`
  - æ›´æ–°UIç‚¹èµæ•° (+1 / -1)
  - å¤„ç†é”™è¯¯ (æœªç™»å½•æç¤º)
  
- [ ] 3.2 å®ç°è¯„è®ºå±•å¼€/æŠ˜å 
  - ç‚¹å‡»ğŸ’¬æŒ‰é’®å±•å¼€è¯„è®ºåŒº
  - è°ƒç”¨ `SupabaseManager.getAnnotationCommentTree()`
  - å¤ç”¨ CommentRenderer æ¸²æŸ“è¯„è®ºæ ‘
  
- [ ] 3.3 æ·»åŠ åˆ·æ–°æŒ‰é’®åŠŸèƒ½
  - æ¸…é™¤ç¼“å­˜
  - é‡æ–°è°ƒç”¨ `loadAnnotations()`
  - æ˜¾ç¤ºLoadingçŠ¶æ€

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç‚¹èµæŒ‰é’®èƒ½å®æ—¶æ›´æ–°æ•°é‡
- âœ… è¯„è®ºèƒ½å®Œæ•´å±•ç¤º(å«åµŒå¥—å›å¤)
- âœ… åˆ·æ–°æŒ‰é’®èƒ½é‡æ–°åŠ è½½æ•°æ®

---

### Phase 4: é«˜çº§åŠŸèƒ½ (å¯é€‰,é¢„è®¡6å°æ—¶)

**ä»»åŠ¡æ¸…å•**:
- [ ] 4.1 ç­›é€‰å™¨åŠŸèƒ½
  - "ä»…å…³æ³¨": ç­›é€‰å…³æ³¨ç”¨æˆ·çš„æ ‡æ³¨
  - "å½“å‰ä¼šè¯": ç­›é€‰ç‰¹å®šä¼šè¯çš„æ ‡æ³¨
  
- [ ] 4.2 æ’åºåŠŸèƒ½
  - æœ€æ–°ä¼˜å…ˆ (created_at desc)
  - æœ€çƒ­ä¼˜å…ˆ (likes_count desc)
  - é¡µç é¡ºåº (pageIndex asc)
  
- [ ] 4.3 è™šæ‹Ÿæ»šåŠ¨ (æ€§èƒ½ä¼˜åŒ–)
  - æ ‡æ³¨æ•°é‡ > 100 æ—¶å¯ç”¨
  - ä½¿ç”¨ IntersectionObserver æ‡’åŠ è½½

**ä¼˜å…ˆçº§**: P2 (Phase 2/3å®Œæˆåæ ¹æ®ç”¨æˆ·åé¦ˆå†³å®š)

---

## äº”ã€ä»£ç å¤ç”¨ç­–ç•¥

### 5.1 å¯ç›´æ¥å¤ç”¨çš„æ¨¡å— âœ…

| æ¨¡å—å | æ–‡ä»¶è·¯å¾„ | ç”¨é€” | ä½¿ç”¨æ–¹å¼ |
|--------|---------|------|---------|
| **APIClient** | `utils/apiClient.ts` | HTTPè¯·æ±‚ | `APIClient.getInstance()` |
| **UserHoverCardManager** | `ui/userHoverCard.ts` | ç”¨æˆ·å¡ç‰‡ | `new UserHoverCardManager(context)` |
| **SupabaseManager** | é€šè¿‡APIClient | ç‚¹èµ/è¯„è®ºAPI | `apiClient.post('/api/proxy/...')` |
| **PDFReaderManager** | `pdf/PDFReaderManager.ts` | æ ‡æ³¨è·³è½¬ | æ‡’åŠ è½½å•ä¾‹ |
| **Logger** | `utils/logger.ts` | æ—¥å¿—è¾“å‡º | `logger.log()` |

### 5.2 éœ€é€‚é…çš„æ¨¡å— âš ï¸

| æ¥æºæ¨¡å— | å¤ç”¨å†…å®¹ | é€‚é…è¦ç‚¹ |
|---------|---------|---------|
| **SessionAnnotationsView** | HTMLå¡ç‰‡ç»“æ„ | âœ‚ï¸ ç§»é™¤æ‰¹é‡é€‰æ‹©checkbox,ç¼©å°avatar/å­—ä½“ |
| **SessionAnnotationsView** | è¯„è®ºæ ‘æ¸²æŸ“ | âœ… æŠ½å–ä¸ºç‹¬ç«‹CommentRendererç±» (Phase 3) |
| **SessionAnnotationsView** | ç‚¹èµæŒ‰é’®é€»è¾‘ | âœ… å¤ç”¨APIè°ƒç”¨,ç®€åŒ–UIæ›´æ–° |
| **SidebarAnnotationEnhancer** | CSSæ ·å¼ | âœ… å¤ç”¨ `.hidden` / `.selected` ç­‰åŸºç¡€ç±» |

### 5.3 ä¸åº”å¤ç”¨çš„æ¨¡å— âŒ

| æ¨¡å— | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------|
| **æ‰¹é‡æ“ä½œé€»è¾‘** | Sidebarä¸éœ€è¦æ‰¹é‡ç®¡ç† | å•ä¸ªæ ‡æ³¨ç‚¹å‡»äº¤äº’ |
| **æ¨¡å¼åˆ‡æ¢** | Sidebaråªæ˜¾ç¤ºå…±äº«æ¨¡å¼ | å›ºå®šä¸º"å…±äº«æ ‡æ³¨"è§†å›¾ |
| **æ–‡çŒ®åˆ—è¡¨** | Sidebarç»‘å®šå•ä¸ªReader | æ— éœ€è·¨æ–‡çŒ®åˆ‡æ¢ |

---

## å…­ã€æ³¨æ„äº‹é¡¹ä¸é£é™©

### 6.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|---------|------|
| **Toggle sidebar DOMä¸¢å¤±** | Tabæ¶ˆå¤± | renderSidebarAnnotationHeaderç›‘å¬+é‡è¯• | âœ… å·²è§£å†³ |
| **reader.setSidebarViewæŠ¥é”™** | åŠŸèƒ½å´©æºƒ | ä½¿ç”¨çº¯CSSæ§åˆ¶,é¿å…è°ƒç”¨ | âœ… å·²è§„é¿ |
| **æ ‡æ³¨æ•°é‡è¿‡å¤š** | æ»šåŠ¨å¡é¡¿ | Phase 4è™šæ‹Ÿæ»šåŠ¨ / åˆ†é¡µåŠ è½½ | â³ å¾…ä¼˜åŒ– |
| **PDFReaderManagerå¾ªç¯ä¾èµ–** | æ„å»ºå¤±è´¥ | æ‡’åŠ è½½+å…¨å±€ç¼“å­˜ | âœ… å·²è§„é¿ |

### 6.2 æ ·å¼å…¼å®¹æ€§

**æµ‹è¯•åœºæ™¯**:
- [x] äº®è‰²ä¸»é¢˜ (é»˜è®¤)
- [ ] æš—è‰²ä¸»é¢˜ (`var(--material-*)` å˜é‡)
- [ ] ä¸åŒDPIæ˜¾ç¤ºå™¨ (Windowsç¼©æ”¾ 125%/150%)
- [ ] Sidebarå®½åº¦è°ƒæ•´ (ç”¨æˆ·æ‹–æ‹½)

**CSSå˜é‡ä½¿ç”¨**:
```css
/* ä½¿ç”¨ZoteroåŸç”Ÿå˜é‡,è‡ªåŠ¨é€‚é…ä¸»é¢˜ */
background: var(--material-sidebar-bg);
color: var(--fill-primary);
border: 1px solid var(--material-divider);
```

### 6.3 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| **é¦–æ¬¡åŠ è½½æ—¶é—´** | < 500ms | 100ä¸ªæ ‡æ³¨åœºæ™¯ |
| **å¡ç‰‡æ¸²æŸ“æ—¶é—´** | < 50ms/ä¸ª | Chrome DevTools Timeline |
| **æ»šåŠ¨å¸§ç‡** | > 55 FPS | Zoteroå†…ç½®æ€§èƒ½ç›‘æ§ |
| **å†…å­˜å ç”¨** | < 50MBå¢é‡ | æ‰“å¼€å‰åå¯¹æ¯” |

---

## ä¸ƒã€æµ‹è¯•è®¡åˆ’

### 7.1 Phase 2 æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|--------|---------|---------|
| **TC-2.1** | æ‰“å¼€æœ‰DOIçš„PDF â†’ ç‚¹å‡»ğŸ‘¥Tab | æ˜¾ç¤ºLoading â†’ æ˜¾ç¤ºæ ‡æ³¨åˆ—è¡¨ |
| **TC-2.2** | ç‚¹å‡»æ ‡æ³¨å¡ç‰‡ | PDFè·³è½¬åˆ°å¯¹åº”é¡µç å’Œä½ç½® |
| **TC-2.3** | Hoverç”¨æˆ·å | æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¡ç‰‡ |
| **TC-2.4** | æ‰“å¼€æ— DOIçš„PDF | æ˜¾ç¤º"å½“å‰æ–‡çŒ®æ— DOI"æç¤º |
| **TC-2.5** | APIè¯·æ±‚å¤±è´¥ | æ˜¾ç¤º"åŠ è½½å¤±è´¥"æç¤º+é‡è¯•æŒ‰é’® |
| **TC-2.6** | åˆ‡æ¢åˆ°å…¶ä»–Tabå†åˆ‡å› | æ•°æ®ä¿æŒ(ä¸é‡æ–°åŠ è½½) |
| **TC-2.7** | Toggle sidebarå…³é—­-æ‰“å¼€ | Tabæ­£å¸¸æ˜¾ç¤º,æ•°æ®ä¿æŒ |

### 7.2 å…¼å®¹æ€§æµ‹è¯•

- [ ] Zotero 7.0.x (æ—§API)
- [ ] Zotero 8.0-beta.17+ (æ–°API)
- [ ] Windows 10/11
- [ ] macOS (M1/Intel)
- [ ] Linux (Ubuntu/Fedora)

---

## å…«ã€å¼€å‘æŒ‡å—

### 8.1 æœ¬åœ°è°ƒè¯•

**å¯åŠ¨çƒ­é‡è½½**:
```bash
cd zotero-plugin
npm start
```

**æŸ¥çœ‹æ—¥å¿—**:
- Zoteroèœå•: Tools â†’ Developer â†’ Error Console
- æœç´¢: `[SidebarSharedView]`

**æ–­ç‚¹è°ƒè¯•**:
```typescript
// åœ¨å…³é”®æ–¹æ³•æ·»åŠ æ–­ç‚¹
private async loadAnnotations(reader: any, doc: Document) {
  debugger; // æµè§ˆå™¨ä¼šåœ¨æ­¤å¤„æš‚åœ
  // ...
}
```

### 8.2 ä»£ç è§„èŒƒ

**æ–‡ä»¶ä½ç½®**:
```
zotero-plugin/src/modules/ui/sidebarSharedView.ts (ä¸»ç±»)
zotero-plugin/src/modules/ui/types.ts (ç±»å‹å®šä¹‰)
```

**å‘½åçº¦å®š**:
- ç±»å: `SidebarSharedView` (PascalCase)
- æ–¹æ³•: `loadAnnotations()` (camelCase)
- ç§æœ‰æ–¹æ³•: `private renderCard()` (åŠ privateå‰ç¼€)
- DOM ID: `researchopia-shared-annotations-*` (kebab-case)
- CSSç±»: `.shared-annotations-*` (kebab-case)

**æ—¥å¿—çº§åˆ«**:
```typescript
logger.log('[SidebarSharedView] Normal operation'); // ä¸€èˆ¬ä¿¡æ¯
logger.warn('[SidebarSharedView] âš ï¸ Potential issue'); // è­¦å‘Š
logger.error('[SidebarSharedView] âŒ Critical error:', error); // é”™è¯¯
```

### 8.3 Gitæäº¤è§„èŒƒ

**Commitæ¶ˆæ¯æ ¼å¼**:
```bash
feat(zotero): Add shared annotations data loading
fix(zotero): Fix annotation card rendering in sidebar
refactor(zotero): Extract card rendering to separate method
```

**åˆ†æ”¯ç­–ç•¥**:
- å¼€å‘åˆ†æ”¯: `refactor/progressive-v2`
- Featureåˆ†æ”¯: `feature/sidebar-shared-tab-phase2`
- åˆå¹¶å‰å…ˆæµ‹è¯•æ‰€æœ‰ç”¨ä¾‹

---

## ä¹ã€åç»­æ¼”è¿›æ–¹å‘

### 9.1 çŸ­æœŸä¼˜åŒ– (1-2å‘¨)

- [ ] æ·»åŠ é”®ç›˜å¿«æ·é”® (Ctrl+Shift+S åˆ‡æ¢åˆ°Shared Tab)
- [ ] æ ‡æ³¨é«˜äº®é¢œè‰²åŒæ­¥åˆ°å¡ç‰‡ (å·¦ä¾§å½©æ¡)
- [ ] æ”¯æŒæ ‡æ³¨æœç´¢ (å…³é”®è¯ç­›é€‰)

### 9.2 ä¸­æœŸåŠŸèƒ½ (1-2æœˆ)

- [ ] æ ‡æ³¨å¯¼å‡º (å¯¼å‡ºä¸ºMarkdown/PDF)
- [ ] æ ‡æ³¨å¯¹æ¯” (æˆ‘çš„ vs ä»–äººçš„)
- [ ] æ ‡æ³¨çƒ­åŠ›å›¾ (é¡µé¢ç»´åº¦èšåˆ)

### 9.3 é•¿æœŸæ„¿æ™¯ (3-6æœˆ)

- [ ] AIæ‘˜è¦ç”Ÿæˆ (åŸºäºæ‰€æœ‰æ ‡æ³¨)
- [ ] åä½œæ ‡æ³¨ (å®æ—¶å¤šäººç¼–è¾‘)
- [ ] æ™ºèƒ½æ¨è (æ¨èç›¸å…³æ ‡æ³¨)

---

## åã€æ€»ç»“

### å½“å‰çŠ¶æ€

âœ… **Phase 1å®Œæˆ**: æ¡†æ¶æ­å»ºå®Œæ¯•,Tabå¯æ­£å¸¸åˆ‡æ¢  
ğŸ”„ **Phase 2è¿›è¡Œä¸­**: å‡†å¤‡å®æ–½æ•°æ®åŠ è½½å’Œå¡ç‰‡æ¸²æŸ“  
â³ **Phase 3/4å¾…å®š**: æ ¹æ®ç”¨æˆ·åé¦ˆä¼˜å…ˆçº§æ’åº

### å…³é”®æˆæœ

1. **è§„é¿äº†2ä¸ªé«˜å±APIé—®é¢˜**: `reader.setSidebarView()` å’Œ `reader.navigate()`
2. **è§£å†³äº†Toggle sidebaræŒä¹…æ€§é—®é¢˜**: 10æ¬¡é‡è¯•æœºåˆ¶
3. **æ˜ç¡®äº†ä»£ç å¤ç”¨è¾¹ç•Œ**: é¿å…å¼•å…¥ä¸å¿…è¦çš„ä¾èµ–

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³å¼€å§‹Phase 2å¼€å‘**:
1. å®ç° `loadAnnotations()` (2å°æ—¶)
2. å®ç° `renderAnnotationCard()` (3å°æ—¶)
3. å®ç° `navigateToAnnotation()` (1å°æ—¶)
4. é›†æˆæµ‹è¯• (2å°æ—¶)

**é¢„è®¡å®Œæˆæ—¶é—´**: 2025-11-22 (1ä¸ªå·¥ä½œæ—¥)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-11-21  
**ä¸‹æ¬¡å®¡æŸ¥**: Phase 2å®Œæˆå
